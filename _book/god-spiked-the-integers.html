<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>11 God Spiked the Integers | Statistical rethinking with brms, ggplot2, and the tidyverse: Second edition</title>
  <meta name="description" content="This book is an attempt to re-express the code in the second edition of McElreath’s textbook, ‘Statistical rethinking.’ His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="11 God Spiked the Integers | Statistical rethinking with brms, ggplot2, and the tidyverse: Second edition" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book is an attempt to re-express the code in the second edition of McElreath’s textbook, ‘Statistical rethinking.’ His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  <meta name="github-repo" content="ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="11 God Spiked the Integers | Statistical rethinking with brms, ggplot2, and the tidyverse: Second edition" />
  <meta name="twitter:site" content="@SolomonKurz" />
  <meta name="twitter:description" content="This book is an attempt to re-express the code in the second edition of McElreath’s textbook, ‘Statistical rethinking.’ His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  

<meta name="author" content="A Solomon Kurz" />


<meta name="date" content="2020-06-30" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="big-entropy-and-the-generalized-linear-model.html"/>
<link rel="next" href="monsters-and-mixtures.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>What and why</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#caution-work-in-progress"><i class="fa fa-check"></i>Caution: Work in progress</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#thank-yous-are-in-order"><i class="fa fa-check"></i>Thank-you’s are in order</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="the-golem-of-prague.html"><a href="the-golem-of-prague.html"><i class="fa fa-check"></i><b>1</b> The Golem of Prague</a><ul>
<li class="chapter" data-level="" data-path="the-golem-of-prague.html"><a href="the-golem-of-prague.html#session-info"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html"><i class="fa fa-check"></i><b>2</b> Small Worlds and Large Worlds</a><ul>
<li class="chapter" data-level="2.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#the-garden-of-forking-data"><i class="fa fa-check"></i><b>2.1</b> The garden of forking data</a><ul>
<li class="chapter" data-level="2.1.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#counting-possibilities."><i class="fa fa-check"></i><b>2.1.1</b> Counting possibilities.</a></li>
<li class="chapter" data-level="2.1.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#combining-other-information."><i class="fa fa-check"></i><b>2.1.2</b> Combining other information.</a></li>
<li class="chapter" data-level="2.1.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#from-counts-to-probability."><i class="fa fa-check"></i><b>2.1.3</b> From counts to probability.</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#building-a-model"><i class="fa fa-check"></i><b>2.2</b> Building a model</a><ul>
<li class="chapter" data-level="2.2.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#a-data-story."><i class="fa fa-check"></i><b>2.2.1</b> A data story.</a></li>
<li class="chapter" data-level="2.2.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#bayesian-updating."><i class="fa fa-check"></i><b>2.2.2</b> Bayesian updating.</a></li>
<li class="chapter" data-level="2.2.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#evaluate."><i class="fa fa-check"></i><b>2.2.3</b> Evaluate.</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#components-of-the-model"><i class="fa fa-check"></i><b>2.3</b> Components of the model</a><ul>
<li class="chapter" data-level="2.3.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#variables."><i class="fa fa-check"></i><b>2.3.1</b> Variables.</a></li>
<li class="chapter" data-level="2.3.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#definitions."><i class="fa fa-check"></i><b>2.3.2</b> Definitions.</a></li>
<li class="chapter" data-level="2.3.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#a-model-is-born."><i class="fa fa-check"></i><b>2.3.3</b> A model is born.</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#making-the-model-go"><i class="fa fa-check"></i><b>2.4</b> Making the model go</a><ul>
<li class="chapter" data-level="2.4.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#bayes-theorem."><i class="fa fa-check"></i><b>2.4.1</b> Bayes’ theorem.</a></li>
<li class="chapter" data-level="2.4.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#motors."><i class="fa fa-check"></i><b>2.4.2</b> Motors.</a></li>
<li class="chapter" data-level="2.4.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#grid-approximation."><i class="fa fa-check"></i><b>2.4.3</b> Grid approximation.</a></li>
<li class="chapter" data-level="2.4.4" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#quadratic-approximation."><i class="fa fa-check"></i><b>2.4.4</b> Quadratic approximation.</a></li>
<li class="chapter" data-level="2.4.5" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#markov-chain-monte-carlo."><i class="fa fa-check"></i><b>2.4.5</b> Markov chain Monte Carlo.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#session-info-1"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html"><i class="fa fa-check"></i><b>3</b> Sampling the Imaginary</a><ul>
<li class="chapter" data-level="3.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-from-a-grid-approximate-posterior"><i class="fa fa-check"></i><b>3.1</b> Sampling from a grid-approximate posterior</a></li>
<li class="chapter" data-level="3.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-to-summarize"><i class="fa fa-check"></i><b>3.2</b> Sampling to summarize</a><ul>
<li class="chapter" data-level="3.2.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#intervals-of-defined-boundaries."><i class="fa fa-check"></i><b>3.2.1</b> Intervals of defined boundaries.</a></li>
<li class="chapter" data-level="3.2.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#intervals-of-defined-mass."><i class="fa fa-check"></i><b>3.2.2</b> Intervals of defined mass.</a></li>
<li class="chapter" data-level="3.2.3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#point-estimates."><i class="fa fa-check"></i><b>3.2.3</b> Point estimates.</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-to-simulate-prediction"><i class="fa fa-check"></i><b>3.3</b> Sampling to simulate prediction</a><ul>
<li class="chapter" data-level="3.3.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#dummy-data."><i class="fa fa-check"></i><b>3.3.1</b> Dummy data.</a></li>
<li class="chapter" data-level="3.3.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#model-checking."><i class="fa fa-check"></i><b>3.3.2</b> Model checking.</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#summary-lets-practice-with-brms"><i class="fa fa-check"></i><b>3.4</b> <del>Summary</del> Let’s practice with brms</a></li>
<li class="chapter" data-level="" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#session-info-2"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="geocentric-models.html"><a href="geocentric-models.html"><i class="fa fa-check"></i><b>4</b> Geocentric Models</a><ul>
<li class="chapter" data-level="4.1" data-path="geocentric-models.html"><a href="geocentric-models.html#why-normal-distributions-are-normal"><i class="fa fa-check"></i><b>4.1</b> Why normal distributions are normal</a><ul>
<li class="chapter" data-level="4.1.1" data-path="geocentric-models.html"><a href="geocentric-models.html#normal-by-addition."><i class="fa fa-check"></i><b>4.1.1</b> Normal by addition.</a></li>
<li class="chapter" data-level="4.1.2" data-path="geocentric-models.html"><a href="geocentric-models.html#normal-by-multiplication."><i class="fa fa-check"></i><b>4.1.2</b> Normal by multiplication.</a></li>
<li class="chapter" data-level="4.1.3" data-path="geocentric-models.html"><a href="geocentric-models.html#normal-by-log-multiplication."><i class="fa fa-check"></i><b>4.1.3</b> Normal by log-multiplication.</a></li>
<li class="chapter" data-level="4.1.4" data-path="geocentric-models.html"><a href="geocentric-models.html#using-gaussian-distributions."><i class="fa fa-check"></i><b>4.1.4</b> Using Gaussian distributions.</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="geocentric-models.html"><a href="geocentric-models.html#a-language-for-describing-models"><i class="fa fa-check"></i><b>4.2</b> A language for describing models</a><ul>
<li class="chapter" data-level="4.2.1" data-path="geocentric-models.html"><a href="geocentric-models.html#re-describing-the-globe-tossing-model."><i class="fa fa-check"></i><b>4.2.1</b> Re-describing the globe tossing model.</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="geocentric-models.html"><a href="geocentric-models.html#a-gaussian-model-of-height"><i class="fa fa-check"></i><b>4.3</b> A Gaussian model of height</a><ul>
<li class="chapter" data-level="4.3.1" data-path="geocentric-models.html"><a href="geocentric-models.html#the-data."><i class="fa fa-check"></i><b>4.3.1</b> The data.</a></li>
<li class="chapter" data-level="4.3.2" data-path="geocentric-models.html"><a href="geocentric-models.html#the-model."><i class="fa fa-check"></i><b>4.3.2</b> The model.</a></li>
<li class="chapter" data-level="4.3.3" data-path="geocentric-models.html"><a href="geocentric-models.html#grid-approximation-of-the-posterior-distribution."><i class="fa fa-check"></i><b>4.3.3</b> Grid approximation of the posterior distribution.</a></li>
<li class="chapter" data-level="4.3.4" data-path="geocentric-models.html"><a href="geocentric-models.html#sampling-from-the-posterior."><i class="fa fa-check"></i><b>4.3.4</b> Sampling from the posterior.</a></li>
<li class="chapter" data-level="4.3.5" data-path="geocentric-models.html"><a href="geocentric-models.html#finding-the-posterior-distribution-with-quap-brm."><i class="fa fa-check"></i><b>4.3.5</b> Finding the posterior distribution with <del><code>quap</code></del> <code>brm()</code>.</a></li>
<li class="chapter" data-level="4.3.6" data-path="geocentric-models.html"><a href="geocentric-models.html#sampling-from-a-quap-brm-fit."><i class="fa fa-check"></i><b>4.3.6</b> Sampling from a <del><code>quap()</code></del> <code>brm()</code> fit.</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="geocentric-models.html"><a href="geocentric-models.html#linear-prediction"><i class="fa fa-check"></i><b>4.4</b> Linear prediction</a><ul>
<li class="chapter" data-level="4.4.1" data-path="geocentric-models.html"><a href="geocentric-models.html#the-linear-model-strategy."><i class="fa fa-check"></i><b>4.4.1</b> The linear model strategy.</a></li>
<li class="chapter" data-level="4.4.2" data-path="geocentric-models.html"><a href="geocentric-models.html#finding-the-posterior-distribution."><i class="fa fa-check"></i><b>4.4.2</b> Finding the posterior distribution.</a></li>
<li class="chapter" data-level="4.4.3" data-path="geocentric-models.html"><a href="geocentric-models.html#interpreting-the-posterior-distribution."><i class="fa fa-check"></i><b>4.4.3</b> Interpreting the posterior distribution.</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="geocentric-models.html"><a href="geocentric-models.html#curves-from-lines"><i class="fa fa-check"></i><b>4.5</b> Curves from lines</a><ul>
<li class="chapter" data-level="4.5.1" data-path="geocentric-models.html"><a href="geocentric-models.html#polynomial-regression"><i class="fa fa-check"></i><b>4.5.1</b> Polynomial regression</a></li>
<li class="chapter" data-level="4.5.2" data-path="geocentric-models.html"><a href="geocentric-models.html#splines."><i class="fa fa-check"></i><b>4.5.2</b> Splines.</a></li>
<li class="chapter" data-level="4.5.3" data-path="geocentric-models.html"><a href="geocentric-models.html#smooth-functions-for-a-rough-world."><i class="fa fa-check"></i><b>4.5.3</b> Smooth functions for a rough world.</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="geocentric-models.html"><a href="geocentric-models.html#summary-b-splines-with-brms"><i class="fa fa-check"></i><b>4.6</b> <del>Summary</del> B-splines with <strong>brms</strong></a></li>
<li class="chapter" data-level="" data-path="geocentric-models.html"><a href="geocentric-models.html#session-info-3"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html"><i class="fa fa-check"></i><b>5</b> The Many Variables &amp; The Spurious Waffles</a><ul>
<li class="chapter" data-level="5.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#spurious-associations"><i class="fa fa-check"></i><b>5.1</b> Spurious associations</a><ul>
<li class="chapter" data-level="5.1.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#think-before-you-regress."><i class="fa fa-check"></i><b>5.1.1</b> Think before you regress.</a></li>
<li class="chapter" data-level="5.1.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#testable-implications."><i class="fa fa-check"></i><b>5.1.2</b> Testable implications.</a></li>
<li class="chapter" data-level="5.1.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#multiple-regression-notation."><i class="fa fa-check"></i><b>5.1.3</b> Multiple regression notation.</a></li>
<li class="chapter" data-level="5.1.4" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#approximating-the-posterior."><i class="fa fa-check"></i><b>5.1.4</b> Approximating the posterior.</a></li>
<li class="chapter" data-level="5.1.5" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#plotting-multivariate-posteriors."><i class="fa fa-check"></i><b>5.1.5</b> Plotting multivariate posteriors.</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#masked-relationship"><i class="fa fa-check"></i><b>5.2</b> Masked relationship</a></li>
<li class="chapter" data-level="5.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#categorical-varaibles"><i class="fa fa-check"></i><b>5.3</b> Categorical varaibles</a><ul>
<li class="chapter" data-level="5.3.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#binary-categories."><i class="fa fa-check"></i><b>5.3.1</b> Binary categories.</a></li>
<li class="chapter" data-level="5.3.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#many-categories."><i class="fa fa-check"></i><b>5.3.2</b> Many categories.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#session-info-4"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html"><i class="fa fa-check"></i><b>6</b> The Haunted DAG &amp; The Causal Terror</a><ul>
<li class="chapter" data-level="6.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#multicollinearity"><i class="fa fa-check"></i><b>6.1</b> Multicollinearity</a><ul>
<li class="chapter" data-level="6.1.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#multicollinear-legs."><i class="fa fa-check"></i><b>6.1.1</b> Multicollinear legs.</a></li>
<li class="chapter" data-level="6.1.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#multicollinear-milk."><i class="fa fa-check"></i><b>6.1.2</b> Multicollinear <code>milk</code>.</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#post-treatment-bias"><i class="fa fa-check"></i><b>6.2</b> Post-treatment bias</a><ul>
<li class="chapter" data-level="6.2.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#a-prior-is-born."><i class="fa fa-check"></i><b>6.2.1</b> A prior is born.</a></li>
<li class="chapter" data-level="6.2.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#blocked-by-consequence."><i class="fa fa-check"></i><b>6.2.2</b> Blocked by consequence.</a></li>
<li class="chapter" data-level="6.2.3" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#fungus-and-d-separation."><i class="fa fa-check"></i><b>6.2.3</b> Fungus and <span class="math inline">\(d\)</span>-separation.</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#collider-bias"><i class="fa fa-check"></i><b>6.3</b> Collider bias</a><ul>
<li class="chapter" data-level="6.3.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#collider-of-false-sorrow."><i class="fa fa-check"></i><b>6.3.1</b> Collider of false sorrow.</a></li>
<li class="chapter" data-level="6.3.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#the-haunted-dag."><i class="fa fa-check"></i><b>6.3.2</b> The haunted DAG.</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#confronting-confounding"><i class="fa fa-check"></i><b>6.4</b> Confronting confounding</a><ul>
<li class="chapter" data-level="6.4.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#shutting-the-backdoor."><i class="fa fa-check"></i><b>6.4.1</b> Shutting the backdoor.</a></li>
<li class="chapter" data-level="6.4.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#two-roads."><i class="fa fa-check"></i><b>6.4.2</b> Two roads.</a></li>
<li class="chapter" data-level="6.4.3" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#backdoor-waffles."><i class="fa fa-check"></i><b>6.4.3</b> Backdoor waffles.</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#summary-and-a-little-more-practice"><i class="fa fa-check"></i><b>6.5</b> Summary [and a little more practice]</a></li>
<li class="chapter" data-level="" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#session-info-5"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ulysses-compass.html"><a href="ulysses-compass.html"><i class="fa fa-check"></i><b>7</b> Ulysses’ Compass</a><ul>
<li class="chapter" data-level="7.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#the-problem-with-parameters"><i class="fa fa-check"></i><b>7.1</b> The problem with parameters</a><ul>
<li class="chapter" data-level="7.1.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#more-parameters-almost-always-improve-fit."><i class="fa fa-check"></i><b>7.1.1</b> More parameters (almost) always improve fit.</a></li>
<li class="chapter" data-level="7.1.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#too-few-parameters-hurts-too."><i class="fa fa-check"></i><b>7.1.2</b> Too few parameters hurts, too.</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#entropy-and-accuracy"><i class="fa fa-check"></i><b>7.2</b> Entropy and accuracy</a><ul>
<li class="chapter" data-level="7.2.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#firing-the-weatherperson."><i class="fa fa-check"></i><b>7.2.1</b> Firing the weatherperson.</a></li>
<li class="chapter" data-level="7.2.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#information-and-uncertainty."><i class="fa fa-check"></i><b>7.2.2</b> Information and uncertainty.</a></li>
<li class="chapter" data-level="7.2.3" data-path="ulysses-compass.html"><a href="ulysses-compass.html#from-entropy-to-accuracy."><i class="fa fa-check"></i><b>7.2.3</b> From entropy to accuracy.</a></li>
<li class="chapter" data-level="7.2.4" data-path="ulysses-compass.html"><a href="ulysses-compass.html#estimating-divergence."><i class="fa fa-check"></i><b>7.2.4</b> Estimating divergence.</a></li>
<li class="chapter" data-level="7.2.5" data-path="ulysses-compass.html"><a href="ulysses-compass.html#scoring-the-right-data."><i class="fa fa-check"></i><b>7.2.5</b> Scoring the right data.</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ulysses-compass.html"><a href="ulysses-compass.html#golem-taming-regularization"><i class="fa fa-check"></i><b>7.3</b> Golem taming: regularization</a></li>
<li class="chapter" data-level="7.4" data-path="ulysses-compass.html"><a href="ulysses-compass.html#predicting-predictive-accuracy"><i class="fa fa-check"></i><b>7.4</b> Predicting predictive accuracy</a><ul>
<li class="chapter" data-level="7.4.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#cross-validation."><i class="fa fa-check"></i><b>7.4.1</b> Cross-validation.</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="ulysses-compass.html"><a href="ulysses-compass.html#information-criteria"><i class="fa fa-check"></i><b>7.5</b> Information criteria</a><ul>
<li class="chapter" data-level="7.5.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#comparing-cv-psis-and-waic."><i class="fa fa-check"></i><b>7.5.1</b> Comparing CV, PSIS, and WAIC.</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="ulysses-compass.html"><a href="ulysses-compass.html#model-comparison"><i class="fa fa-check"></i><b>7.6</b> Model comparison</a><ul>
<li class="chapter" data-level="7.6.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#model-mis-selection."><i class="fa fa-check"></i><b>7.6.1</b> Model mis-selection.</a></li>
<li class="chapter" data-level="7.6.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#outliers-and-other-illusions."><i class="fa fa-check"></i><b>7.6.2</b> Outliers and other illusions.</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="ulysses-compass.html"><a href="ulysses-compass.html#summarybonus-r2-talk"><i class="fa fa-check"></i><b>7.7</b> <del>Summary</del>Bonus: <span class="math inline">\(R^2\)</span> talk</a></li>
<li class="chapter" data-level="" data-path="ulysses-compass.html"><a href="ulysses-compass.html#session-info-6"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="conditional-manatees.html"><a href="conditional-manatees.html"><i class="fa fa-check"></i><b>8</b> Conditional Manatees</a><ul>
<li class="chapter" data-level="8.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#building-an-interaction."><i class="fa fa-check"></i><b>8.1</b> Building an interaction.</a><ul>
<li class="chapter" data-level="8.1.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#making-a-rugged-model."><i class="fa fa-check"></i><b>8.1.1</b> Making a rugged model.</a></li>
<li class="chapter" data-level="8.1.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#adding-an-indicator-variable-isnt-enough."><i class="fa fa-check"></i><b>8.1.2</b> Adding an indicator variable isn’t enough.</a></li>
<li class="chapter" data-level="8.1.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#adding-an-interaction-does-work."><i class="fa fa-check"></i><b>8.1.3</b> Adding an interaction does work.</a></li>
<li class="chapter" data-level="8.1.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-the-interaction."><i class="fa fa-check"></i><b>8.1.4</b> Plotting the interaction.</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#symmetry-of-interactions"><i class="fa fa-check"></i><b>8.2</b> Symmetry of interactions</a></li>
<li class="chapter" data-level="8.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#continuous-interactions"><i class="fa fa-check"></i><b>8.3</b> Continuous interactions</a><ul>
<li class="chapter" data-level="8.3.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#a-winter-flower."><i class="fa fa-check"></i><b>8.3.1</b> A winter flower.</a></li>
<li class="chapter" data-level="8.3.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#the-models."><i class="fa fa-check"></i><b>8.3.2</b> The models.</a></li>
<li class="chapter" data-level="8.3.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-posterior-predictions."><i class="fa fa-check"></i><b>8.3.3</b> Plotting posterior predictions.</a></li>
<li class="chapter" data-level="8.3.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-prior-predictions."><i class="fa fa-check"></i><b>8.3.4</b> Plotting prior predictions.</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#summary-bonus-conditional_effects"><i class="fa fa-check"></i><b>8.4</b> <del>Summary</del> Bonus: <code>conditional_effects()</code></a></li>
<li class="chapter" data-level="" data-path="conditional-manatees.html"><a href="conditional-manatees.html#session-info-7"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html"><i class="fa fa-check"></i><b>9</b> Markov Chain Monte Carlo</a><ul>
<li class="chapter" data-level="9.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#good-king-markov-and-his-island-kingdom"><i class="fa fa-check"></i><b>9.1</b> Good King Markov and his island kingdom</a></li>
<li class="chapter" data-level="9.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#metropolis-algorithms"><i class="fa fa-check"></i><b>9.2</b> Metropolis algorithms</a><ul>
<li class="chapter" data-level="9.2.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#gibbs-sampling."><i class="fa fa-check"></i><b>9.2.1</b> Gibbs sampling.</a></li>
<li class="chapter" data-level="9.2.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#high-dimensional-problems."><i class="fa fa-check"></i><b>9.2.2</b> High-dimensional problems.</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#hamiltonian-monte-carlo"><i class="fa fa-check"></i><b>9.3</b> Hamiltonian Monte Carlo</a><ul>
<li class="chapter" data-level="9.3.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#limitations."><i class="fa fa-check"></i><b>9.3.1</b> Limitations.</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#easy-hmc-ulam-brm"><i class="fa fa-check"></i><b>9.4</b> Easy HMC: <del>ulam</del> <code>brm()</code></a><ul>
<li class="chapter" data-level="9.4.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#preparation."><i class="fa fa-check"></i><b>9.4.1</b> Preparation.</a></li>
<li class="chapter" data-level="9.4.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#estimation."><i class="fa fa-check"></i><b>9.4.2</b> Estimation.</a></li>
<li class="chapter" data-level="9.4.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#sampling-again-in-parallel."><i class="fa fa-check"></i><b>9.4.3</b> Sampling again, in parallel.</a></li>
<li class="chapter" data-level="9.4.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#visualization."><i class="fa fa-check"></i><b>9.4.4</b> Visualization.</a></li>
<li class="chapter" data-level="9.4.5" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#checking-the-chain."><i class="fa fa-check"></i><b>9.4.5</b> Checking the chain.</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#care-and-feeding-of-your-markov-chain."><i class="fa fa-check"></i><b>9.5</b> Care and feeding of your Markov chain.</a><ul>
<li class="chapter" data-level="9.5.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#how-many-samples-do-you-need"><i class="fa fa-check"></i><b>9.5.1</b> How many samples do you need?</a></li>
<li class="chapter" data-level="9.5.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#how-many-chains-do-you-need"><i class="fa fa-check"></i><b>9.5.2</b> How many chains do you need?</a></li>
<li class="chapter" data-level="9.5.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#taming-a-wild-chain."><i class="fa fa-check"></i><b>9.5.3</b> Taming a wild chain.</a></li>
<li class="chapter" data-level="9.5.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#non-identifiable-parameters."><i class="fa fa-check"></i><b>9.5.4</b> Non-identifiable parameters.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#session-info-8"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html"><i class="fa fa-check"></i><b>10</b> Big Entropy and the Generalized Linear Model</a><ul>
<li class="chapter" data-level="10.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#maximum-entropy"><i class="fa fa-check"></i><b>10.1</b> Maximum entropy</a><ul>
<li class="chapter" data-level="10.1.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#gaussian."><i class="fa fa-check"></i><b>10.1.1</b> Gaussian.</a></li>
<li class="chapter" data-level="10.1.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#binomial."><i class="fa fa-check"></i><b>10.1.2</b> Binomial.</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#generalized-linear-models"><i class="fa fa-check"></i><b>10.2</b> Generalized linear models</a><ul>
<li class="chapter" data-level="10.2.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#meet-the-family."><i class="fa fa-check"></i><b>10.2.1</b> Meet the family.</a></li>
<li class="chapter" data-level="10.2.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#linking-linear-models-to-distributions."><i class="fa fa-check"></i><b>10.2.2</b> Linking linear models to distributions.</a></li>
<li class="chapter" data-level="10.2.3" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#omitted-variable-bias-again."><i class="fa fa-check"></i><b>10.2.3</b> Omitted variable bias again.</a></li>
<li class="chapter" data-level="10.2.4" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#absolute-and-relative-differences."><i class="fa fa-check"></i><b>10.2.4</b> Absolute and relative differences.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#session-info-9"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html"><i class="fa fa-check"></i><b>11</b> God Spiked the Integers</a><ul>
<li class="chapter" data-level="11.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#binomial-regression"><i class="fa fa-check"></i><b>11.1</b> Binomial regression</a><ul>
<li class="chapter" data-level="11.1.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#logistic-regression-prosocial-chimpanzees."><i class="fa fa-check"></i><b>11.1.1</b> Logistic regression: Prosocial chimpanzees.</a></li>
<li class="chapter" data-level="11.1.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#relative-shark-and-absolute-deer."><i class="fa fa-check"></i><b>11.1.2</b> Relative shark and absolute deer.</a></li>
<li class="chapter" data-level="11.1.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#aggregated-binomial-chimpanzees-again-condensed."><i class="fa fa-check"></i><b>11.1.3</b> Aggregated binomial: Chimpanzees again, condensed.</a></li>
<li class="chapter" data-level="11.1.4" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#aggregated-binomial-graduate-school-admissions."><i class="fa fa-check"></i><b>11.1.4</b> Aggregated binomial: Graduate school admissions.</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#poisson-regression"><i class="fa fa-check"></i><b>11.2</b> Poisson regression</a><ul>
<li class="chapter" data-level="11.2.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#example-oceanic-tool-complexity."><i class="fa fa-check"></i><b>11.2.1</b> Example: Oceanic tool complexity.</a></li>
<li class="chapter" data-level="11.2.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#negative-binomial-gamma-poisson-models."><i class="fa fa-check"></i><b>11.2.2</b> Negative binomial (gamma-Poisson) models.</a></li>
<li class="chapter" data-level="11.2.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#example-exposure-and-the-offset."><i class="fa fa-check"></i><b>11.2.3</b> Example: Exposure and the offset.</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#multinomial-and-categorical-models"><i class="fa fa-check"></i><b>11.3</b> Multinomial and categorical models</a><ul>
<li class="chapter" data-level="11.3.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#predictors-matched-to-observations."><i class="fa fa-check"></i><b>11.3.1</b> Predictors matched to observations.</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#summary"><i class="fa fa-check"></i><b>11.4</b> Summary</a></li>
<li class="chapter" data-level="" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#session-info-10"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html"><i class="fa fa-check"></i><b>12</b> Monsters and Mixtures</a><ul>
<li class="chapter" data-level="12.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#over-dispersed-counts"><i class="fa fa-check"></i><b>12.1</b> Over-dispersed counts</a><ul>
<li class="chapter" data-level="12.1.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#beta-binomial."><i class="fa fa-check"></i><b>12.1.1</b> Beta-binomial.</a></li>
<li class="chapter" data-level="12.1.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#negative-binomial-or-gamma-poisson."><i class="fa fa-check"></i><b>12.1.2</b> Negative-binomial or gamma-Poisson.</a></li>
<li class="chapter" data-level="12.1.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#over-dispersion-entropy-and-information-criteria."><i class="fa fa-check"></i><b>12.1.3</b> Over-dispersion, entropy, and information criteria.</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#zero-inflated-outcomes"><i class="fa fa-check"></i><b>12.2</b> Zero-inflated outcomes</a><ul>
<li class="chapter" data-level="12.2.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#example-zero-inflated-poisson."><i class="fa fa-check"></i><b>12.2.1</b> Example: Zero-inflated Poisson.</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#ordered-categorical-outcomes"><i class="fa fa-check"></i><b>12.3</b> Ordered categorical outcomes</a><ul>
<li class="chapter" data-level="12.3.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#example-moral-intuition."><i class="fa fa-check"></i><b>12.3.1</b> Example: Moral intuition.</a></li>
<li class="chapter" data-level="12.3.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#describing-an-ordered-distribution-with-intercepts."><i class="fa fa-check"></i><b>12.3.2</b> Describing an ordered distribution with intercepts.</a></li>
<li class="chapter" data-level="12.3.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#adding-predictor-variables."><i class="fa fa-check"></i><b>12.3.3</b> Adding predictor variables.</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#ordered-categorical-predictors"><i class="fa fa-check"></i><b>12.4</b> Ordered categorical predictors</a></li>
<li class="chapter" data-level="12.5" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#summary-1"><i class="fa fa-check"></i><b>12.5</b> Summary</a></li>
<li class="chapter" data-level="" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#session-info-11"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><em>Statistical rethinking</em> with brms, ggplot2, and the tidyverse: Second edition</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="god-spiked-the-integers" class="section level1">
<h1><span class="header-section-number">11</span> God Spiked the Integers</h1>
<blockquote>
<p>The most common and useful generalized linear models are models for counts. Counts are non-negative integers–0, 1, 2, and so on. They are the basis of all mathematics, the first bits that children learn. But they are also intoxicatingly complicated to model–hence the apocryphal slogan that titles this chapter. The essential problem is this: When what we wish to predict is a count, the scale of the parameters is never the same as the scale of the outcome. A count golem, like a tide prediction engine, has a whirring machinery underneath that doesn’t resemble the output. Keeping the tide engine in mind, you can master these models and use them responsibly.</p>
<p>We will engineer complete examples of the two most common types of count model. <strong>Binomial regression</strong> is the name we’ll use for a family of related procedures that all model a binary classification–alive/dead, accept/reject, left/right–for which the total of both categories is known. This is like the marble and globe tossing examples from Chapter 2. But now you get to incorporate predictor variables. <strong>Poisson regression</strong> is a GLM that models a count with an unknown maximum—number of elephants in Kenya, number of applications to a PhD program, number of significance tests in an issue of <em>Psychological Science</em>. As described in Chapter 10, the Poisson model is a special case of binomial. At the end, the chapter describes some other count regressions. <span class="citation">(McElreath, <a href="#ref-mcelreathStatisticalRethinkingBayesian2020">2020</a><a href="#ref-mcelreathStatisticalRethinkingBayesian2020">a</a>, p. 323, <strong>emphasis</strong> in the original)</span></p>
</blockquote>
<p>In this chapter, we focus on the two most common types of count models: the binomial and the Poisson.</p>
<div id="binomial-regression" class="section level2">
<h2><span class="header-section-number">11.1</span> Binomial regression</h2>
<p>The basic binomial model follows the form</p>
<p><span class="math display">\[y \sim \operatorname{Binomial} (n, p),\]</span></p>
<p>where <span class="math inline">\(y\)</span> is some count variable, <span class="math inline">\(n\)</span> is the number of trials, and <span class="math inline">\(p\)</span> it the probability a given trial was a 1, which is sometimes termed a <em>success</em>. When <span class="math inline">\(n = 1\)</span>, then <span class="math inline">\(y\)</span> is a vector of 0s and 1s. Presuming the logit link, which we just covered in <a href="big-entropy-and-the-generalized-linear-model.html#linking-linear-models-to-distributions.">Chapter 10</a>, models of this type are commonly termed logistic regression. When <span class="math inline">\(n &gt; 1\)</span>, and still presuming the logit link, we might call our model an aggregated logistic regression model, or more generally an aggregated binomial regression model.</p>
<div id="logistic-regression-prosocial-chimpanzees." class="section level3">
<h3><span class="header-section-number">11.1.1</span> Logistic regression: Prosocial chimpanzees.</h3>
<p>Load the <span class="citation">Silk et al. (<a href="#ref-silkChimpanzeesAreIndifferent2005">2005</a>)</span> <code>chimpanzees</code> data.</p>
<div class="sourceCode" id="cb1148"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1148-1" data-line-number="1"><span class="kw">library</span>(rethinking)</a>
<a class="sourceLine" id="cb1148-2" data-line-number="2"><span class="kw">data</span>(chimpanzees)</a>
<a class="sourceLine" id="cb1148-3" data-line-number="3">d &lt;-<span class="st"> </span>chimpanzees</a></code></pre></div>
<p>The data include two experimental conditions, <code>prosoc_left</code> and <code>condition</code>, each of which has two levels. This results in four combinations.</p>
<div class="sourceCode" id="cb1149"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1149-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1149-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1149-3" data-line-number="3">d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1149-4" data-line-number="4"><span class="st">  </span><span class="kw">distinct</span>(prosoc_left, condition) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1149-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">description =</span> <span class="kw">c</span>(<span class="st">&quot;Two food items on right and no partner&quot;</span>,</a>
<a class="sourceLine" id="cb1149-6" data-line-number="6">                         <span class="st">&quot;Two food items on left and no partner&quot;</span>,</a>
<a class="sourceLine" id="cb1149-7" data-line-number="7">                         <span class="st">&quot;Two food items on right and partner present&quot;</span>,</a>
<a class="sourceLine" id="cb1149-8" data-line-number="8">                         <span class="st">&quot;Two food items on left and partner present&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1149-9" data-line-number="9"><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">prosoc_left</th>
<th align="right">condition</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="left">Two food items on right and no partner</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">0</td>
<td align="left">Two food items on left and no partner</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">1</td>
<td align="left">Two food items on right and partner present</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="left">Two food items on left and partner present</td>
</tr>
</tbody>
</table>
<p>It would be conventional to include these two variables and their interaction using dummy variables. We’re going to follow McElreath and use an index variable approach, instead. If you’d like to see what this would look like using the dummy variable approach, check out my <span class="citation">(<a href="#ref-kurzStatisticalRethinkingBrms2020">2020</a><a href="#ref-kurzStatisticalRethinkingBrms2020">a</a>)</span> <a href="https://bookdown.org/content/3890/counting-and-classification.html#logistic-regression-prosocial-chimpanzees.">translation of the corresponding section</a> from McElreath’s first edition <span class="citation">(McElreath, <a href="#ref-mcelreathStatisticalRethinkingBayesian2015">2015</a>)</span>. For now, make the index, which we’ll be saving as a factor.</p>
<div class="sourceCode" id="cb1150"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1150-1" data-line-number="1">d &lt;-</a>
<a class="sourceLine" id="cb1150-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1150-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">factor</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>prosoc_left <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>condition)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1150-4" data-line-number="4"><span class="st">  </span><span class="co"># this will come in handy, later</span></a>
<a class="sourceLine" id="cb1150-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">labels =</span> <span class="kw">factor</span>(treatment,</a>
<a class="sourceLine" id="cb1150-6" data-line-number="6">                         <span class="dt">levels =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1150-7" data-line-number="7">                         <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;r/n&quot;</span>, <span class="st">&quot;l/n&quot;</span>, <span class="st">&quot;r/p&quot;</span>, <span class="st">&quot;l/p&quot;</span>)))</a></code></pre></div>
<p>We can use the <code>dplyr::count()</code> function to get a sense of the distribution of the conditions in the data.</p>
<div class="sourceCode" id="cb1151"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1151-1" data-line-number="1">d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1151-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>(condition, treatment, prosoc_left)</a></code></pre></div>
<pre><code>## # A tibble: 4 x 4
##   condition treatment prosoc_left     n
##       &lt;int&gt; &lt;fct&gt;           &lt;int&gt; &lt;int&gt;
## 1         0 1                   0   126
## 2         0 2                   1   126
## 3         1 3                   0   126
## 4         1 4                   1   126</code></pre>
<p>Before we go further, switch from <strong>rethinking</strong> to <strong>brms</strong>.</p>
<div class="sourceCode" id="cb1153"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1153-1" data-line-number="1"><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</a>
<a class="sourceLine" id="cb1153-2" data-line-number="2"><span class="kw">library</span>(brms)</a>
<a class="sourceLine" id="cb1153-3" data-line-number="3"><span class="kw">rm</span>(chimpanzees)</a></code></pre></div>
<p>We start with the simple intercept-only logistic regression model, which follows the statistical formula</p>
<p><span class="math display">\[\begin{align*}
\text{pulled_left}_i &amp; \sim \operatorname{Binomial} (1, p_i) \\
\operatorname{logit} (p_i)    &amp; = \alpha \\
\alpha                &amp; \sim \operatorname{Normal} (0, w),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(w\)</span> is the hyperparameter for <span class="math inline">\(\sigma\)</span> the value for which we have yet to choose. To start things off, we’ll set <span class="math inline">\(w = 10\)</span>, fit a model with where we set <code>sample_prior = T</code>, and get a sense of the prior on a plot.</p>
<p>In the <code>brm()</code> <code>formula</code> syntax, including a <code>|</code> bar on the left side of a formula indicates we have extra supplementary information about our criterion. In this case, that information is that each <code>pulled_left</code> value corresponds to a single trial (i.e., <code>trials(1)</code>), which itself corresponds to the <span class="math inline">\(n = 1\)</span> portion of the statistical formula, above.</p>
<div class="sourceCode" id="cb1154"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1154-1" data-line-number="1">b11<span class="fl">.1</span> &lt;-</a>
<a class="sourceLine" id="cb1154-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1154-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1154-4" data-line-number="4">      pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1154-5" data-line-number="5">      <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1154-6" data-line-number="6">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1154-7" data-line-number="7">      <span class="dt">sample_prior =</span> T,</a>
<a class="sourceLine" id="cb1154-8" data-line-number="8">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.01&quot;</span>)</a></code></pre></div>
<p>Before we go any further, let’s discuss the plot theme. For this chapter, we’ll take our color scheme from the <code>&quot;Moonrise2&quot;</code> palette from the <a href="https://cran.r-project.org/package=wesanderson"><strong>wesanderson</strong> package</a> <span class="citation">(Ram &amp; Wickham, <a href="#ref-R-wesanderson">2018</a>)</span>.</p>
<div class="sourceCode" id="cb1155"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1155-1" data-line-number="1"><span class="co"># install.packages(&quot;wesanderson&quot;, dependencies = T)</span></a>
<a class="sourceLine" id="cb1155-2" data-line-number="2"><span class="kw">library</span>(wesanderson)</a>
<a class="sourceLine" id="cb1155-3" data-line-number="3"><span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-7-1.png" width="288" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb1156"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1156-1" data-line-number="1"><span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</a></code></pre></div>
<pre><code>## [1] &quot;#798E87&quot; &quot;#C27D38&quot; &quot;#CCC591&quot; &quot;#29211F&quot;</code></pre>
<p>We’ll also take a few formatting cues from Edward Tufte <span class="citation">(<a href="#ref-tufteVisualDisplayQuantitative2001">2001</a>)</span>, courtesy of the <a href="https://cran.r-project.org/package=ggthemes"><strong>ggthemes package</strong></a>. The <code>theme_tufte()</code> function will change the default font and remove some chart junk. The <code>theme_set()</code> function, below, will make these adjustments the default for all subsequent ggplot2 plots. To undo this, just execute <code>theme_set(theme_default())</code>.</p>
<div class="sourceCode" id="cb1158"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1158-1" data-line-number="1"><span class="kw">library</span>(ggthemes)</a>
<a class="sourceLine" id="cb1158-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1158-3" data-line-number="3"><span class="kw">theme_set</span>(</a>
<a class="sourceLine" id="cb1158-4" data-line-number="4">  <span class="kw">theme_default</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1158-5" data-line-number="5"><span class="st">    </span><span class="kw">theme_tufte</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb1158-6" data-line-number="6"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">plot.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">3</span>],</a>
<a class="sourceLine" id="cb1158-7" data-line-number="7">                                         <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb1158-8" data-line-number="8">)</a></code></pre></div>
<p>Now we’re ready to plot. We’ll extract the prior draws with <code>prior_samples()</code>, convert them from the log-odds metric to the probability metric with the <code>brms::inv_logit_scaled()</code> function, and adjust the bandwidth of the density plot with the <code>adjust</code> argument within <code>geom_density()</code>.</p>
<div class="sourceCode" id="cb1159"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1159-1" data-line-number="1"><span class="kw">prior_samples</span>(b11<span class="fl">.1</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1159-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p =</span> <span class="kw">inv_logit_scaled</span>(Intercept)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1159-3" data-line-number="3"><span class="st">  </span></a>
<a class="sourceLine" id="cb1159-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> p)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1159-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">fill  =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>], </a>
<a class="sourceLine" id="cb1159-6" data-line-number="6">               <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">adjust =</span> <span class="fl">0.1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1159-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1159-8" data-line-number="8"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;prior prob pull left&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-9-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>At this point in the analysis, we were only able to make part of the left panel of McElreath’s Figure 11.3. We’ll add to it in a bit. Now update the model so that <span class="math inline">\(w = 1.5\)</span></p>
<div class="sourceCode" id="cb1160"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1160-1" data-line-number="1">b11<span class="fl">.1</span>b &lt;-</a>
<a class="sourceLine" id="cb1160-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1160-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1160-4" data-line-number="4">      pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1160-5" data-line-number="5">      <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1160-6" data-line-number="6">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1160-7" data-line-number="7">      <span class="dt">sample_prior =</span> T,</a>
<a class="sourceLine" id="cb1160-8" data-line-number="8">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.01b&quot;</span>)</a></code></pre></div>
<p>Now we can make the full version of the left panel of Figure 11.3.</p>
<div class="sourceCode" id="cb1161"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1161-1" data-line-number="1"><span class="co"># wrangle</span></a>
<a class="sourceLine" id="cb1161-2" data-line-number="2"><span class="kw">bind_rows</span>(<span class="kw">prior_samples</span>(b11<span class="fl">.1</span>),</a>
<a class="sourceLine" id="cb1161-3" data-line-number="3">          <span class="kw">prior_samples</span>(b11<span class="fl">.1</span>b)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1161-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p =</span> <span class="kw">inv_logit_scaled</span>(Intercept),</a>
<a class="sourceLine" id="cb1161-5" data-line-number="5">         <span class="dt">w =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">10</span>, <span class="fl">1.5</span>), <span class="dt">each =</span> <span class="kw">n</span>() <span class="op">/</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1161-6" data-line-number="6">                    <span class="dt">levels =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="fl">1.5</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1161-7" data-line-number="7"><span class="st">  </span></a>
<a class="sourceLine" id="cb1161-8" data-line-number="8"><span class="st">  </span><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1161-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> p, <span class="dt">fill =</span> w)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1161-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">adjust =</span> <span class="fl">0.1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1161-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="kw">expression</span>(<span class="kw">italic</span>(w)), <span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1161-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1161-13" data-line-number="13"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(alpha<span class="op">%~%</span><span class="kw">Normal</span>(<span class="dv">0</span><span class="op">*</span><span class="st">&quot;, &quot;</span><span class="op">*</span><span class="kw">italic</span>(w))),</a>
<a class="sourceLine" id="cb1161-14" data-line-number="14">       <span class="dt">x =</span> <span class="st">&quot;prior prob pull left&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-10-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>If we’d like to fit a model that includes an onverall intercept and uses McElreath’d index variable approach for the predictor variable <code>treatment</code>, we’ll have to switch to the <strong>brms</strong> non-linear syntax. Here it is for the models using <span class="math inline">\(w = 10\)</span> and then <span class="math inline">\(w = 0.5\)</span>.</p>
<div class="sourceCode" id="cb1162"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1162-1" data-line-number="1"><span class="co"># w = 10</span></a>
<a class="sourceLine" id="cb1162-2" data-line-number="2">b11<span class="fl">.2</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1162-3" data-line-number="3"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1162-4" data-line-number="4">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1162-5" data-line-number="5">      <span class="kw">bf</span>(pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span>a <span class="op">+</span><span class="st"> </span>b,</a>
<a class="sourceLine" id="cb1162-6" data-line-number="6">         a <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, </a>
<a class="sourceLine" id="cb1162-7" data-line-number="7">         b <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>treatment,</a>
<a class="sourceLine" id="cb1162-8" data-line-number="8">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1162-9" data-line-number="9">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1162-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">nlpar =</span> b, <span class="dt">coef =</span> treatment1),</a>
<a class="sourceLine" id="cb1162-11" data-line-number="11">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">nlpar =</span> b, <span class="dt">coef =</span> treatment2),</a>
<a class="sourceLine" id="cb1162-12" data-line-number="12">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">nlpar =</span> b, <span class="dt">coef =</span> treatment3),</a>
<a class="sourceLine" id="cb1162-13" data-line-number="13">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">nlpar =</span> b, <span class="dt">coef =</span> treatment4)),</a>
<a class="sourceLine" id="cb1162-14" data-line-number="14">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1162-15" data-line-number="15">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1162-16" data-line-number="16">      <span class="dt">sample_prior =</span> T,</a>
<a class="sourceLine" id="cb1162-17" data-line-number="17">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.02&quot;</span>)</a>
<a class="sourceLine" id="cb1162-18" data-line-number="18"></a>
<a class="sourceLine" id="cb1162-19" data-line-number="19"><span class="co"># w = 0.5</span></a>
<a class="sourceLine" id="cb1162-20" data-line-number="20">b11<span class="fl">.3</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1162-21" data-line-number="21"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1162-22" data-line-number="22">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1162-23" data-line-number="23">      <span class="kw">bf</span>(pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span>a <span class="op">+</span><span class="st"> </span>b,</a>
<a class="sourceLine" id="cb1162-24" data-line-number="24">         a <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, </a>
<a class="sourceLine" id="cb1162-25" data-line-number="25">         b <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>treatment,</a>
<a class="sourceLine" id="cb1162-26" data-line-number="26">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1162-27" data-line-number="27">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1162-28" data-line-number="28">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">nlpar =</span> b, <span class="dt">coef =</span> treatment1),</a>
<a class="sourceLine" id="cb1162-29" data-line-number="29">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">nlpar =</span> b, <span class="dt">coef =</span> treatment2),</a>
<a class="sourceLine" id="cb1162-30" data-line-number="30">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">nlpar =</span> b, <span class="dt">coef =</span> treatment3),</a>
<a class="sourceLine" id="cb1162-31" data-line-number="31">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">nlpar =</span> b, <span class="dt">coef =</span> treatment4)),</a>
<a class="sourceLine" id="cb1162-32" data-line-number="32">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1162-33" data-line-number="33">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1162-34" data-line-number="34">      <span class="dt">sample_prior =</span> T,</a>
<a class="sourceLine" id="cb1162-35" data-line-number="35">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.03&quot;</span>)</a></code></pre></div>
<p>If all you want to do is fit the models, you wouldn’t have to add a separate <code>prior()</code> statement for each level of <code>treatment</code>. You could have just included a single line, <code>prior(normal(0, 0.5), nlpar = b)</code>, that did not include a <code>coef</code> argument. The problem with this approach is we’d only get one column for <code>treatment</code> when using the <code>prior_samples()</code> function to retrieve the prior samples. To get separate columns for the prior samples of each of the levels of <code>treatment</code>, you need to take the verbose approach, above.</p>
<p>Anyway, here’s how to make a version of the right panel of Figure 11.3.</p>
<div class="sourceCode" id="cb1163"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1163-1" data-line-number="1"><span class="co"># wrangle</span></a>
<a class="sourceLine" id="cb1163-2" data-line-number="2">prior &lt;-</a>
<a class="sourceLine" id="cb1163-3" data-line-number="3"><span class="st">  </span><span class="kw">bind_rows</span>(<span class="kw">prior_samples</span>(b11<span class="fl">.2</span>),</a>
<a class="sourceLine" id="cb1163-4" data-line-number="4">            <span class="kw">prior_samples</span>(b11<span class="fl">.3</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1163-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">w =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">10</span>, <span class="fl">0.5</span>), <span class="dt">each =</span> <span class="kw">n</span>() <span class="op">/</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1163-6" data-line-number="6">                    <span class="dt">levels =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="fl">0.5</span>)),</a>
<a class="sourceLine" id="cb1163-7" data-line-number="7">         <span class="dt">p1 =</span> <span class="kw">inv_logit_scaled</span>(b_a <span class="op">+</span><span class="st"> </span>b_b_treatment1),</a>
<a class="sourceLine" id="cb1163-8" data-line-number="8">         <span class="dt">p2 =</span> <span class="kw">inv_logit_scaled</span>(b_a <span class="op">+</span><span class="st"> </span>b_b_treatment2)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1163-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> <span class="kw">abs</span>(p1 <span class="op">-</span><span class="st"> </span>p2)) </a>
<a class="sourceLine" id="cb1163-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1163-11" data-line-number="11"><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1163-12" data-line-number="12">prior <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1163-13" data-line-number="13"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> diff, <span class="dt">fill =</span> w)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1163-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">adjust =</span> <span class="fl">0.1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1163-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="kw">expression</span>(<span class="kw">italic</span>(w)), <span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">2</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1163-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1163-17" data-line-number="17"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(alpha<span class="op">%~%</span><span class="kw">Normal</span>(<span class="dv">0</span><span class="op">*</span><span class="st">&quot;, &quot;</span><span class="op">*</span><span class="kw">italic</span>(w))),</a>
<a class="sourceLine" id="cb1163-18" data-line-number="18">       <span class="dt">x =</span> <span class="st">&quot;prior diff between treatments&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-11-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>Here are the averages of the two prior-predictive difference distributions.</p>
<div class="sourceCode" id="cb1164"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1164-1" data-line-number="1">prior <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1164-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(w) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1164-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(diff))</a></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   w       mean
##   &lt;fct&gt;  &lt;dbl&gt;
## 1 10    0.483 
## 2 0.5   0.0973</code></pre>
<p>Before we move on to fit the full model, it might be useful to linger here and examine the nature of the model we just fit. Here’s the parameter summary for <code>b11.3</code>.</p>
<div class="sourceCode" id="cb1166"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1166-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.3</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: pulled_left | trials(1) ~ a + b 
##          a ~ 1
##          b ~ 0 + treatment
##    Data: d (Number of observations: 504) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a_Intercept      0.33      0.26    -0.18     0.83 1.01      995     1113
## b_treatment1    -0.12      0.29    -0.68     0.44 1.01     1212     1755
## b_treatment2     0.29      0.29    -0.27     0.87 1.00     1266     1398
## b_treatment3    -0.37      0.29    -0.94     0.18 1.00     1152     1682
## b_treatment4     0.21      0.29    -0.35     0.77 1.01     1192     1450
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Now focus on the likelihood portion of the model formula,</p>
<p><span class="math display">\[\begin{align*}
\text{pulled_left}_i &amp; \sim \operatorname{Binomial} (1, p_i) \\
\operatorname{logit} (p_i) &amp; = \alpha+ \beta_\text{treatment} .
\end{align*}\]</span></p>
<p>When you have one overall intercept <span class="math inline">\(\alpha\)</span> and then use the non-linear approach for the <code>treatment</code> index, you end up with as many <span class="math inline">\(\beta\)</span> parameters as there levels for <code>treatment</code>. This means the formula for <code>treatment == 1</code> is <span class="math inline">\(\alpha + \beta_{\text{treatment}[1]}\)</span>, the formula for <code>treatment == 2</code> is <span class="math inline">\(\alpha + \beta_{\text{treatment}[2]}\)</span>, and so on. This also effectively makes <span class="math inline">\(\alpha\)</span> the grand mean. Here’s the empirical grand mean.</p>
<div class="sourceCode" id="cb1168"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1168-1" data-line-number="1">d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1168-2" data-line-number="2"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">grand_mean =</span> <span class="kw">mean</span>(pulled_left))</a></code></pre></div>
<pre><code>##   grand_mean
## 1  0.5793651</code></pre>
<p>Now here’s the summary of <span class="math inline">\(\alpha\)</span> after transforming it back into the probability metric with the <code>inv_logit_scaled()</code> function.</p>
<div class="sourceCode" id="cb1170"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1170-1" data-line-number="1"><span class="kw">library</span>(tidybayes)</a>
<a class="sourceLine" id="cb1170-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1170-3" data-line-number="3"><span class="kw">posterior_samples</span>(b11<span class="fl">.3</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1170-4" data-line-number="4"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">alpha =</span> <span class="kw">inv_logit_scaled</span>(b_a_Intercept)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1170-5" data-line-number="5"><span class="st">  </span><span class="kw">mean_qi</span>()</a></code></pre></div>
<pre><code>##       alpha    .lower    .upper .width .point .interval
## 1 0.5793642 0.4559913 0.6969244   0.95   mean        qi</code></pre>
<p>Here are the empirical probabilities for each of the four levels of <code>treatment</code>.</p>
<div class="sourceCode" id="cb1172"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1172-1" data-line-number="1">d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1172-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(treatment) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1172-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(pulled_left))</a></code></pre></div>
<pre><code>## # A tibble: 4 x 2
##   treatment  mean
##   &lt;fct&gt;     &lt;dbl&gt;
## 1 1         0.548
## 2 2         0.659
## 3 3         0.476
## 4 4         0.635</code></pre>
<p>Here are the corresponding posteriors.</p>
<div class="sourceCode" id="cb1174"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1174-1" data-line-number="1"><span class="kw">posterior_samples</span>(b11<span class="fl">.3</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1174-2" data-line-number="2"><span class="st">  </span><span class="kw">pivot_longer</span>(b_b_treatment1<span class="op">:</span>b_b_treatment4) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1174-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">str_remove</span>(name, <span class="st">&quot;b_b_treatment&quot;</span>),</a>
<a class="sourceLine" id="cb1174-4" data-line-number="4">         <span class="dt">mean      =</span> <span class="kw">inv_logit_scaled</span>(b_a_Intercept <span class="op">+</span><span class="st"> </span>value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1174-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(treatment) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1174-6" data-line-number="6"><span class="st">  </span><span class="kw">mean_qi</span>(mean)</a></code></pre></div>
<pre><code>## # A tibble: 4 x 7
##   treatment  mean .lower .upper .width .point .interval
##   &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
## 1 1         0.551  0.467  0.628   0.95 mean   qi       
## 2 2         0.649  0.566  0.726   0.95 mean   qi       
## 3 3         0.489  0.409  0.571   0.95 mean   qi       
## 4 4         0.629  0.546  0.704   0.95 mean   qi</code></pre>
<p>Okay, let’s get back on track with the text. Now we’re ready to fit the full model, which follows the form</p>
<p><span class="math display">\[\begin{align*}
\text{pulled_left}_i      &amp; \sim \operatorname{Binomial} (1, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_{\text{actor}[i]} + \beta_{\text{treatment}[i]} \\
\alpha_j                  &amp; \sim \operatorname{Normal} (0, 1.5) \\
\beta_k                   &amp; \sim \operatorname{Normal} (0, 0.5).
\end{align*}\]</span></p>
<p>Before fitting the model, we should save <code>actor</code> as a factor.</p>
<div class="sourceCode" id="cb1176"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1176-1" data-line-number="1">d &lt;-</a>
<a class="sourceLine" id="cb1176-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1176-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">actor =</span> <span class="kw">factor</span>(actor))</a></code></pre></div>
<p>Now fit the model.</p>
<div class="sourceCode" id="cb1177"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1177-1" data-line-number="1">b11<span class="fl">.4</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1177-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1177-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1177-4" data-line-number="4">      <span class="kw">bf</span>(pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span>a <span class="op">+</span><span class="st"> </span>b,</a>
<a class="sourceLine" id="cb1177-5" data-line-number="5">         a <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>actor, </a>
<a class="sourceLine" id="cb1177-6" data-line-number="6">         b <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>treatment,</a>
<a class="sourceLine" id="cb1177-7" data-line-number="7">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1177-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1177-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">nlpar =</span> b)),</a>
<a class="sourceLine" id="cb1177-10" data-line-number="10">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1177-11" data-line-number="11">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1177-12" data-line-number="12">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.04&quot;</span>)</a></code></pre></div>
<p>Inspect the parameter summary.</p>
<div class="sourceCode" id="cb1178"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1178-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.4</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: pulled_left | trials(1) ~ a + b 
##          a ~ 0 + actor
##          b ~ 0 + treatment
##    Data: d (Number of observations: 504) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a_actor1        -0.45      0.33    -1.08     0.20 1.00     1403     2472
## a_actor2         3.90      0.75     2.56     5.48 1.00     3862     2528
## a_actor3        -0.75      0.33    -1.42    -0.10 1.00     1335     2318
## a_actor4        -0.74      0.33    -1.40    -0.11 1.00     1309     2457
## a_actor5        -0.45      0.33    -1.09     0.19 1.01     1330     2290
## a_actor6         0.48      0.34    -0.17     1.15 1.00     1441     2622
## a_actor7         1.96      0.42     1.17     2.81 1.00     2001     2700
## b_treatment1    -0.04      0.28    -0.60     0.52 1.00     1239     2256
## b_treatment2     0.48      0.29    -0.07     1.05 1.00     1191     1943
## b_treatment3    -0.39      0.28    -0.96     0.17 1.00     1154     2195
## b_treatment4     0.37      0.28    -0.19     0.91 1.00     1195     2217
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Here’s how we might make our version of McElreath’s coefficient plot of the <span class="math inline">\(\alpha\)</span> parameters.</p>
<div class="sourceCode" id="cb1180"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1180-1" data-line-number="1"><span class="kw">library</span>(tidybayes)</a>
<a class="sourceLine" id="cb1180-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1180-3" data-line-number="3">post &lt;-<span class="st"> </span><span class="kw">posterior_samples</span>(b11<span class="fl">.4</span>)</a>
<a class="sourceLine" id="cb1180-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1180-5" data-line-number="5">post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1180-6" data-line-number="6"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">contains</span>(<span class="st">&quot;actor&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1180-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">probability =</span> <span class="kw">inv_logit_scaled</span>(value),</a>
<a class="sourceLine" id="cb1180-8" data-line-number="8">         <span class="dt">actor       =</span> <span class="kw">factor</span>(<span class="kw">str_remove</span>(name, <span class="st">&quot;b_a_actor&quot;</span>),</a>
<a class="sourceLine" id="cb1180-9" data-line-number="9">                              <span class="dt">levels =</span> <span class="dv">7</span><span class="op">:</span><span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1180-10" data-line-number="10"><span class="st">  </span></a>
<a class="sourceLine" id="cb1180-11" data-line-number="11"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> probability, <span class="dt">y =</span> actor)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1180-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">.5</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span>], <span class="dt">linetype =</span> <span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1180-13" data-line-number="13"><span class="st">  </span><span class="kw">stat_pointinterval</span>(<span class="dt">.width =</span> <span class="fl">.95</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb1180-14" data-line-number="14">                     <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1180-15" data-line-number="15"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="kw">expression</span>(alpha[actor]),</a>
<a class="sourceLine" id="cb1180-16" data-line-number="16">       <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1180-17" data-line-number="17"><span class="st">  </span><span class="kw">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1180-18" data-line-number="18"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-20-1.png" width="432" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb1181"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1181-1" data-line-number="1">tx &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;R/N&quot;</span>, <span class="st">&quot;L/N&quot;</span>, <span class="st">&quot;R/P&quot;</span>, <span class="st">&quot;L/P&quot;</span>)</a>
<a class="sourceLine" id="cb1181-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1181-3" data-line-number="3">post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1181-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="kw">contains</span>(<span class="st">&quot;treatment&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1181-5" data-line-number="5"><span class="st">  </span><span class="kw">set_names</span>(<span class="st">&quot;R/N&quot;</span>,<span class="st">&quot;L/N&quot;</span>,<span class="st">&quot;R/P&quot;</span>,<span class="st">&quot;L/P&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1181-6" data-line-number="6"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1181-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">probability =</span> <span class="kw">inv_logit_scaled</span>(value),</a>
<a class="sourceLine" id="cb1181-8" data-line-number="8">         <span class="dt">treatment   =</span> <span class="kw">factor</span>(name, <span class="dt">levels =</span> tx)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1181-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">fct_rev</span>(treatment)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1181-10" data-line-number="10"><span class="st">  </span></a>
<a class="sourceLine" id="cb1181-11" data-line-number="11"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> treatment)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1181-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>], <span class="dt">linetype =</span> <span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1181-13" data-line-number="13"><span class="st">  </span><span class="kw">stat_pointinterval</span>(<span class="dt">.width =</span> <span class="fl">.95</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb1181-14" data-line-number="14">                     <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1181-15" data-line-number="15"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="kw">expression</span>(beta[treatment]),</a>
<a class="sourceLine" id="cb1181-16" data-line-number="16">       <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1181-17" data-line-number="17"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-21-1.png" width="336" style="display: block; margin: auto;" /></p>
<p>Now make the coefficient plot for the primary contrasts of interest.</p>
<div class="sourceCode" id="cb1182"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1182-1" data-line-number="1">post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1182-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">db13 =</span> b_b_treatment1 <span class="op">-</span><span class="st"> </span>b_b_treatment3,</a>
<a class="sourceLine" id="cb1182-3" data-line-number="3">         <span class="dt">db24 =</span> b_b_treatment2 <span class="op">-</span><span class="st"> </span>b_b_treatment4) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1182-4" data-line-number="4"><span class="st">  </span><span class="kw">pivot_longer</span>(db13<span class="op">:</span>db24) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1182-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diffs =</span> <span class="kw">factor</span>(name, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;db24&quot;</span>, <span class="st">&quot;db13&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1182-6" data-line-number="6"><span class="st">  </span></a>
<a class="sourceLine" id="cb1182-7" data-line-number="7"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> diffs)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1182-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>], <span class="dt">linetype =</span> <span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1182-9" data-line-number="9"><span class="st">  </span><span class="kw">stat_pointinterval</span>(<span class="dt">.width =</span> <span class="fl">.95</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb1182-10" data-line-number="10">                     <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1182-11" data-line-number="11"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;difference&quot;</span>,</a>
<a class="sourceLine" id="cb1182-12" data-line-number="12">       <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1182-13" data-line-number="13"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-22-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>“These are the contrasts between the no-partner/partner treatments” (p. 331). Next, we prepare for the posterior predictive check. McElreath showed how to compute empirical proportions by the levels of <code>actor</code> and <code>treatment</code> with the <code>by()</code> function. Our approach will be with a combination of <code>group_by()</code> and <code>summarise()</code>. Here’s what that looks like for <code>actor == 1</code>.</p>
<div class="sourceCode" id="cb1183"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1183-1" data-line-number="1">d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1183-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(actor, treatment) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1183-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">proportion =</span> <span class="kw">mean</span>(pulled_left)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1183-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(actor <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
## # Groups:   actor [1]
##   actor treatment proportion
##   &lt;fct&gt; &lt;fct&gt;          &lt;dbl&gt;
## 1 1     1              0.333
## 2 1     2              0.5  
## 3 1     3              0.278
## 4 1     4              0.556</code></pre>
<p>Now we’ll follow that through to make the top panel of Figure 11.4. Instead of showing the plot, we’ll save it for the next code block.</p>
<div class="sourceCode" id="cb1185"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1185-1" data-line-number="1">p1 &lt;-</a>
<a class="sourceLine" id="cb1185-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1185-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(actor, treatment) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1185-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">proportion =</span> <span class="kw">mean</span>(pulled_left)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1185-5" data-line-number="5"><span class="st">  </span><span class="kw">left_join</span>(d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>(actor, treatment, labels, condition, prosoc_left),</a>
<a class="sourceLine" id="cb1185-6" data-line-number="6">            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;actor&quot;</span>, <span class="st">&quot;treatment&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1185-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">condition =</span> <span class="kw">factor</span>(condition)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1185-8" data-line-number="8"><span class="st">  </span></a>
<a class="sourceLine" id="cb1185-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> labels, <span class="dt">y =</span> proportion)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1185-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="fl">.5</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">3</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1185-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> prosoc_left),</a>
<a class="sourceLine" id="cb1185-12" data-line-number="12">            <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1185-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> condition),</a>
<a class="sourceLine" id="cb1185-14" data-line-number="14">             <span class="dt">size =</span> <span class="fl">2.5</span>, <span class="dt">show.legend =</span> F) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1185-15" data-line-number="15"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;observed proportions&quot;</span>)</a></code></pre></div>
<p>Next we use <code>brms()</code> fitted to get the posterior predictive distributions for each unique combination of <code>actor</code> and <code>treatment</code>, wrangle, and plot. First, we save the plot as <code>p2</code> and then we use <strong>patchwork</strong> syntax to combine the two subplots.</p>
<div class="sourceCode" id="cb1186"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1186-1" data-line-number="1">nd &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1186-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1186-3" data-line-number="3"><span class="st">  </span><span class="kw">distinct</span>(actor, treatment, labels, condition, prosoc_left)</a>
<a class="sourceLine" id="cb1186-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1186-5" data-line-number="5">p2 &lt;-</a>
<a class="sourceLine" id="cb1186-6" data-line-number="6"><span class="st">  </span><span class="kw">fitted</span>(b11<span class="fl">.4</span>,</a>
<a class="sourceLine" id="cb1186-7" data-line-number="7">         <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1186-8" data-line-number="8"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1186-9" data-line-number="9"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1186-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">condition =</span> <span class="kw">factor</span>(condition)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1186-11" data-line-number="11"><span class="st">  </span></a>
<a class="sourceLine" id="cb1186-12" data-line-number="12"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> labels, <span class="dt">y =</span> Estimate, <span class="dt">ymin =</span> Q2<span class="fl">.5</span>, <span class="dt">ymax =</span> Q97<span class="fl">.5</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1186-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="fl">.5</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">3</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1186-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> prosoc_left),</a>
<a class="sourceLine" id="cb1186-15" data-line-number="15">            <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1186-16" data-line-number="16"><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">color =</span> condition),</a>
<a class="sourceLine" id="cb1186-17" data-line-number="17">                  <span class="dt">fatten =</span> <span class="fl">2.5</span>, <span class="dt">show.legend =</span> F) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1186-18" data-line-number="18"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;posterior predictions&quot;</span>)</a>
<a class="sourceLine" id="cb1186-19" data-line-number="19"></a>
<a class="sourceLine" id="cb1186-20" data-line-number="20"><span class="co"># combine the to subplots</span></a>
<a class="sourceLine" id="cb1186-21" data-line-number="21"><span class="kw">library</span>(patchwork)</a>
<a class="sourceLine" id="cb1186-22" data-line-number="22"></a>
<a class="sourceLine" id="cb1186-23" data-line-number="23">(p1 <span class="op">/</span><span class="st"> </span>p2) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb1186-24" data-line-number="24"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="kw">c</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>)]) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb1186-25" data-line-number="25"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;proportion left lever&quot;</span>, </a>
<a class="sourceLine" id="cb1186-26" data-line-number="26">                     <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb1186-27" data-line-number="27"><span class="st">  </span><span class="kw">xlab</span>(<span class="ot">NULL</span>) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb1186-28" data-line-number="28"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1186-29" data-line-number="29">        <span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="dt">size =</span> <span class="dv">0</span>)) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb1186-30" data-line-number="30"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>actor, <span class="dt">nrow =</span> <span class="dv">1</span>, <span class="dt">labeller =</span> label_both)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-25-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Let’s make two more index variables.</p>
<div class="sourceCode" id="cb1187"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1187-1" data-line-number="1">d &lt;-</a>
<a class="sourceLine" id="cb1187-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1187-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">side =</span> <span class="kw">factor</span>(prosoc_left <span class="op">+</span><span class="st"> </span><span class="dv">1</span>),  <span class="co"># right 1, left 2</span></a>
<a class="sourceLine" id="cb1187-4" data-line-number="4">         <span class="dt">cond =</span> <span class="kw">factor</span>(condition <span class="op">+</span><span class="st"> </span><span class="dv">1</span>))    <span class="co"># no partner 1, partner 2</span></a></code></pre></div>
<p>Now fit the model without the interaction between <code>prosoc_left</code> and <code>condition</code>.</p>
<div class="sourceCode" id="cb1188"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1188-1" data-line-number="1">b11<span class="fl">.5</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1188-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1188-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1188-4" data-line-number="4">      <span class="kw">bf</span>(pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span>a <span class="op">+</span><span class="st"> </span>bs <span class="op">+</span><span class="st"> </span>bc,</a>
<a class="sourceLine" id="cb1188-5" data-line-number="5">         a <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>actor, </a>
<a class="sourceLine" id="cb1188-6" data-line-number="6">         bs <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>side, </a>
<a class="sourceLine" id="cb1188-7" data-line-number="7">         bc <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>cond,</a>
<a class="sourceLine" id="cb1188-8" data-line-number="8">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1188-9" data-line-number="9">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1188-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">nlpar =</span> bs),</a>
<a class="sourceLine" id="cb1188-11" data-line-number="11">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">nlpar =</span> bc)),</a>
<a class="sourceLine" id="cb1188-12" data-line-number="12">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1188-13" data-line-number="13">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1188-14" data-line-number="14">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.05&quot;</span>)</a></code></pre></div>
<p>Compare <code>b11.4</code> and <code>b11.5</code> by the PSIS-LOO and the WAIC.</p>
<div class="sourceCode" id="cb1189"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1189-1" data-line-number="1">b11<span class="fl">.4</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.4</span>, <span class="kw">c</span>(<span class="st">&quot;loo&quot;</span>, <span class="st">&quot;waic&quot;</span>))</a>
<a class="sourceLine" id="cb1189-2" data-line-number="2">b11<span class="fl">.5</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.5</span>, <span class="kw">c</span>(<span class="st">&quot;loo&quot;</span>, <span class="st">&quot;waic&quot;</span>))</a>
<a class="sourceLine" id="cb1189-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1189-4" data-line-number="4"><span class="kw">loo_compare</span>(b11<span class="fl">.4</span>, b11<span class="fl">.5</span>, <span class="dt">criterion =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</a></code></pre></div>
<pre><code>##       elpd_diff se_diff elpd_loo se_elpd_loo p_loo  se_p_loo looic  se_looic
## b11.5    0.0       0.0  -265.4      9.6         7.8    0.4    530.8   19.1  
## b11.4   -0.6       0.6  -266.0      9.5         8.4    0.4    532.0   19.0</code></pre>
<div class="sourceCode" id="cb1191"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1191-1" data-line-number="1"><span class="kw">loo_compare</span>(b11<span class="fl">.4</span>, b11<span class="fl">.5</span>, <span class="dt">criterion =</span> <span class="st">&quot;waic&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</a></code></pre></div>
<pre><code>##       elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
## b11.5    0.0       0.0  -265.4       9.6          7.7    0.4     530.8   19.1 
## b11.4   -0.6       0.6  -266.0       9.5          8.4    0.4     531.9   19.0</code></pre>
<p>Here are the weights.</p>
<div class="sourceCode" id="cb1193"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1193-1" data-line-number="1"><span class="kw">model_weights</span>(b11<span class="fl">.4</span>, b11<span class="fl">.5</span>, <span class="dt">weights =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## b11.4 b11.5 
##  0.36  0.64</code></pre>
<div class="sourceCode" id="cb1195"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1195-1" data-line-number="1"><span class="kw">model_weights</span>(b11<span class="fl">.4</span>, b11<span class="fl">.5</span>, <span class="dt">weights =</span> <span class="st">&quot;waic&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## b11.4 b11.5 
##  0.36  0.64</code></pre>
<p>Here’s a quick check of the parameter summary for the non-interaction model, <code>b11.5</code>.</p>
<div class="sourceCode" id="cb1197"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1197-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.5</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: pulled_left | trials(1) ~ a + bs + bc 
##          a ~ 0 + actor
##          bs ~ 0 + side
##          bc ~ 0 + cond
##    Data: d (Number of observations: 504) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a_actor1    -0.64      0.44    -1.50     0.23 1.00      962     1563
## a_actor2     3.76      0.81     2.29     5.52 1.00     1941     2090
## a_actor3    -0.95      0.44    -1.80    -0.08 1.00      898     1693
## a_actor4    -0.94      0.44    -1.79    -0.08 1.00      923     1348
## a_actor5    -0.65      0.44    -1.53     0.22 1.00     1059     1638
## a_actor6     0.28      0.44    -0.59     1.18 1.00     1025     1401
## a_actor7     1.77      0.51     0.82     2.78 1.00     1123     1969
## bs_side1    -0.19      0.33    -0.83     0.42 1.00     1572     2369
## bs_side2     0.50      0.33    -0.16     1.14 1.00     1581     2053
## bc_cond1     0.28      0.34    -0.40     0.92 1.00     1340     1885
## bc_cond2     0.03      0.34    -0.66     0.66 1.00     1331     2136
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Because it’s good practice, here’s the <code>b11.5</code> version of the bottom panel of Figure 11.4.</p>
<div class="sourceCode" id="cb1199"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1199-1" data-line-number="1">nd &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1199-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1199-3" data-line-number="3"><span class="st">  </span><span class="kw">distinct</span>(actor, treatment, labels, cond, side)</a>
<a class="sourceLine" id="cb1199-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1199-5" data-line-number="5"><span class="kw">fitted</span>(b11<span class="fl">.5</span>,</a>
<a class="sourceLine" id="cb1199-6" data-line-number="6">       <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1199-7" data-line-number="7"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1199-8" data-line-number="8"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1199-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb1199-10" data-line-number="10"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> labels, <span class="dt">y =</span> Estimate, <span class="dt">ymin =</span> Q2<span class="fl">.5</span>, <span class="dt">ymax =</span> Q97<span class="fl">.5</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1199-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="fl">.5</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">3</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1199-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> side),</a>
<a class="sourceLine" id="cb1199-13" data-line-number="13">            <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1199-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">color =</span> cond),</a>
<a class="sourceLine" id="cb1199-15" data-line-number="15">                  <span class="dt">fatten =</span> <span class="fl">2.5</span>, <span class="dt">show.legend =</span> F) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1199-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="kw">c</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1199-17" data-line-number="17"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;proportion left lever&quot;</span>, </a>
<a class="sourceLine" id="cb1199-18" data-line-number="18">                     <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1199-19" data-line-number="19"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;posterior predictions for b11.5&quot;</span>,</a>
<a class="sourceLine" id="cb1199-20" data-line-number="20">       <span class="dt">x =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1199-21" data-line-number="21"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1199-22" data-line-number="22">        <span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="dt">size =</span> <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1199-23" data-line-number="23"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>actor, <span class="dt">nrow =</span> <span class="dv">1</span>, <span class="dt">labeller =</span> label_both)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-30-1.png" width="672" style="display: block; margin: auto;" /></p>
<div id="overthinking-adding-log-probability-calculations-to-a-stan-model." class="section level4">
<h4><span class="header-section-number">11.1.1.1</span> Overthinking: Adding log-probability calculations to a Stan model.</h4>
<p>Our approach with <strong>brms</strong> is a little different than the one you might take with McElreath’s <strong>rethinking</strong>. Rather than adding a <code>log_lik=TRUE</code> argument within <code>rethinking::ulam()</code>, we just use the <code>log_lik()</code> after fitting a <strong>brms</strong> model. You may recall we already practiced this way back in Chapter 7. Here’s a quick example of what that looks like for <code>b11.5</code>.</p>
<div class="sourceCode" id="cb1200"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1200-1" data-line-number="1"><span class="kw">log_lik</span>(b11<span class="fl">.5</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str</span>()</a></code></pre></div>
<pre><code>##  num [1:4000, 1:504] -0.418 -0.419 -0.453 -0.366 -0.324 ...
##  - attr(*, &quot;dimnames&quot;)=List of 2
##   ..$ : NULL
##   ..$ : NULL</code></pre>
</div>
</div>
<div id="relative-shark-and-absolute-deer." class="section level3">
<h3><span class="header-section-number">11.1.2</span> Relative shark and absolute deer.</h3>
<p>Based on the full model, <code>b11.4</code>, here’s how you might compute the posterior mean and 95% intervals for the proportional odds of switching from <code>treatment == 2</code> to <code>treatment == 4</code>.</p>
<div class="sourceCode" id="cb1202"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1202-1" data-line-number="1"><span class="kw">posterior_samples</span>(b11<span class="fl">.4</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1202-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">proportional_odds =</span> <span class="kw">exp</span>(b_b_treatment4 <span class="op">-</span><span class="st"> </span>b_b_treatment2)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1202-3" data-line-number="3"><span class="st">  </span><span class="kw">mean_qi</span>(proportional_odds)</a></code></pre></div>
<pre><code>##   proportional_odds    .lower   .upper .width .point .interval
## 1         0.9269721 0.5243428 1.508919   0.95   mean        qi</code></pre>
<blockquote>
<p>On average, the switch multiplies the odds of pulling the left lever by 0.92, an 8% reduction in odds. This is what is meant by proportional odds. The new odds are calculated by taking the old odds and multiplying them by the proportional odds, which is 0.92 in this example. (p. 336)</p>
</blockquote>
<p>A limitation of relative measures measures like proportional odds is they ignore what you might think of as the reference or the baseline.</p>
<blockquote>
<p>Consider for example a rare disease which occurs in 1 per 10-million people. Suppose also that reading this textbook increased the odds of the disease 5-fold. That would mean approximately 4 more cases of the disease per 10-million people. So only 5-in-10-million chance now. The book is safe. (p. 336)</p>
</blockquote>
<p>Here that is in code.</p>
<div class="sourceCode" id="cb1204"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1204-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">disease_rate  =</span> <span class="dv">1</span><span class="op">/</span><span class="fl">1e7</span>,</a>
<a class="sourceLine" id="cb1204-2" data-line-number="2">       <span class="dt">fold_increase =</span> <span class="dv">5</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1204-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">new_disease_rate =</span> disease_rate <span class="op">*</span><span class="st"> </span>fold_increase)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 3
##   disease_rate fold_increase new_disease_rate
##          &lt;dbl&gt;         &lt;dbl&gt;            &lt;dbl&gt;
## 1    0.0000001             5        0.0000005</code></pre>
<p>The hard part, though, is that “neither absolute nor relative risk is sufficient for all purposes” (p. 337). Each provides it’s own unique perspective on the data. Again, welcome to applied statistics. 🤷‍♂</p>
</div>
<div id="aggregated-binomial-chimpanzees-again-condensed." class="section level3">
<h3><span class="header-section-number">11.1.3</span> Aggregated binomial: Chimpanzees again, condensed.</h3>
<p>With the <strong>tidyverse</strong>, we can use <code>group_by()</code> and <code>summarise()</code> to achieve what McElreath did with <code>aggregate()</code>.</p>
<div class="sourceCode" id="cb1206"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1206-1" data-line-number="1">d_aggregated &lt;-</a>
<a class="sourceLine" id="cb1206-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1206-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(treatment, actor, side, cond) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1206-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">left_pulls =</span> <span class="kw">sum</span>(pulled_left)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1206-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb1206-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1206-7" data-line-number="7">d_aggregated <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1206-8" data-line-number="8"><span class="st">  </span><span class="kw">head</span>(<span class="dt">n =</span> <span class="dv">8</span>)</a></code></pre></div>
<pre><code>## # A tibble: 8 x 5
##   treatment actor side  cond  left_pulls
##   &lt;fct&gt;     &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;int&gt;
## 1 1         1     1     1              6
## 2 1         2     1     1             18
## 3 1         3     1     1              5
## 4 1         4     1     1              6
## 5 1         5     1     1              6
## 6 1         6     1     1             14
## 7 1         7     1     1             14
## 8 2         1     2     1              9</code></pre>
<p>To fit an aggregated binomial model with <strong>brms</strong>, we augment the <code>&lt;criterion&gt; | trials()</code> syntax where the value that goes in <code>trials()</code> is either a fixed number, as in this case, or variable in the data indexing <span class="math inline">\(n\)</span>. Either way, at least some of those trials will have an <span class="math inline">\(n &gt; 1\)</span>. Here we’ll use the hard-code method, just like McElreath did in the text.</p>
<div class="sourceCode" id="cb1208"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1208-1" data-line-number="1">b11<span class="fl">.6</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1208-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d_aggregated, </a>
<a class="sourceLine" id="cb1208-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1208-4" data-line-number="4">      <span class="kw">bf</span>(left_pulls <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">18</span>) <span class="op">~</span><span class="st"> </span>a <span class="op">+</span><span class="st"> </span>b,</a>
<a class="sourceLine" id="cb1208-5" data-line-number="5">         a <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>actor, </a>
<a class="sourceLine" id="cb1208-6" data-line-number="6">         b <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>treatment,</a>
<a class="sourceLine" id="cb1208-7" data-line-number="7">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1208-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1208-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">nlpar =</span> b)),</a>
<a class="sourceLine" id="cb1208-10" data-line-number="10">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1208-11" data-line-number="11">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1208-12" data-line-number="12">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.06&quot;</span>)</a></code></pre></div>
<p>Check the posterior summary.</p>
<div class="sourceCode" id="cb1209"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1209-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.6</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: left_pulls | trials(18) ~ a + b 
##          a ~ 0 + actor
##          b ~ 0 + treatment
##    Data: d_aggregated (Number of observations: 28) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a_actor1        -0.45      0.33    -1.10     0.17 1.00     1079     1806
## a_actor2         3.88      0.74     2.54     5.49 1.00     3629     2936
## a_actor3        -0.76      0.35    -1.45    -0.09 1.00     1195     1904
## a_actor4        -0.75      0.34    -1.43    -0.08 1.00     1332     2150
## a_actor5        -0.45      0.34    -1.11     0.21 1.00     1167     1924
## a_actor6         0.48      0.33    -0.18     1.13 1.00     1191     2096
## a_actor7         1.96      0.42     1.17     2.80 1.00     1620     2574
## b_treatment1    -0.04      0.29    -0.61     0.53 1.00     1049     1700
## b_treatment2     0.48      0.29    -0.07     1.08 1.00     1021     2003
## b_treatment3    -0.38      0.29    -0.93     0.20 1.00     1101     2010
## b_treatment4     0.37      0.28    -0.17     0.92 1.00     1041     1521
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>It might be easiest to compare <code>b11.4</code> and <code>b11.6</code> with a coefficient plot.</p>
<div class="sourceCode" id="cb1211"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1211-1" data-line-number="1"><span class="co"># this is just for fancy annotation</span></a>
<a class="sourceLine" id="cb1211-2" data-line-number="2">text &lt;-</a>
<a class="sourceLine" id="cb1211-3" data-line-number="3"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">value =</span> <span class="kw">c</span>(<span class="fl">1.4</span>, <span class="fl">2.6</span>),</a>
<a class="sourceLine" id="cb1211-4" data-line-number="4">         <span class="dt">name  =</span> <span class="st">&quot;b_a_actor7&quot;</span>,</a>
<a class="sourceLine" id="cb1211-5" data-line-number="5">         <span class="dt">fit   =</span> <span class="kw">c</span>(<span class="st">&quot;b11.6&quot;</span>, <span class="st">&quot;b11.4&quot;</span>))</a>
<a class="sourceLine" id="cb1211-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1211-7" data-line-number="7"><span class="co"># rope in the posterior draws and wrangle</span></a>
<a class="sourceLine" id="cb1211-8" data-line-number="8"><span class="kw">bind_rows</span>(<span class="kw">posterior_samples</span>(b11<span class="fl">.4</span>),</a>
<a class="sourceLine" id="cb1211-9" data-line-number="9">          <span class="kw">posterior_samples</span>(b11<span class="fl">.6</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1211-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fit =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;b11.4&quot;</span>, <span class="st">&quot;b11.6&quot;</span>), <span class="dt">each =</span> <span class="kw">n</span>() <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1211-11" data-line-number="11"><span class="st">  </span><span class="kw">pivot_longer</span>(b_a_actor1<span class="op">:</span>b_b_treatment4) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1211-12" data-line-number="12"><span class="st">  </span></a>
<a class="sourceLine" id="cb1211-13" data-line-number="13"><span class="st">  </span><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1211-14" data-line-number="14"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> name, <span class="dt">color =</span> fit)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1211-15" data-line-number="15"><span class="st">  </span><span class="kw">stat_pointinterval</span>(<span class="dt">.width =</span> <span class="fl">.95</span>, <span class="dt">size =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb1211-16" data-line-number="16">                     <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">0.5</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1211-17" data-line-number="17"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="kw">c</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1211-18" data-line-number="18"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> text,</a>
<a class="sourceLine" id="cb1211-19" data-line-number="19">            <span class="kw">aes</span>(<span class="dt">label =</span> fit),</a>
<a class="sourceLine" id="cb1211-20" data-line-number="20">            <span class="dt">family =</span> <span class="st">&quot;Times&quot;</span>, <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">2.25</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1211-21" data-line-number="21"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;posterior (log-odds scale)&quot;</span>,</a>
<a class="sourceLine" id="cb1211-22" data-line-number="22">       <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1211-23" data-line-number="23"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1211-24" data-line-number="24">        <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-36-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Did you catch our <code>position = position_dodge()</code> tricks? Try executing the plot without those parts of the code to get a sense of what they did. Now compute and save the PSIS-LOO estimates for the two models so we might compare them.</p>
<div class="sourceCode" id="cb1212"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1212-1" data-line-number="1">b11<span class="fl">.4</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.4</span>, <span class="st">&quot;loo&quot;</span>)</a>
<a class="sourceLine" id="cb1212-2" data-line-number="2">b11<span class="fl">.6</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.6</span>, <span class="st">&quot;loo&quot;</span>)</a></code></pre></div>
<p>Here’s how we might attempt the comparison.</p>
<div class="sourceCode" id="cb1213"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1213-1" data-line-number="1"><span class="kw">loo_compare</span>(b11<span class="fl">.4</span>, b11<span class="fl">.6</span>, <span class="dt">criterion =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</a></code></pre></div>
<p>Unlike with McElreath’s <code>compare()</code> code in the text, <code>loo_compare()</code> wouldn’t even give us the results. All we get is the warning message that because these two models are not based on the same data, comparing them with the LOO is invalid and <strong>brms</strong> refuses to let us do it. We can, however, look at their LOO summaries separately.</p>
<div class="sourceCode" id="cb1214"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1214-1" data-line-number="1"><span class="kw">loo</span>(b11<span class="fl">.4</span>)</a></code></pre></div>
<pre><code>## 
## Computed from 4000 by 504 log-likelihood matrix
## 
##          Estimate   SE
## elpd_loo   -266.0  9.5
## p_loo         8.4  0.4
## looic       532.0 19.0
## ------
## Monte Carlo SE of elpd_loo is 0.0.
## 
## All Pareto k estimates are good (k &lt; 0.5).
## See help(&#39;pareto-k-diagnostic&#39;) for details.</code></pre>
<div class="sourceCode" id="cb1216"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1216-1" data-line-number="1"><span class="kw">loo</span>(b11<span class="fl">.6</span>)</a></code></pre></div>
<pre><code>## Warning: Found 1 observations with a pareto_k &gt; 0.7 in model &#39;b11.6&#39;. It is recommended to set &#39;reloo = TRUE&#39;
## in order to calculate the ELPD without the assumption that these observations are negligible. This will refit
## the model 1 times to compute the ELPDs for the problematic observations directly.</code></pre>
<pre><code>## 
## Computed from 4000 by 28 log-likelihood matrix
## 
##          Estimate  SE
## elpd_loo    -57.5 4.4
## p_loo         8.8 1.7
## looic       115.0 8.7
## ------
## Monte Carlo SE of elpd_loo is NA.
## 
## Pareto k diagnostic values:
##                          Count Pct.    Min. n_eff
## (-Inf, 0.5]   (good)     18    64.3%   1359      
##  (0.5, 0.7]   (ok)        9    32.1%   539       
##    (0.7, 1]   (bad)       1     3.6%   118       
##    (1, Inf)   (very bad)  0     0.0%   &lt;NA&gt;      
## See help(&#39;pareto-k-diagnostic&#39;) for details.</code></pre>
<p>To understand why, consider how you might describe six 1’s out of nine trials in the aggregated form,</p>
<p><span class="math display">\[\text{Pr}(6|9, p) = \frac{6!}{6!(9 - 6)!} p^6 (1 - p)^{9 - 6}.\]</span></p>
<p>If we still stick with the same data, but this time re-express those as nine dichotomous data points, we now describe their joint probability as</p>
<p><span class="math display">\[\text{Pr}(1, 1, 1, 1, 1, 1, 0, 0, 0 | p) = p^6 (1 - p)^{9 - 6}.\]</span></p>
<p>Let’s work this out in code.</p>
<div class="sourceCode" id="cb1219"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1219-1" data-line-number="1"><span class="co"># deviance of aggregated 6-in-9 </span></a>
<a class="sourceLine" id="cb1219-2" data-line-number="2"><span class="dv">-2</span> <span class="op">*</span><span class="st"> </span><span class="kw">dbinom</span>(<span class="dv">6</span>, <span class="dt">size =</span> <span class="dv">9</span>, <span class="dt">prob =</span> <span class="fl">0.2</span>, <span class="dt">log =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## [1] 11.79048</code></pre>
<div class="sourceCode" id="cb1221"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1221-1" data-line-number="1"><span class="co"># deviance of dis-aggregated </span></a>
<a class="sourceLine" id="cb1221-2" data-line-number="2"><span class="dv">-2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">dbinom</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="fl">0.2</span>, <span class="dt">log =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<pre><code>## [1] 20.65212</code></pre>
<blockquote>
<p>But this difference is entirely meaningless. It is just a side effect of how we organized the data. The posterior distribution for the probability of success on each trial will end up the same, either way. (p. 339)</p>
</blockquote>
<p>This is what our coefficient plot showed us, above. The posterior distribution was the same within simulation variance for <code>b11.4</code> and <code>b11.6</code>. Just like McElreath reported in the text, we also got a warning about high Pareto <span class="math inline">\(k\)</span> values from the aggregated binomial model, <code>b11.6</code>. To access the message and its associated table directly, we can feed the results of <code>loo()</code> into the <code>loo::pareto_k_table</code> function.</p>
<div class="sourceCode" id="cb1223"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1223-1" data-line-number="1"><span class="kw">loo</span>(b11<span class="fl">.6</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1223-2" data-line-number="2"><span class="st">  </span>loo<span class="op">::</span><span class="kw">pareto_k_table</span>()</a></code></pre></div>
<pre><code>## Warning: Found 1 observations with a pareto_k &gt; 0.7 in model &#39;b11.6&#39;. It is recommended to set &#39;reloo = TRUE&#39;
## in order to calculate the ELPD without the assumption that these observations are negligible. This will refit
## the model 1 times to compute the ELPDs for the problematic observations directly.</code></pre>
<pre><code>## Pareto k diagnostic values:
##                          Count Pct.    Min. n_eff
## (-Inf, 0.5]   (good)     18    64.3%   1359      
##  (0.5, 0.7]   (ok)        9    32.1%   539       
##    (0.7, 1]   (bad)       1     3.6%   118       
##    (1, Inf)   (very bad)  0     0.0%   &lt;NA&gt;</code></pre>
<blockquote>
<p>Before looking at the Pareto <span class="math inline">\(k\)</span> values, you might have noticed already that we didn’t get a similar warning before in the disaggregated logistic models of the same data. Why not? Because when we aggregated the data by actor-treatment, we forced PSIS (and WAIC) to imagine cross-validation that leaves out all 18 observations in each actor-treatment combination. So instead of leave-one-out cross-validation, it is more like leave-eighteen-out. This makes some observations more influential, because they are really now 18 observations.</p>
<p>What’s the bottom line? If you want to calculate WAIC or PSIS, you should use a logistic regression data format, not an aggregated format. (p. 340)</p>
</blockquote>
</div>
<div id="aggregated-binomial-graduate-school-admissions." class="section level3">
<h3><span class="header-section-number">11.1.4</span> Aggregated binomial: Graduate school admissions.</h3>
<p>Load the infamous <code>UCBadmit</code> data <span class="citation">(see Bickel et al., <a href="#ref-bickelSexBiasGraduate1975">1975</a>)</span>.</p>
<div class="sourceCode" id="cb1226"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1226-1" data-line-number="1"><span class="co"># detach(package:brms)</span></a>
<a class="sourceLine" id="cb1226-2" data-line-number="2"><span class="kw">library</span>(rethinking)</a>
<a class="sourceLine" id="cb1226-3" data-line-number="3"><span class="kw">data</span>(UCBadmit)</a>
<a class="sourceLine" id="cb1226-4" data-line-number="4">d &lt;-<span class="st"> </span>UCBadmit</a></code></pre></div>
<p>Switch from <strong>rethinking</strong> to <strong>brms</strong>.</p>
<div class="sourceCode" id="cb1227"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1227-1" data-line-number="1"><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</a>
<a class="sourceLine" id="cb1227-2" data-line-number="2"><span class="kw">library</span>(brms)</a>
<a class="sourceLine" id="cb1227-3" data-line-number="3"><span class="kw">rm</span>(UCBadmit)</a>
<a class="sourceLine" id="cb1227-4" data-line-number="4">d</a></code></pre></div>
<pre><code>##    dept applicant.gender admit reject applications
## 1     A             male   512    313          825
## 2     A           female    89     19          108
## 3     B             male   353    207          560
## 4     B           female    17      8           25
## 5     C             male   120    205          325
## 6     C           female   202    391          593
## 7     D             male   138    279          417
## 8     D           female   131    244          375
## 9     E             male    53    138          191
## 10    E           female    94    299          393
## 11    F             male    22    351          373
## 12    F           female    24    317          341</code></pre>
<p>Now compute our new index variable, <code>gid</code>. We’ll also slip in a <code>case</code> variable that saves the row numbers as a factor. That’ll come in handy later when we plot.</p>
<div class="sourceCode" id="cb1229"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1229-1" data-line-number="1">d &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1229-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb1229-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gid  =</span> <span class="kw">factor</span>(applicant.gender, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;male&quot;</span>, <span class="st">&quot;female&quot;</span>)),</a>
<a class="sourceLine" id="cb1229-4" data-line-number="4">         <span class="dt">case =</span> <span class="kw">factor</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">n</span>()))</a></code></pre></div>
<p>Note the difference in how we defined out <code>gid</code>. Whereas McElreath used numeral indices, we retained the text within an ordered factor. <strong>brms</strong> can handle either approach just fine. The advantage of the factor approach is it will be easier to understand the output. You’ll see in just a bit.</p>
<p>The univariable logistic model with <code>male</code> as the sole predictor of <code>admit</code> follows the form</p>
<p><span class="math display">\[\begin{align*}
\text{admit}_i    &amp; \sim \operatorname{Binomial} (n_i, p_i) \\
\text{logit}(p_i) &amp; = \alpha_{\text{gid}[i]} \\
\alpha_j          &amp; \sim \operatorname{Normal} (0, 1.5),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(n_i = \text{applications}_i\)</span>, the rows are indexed by <span class="math inline">\(i\)</span>, and the two levels of <span class="math inline">\(\text{gid}\)</span> are indexed by <span class="math inline">\(j\)</span>. Since we’re only using our index variable <code>gid</code> to model two intercepts with no further complications, we don’t need to use the verbose non-linear syntax to fit this model with <strong>brms</strong>.</p>
<div class="sourceCode" id="cb1230"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1230-1" data-line-number="1">b11<span class="fl">.7</span> &lt;-</a>
<a class="sourceLine" id="cb1230-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1230-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1230-4" data-line-number="4">      admit <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(applications) <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>gid,</a>
<a class="sourceLine" id="cb1230-5" data-line-number="5">      <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> b),</a>
<a class="sourceLine" id="cb1230-6" data-line-number="6">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1230-7" data-line-number="7">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1230-8" data-line-number="8">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.07&quot;</span>) </a></code></pre></div>
<div class="sourceCode" id="cb1231"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1231-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.7</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: admit | trials(applications) ~ 0 + gid 
##    Data: d (Number of observations: 12) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## gidmale      -0.22      0.04    -0.30    -0.14 1.00     2684     2468
## gidfemale    -0.83      0.05    -0.94    -0.73 1.00     3289     2318
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Our results are very similar to those in the text. But notice how our two rows have more informative row names than <code>a[1]</code> and <code>a[2]</code>. This is why you might consider using the ordered factor approach rather than using numeral indices.</p>
<p>Anyway, here we’ll compute the difference score in two metrics and summarize them with a little help from <code>mean_qi()</code>.</p>
<div class="sourceCode" id="cb1233"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1233-1" data-line-number="1"><span class="kw">posterior_samples</span>(b11<span class="fl">.7</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1233-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff_a =</span> b_gidmale <span class="op">-</span><span class="st"> </span>b_gidfemale,</a>
<a class="sourceLine" id="cb1233-3" data-line-number="3">         <span class="dt">diff_p =</span> <span class="kw">inv_logit_scaled</span>(b_gidmale) <span class="op">-</span><span class="st"> </span><span class="kw">inv_logit_scaled</span>(b_gidfemale)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1233-4" data-line-number="4"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">contains</span>(<span class="st">&quot;diff&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1233-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1233-6" data-line-number="6"><span class="st">  </span><span class="kw">mean_qi</span>(value, <span class="dt">.width =</span> <span class="fl">.89</span>)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 7
##   name   value .lower .upper .width .point .interval
##   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
## 1 diff_a 0.609  0.504  0.715   0.89 mean   qi       
## 2 diff_p 0.141  0.118  0.165   0.89 mean   qi</code></pre>
<p><strong>brms</strong> doesn’t have a convenience function that works quite like <code>rethinking::postcheck()</code>. But we have options, the most handy of which in this case is probably <code>predict()</code>.</p>
<div class="sourceCode" id="cb1235"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1235-1" data-line-number="1">p &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1235-2" data-line-number="2"><span class="st">  </span><span class="kw">predict</span>(b11<span class="fl">.7</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1235-3" data-line-number="3"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1235-4" data-line-number="4"><span class="st">  </span><span class="kw">bind_cols</span>(d)</a>
<a class="sourceLine" id="cb1235-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1235-6" data-line-number="6">text &lt;-</a>
<a class="sourceLine" id="cb1235-7" data-line-number="7"><span class="st">  </span>d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1235-8" data-line-number="8"><span class="st">  </span><span class="kw">group_by</span>(dept) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1235-9" data-line-number="9"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">case  =</span> <span class="kw">mean</span>(<span class="kw">as.numeric</span>(case)),</a>
<a class="sourceLine" id="cb1235-10" data-line-number="10">            <span class="dt">admit =</span> <span class="kw">mean</span>(admit <span class="op">/</span><span class="st"> </span>applications) <span class="op">+</span><span class="st"> </span><span class="fl">.05</span>)</a>
<a class="sourceLine" id="cb1235-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1235-12" data-line-number="12">p <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1235-13" data-line-number="13"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> case, <span class="dt">y =</span> admit <span class="op">/</span><span class="st"> </span>applications)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1235-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">y    =</span> Estimate <span class="op">/</span><span class="st"> </span>applications,</a>
<a class="sourceLine" id="cb1235-15" data-line-number="15">                      <span class="dt">ymin =</span> Q2<span class="fl">.5</span>     <span class="op">/</span><span class="st"> </span>applications ,</a>
<a class="sourceLine" id="cb1235-16" data-line-number="16">                      <span class="dt">ymax =</span> Q97<span class="fl">.5</span>    <span class="op">/</span><span class="st"> </span>applications),</a>
<a class="sourceLine" id="cb1235-17" data-line-number="17">                  <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb1235-18" data-line-number="18">                  <span class="dt">shape =</span> <span class="dv">1</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1235-19" data-line-number="19"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1235-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> dept),</a>
<a class="sourceLine" id="cb1235-21" data-line-number="21">            <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1235-22" data-line-number="22"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> text,</a>
<a class="sourceLine" id="cb1235-23" data-line-number="23">            <span class="kw">aes</span>(<span class="dt">y =</span> admit, <span class="dt">label =</span> dept),</a>
<a class="sourceLine" id="cb1235-24" data-line-number="24">            <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>],</a>
<a class="sourceLine" id="cb1235-25" data-line-number="25">            <span class="dt">family =</span> <span class="st">&quot;serif&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1235-26" data-line-number="26"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Posterior validation check&quot;</span>,</a>
<a class="sourceLine" id="cb1235-27" data-line-number="27">       <span class="dt">y =</span> <span class="st">&quot;Proportion admitted&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1235-28" data-line-number="28"><span class="st">  </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1235-29" data-line-number="29"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-47-1.png" width="432" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Sometimes a fit this bad is the result of a coding mistake. In this case, it is not. The model did correctly answer the question we asked of it: <em>What are the average probabilities of admission for women and men, across all departments?</em> The problem in this case is that men and women did not apply to the same departments, and departments vary in their rates of admission. This makes the answer misleading….</p>
<p>Instead of asking <em>“What are the average probabilities of admission for women and men across all departments?”</em> we want to ask <em>“What is the average difference in probability of admission between women and men within departments?”</em> (pp. 342–343, <em>emphasis</em> in the original).</p>
</blockquote>
<p>The model better suited to answer that question follows the form</p>
<p><span class="math display">\[\begin{align*}
\text{admit}_i    &amp; \sim \operatorname{Binomial} (n_i, p_i) \\
\text{logit}(p_i) &amp; = \alpha_{\text{gid}[i]} + \delta_{\text{dept}[i]} \\
\alpha_j          &amp; \sim \operatorname{Normal} (0, 1.5) \\
\delta_k          &amp; \sim \operatorname{Normal} (0, 1.5),
\end{align*}\]</span></p>
<p>where departments are indexed by <span class="math inline">\(k\)</span>. To fit a model including two index variables like this in <strong>brms</strong>, we’ll need to switch back to the non-linear syntax. Though if you’d like to see an analogous approach using conventional <strong>brms</strong> syntax, check out model <code>b10.9</code> in <a href="https://bookdown.org/content/3890/counting-and-classification.html#aggregated-binomial-graduate-school-admissions.">Section 10.1.3</a> of my translation of McElreath’s first edition.</p>
<div class="sourceCode" id="cb1236"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1236-1" data-line-number="1">b11<span class="fl">.8</span> &lt;-</a>
<a class="sourceLine" id="cb1236-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1236-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1236-4" data-line-number="4">      <span class="kw">bf</span>(admit <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(applications) <span class="op">~</span><span class="st"> </span>a <span class="op">+</span><span class="st"> </span>d,</a>
<a class="sourceLine" id="cb1236-5" data-line-number="5">         a <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>gid, </a>
<a class="sourceLine" id="cb1236-6" data-line-number="6">         d <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>dept,</a>
<a class="sourceLine" id="cb1236-7" data-line-number="7">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1236-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1236-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">nlpar =</span> d)),</a>
<a class="sourceLine" id="cb1236-10" data-line-number="10">      <span class="dt">iter =</span> <span class="dv">4000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1236-11" data-line-number="11">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1236-12" data-line-number="12">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.08&quot;</span>) </a></code></pre></div>
<div class="sourceCode" id="cb1237"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1237-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.8</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: admit | trials(applications) ~ a + d 
##          a ~ 0 + gid
##          d ~ 0 + dept
##    Data: d (Number of observations: 12) 
## Samples: 4 chains, each with iter = 4000; warmup = 1000; thin = 1;
##          total post-warmup samples = 12000
## 
## Population-Level Effects: 
##             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a_gidmale      -0.52      0.55    -1.59     0.57 1.00      920      905
## a_gidfemale    -0.43      0.55    -1.50     0.69 1.00      923      850
## d_deptA         1.10      0.56    -0.00     2.19 1.00      932      831
## d_deptB         1.06      0.56    -0.06     2.14 1.00      936      853
## d_deptC        -0.16      0.56    -1.27     0.91 1.00      927      815
## d_deptD        -0.19      0.56    -1.29     0.89 1.00      928      854
## d_deptE        -0.63      0.56    -1.75     0.44 1.00      937      860
## d_deptF        -2.19      0.57    -3.33    -1.10 1.00      966      907
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Like with the earlier model, here we compute the difference score for <span class="math inline">\(\alpha\)</span> in two metrics.</p>
<div class="sourceCode" id="cb1239"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1239-1" data-line-number="1"><span class="kw">posterior_samples</span>(b11<span class="fl">.8</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1239-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff_a =</span> b_a_gidmale <span class="op">-</span><span class="st"> </span>b_a_gidfemale,</a>
<a class="sourceLine" id="cb1239-3" data-line-number="3">         <span class="dt">diff_p =</span> <span class="kw">inv_logit_scaled</span>(b_a_gidmale) <span class="op">-</span><span class="st"> </span><span class="kw">inv_logit_scaled</span>(b_a_gidfemale)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1239-4" data-line-number="4"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">contains</span>(<span class="st">&quot;diff&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1239-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1239-6" data-line-number="6"><span class="st">  </span><span class="kw">mean_qi</span>(value, <span class="dt">.width =</span> <span class="fl">.89</span>)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 7
##   name     value  .lower  .upper .width .point .interval
##   &lt;chr&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
## 1 diff_a -0.0966 -0.225  0.0303    0.89 mean   qi       
## 2 diff_p -0.0216 -0.0513 0.00668   0.89 mean   qi</code></pre>
<blockquote>
<p>Why did adding departments to the model change the inference about gender so much? The earlier figure gives you a hint–the rates of admission vary a lot across departments. Furthermore, women and men applied to different departments. Let’s do a quick tabulation
to show that: (p. 344)</p>
</blockquote>
<p>Here’s our <strong>tidyverse</strong>-style tabulation of the proportions of applicants in each department by <code>gid</code>.</p>
<div class="sourceCode" id="cb1241"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1241-1" data-line-number="1">d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1241-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(dept) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1241-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">proportion =</span> applications <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(applications)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1241-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(dept, gid, proportion) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1241-5" data-line-number="5"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> dept,</a>
<a class="sourceLine" id="cb1241-6" data-line-number="6">              <span class="dt">values_from =</span> proportion) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1241-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 7
##   gid        A     B     C     D     E     F
##   &lt;fct&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 male    0.88  0.96  0.35  0.53  0.33  0.52
## 2 female  0.12  0.04  0.65  0.47  0.67  0.48</code></pre>
<p>To make it even easier to see, we’ll depict it in a tile plot.</p>
<div class="sourceCode" id="cb1243"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1243-1" data-line-number="1">d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1243-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(dept) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1243-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">proportion =</span> applications <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(applications)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1243-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">label =</span> <span class="kw">round</span>(proportion, <span class="dt">digits =</span> <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1243-5" data-line-number="5">         <span class="dt">gid   =</span> <span class="kw">fct_rev</span>(gid)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1243-6" data-line-number="6"><span class="st">  </span></a>
<a class="sourceLine" id="cb1243-7" data-line-number="7"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> dept, <span class="dt">y =</span> gid, <span class="dt">fill =</span> proportion, <span class="dt">label =</span> label)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1243-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_tile</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb1243-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">color =</span> proportion <span class="op">&gt;</span><span class="st"> </span><span class="fl">.25</span>),</a>
<a class="sourceLine" id="cb1243-10" data-line-number="10">            <span class="dt">family =</span> <span class="st">&quot;serif&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1243-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="dt">low =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>],</a>
<a class="sourceLine" id="cb1243-12" data-line-number="12">                      <span class="dt">high =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb1243-13" data-line-number="13">                      <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1243-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1243-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">position =</span> <span class="st">&quot;top&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1243-16" data-line-number="16"><span class="st">  </span><span class="kw">ylab</span>(<span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1243-17" data-line-number="17"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1243-18" data-line-number="18">        <span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1243-19" data-line-number="19">        <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-51-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>As it turns out, “the departments with a larger proportion of women applicants are also those with lower overall admissions rates” (p. 344). If we presume gender influences both choice of department and admission rates, we might depict that in a simple DAG where <span class="math inline">\(G\)</span> is applicant gender, <span class="math inline">\(D\)</span> is department, and <span class="math inline">\(A\)</span> is acceptance into grad school.</p>
<div class="sourceCode" id="cb1244"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1244-1" data-line-number="1"><span class="kw">library</span>(ggdag)</a>
<a class="sourceLine" id="cb1244-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1244-3" data-line-number="3">dag_coords &lt;-</a>
<a class="sourceLine" id="cb1244-4" data-line-number="4"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">name =</span> <span class="kw">c</span>(<span class="st">&quot;G&quot;</span>, <span class="st">&quot;D&quot;</span>, <span class="st">&quot;A&quot;</span>),</a>
<a class="sourceLine" id="cb1244-5" data-line-number="5">         <span class="dt">x    =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1244-6" data-line-number="6">         <span class="dt">y    =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb1244-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1244-8" data-line-number="8"><span class="kw">dagify</span>(D <span class="op">~</span><span class="st"> </span>G,</a>
<a class="sourceLine" id="cb1244-9" data-line-number="9">       A <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>G,</a>
<a class="sourceLine" id="cb1244-10" data-line-number="10">       <span class="dt">coords =</span> dag_coords) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1244-11" data-line-number="11"><span class="st">  </span></a>
<a class="sourceLine" id="cb1244-12" data-line-number="12"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">xend =</span> xend, <span class="dt">yend =</span> yend)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1244-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_dag_text</span>(<span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>], <span class="dt">family =</span> <span class="st">&quot;serif&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1244-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_dag_edges</span>(<span class="dt">edge_color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1244-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1244-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-52-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>Although our <code>b11.8</code> model did not contain a parameter corresponding to the <span class="math inline">\(G \rightarrow D\)</span> pathway, it did condition on both <span class="math inline">\(G\)</span> and <span class="math inline">\(D\)</span>. If we make another Figure like 11.5, we’ll see conditioning on both substantially improved the posterior predictive distribution.</p>
<div class="sourceCode" id="cb1245"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1245-1" data-line-number="1"><span class="kw">predict</span>(b11<span class="fl">.8</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1245-2" data-line-number="2"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1245-3" data-line-number="3"><span class="st">  </span><span class="kw">bind_cols</span>(d) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1245-4" data-line-number="4"><span class="st">  </span></a>
<a class="sourceLine" id="cb1245-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> case, <span class="dt">y =</span> admit <span class="op">/</span><span class="st"> </span>applications)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1245-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimate <span class="op">/</span><span class="st"> </span>applications,</a>
<a class="sourceLine" id="cb1245-7" data-line-number="7">                      <span class="dt">ymin =</span> Q2<span class="fl">.5</span> <span class="op">/</span><span class="st"> </span>applications ,</a>
<a class="sourceLine" id="cb1245-8" data-line-number="8">                      <span class="dt">ymax =</span> Q97<span class="fl">.5</span> <span class="op">/</span><span class="st"> </span>applications),</a>
<a class="sourceLine" id="cb1245-9" data-line-number="9">                  <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb1245-10" data-line-number="10">                  <span class="dt">shape =</span> <span class="dv">1</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1245-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1245-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> dept),</a>
<a class="sourceLine" id="cb1245-13" data-line-number="13">            <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1245-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> text,</a>
<a class="sourceLine" id="cb1245-15" data-line-number="15">            <span class="kw">aes</span>(<span class="dt">y =</span> admit, <span class="dt">label =</span> dept),</a>
<a class="sourceLine" id="cb1245-16" data-line-number="16">            <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>],</a>
<a class="sourceLine" id="cb1245-17" data-line-number="17">            <span class="dt">family =</span> <span class="st">&quot;serif&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1245-18" data-line-number="18"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Posterior validation check&quot;</span>,</a>
<a class="sourceLine" id="cb1245-19" data-line-number="19">       <span class="dt">subtitle =</span> <span class="st">&quot;Though imperfect, this model is a big improvement&quot;</span>,</a>
<a class="sourceLine" id="cb1245-20" data-line-number="20">       <span class="dt">y =</span> <span class="st">&quot;Proportion admitted&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1245-21" data-line-number="21"><span class="st">  </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1245-22" data-line-number="22"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-53-1.png" width="432" style="display: block; margin: auto;" /></p>
<p>Here’s the DAG that proposes an unobserved confound, <span class="math inline">\(U\)</span>, that might better explain the <span class="math inline">\(D \rightarrow A\)</span> pathway.</p>
<div class="sourceCode" id="cb1246"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1246-1" data-line-number="1">dag_coords &lt;-</a>
<a class="sourceLine" id="cb1246-2" data-line-number="2"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">name =</span> <span class="kw">c</span>(<span class="st">&quot;G&quot;</span>, <span class="st">&quot;D&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;U&quot;</span>),</a>
<a class="sourceLine" id="cb1246-3" data-line-number="3">         <span class="dt">x    =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1246-4" data-line-number="4">         <span class="dt">y    =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb1246-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1246-6" data-line-number="6"><span class="kw">dagify</span>(D <span class="op">~</span><span class="st"> </span>G <span class="op">+</span><span class="st"> </span>U,</a>
<a class="sourceLine" id="cb1246-7" data-line-number="7">       A <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>G <span class="op">+</span><span class="st"> </span>U,</a>
<a class="sourceLine" id="cb1246-8" data-line-number="8">       <span class="dt">coords =</span> dag_coords) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1246-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb1246-10" data-line-number="10"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">xend =</span> xend, <span class="dt">yend =</span> yend)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1246-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">x =</span> <span class="dv">3</span>, <span class="dt">y =</span> <span class="dv">2</span>, </a>
<a class="sourceLine" id="cb1246-12" data-line-number="12">             <span class="dt">size =</span> <span class="dv">5</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1246-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_dag_text</span>(<span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>], <span class="dt">family =</span> <span class="st">&quot;serif&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1246-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_dag_edges</span>(<span class="dt">edge_color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1246-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1246-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-54-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>McElreath recommended we look at the <code>pairs()</code> plot to get a sense of how highly correlated the parameters in our <code>b11.8</code> model are. Why not get a little extra about it and use custom settings the upper triangle, the diagonal, and the lower triangle with a <code>GGally::ggpairs()</code> plot? First we save our custom settings.</p>
<div class="sourceCode" id="cb1247"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1247-1" data-line-number="1">my_upper &lt;-<span class="st"> </span><span class="cf">function</span>(data, mapping, ...) {</a>
<a class="sourceLine" id="cb1247-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb1247-3" data-line-number="3">  <span class="co"># get the x and y data to use the other code</span></a>
<a class="sourceLine" id="cb1247-4" data-line-number="4">  x &lt;-<span class="st"> </span><span class="kw">eval_data_col</span>(data, mapping<span class="op">$</span>x)</a>
<a class="sourceLine" id="cb1247-5" data-line-number="5">  y &lt;-<span class="st"> </span><span class="kw">eval_data_col</span>(data, mapping<span class="op">$</span>y)</a>
<a class="sourceLine" id="cb1247-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb1247-7" data-line-number="7">  r  &lt;-<span class="st"> </span><span class="kw">unname</span>(<span class="kw">cor.test</span>(x, y)<span class="op">$</span>estimate)</a>
<a class="sourceLine" id="cb1247-8" data-line-number="8">  rt &lt;-<span class="st"> </span><span class="kw">format</span>(r, <span class="dt">digits =</span> <span class="dv">2</span>)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb1247-9" data-line-number="9">  tt &lt;-<span class="st"> </span><span class="kw">as.character</span>(rt)</a>
<a class="sourceLine" id="cb1247-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb1247-11" data-line-number="11">  <span class="co"># plot the cor value</span></a>
<a class="sourceLine" id="cb1247-12" data-line-number="12">  <span class="kw">ggally_text</span>(</a>
<a class="sourceLine" id="cb1247-13" data-line-number="13">    <span class="dt">label =</span> tt, </a>
<a class="sourceLine" id="cb1247-14" data-line-number="14">    <span class="dt">mapping =</span> <span class="kw">aes</span>(),</a>
<a class="sourceLine" id="cb1247-15" data-line-number="15">    <span class="dt">size =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1247-16" data-line-number="16">    <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>], </a>
<a class="sourceLine" id="cb1247-17" data-line-number="17">    <span class="dt">alpha =</span> <span class="dv">4</span><span class="op">/</span><span class="dv">5</span>,</a>
<a class="sourceLine" id="cb1247-18" data-line-number="18">    <span class="dt">family =</span> <span class="st">&quot;Times&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1247-19" data-line-number="19"><span class="st">    </span><span class="kw">theme_void</span>()</a>
<a class="sourceLine" id="cb1247-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb1247-21" data-line-number="21"></a>
<a class="sourceLine" id="cb1247-22" data-line-number="22">my_diag &lt;-<span class="st"> </span><span class="cf">function</span>(data, mapping, ...) {</a>
<a class="sourceLine" id="cb1247-23" data-line-number="23">  <span class="kw">ggplot</span>(<span class="dt">data =</span> data, <span class="dt">mapping =</span> mapping) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1247-24" data-line-number="24"><span class="st">    </span><span class="kw">geom_density</span>(<span class="dt">fill =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>], <span class="dt">size =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1247-25" data-line-number="25"><span class="st">    </span><span class="kw">theme_void</span>()</a>
<a class="sourceLine" id="cb1247-26" data-line-number="26">}</a>
<a class="sourceLine" id="cb1247-27" data-line-number="27"></a>
<a class="sourceLine" id="cb1247-28" data-line-number="28">my_lower &lt;-<span class="st"> </span><span class="cf">function</span>(data, mapping, ...) {</a>
<a class="sourceLine" id="cb1247-29" data-line-number="29">  <span class="kw">ggplot</span>(<span class="dt">data =</span> data, <span class="dt">mapping =</span> mapping) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1247-30" data-line-number="30"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span>], </a>
<a class="sourceLine" id="cb1247-31" data-line-number="31">               <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1247-32" data-line-number="32"><span class="st">    </span><span class="kw">theme_void</span>()</a>
<a class="sourceLine" id="cb1247-33" data-line-number="33">}</a></code></pre></div>
<p>To learn more about the nature of the code for the <code>my_upper()</code> function, check out <a href="https://github.com/ggobi/ggally/issues/139">Issue #139</a> in the <a href="https://github.com/ggobi/ggally">GGally GitHub repository</a>. Here is the plot.</p>
<div class="sourceCode" id="cb1248"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1248-1" data-line-number="1"><span class="kw">library</span>(GGally)</a>
<a class="sourceLine" id="cb1248-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1248-3" data-line-number="3"><span class="kw">posterior_samples</span>(b11<span class="fl">.8</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1248-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>lp__) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1248-5" data-line-number="5"><span class="st">  </span><span class="kw">set_names</span>(<span class="kw">c</span>(<span class="st">&quot;alpha[male]&quot;</span>, <span class="st">&quot;alpha[female]&quot;</span>, <span class="kw">str_c</span>(<span class="st">&quot;delta[&quot;</span>, LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>], <span class="st">&quot;]&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1248-6" data-line-number="6"><span class="st">  </span><span class="kw">ggpairs</span>(<span class="dt">upper =</span> <span class="kw">list</span>(<span class="dt">continuous =</span> my_upper),</a>
<a class="sourceLine" id="cb1248-7" data-line-number="7">          <span class="dt">diag  =</span> <span class="kw">list</span>(<span class="dt">continuous =</span> my_diag),</a>
<a class="sourceLine" id="cb1248-8" data-line-number="8">          <span class="dt">lower =</span> <span class="kw">list</span>(<span class="dt">continuous =</span> my_lower),</a>
<a class="sourceLine" id="cb1248-9" data-line-number="9">          <span class="dt">labeller =</span> <span class="st">&quot;label_parsed&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1248-10" data-line-number="10"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Model: b11.8&quot;</span>,</a>
<a class="sourceLine" id="cb1248-11" data-line-number="11">       <span class="dt">subtitle =</span> <span class="st">&quot;The parameters are highly correlated&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1248-12" data-line-number="12"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">strip.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">11</span>))</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-56-1.png" width="528" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Why might we want to over-parameterize the model? Because it makes it easier to assign priors. If we made one of the genders baseline and measured the other as a deviation from it, we would stumble into the issue of assuming that the acceptance rate for one of the genders is pre-data more uncertain than the other. This isn’t to say that over-parameterizing a model is always a good idea. But it isn’t a violation of any statistical principle. You can always convert the posterior, post sampling, to any alternative parameterization. The only limitation is whether the algorithm we use to approximate the posterior can handle the high correlations. In this case, it can. (p. 345)</p>
</blockquote>
<div id="rethinking-simpsons-paradox-is-not-a-paradox." class="section level4">
<h4><span class="header-section-number">11.1.4.1</span> Rethinking: Simpson’s paradox is not a paradox.</h4>
<blockquote>
<p>This empirical example is a famous one in statistical teaching. It is often used to illustrate a phenomenon known as <strong>Simpson’s paradox</strong>. Like most paradoxes, there is no violation of logic, just of intuition. And since different people have different intuition, Simpson’s paradox means different things to different people. The poor intuition being violated in this case is that a positive association in the entire population should also hold within each department. (p. 345, <strong>emphasis</strong> in the original)</p>
</blockquote>
<p>In my field of clinical psychology, Simpson’s paradox is an important, if under-appreciated, phenomenon. If you’re in the social sciences as well, I highly recommend spending more time thinking about it. To get you started, I blogged about it <a href="https://solomonkurz.netlify.com/post/individuals-are-not-small-groups-i-simpson-s-paradox/">here</a> and <span class="citation">Kievit et al. (<a href="#ref-kievitSimpsonParadoxPsychological2013">2013</a>)</span> wrote a great tutorial paper called <a href="https://www.frontiersin.org/articles/10.3389/fpsyg.2013.00513/full"><em>Simpson’s paradox in psychological science: a practical guide</em></a>.</p>
</div>
</div>
</div>
<div id="poisson-regression" class="section level2">
<h2><span class="header-section-number">11.2</span> Poisson regression</h2>
<blockquote>
<p>When a binomial distribution has a very small probability of an event <span class="math inline">\(p\)</span> and a very large number of trials <span class="math inline">\(N\)</span>, then it takes on a special shape. The expected value of a binomial distribution is just <span class="math inline">\(Np\)</span>, and its variance is <span class="math inline">\(Np(1 - p)\)</span>. But when <span class="math inline">\(N\)</span> is very large and <span class="math inline">\(p\)</span> is very small, then these are approximately the same. (p. 346)</p>
</blockquote>
<p>Data of this kind are often called count data. Here we simulate some.</p>
<div class="sourceCode" id="cb1249"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1249-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">11</span>)</a>
<a class="sourceLine" id="cb1249-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1249-3" data-line-number="3"><span class="kw">tibble</span>(<span class="dt">y =</span> <span class="kw">rbinom</span>(<span class="fl">1e5</span>, <span class="dv">1000</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">1000</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1249-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">y_mean     =</span> <span class="kw">mean</span>(y),</a>
<a class="sourceLine" id="cb1249-5" data-line-number="5">            <span class="dt">y_variance =</span> <span class="kw">var</span>(y))</a></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   y_mean y_variance
##    &lt;dbl&gt;      &lt;dbl&gt;
## 1   1.00       1.01</code></pre>
<p>Yes, those statistics are virtually the same. When dealing with pure Poisson data, <span class="math inline">\(\mu = \sigma^2\)</span>. When you have a number of trials for which <span class="math inline">\(n\)</span> is unknown or much larger than seen in the data, the Poisson likelihood is a useful tool. We define it as</p>
<p><span class="math display">\[y_i \sim \text{Poisson} (\lambda).\]</span></p>
<p>As <span class="math inline">\(\lambda\)</span> expresses both mean and variance because within this model, the variance scales right along with the mean. Since <span class="math inline">\(\lambda\)</span> is constrained to be positive, we typically use the log link. Thus the basic Poisson regression model is</p>
<p><span class="math display">\[\begin{align*}
y_i             &amp; \sim \operatorname{Poisson} (\lambda_i) \\
\log(\lambda_i) &amp; = \alpha + \beta (x_i - \bar x),
\end{align*}\]</span></p>
<p>where all model parameters receive priors following the forms we’ve been practicing.</p>
<div id="example-oceanic-tool-complexity." class="section level3">
<h3><span class="header-section-number">11.2.1</span> Example: Oceanic tool complexity.</h3>
<p>Load the <code>Kline</code> data <span class="citation">(see Kline &amp; Boyd, <a href="#ref-klinePopulationSizePredicts2010">2010</a>)</span>.</p>
<div class="sourceCode" id="cb1251"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1251-1" data-line-number="1"><span class="kw">library</span>(rethinking)</a>
<a class="sourceLine" id="cb1251-2" data-line-number="2"><span class="kw">data</span>(Kline)</a>
<a class="sourceLine" id="cb1251-3" data-line-number="3">d &lt;-<span class="st"> </span>Kline</a></code></pre></div>
<p>Switch from <strong>rethinking</strong> to <strong>brms</strong>.</p>
<div class="sourceCode" id="cb1252"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1252-1" data-line-number="1"><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</a>
<a class="sourceLine" id="cb1252-2" data-line-number="2"><span class="kw">library</span>(brms)</a>
<a class="sourceLine" id="cb1252-3" data-line-number="3"><span class="kw">rm</span>(Kline)</a>
<a class="sourceLine" id="cb1252-4" data-line-number="4">d</a></code></pre></div>
<pre><code>##       culture population contact total_tools mean_TU
## 1    Malekula       1100     low          13     3.2
## 2     Tikopia       1500     low          22     4.7
## 3  Santa Cruz       3600     low          24     4.0
## 4         Yap       4791    high          43     5.0
## 5    Lau Fiji       7400    high          33     5.0
## 6   Trobriand       8000    high          19     4.0
## 7       Chuuk       9200    high          40     3.8
## 8       Manus      13000     low          28     6.6
## 9       Tonga      17500    high          55     5.4
## 10     Hawaii     275000     low          71     6.6</code></pre>
<p>Here are our new columns.</p>
<div class="sourceCode" id="cb1254"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1254-1" data-line-number="1">d &lt;-</a>
<a class="sourceLine" id="cb1254-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1254-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">log_pop_std =</span> (<span class="kw">log</span>(population) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(<span class="kw">log</span>(population))) <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(<span class="kw">log</span>(population)),</a>
<a class="sourceLine" id="cb1254-4" data-line-number="4">         <span class="dt">cid         =</span> contact)</a></code></pre></div>
<p>Our statistical model will follow the form</p>
<p><span class="math display">\[\begin{align*}
\text{total_tools}_i  &amp; \sim \operatorname{Poisson} (\lambda_i) \\
\text{log}(\lambda_i) &amp; = \alpha_{\text{cid}[i]} + \beta_{\text{cid}[i]} \text{log_pop_std}_i \\
\alpha_j              &amp; \sim \; ? \\
\beta_j               &amp; \sim \; ?, 
\end{align*}\]</span></p>
<p>where the priors for <span class="math inline">\(\alpha_j\)</span> and <span class="math inline">\(\beta_j\)</span> have yet be defined. If we continue our convention of using a Normal prior on the <span class="math inline">\(\alpha\)</span> parameters, we should recognize those will be log-Normal distributed on the outcome scale. Why? Because we’re modeling <span class="math inline">\(\lambda\)</span> with the log link. Here’s our version of Figure 11.7, depicting the two log-Normal priors considered in the text.</p>
<div class="sourceCode" id="cb1255"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1255-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">x       =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">22</span>),</a>
<a class="sourceLine" id="cb1255-2" data-line-number="2">       <span class="dt">y       =</span> <span class="kw">c</span>(<span class="fl">0.055</span>, <span class="fl">0.04</span>),</a>
<a class="sourceLine" id="cb1255-3" data-line-number="3">       <span class="dt">meanlog =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1255-4" data-line-number="4">       <span class="dt">sdlog   =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="fl">0.5</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1255-5" data-line-number="5"><span class="st">  </span><span class="kw">expand</span>(<span class="kw">nesting</span>(x, y, meanlog, sdlog),</a>
<a class="sourceLine" id="cb1255-6" data-line-number="6">         <span class="dt">number =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">100</span>, <span class="dt">length.out =</span> <span class="dv">200</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1255-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">density =</span> <span class="kw">dlnorm</span>(number, meanlog, sdlog),</a>
<a class="sourceLine" id="cb1255-8" data-line-number="8">         <span class="dt">group   =</span> <span class="kw">str_c</span>(<span class="st">&quot;alpha%~%Normal(&quot;</span>, meanlog, <span class="st">&quot;, &quot;</span>, sdlog, <span class="st">&quot;)&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1255-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb1255-10" data-line-number="10"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">ymax =</span> density, </a>
<a class="sourceLine" id="cb1255-11" data-line-number="11">             <span class="dt">fill =</span> group, <span class="dt">color =</span> group)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1255-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x =</span> number, ), </a>
<a class="sourceLine" id="cb1255-13" data-line-number="13">              <span class="dt">alpha =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">size =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1255-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> . <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1255-15" data-line-number="15">            <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">label =</span> group),</a>
<a class="sourceLine" id="cb1255-16" data-line-number="16">            <span class="dt">family =</span> <span class="st">&quot;Times&quot;</span>, <span class="dt">parse =</span> T,  <span class="dt">hjust =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1255-17" data-line-number="17"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1255-18" data-line-number="18"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1255-19" data-line-number="19"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1255-20" data-line-number="20"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;mean number of tools&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1255-21" data-line-number="21"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-61-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>In this context, <span class="math inline">\(\alpha \sim \operatorname{Normal} (0, 10)\)</span> has a very long tail on the outcome scale. The mean of the log-Normal distribution, recall, is <span class="math inline">\(\exp (\mu + \sigma^2/2)\)</span>. Here that is in code.</p>
<div class="sourceCode" id="cb1256"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1256-1" data-line-number="1"><span class="kw">exp</span>(<span class="dv">0</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)</a></code></pre></div>
<pre><code>## [1] 5.184706e+21</code></pre>
<p>That is very large. Here’s the same thing in a simulation.</p>
<div class="sourceCode" id="cb1258"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1258-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">11</span>)</a>
<a class="sourceLine" id="cb1258-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1258-3" data-line-number="3"><span class="kw">rnorm</span>(<span class="fl">1e4</span>, <span class="dv">0</span>, <span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1258-4" data-line-number="4"><span class="st">  </span><span class="kw">exp</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1258-5" data-line-number="5"><span class="st">  </span><span class="kw">mean</span>()</a></code></pre></div>
<pre><code>## [1] 1.61276e+12</code></pre>
<p>Now compute the mean for the other prior under consiteration, <span class="math inline">\(\alpha \sim \operatorname{Normal} (3, 0.5)\)</span>.</p>
<div class="sourceCode" id="cb1260"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1260-1" data-line-number="1"><span class="kw">exp</span>(<span class="dv">3</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span><span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)</a></code></pre></div>
<pre><code>## [1] 22.7599</code></pre>
<p>This is much smaller and more reasonable. In case you were curious, here are the same priors, this time on the scale of <span class="math inline">\(\lambda\)</span>.</p>
<div class="sourceCode" id="cb1262"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1262-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">x    =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb1262-2" data-line-number="2">       <span class="dt">y    =</span> <span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.5</span>),</a>
<a class="sourceLine" id="cb1262-3" data-line-number="3">       <span class="dt">mean =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1262-4" data-line-number="4">       <span class="dt">sd   =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="fl">0.5</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1262-5" data-line-number="5"><span class="st">  </span><span class="kw">expand</span>(<span class="kw">nesting</span>(x, y, mean, sd),</a>
<a class="sourceLine" id="cb1262-6" data-line-number="6">         <span class="dt">number =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">-25</span>, <span class="dt">to =</span> <span class="dv">25</span>, <span class="dt">length.out =</span> <span class="dv">500</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1262-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">density =</span> <span class="kw">dnorm</span>(number, mean, sd),</a>
<a class="sourceLine" id="cb1262-8" data-line-number="8">         <span class="dt">group   =</span> <span class="kw">str_c</span>(<span class="st">&quot;alpha%~%Normal(&quot;</span>, mean, <span class="st">&quot;, &quot;</span>, sd, <span class="st">&quot;)&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1262-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb1262-10" data-line-number="10"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">ymax =</span> density, </a>
<a class="sourceLine" id="cb1262-11" data-line-number="11">             <span class="dt">fill =</span> group, <span class="dt">color =</span> group)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1262-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x =</span> number, ), </a>
<a class="sourceLine" id="cb1262-13" data-line-number="13">              <span class="dt">alpha =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">size =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1262-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> . <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1262-15" data-line-number="15">            <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">label =</span> group),</a>
<a class="sourceLine" id="cb1262-16" data-line-number="16">            <span class="dt">family =</span> <span class="st">&quot;Times&quot;</span>, <span class="dt">parse =</span> T,  <span class="dt">hjust =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1262-17" data-line-number="17"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1262-18" data-line-number="18"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1262-19" data-line-number="19"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1262-20" data-line-number="20"><span class="st">  </span><span class="kw">xlab</span>(<span class="kw">expression</span>(lambda<span class="op">~</span>scale)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1262-21" data-line-number="21"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-65-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>Now let’s prepare to make the top row of Figure 11.8. In this portion of the figure, we consider the implications of two competing priors for <span class="math inline">\(\beta\)</span> while holding the prior for <span class="math inline">\(\alpha\)</span> at <span class="math inline">\(\operatorname{Normal}(3, 0.5)\)</span>. The two <span class="math inline">\(\beta\)</span> priors under consideration are <span class="math inline">\(\operatorname{Normal}(0, 10)\)</span> and <span class="math inline">\(\operatorname{Normal}(0, 0.2)\)</span>.</p>
<div class="sourceCode" id="cb1263"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1263-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">11</span>)</a>
<a class="sourceLine" id="cb1263-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1263-3" data-line-number="3"><span class="co"># how many lines would you like?</span></a>
<a class="sourceLine" id="cb1263-4" data-line-number="4">n &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb1263-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1263-6" data-line-number="6"><span class="co"># simulate and wrangle</span></a>
<a class="sourceLine" id="cb1263-7" data-line-number="7"><span class="kw">tibble</span>(<span class="dt">i =</span> <span class="dv">1</span><span class="op">:</span>n,</a>
<a class="sourceLine" id="cb1263-8" data-line-number="8">       <span class="dt">a =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> <span class="dv">3</span> , <span class="dt">sd =</span> <span class="fl">0.5</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1263-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">beta%~%Normal(0*&#39;, &#39;*10)</span><span class="st">`</span>  =<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dt">mean =</span> <span class="dv">0</span> , <span class="dt">sd =</span> <span class="dv">10</span>),</a>
<a class="sourceLine" id="cb1263-10" data-line-number="10">         <span class="st">`</span><span class="dt">beta%~%Normal(0*&#39;, &#39;*0.2)</span><span class="st">`</span> =<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dt">mean =</span> <span class="dv">0</span> , <span class="dt">sd =</span> <span class="fl">0.2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1263-11" data-line-number="11"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">contains</span>(<span class="st">&quot;beta&quot;</span>),</a>
<a class="sourceLine" id="cb1263-12" data-line-number="12">               <span class="dt">values_to =</span> <span class="st">&quot;b&quot;</span>,</a>
<a class="sourceLine" id="cb1263-13" data-line-number="13">               <span class="dt">names_to =</span> <span class="st">&quot;prior&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1263-14" data-line-number="14"><span class="st">  </span><span class="kw">expand</span>(<span class="kw">nesting</span>(i, a, b, prior),</a>
<a class="sourceLine" id="cb1263-15" data-line-number="15">         <span class="dt">x =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">-2</span>, <span class="dt">to =</span> <span class="dv">2</span>, <span class="dt">length.out =</span> <span class="dv">100</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1263-16" data-line-number="16"><span class="st">  </span></a>
<a class="sourceLine" id="cb1263-17" data-line-number="17"><span class="st">  </span><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1263-18" data-line-number="18"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> <span class="kw">exp</span>(a <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span>x), <span class="dt">group =</span> i)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1263-19" data-line-number="19"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb1263-20" data-line-number="20">            <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1263-21" data-line-number="21"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;log population (std)&quot;</span>,</a>
<a class="sourceLine" id="cb1263-22" data-line-number="22">       <span class="dt">y =</span> <span class="st">&quot;total tools&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1263-23" data-line-number="23"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">100</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1263-24" data-line-number="24"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>prior, <span class="dt">labeller =</span> label_parsed)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-66-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>It turns out that many of the lines considered plausible under <span class="math inline">\(\operatorname{Normal}(0, 10)\)</span> are disturbingly extreme. Here is what <span class="math inline">\(\alpha \sim \operatorname{Normal}(3, 0.5)\)</span> and <span class="math inline">\(\beta \sim \operatorname{Normal}(0, 0.2)\)</span> would mean when the <span class="math inline">\(x\)</span>-axis is on the log population scale and the population scale.</p>
<div class="sourceCode" id="cb1264"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1264-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">11</span>)</a>
<a class="sourceLine" id="cb1264-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1264-3" data-line-number="3">prior &lt;-</a>
<a class="sourceLine" id="cb1264-4" data-line-number="4"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">i =</span> <span class="dv">1</span><span class="op">:</span>n,</a>
<a class="sourceLine" id="cb1264-5" data-line-number="5">         <span class="dt">a =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> <span class="dv">3</span>, <span class="dt">sd =</span> <span class="fl">0.5</span>),</a>
<a class="sourceLine" id="cb1264-6" data-line-number="6">         <span class="dt">b =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1264-7" data-line-number="7"><span class="st">  </span><span class="kw">expand</span>(<span class="kw">nesting</span>(i, a, b),</a>
<a class="sourceLine" id="cb1264-8" data-line-number="8">         <span class="dt">x =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="kw">log</span>(<span class="dv">100</span>), <span class="dt">to =</span> <span class="kw">log</span>(<span class="dv">200000</span>), <span class="dt">length.out =</span> <span class="dv">100</span>))</a>
<a class="sourceLine" id="cb1264-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1264-10" data-line-number="10"><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1264-11" data-line-number="11">p1 &lt;-</a>
<a class="sourceLine" id="cb1264-12" data-line-number="12"><span class="st">  </span>prior <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1264-13" data-line-number="13"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> <span class="kw">exp</span>(a <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span>x), <span class="dt">group =</span> i)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1264-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb1264-15" data-line-number="15">            <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1264-16" data-line-number="16"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="kw">expression</span>(beta<span class="op">%~%</span><span class="kw">Normal</span>(<span class="dv">0</span><span class="op">*</span><span class="st">&#39;, &#39;</span><span class="op">*</span><span class="fl">0.2</span>)),</a>
<a class="sourceLine" id="cb1264-17" data-line-number="17">       <span class="dt">x =</span> <span class="st">&quot;log population&quot;</span>,</a>
<a class="sourceLine" id="cb1264-18" data-line-number="18">       <span class="dt">y =</span> <span class="st">&quot;total tools&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1264-19" data-line-number="19"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="kw">log</span>(<span class="dv">100</span>), <span class="kw">log</span>(<span class="dv">200000</span>)),</a>
<a class="sourceLine" id="cb1264-20" data-line-number="20">                  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">500</span>))</a>
<a class="sourceLine" id="cb1264-21" data-line-number="21">p2 &lt;-</a>
<a class="sourceLine" id="cb1264-22" data-line-number="22"><span class="st">  </span>prior <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1264-23" data-line-number="23"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">exp</span>(x), <span class="dt">y =</span> <span class="kw">exp</span>(a <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span>x), <span class="dt">group =</span> i)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1264-24" data-line-number="24"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb1264-25" data-line-number="25">            <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1264-26" data-line-number="26"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="kw">expression</span>(beta<span class="op">%~%</span><span class="kw">Normal</span>(<span class="dv">0</span><span class="op">*</span><span class="st">&#39;, &#39;</span><span class="op">*</span><span class="fl">0.2</span>)),</a>
<a class="sourceLine" id="cb1264-27" data-line-number="27">       <span class="dt">x =</span> <span class="st">&quot;population&quot;</span>,</a>
<a class="sourceLine" id="cb1264-28" data-line-number="28">       <span class="dt">y =</span> <span class="st">&quot;total tools&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1264-29" data-line-number="29"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">100</span>, <span class="dv">200000</span>),</a>
<a class="sourceLine" id="cb1264-30" data-line-number="30">                  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">500</span>))</a>
<a class="sourceLine" id="cb1264-31" data-line-number="31"></a>
<a class="sourceLine" id="cb1264-32" data-line-number="32">p1 <span class="op">|</span><span class="st"> </span>p2</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-67-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>Okay, after settling on our two priors, the updated model formula is</p>
<p><span class="math display">\[\begin{align*}
y_i              &amp; \sim \operatorname{Poisson} (\lambda_i) \\
\log (\lambda_i) &amp; = \alpha + \beta (x_i - \bar x) \\
\alpha           &amp; \sim \operatorname{Normal}(3, 0.5) \\
\beta            &amp; \sim \operatorname{Normal}(0, 0.2).
\end{align*}\]</span></p>
<p>We’re finally ready to fit the model. The only new thing in our model code is <code>family = poisson</code>. In this case, <strong>brms</strong> defaults to the <code>log()</code> link.</p>
<div class="sourceCode" id="cb1265"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1265-1" data-line-number="1">d &lt;-</a>
<a class="sourceLine" id="cb1265-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1265-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">total_tools_std =</span> (total_tools <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(total_tools)) <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(total_tools))</a></code></pre></div>
<div class="sourceCode" id="cb1266"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1266-1" data-line-number="1">b11<span class="fl">.9</span> &lt;-</a>
<a class="sourceLine" id="cb1266-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1266-3" data-line-number="3">      <span class="dt">family =</span> poisson,</a>
<a class="sourceLine" id="cb1266-4" data-line-number="4">      total_tools <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1266-5" data-line-number="5">      <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">3</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1266-6" data-line-number="6">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1266-7" data-line-number="7">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1266-8" data-line-number="8">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.09&quot;</span>) </a>
<a class="sourceLine" id="cb1266-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1266-10" data-line-number="10">b11<span class="fl">.10</span> &lt;-</a>
<a class="sourceLine" id="cb1266-11" data-line-number="11"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1266-12" data-line-number="12">      <span class="dt">family =</span> poisson,</a>
<a class="sourceLine" id="cb1266-13" data-line-number="13">      <span class="kw">bf</span>(total_tools <span class="op">~</span><span class="st"> </span>a <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span>log_pop_std,</a>
<a class="sourceLine" id="cb1266-14" data-line-number="14">         a <span class="op">+</span><span class="st"> </span>b <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>cid,</a>
<a class="sourceLine" id="cb1266-15" data-line-number="15">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1266-16" data-line-number="16">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">3</span>, <span class="fl">0.5</span>), <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1266-17" data-line-number="17">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">nlpar =</span> b)),</a>
<a class="sourceLine" id="cb1266-18" data-line-number="18">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1266-19" data-line-number="19">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1266-20" data-line-number="20">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.10&quot;</span>) </a></code></pre></div>
<p>Check the model summaries.</p>
<div class="sourceCode" id="cb1267"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1267-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.9</span>)</a></code></pre></div>
<pre><code>##  Family: poisson 
##   Links: mu = log 
## Formula: total_tools ~ 1 
##    Data: d (Number of observations: 10) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     3.54      0.05     3.44     3.64 1.00     1734     1855
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<div class="sourceCode" id="cb1269"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1269-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.10</span>)</a></code></pre></div>
<pre><code>##  Family: poisson 
##   Links: mu = log 
## Formula: total_tools ~ a + b * log_pop_std 
##          a ~ 0 + cid
##          b ~ 0 + cid
##    Data: d (Number of observations: 10) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a_cidhigh     3.61      0.07     3.47     3.75 1.00     3477     2989
## a_cidlow      3.32      0.08     3.15     3.48 1.00     3636     3191
## b_cidhigh     0.19      0.16    -0.12     0.50 1.00     4144     2768
## b_cidlow      0.38      0.05     0.28     0.48 1.00     3088     3137
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<div class="sourceCode" id="cb1271"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1271-1" data-line-number="1">b11<span class="fl">.9</span>  &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.9</span>, <span class="st">&quot;loo&quot;</span>)</a>
<a class="sourceLine" id="cb1271-2" data-line-number="2">b11<span class="fl">.10</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.10</span>, <span class="st">&quot;loo&quot;</span>)</a></code></pre></div>
<pre><code>## Warning: Found 3 observations with a pareto_k &gt; 0.7 in model &#39;b11.10&#39;. It is recommended to set &#39;reloo = TRUE&#39;
## in order to calculate the ELPD without the assumption that these observations are negligible. This will refit
## the model 3 times to compute the ELPDs for the problematic observations directly.</code></pre>
<div class="sourceCode" id="cb1273"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1273-1" data-line-number="1"><span class="kw">loo_compare</span>(b11<span class="fl">.9</span>, b11<span class="fl">.10</span>, <span class="dt">criterion =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</a></code></pre></div>
<pre><code>##        elpd_diff se_diff elpd_loo se_elpd_loo p_loo se_p_loo looic se_looic
## b11.10   0.0       0.0   -42.8      6.6         7.1   2.7     85.6  13.3   
## b11.9  -27.8      16.3   -70.6     16.7         8.2   3.5    141.2  33.5</code></pre>
<p>Here’s the LOO weight.</p>
<div class="sourceCode" id="cb1275"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1275-1" data-line-number="1"><span class="kw">model_weights</span>(b11<span class="fl">.9</span>, b11<span class="fl">.10</span>, <span class="dt">weights =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##  b11.9 b11.10 
##      0      1</code></pre>
<p>McElreath reported getting a warning from his <code>rethinking::compare()</code>. Our warning came from the <code>add_criterion()</code> function. We can inspect the Pareto <span class="math inline">\(k\)</span> values with <code>loo::pareto_k_table()</code>.</p>
<div class="sourceCode" id="cb1277"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1277-1" data-line-number="1"><span class="kw">loo</span>(b11<span class="fl">.10</span>) <span class="op">%&gt;%</span><span class="st"> </span>loo<span class="op">::</span><span class="kw">pareto_k_table</span>()</a></code></pre></div>
<pre><code>## Warning: Found 3 observations with a pareto_k &gt; 0.7 in model &#39;b11.10&#39;. It is recommended to set &#39;reloo = TRUE&#39;
## in order to calculate the ELPD without the assumption that these observations are negligible. This will refit
## the model 3 times to compute the ELPDs for the problematic observations directly.</code></pre>
<pre><code>## Pareto k diagnostic values:
##                          Count Pct.    Min. n_eff
## (-Inf, 0.5]   (good)     6     60.0%   663       
##  (0.5, 0.7]   (ok)       1     10.0%   192       
##    (0.7, 1]   (bad)      2     20.0%   85        
##    (1, Inf)   (very bad) 1     10.0%   24</code></pre>
<p>Wow. Let’s take a closer look.</p>
<div class="sourceCode" id="cb1280"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1280-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">culture =</span> d<span class="op">$</span>culture,</a>
<a class="sourceLine" id="cb1280-2" data-line-number="2">       <span class="dt">k       =</span> b11<span class="fl">.10</span><span class="op">$</span>criteria<span class="op">$</span>loo<span class="op">$</span>diagnostics<span class="op">$</span>pareto_k) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1280-3" data-line-number="3"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(k)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1280-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## # A tibble: 10 x 2
##    culture        k
##    &lt;fct&gt;      &lt;dbl&gt;
##  1 Hawaii      1.2 
##  2 Tonga       0.8 
##  3 Malekula    0.7 
##  4 Trobriand   0.67
##  5 Tikopia     0.49
##  6 Yap         0.44
##  7 Santa Cruz  0.4 
##  8 Manus       0.35
##  9 Lau Fiji    0.31
## 10 Chuuk       0.16</code></pre>
<p>It turns out Hawaii is very influential. Figure 11.9 will clarify why. Here we make the left panel.</p>
<div class="sourceCode" id="cb1282"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1282-1" data-line-number="1">cultures &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Hawaii&quot;</span>, <span class="st">&quot;Tonga&quot;</span>, <span class="st">&quot;Trobriand&quot;</span>, <span class="st">&quot;Yap&quot;</span>)</a>
<a class="sourceLine" id="cb1282-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1282-3" data-line-number="3"><span class="kw">library</span>(ggrepel)</a>
<a class="sourceLine" id="cb1282-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1282-5" data-line-number="5">nd &lt;-</a>
<a class="sourceLine" id="cb1282-6" data-line-number="6"><span class="st">  </span><span class="kw">distinct</span>(d, cid) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1282-7" data-line-number="7"><span class="st">  </span><span class="kw">expand</span>(cid, </a>
<a class="sourceLine" id="cb1282-8" data-line-number="8">         <span class="dt">log_pop_std =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="fl">-4.5</span>, <span class="dt">to =</span> <span class="fl">2.5</span>, <span class="dt">length.out =</span> <span class="dv">100</span>))</a>
<a class="sourceLine" id="cb1282-9" data-line-number="9">f &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1282-10" data-line-number="10"><span class="st">  </span><span class="kw">fitted</span>(b11<span class="fl">.10</span>,</a>
<a class="sourceLine" id="cb1282-11" data-line-number="11">         <span class="dt">newdata =</span> nd,</a>
<a class="sourceLine" id="cb1282-12" data-line-number="12">         <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">055</span>, <span class="fl">.945</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1282-13" data-line-number="13"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1282-14" data-line-number="14"><span class="st">  </span><span class="kw">bind_cols</span>(nd)</a>
<a class="sourceLine" id="cb1282-15" data-line-number="15"></a>
<a class="sourceLine" id="cb1282-16" data-line-number="16">p1 &lt;-</a>
<a class="sourceLine" id="cb1282-17" data-line-number="17"><span class="st">  </span>f <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1282-18" data-line-number="18"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> log_pop_std, <span class="dt">group =</span> cid, <span class="dt">color =</span> cid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1282-19" data-line-number="19"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimate, <span class="dt">ymin =</span> Q5<span class="fl">.5</span>, <span class="dt">ymax =</span> Q94<span class="fl">.5</span>, <span class="dt">fill =</span> cid),</a>
<a class="sourceLine" id="cb1282-20" data-line-number="20">              <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>,</a>
<a class="sourceLine" id="cb1282-21" data-line-number="21">              <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1282-22" data-line-number="22"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">bind_cols</span>(d, b11<span class="fl">.10</span><span class="op">$</span>criteria<span class="op">$</span>loo<span class="op">$</span>diagnostics),</a>
<a class="sourceLine" id="cb1282-23" data-line-number="23">             <span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">size =</span> pareto_k),</a>
<a class="sourceLine" id="cb1282-24" data-line-number="24">             <span class="dt">alpha =</span> <span class="dv">4</span><span class="op">/</span><span class="dv">5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1282-25" data-line-number="25"><span class="st">  </span><span class="kw">geom_text_repel</span>(<span class="dt">data =</span> </a>
<a class="sourceLine" id="cb1282-26" data-line-number="26">                    <span class="kw">bind_cols</span>(d, b11<span class="fl">.10</span><span class="op">$</span>criteria<span class="op">$</span>loo<span class="op">$</span>diagnostics) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1282-27" data-line-number="27"><span class="st">                    </span><span class="kw">filter</span>(culture <span class="op">%in%</span><span class="st"> </span>cultures) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1282-28" data-line-number="28"><span class="st">                    </span><span class="kw">mutate</span>(<span class="dt">label =</span> <span class="kw">str_c</span>(culture, <span class="st">&quot; (&quot;</span>, <span class="kw">round</span>(pareto_k, <span class="dt">digits =</span> <span class="dv">2</span>), <span class="st">&quot;)&quot;</span>)),</a>
<a class="sourceLine" id="cb1282-29" data-line-number="29">                  <span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">label =</span> label), </a>
<a class="sourceLine" id="cb1282-30" data-line-number="30">                  <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">seed =</span> <span class="dv">11</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Times&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1282-31" data-line-number="31"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;log population (std)&quot;</span>,</a>
<a class="sourceLine" id="cb1282-32" data-line-number="32">       <span class="dt">y =</span> <span class="st">&quot;total tools&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1282-33" data-line-number="33"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(b11<span class="fl">.10</span><span class="op">$</span>data<span class="op">$</span>log_pop_std),</a>
<a class="sourceLine" id="cb1282-34" data-line-number="34">                  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">80</span>))</a></code></pre></div>
<p>Now make the right panel of Figure 11.9.</p>
<div class="sourceCode" id="cb1283"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1283-1" data-line-number="1">p2 &lt;-</a>
<a class="sourceLine" id="cb1283-2" data-line-number="2"><span class="st">  </span>f <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1283-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">population =</span> <span class="kw">exp</span>((log_pop_std <span class="op">*</span><span class="st"> </span><span class="kw">sd</span>(<span class="kw">log</span>(d<span class="op">$</span>population))) <span class="op">+</span><span class="st"> </span><span class="kw">mean</span>(<span class="kw">log</span>(d<span class="op">$</span>population)))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1283-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1283-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> population, <span class="dt">group =</span> cid, <span class="dt">color =</span> cid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1283-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimate, <span class="dt">ymin =</span> Q5<span class="fl">.5</span>, <span class="dt">ymax =</span> Q94<span class="fl">.5</span>, <span class="dt">fill =</span> cid),</a>
<a class="sourceLine" id="cb1283-7" data-line-number="7">              <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>,</a>
<a class="sourceLine" id="cb1283-8" data-line-number="8">              <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1283-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">bind_cols</span>(d, b11<span class="fl">.10</span><span class="op">$</span>criteria<span class="op">$</span>loo<span class="op">$</span>diagnostics),</a>
<a class="sourceLine" id="cb1283-10" data-line-number="10">             <span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">size =</span> pareto_k),</a>
<a class="sourceLine" id="cb1283-11" data-line-number="11">             <span class="dt">alpha =</span> <span class="dv">4</span><span class="op">/</span><span class="dv">5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1283-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;population&quot;</span>, <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">50000</span>, <span class="dv">150000</span>, <span class="dv">250000</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1283-13" data-line-number="13"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;total tools&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1283-14" data-line-number="14"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(d<span class="op">$</span>population),</a>
<a class="sourceLine" id="cb1283-15" data-line-number="15">                  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">80</span>))</a></code></pre></div>
<p>Combine the two subplots with <strong>patchwork</strong> and adjust the settings a little.</p>
<div class="sourceCode" id="cb1284"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1284-1" data-line-number="1">(p1 <span class="op">|</span><span class="st"> </span>p2) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb1284-2" data-line-number="2"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb1284-3" data-line-number="3"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb1284-4" data-line-number="4"><span class="st">  </span><span class="kw">scale_size</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">5</span>)) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb1284-5" data-line-number="5"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-76-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Hawaii is influential in that it has a very large population relative to the other islands.</p>
<div id="overthinking-modeling-tool-innovation." class="section level4">
<h4><span class="header-section-number">11.2.1.1</span> Overthinking: Modeling tool innovation.</h4>
<p>McElreath’s theoretical, or scientific, model for <code>total_tools</code> is</p>
<p><span class="math display">\[\widehat{\text{total_tools}} = \frac{\alpha_{\text{cid}[i]} \: \text{population}^{\beta_{\text{cid}[i]}}}{\gamma}.\]</span></p>
<p>We can use the Poisson likelihood to express this in a Bayesian model as</p>
<p><span class="math display">\[
\begin{align*}
\text{total_tools} &amp; \sim \operatorname{Poisson}(\lambda_i) \\
\lambda_i &amp; = \left( \exp (\alpha_{\text{cid}[i]}) \text{population}_i^{\beta_{\text{cid}[i]}} \right) / \gamma \\
\alpha_j  &amp; \sim \operatorname{Normal}(1, 1) \\
\beta_j   &amp; \sim \operatorname{Exponential}(1) \\
\gamma    &amp; \sim \operatorname{Exponential}(1),
\end{align*}
\]</span></p>
<p>where we exponentiate <span class="math inline">\(\alpha_{\text{cid}[i]}\)</span> to restrict the posterior to zero and above. Here’s how we might fit that model with <strong>brms</strong>.</p>
<div class="sourceCode" id="cb1285"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1285-1" data-line-number="1">b11<span class="fl">.11</span> &lt;-</a>
<a class="sourceLine" id="cb1285-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1285-3" data-line-number="3">      <span class="dt">family =</span> <span class="kw">poisson</span>(<span class="dt">link =</span> <span class="st">&quot;identity&quot;</span>),</a>
<a class="sourceLine" id="cb1285-4" data-line-number="4">      <span class="kw">bf</span>(total_tools <span class="op">~</span><span class="st"> </span><span class="kw">exp</span>(a) <span class="op">*</span><span class="st"> </span>population<span class="op">^</span>b <span class="op">/</span><span class="st"> </span>g,</a>
<a class="sourceLine" id="cb1285-5" data-line-number="5">         a <span class="op">+</span><span class="st"> </span>b <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>cid,</a>
<a class="sourceLine" id="cb1285-6" data-line-number="6">         g <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1285-7" data-line-number="7">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1285-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1285-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">nlpar =</span> b, <span class="dt">lb =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1285-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">nlpar =</span> g, <span class="dt">lb =</span> <span class="dv">0</span>)),</a>
<a class="sourceLine" id="cb1285-11" data-line-number="11">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1285-12" data-line-number="12">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1285-13" data-line-number="13">      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">.95</span>),</a>
<a class="sourceLine" id="cb1285-14" data-line-number="14">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.11&quot;</span>) </a></code></pre></div>
<p>Did you notice the <code>family = poisson(link = &quot;identity&quot;)</code> part of the code? Yes, it’s possible to use the Poisson likelihood without the log link. However, if you’re going to buck tradition and use some other link, make sure you know what you’re doing.</p>
<p>Check the model summary.</p>
<div class="sourceCode" id="cb1286"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1286-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.11</span>)</a></code></pre></div>
<pre><code>##  Family: poisson 
##   Links: mu = identity 
## Formula: total_tools ~ exp(a) * population^b/g 
##          a ~ 0 + cid
##          b ~ 0 + cid
##          g ~ 1
##    Data: d (Number of observations: 10) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a_cidhigh       1.16      0.69     0.08     2.69 1.00     1463      989
## a_cidlow        1.05      0.54     0.09     2.17 1.00     1107      869
## b_cidhigh       0.28      0.09     0.09     0.44 1.00     1122     1248
## b_cidlow        0.26      0.03     0.19     0.33 1.00     1647     1459
## g_Intercept     1.26      0.73     0.39     3.15 1.00     1163     1838
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Compute and check the PSIS-LOO estimates along with their diagnostic Pareto <span class="math inline">\(k\)</span> values.</p>
<div class="sourceCode" id="cb1288"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1288-1" data-line-number="1">b11<span class="fl">.11</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.11</span>, <span class="st">&quot;loo&quot;</span>)</a></code></pre></div>
<pre><code>## Warning: Found 1 observations with a pareto_k &gt; 0.7 in model &#39;b11.11&#39;. It is recommended to set &#39;reloo = TRUE&#39;
## in order to calculate the ELPD without the assumption that these observations are negligible. This will refit
## the model 1 times to compute the ELPDs for the problematic observations directly.</code></pre>
<div class="sourceCode" id="cb1290"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1290-1" data-line-number="1"><span class="kw">loo</span>(b11<span class="fl">.11</span>)</a></code></pre></div>
<pre><code>## Warning: Found 1 observations with a pareto_k &gt; 0.7 in model &#39;b11.11&#39;. It is recommended to set &#39;reloo = TRUE&#39;
## in order to calculate the ELPD without the assumption that these observations are negligible. This will refit
## the model 1 times to compute the ELPDs for the problematic observations directly.</code></pre>
<pre><code>## 
## Computed from 4000 by 10 log-likelihood matrix
## 
##          Estimate   SE
## elpd_loo    -40.6  6.0
## p_loo         5.4  1.8
## looic        81.1 12.0
## ------
## Monte Carlo SE of elpd_loo is NA.
## 
## Pareto k diagnostic values:
##                          Count Pct.    Min. n_eff
## (-Inf, 0.5]   (good)     7     70.0%   498       
##  (0.5, 0.7]   (ok)       2     20.0%   273       
##    (0.7, 1]   (bad)      1     10.0%   39        
##    (1, Inf)   (very bad) 0      0.0%   &lt;NA&gt;      
## See help(&#39;pareto-k-diagnostic&#39;) for details.</code></pre>
<p>We still have Pareto high <span class="math inline">\(k\)</span> values. Recall that due to the very small sample size, this isn’t entirely surprising. Okay, it’s time to make Figure 11.10.</p>
<div class="sourceCode" id="cb1293"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1293-1" data-line-number="1"><span class="co"># for the annotation</span></a>
<a class="sourceLine" id="cb1293-2" data-line-number="2">text &lt;-</a>
<a class="sourceLine" id="cb1293-3" data-line-number="3"><span class="st">  </span><span class="kw">distinct</span>(d, cid) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1293-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">population  =</span> <span class="kw">c</span>(<span class="dv">210000</span>, <span class="dv">72500</span>),</a>
<a class="sourceLine" id="cb1293-5" data-line-number="5">         <span class="dt">total_tools =</span> <span class="kw">c</span>(<span class="dv">59</span>, <span class="dv">68</span>),</a>
<a class="sourceLine" id="cb1293-6" data-line-number="6">         <span class="dt">label       =</span> <span class="kw">str_c</span>(cid, <span class="st">&quot; contact&quot;</span>))</a>
<a class="sourceLine" id="cb1293-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1293-8" data-line-number="8"><span class="co"># redifine the new data</span></a>
<a class="sourceLine" id="cb1293-9" data-line-number="9">nd &lt;-</a>
<a class="sourceLine" id="cb1293-10" data-line-number="10"><span class="st">  </span><span class="kw">distinct</span>(d, cid) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1293-11" data-line-number="11"><span class="st">  </span><span class="kw">expand</span>(cid, </a>
<a class="sourceLine" id="cb1293-12" data-line-number="12">         <span class="dt">population =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">300000</span>, <span class="dt">length.out =</span> <span class="dv">100</span>))</a>
<a class="sourceLine" id="cb1293-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1293-14" data-line-number="14"><span class="co"># compute the poster predictions for lambda</span></a>
<a class="sourceLine" id="cb1293-15" data-line-number="15"><span class="kw">fitted</span>(b11<span class="fl">.11</span>,</a>
<a class="sourceLine" id="cb1293-16" data-line-number="16">       <span class="dt">newdata =</span> nd,</a>
<a class="sourceLine" id="cb1293-17" data-line-number="17">       <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">055</span>, <span class="fl">.945</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1293-18" data-line-number="18"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1293-19" data-line-number="19"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1293-20" data-line-number="20"><span class="st">  </span></a>
<a class="sourceLine" id="cb1293-21" data-line-number="21"><span class="st">  </span><span class="co"># plot!</span></a>
<a class="sourceLine" id="cb1293-22" data-line-number="22"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> population, <span class="dt">group =</span> cid, <span class="dt">color =</span> cid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1293-23" data-line-number="23"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimate, <span class="dt">ymin =</span> Q5<span class="fl">.5</span>, <span class="dt">ymax =</span> Q94<span class="fl">.5</span>, <span class="dt">fill =</span> cid),</a>
<a class="sourceLine" id="cb1293-24" data-line-number="24">              <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>,</a>
<a class="sourceLine" id="cb1293-25" data-line-number="25">              <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1293-26" data-line-number="26"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">bind_cols</span>(d, b11<span class="fl">.11</span><span class="op">$</span>criteria<span class="op">$</span>loo<span class="op">$</span>diagnostics),</a>
<a class="sourceLine" id="cb1293-27" data-line-number="27">             <span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">size =</span> pareto_k),</a>
<a class="sourceLine" id="cb1293-28" data-line-number="28">             <span class="dt">alpha =</span> <span class="dv">4</span><span class="op">/</span><span class="dv">5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1293-29" data-line-number="29"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> text,</a>
<a class="sourceLine" id="cb1293-30" data-line-number="30">            <span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">label =</span> label),</a>
<a class="sourceLine" id="cb1293-31" data-line-number="31">            <span class="dt">family =</span> <span class="st">&quot;serif&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1293-32" data-line-number="32"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1293-33" data-line-number="33"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1293-34" data-line-number="34"><span class="st">  </span><span class="kw">scale_size</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">5</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1293-35" data-line-number="35"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;population&quot;</span>, <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">50000</span>, <span class="dv">150000</span>, <span class="dv">250000</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1293-36" data-line-number="36"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;total tools&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1293-37" data-line-number="37"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(d<span class="op">$</span>population),</a>
<a class="sourceLine" id="cb1293-38" data-line-number="38">                  <span class="dt">ylim =</span> <span class="kw">range</span>(d<span class="op">$</span>total_tools)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1293-39" data-line-number="39"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-79-1.png" width="336" style="display: block; margin: auto;" /></p>
<p>In case you were curious, here are the results if we compare <code>b11.10</code> and <code>b11.11</code> by the PSIS-LOO.</p>
<div class="sourceCode" id="cb1294"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1294-1" data-line-number="1"><span class="kw">loo_compare</span>(b11<span class="fl">.10</span>, b11<span class="fl">.11</span>, <span class="dt">criterion =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</a></code></pre></div>
<pre><code>##        elpd_diff se_diff elpd_loo se_elpd_loo p_loo se_p_loo looic se_looic
## b11.11   0.0       0.0   -40.6      6.0         5.4   1.8     81.1  12.0   
## b11.10  -2.2       2.6   -42.8      6.6         7.1   2.7     85.6  13.3</code></pre>
<div class="sourceCode" id="cb1296"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1296-1" data-line-number="1"><span class="kw">model_weights</span>(b11<span class="fl">.10</span>, b11<span class="fl">.11</span>, <span class="dt">weights =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a></code></pre></div>
<pre><code>## b11.10 b11.11 
##  0.097  0.903</code></pre>
<p>Finally, here’s a comparison of the two models by the Pareto <span class="math inline">\(k\)</span> values.</p>
<div class="sourceCode" id="cb1298"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1298-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">b11.10 =</span> b11<span class="fl">.10</span><span class="op">$</span>criteria<span class="op">$</span>loo<span class="op">$</span>diagnostics<span class="op">$</span>pareto_k,</a>
<a class="sourceLine" id="cb1298-2" data-line-number="2">       <span class="dt">b11.11 =</span> b11<span class="fl">.11</span><span class="op">$</span>criteria<span class="op">$</span>loo<span class="op">$</span>diagnostics<span class="op">$</span>pareto_k) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1298-3" data-line-number="3"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1298-4" data-line-number="4"><span class="st">  </span></a>
<a class="sourceLine" id="cb1298-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1298-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">.7</span>, <span class="dv">1</span>), <span class="dt">linetype =</span> <span class="dv">3</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1298-7" data-line-number="7"><span class="st">  </span><span class="kw">stat_dots</span>(<span class="dt">slab_fill =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span>], </a>
<a class="sourceLine" id="cb1298-8" data-line-number="8">            <span class="dt">slab_color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span>]) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1298-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(Pareto<span class="op">~</span><span class="kw">italic</span>(k)), <span class="dt">breaks =</span> <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">.7</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1298-10" data-line-number="10"><span class="st">  </span><span class="kw">ylab</span>(<span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1298-11" data-line-number="11"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(<span class="fl">1.5</span>, <span class="fl">2.4</span>))</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-81-1.png" width="312" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="negative-binomial-gamma-poisson-models." class="section level3">
<h3><span class="header-section-number">11.2.2</span> Negative binomial (gamma-Poisson) models.</h3>
<blockquote>
<p>Typically there is a lot of unexplained variation in Poisson models. Presumably this additional variation arises from unobserved influences that vary from case to case, generating variation in the true <span class="math inline">\(\lambda\)</span>’s. Ignoring this variation, or <em>rate heterogeneity</em>, can cause confounds just like it can for binomial models. So a very common extension of Poisson GLMs is to swap the Poisson distribution for something called the <strong>negative binomial</strong> distribution. This is really a Poisson distribution in disguise, and it is also sometimes called the <strong>gamma-Poisson</strong> distribution for this reason. It is a Poisson in disguise, because it is a mixture of different Poisson distributions. This is the Poisson analogue of the Student-t model, which is a mixture of different normal distributions. We’ll work with mixtures in the next chapter. (p. 357, <em>emphasis</em> in the original)</p>
</blockquote>
</div>
<div id="example-exposure-and-the-offset." class="section level3">
<h3><span class="header-section-number">11.2.3</span> Example: Exposure and the offset.</h3>
<blockquote>
<p>For the last Poisson example, we’ll look at a case where the exposure varies across observations. When the length of observation, area of sampling, or intensity of sampling varies, the counts we observe also naturally vary. Since a Poisson distribution assumes that the rate of events is constant in time (or space), it’s easy to handle this. All we need to do, as explained above, is to add the logarithm of the exposure to the linear model. The term we add is typically called an <em>offset</em>. (p. 357, <em>emphasis</em> in the original)</p>
</blockquote>
<p>Here we simulate our data.</p>
<div class="sourceCode" id="cb1299"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1299-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">11</span>)</a>
<a class="sourceLine" id="cb1299-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1299-3" data-line-number="3">num_days &lt;-<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb1299-4" data-line-number="4">y        &lt;-<span class="st"> </span><span class="kw">rpois</span>(num_days, <span class="dt">lambda =</span> <span class="fl">1.5</span>)</a>
<a class="sourceLine" id="cb1299-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1299-6" data-line-number="6">num_weeks &lt;-<span class="st"> </span><span class="dv">4</span></a>
<a class="sourceLine" id="cb1299-7" data-line-number="7">y_new     &lt;-<span class="st"> </span><span class="kw">rpois</span>(num_weeks, <span class="dt">lambda =</span> <span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span><span class="dv">7</span>)</a></code></pre></div>
<p>Now tidy the data and add <code>log_days</code>.</p>
<div class="sourceCode" id="cb1300"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1300-1" data-line-number="1">(</a>
<a class="sourceLine" id="cb1300-2" data-line-number="2">  d &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1300-3" data-line-number="3"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">y         =</span> <span class="kw">c</span>(y, y_new), </a>
<a class="sourceLine" id="cb1300-4" data-line-number="4">         <span class="dt">days      =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">7</span>), <span class="dt">times =</span> <span class="kw">c</span>(num_days, num_weeks)),  <span class="co"># this is the exposure</span></a>
<a class="sourceLine" id="cb1300-5" data-line-number="5">         <span class="dt">monastery =</span> <span class="kw">rep</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">times =</span> <span class="kw">c</span>(num_days, num_weeks))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1300-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">log_days =</span> <span class="kw">log</span>(days))</a>
<a class="sourceLine" id="cb1300-7" data-line-number="7">)</a></code></pre></div>
<pre><code>## # A tibble: 34 x 4
##        y  days monastery log_days
##    &lt;int&gt; &lt;dbl&gt;     &lt;int&gt;    &lt;dbl&gt;
##  1     1     1         0        0
##  2     0     1         0        0
##  3     1     1         0        0
##  4     0     1         0        0
##  5     0     1         0        0
##  6     4     1         0        0
##  7     0     1         0        0
##  8     1     1         0        0
##  9     3     1         0        0
## 10     0     1         0        0
## # … with 24 more rows</code></pre>
<p>Within the context of the Poisson likelihood, we can decompose <span class="math inline">\(\lambda\)</span> into two parts, <span class="math inline">\(\mu\)</span> (mean) and <span class="math inline">\(\tau\)</span> (exposure), like this:</p>
<p><span class="math display">\[
y_i \sim \operatorname{Poisson}(\lambda_i) \\
\log \lambda_i = \log \frac{\mu_i}{\tau_i} = \log \mu_i - \log \tau_i.
\]</span></p>
<p>Therefore, you can rewrite the equation if the exposure (<span class="math inline">\(\tau\)</span>) varies in your data and you still want to model the mean (<span class="math inline">\(\mu\)</span>). Using the model we’re about to fit as an example, here’s what that might look like:</p>
<p><span class="math display">\[\begin{align*}
y_i &amp; \sim \operatorname{Poisson}(\mu_i) \\
\log \mu_i &amp; = \log \tau_i + \alpha + \beta \text{monastery}_i \\
\alpha     &amp; \sim \operatorname{Normal}(0, 1) \\
\beta      &amp; \sim \operatorname{Normal}(0, 1),
\end{align*}\]</span></p>
<p>where the offset does not get a prior. In this context, its value is added directly to the right side of the formula. With the <strong>brms</strong> package, you use the <code>offset()</code> function in the <code>formula</code> syntax. You just insert a pre-processed variable like <code>log_days</code> or the log of a variable, such as <code>log(days)</code>. Fit the model.</p>
<div class="sourceCode" id="cb1302"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1302-1" data-line-number="1">b11<span class="fl">.12</span> &lt;-</a>
<a class="sourceLine" id="cb1302-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1302-3" data-line-number="3">      <span class="dt">family =</span> poisson,</a>
<a class="sourceLine" id="cb1302-4" data-line-number="4">      y <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">offset</span>(log_days) <span class="op">+</span><span class="st"> </span>monastery,</a>
<a class="sourceLine" id="cb1302-5" data-line-number="5">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1302-6" data-line-number="6">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b)),</a>
<a class="sourceLine" id="cb1302-7" data-line-number="7">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1302-8" data-line-number="8">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1302-9" data-line-number="9">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.12&quot;</span>)</a></code></pre></div>
<p>As we look at the model summary, keep in mind that the parameters are on the per-one-unit-of-time scale. Since we simulated the data based on summary information from two units of time–one day and seven days–, this means the parameters are in the scale of <span class="math inline">\(\log (\lambda)\)</span> per one day.</p>
<div class="sourceCode" id="cb1303"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1303-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.12</span>)</a></code></pre></div>
<pre><code>##  Family: poisson 
##   Links: mu = log 
## Formula: y ~ 1 + offset(log_days) + monastery 
##    Data: d (Number of observations: 34) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept    -0.01      0.17    -0.36     0.33 1.00     2438     2558
## monastery    -0.88      0.33    -1.56    -0.26 1.00     2486     2050
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>The model summary helps clarify that when you use <code>offset()</code>, <code>brm()</code> fixes the value. Thus there is no parameter estimate for the <code>offset()</code>. It’s a fixed part of the model not unlike the <span class="math inline">\(\nu\)</span> parameter of the Student-<span class="math inline">\(t\)</span> distribution gets fixed to infinity when you use the Gaussian likelihood.</p>
<p>To get the posterior distributions for average daily outputs for the old and new monasteries, respectively, we’ll use use the formulas</p>
<p><span class="math display">\[\begin{align*}
\lambda_\text{old} &amp; = \exp (\alpha) \;\;\; \text{and} \\
\lambda_\text{new} &amp; = \exp (\alpha + \beta_\text{monastery}).
\end{align*}\]</span></p>
<p>Following those transformations, we’ll summarize the <span class="math inline">\(\lambda\)</span> distributions with medians and 89% HDIs with help from the <code>tidybayes::mean_hdi()</code> function.</p>
<div class="sourceCode" id="cb1305"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1305-1" data-line-number="1"><span class="kw">posterior_samples</span>(b11<span class="fl">.12</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1305-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lambda_old =</span> <span class="kw">exp</span>(b_Intercept),</a>
<a class="sourceLine" id="cb1305-3" data-line-number="3">         <span class="dt">lambda_new =</span> <span class="kw">exp</span>(b_Intercept <span class="op">+</span><span class="st"> </span>b_monastery)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1305-4" data-line-number="4"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">contains</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1305-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">factor</span>(name, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;lambda_old&quot;</span>, <span class="st">&quot;lambda_new&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1305-6" data-line-number="6"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1305-7" data-line-number="7"><span class="st">  </span><span class="kw">mean_hdi</span>(value, <span class="dt">.width =</span> <span class="fl">.89</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1305-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 7
##   name       value .lower .upper .width .point .interval
##   &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
## 1 lambda_old  1.01   0.73   1.27   0.89 mean   hdi      
## 2 lambda_new  0.43   0.25   0.61   0.89 mean   hdi</code></pre>
<p>Because we don’t know what seed McElreath used to simulate his data, our simulated data differed a little from his and, as a consequence, our results differ a little.</p>
</div>
</div>
<div id="multinomial-and-categorical-models" class="section level2">
<h2><span class="header-section-number">11.3</span> Multinomial and categorical models</h2>
<blockquote>
<p>When more than two types of unordered events are possible, and the probability of each type of event is constant across trials, then the maximum entropy distribution is the <strong>multinomial distribution</strong>. [We] already met the multinomial, implicitly, in <a href="big-entropy-and-the-generalized-linear-model.html#big-entropy-and-the-generalized-linear-model">Chapter 10</a> when we tossed pebbles into buckets as an introduction to maximum entropy. The binomial is really a special case of this distribution. And so its distribution formula resembles the binomial, just extrapolated out to three or more types of events. If there are <span class="math inline">\(K\)</span> types of events with probabilities <span class="math inline">\(p_1, ..., p_K\)</span>, then the probability of observing <span class="math inline">\(y_1, ..., y_K\)</span> events of each type out of <span class="math inline">\(n\)</span> total trials is:</p>
<p><span class="math display">\[\operatorname{Pr} (y_1, ..., y_K | n, p_1, ..., p_K) = \frac{n!}{\prod_i y_i!} \prod_{i = 1}^K p_i^{y_i}\]</span></p>
<p>The fraction with <span class="math inline">\(n!\)</span> on top just expresses the number of different orderings that give the same counts <span class="math inline">\(y_1, ..., y_K\)</span>. It’s the famous multiplicity from the previous chapter….</p>
<p>The conventional and natural link is this context is the <strong>multinomial logit</strong>, also known as the <strong>softmax</strong> function. This link function takes a vector of <em>scores</em>, one for each <span class="math inline">\(K\)</span> event types, and computes the probability of a particular type of event <span class="math inline">\(k\)</span> as</p>
<p><span class="math display">\[\text{Pr} (k |s_1, s_2, ..., s_K) = \frac{\exp (s_k)}{\sum_{i = 1}^K \exp (s_i)}\]</span>
(p. 359, <strong>emphasis</strong> in the original)</p>
</blockquote>
<p>McElreath then went on to explain how multinomial logistic regression models are among the more difficult of the GLMs to master. He wasn’t kidding. To get a grasp on these, we’ll cover them in a little more detail than he did in the text. Before we begin, I’d like to give a big shout out to <a href="https://adambear.me/">Adam Bear</a>, whose initial comment on a <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse/issues/5">GitHub issue</a> turned into a friendly and productive email collaboration on what, exactly, is going on with this section. Hopefully we got it.</p>
<p>To begin, let’s simulate the data just like McElreath did in the <strong>R</strong> code 11.55 block.</p>
<div class="sourceCode" id="cb1307"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1307-1" data-line-number="1"><span class="kw">library</span>(rethinking)</a>
<a class="sourceLine" id="cb1307-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1307-3" data-line-number="3"><span class="co"># simulate career choices among 500 individuals</span></a>
<a class="sourceLine" id="cb1307-4" data-line-number="4">n      &lt;-<span class="st"> </span><span class="dv">500</span>           <span class="co"># number of individuals</span></a>
<a class="sourceLine" id="cb1307-5" data-line-number="5">income &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>)    <span class="co"># expected income of each career</span></a>
<a class="sourceLine" id="cb1307-6" data-line-number="6">score  &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>income  <span class="co"># scores for each career, based on income</span></a>
<a class="sourceLine" id="cb1307-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1307-8" data-line-number="8"><span class="co"># next line converts scores to probabilities</span></a>
<a class="sourceLine" id="cb1307-9" data-line-number="9">p &lt;-<span class="st"> </span><span class="kw">softmax</span>(score[<span class="dv">1</span>], score[<span class="dv">2</span>], score[<span class="dv">3</span>])</a>
<a class="sourceLine" id="cb1307-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1307-11" data-line-number="11"><span class="co"># now simulate choice</span></a>
<a class="sourceLine" id="cb1307-12" data-line-number="12"><span class="co"># outcome career holds event type values, not counts</span></a>
<a class="sourceLine" id="cb1307-13" data-line-number="13">career &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, n)  <span class="co"># empty vector of choices for each individual</span></a>
<a class="sourceLine" id="cb1307-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1307-15" data-line-number="15"><span class="co"># sample chosen career for each individual</span></a>
<a class="sourceLine" id="cb1307-16" data-line-number="16"><span class="kw">set.seed</span>(<span class="dv">34302</span>)</a>
<a class="sourceLine" id="cb1307-17" data-line-number="17"><span class="co"># sample chosen career for each individual</span></a>
<a class="sourceLine" id="cb1307-18" data-line-number="18"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n) career[i] &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> p)</a></code></pre></div>
<p>Before moving on, it might be useful to examine what we just did. With the three lines below the “# simulate career choices among 500 individuals” comment, we defined the formulas for three scores. Those were</p>
<p><span class="math display">\[
\begin{align*}
s_1 &amp; = 0.5 \times \text{income}_1 \\
s_2 &amp; = 0.5 \times \text{income}_2 \\ 
s_3 &amp; = 0.5 \times \text{income}_3,
\end{align*}
\]</span></p>
<p>where <span class="math inline">\(\text{income}_1 = 1\)</span>, <span class="math inline">\(\text{income}_2 = 2\)</span>, and <span class="math inline">\(\text{income}_3 = 5\)</span>. What’s a little odd about this setup and conceptually important to get is that although <span class="math inline">\(\text{income}_i\)</span> varies across the three levels of <span class="math inline">\(s\)</span>, the <span class="math inline">\(\text{income}_i\)</span> value is constant within each level of <span class="math inline">\(s\)</span>. E.g., <span class="math inline">\(\text{income}_1\)</span> is not a variable within the context of <span class="math inline">\(s_1\)</span>. Therefore, we could also write the above as</p>
<p><span class="math display">\[
\begin{align*}
s_1 &amp; = 0.5 \cdot 1 = 0.5 \\
s_2 &amp; = 0.5 \cdot 2 = 1.0 \\ 
s_3 &amp; = 0.5 \cdot 5 = 2.5.
\end{align*}
\]</span></p>
<p>Let’s confirm.</p>
<div class="sourceCode" id="cb1308"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1308-1" data-line-number="1"><span class="kw">print</span>(score)</a></code></pre></div>
<pre><code>## [1] 0.5 1.0 2.5</code></pre>
<p>We then converted those <code>score</code> values to probabilities with the <code>softmax()</code> function. This will become important when we set up the model code. For now, here’s what the data look like.</p>
<div class="sourceCode" id="cb1310"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1310-1" data-line-number="1"><span class="co"># put them in a tibble</span></a>
<a class="sourceLine" id="cb1310-2" data-line-number="2">d &lt;-</a>
<a class="sourceLine" id="cb1310-3" data-line-number="3"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">career =</span> career) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1310-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">career_income =</span> <span class="kw">ifelse</span>(career <span class="op">==</span><span class="st"> </span><span class="dv">3</span>, <span class="dv">5</span>, career))</a>
<a class="sourceLine" id="cb1310-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1310-6" data-line-number="6"><span class="co"># plot </span></a>
<a class="sourceLine" id="cb1310-7" data-line-number="7">d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1310-8" data-line-number="8"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> career)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1310-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">fill =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span>])</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-88-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>Our <code>career</code> variable is composed of three categories, <code>1:3</code>, with each category more likely than the one before. Here’s a breakdown of the counts, percentages, and probabilities of each category.</p>
<div class="sourceCode" id="cb1311"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1311-1" data-line-number="1">d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1311-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>(career) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1311-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">percent     =</span> (<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n)),</a>
<a class="sourceLine" id="cb1311-4" data-line-number="4">         <span class="dt">probability =</span>        n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a></code></pre></div>
<pre><code>## # A tibble: 3 x 4
##   career     n percent probability
##    &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;       &lt;dbl&gt;
## 1      1    48     9.6       0.096
## 2      2    79    15.8       0.158
## 3      3   373    74.6       0.746</code></pre>
<p>To further build an appreciation for how we simulated data with these proportions and how the process links in with the formulas, above, we’ll retrace the first few simulation steps within a <strong>tidyverse</strong>-centric workflow. Recall how in those first few steps we defined values for <code>income</code>, <code>score</code>, and <code>p</code>. Here they are again in a tibble.</p>
<div class="sourceCode" id="cb1313"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1313-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">income =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1313-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">score =</span> <span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>income) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1313-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p =</span> <span class="kw">exp</span>(score) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">exp</span>(score)))</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   income score      p
##    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1      1   0.5 0.0996
## 2      2   1   0.164 
## 3      5   2.5 0.736</code></pre>
<p>Notice how the values in the <code>p</code> column match up well with the <code>probability</code> values from the output from the block just above. Our simulation successfully produces data corresponding to the data-generating values. Woot! Also note how the code we just used to compute those <code>p</code> values, <code>p = exp(score) / sum(exp(score))</code>, corresponds nicely with the formula from above,</p>
<p><span class="math display">\[\text{Pr} (k |s_1, s_2, ..., s_K) = \frac{\exp (s_k)}{\sum_{i = 1}^K \exp (s_i)}.\]</span></p>
<p>What still might seem mysterious is what those <span class="math inline">\(s\)</span> values in the equation are. In the simulation and in the prose, McElreath called them <em>scores</em>. Another way to think about them is as weights. The thing to get is that their exact values aren’t important so much as their difference one from another. You’ll note that <code>score</code> for <code>income == 2</code> was 0.5 larger than that of <code>income == 1</code>. The same was true for <code>income == 3</code> and <code>income == 2</code>. So if we add an arbitrary constant to each of those <code>score</code> values, like 11, we’ll get the same <code>p</code> values.</p>
<div class="sourceCode" id="cb1315"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1315-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">income        =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>), </a>
<a class="sourceLine" id="cb1315-2" data-line-number="2">       <span class="dt">some_constant =</span> <span class="dv">11</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1315-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">score =</span> (<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>income) <span class="op">+</span><span class="st"> </span>some_constant) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1315-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p =</span> <span class="kw">exp</span>(score) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">exp</span>(score)))</a></code></pre></div>
<pre><code>## # A tibble: 3 x 4
##   income some_constant score      p
##    &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1      1            11  11.5 0.0996
## 2      2            11  12   0.164 
## 3      5            11  13.5 0.736</code></pre>
<p>Now keeping that in mind, recall how McElreath said that though we have <span class="math inline">\(K\)</span> categories, <span class="math inline">\(K = 3\)</span> in this case, we only estimate <span class="math inline">\(K - 1\)</span> linear models. “In a multinomial (or categorical) GLM, you need <span class="math inline">\(K - 1\)</span> linear models for <span class="math inline">\(K\)</span> types of events. One of the outcome values is chosen as a”pivot&quot; and the others are modeled relative to it.&quot; (p. 360). You could also think of the pivot category as the reference category.</p>
<p>Before we practice fitting multinomial models with <strong>brms</strong>, it’ll be helpful if we first follow along with the text and fit the model directly in Stan. We will be working directly with Stan very infrequently in this ebook. If you’re interested in learning more about modeling directly with Stan, you might check out the <a href="https://mc-stan.org/docs/2_23/stan-users-guide/index.html"><em>Stan user’s guide, Version 2.23</em></a> <span class="citation">(Stan Development Team, <a href="#ref-standevelopmentteamStanUserGuide2020">2020</a><a href="#ref-standevelopmentteamStanUserGuide2020">d</a>)</span>, the <a href="https://mc-stan.org/docs/2_23/reference-manual/"><em>Stan reference manual, Version 2.23</em></a> <span class="citation">(Stan Development Team, <a href="#ref-standevelopmentteamStanReferenceManual2020">2020</a><a href="#ref-standevelopmentteamStanReferenceManual2020">c</a>)</span>, and the <a href="https://mc-stan.org/docs/2_23/functions-reference/index.html"><em>Stan functions reference</em></a> <span class="citation">(Stan Development Team, <a href="#ref-standevelopmentteamStanFunctionsReference2020">2020</a><a href="#ref-standevelopmentteamStanFunctionsReference2020">b</a>)</span>. Fit the model with Stan.</p>
<div class="sourceCode" id="cb1317"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1317-1" data-line-number="1"><span class="co"># define the model</span></a>
<a class="sourceLine" id="cb1317-2" data-line-number="2">code_m11<span class="fl">.13</span> &lt;-<span class="st"> &quot;</span></a>
<a class="sourceLine" id="cb1317-3" data-line-number="3"><span class="st">data{</span></a>
<a class="sourceLine" id="cb1317-4" data-line-number="4"><span class="st">  int N; // number of individuals</span></a>
<a class="sourceLine" id="cb1317-5" data-line-number="5"><span class="st">  int K; // number of possible careers </span></a>
<a class="sourceLine" id="cb1317-6" data-line-number="6"><span class="st">  int career[N]; // outcome</span></a>
<a class="sourceLine" id="cb1317-7" data-line-number="7"><span class="st">  vector[K] career_income;</span></a>
<a class="sourceLine" id="cb1317-8" data-line-number="8"><span class="st">}</span></a>
<a class="sourceLine" id="cb1317-9" data-line-number="9"><span class="st">parameters{</span></a>
<a class="sourceLine" id="cb1317-10" data-line-number="10"><span class="st">  vector[K - 1] a; // intercepts</span></a>
<a class="sourceLine" id="cb1317-11" data-line-number="11"><span class="st">  real&lt;lower=0&gt; b; // association of income with choice</span></a>
<a class="sourceLine" id="cb1317-12" data-line-number="12"><span class="st">}</span></a>
<a class="sourceLine" id="cb1317-13" data-line-number="13"><span class="st">model{</span></a>
<a class="sourceLine" id="cb1317-14" data-line-number="14"><span class="st">  vector[K] p;</span></a>
<a class="sourceLine" id="cb1317-15" data-line-number="15"><span class="st">  vector[K] s;</span></a>
<a class="sourceLine" id="cb1317-16" data-line-number="16"><span class="st">  a ~ normal(0, 1);</span></a>
<a class="sourceLine" id="cb1317-17" data-line-number="17"><span class="st">  b ~ normal(0, 0.5);</span></a>
<a class="sourceLine" id="cb1317-18" data-line-number="18"><span class="st">  s[1] = a[1] + b * career_income[1]; </span></a>
<a class="sourceLine" id="cb1317-19" data-line-number="19"><span class="st">  s[2] = a[2] + b * career_income[2]; </span></a>
<a class="sourceLine" id="cb1317-20" data-line-number="20"><span class="st">  s[3] = 0; // pivot</span></a>
<a class="sourceLine" id="cb1317-21" data-line-number="21"><span class="st">  p = softmax(s);</span></a>
<a class="sourceLine" id="cb1317-22" data-line-number="22"><span class="st">  career ~ categorical(p);</span></a>
<a class="sourceLine" id="cb1317-23" data-line-number="23"><span class="st">} </span></a>
<a class="sourceLine" id="cb1317-24" data-line-number="24"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb1317-25" data-line-number="25"></a>
<a class="sourceLine" id="cb1317-26" data-line-number="26"><span class="co"># wrangle the data</span></a>
<a class="sourceLine" id="cb1317-27" data-line-number="27">dat_list &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1317-28" data-line-number="28"><span class="st">  </span><span class="kw">list</span>(<span class="dt">N =</span> n, </a>
<a class="sourceLine" id="cb1317-29" data-line-number="29">       <span class="dt">K =</span> <span class="dv">3</span>, </a>
<a class="sourceLine" id="cb1317-30" data-line-number="30">       <span class="dt">career =</span> career, </a>
<a class="sourceLine" id="cb1317-31" data-line-number="31">       <span class="dt">career_income =</span> income)</a>
<a class="sourceLine" id="cb1317-32" data-line-number="32"></a>
<a class="sourceLine" id="cb1317-33" data-line-number="33"><span class="co"># fit the model</span></a>
<a class="sourceLine" id="cb1317-34" data-line-number="34">m11<span class="fl">.13</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1317-35" data-line-number="35"><span class="st">  </span><span class="kw">stan</span>(<span class="dt">data =</span> dat_list,</a>
<a class="sourceLine" id="cb1317-36" data-line-number="36">       <span class="dt">model_code =</span> code_m11<span class="fl">.13</span>,</a>
<a class="sourceLine" id="cb1317-37" data-line-number="37">       <span class="dt">chains =</span> <span class="dv">4</span>)</a></code></pre></div>
<p>Check the summary.</p>
<div class="sourceCode" id="cb1318"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1318-1" data-line-number="1"><span class="kw">precis</span>(m11<span class="fl">.13</span>, <span class="dt">depth =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##       mean   sd  5.5% 94.5%  n_eff Rhat4
## a[1] -2.13 0.19 -2.46 -1.85 101.27  1.04
## a[2] -1.79 0.27 -2.32 -1.45  63.93  1.07
## b     0.13 0.12  0.01  0.37  56.88  1.07</code></pre>
<p>One of the primary reasons we went through this exercise is to show that McElreath’s <strong>R</strong> code 11.56 and 11.57 do not return the results he reported on page 361. The plot thickens when we attempt the counterfactual simulation on page 362, as reported in <strong>R</strong> code 11.58.</p>
<div class="sourceCode" id="cb1320"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1320-1" data-line-number="1">post &lt;-<span class="st"> </span><span class="kw">extract.samples</span>(m11<span class="fl">.13</span>)</a>
<a class="sourceLine" id="cb1320-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1320-3" data-line-number="3"><span class="co"># set up logit scores</span></a>
<a class="sourceLine" id="cb1320-4" data-line-number="4">s1      &lt;-<span class="st"> </span><span class="kw">with</span>(post, a[, <span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span>income[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb1320-5" data-line-number="5">s2_orig &lt;-<span class="st"> </span><span class="kw">with</span>(post, a[, <span class="dv">2</span>] <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span>income[<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb1320-6" data-line-number="6">s2_new  &lt;-<span class="st"> </span><span class="kw">with</span>(post, a[, <span class="dv">2</span>] <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span>income[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1320-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1320-8" data-line-number="8"><span class="co"># compute probabilities for original and counterfactual </span></a>
<a class="sourceLine" id="cb1320-9" data-line-number="9">p_orig &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(post<span class="op">$</span>b), <span class="cf">function</span>(i)</a>
<a class="sourceLine" id="cb1320-10" data-line-number="10">  <span class="kw">softmax</span>(<span class="kw">c</span>(s1[i], s2_orig[i], <span class="dv">0</span>)))</a>
<a class="sourceLine" id="cb1320-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1320-12" data-line-number="12">p_new &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(post<span class="op">$</span>b), <span class="cf">function</span>(i)</a>
<a class="sourceLine" id="cb1320-13" data-line-number="13">  <span class="kw">softmax</span>(<span class="kw">c</span>(s1[i], s2_new[i], <span class="dv">0</span>)))</a>
<a class="sourceLine" id="cb1320-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1320-15" data-line-number="15"><span class="co"># summarize</span></a>
<a class="sourceLine" id="cb1320-16" data-line-number="16">p_diff &lt;-<span class="st"> </span>p_new[<span class="dv">2</span>, ] <span class="op">-</span><span class="st"> </span>p_orig[<span class="dv">2</span>, ] </a>
<a class="sourceLine" id="cb1320-17" data-line-number="17"><span class="kw">precis</span>(p_diff)</a></code></pre></div>
<pre><code>##              mean        sd        5.5%     94.5%     histogram
## p_diff 0.04258541 0.0429278 0.002595453 0.1274182 ▇▅▂▂▁▁▁▁▁▁▁▁▁</code></pre>
<p>Even though we used the same code, our counterfactual simulation doesn’t match up with the results McElreath reported in the text, either. Keep this all in mind as we switch to <strong>brms</strong>. But before we move on to <strong>brms</strong>, check this out.</p>
<div class="sourceCode" id="cb1322"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1322-1" data-line-number="1"><span class="kw">data.frame</span>(<span class="dt">s1 =</span> score[<span class="dv">3</span>] <span class="op">+</span><span class="st"> </span>s1, </a>
<a class="sourceLine" id="cb1322-2" data-line-number="2">           <span class="dt">s2 =</span> score[<span class="dv">3</span>] <span class="op">+</span><span class="st"> </span>s2_orig, </a>
<a class="sourceLine" id="cb1322-3" data-line-number="3">           <span class="dt">s3 =</span> score[<span class="dv">3</span>] <span class="op">+</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1322-4" data-line-number="4"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1322-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1322-6" data-line-number="6"><span class="st">  </span><span class="kw">mean_qi</span>(value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1322-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 7
##   name  value .lower .upper .width .point .interval
##   &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
## 1 s1     0.5    0.21   0.78   0.95 mean   qi       
## 2 s2     0.98   0.74   1.21   0.95 mean   qi       
## 3 s3     2.5    2.5    2.5    0.95 mean   qi</code></pre>
<p>In his Stan code (<strong>R</strong> code 11.56), you’ll see McElreath chose the third category to be his pivot and that he used zero as a constant value. As it turns out, it is common practice to set the score value for the reference category to zero. It’s also a common practice to use the first event type as the reference category. Importantly, in his <span class="citation">(<a href="#ref-Bürkner2020Parameterization">2020</a><a href="#ref-Bürkner2020Parameterization">h</a>)</span> vignette, <a href="https://cran.r-project.org/package=brms/vignettes/brms_families.html#ordinal-and-categorical-models"><em>Parameterization of response distributions in brms</em></a>, Bürkner clarified the <strong>brms</strong> default is to use the first response category as the reference and set it to a zero as well. However, we can control this behavior with the <code>refcat</code> argument. In the examples to follow, we’ll follow McElreath and use the third event type as the reference category by setting <code>refcat = 3</code>.</p>
<p>In addition to the discrepancies with the code and results in the text, one of the things I don’t care for in this section is how fast McElreath covered the material. Our approach will be to slow down a little and start off by fitting a intercepts-only model before adding the covariate. Before we fit the model, we might take a quick look at the prior structure with <code>brms::get_prior()</code>.</p>
<div class="sourceCode" id="cb1324"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1324-1" data-line-number="1"><span class="kw">get_prior</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1324-2" data-line-number="2">          <span class="dt">family =</span> <span class="kw">categorical</span>(<span class="dt">link =</span> logit, <span class="dt">refcat =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1324-3" data-line-number="3">          career <span class="op">~</span><span class="st"> </span><span class="dv">1</span>)</a></code></pre></div>
<pre><code>##                  prior     class coef group resp dpar nlpar bound
## 1                      Intercept                                 
## 2 student_t(3, 3, 2.5) Intercept                  mu1            
## 3 student_t(3, 3, 2.5) Intercept                  mu2</code></pre>
<p>We have two “intercepts”, which are differentiated in the <code>dpar</code> column. We’ll talk more about what these are in just a bit; don’t worry. I show this here because as of <strong>brms</strong> 2.12.0, “specifying global priors for regression coefficients in categorical models is deprecated.” The upshot is even if we want to use the same prior for both, we need to use the <code>dpar</code> argument for each. With that in mind, here’s our multinomial model in <strong>brms</strong>. Do note the specification <code>family = categorical(link = logit, refcat = 3)</code>. The <code>categorical</code> part is what instructs <strong>brms</strong> to use the multinomial likelihood and the <code>refcat = 3</code> part will allow us to use the third event type as the pivot.</p>
<div class="sourceCode" id="cb1326"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1326-1" data-line-number="1">b11<span class="fl">.13</span>io &lt;-</a>
<a class="sourceLine" id="cb1326-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1326-3" data-line-number="3">      <span class="dt">family =</span> <span class="kw">categorical</span>(<span class="dt">link =</span> logit, <span class="dt">refcat =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1326-4" data-line-number="4">      career <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1326-5" data-line-number="5">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept, <span class="dt">dpar =</span> mu1),</a>
<a class="sourceLine" id="cb1326-6" data-line-number="6">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept, <span class="dt">dpar =</span> mu2)),</a>
<a class="sourceLine" id="cb1326-7" data-line-number="7">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1326-8" data-line-number="8">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1326-9" data-line-number="9">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.13io&quot;</span>)</a></code></pre></div>
<p>The summary can be difficult to interpret.</p>
<div class="sourceCode" id="cb1327"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1327-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.13</span>io)</a></code></pre></div>
<pre><code>##  Family: categorical 
##   Links: mu1 = logit; mu2 = logit 
## Formula: career ~ 1 
##    Data: d (Number of observations: 500) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## mu1_Intercept    -2.01      0.15    -2.31    -1.73 1.00     3226     2560
## mu2_Intercept    -1.53      0.12    -1.77    -1.29 1.00     2768     2628
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p><code>brms::brm()</code> referred to the <span class="math inline">\(K\)</span> categories as <code>mu1</code>, <code>mu2</code>, and <code>mu3</code>. Since <code>career == 3</code> is the reference category, the score for which was set to zero, there is no parameter for <code>mu3_Intercept</code>. That’s a zero. Now notice how <code>mu1_Intercept</code> is about -2 and <code>mu2_Intercept</code> is about -1.5. If we double back to the <code>income</code> and <code>score</code> values we played with at the beginning of this section, you’ll notice that the score for the reference category was 2.5. Here’s what happens if we rescale the three scores such that the <code>score</code> value for the reference category is 0.</p>
<div class="sourceCode" id="cb1329"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1329-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">income =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1329-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">score =</span> <span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>income) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1329-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rescaled_score =</span> score <span class="op">-</span><span class="st"> </span><span class="fl">2.5</span>)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   income score rescaled_score
##    &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt;
## 1      1   0.5           -2  
## 2      2   1             -1.5
## 3      5   2.5            0</code></pre>
<p>Now see how the <code>rescaled_score</code> values for the first two rows correspond nicely to <code>mu1_Intercept</code> and <code>mu2_Intercept</code> from our model. What I hope this clarifies is that our statistical model returned the scores. But recall these are not quite probabilities. Why? Because the weights are all relative to one another. The easiest way to get what we want, the probabilities for the three categories, is with <code>brms::fitted()</code>. Since this model has no predictors, only intercepts, we won’t specify any <code>newdata</code>. In such a case, <code>fitted()</code> will return fitted values for each case in the data. Going slow, let’s take a look at the structure of the output.</p>
<div class="sourceCode" id="cb1331"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1331-1" data-line-number="1"><span class="kw">fitted</span>(b11<span class="fl">.13</span>io) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str</span>()</a></code></pre></div>
<pre><code>##  num [1:500, 1:4, 1:3] 0.0998 0.0998 0.0998 0.0998 0.0998 ...
##  - attr(*, &quot;dimnames&quot;)=List of 3
##   ..$ : NULL
##   ..$ : chr [1:4] &quot;Estimate&quot; &quot;Est.Error&quot; &quot;Q2.5&quot; &quot;Q97.5&quot;
##   ..$ : chr [1:3] &quot;P(Y = 1)&quot; &quot;P(Y = 2)&quot; &quot;P(Y = 3)&quot;</code></pre>
<p>Just as expected, we have 500 rows–one for each case in the original data. We have four summary columns, the typical <code>Estimate</code>, <code>Est.Error</code>, <code>Q2.5</code>, and <code>Q97.5</code>. We also have third dimension composed of three levels, <code>P(Y = 1)</code>, <code>P(Y = 2)</code>, and <code>P(Y = 3)</code>. Those index which of the three career categories each probability summary is for. Since the results are identical for each row, we’ll simplify the output by only keeping the first row.</p>
<div class="sourceCode" id="cb1333"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1333-1" data-line-number="1"><span class="kw">fitted</span>(b11<span class="fl">.13</span>io)[<span class="dv">1</span>, , ] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1333-2" data-line-number="2"><span class="st">  </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##           P(Y = 1) P(Y = 2) P(Y = 3)
## Estimate      0.10     0.16     0.74
## Est.Error     0.01     0.02     0.02
## Q2.5          0.07     0.13     0.70
## Q97.5         0.13     0.19     0.78</code></pre>
<p>If we take the transpose of that, it will put the results in the format we’re more accustomed to.</p>
<div class="sourceCode" id="cb1335"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1335-1" data-line-number="1"><span class="kw">fitted</span>(b11<span class="fl">.13</span>io)[<span class="dv">1</span>, , ] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1335-2" data-line-number="2"><span class="st">  </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1335-3" data-line-number="3"><span class="st">  </span><span class="kw">t</span>()</a></code></pre></div>
<pre><code>##          Estimate Est.Error Q2.5 Q97.5
## P(Y = 1)     0.10      0.01 0.07  0.13
## P(Y = 2)     0.16      0.02 0.13  0.19
## P(Y = 3)     0.74      0.02 0.70  0.78</code></pre>
<p>Now compare those summaries with the empirically-derived percent and probability values we computed earlier.</p>
<div class="sourceCode" id="cb1337"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1337-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">income =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1337-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">score =</span> <span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>income) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1337-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p =</span> <span class="kw">exp</span>(score) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">exp</span>(score)))</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   income score      p
##    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1      1   0.5 0.0996
## 2      2   1   0.164 
## 3      5   2.5 0.736</code></pre>
<p>How here’s how to make use of the formula from the last <code>mutate()</code> line, <span class="math inline">\(\frac{\exp (s_k)}{\sum_{i = 1}^K \exp (s_i)}\)</span>, to compute the marginal probabilities from <code>b11.13io</code> by hand.</p>
<div class="sourceCode" id="cb1339"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1339-1" data-line-number="1"><span class="kw">posterior_samples</span>(b11<span class="fl">.13</span>io) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1339-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">b_mu3_Intercept =</span> <span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1339-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p1 =</span> <span class="kw">exp</span>(b_mu1_Intercept) <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(b_mu1_Intercept) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(b_mu2_Intercept) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(b_mu3_Intercept)),</a>
<a class="sourceLine" id="cb1339-4" data-line-number="4">         <span class="dt">p2 =</span> <span class="kw">exp</span>(b_mu2_Intercept) <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(b_mu1_Intercept) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(b_mu2_Intercept) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(b_mu3_Intercept)),</a>
<a class="sourceLine" id="cb1339-5" data-line-number="5">         <span class="dt">p3 =</span> <span class="kw">exp</span>(b_mu3_Intercept) <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(b_mu1_Intercept) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(b_mu2_Intercept) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(b_mu3_Intercept))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1339-6" data-line-number="6"><span class="st">  </span><span class="kw">pivot_longer</span>(p1<span class="op">:</span>p3) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1339-7" data-line-number="7"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1339-8" data-line-number="8"><span class="st">  </span><span class="kw">mean_qi</span>(value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1339-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 7
##   name  value .lower .upper .width .point .interval
##   &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
## 1 p1     0.1    0.07   0.13   0.95 mean   qi       
## 2 p2     0.16   0.13   0.19   0.95 mean   qi       
## 3 p3     0.74   0.7    0.78   0.95 mean   qi</code></pre>
<p>Hurray; we did it! Not only did we fit a simple multinomial model with <strong>brms</strong>, we actually made sense of the parameters by connecting them to the original data-generating values. We’re almost ready to contend with the model McElreath fit with <code>stan()</code>. But before we do, it’ll be helpful to show alternative ways to fit these models. We used conventional style syntax when we fit <code>b11.13io</code>. There are at least two alternative ways to fit the model:</p>
<div class="sourceCode" id="cb1341"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1341-1" data-line-number="1"><span class="co"># verbose syntax</span></a>
<a class="sourceLine" id="cb1341-2" data-line-number="2">b11<span class="fl">.13</span>io_verbose &lt;-</a>
<a class="sourceLine" id="cb1341-3" data-line-number="3"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1341-4" data-line-number="4">      <span class="dt">family =</span> <span class="kw">categorical</span>(<span class="dt">link =</span> logit, <span class="dt">refcat =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1341-5" data-line-number="5">      <span class="kw">bf</span>(career <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1341-6" data-line-number="6">         mu1 <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1341-7" data-line-number="7">         mu2 <span class="op">~</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1341-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept, <span class="dt">dpar =</span> mu1),</a>
<a class="sourceLine" id="cb1341-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept, <span class="dt">dpar =</span> mu2)),</a>
<a class="sourceLine" id="cb1341-10" data-line-number="10">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1341-11" data-line-number="11">      <span class="dt">seed =</span> <span class="dv">11</span>)</a>
<a class="sourceLine" id="cb1341-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1341-13" data-line-number="13"><span class="co"># nonlinear syntax</span></a>
<a class="sourceLine" id="cb1341-14" data-line-number="14">b11<span class="fl">.13</span>io_nonlinear &lt;-</a>
<a class="sourceLine" id="cb1341-15" data-line-number="15"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1341-16" data-line-number="16">      <span class="dt">family =</span> <span class="kw">categorical</span>(<span class="dt">link =</span> logit, <span class="dt">refcat =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1341-17" data-line-number="17">      <span class="kw">bf</span>(career <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1341-18" data-line-number="18">         <span class="kw">nlf</span>(mu1 <span class="op">~</span><span class="st"> </span>a1),</a>
<a class="sourceLine" id="cb1341-19" data-line-number="19">         <span class="kw">nlf</span>(mu2 <span class="op">~</span><span class="st"> </span>a2),</a>
<a class="sourceLine" id="cb1341-20" data-line-number="20">         a1 <span class="op">+</span><span class="st"> </span>a2 <span class="op">~</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1341-21" data-line-number="21">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a1),</a>
<a class="sourceLine" id="cb1341-22" data-line-number="22">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a2)),</a>
<a class="sourceLine" id="cb1341-23" data-line-number="23">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1341-24" data-line-number="24">      <span class="dt">seed =</span> <span class="dv">11</span>)</a></code></pre></div>
<p>For the sake of space, I’m not going to show the results for those two models. If you fit them yourself, you’ll see the results for <code>b11.13io</code> and <code>b11.13io_verbose</code> are exactly the same and <code>b11.13io_nonlinear</code> differs from them only within simulation variation. I point this out because it’s the nonlinear approach that will allow us to fit a model like McElreath’s <code>m11.13</code>. My hope is the syntax we used in the <code>b11.13io_verbose</code> model will help clarify what’s going on with the non-linear syntax. When we fit multinomial models with <strong>brms</strong>, the terse conventional <code>formula</code> syntax might not make clear how there are actually <span class="math inline">\(K - 1\)</span> formulas. The more verbose syntax of our <code>b11.13io_verbose</code> model shows how we can specify those models directly. In our case, that was with those <code>mu1 ~ 1, mu2 ~ 1</code> lines. Had we used the <strong>brms</strong> default and used the first level of <code>career</code> as the pivot, those lines would have instead been <code>mu2 ~ 1, mu3 ~ 1</code>. So anyway, when we switch to the non-linear syntax, we explicitly model <code>mu1</code> and <code>mu2</code> and, as is typical of the non-linear syntax, we name our parameters. You can see another comparison of these three ways of fitting a multinomial model at the <a href="https://discourse.mc-stan.org/t/nonlinear-syntax-with-a-multinomial-model/16122">Nonlinear syntax with a multinomial model?</a> thread on the Stan Forums.</p>
<p>Now it’s time to focus on the <strong>brms</strong> version of McElreath’s <code>m11.13</code>. To my eye, McElreath’s model has two odd features. First, though he has two intercepts, he only has one <span class="math inline">\(\beta\)</span> parameter. Second, if you look at McElreath’s <code>parameters</code> block, you’ll see that he restricted his <span class="math inline">\(\beta\)</span> parameter to be zero and above (<code>real&lt;lower=0&gt; b;</code>).</p>
<p>With the <strong>brms</strong> non-linear syntax, we can fit the model with one <span class="math inline">\(\beta\)</span> parameter or allow the one <span class="math inline">\(\beta\)</span> parameter to differ for <code>mu1</code> and <code>mu2</code>. As to setting a lower bound to the <code>b</code> parameter[s], we can do that with the <code>lb</code> argument within the <code>prior()</code> function. If we fit our version of <code>m11.13</code> by systemically varying these two features, we’ll end up with the four versions listed in the table below.</p>
<div class="sourceCode" id="cb1342"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1342-1" data-line-number="1"><span class="kw">crossing</span>(<span class="dt">b  =</span> <span class="kw">factor</span>(<span class="kw">c</span>(<span class="st">&quot;b1 + b2&quot;</span>, <span class="st">&quot;b&quot;</span>), <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;b1 + b2&quot;</span>, <span class="st">&quot;b&quot;</span>)),</a>
<a class="sourceLine" id="cb1342-2" data-line-number="2">         <span class="dt">lb =</span> <span class="kw">factor</span>(<span class="kw">c</span>(<span class="st">&quot;NA&quot;</span>, <span class="dv">0</span>), <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;NA&quot;</span>, <span class="dv">0</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1342-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fit =</span> <span class="kw">str_c</span>(<span class="st">&quot;b11.13&quot;</span>, letters[<span class="dv">1</span><span class="op">:</span><span class="kw">n</span>()])) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1342-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(fit, <span class="kw">everything</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1342-5" data-line-number="5"><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">fit</th>
<th align="left">b</th>
<th align="left">lb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">b11.13a</td>
<td align="left">b1 + b2</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">b11.13b</td>
<td align="left">b1 + b2</td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td align="left">b11.13c</td>
<td align="left">b</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">b11.13d</td>
<td align="left">b</td>
<td align="left">0</td>
</tr>
</tbody>
</table>
<p>Fit <code>b11.13a</code> through <code>b11.13d</code>, the four variants on the model.</p>
<div class="sourceCode" id="cb1343"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1343-1" data-line-number="1">b11<span class="fl">.13</span>a &lt;-</a>
<a class="sourceLine" id="cb1343-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1343-3" data-line-number="3">      <span class="dt">family =</span> <span class="kw">categorical</span>(<span class="dt">link =</span> logit, <span class="dt">refcat =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1343-4" data-line-number="4">      <span class="kw">bf</span>(career <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1343-5" data-line-number="5">         <span class="kw">nlf</span>(mu1 <span class="op">~</span><span class="st"> </span>a1 <span class="op">+</span><span class="st"> </span>b1 <span class="op">*</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1343-6" data-line-number="6">         <span class="kw">nlf</span>(mu2 <span class="op">~</span><span class="st"> </span>a2 <span class="op">+</span><span class="st"> </span>b2 <span class="op">*</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1343-7" data-line-number="7">         a1 <span class="op">+</span><span class="st"> </span>a2 <span class="op">+</span><span class="st"> </span>b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">~</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1343-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a1),</a>
<a class="sourceLine" id="cb1343-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a2),</a>
<a class="sourceLine" id="cb1343-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> b1),</a>
<a class="sourceLine" id="cb1343-11" data-line-number="11">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> b2)),</a>
<a class="sourceLine" id="cb1343-12" data-line-number="12">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1343-13" data-line-number="13">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1343-14" data-line-number="14">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.13a&quot;</span>)</a>
<a class="sourceLine" id="cb1343-15" data-line-number="15"></a>
<a class="sourceLine" id="cb1343-16" data-line-number="16">b11<span class="fl">.13</span>b &lt;-</a>
<a class="sourceLine" id="cb1343-17" data-line-number="17"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1343-18" data-line-number="18">      <span class="dt">family =</span> <span class="kw">categorical</span>(<span class="dt">link =</span> logit, <span class="dt">refcat =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1343-19" data-line-number="19">      <span class="kw">bf</span>(career <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1343-20" data-line-number="20">         <span class="kw">nlf</span>(mu1 <span class="op">~</span><span class="st"> </span>a1 <span class="op">+</span><span class="st"> </span>b1 <span class="op">*</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1343-21" data-line-number="21">         <span class="kw">nlf</span>(mu2 <span class="op">~</span><span class="st"> </span>a2 <span class="op">+</span><span class="st"> </span>b2 <span class="op">*</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1343-22" data-line-number="22">         a1 <span class="op">+</span><span class="st"> </span>a2 <span class="op">+</span><span class="st"> </span>b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">~</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1343-23" data-line-number="23">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a1),</a>
<a class="sourceLine" id="cb1343-24" data-line-number="24">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a2),</a>
<a class="sourceLine" id="cb1343-25" data-line-number="25">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> b1, <span class="dt">lb =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1343-26" data-line-number="26">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> b2, <span class="dt">lb =</span> <span class="dv">0</span>)),</a>
<a class="sourceLine" id="cb1343-27" data-line-number="27">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1343-28" data-line-number="28">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1343-29" data-line-number="29">      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">.99</span>),</a>
<a class="sourceLine" id="cb1343-30" data-line-number="30">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.13b&quot;</span>)</a>
<a class="sourceLine" id="cb1343-31" data-line-number="31"></a>
<a class="sourceLine" id="cb1343-32" data-line-number="32">b11<span class="fl">.13</span>c &lt;-</a>
<a class="sourceLine" id="cb1343-33" data-line-number="33"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1343-34" data-line-number="34">      <span class="dt">family =</span> <span class="kw">categorical</span>(<span class="dt">link =</span> logit, <span class="dt">refcat =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1343-35" data-line-number="35">      <span class="kw">bf</span>(career <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1343-36" data-line-number="36">         <span class="kw">nlf</span>(mu1 <span class="op">~</span><span class="st"> </span>a1 <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1343-37" data-line-number="37">         <span class="kw">nlf</span>(mu2 <span class="op">~</span><span class="st"> </span>a2 <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1343-38" data-line-number="38">         a1 <span class="op">+</span><span class="st"> </span>a2 <span class="op">+</span><span class="st"> </span>b <span class="op">~</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1343-39" data-line-number="39">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a1),</a>
<a class="sourceLine" id="cb1343-40" data-line-number="40">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a2),</a>
<a class="sourceLine" id="cb1343-41" data-line-number="41">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> b)),</a>
<a class="sourceLine" id="cb1343-42" data-line-number="42">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1343-43" data-line-number="43">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1343-44" data-line-number="44">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.13c&quot;</span>)</a>
<a class="sourceLine" id="cb1343-45" data-line-number="45"></a>
<a class="sourceLine" id="cb1343-46" data-line-number="46">b11<span class="fl">.13</span>d &lt;-</a>
<a class="sourceLine" id="cb1343-47" data-line-number="47"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1343-48" data-line-number="48">      <span class="dt">family =</span> <span class="kw">categorical</span>(<span class="dt">link =</span> logit, <span class="dt">refcat =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1343-49" data-line-number="49">      <span class="kw">bf</span>(career <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1343-50" data-line-number="50">         <span class="kw">nlf</span>(mu1 <span class="op">~</span><span class="st"> </span>a1 <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1343-51" data-line-number="51">         <span class="kw">nlf</span>(mu2 <span class="op">~</span><span class="st"> </span>a2 <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1343-52" data-line-number="52">         a1 <span class="op">+</span><span class="st"> </span>a2 <span class="op">+</span><span class="st"> </span>b <span class="op">~</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1343-53" data-line-number="53">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a1),</a>
<a class="sourceLine" id="cb1343-54" data-line-number="54">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a2),</a>
<a class="sourceLine" id="cb1343-55" data-line-number="55">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> b, <span class="dt">lb =</span> <span class="dv">0</span>)),</a>
<a class="sourceLine" id="cb1343-56" data-line-number="56">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1343-57" data-line-number="57">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1343-58" data-line-number="58">      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">.99</span>),</a>
<a class="sourceLine" id="cb1343-59" data-line-number="59">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.13d&quot;</span>)</a></code></pre></div>
<p>I’m not going to exhaustively show the <code>print()</code> output for each. If you check, you’ll see they all fit reasonably well. Here we’ll look at their parameter summaries in bulk with a coefficient plot.</p>
<div class="sourceCode" id="cb1344"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1344-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">fit =</span> <span class="kw">str_c</span>(<span class="st">&quot;b11.13&quot;</span>, letters[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>])) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1344-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fixef =</span> purrr<span class="op">::</span><span class="kw">map</span>(fit, <span class="op">~</span><span class="kw">get</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1344-3" data-line-number="3"><span class="st">                              </span><span class="kw">fixef</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1344-4" data-line-number="4"><span class="st">                              </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1344-5" data-line-number="5"><span class="st">                              </span><span class="kw">rownames_to_column</span>(<span class="st">&quot;parameter&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1344-6" data-line-number="6"><span class="st">  </span><span class="kw">unnest</span>(fixef) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1344-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parameter =</span> <span class="kw">str_remove</span>(parameter, <span class="st">&quot;_Intercept&quot;</span>),</a>
<a class="sourceLine" id="cb1344-8" data-line-number="8">         <span class="dt">fit       =</span> <span class="kw">factor</span>(fit, <span class="dt">levels =</span> <span class="kw">str_c</span>(<span class="st">&quot;b11.13&quot;</span>, letters[<span class="dv">4</span><span class="op">:</span><span class="dv">1</span>]))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1344-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb1344-10" data-line-number="10"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Estimate, <span class="dt">xmin =</span> Q2<span class="fl">.5</span>, <span class="dt">xmax =</span> Q97<span class="fl">.5</span>, <span class="dt">y =</span> fit)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1344-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">3</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1344-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="dt">fatten =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1344-13" data-line-number="13"><span class="st">  </span><span class="kw">ylab</span>(<span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1344-14" data-line-number="14"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1344-15" data-line-number="15">        <span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">8</span>), <span class="dt">size =</span> <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1344-16" data-line-number="16"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>parameter, <span class="dt">nrow =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-107-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The results differed across models. None of them match up with the results McElreath reported in the text. However, the parameters from <code>b11.13d</code> are very close to those from our <code>m11.13</code>.</p>
<div class="sourceCode" id="cb1345"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1345-1" data-line-number="1"><span class="kw">precis</span>(m11<span class="fl">.13</span>, <span class="dt">depth =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##            mean        sd         5.5%      94.5%     n_eff    Rhat4
## a[1] -2.1341458 0.1927525 -2.457427970 -1.8543986 101.26816 1.039573
## a[2] -1.7888544 0.2662395 -2.315997996 -1.4486228  63.92879 1.065868
## b     0.1345084 0.1201704  0.009794993  0.3711676  56.87836 1.073703</code></pre>
<div class="sourceCode" id="cb1347"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1347-1" data-line-number="1"><span class="kw">fixef</span>(b11<span class="fl">.13</span>d) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##              Estimate Est.Error  Q2.5 Q97.5
## a1_Intercept    -2.14      0.19 -2.56 -1.80
## a2_Intercept    -1.79      0.26 -2.44 -1.39
## b_Intercept      0.13      0.12  0.00  0.44</code></pre>
<p>It might be instructive to compare <code>b11.13a</code> through <code>b11.13d</code> with the PSIS-LOO.</p>
<div class="sourceCode" id="cb1349"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1349-1" data-line-number="1">b11<span class="fl">.13</span>a &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.13</span>a, <span class="st">&quot;loo&quot;</span>)</a>
<a class="sourceLine" id="cb1349-2" data-line-number="2">b11<span class="fl">.13</span>b &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.13</span>b, <span class="st">&quot;loo&quot;</span>)</a>
<a class="sourceLine" id="cb1349-3" data-line-number="3">b11<span class="fl">.13</span>c &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.13</span>c, <span class="st">&quot;loo&quot;</span>)</a>
<a class="sourceLine" id="cb1349-4" data-line-number="4">b11<span class="fl">.13</span>d &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.13</span>d, <span class="st">&quot;loo&quot;</span>)</a>
<a class="sourceLine" id="cb1349-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1349-6" data-line-number="6"><span class="kw">loo_compare</span>(b11<span class="fl">.13</span>a, b11<span class="fl">.13</span>b, b11<span class="fl">.13</span>c, b11<span class="fl">.13</span>d, <span class="dt">criterion =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1349-7" data-line-number="7"><span class="st">  </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</a></code></pre></div>
<pre><code>##         elpd_diff se_diff elpd_loo se_elpd_loo p_loo  se_p_loo looic  se_looic
## b11.13c    0.0       0.0  -369.5     17.1         1.9    0.1    738.9   34.2  
## b11.13a   -0.1       0.0  -369.5     17.1         2.0    0.1    739.1   34.1  
## b11.13d   -0.1       0.2  -369.6     16.9         1.9    0.1    739.1   33.8  
## b11.13b   -0.2       0.2  -369.6     16.9         2.0    0.1    739.3   33.8</code></pre>
<div class="sourceCode" id="cb1351"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1351-1" data-line-number="1"><span class="kw">model_weights</span>(b11<span class="fl">.13</span>a, b11<span class="fl">.13</span>b, b11<span class="fl">.13</span>c, b11<span class="fl">.13</span>d, <span class="dt">weights =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1351-2" data-line-number="2"><span class="st">  </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## b11.13a b11.13b b11.13c b11.13d 
##    0.25    0.23    0.27    0.25</code></pre>
<p>Two things pop out, here. First, all models are essentially equivalent in terms of LOO estimates and LOO weights. Second, the effective number of parameters (<span class="math inline">\(p_\text{LOO}\)</span>) is about 2 for each model. At first glance, this might be surprising given that <code>b11.13a</code> and <code>b11.13b</code> both have 4 parameters and <code>b11.13c</code> and <code>b11.13d</code> both have three parameters. But recall that none of these models contain predictor variables from the data. All those <span class="math inline">\(\beta\)</span> parameters, whether they’re held equal or allowed to vary across <span class="math inline">\(s_1\)</span> and <span class="math inline">\(s_2\)</span>, are just constants. In the absence of actual <code>income</code> values that vary within the data, those <span class="math inline">\(\beta\)</span> parameters are kinda like extra intercepts. For context, go back and review our multicollinear legs from <a href="the-haunted-dag-the-causal-terror.html#multicollinear-legs.">Section 6.1.1</a> or our double intercepts from <a href="markov-chain-monte-carlo.html#non-identifiable-parameters.">Section 9.5.4</a>.</p>
<p>Now see what happens when we compare these four models with our intercepts-only model, <code>b11.13io</code>.</p>
<div class="sourceCode" id="cb1353"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1353-1" data-line-number="1">b11<span class="fl">.13</span>io &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.13</span>io, <span class="st">&quot;loo&quot;</span>)</a>
<a class="sourceLine" id="cb1353-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1353-3" data-line-number="3"><span class="kw">loo_compare</span>(b11<span class="fl">.13</span>io, b11<span class="fl">.13</span>a, b11<span class="fl">.13</span>b, b11<span class="fl">.13</span>c, b11<span class="fl">.13</span>d, <span class="dt">criterion =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1353-4" data-line-number="4"><span class="st">  </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</a></code></pre></div>
<pre><code>##          elpd_diff se_diff elpd_loo se_elpd_loo p_loo  se_p_loo looic  se_looic
## b11.13c     0.0       0.0  -369.5     17.1         1.9    0.1    738.9   34.2  
## b11.13a    -0.1       0.0  -369.5     17.1         2.0    0.1    739.1   34.1  
## b11.13io   -0.1       0.2  -369.6     16.9         1.9    0.1    739.1   33.9  
## b11.13d    -0.1       0.2  -369.6     16.9         1.9    0.1    739.1   33.8  
## b11.13b    -0.2       0.2  -369.6     16.9         2.0    0.1    739.3   33.8</code></pre>
<div class="sourceCode" id="cb1355"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1355-1" data-line-number="1"><span class="kw">model_weights</span>(b11<span class="fl">.13</span>io, b11<span class="fl">.13</span>a, b11<span class="fl">.13</span>b, b11<span class="fl">.13</span>c, b11<span class="fl">.13</span>d, <span class="dt">weights =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1355-2" data-line-number="2"><span class="st">  </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## b11.13io  b11.13a  b11.13b  b11.13c  b11.13d 
##     0.20     0.20     0.18     0.22     0.20</code></pre>
<p>They’re all the same. Each model effectively has 2 parameters. Though it doesn’t do much by way of cross-validation, McElreath’s extra <span class="math inline">\(\beta\)</span> parameter will let us perform a counterfactual simulation. Here is a <strong>brms</strong>/<strong>tidyverse</strong> workflow to make a counterfactual simulation for two levels of <code>income</code> based on our <code>b11.13d</code>, the <strong>brms</strong> model most closely corresponding to our <strong>rethinking</strong>-based <code>m11.13</code>.</p>
<div class="sourceCode" id="cb1357"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1357-1" data-line-number="1"><span class="kw">posterior_samples</span>(b11<span class="fl">.13</span>d) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1357-2" data-line-number="2"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">s1      =</span> b_a1_Intercept <span class="op">+</span><span class="st"> </span>b_b_Intercept <span class="op">*</span><span class="st"> </span>income[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb1357-3" data-line-number="3">            <span class="dt">s2_orig =</span> b_a2_Intercept <span class="op">+</span><span class="st"> </span>b_b_Intercept <span class="op">*</span><span class="st"> </span>income[<span class="dv">2</span>],</a>
<a class="sourceLine" id="cb1357-4" data-line-number="4">            <span class="dt">s2_new  =</span> b_a2_Intercept <span class="op">+</span><span class="st"> </span>b_b_Intercept <span class="op">*</span><span class="st"> </span>income[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1357-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p_orig =</span> purrr<span class="op">::</span><span class="kw">map2_dbl</span>(s1, s2_orig, <span class="op">~</span><span class="kw">softmax</span>(.x, .y, <span class="dv">0</span>)[<span class="dv">2</span>]),</a>
<a class="sourceLine" id="cb1357-6" data-line-number="6">         <span class="dt">p_new  =</span> purrr<span class="op">::</span><span class="kw">map2_dbl</span>(s1, s2_new, <span class="op">~</span><span class="kw">softmax</span>(.x, .y, <span class="dv">0</span>)[<span class="dv">2</span>])) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1357-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p_diff =</span> p_new <span class="op">-</span><span class="st"> </span>p_orig) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1357-8" data-line-number="8"><span class="st">  </span><span class="kw">mean_qi</span>(p_diff) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1357-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##   p_diff .lower .upper .width .point .interval
## 1   0.04      0   0.16   0.95   mean        qi</code></pre>
<p>Now let’s build.</p>
<div id="predictors-matched-to-observations." class="section level3">
<h3><span class="header-section-number">11.3.1</span> Predictors matched to observations.</h3>
<blockquote>
<p>Now consider an example in which each observed outcome has unique predictor values. Suppose you are still modeling career choice. But now you want to estimate the association between each person’s family income and which career they choose. So the predictor variable must have the same value in each linear model, for each row in the data. But now there is a unique parameter multiplying it in each linear model. This provides an estimate of the impact of family income on choice, for each type of career. (p. 362)</p>
</blockquote>
<div class="sourceCode" id="cb1359"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1359-1" data-line-number="1">n &lt;-<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb1359-2" data-line-number="2"><span class="kw">set.seed</span>(<span class="dv">11</span>)</a>
<a class="sourceLine" id="cb1359-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1359-4" data-line-number="4"><span class="co"># simulate family incomes for each individual</span></a>
<a class="sourceLine" id="cb1359-5" data-line-number="5">family_income &lt;-<span class="st"> </span><span class="kw">runif</span>(n)</a>
<a class="sourceLine" id="cb1359-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1359-7" data-line-number="7"><span class="co"># assign a unique coefficient for each type of event</span></a>
<a class="sourceLine" id="cb1359-8" data-line-number="8">b      &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1359-9" data-line-number="9">career &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, n)  <span class="co"># empty vector of choices for each individual</span></a>
<a class="sourceLine" id="cb1359-10" data-line-number="10"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n) {</a>
<a class="sourceLine" id="cb1359-11" data-line-number="11">    score     &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span>family_income[i]</a>
<a class="sourceLine" id="cb1359-12" data-line-number="12">    p         &lt;-<span class="st"> </span><span class="kw">softmax</span>(score[<span class="dv">1</span>], score[<span class="dv">2</span>], score[<span class="dv">3</span>])</a>
<a class="sourceLine" id="cb1359-13" data-line-number="13">    career[i] &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> p)</a>
<a class="sourceLine" id="cb1359-14" data-line-number="14">}</a></code></pre></div>
<p>In effect, we now have three data-generating equations:</p>
<p><span class="math display">\[
\begin{align*}
s_1 &amp; = 0.5 + -2 \cdot \text{family_income}_i \\
s_2 &amp; = 1.0 +  0 \cdot \text{family_income}_i \\ 
s_3 &amp; = 1.5 +  2 \cdot \text{family_income}_i,
\end{align*}
\]</span></p>
<p>where, because <code>family_income</code> is an actual variable that can take on unique values for each row in the data, we can call the first term in each equation the <span class="math inline">\(\alpha\)</span> parameter and the second term in each equation the <span class="math inline">\(\beta\)</span> parameter AND those <span class="math inline">\(\beta\)</span> parameters will be more than odd double intercepts.</p>
<p>We might examine what the <code>family_income</code> distributions look like across the three levels of <code>career</code>. We’ll do it in two plots and combine them with the patchwork syntax. The first will be overlapping densities. For the second, we’ll display the proportions of <code>career</code> across a discretized version of <code>family_income</code> in a stacked area plot.</p>
<div class="sourceCode" id="cb1360"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1360-1" data-line-number="1"><span class="co"># put the data in a tibble</span></a>
<a class="sourceLine" id="cb1360-2" data-line-number="2">d &lt;-</a>
<a class="sourceLine" id="cb1360-3" data-line-number="3"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">career =</span> career) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1360-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">family_income =</span> family_income)</a>
<a class="sourceLine" id="cb1360-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1360-6" data-line-number="6">p1 &lt;-</a>
<a class="sourceLine" id="cb1360-7" data-line-number="7"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1360-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">career =</span> <span class="kw">as.factor</span>(career)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1360-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb1360-10" data-line-number="10"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> family_income, <span class="dt">fill =</span> career)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1360-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1360-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1360-13" data-line-number="13"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a>
<a class="sourceLine" id="cb1360-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb1360-15" data-line-number="15">p2 &lt;-</a>
<a class="sourceLine" id="cb1360-16" data-line-number="16"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1360-17" data-line-number="17"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">career =</span> <span class="kw">as.factor</span>(career)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1360-18" data-line-number="18"><span class="st">  </span></a>
<a class="sourceLine" id="cb1360-19" data-line-number="19"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fi =</span> santoku<span class="op">::</span><span class="kw">chop_width</span>(family_income, <span class="dt">width =</span> <span class="fl">.1</span>, <span class="dt">start =</span> <span class="dv">0</span>, <span class="dt">labels =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1360-20" data-line-number="20"><span class="st">  </span><span class="kw">count</span>(fi, career) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1360-21" data-line-number="21"><span class="st">  </span><span class="kw">group_by</span>(fi) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1360-22" data-line-number="22"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">proportion =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1360-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">f =</span> <span class="kw">as.double</span>(fi)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1360-24" data-line-number="24"><span class="st">  </span></a>
<a class="sourceLine" id="cb1360-25" data-line-number="25"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> (f <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">/</span><span class="st"> </span><span class="dv">9</span>, <span class="dt">y =</span> proportion, <span class="dt">fill =</span> career)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1360-26" data-line-number="26"><span class="st">  </span><span class="kw">geom_area</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb1360-27" data-line-number="27"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1360-28" data-line-number="28"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;family_income, descritized&quot;</span>)</a>
<a class="sourceLine" id="cb1360-29" data-line-number="29"></a>
<a class="sourceLine" id="cb1360-30" data-line-number="30">p1 <span class="op">+</span><span class="st"> </span>p2</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-113-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Since Mcelreath’s simulation code in McElreath’s <strong>R</strong> code 11.59 did not contain a <code>set.seed()</code> line, it won’t be possible to exactly reproduce his results. Happily, though, it appears that this time the results he reported in the text to cohere reasonably well with I ran the code on my computer. They weren’t identical, but there were much closer that for <code>m11.13</code> from the last section. Since things are working more smoothly, here, I’m going to jump directly to <strong>brms</strong> code.</p>
<div class="sourceCode" id="cb1361"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1361-1" data-line-number="1">b11<span class="fl">.14</span> &lt;-</a>
<a class="sourceLine" id="cb1361-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1361-3" data-line-number="3">      <span class="dt">family =</span> <span class="kw">categorical</span>(<span class="dt">link =</span> logit, <span class="dt">refcat =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1361-4" data-line-number="4">      <span class="kw">bf</span>(career <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1361-5" data-line-number="5">         <span class="kw">nlf</span>(mu1 <span class="op">~</span><span class="st"> </span>a1 <span class="op">+</span><span class="st"> </span>b1 <span class="op">*</span><span class="st"> </span>family_income),</a>
<a class="sourceLine" id="cb1361-6" data-line-number="6">         <span class="kw">nlf</span>(mu2 <span class="op">~</span><span class="st"> </span>a2 <span class="op">+</span><span class="st"> </span>b2 <span class="op">*</span><span class="st"> </span>family_income),</a>
<a class="sourceLine" id="cb1361-7" data-line-number="7">         a1 <span class="op">+</span><span class="st"> </span>a2 <span class="op">+</span><span class="st"> </span>b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">~</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1361-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a1),</a>
<a class="sourceLine" id="cb1361-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> a2),</a>
<a class="sourceLine" id="cb1361-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> b1),</a>
<a class="sourceLine" id="cb1361-11" data-line-number="11">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">nlpar =</span> b2)),</a>
<a class="sourceLine" id="cb1361-12" data-line-number="12">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1361-13" data-line-number="13">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1361-14" data-line-number="14">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.14&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb1362"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1362-1" data-line-number="1"><span class="kw">print</span>(b11<span class="fl">.14</span>)</a></code></pre></div>
<pre><code>##  Family: categorical 
##   Links: mu1 = logit; mu2 = logit 
## Formula: career ~ 1 
##          mu1 ~ a1 + b1 * family_income
##          mu2 ~ a2 + b2 * family_income
##          a1 ~ 1
##          a2 ~ 1
##          b1 ~ 1
##          b2 ~ 1
##    Data: d (Number of observations: 500) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a1_Intercept    -1.29      0.26    -1.80    -0.79 1.00     2410     2255
## a2_Intercept    -1.01      0.22    -1.47    -0.59 1.00     2130     2133
## b1_Intercept    -2.49      0.57    -3.64    -1.36 1.00     2207     2143
## b2_Intercept    -1.21      0.43    -2.04    -0.37 1.00     2093     2006
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Check the PSIS-LOO.</p>
<div class="sourceCode" id="cb1364"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1364-1" data-line-number="1">b11<span class="fl">.14</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b11<span class="fl">.14</span>, <span class="st">&quot;loo&quot;</span>)</a>
<a class="sourceLine" id="cb1364-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1364-3" data-line-number="3"><span class="kw">loo</span>(b11<span class="fl">.14</span>)</a></code></pre></div>
<pre><code>## 
## Computed from 4000 by 500 log-likelihood matrix
## 
##          Estimate   SE
## elpd_loo   -330.4 17.0
## p_loo         3.3  0.3
## looic       660.9 33.9
## ------
## Monte Carlo SE of elpd_loo is 0.0.
## 
## All Pareto k estimates are good (k &lt; 0.5).
## See help(&#39;pareto-k-diagnostic&#39;) for details.</code></pre>
<p>Now that we actually have predictor variables with which we might estimate conventional <span class="math inline">\(\beta\)</span> parameters, we finally have more than 2 effective parameters (<span class="math inline">\(p_\text{LOO}\)</span>).</p>
<p>“Again, computing implied predictions is the safest way to interpret these models. They do a great job of classifying discrete, unordered events. But the parameters are on a scale that is very hard to interpret” (p. 325). Like before, we’ll do that with <code>fitted()</code>. Now we have a predictor, this time we will use the <code>newdata</code> argument.</p>
<div class="sourceCode" id="cb1366"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1366-1" data-line-number="1">nd &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">family_income =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">1</span>, <span class="dt">length.out =</span> <span class="dv">60</span>))</a>
<a class="sourceLine" id="cb1366-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1366-3" data-line-number="3">f &lt;-</a>
<a class="sourceLine" id="cb1366-4" data-line-number="4"><span class="st">  </span><span class="kw">fitted</span>(b11<span class="fl">.14</span>,</a>
<a class="sourceLine" id="cb1366-5" data-line-number="5">        <span class="dt">newdata =</span> nd)</a></code></pre></div>
<p>First we’ll plot the fitted probabilities for each <code>career</code> level across the full range of <code>family_income</code> values.</p>
<div class="sourceCode" id="cb1367"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1367-1" data-line-number="1"><span class="co"># wrangle</span></a>
<a class="sourceLine" id="cb1367-2" data-line-number="2"><span class="kw">rbind</span>(f[, , <span class="dv">1</span>],</a>
<a class="sourceLine" id="cb1367-3" data-line-number="3">      f[, , <span class="dv">2</span>],</a>
<a class="sourceLine" id="cb1367-4" data-line-number="4">      f[, , <span class="dv">3</span>]) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1367-5" data-line-number="5"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1367-6" data-line-number="6"><span class="st">  </span><span class="kw">bind_cols</span>(nd <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">expand</span>(<span class="dt">career =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, family_income)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1367-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">career =</span> <span class="kw">str_c</span>(<span class="st">&quot;career: &quot;</span>, career)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1367-8" data-line-number="8"><span class="st">  </span></a>
<a class="sourceLine" id="cb1367-9" data-line-number="9"><span class="st">  </span><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1367-10" data-line-number="10"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> family_income, <span class="dt">y =</span> Estimate,</a>
<a class="sourceLine" id="cb1367-11" data-line-number="11">             <span class="dt">ymin =</span> Q2<span class="fl">.5</span>, <span class="dt">ymax =</span> Q97<span class="fl">.5</span>,</a>
<a class="sourceLine" id="cb1367-12" data-line-number="12">             <span class="dt">fill =</span> career, <span class="dt">color =</span> career)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1367-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">size =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1367-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1367-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1367-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1367-17" data-line-number="17"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1367-18" data-line-number="18"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;probability&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1367-19" data-line-number="19">                     <span class="dt">breaks =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">3</span> <span class="op">/</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;0&quot;</span>, <span class="st">&quot;.33&quot;</span>, <span class="st">&quot;.67&quot;</span>, <span class="st">&quot;1&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1367-20" data-line-number="20"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1367-21" data-line-number="21">        <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1367-22" data-line-number="22"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>career)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-117-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>If we’re willing to summarize those fitted lines by their posterior means, we could also make a model-implied version of the stacked area plot from above.</p>
<div class="sourceCode" id="cb1368"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1368-1" data-line-number="1"><span class="co"># annotation</span></a>
<a class="sourceLine" id="cb1368-2" data-line-number="2">text &lt;-</a>
<a class="sourceLine" id="cb1368-3" data-line-number="3"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">family_income =</span> <span class="kw">c</span>(.<span class="dv">45</span>, <span class="fl">.3</span>, <span class="fl">.15</span>),</a>
<a class="sourceLine" id="cb1368-4" data-line-number="4">         <span class="dt">proportion    =</span> <span class="kw">c</span>(.<span class="dv">65</span>, <span class="fl">.8</span>, <span class="fl">.95</span>),</a>
<a class="sourceLine" id="cb1368-5" data-line-number="5">         <span class="dt">label         =</span> <span class="kw">str_c</span>(<span class="st">&quot;career: &quot;</span>, <span class="dv">3</span><span class="op">:</span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1368-6" data-line-number="6">         <span class="dt">color         =</span> <span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>))</a>
<a class="sourceLine" id="cb1368-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1368-8" data-line-number="8"><span class="co"># wrangle</span></a>
<a class="sourceLine" id="cb1368-9" data-line-number="9"><span class="kw">rbind</span>(f[, , <span class="dv">1</span>],</a>
<a class="sourceLine" id="cb1368-10" data-line-number="10">      f[, , <span class="dv">2</span>],</a>
<a class="sourceLine" id="cb1368-11" data-line-number="11">      f[, , <span class="dv">3</span>]) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1368-12" data-line-number="12"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1368-13" data-line-number="13"><span class="st">  </span><span class="kw">bind_cols</span>(nd <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">expand</span>(<span class="dt">career =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, family_income)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1368-14" data-line-number="14"><span class="st">  </span><span class="kw">group_by</span>(family_income) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1368-15" data-line-number="15"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">proportion =</span> Estimate <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(Estimate),</a>
<a class="sourceLine" id="cb1368-16" data-line-number="16">         <span class="dt">career     =</span> <span class="kw">factor</span>(career)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1368-17" data-line-number="17"><span class="st">  </span></a>
<a class="sourceLine" id="cb1368-18" data-line-number="18"><span class="st">  </span><span class="co"># plot!</span></a>
<a class="sourceLine" id="cb1368-19" data-line-number="19"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> family_income, <span class="dt">y =</span> proportion)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1368-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_area</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> career)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1368-21" data-line-number="21"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> text,</a>
<a class="sourceLine" id="cb1368-22" data-line-number="22">            <span class="kw">aes</span>(<span class="dt">label =</span> label, <span class="dt">color =</span> color),</a>
<a class="sourceLine" id="cb1368-23" data-line-number="23">            <span class="dt">family =</span> <span class="st">&quot;Times&quot;</span>, <span class="dt">size =</span> <span class="fl">4.25</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1368-24" data-line-number="24"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span><span class="op">:</span><span class="dv">3</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1368-25" data-line-number="25"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1368-26" data-line-number="26"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-118-1.png" width="312" style="display: block; margin: auto;" /></p>
<p>For more practice fitting multinomial models with <strong>brms</strong>, check out <a href="https://bookdown.org/content/3686/nominal-predicted-variable.html">Chapter 22</a> of my <span class="citation">(<a href="#ref-kurzDoingBayesianData2020">2020</a><a href="#ref-kurzDoingBayesianData2020">b</a>)</span> translation of Kruschke’s <span class="citation">(<a href="#ref-kruschkeDoingBayesianData2015">2015</a>)</span> text.</p>
<div id="multinomial-in-disguise-as-poisson." class="section level4">
<h4><span class="header-section-number">11.3.1.1</span> Multinomial in disguise as Poisson.</h4>
<p>Here we fit a multinomial likelihood by refactoring it to a series of Poissons. Let’s retrieve the Berkeley data.</p>
<div class="sourceCode" id="cb1369"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1369-1" data-line-number="1"><span class="kw">library</span>(rethinking)</a>
<a class="sourceLine" id="cb1369-2" data-line-number="2"><span class="kw">data</span>(UCBadmit)</a>
<a class="sourceLine" id="cb1369-3" data-line-number="3">d &lt;-<span class="st"> </span>UCBadmit</a>
<a class="sourceLine" id="cb1369-4" data-line-number="4"><span class="kw">rm</span>(UCBadmit)</a>
<a class="sourceLine" id="cb1369-5" data-line-number="5"><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</a>
<a class="sourceLine" id="cb1369-6" data-line-number="6"><span class="kw">library</span>(brms)</a></code></pre></div>
<p>Fit the models.</p>
<div class="sourceCode" id="cb1370"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1370-1" data-line-number="1"><span class="co"># binomial model of overall admission probability</span></a>
<a class="sourceLine" id="cb1370-2" data-line-number="2">b11.binom &lt;-</a>
<a class="sourceLine" id="cb1370-3" data-line-number="3"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1370-4" data-line-number="4">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1370-5" data-line-number="5">      admit <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(applications) <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1370-6" data-line-number="6">      <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1370-7" data-line-number="7">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">3</span>, <span class="dt">chains =</span> <span class="dv">3</span>,</a>
<a class="sourceLine" id="cb1370-8" data-line-number="8">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1370-9" data-line-number="9">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.binom&quot;</span>)</a>
<a class="sourceLine" id="cb1370-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1370-11" data-line-number="11"><span class="co"># Poisson model of overall admission rate and rejection rate</span></a>
<a class="sourceLine" id="cb1370-12" data-line-number="12">b11.pois &lt;-</a>
<a class="sourceLine" id="cb1370-13" data-line-number="13"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1370-14" data-line-number="14"><span class="st">        </span><span class="kw">mutate</span>(<span class="dt">rej =</span> reject),  <span class="co"># &#39;reject&#39; is a reserved word</span></a>
<a class="sourceLine" id="cb1370-15" data-line-number="15">      <span class="dt">family =</span> poisson,</a>
<a class="sourceLine" id="cb1370-16" data-line-number="16">      <span class="kw">mvbind</span>(admit, rej) <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1370-17" data-line-number="17">      <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1370-18" data-line-number="18">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">3</span>, <span class="dt">chains =</span> <span class="dv">3</span>,</a>
<a class="sourceLine" id="cb1370-19" data-line-number="19">      <span class="dt">seed =</span> <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb1370-20" data-line-number="20">      <span class="dt">file =</span> <span class="st">&quot;fits/b11.pois&quot;</span>)</a></code></pre></div>
<p>Note, the <code>mvbind()</code> syntax made <code>b11.pois</code> a multivariate Poisson model. Starting with version 2.0.0, <strong>brms</strong> supports a variety of multivariate models, which you might learn more about with Bürkner’s <span class="citation">(<a href="#ref-Bürkner2020Multivariate">2020</a><a href="#ref-Bürkner2020Multivariate">c</a>)</span> vignette, <a href="https://cran.r-project.org/package=brms/vignettes/brms_multivariate.html"><em>Estimating multivariate models with brms</em></a>. Anyway, here are the implications of <code>b11.pois</code>.</p>
<div class="sourceCode" id="cb1371"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1371-1" data-line-number="1"><span class="co"># extract the samples</span></a>
<a class="sourceLine" id="cb1371-2" data-line-number="2">post &lt;-<span class="st"> </span><span class="kw">posterior_samples</span>(b11.pois)</a>
<a class="sourceLine" id="cb1371-3" data-line-number="3"><span class="co"># wrangle</span></a>
<a class="sourceLine" id="cb1371-4" data-line-number="4">post <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1371-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">admit  =</span> <span class="kw">exp</span>(b_admit_Intercept), </a>
<a class="sourceLine" id="cb1371-6" data-line-number="6">         <span class="dt">reject =</span> <span class="kw">exp</span>(b_rej_Intercept)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1371-7" data-line-number="7"><span class="st">  </span><span class="kw">pivot_longer</span>(admit<span class="op">:</span>reject) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1371-8" data-line-number="8"><span class="st">  </span></a>
<a class="sourceLine" id="cb1371-9" data-line-number="9"><span class="st">  </span><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1371-10" data-line-number="10"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> name, <span class="dt">fill =</span> name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1371-11" data-line-number="11"><span class="st">  </span><span class="kw">stat_halfeye</span>(<span class="dt">point_interval =</span> median_qi, <span class="dt">.width =</span> <span class="fl">.95</span>,</a>
<a class="sourceLine" id="cb1371-12" data-line-number="12">               <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1371-13" data-line-number="13"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1371-14" data-line-number="14"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot; Mean admit/reject rates across departments&quot;</span>,</a>
<a class="sourceLine" id="cb1371-15" data-line-number="15">       <span class="dt">x =</span> <span class="st">&quot;# applications&quot;</span>,</a>
<a class="sourceLine" id="cb1371-16" data-line-number="16">       <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1371-17" data-line-number="17"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1371-18" data-line-number="18">        <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-120-1.png" width="624" style="display: block; margin: auto;" /></p>
<p>We might compare the model summaries.</p>
<div class="sourceCode" id="cb1372"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1372-1" data-line-number="1"><span class="kw">summary</span>(b11.binom)<span class="op">$</span>fixed</a></code></pre></div>
<pre><code>##             Estimate Est.Error   l-95% CI   u-95% CI     Rhat Bulk_ESS Tail_ESS
## Intercept -0.4554727  0.030408 -0.5131503 -0.3933352 1.002252     1207     1601</code></pre>
<div class="sourceCode" id="cb1374"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1374-1" data-line-number="1"><span class="kw">summary</span>(b11.pois)<span class="op">$</span>fixed</a></code></pre></div>
<pre><code>##                 Estimate  Est.Error l-95% CI u-95% CI     Rhat Bulk_ESS Tail_ESS
## admit_Intercept 4.984362 0.02362118 4.937529 5.028207 1.001698     2675     1651
## rej_Intercept   5.441076 0.01881634 5.404090 5.478881 1.000537     2994     2209</code></pre>
<p>Here’s the posterior mean for the probability of admission, based on <code>b11.binom</code>.</p>
<div class="sourceCode" id="cb1376"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1376-1" data-line-number="1"><span class="kw">fixef</span>(b11.binom)[ ,<span class="st">&quot;Estimate&quot;</span>] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1376-2" data-line-number="2"><span class="st">  </span><span class="kw">inv_logit_scaled</span>()</a></code></pre></div>
<pre><code>## [1] 0.3880604</code></pre>
<p>Happily, we get the same value within simulation error from model <code>b11.pois</code>.</p>
<div class="sourceCode" id="cb1378"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1378-1" data-line-number="1">k &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1378-2" data-line-number="2"><span class="st">  </span><span class="kw">fixef</span>(b11.pois) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1378-3" data-line-number="3"><span class="st">  </span><span class="kw">as.numeric</span>()</a>
<a class="sourceLine" id="cb1378-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1378-5" data-line-number="5"><span class="kw">exp</span>(k[<span class="dv">1</span>]) <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(k[<span class="dv">1</span>]) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(k[<span class="dv">2</span>]))</a></code></pre></div>
<pre><code>## [1] 0.3877655</code></pre>
<p>The formula for what we just did in code is</p>
<p><span class="math display">\[p_\text{admit} = \frac{\lambda_1}{\lambda_1 + \lambda_2} = \frac{\exp (\alpha_1)}{\exp (\alpha_1) + \exp (\alpha_2)}.\]</span></p>
<p>To get a better appreciation on how well the two model types converge on the same solution, we might plot the full poster for admissions probability from each.</p>
<div class="sourceCode" id="cb1380"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1380-1" data-line-number="1"><span class="co"># wrangle</span></a>
<a class="sourceLine" id="cb1380-2" data-line-number="2"><span class="kw">bind_cols</span>(</a>
<a class="sourceLine" id="cb1380-3" data-line-number="3">  <span class="kw">posterior_samples</span>(b11.pois) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1380-4" data-line-number="4"><span class="st">    </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">the Poisson</span><span class="st">`</span>  =<span class="st"> </span><span class="kw">exp</span>(b_admit_Intercept) <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(b_admit_Intercept) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(b_rej_Intercept))),</a>
<a class="sourceLine" id="cb1380-5" data-line-number="5">  <span class="kw">posterior_samples</span>(b11.binom) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1380-6" data-line-number="6"><span class="st">    </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">the binomial</span><span class="st">`</span> =<span class="st"> </span><span class="kw">inv_logit_scaled</span>(b_Intercept))</a>
<a class="sourceLine" id="cb1380-7" data-line-number="7">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1380-8" data-line-number="8"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;the&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1380-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb1380-10" data-line-number="10"><span class="st">  </span><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1380-11" data-line-number="11"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> name, <span class="dt">fill =</span> name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1380-12" data-line-number="12"><span class="st">  </span><span class="kw">stat_halfeye</span>(<span class="dt">point_interval =</span> median_qi, <span class="dt">.width =</span> <span class="kw">c</span>(.<span class="dv">95</span>, <span class="fl">.5</span>),</a>
<a class="sourceLine" id="cb1380-13" data-line-number="13">               <span class="dt">color =</span> <span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">4</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb1380-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="kw">wes_palette</span>(<span class="st">&quot;Moonrise2&quot;</span>)[<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>])) <span class="op">+</span></a>
<a class="sourceLine" id="cb1380-15" data-line-number="15"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Two models, same marginal posterior&quot;</span>,</a>
<a class="sourceLine" id="cb1380-16" data-line-number="16">       <span class="dt">x =</span> <span class="st">&quot;admissions probability&quot;</span>,</a>
<a class="sourceLine" id="cb1380-17" data-line-number="17">       <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1380-18" data-line-number="18"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(<span class="fl">1.5</span>, <span class="fl">2.25</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1380-19" data-line-number="19"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1380-20" data-line-number="20">        <span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1380-21" data-line-number="21">        <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="11_files/figure-html/unnamed-chunk-124-1.png" width="432" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="summary" class="section level2">
<h2><span class="header-section-number">11.4</span> Summary</h2>
<blockquote>
<p>This chapter described some of the most common generalized linear models, those used to model counts. It is important to never convert counts to proportions before analysis, because doing so destroys information about sample size. A fundamental difficulty with these models is that parameters are on a different scale, typically log-odds (for binomial) or log-rate (for Poisson), than the outcome variable they describe. Therefore computing implied predictions is even more important than before. (p. 365)</p>
</blockquote>
</div>
<div id="session-info-10" class="section level2 unnumbered">
<h2>Session info</h2>
<div class="sourceCode" id="cb1381"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1381-1" data-line-number="1"><span class="kw">sessionInfo</span>()</a></code></pre></div>
<pre><code>## R version 3.6.3 (2020-02-29)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS Catalina 10.15.3
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] parallel  stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] ggrepel_0.8.2        GGally_1.5.0         ggdag_0.2.2          patchwork_1.0.0      tidybayes_2.1.1     
##  [6] ggthemes_4.2.0       wesanderson_0.3.6    brms_2.13.0          Rcpp_1.0.4.6         forcats_0.5.0       
## [11] stringr_1.4.0        dplyr_0.8.5          purrr_0.3.4          readr_1.3.1          tidyr_1.0.2         
## [16] tibble_3.0.1         tidyverse_1.3.0      dagitty_0.2-2        rstan_2.19.3         ggplot2_3.3.1       
## [21] StanHeaders_2.21.0-1
## 
## loaded via a namespace (and not attached):
##   [1] readxl_1.3.1         backports_1.1.7      plyr_1.8.6           igraph_1.2.5         splines_3.6.3       
##   [6] svUnit_1.0.3         crosstalk_1.1.0.1    TH.data_1.0-10       rstantools_2.0.0     inline_0.3.15       
##  [11] digest_0.6.25        htmltools_0.4.0      viridis_0.5.1        rsconnect_0.8.16     fansi_0.4.1         
##  [16] magrittr_1.5         graphlayouts_0.7.0   modelr_0.1.6         matrixStats_0.56.0   xts_0.12-0          
##  [21] sandwich_2.5-1       prettyunits_1.1.1    colorspace_1.4-1     rvest_0.3.5          ggdist_2.1.1        
##  [26] haven_2.2.0          xfun_0.13            callr_3.4.3          crayon_1.3.4         jsonlite_1.6.1      
##  [31] survival_3.1-12      zoo_1.8-7            glue_1.4.1           polyclip_1.10-0      gtable_0.3.0        
##  [36] emmeans_1.4.5        V8_3.0.2             pkgbuild_1.0.8       shape_1.4.4          abind_1.4-5         
##  [41] scales_1.1.1         mvtnorm_1.1-0        emo_0.0.0.9000       DBI_1.1.0            miniUI_0.1.1.1      
##  [46] viridisLite_0.3.0    xtable_1.8-4         HDInterval_0.2.0     stats4_3.6.3         DT_0.13             
##  [51] htmlwidgets_1.5.1    httr_1.4.1           threejs_0.3.3        RColorBrewer_1.1-2   arrayhelpers_1.1-0  
##  [56] ellipsis_0.3.1       santoku_0.3.0        reshape_0.8.8        pkgconfig_2.0.3      loo_2.2.0           
##  [61] farver_2.0.3         dbplyr_1.4.2         utf8_1.1.4           tidyselect_1.0.0     labeling_0.3        
##  [66] rlang_0.4.6          reshape2_1.4.4       later_1.0.0          munsell_0.5.0        cellranger_1.1.0    
##  [71] tools_3.6.3          cli_2.0.2            generics_0.0.2       broom_0.5.5          ggridges_0.5.2      
##  [76] evaluate_0.14        fastmap_1.0.1        yaml_2.2.1           processx_3.4.2       knitr_1.28          
##  [81] fs_1.4.1             tidygraph_1.2.0      ggraph_2.0.3         nlme_3.1-144         mime_0.9            
##  [86] xml2_1.3.1           compiler_3.6.3       bayesplot_1.7.1      shinythemes_1.1.2    rstudioapi_0.11     
##  [91] curl_4.3             reprex_0.3.0         tweenr_1.0.1         stringi_1.4.6        highr_0.8           
##  [96] ps_1.3.3             Brobdingnag_1.2-6    lattice_0.20-38      Matrix_1.2-18        markdown_1.1        
## [101] shinyjs_1.1          vctrs_0.3.1          pillar_1.4.4         lifecycle_0.2.0      bridgesampling_1.0-0
## [106] estimability_1.3     httpuv_1.5.2         R6_2.4.1             bookdown_0.18        promises_1.1.0      
## [111] gridExtra_2.3        codetools_0.2-16     boot_1.3-24          colourpicker_1.0     MASS_7.3-51.5       
## [116] gtools_3.8.2         assertthat_0.2.1     withr_2.2.0          shinystan_2.5.0      multcomp_1.4-13     
## [121] hms_0.5.3            grid_3.6.3           coda_0.19-3          rmarkdown_2.1        ggforce_0.3.1       
## [126] shiny_1.4.0.2        lubridate_1.7.8      base64enc_0.1-3      dygraphs_1.1.1.6</code></pre>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-bickelSexBiasGraduate1975">
<p>Bickel, P. J., Hammel, E. A., &amp; O’Connell, J. W. (1975). Sex bias in graduate admissions: Data from Berkeley. <em>Science</em>, <em>187</em>(4175), 398–404. <a href="https://doi.org/10.1126/science.187.4175.398">https://doi.org/10.1126/science.187.4175.398</a></p>
</div>
<div id="ref-Bürkner2020Multivariate">
<p>Bürkner, P.-C. (2020c). <em>Estimating multivariate models with brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_multivariate.html">https://CRAN.R-project.org/package=brms/vignettes/brms_multivariate.html</a></p>
</div>
<div id="ref-Bürkner2020Parameterization">
<p>Bürkner, P.-C. (2020h). <em>Parameterization of response distributions in brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_families.html">https://CRAN.R-project.org/package=brms/vignettes/brms_families.html</a></p>
</div>
<div id="ref-kievitSimpsonParadoxPsychological2013">
<p>Kievit, R., Frankenhuis, W. E., Waldorp, L., &amp; Borsboom, D. (2013). Simpson’s paradox in psychological science: A practical guide. <em>Frontiers in Psychology</em>, <em>4</em>. <a href="https://doi.org/10.3389/fpsyg.2013.00513">https://doi.org/10.3389/fpsyg.2013.00513</a></p>
</div>
<div id="ref-klinePopulationSizePredicts2010">
<p>Kline, M. A., &amp; Boyd, R. (2010). Population size predicts technological complexity in Oceania. <em>Proceedings of the Royal Society B: Biological Sciences</em>, <em>277</em>(1693), 2559–2564. <a href="https://doi.org/10.1098/rspb.2010.0452">https://doi.org/10.1098/rspb.2010.0452</a></p>
</div>
<div id="ref-kruschkeDoingBayesianData2015">
<p>Kruschke, J. K. (2015). <em>Doing Bayesian data analysis: A tutorial with R, JAGS, and Stan</em>. Academic Press. <a href="https://sites.google.com/site/doingbayesiandataanalysis/">https://sites.google.com/site/doingbayesiandataanalysis/</a></p>
</div>
<div id="ref-kurzStatisticalRethinkingBrms2020">
<p>Kurz, A. S. (2020a). <em>Statistical rethinking with brms, ggplot2, and the tidyverse</em> (version 1.1.0). <a href="https://doi.org/10.5281/zenodo.3693202">https://doi.org/10.5281/zenodo.3693202</a></p>
</div>
<div id="ref-kurzDoingBayesianData2020">
<p>Kurz, A. S. (2020b). <em>Doing Bayesian data analysis in brms and the tidyverse</em> (version 0.2.0). <a href="https://bookdown.org/content/3686/">https://bookdown.org/content/3686/</a></p>
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2020">
<p>McElreath, R. (2020a). <em>Statistical rethinking: A Bayesian course with examples in R and Stan</em> (Second edition). CRC Press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a></p>
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2015">
<p>McElreath, R. (2015). <em>Statistical rethinking: A Bayesian course with examples in R and Stan</em>. CRC press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a></p>
</div>
<div id="ref-R-wesanderson">
<p>Ram, K., &amp; Wickham, H. (2018). <em>Wesanderson: A wes anderson palette generator</em> [Manual]. <a href="https://CRAN.R-project.org/package=wesanderson">https://CRAN.R-project.org/package=wesanderson</a></p>
</div>
<div id="ref-silkChimpanzeesAreIndifferent2005">
<p>Silk, J. B., Brosnan, S. F., Vonk, J., Henrich, J., Povinelli, D. J., Richardson, A. S., Lambeth, S. P., Mascaro, J., &amp; Schapiro, S. J. (2005). Chimpanzees are indifferent to the welfare of unrelated group members. <em>Nature</em>, <em>437</em>(7063), 1357–1359. <a href="https://doi.org/10.1038/nature04243">https://doi.org/10.1038/nature04243</a></p>
</div>
<div id="ref-standevelopmentteamStanFunctionsReference2020">
<p>Stan Development Team. (2020b). <em>Stan functions reference</em>. <a href="https://mc-stan.org/docs/2_23/functions-reference/index.html">https://mc-stan.org/docs/2_23/functions-reference/index.html</a></p>
</div>
<div id="ref-standevelopmentteamStanReferenceManual2020">
<p>Stan Development Team. (2020c). <em>Stan reference manual, Version 2.23</em>. <a href="https://mc-stan.org/docs/2_23/reference-manual/">https://mc-stan.org/docs/2_23/reference-manual/</a></p>
</div>
<div id="ref-standevelopmentteamStanUserGuide2020">
<p>Stan Development Team. (2020d). <em>Stan user’s guide, Version 2.23</em>. <a href="https://mc-stan.org/docs/2_23/stan-users-guide/index.html">https://mc-stan.org/docs/2_23/stan-users-guide/index.html</a></p>
</div>
<div id="ref-tufteVisualDisplayQuantitative2001">
<p>Tufte, E. R. (2001). <em>The visual display of quantitative information</em> (2nd edition edition). Graphics Press. <a href="https://www.edwardtufte.com/tufte/books_vdqi">https://www.edwardtufte.com/tufte/books_vdqi</a></p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="big-entropy-and-the-generalized-linear-model.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="monsters-and-mixtures.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
