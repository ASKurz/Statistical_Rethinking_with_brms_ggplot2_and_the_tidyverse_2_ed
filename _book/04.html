<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Geocentric Models – *Statistical rethinking* 2 with brms and the tidyverse</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./05.html" rel="next">
<link href="./03.html" rel="prev">
<link href="./mischa_favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7d082c015fa132ca880f975003d7bf2f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="4&nbsp; Geocentric Models – Statistical rethinking 2 with brms and the tidyverse">
<meta property="og:description" content="">
<meta property="og:image" content="https://solomon.quarto.pub/sr2/04_files/figure-html/unnamed-chunk-3-1.png">
<meta property="og:site_name" content="*Statistical rethinking* 2 with brms and the tidyverse">
<meta property="og:image:height" content="384">
<meta property="og:image:width" content="1228">
</head>

<body class="nav-sidebar floating slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./04.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geocentric Models</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./"><em>Statistical rethinking</em> 2 with brms and the tidyverse</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Golem of Prague</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Small Worlds and Large Worlds</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Sampling the Imaginary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geocentric Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The Many Variables &amp; The Spurious Waffles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The Haunted DAG &amp; The Causal Terror</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Ulysses’ Compass</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Conditional Manatees</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Big Entropy and the Generalized Linear Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">God Spiked the Integers</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Monsters and Mixtures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Models With Memory</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Adventures in Covariance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Missing Data and Other Opportunities</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Generalized Linear Madness</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title"><del>Horoscopes</del> Insights</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#why-normal-distributions-are-normal" id="toc-why-normal-distributions-are-normal" class="nav-link active" data-scroll-target="#why-normal-distributions-are-normal"><span class="header-section-number">4.1</span> Why normal distributions are normal</a>
  <ul>
  <li><a href="#sec-Normal-by-addition" id="toc-sec-Normal-by-addition" class="nav-link" data-scroll-target="#sec-Normal-by-addition"><span class="header-section-number">4.1.1</span> Normal by addition</a></li>
  <li><a href="#normal-by-multiplication" id="toc-normal-by-multiplication" class="nav-link" data-scroll-target="#normal-by-multiplication"><span class="header-section-number">4.1.2</span> Normal by multiplication</a></li>
  <li><a href="#normal-by-log-multiplication" id="toc-normal-by-log-multiplication" class="nav-link" data-scroll-target="#normal-by-log-multiplication"><span class="header-section-number">4.1.3</span> Normal by log-multiplication</a></li>
  <li><a href="#using-gaussian-distributions" id="toc-using-gaussian-distributions" class="nav-link" data-scroll-target="#using-gaussian-distributions"><span class="header-section-number">4.1.4</span> Using Gaussian distributions</a>
  <ul>
  <li><a href="#ontological-justification" id="toc-ontological-justification" class="nav-link" data-scroll-target="#ontological-justification"><span class="header-section-number">4.1.4.1</span> Ontological justification</a></li>
  <li><a href="#epistemological-justification" id="toc-epistemological-justification" class="nav-link" data-scroll-target="#epistemological-justification"><span class="header-section-number">4.1.4.2</span> Epistemological justification</a></li>
  <li><a href="#rethinking-heavy-tails" id="toc-rethinking-heavy-tails" class="nav-link" data-scroll-target="#rethinking-heavy-tails"><span class="header-section-number">4.1.4.3</span> Rethinking: Heavy tails</a></li>
  <li><a href="#overthinking-gaussian-distribution" id="toc-overthinking-gaussian-distribution" class="nav-link" data-scroll-target="#overthinking-gaussian-distribution"><span class="header-section-number">4.1.4.4</span> Overthinking: Gaussian distribution</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#a-language-for-describing-models" id="toc-a-language-for-describing-models" class="nav-link" data-scroll-target="#a-language-for-describing-models"><span class="header-section-number">4.2</span> A language for describing models</a>
  <ul>
  <li><a href="#re-describing-the-globe-tossing-model" id="toc-re-describing-the-globe-tossing-model" class="nav-link" data-scroll-target="#re-describing-the-globe-tossing-model"><span class="header-section-number">4.2.1</span> Re-describing the globe tossing model</a>
  <ul>
  <li><a href="#overthinking-from-model-definition-to-bayes-theorem" id="toc-overthinking-from-model-definition-to-bayes-theorem" class="nav-link" data-scroll-target="#overthinking-from-model-definition-to-bayes-theorem"><span class="header-section-number">4.2.1.1</span> Overthinking: From model definition to Bayes’ theorem</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#a-gaussian-model-of-height" id="toc-a-gaussian-model-of-height" class="nav-link" data-scroll-target="#a-gaussian-model-of-height"><span class="header-section-number">4.3</span> A Gaussian model of height</a>
  <ul>
  <li><a href="#the-data" id="toc-the-data" class="nav-link" data-scroll-target="#the-data"><span class="header-section-number">4.3.1</span> The data</a>
  <ul>
  <li><a href="#overthinking-data-frames-and-indexes" id="toc-overthinking-data-frames-and-indexes" class="nav-link" data-scroll-target="#overthinking-data-frames-and-indexes"><span class="header-section-number">4.3.1.1</span> Overthinking: Data frames and indexes</a></li>
  </ul></li>
  <li><a href="#the-model" id="toc-the-model" class="nav-link" data-scroll-target="#the-model"><span class="header-section-number">4.3.2</span> The model</a>
  <ul>
  <li><a href="#rethinking-a-farewell-to-epsilon" id="toc-rethinking-a-farewell-to-epsilon" class="nav-link" data-scroll-target="#rethinking-a-farewell-to-epsilon"><span class="header-section-number">4.3.2.1</span> Rethinking: A farewell to epsilon</a></li>
  </ul></li>
  <li><a href="#grid-approximation-of-the-posterior-distribution" id="toc-grid-approximation-of-the-posterior-distribution" class="nav-link" data-scroll-target="#grid-approximation-of-the-posterior-distribution"><span class="header-section-number">4.3.3</span> Grid approximation of the posterior distribution</a></li>
  <li><a href="#sampling-from-the-posterior" id="toc-sampling-from-the-posterior" class="nav-link" data-scroll-target="#sampling-from-the-posterior"><span class="header-section-number">4.3.4</span> Sampling from the posterior</a>
  <ul>
  <li><a href="#overthinking-sample-size-and-the-normality-of-sigmas-posterior" id="toc-overthinking-sample-size-and-the-normality-of-sigmas-posterior" class="nav-link" data-scroll-target="#overthinking-sample-size-and-the-normality-of-sigmas-posterior"><span class="header-section-number">4.3.4.1</span> Overthinking: Sample size and the normality of <span class="math inline">\(\sigma\)</span>’s posterior</a></li>
  </ul></li>
  <li><a href="#finding-the-posterior-distribution-with-quap-brm" id="toc-finding-the-posterior-distribution-with-quap-brm" class="nav-link" data-scroll-target="#finding-the-posterior-distribution-with-quap-brm"><span class="header-section-number">4.3.5</span> Finding the posterior distribution with <del><code>quap</code></del> <code>brm()</code></a></li>
  <li><a href="#sampling-from-a-quap-brm-fit" id="toc-sampling-from-a-quap-brm-fit" class="nav-link" data-scroll-target="#sampling-from-a-quap-brm-fit"><span class="header-section-number">4.3.6</span> Sampling from a <del><code>quap()</code></del> <code>brm()</code> fit</a>
  <ul>
  <li><a href="#overthinking-start-values-for-quap-brm" id="toc-overthinking-start-values-for-quap-brm" class="nav-link" data-scroll-target="#overthinking-start-values-for-quap-brm"><span class="header-section-number">4.3.6.1</span> Overthinking: Start values for <del><code>quap()</code></del> <code>brm()</code></a></li>
  <li><a href="#overthinking-under-the-hood-with-multivariate-sampling" id="toc-overthinking-under-the-hood-with-multivariate-sampling" class="nav-link" data-scroll-target="#overthinking-under-the-hood-with-multivariate-sampling"><span class="header-section-number">4.3.6.2</span> Overthinking: Under the hood with multivariate sampling</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#linear-prediction" id="toc-linear-prediction" class="nav-link" data-scroll-target="#linear-prediction"><span class="header-section-number">4.4</span> Linear prediction</a>
  <ul>
  <li><a href="#the-linear-model-strategy" id="toc-the-linear-model-strategy" class="nav-link" data-scroll-target="#the-linear-model-strategy"><span class="header-section-number">4.4.1</span> The linear model strategy</a>
  <ul>
  <li><a href="#probability-of-the-data" id="toc-probability-of-the-data" class="nav-link" data-scroll-target="#probability-of-the-data"><span class="header-section-number">4.4.1.1</span> Probability of the data</a></li>
  <li><a href="#linear-model" id="toc-linear-model" class="nav-link" data-scroll-target="#linear-model"><span class="header-section-number">4.4.1.2</span> Linear model</a>
  <ul class="collapse">
  <li><a href="#rethinking-nothing-special-or-natural-about-linear-models" id="toc-rethinking-nothing-special-or-natural-about-linear-models" class="nav-link" data-scroll-target="#rethinking-nothing-special-or-natural-about-linear-models"><span class="header-section-number">4.4.1.2.1</span> Rethinking: Nothing special or natural about linear models</a></li>
  </ul></li>
  <li><a href="#priors" id="toc-priors" class="nav-link" data-scroll-target="#priors"><span class="header-section-number">4.4.1.3</span> Priors</a>
  <ul class="collapse">
  <li><a href="#rethinking-whats-the-correct-prior" id="toc-rethinking-whats-the-correct-prior" class="nav-link" data-scroll-target="#rethinking-whats-the-correct-prior"><span class="header-section-number">4.4.1.3.1</span> Rethinking: What’s the correct prior?</a></li>
  <li><a href="#rethinking-prior-predictive-simulation-and-p-hacking" id="toc-rethinking-prior-predictive-simulation-and-p-hacking" class="nav-link" data-scroll-target="#rethinking-prior-predictive-simulation-and-p-hacking"><span class="header-section-number">4.4.1.3.2</span> Rethinking: Prior predictive simulation and <span class="math inline">\(p\)</span>-hacking</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#finding-the-posterior-distribution" id="toc-finding-the-posterior-distribution" class="nav-link" data-scroll-target="#finding-the-posterior-distribution"><span class="header-section-number">4.4.2</span> Finding the posterior distribution</a>
  <ul>
  <li><a href="#sec-Overthinking-Logs-and-exps" id="toc-sec-Overthinking-Logs-and-exps" class="nav-link" data-scroll-target="#sec-Overthinking-Logs-and-exps"><span class="header-section-number">4.4.2.1</span> Overthinking: Logs and exps, oh my</a></li>
  </ul></li>
  <li><a href="#interpreting-the-posterior-distribution" id="toc-interpreting-the-posterior-distribution" class="nav-link" data-scroll-target="#interpreting-the-posterior-distribution"><span class="header-section-number">4.4.3</span> Interpreting the posterior distribution</a>
  <ul>
  <li><a href="#rethinking-what-do-parameters-mean" id="toc-rethinking-what-do-parameters-mean" class="nav-link" data-scroll-target="#rethinking-what-do-parameters-mean"><span class="header-section-number">4.4.3.0.1</span> Rethinking: What do parameters mean?</a></li>
  <li><a href="#tables-of-marginal-distributions" id="toc-tables-of-marginal-distributions" class="nav-link" data-scroll-target="#tables-of-marginal-distributions"><span class="header-section-number">4.4.3.1</span> Tables of marginal distributions</a></li>
  <li><a href="#plotting-posterior-inference-against-the-data" id="toc-plotting-posterior-inference-against-the-data" class="nav-link" data-scroll-target="#plotting-posterior-inference-against-the-data"><span class="header-section-number">4.4.3.2</span> Plotting posterior inference against the data</a></li>
  <li><a href="#adding-uncertainty-around-the-mean" id="toc-adding-uncertainty-around-the-mean" class="nav-link" data-scroll-target="#adding-uncertainty-around-the-mean"><span class="header-section-number">4.4.3.3</span> Adding uncertainty around the mean</a></li>
  <li><a href="#plotting-regression-intervals-and-contours" id="toc-plotting-regression-intervals-and-contours" class="nav-link" data-scroll-target="#plotting-regression-intervals-and-contours"><span class="header-section-number">4.4.3.4</span> Plotting regression intervals and contours</a>
  <ul class="collapse">
  <li><a href="#rethinking-overconfident-intervals" id="toc-rethinking-overconfident-intervals" class="nav-link" data-scroll-target="#rethinking-overconfident-intervals"><span class="header-section-number">4.4.3.4.1</span> Rethinking: Overconfident intervals</a></li>
  <li><a href="#overthinking-how-link-fitted-works" id="toc-overthinking-how-link-fitted-works" class="nav-link" data-scroll-target="#overthinking-how-link-fitted-works"><span class="header-section-number">4.4.3.4.2</span> Overthinking: How <del>link</del> <code>fitted()</code> works</a></li>
  </ul></li>
  <li><a href="#sec-Prediction-intervals" id="toc-sec-Prediction-intervals" class="nav-link" data-scroll-target="#sec-Prediction-intervals"><span class="header-section-number">4.4.3.5</span> Prediction intervals</a>
  <ul class="collapse">
  <li><a href="#overthinking-rolling-your-own-sim-predict" id="toc-overthinking-rolling-your-own-sim-predict" class="nav-link" data-scroll-target="#overthinking-rolling-your-own-sim-predict"><span class="header-section-number">4.4.3.5.1</span> Overthinking: Rolling your own <del>sim</del> <code>predict()</code></a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  <li><a href="#curves-from-lines" id="toc-curves-from-lines" class="nav-link" data-scroll-target="#curves-from-lines"><span class="header-section-number">4.5</span> Curves from lines</a>
  <ul>
  <li><a href="#sec-Polynomial-regression" id="toc-sec-Polynomial-regression" class="nav-link" data-scroll-target="#sec-Polynomial-regression"><span class="header-section-number">4.5.1</span> Polynomial regression</a>
  <ul>
  <li><a href="#sec-Converting-back-to-natural-scale" id="toc-sec-Converting-back-to-natural-scale" class="nav-link" data-scroll-target="#sec-Converting-back-to-natural-scale"><span class="header-section-number">4.5.1.0.1</span> Overthinking: Converting back to natural scale</a></li>
  </ul></li>
  <li><a href="#sec-Splines" id="toc-sec-Splines" class="nav-link" data-scroll-target="#sec-Splines"><span class="header-section-number">4.5.2</span> Splines</a></li>
  <li><a href="#smooth-functions-for-a-rough-world" id="toc-smooth-functions-for-a-rough-world" class="nav-link" data-scroll-target="#smooth-functions-for-a-rough-world"><span class="header-section-number">4.5.3</span> Smooth functions for a rough world</a></li>
  </ul></li>
  <li><a href="#sec-smooth-functions-with-s" id="toc-sec-smooth-functions-with-s" class="nav-link" data-scroll-target="#sec-smooth-functions-with-s"><span class="header-section-number">4.6</span> <del>Summary</del> First bonus: Smooth functions with <code>brms::s()</code></a></li>
  <li><a href="#sec-Group-predictors-with-matrix-columns" id="toc-sec-Group-predictors-with-matrix-columns" class="nav-link" data-scroll-target="#sec-Group-predictors-with-matrix-columns"><span class="header-section-number">4.7</span> Second bonus: Group predictors with matrix columns</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  <li><a href="#comments" id="toc-comments" class="nav-link" data-scroll-target="#comments">Comments</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-Geocentric-Models" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geocentric Models</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<p><strong>Linear regression</strong> is the geocentric model of applied statistics. By “linear regression,” we will mean a family of simple statistical golems that attempt to learn about the mean and variance of some measurement, using an additive combination of other measurements. Like geocentrism, linear regression can usefully describe a very large variety of natural phenomena. Like geocentrism, linear regression is a descriptive model that corresponds to many different process models. If we read its structure too literally, we’re likely to make mistakes. But used wisely, these little linear golems continue to be useful. <span class="citation" data-cites="mcelreathStatisticalRethinkingBayesian2020">(<a href="references.html#ref-mcelreathStatisticalRethinkingBayesian2020" role="doc-biblioref">McElreath, 2020b, p. 71</a>, <strong>emphasis</strong>, in the original)</span></p>
</blockquote>
<section id="why-normal-distributions-are-normal" class="level2 page-columns page-full" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="why-normal-distributions-are-normal"><span class="header-section-number">4.1</span> Why normal distributions are normal</h2>
<p>After laying out his soccer field coin toss shuffle premise, McElreath wrote:</p>
<blockquote class="blockquote">
<p>It’s hard to say where any individual person will end up, but you can say with great confidence what the collection of positions will be. The distances will be distributed in approximately normal, or Gaussian, fashion. This is true even though the underlying distribution is binomial. It does this because there are so many more possible ways to realize a sequence of left-right steps that sums to zero. There are slightly fewer ways to realize a sequence that ends up one step left or right of zero, and so on, with the number of possible sequences declining in the characteristic bell curve of the normal distribution. (p.&nbsp;72)</p>
</blockquote>
<section id="sec-Normal-by-addition" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="sec-Normal-by-addition"><span class="header-section-number">4.1.1</span> Normal by addition</h3>
<p>Here’s a way to do the simulation necessary for the plot in the top panel of Figure 4.2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We set the seed to make the results of `runif()` reproducible.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Make data with 100 people, 16 steps each with a starting point of `step == 0` (17 rows per person)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>pos <span class="ot">&lt;-</span> <span class="fu">crossing</span>(<span class="at">person =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">step   =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">16</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate a `deviation` when `step &gt; 0`</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">deviation =</span> <span class="fu">map_dbl</span>(<span class="at">.x =</span> step, <span class="at">.f =</span> \(step) <span class="fu">if_else</span>(step <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">min =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">max =</span> <span class="dv">1</span>)))) <span class="sc">|&gt;</span> </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># After grouping by `person`, compute the cumulative sum of the deviations, then `ungroup()`</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(person) <span class="sc">|&gt;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">position =</span> <span class="fu">cumsum</span>(deviation)) <span class="sc">|&gt;</span> </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That <code>map_dbl()</code> code within the first <code>mutate()</code> line might look odd. Go <a href="https://purrr.tidyverse.org/reference/map.html">here</a> to learn more about iterating with <code>purrr::map_dbl()</code>.</p>
<p>We might <code>glimpse()</code> at the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(pos)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,700
Columns: 4
$ person    &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3,…
$ step      &lt;int&gt; 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15…
$ deviation &lt;dbl&gt; 0.00000000, -0.98210841, -0.41252078, -0.44525008, 0.62714843, -0.47914446, 0.44881179, 0.81218430, 0.89808044…
$ position  &lt;dbl&gt; 0.0000000, -0.9821084, -1.3946292, -1.8398793, -1.2127308, -1.6918753, -1.2430635, -0.4308792, 0.4672012, -0.3…</code></pre>
</div>
</div>
<p>Here’s the code to make the top panel of Figure 4.2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> pos, </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> step, <span class="at">y =</span> position, <span class="at">group =</span> person)) <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">16</span>), <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> person <span class="sc">&lt;</span> <span class="dv">2</span>, <span class="at">alpha  =</span> person <span class="sc">&lt;</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"step number"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">4</span> <span class="sc">*</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"skyblue4"</span>, <span class="st">"black"</span>)) <span class="sc">+</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">5</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="614"></p>
</figure>
</div>
</div>
</div>
<p>Here’s the code for the bottom three plots of Figure 4.2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Figure 4.2.a.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> pos <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(step <span class="sc">==</span> <span class="dv">4</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> position)) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">stat =</span> <span class="st">"density"</span>, <span class="at">color =</span> <span class="st">"dodgerblue1"</span>) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="st">"4 steps"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Figure 4.2.b.</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> pos <span class="sc">|&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(step <span class="sc">==</span> <span class="dv">8</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> position)) <span class="sc">+</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">color =</span> <span class="st">"dodgerblue2"</span>, <span class="at">outline.type =</span> <span class="st">"full"</span>) <span class="sc">+</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="st">"8 steps"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># This is an intermediary step to get an SD value</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>sd <span class="ot">&lt;-</span> pos <span class="sc">|&gt;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(step <span class="sc">==</span> <span class="dv">16</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">sd =</span> <span class="fu">sd</span>(position)) <span class="sc">|&gt;</span> </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(sd)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Figure 4.2.c.</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> pos <span class="sc">|&gt;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(step <span class="sc">==</span> <span class="dv">16</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> position)) <span class="sc">+</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm, </span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sd),</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">color =</span> <span class="st">"transparent"</span>, <span class="at">fill =</span> <span class="st">"dodgerblue3"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"density"</span>) <span class="sc">+</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="st">"16 steps"</span>)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the ggplots</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">|</span> p2 <span class="sc">|</span> p3) <span class="sc">&amp;</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="dv">6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>While we were at it, we explored a few ways to express densities. The main action was with the <code>geom_line()</code>, <code>geom_density()</code>, and <code>stat_function()</code> functions, respectively.</p>
<blockquote class="blockquote">
<p>Any process that adds together random values from the same distribution converges to a normal. But it’s not easy to grasp why addition should result in a bell curve of sums. Here’s a conceptual way to think of the process. Whatever the average value of the source distribution, each sample from it can be thought of as a fluctuation from that average value. When we begin to add these fluctuations together, they also begin to cancel one another out. A large positive fluctuation will cancel a large negative one. (p.&nbsp;73)</p>
</blockquote>
</section>
<section id="normal-by-multiplication" class="level3 page-columns page-full" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="normal-by-multiplication"><span class="header-section-number">4.1.2</span> Normal by multiplication</h3>
<p>Here’s McElreath’s simple random growth rate.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">runif</span>(<span class="dv">12</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.774719</code></pre>
</div>
</div>
<p>In the <code>runif()</code> part of that code, we generated 12 random draws from the uniform distribution with bounds <span class="math inline">\([0, 0.1]\)</span>. Within the <code>prod()</code> function, we first added <code>1</code> to each of those values, and then computed their product. Consider a more explicit variant of the code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">a =</span> <span class="dv">1</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">b =</span> <span class="fu">runif</span>(<span class="dv">12</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fl">0.1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">c =</span> a <span class="sc">+</span> b) <span class="sc">|&gt;</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">p =</span> <span class="fu">prod</span>(c))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
      p
  &lt;dbl&gt;
1  1.77</code></pre>
</div>
</div>
<p>Same result. Rather than using base <strong>R</strong> <code>replicate()</code> to do this many times, let’s practice with <code>purrr::map_dbl()</code> like before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many iterations?</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>n_iter <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">iteration =</span> <span class="dv">1</span><span class="sc">:</span>n_iter) <span class="sc">|&gt;</span> </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">growth =</span> <span class="fu">map_dbl</span>(<span class="at">.x =</span> iteration, <span class="at">.f =</span> <span class="cf">function</span>(x) {</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(x)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">12</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fl">0.1</span>))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 10,000
Columns: 2
$ iteration &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30,…
$ growth    &lt;dbl&gt; 1.769489, 1.837733, 1.715074, 1.774719, 1.797436, 2.125435, 1.615300, 1.850101, 1.446821, 1.637938, 1.448587, …</code></pre>
</div>
</div>
<p>This time we used the <code>iteration</code> column in two ways. It’s first function was as a simple row index, which in this context might seem like overkill. However, it’s second function was the value we serially fed into the <code>set.seed()</code> function within <code>map_dbl()</code>. This might also be overkill for such a simple example, but it’s a nice strategy to have in your skillset for when you move on to more complicated simulations. I use it all the time.</p>
<p>As to the <code>growth</code> column, when we first used <code>map_dbl()</code> in <a href="#sec-Normal-by-addition" class="quarto-xref"><span>Section 4.1.1</span></a>, we defined a custom anonomous function on the fly with the syntax of <code>.f = \(x) some_function(x)</code>. In that syntax, the <code>\()</code> portion was a shorthand for the <code>function()</code> function. The <code>\()</code> shortand is generally preferred when defining a simple one-line function. However, it’s generally a good idea to use the more explicit syntax of <code>function() { my() |&gt; complicated_function() }</code> for longer multi-line functions. In our case directly above, we specified <code>set.seed(x)</code> in the first line of the anonomous function, and then <code>prod(1 + runif(n = 12, min = 0, max = 0.1))</code> in the second line. Thus the more explicit <code>function()</code> syntax was preferred.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> Now we plot the results of our handiwork.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;See <a href="https://style.tidyverse.org/functions.html#anonymous-functions">here</a>.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> growth)) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">color =</span> <span class="st">"transparent"</span>, <span class="at">fill =</span> <span class="st">"dodgerblue3"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> <span class="fu">mean</span>(d<span class="sc">$</span>growth), <span class="at">sd =</span> <span class="fu">sd</span>(d<span class="sc">$</span>growth)),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">linetype =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="312"></p>
</figure>
</div>
</div>
</div>
<p>The <code>stat_function()</code> portion of our code accomplished what McElreath did with <code>dens(norm.comp = TRUE)</code>.</p>
<p>Before we move on, we could have also accomplished our simulation with much simpler tidyverse-style code like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">growth =</span> <span class="fu">map_dbl</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>, <span class="sc">~</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">runif</span>(<span class="dv">12</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fl">0.1</span>))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The reason I show the more verbose workflow was to make the simulation steps more explicit, and to give newer programers some of the skills they might want for later.</p>
<p>Returning to the text: “The smaller the effect of each locus, the better this additive approximation will be” (p.&nbsp;74). Let’s compare big and small. Rather tham making two free-floating vectors, <code>big</code> and <code>small</code>, like McElreath’s R code 4.4, we’ll see how to generalize our approach from <code>map_dbl()</code> above to <code>map2_dbl()</code>, all within a single data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">size =</span> <span class="fu">c</span>(<span class="st">"big"</span>, <span class="st">"small"</span>),</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">max =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.01</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">iteration =</span> <span class="dv">1</span><span class="sc">:</span>n_iter) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">growth =</span> <span class="fu">map2_dbl</span>(<span class="at">.x =</span> iteration, <span class="at">.y =</span> max, <span class="at">.f =</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(x)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">12</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> y))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  })) </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 20,000
Columns: 4
$ size      &lt;chr&gt; "big", "big", "big", "big", "big", "big", "big", "big", "big", "big", "big", "big", "big", "big", "big", "big"…
$ max       &lt;dbl&gt; 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, …
$ iteration &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30,…
$ growth    &lt;dbl&gt; 12.775203, 15.121361, 11.631403, 12.843077, 13.700677, 27.489340, 8.616126, 15.731934, 5.386494, 9.578998, 5.3…</code></pre>
</div>
</div>
<p>Now we can display the simulations in a faceted plot like so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> growth)) <span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"dodgerblue3"</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> size, <span class="at">scales =</span> <span class="st">"free"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Yep, the <code>small</code> samples were more Gaussian. “The interacting growth deviations, as long as they are sufficiently small, converge to a Gaussian distribution. In this way, the range of causal forces that tend towards Gaussian distributions extends well beyond purely additive interactions” (p.&nbsp;74).</p>
</section>
<section id="normal-by-log-multiplication" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="normal-by-log-multiplication"><span class="header-section-number">4.1.3</span> Normal by log-multiplication</h3>
<p>Since we saved the <code>big</code> and <code>small</code> versions of the last simulations in the same data frame, we use <code>filter()</code> to isolate the <code>big</code> ones.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(size <span class="sc">==</span> <span class="st">"big"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(growth))) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"gray33"</span>) <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">'the log of the "big" growth'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="312"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>Yet another Gaussian distribution. We get the Gaussian distribution back, because adding logs is equivalent to multiplying the original numbers. So even multiplicative interactions of large deviations can produce Gaussian distributions, once we measure the outcomes on the log scale. (p.&nbsp;75)</p>
</blockquote>
</section>
<section id="using-gaussian-distributions" class="level3" data-number="4.1.4">
<h3 data-number="4.1.4" class="anchored" data-anchor-id="using-gaussian-distributions"><span class="header-section-number">4.1.4</span> Using Gaussian distributions</h3>
<p>“The justifications for using the Gaussian distribution fall into two broad categories: (1) ontological and (2) epistemological” (p.&nbsp;75). I’m a fan of the justifications to follow.</p>
<section id="ontological-justification" class="level4" data-number="4.1.4.1">
<h4 data-number="4.1.4.1" class="anchored" data-anchor-id="ontological-justification"><span class="header-section-number">4.1.4.1</span> Ontological justification</h4>
<p>The Gaussian is</p>
<blockquote class="blockquote">
<p>a widespread pattern, appearing again and again at different scales and in different domains. Measurement errors, variations in growth, and the velocities of molecules all tend towards Gaussian distributions. These processes do this because at their heart, these processes add together fluctuations. And repeatedly adding finite fluctuations results in a distribution of sums that have shed all information about the underlying process, aside from mean and spread.</p>
<p>[However,] one consequence of this is that statistical models based on Gaussian distributions cannot reliably identify micro-process. (p.&nbsp;75)</p>
</blockquote>
<p>But like Ptolemy’s circles within circles, the Gaussian can still be useful even if it sheds information.</p>
</section>
<section id="epistemological-justification" class="level4" data-number="4.1.4.2">
<h4 data-number="4.1.4.2" class="anchored" data-anchor-id="epistemological-justification"><span class="header-section-number">4.1.4.2</span> Epistemological justification</h4>
<blockquote class="blockquote">
<p>By the epistemological justification, the Gaussian represents a particular state of ignorance. When all we know or are willing to say about a distribution of measures (measures are continuous values on the real number line) is their mean and variance, then the Gaussian distribution arises as the most consistent with our assumptions.</p>
<p>That is to say that the Gaussian distribution is the most natural expression of our state of ignorance, because if all we are willing to assume is that a measure has finite variance, the Gaussian distribution is the shape that can be realized in the largest number of ways and does not introduce any new assumptions. It is the least surprising and least informative assumption to make. In this way, the Gaussian is the distribution most consistent with our assumptions. Or rather, it is the most consistent with our golem’s assumptions. If you don’t think the distribution should be Gaussian, then that implies that you know something else that you should tell your golem about, something that would improve inference. (p.&nbsp;75)</p>
</blockquote>
<p>We’ll dive deeper into why the Gaussian is such a natural expression of ignorance in these contexts when we cover maximum entropy in <a href="07.html" class="quarto-xref"><span>Chapter 7</span></a>.</p>
</section>
<section id="rethinking-heavy-tails" class="level4" data-number="4.1.4.3">
<h4 data-number="4.1.4.3" class="anchored" data-anchor-id="rethinking-heavy-tails"><span class="header-section-number">4.1.4.3</span> Rethinking: Heavy tails</h4>
<blockquote class="blockquote">
<p>The Gaussian distribution is common in nature and has some nice properties. But there are some risks in using it as a default data model. The extreme ends of a distribution are known as its tails. And the Gaussian distribution has some very thin tails–there is very little probability in them. Instead most of the mass in the Gaussian lies within one standard deviation of the mean. Many natural (and unnatural) processes have much heavier tails. (p.&nbsp;76)</p>
</blockquote>
<p>You have no idea how excited I am that we’ll be covering some of these heavy-tailed alternatives!</p>
</section>
<section id="overthinking-gaussian-distribution" class="level4" data-number="4.1.4.4">
<h4 data-number="4.1.4.4" class="anchored" data-anchor-id="overthinking-gaussian-distribution"><span class="header-section-number">4.1.4.4</span> Overthinking: Gaussian distribution</h4>
<p>In this section McElreath gave the formula for the Gaussian probability density function. Let <span class="math inline">\(y\)</span> be the criterion, <span class="math inline">\(\mu\)</span> be the mean, and <span class="math inline">\(\sigma\)</span> be the standard deviation. Then the probability density of some Gaussian value <span class="math inline">\(y\)</span> is</p>
<p><span class="math display">\[p(y \mid \mu, \sigma) = \frac{1}{\sqrt{2 \pi \sigma^2}} \exp \left (- \frac{(y - \mu)^2}{2 \sigma^2} \right).\]</span></p>
<p>McElreath’s right. “This looks monstrous” (p.&nbsp;76). Why not demystify that monster with a little <strong>R</strong> code? For simplicity, we’ll compute <span class="math inline">\(p(y \mid \mu, \sigma)\)</span> for a series of <span class="math inline">\(y\)</span>-values ranging from -1 to 1, holding <span class="math inline">\(\mu = 0\)</span> and <span class="math inline">\(\sigma = 0.1\)</span>. Then we’ll plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">y     =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.01</span>),</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">mu    =</span> <span class="dv">0</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">sigma =</span> <span class="fl">0.1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute p(y) with a hand-made Gaussian probability density function</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> sigma<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>((y <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> sigma<span class="sc">^</span><span class="dv">2</span>)))) <span class="sc">|&gt;</span> </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> y, <span class="at">y =</span> p)) <span class="sc">+</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">expression</span>(<span class="fu">italic</span>(p)(<span class="fu">italic</span>(<span class="st">"y | "</span>)<span class="sc">*</span>mu<span class="sc">==</span><span class="dv">0</span><span class="sc">*</span><span class="st">","</span><span class="sc">~</span>sigma<span class="sc">==</span><span class="fl">0.1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>Notice how <span class="math inline">\(p(y \mid \mu, \sigma)\)</span> peaks around 4 when <span class="math inline">\(y = 0\)</span>. We can also get that value with the <code>dnorm()</code> function, which will return the <span class="math inline">\(p(y)\)</span> value for a given combination of <span class="math inline">\(y\)</span>, <span class="math inline">\(\mu\)</span>, and <span class="math inline">\(\sigma\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.989423</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>The answer, about 4, is no mistake. Probability <em>density</em> is the rate of change in cumulative probability. So where cumulative probability is increasing rapidly, density can easily exceed 1. But if we calculate the area under the density function, it will never exceed 1. Such areas are also called probability mass. You can usually ignore these density/mass details while doing computational work. But it’s good to be aware of the distinction. (p.&nbsp;76, <em>emphasis</em> in the original)</p>
</blockquote>
</section>
</section>
</section>
<section id="a-language-for-describing-models" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="a-language-for-describing-models"><span class="header-section-number">4.2</span> A language for describing models</h2>
<p>Our mathy ways of summarizing models will be something like</p>
<p><span class="math display">\[\begin{align*}
\text{criterion}_i &amp; \sim \operatorname{Normal}(\mu_i, \sigma) \\
\mu_i  &amp; = \beta \times \text{predictor}_i \\
\beta  &amp; \sim \operatorname{Normal}(0, 10) \\
\sigma &amp; \sim \operatorname{Exponential}(1) \\
x_i    &amp; \sim \operatorname{Normal}(0, 1).
\end{align*}\]</span></p>
<p>“If that doesn’t make much sense, good. That indicates that you are holding the right textbook” (p.&nbsp;77). Welcome applied statistics! 🤓</p>
<section id="re-describing-the-globe-tossing-model" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="re-describing-the-globe-tossing-model"><span class="header-section-number">4.2.1</span> Re-describing the globe tossing model</h3>
<p>For the globe tossing model, the probability <span class="math inline">\(p\)</span> of a count of water <span class="math inline">\(w\)</span> based on <span class="math inline">\(n\)</span> trials was</p>
<p><span class="math display">\[\begin{align*}
w &amp; \sim \operatorname{Binomial}(n, p) \\
p &amp; \sim \operatorname{Uniform}(0, 1),
\end{align*}\]</span></p>
<p>where the top line indicates we’re using the Binomial likelihood function to model <span class="math inline">\(w\)</span> given unique combinations of <span class="math inline">\(n\)</span> and <span class="math inline">\(p\)</span>. In our example, <span class="math inline">\(w\)</span> and <span class="math inline">\(n\)</span> were already defined in the data, so all we need to do is compute <span class="math inline">\(p\)</span>. Since <span class="math inline">\(p\)</span> is the only parameter, it’s the only element that gets a prior, which is what that second line was.</p>
<section id="overthinking-from-model-definition-to-bayes-theorem" class="level4" data-number="4.2.1.1">
<h4 data-number="4.2.1.1" class="anchored" data-anchor-id="overthinking-from-model-definition-to-bayes-theorem"><span class="header-section-number">4.2.1.1</span> Overthinking: From model definition to Bayes’ theorem</h4>
<p>We can use grid approximation to work through our globe tossing model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many `p_grid` points would you like?</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>n_points <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">p_grid =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">length.out =</span> n_points),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">w =</span> <span class="dv">6</span>, </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">n =</span> <span class="dv">9</span>) <span class="sc">|&gt;</span> </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior      =</span> <span class="fu">dunif</span>(p_grid, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>),</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">likelihood =</span> <span class="fu">dbinom</span>(w, <span class="at">size =</span> n, <span class="at">prob =</span> p_grid)) <span class="sc">|&gt;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">posterior =</span> likelihood <span class="sc">*</span> prior <span class="sc">/</span> <span class="fu">sum</span>(likelihood <span class="sc">*</span> prior))</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  p_grid     w     n prior likelihood posterior
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;
1 0          6     9     1   0         0       
2 0.0101     6     9     1   8.65e-11  8.74e-12
3 0.0202     6     9     1   5.37e- 9  5.43e-10
4 0.0303     6     9     1   5.93e- 8  5.99e- 9
5 0.0404     6     9     1   3.23e- 7  3.26e- 8
6 0.0505     6     9     1   1.19e- 6  1.21e- 7</code></pre>
</div>
</div>
<p>In case you were curious, here’s what they look like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(prior<span class="sc">:</span>posterior) <span class="sc">|&gt;</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This line allows us to dictate the order in which the panels will appear</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">factor</span>(name, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"likelihood"</span>, <span class="st">"posterior"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> p_grid, <span class="at">y =</span> value, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"purple"</span>)) <span class="sc">+</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>The posterior is a combination of the prior and the likelihood. When the prior is flat across the parameter space, the posterior is just the likelihood re-expressed as a probability. As we go along, you’ll see we almost never use flat priors in practice. Be warned that eschewing flat priors is a recent development, however. You only have to look at the literature from a couple decades ago to see mounds and mounds of flat priors.</p>
</section>
</section>
</section>
<section id="a-gaussian-model-of-height" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="a-gaussian-model-of-height"><span class="header-section-number">4.3</span> A Gaussian model of height</h2>
<blockquote class="blockquote">
<p>There are an infinite number of possible Gaussian distributions. Some have small means. Others have large means. Some are wide, with a large <span class="math inline">\(\sigma\)</span>. Others are narrow. We want our Bayesian machine to consider every possible distribution, each defined by a combination of <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>, and rank them by posterior plausibility. Posterior plausibility provides a measure of the logical compatibility of each possible distribution with the data and model. (p.&nbsp;79)</p>
</blockquote>
<section id="the-data" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="the-data"><span class="header-section-number">4.3.1</span> The data</h3>
<p>Let’s load the Howell <span class="citation" data-cites="howell2001demography howell2010life">(<a href="references.html#ref-howell2001demography" role="doc-biblioref">2001</a>, <a href="references.html#ref-howell2010life" role="doc-biblioref">2010</a>)</span> data from McElreath’s <span class="citation" data-cites="R-rethinking">(<a href="references.html#ref-R-rethinking" role="doc-biblioref">2020a</a>)</span> <a href="https://xcelab.net/rm/software/"><strong>rethinking</strong> package</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rethinking)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'cmdstanr' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'posterior' was built under R version 4.5.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Howell1)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> Howell1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we open our focal statistical package, Bürkner’s <a href="https://github.com/paul-buerkner/brms"><strong>brms</strong></a>. But before we do, we’ll want to detach the <strong>rethinking</strong> package. <strong>R</strong> will not allow us to use a function from one package that shares the same name as a different function from another package if both packages are open at the same time. The <strong>rethinking</strong> and <strong>brms</strong> packages are designed for similar purposes and, unsurprisingly, overlap in some of their function names. To prevent problems, we will always make sure <strong>rethinking</strong> is detached before using <strong>brms</strong>. To learn more on the topic, see <a href="https://www.r-bloggers.com/2015/04/r-and-package-masking-a-real-life-example/">this R-bloggers post</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(Howell1)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">detach</span>(package<span class="sc">:</span>rethinking, <span class="at">unload =</span> T)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Go ahead and investigate the data with <code>str()</code>, the <strong>tidyverse</strong> analogue for which is <code>glimpse()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   544 obs. of  4 variables:
 $ height: num  152 140 137 157 145 ...
 $ weight: num  47.8 36.5 31.9 53 41.3 ...
 $ age   : num  63 63 65 41 51 35 32 27 19 54 ...
 $ male  : int  1 0 0 1 0 1 0 1 0 1 ...</code></pre>
</div>
</div>
<p>The <strong>brms</strong> package does not have a function that works like <code>rethinking::precis()</code> for providing numeric and graphical summaries of variables, as see in McElreath’s <strong>R</strong> code 4.9. We can get some of that information with <code>summary()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     height           weight            age             male       
 Min.   : 53.98   Min.   : 4.252   Min.   : 0.00   Min.   :0.0000  
 1st Qu.:125.09   1st Qu.:22.008   1st Qu.:12.00   1st Qu.:0.0000  
 Median :148.59   Median :40.058   Median :27.00   Median :0.0000  
 Mean   :138.26   Mean   :35.611   Mean   :29.34   Mean   :0.4724  
 3rd Qu.:157.48   3rd Qu.:47.209   3rd Qu.:43.00   3rd Qu.:1.0000  
 Max.   :179.07   Max.   :62.993   Max.   :88.00   Max.   :1.0000  </code></pre>
</div>
</div>
<p>We might make the histograms like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">factor</span>(name, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"height"</span>, <span class="st">"weight"</span>, <span class="st">"age"</span>, <span class="st">"male"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>If you’re curious, McElreath made those tiny histograms with help from Wickham’s <a href="https://github.com/hadley/precis/blob/master/R/histospark.R"><code>histospark()</code> function</a>. Here’s the code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>sparks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"\u2581"</span>, <span class="st">"\u2582"</span>, <span class="st">"\u2583"</span>, <span class="st">"\u2585"</span>, <span class="st">"\u2587"</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>histospark <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">width =</span> <span class="dv">10</span>) {</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  bins <span class="ot">&lt;-</span> graphics<span class="sc">::</span><span class="fu">hist</span>(x, <span class="at">breaks =</span> width, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  factor <span class="ot">&lt;-</span> <span class="fu">cut</span>(</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    bins<span class="sc">$</span>counts <span class="sc">/</span> <span class="fu">max</span>(bins<span class="sc">$</span>counts),</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="fu">length</span>(sparks) <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> sparks,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">include.lowest =</span> <span class="cn">TRUE</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(factor, <span class="at">collapse =</span> <span class="st">""</span>)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s how it works.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">histospark</span>(d<span class="sc">$</span>weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "▁▂▃▂▂▂▂▅▇▇▃▂▁"</code></pre>
</div>
</div>
<p>One of the neat things about the <code>histospark()</code> function is you can insert the output right in your R Markdown prose. For example, we can use it to casually show how left skewed the our <code>height</code> variable is: ▁▁▁▁▁▁▁▂▁▇▇▅▁. But it’s time to get back on track. You can isolate <code>height</code> values with the <code>dplyr::select()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(height) <span class="sc">|&gt;</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 544
Columns: 1
$ height &lt;dbl&gt; 151.7650, 139.7000, 136.5250, 156.8450, 145.4150, 163.8300, 149.2250, 168.9100, 147.9550, 165.1000, 154.3050, 151…</code></pre>
</div>
</div>
<p>If you want the values in a numeric vector rather than in a data fame, try <code>pull(d, height)</code>.</p>
<p>We can use the <code>dplyr::filter()</code> function to make an adults-only data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">18</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our reduced <code>d2</code> does indeed have <span class="math inline">\(n = 352\)</span> cases.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="sc">|&gt;</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    n
1 352</code></pre>
</div>
</div>
<section id="overthinking-data-frames-and-indexes" class="level4" data-number="4.3.1.1">
<h4 data-number="4.3.1.1" class="anchored" data-anchor-id="overthinking-data-frames-and-indexes"><span class="header-section-number">4.3.1.1</span> Overthinking: Data frames and indexes</h4>
<p>For more on indexing, check out <a href="https://bookdown.org/rdpeng/rprogdatascience/subsetting-r-objects.html">Chapter 9</a> of Peng’s <span class="citation" data-cites="pengProgrammingDataScience2022">(<a href="references.html#ref-pengProgrammingDataScience2022" role="doc-biblioref">2022</a>)</span> <em>R programming for data science</em>, or even the <a href="http://r4ds.had.co.nz/vectors.html#subsetting-1">Subsetting</a> subsection in <em>R4DS</em>.</p>
<p>This probably reflects my training history, but the structure of a data frame seems natural and inherently appealing. If you’re in the other camp, do check out either of these two data wrangling talks (<a href="https://youtu.be/4MfUCX_KpdE">here</a> and <a href="https://youtu.be/GapSskrtUzU?t=1249">here</a>) by the ineffable <a href="https://twitter.com/JennyBryan">Jenny Bryan</a>.</p>
</section>
</section>
<section id="the-model" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="the-model"><span class="header-section-number">4.3.2</span> The model</h3>
<p>Please heed McElreath’s warnings to</p>
<blockquote class="blockquote">
<p>be careful about choosing the Gaussian distribution only when the plotted outcome variable looks Gaussian to you. Gawking at the raw data, to try to decide how to model them, is usually not a good idea. The data could be a mixture of different Gaussian distributions, for example, and in that case you won’t be able to detect the underlying normality just by eyeballing the outcome distribution. Furthermore, as mentioned earlier in this chapter, the empirical distribution needn’t be actually Gaussian in order to justify using a Gaussian probability distribution. (p.&nbsp;81)</p>
</blockquote>
<p>Anyway, the likelihood for our model is</p>
<p><span class="math display">\[\text{heights}_i \sim \operatorname{Normal}(\mu, \sigma),\]</span></p>
<p>where the <span class="math inline">\(i\)</span> subscript indexes the individual cases in the data. Our two parameters are <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>, which we will estimate using Bayes’ formula. Our prior for <span class="math inline">\(\mu\)</span> will be</p>
<p><span class="math display">\[\mu \sim \operatorname{Normal}(178, 20)\]</span></p>
<p>and our prior for <span class="math inline">\(\sigma\)</span> will be</p>
<p><span class="math display">\[\sigma \sim \operatorname{Uniform}(0, 50).\]</span></p>
<p>Here’s the shape of the prior for <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\mathcal N(178, 20)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">100</span>, <span class="at">to =</span> <span class="dv">250</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">dnorm</span>(x, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">20</span>))) <span class="sc">+</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">100</span>, <span class="at">to =</span> <span class="dv">250</span>, <span class="at">by =</span> <span class="dv">75</span>)) <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"density"</span>,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"mu ~ dnorm(178, 20)"</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>And here’s the <strong>ggplot2</strong> code for our prior for <span class="math inline">\(\sigma\)</span>, a uniform distribution with a minimum value of 0 and a maximum value of 50. We don’t really need the <span class="math inline">\(y\)</span>-axis when looking at the shapes of a density, so we’ll just remove it with <code>scale_y_continuous()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">to =</span> <span class="dv">60</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">dunif</span>(x, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">50</span>))) <span class="sc">+</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"sigma ~ dunif(0, 50)"</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>We can simulate from both priors at once to get a prior probability distribution of <code>heights</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fl">1e4</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">sample_mu    =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd  =</span> <span class="dv">20</span>),</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">sample_sigma =</span> <span class="fu">runif</span>(n, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">50</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">height =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> sample_mu, <span class="at">sd =</span> sample_sigma))</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> sim <span class="sc">|&gt;</span> </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> height)) <span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey33"</span>) <span class="sc">+</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">73</span>, <span class="dv">178</span>, <span class="dv">283</span>)) <span class="sc">+</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"height ~ dnorm(mu, sigma)"</span>) <span class="sc">+</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>If you look at the <span class="math inline">\(x\)</span>-axis breaks on the plot in McElreath’s lower left panel in Figure 4.3, you’ll notice they’re intentional. To compute the mean and 3 standard deviations above and below, you might do this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>sim <span class="sc">|&gt;</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">ll   =</span> <span class="fu">mean</span>(height) <span class="sc">-</span> <span class="fu">sd</span>(height) <span class="sc">*</span> <span class="dv">3</span>,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> <span class="fu">mean</span>(height),</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul   =</span> <span class="fu">mean</span>(height) <span class="sc">+</span> <span class="fu">sd</span>(height) <span class="sc">*</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(round, <span class="at">digits =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
     ll  mean    ul
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1  73.9  177.  281.</code></pre>
</div>
</div>
<p>Our values are very close to his, but are off by just a bit due to simulation variation.</p>
<p>Here’s the work to make the lower right panel of Figure 4.3. Watch out; we’re starting to get fancy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">mean</span>(sim<span class="sc">$</span>height) <span class="sc">-</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">sd</span>(sim<span class="sc">$</span>height), <span class="dv">0</span>, <span class="fu">mean</span>(sim<span class="sc">$</span>height), <span class="fu">mean</span>(sim<span class="sc">$</span>height) <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">sd</span>(sim<span class="sc">$</span>height))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  73.94624   0.00000 177.41305 280.87986</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>m_height <span class="ot">&lt;-</span> <span class="fu">mean</span>(sim<span class="sc">$</span>height)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>s_height <span class="ot">&lt;-</span> <span class="fu">sd</span>(sim<span class="sc">$</span>height)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(m_height <span class="sc">-</span> <span class="dv">3</span> <span class="sc">*</span> s_height, <span class="dv">0</span>, m_height, m_height <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> s_height)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  73.94624   0.00000 177.41305 280.87986</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">sample_mu    =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">100</span>),</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">sample_sigma =</span> <span class="fu">runif</span>(n, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">50</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">height =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> sample_mu, <span class="at">sd =</span> sample_sigma))</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the values we'll use to break on our x axis</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>m_height <span class="ot">&lt;-</span> <span class="fu">mean</span>(sim<span class="sc">$</span>height)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>s_height <span class="ot">&lt;-</span> <span class="fu">sd</span>(sim<span class="sc">$</span>height)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(m_height <span class="sc">-</span> <span class="dv">3</span> <span class="sc">*</span> s_height, <span class="dv">0</span>, m_height, m_height <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> s_height) <span class="sc">|&gt;</span> </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">0</span>)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="co"># This is just for aesthetics</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">height =</span> <span class="dv">272</span> <span class="sc">-</span> <span class="dv">25</span>,</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>               <span class="at">y      =</span> <span class="fl">0.0013</span>,</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">label  =</span> <span class="st">"tallest man"</span>,</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">angle  =</span> <span class="dv">90</span>)</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> sim <span class="sc">|&gt;</span> </span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> height)) <span class="sc">+</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"grey92"</span>) <span class="sc">+</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">272</span>, <span class="at">color =</span> <span class="st">"grey92"</span>, <span class="at">linetype =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> text,</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">label =</span> label, <span class="at">angle =</span> angle),</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey92"</span>) <span class="sc">+</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> breaks) <span class="sc">+</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"height ~ dnorm(mu, sigma)</span><span class="sc">\n</span><span class="st">mu ~ dnorm(178, 100)"</span>) <span class="sc">+</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>p4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>You may have noticed how we were saving each of the four last plots as <code>p1</code> through <code>p4</code>. Let’s combine the four to make our version of McElreath’s Figure 4.3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"mu"</span>) <span class="sc">|</span> p2 <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"sigma"</span>)) <span class="sc">/</span> (p3 <span class="sc">|</span> p4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>On page 84, McElreath said his prior simulation indicated 4% of the heights would be below zero. Here’s how we might determe that percentage for our simulation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>sim <span class="sc">|&gt;</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(height <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent =</span> <span class="dv">100</span> <span class="sc">*</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  `height &lt; 0`     n percent
  &lt;lgl&gt;        &lt;int&gt;   &lt;dbl&gt;
1 FALSE         9571   95.7 
2 TRUE           429    4.29</code></pre>
</div>
</div>
<p>Here’s the break down compared to the tallest man on record, <a href="https://en.wikipedia.org/wiki/Robert_Wadlow">Robert Pershing Wadlow</a> (1918–1940).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>sim <span class="sc">|&gt;</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(height <span class="sc">&lt;</span> <span class="dv">272</span>) <span class="sc">|&gt;</span> </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent =</span> <span class="dv">100</span> <span class="sc">*</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  `height &lt; 272`     n percent
  &lt;lgl&gt;          &lt;int&gt;   &lt;dbl&gt;
1 FALSE           1761    17.6
2 TRUE            8239    82.4</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>Does this matter? In this case, we have so much data that the silly prior is harmless. But that won’t always be the case. There are plenty of inference problems for which the data alone are not sufficient, no matter how numerous. Bayes lets us proceed in these cases. But only if we use our scientific knowledge to construct sensible priors. Using scientific knowledge to build priors is not cheating. The important thing is that your prior not be based on the values in the data, but only on what you know about the data before you see it. (p.&nbsp;84)</p>
</blockquote>
<section id="rethinking-a-farewell-to-epsilon" class="level4" data-number="4.3.2.1">
<h4 data-number="4.3.2.1" class="anchored" data-anchor-id="rethinking-a-farewell-to-epsilon"><span class="header-section-number">4.3.2.1</span> Rethinking: A farewell to epsilon</h4>
<blockquote class="blockquote">
<p>Some readers will have already met an alternative notation for a Gaussian linear model:</p>
<p><span class="math display">\[\begin{align*}
h_i &amp; = \mu + \epsilon_i \\
\epsilon_i &amp; \sim \operatorname{Normal}(0, \sigma)
\end{align*}\]</span></p>
<p>This is equivalent to the <span class="math inline">\(h_i \sim \operatorname{Normal}(\mu, \sigma)\)</span> form, with the <span class="math inline">\(\epsilon\)</span> standing in for the Gaussian density. But this <span class="math inline">\(\epsilon\)</span> form is poor form. The reason is that it does not usually generalize to other types of models. This means it won’t be possible to express non-Gaussian models using tricks like <span class="math inline">\(\epsilon\)</span>. Better to learn one system that does generalize. (p.&nbsp;84)</p>
</blockquote>
<p>Agreed.</p>
</section>
</section>
<section id="grid-approximation-of-the-posterior-distribution" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="grid-approximation-of-the-posterior-distribution"><span class="header-section-number">4.3.3</span> Grid approximation of the posterior distribution</h3>
<p>As McElreath explained, you’ll never use this for practical data analysis. But I found this helped me better understanding what exactly we’re doing with Bayesian estimation. So let’s play along.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll accomplish with `tidyr::crossing()` what McElreath did with base R `expand.grid()`</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>d_grid <span class="ot">&lt;-</span> <span class="fu">crossing</span>(<span class="at">mu    =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">140</span>, <span class="at">to =</span> <span class="dv">160</span>, <span class="at">length.out =</span> n),</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sigma =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">4</span>, <span class="at">to =</span> <span class="dv">9</span>, <span class="at">length.out =</span> n))</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 40,000
Columns: 2
$ mu    &lt;dbl&gt; 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140,…
$ sigma &lt;dbl&gt; 4.000000, 4.025126, 4.050251, 4.075377, 4.100503, 4.125628, 4.150754, 4.175879, 4.201005, 4.226131, 4.251256, 4.27…</code></pre>
</div>
</div>
<p><code>d_grid</code> contains every combination of <code>mu</code> and <code>sigma</code> across their specified values. Instead of base <strong>R</strong> <code>sapply()</code>, we’ll do the computations by making a custom function which we’ll then plug into <code>purrr::map2()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>grid_function <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma) {</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(d2<span class="sc">$</span>height, <span class="at">mean =</span> mu, <span class="at">sd =</span> sigma, <span class="at">log =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>()</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we’re ready to complete the tibble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>d_grid <span class="ot">&lt;-</span> d_grid <span class="sc">|&gt;</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_likelihood =</span> <span class="fu">map2</span>(mu, sigma, grid_function)) <span class="sc">|&gt;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(log_likelihood) <span class="sc">|&gt;</span> </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior_mu    =</span> <span class="fu">dnorm</span>(mu, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">20</span>, <span class="at">log =</span> T),</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">prior_sigma =</span> <span class="fu">dunif</span>(sigma, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">50</span>, <span class="at">log =</span> T)) <span class="sc">|&gt;</span> </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">product =</span> log_likelihood <span class="sc">+</span> prior_mu <span class="sc">+</span> prior_sigma) <span class="sc">|&gt;</span> </span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">probability =</span> <span class="fu">exp</span>(product <span class="sc">-</span> <span class="fu">max</span>(product)))</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
     mu sigma log_likelihood prior_mu prior_sigma product probability
  &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt;    &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt;
1   140  4            -3813.    -5.72       -3.91  -3822.           0
2   140  4.03         -3778.    -5.72       -3.91  -3787.           0
3   140  4.05         -3743.    -5.72       -3.91  -3753.           0
4   140  4.08         -3709.    -5.72       -3.91  -3719.           0
5   140  4.10         -3676.    -5.72       -3.91  -3686.           0
6   140  4.13         -3644.    -5.72       -3.91  -3653.           0</code></pre>
</div>
</div>
<p>In the final <code>d_grid</code>, the <code>probability</code> vector contains the posterior probabilities across values of <code>mu</code> and <code>sigma</code>. We can make a contour plot with <code>geom_contour()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>d_grid <span class="sc">|&gt;</span> </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu, <span class="at">y =</span> sigma, <span class="at">z =</span> probability)) <span class="sc">+</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_contour</span>() <span class="sc">+</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(mu),</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(sigma)) <span class="sc">+</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d_grid<span class="sc">$</span>mu),</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d_grid<span class="sc">$</span>sigma)) <span class="sc">+</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>We’ll make our heat map with <code>geom_raster()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>d_grid <span class="sc">|&gt;</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu, <span class="at">y =</span> sigma, <span class="at">fill =</span> probability)) <span class="sc">+</span> </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="at">interpolate =</span> T) <span class="sc">+</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"B"</span>) <span class="sc">+</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(mu),</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(sigma)) <span class="sc">+</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sampling-from-the-posterior" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4" class="anchored" data-anchor-id="sampling-from-the-posterior"><span class="header-section-number">4.3.4</span> Sampling from the posterior</h3>
<p>We can use <code>dplyr::sample_n()</code> to sample rows, with replacement, from <code>d_grid</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="ot">&lt;-</span> d_grid <span class="sc">|&gt;</span> </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="at">size =</span> <span class="fl">1e4</span>, <span class="at">replace =</span> T, <span class="at">weight =</span> probability)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="sc">|&gt;</span> </span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu, <span class="at">y =</span> sigma)) <span class="sc">+</span> </span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.9</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(mu[samples]),</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(sigma[samples])) <span class="sc">+</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>We can use <code>pivot_longer()</code> and then <code>facet_wrap()</code> to plot the densities for both <code>mu</code> and <code>sigma</code> at once.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="sc">|&gt;</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span> </span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey33"</span>) <span class="sc">+</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">labeller =</span> label_parsed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>We’ll use the <strong>tidybayes</strong> package to compute their posterior modes and 95% HDIs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="sc">|&gt;</span> </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span> </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mode_hdi</span>(value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  name   value .lower .upper .width .point .interval
  &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 mu    155.   154.   155.     0.95 mode   hdi      
2 sigma   7.82   7.19   8.35   0.95 mode   hdi      </code></pre>
</div>
</div>
<p>Let’s say you wanted their posterior medians and 50% quantile-based intervals, instead. Just switch out the last line for <code>median_qi(value, .width = 0.5)</code>.</p>
<section id="overthinking-sample-size-and-the-normality-of-sigmas-posterior" class="level4" data-number="4.3.4.1">
<h4 data-number="4.3.4.1" class="anchored" data-anchor-id="overthinking-sample-size-and-the-normality-of-sigmas-posterior"><span class="header-section-number">4.3.4.1</span> Overthinking: Sample size and the normality of <span class="math inline">\(\sigma\)</span>’s posterior</h4>
<p>Since we’ll be fitting models with <strong>brms</strong> almost exclusively from here on out, this section is largely mute. But we’ll do it anyway for the sake of practice. I’m going to break the steps up like before rather than compress the code together. Here’s <code>d3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>(d3 <span class="ot">&lt;-</span> <span class="fu">sample</span>(d2<span class="sc">$</span>height, <span class="at">size =</span> <span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 147.3200 154.9400 168.9100 156.8450 165.7350 151.7650 165.7350 156.2100 144.7800 154.9400 151.1300 147.9550 149.8600 162.5600
[15] 161.9250 164.4650 160.9852 151.7650 163.8300 149.8600</code></pre>
</div>
</div>
<p>For our first step using <code>d3</code>, we’ll redefine <code>d_grid</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Note we've redefined the ranges of `mu` and `sigma`</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>d_grid <span class="ot">&lt;-</span> <span class="fu">crossing</span>(<span class="at">mu    =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">150</span>, <span class="at">to =</span> <span class="dv">170</span>, <span class="at">length.out =</span> n),</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sigma =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">4</span>, <span class="at">to =</span> <span class="dv">20</span>, <span class="at">length.out =</span> n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Second, we’ll redefine our custom <code>grid_function()</code> function to operate over the <code>height</code> values of <code>d3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>grid_function <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma) {</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(d3, <span class="at">mean =</span> mu, <span class="at">sd =</span> sigma, <span class="at">log =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>()</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we’ll use the amended <code>grid_function()</code> to make the posterior.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>d_grid <span class="ot">&lt;-</span> d_grid <span class="sc">|&gt;</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_likelihood =</span> <span class="fu">map2_dbl</span>(mu, sigma, grid_function)) <span class="sc">|&gt;</span> </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior_mu    =</span> <span class="fu">dnorm</span>(mu, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">20</span>, <span class="at">log =</span> T),</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">prior_sigma =</span> <span class="fu">dunif</span>(sigma, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">50</span>, <span class="at">log =</span> T)) <span class="sc">|&gt;</span> </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">product =</span> log_likelihood <span class="sc">+</span> prior_mu <span class="sc">+</span> prior_sigma) <span class="sc">|&gt;</span> </span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">probability =</span> <span class="fu">exp</span>(product <span class="sc">-</span> <span class="fu">max</span>(product)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Did you catch our use of <code>purrr::map2_dbl()</code>, there, in place of <code>purrr::map2()</code>? It turns out that <code>purrr::map()</code> and <code>purrr::map2()</code> always return a list (see <a href="https://purrr.tidyverse.org/reference/map.html">here</a> and <a href="https://purrr.tidyverse.org/reference/map2.html">here</a>). But we can add the <code>_dbl</code> suffix to those functions, which will instruct the <strong>purrr</strong> package to return a double vector (i.e., a <a href="http://r4ds.had.co.nz/vectors.html#important-types-of-atomic-vector">common kind of numeric vector</a>). The advantage of that approach is we no longer need to follow our <code>map()</code> or <code>map2()</code> lines with <code>unnest()</code>. To learn more about the ins and outs of the <code>map()</code> family, check out <a href="http://r4ds.had.co.nz/iteration.html#the-map-functions">this section</a> from <em>R4DS</em> or Jenny Bryan’s <a href="https://jennybc.github.io/purrr-tutorial/"><em>purrr tutorial</em></a>.</p>
<p>Next we’ll <code>sample_n()</code> and plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="ot">&lt;-</span> d_grid <span class="sc">|&gt;</span> </span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="at">size =</span> <span class="fl">1e4</span>, <span class="at">replace =</span> T, <span class="at">weight =</span> probability)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="sc">|&gt;</span> </span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu, <span class="at">y =</span> sigma)) <span class="sc">+</span> </span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">15</span>, <span class="at">size =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(mu[samples]),</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(sigma[samples])) <span class="sc">+</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>Behold the updated densities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="sc">|&gt;</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span> </span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey33"</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">labeller =</span> label_parsed, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>That <code>labeller = label_parsed</code> bit in the <code>facet_wrap()</code> function is what converted our subplot strip labels into Greek. You can learn more about <code>labeller</code> <a href="https://ggplot2.tidyverse.org/reference/labeller.html">here</a>. Anyway, our posterior for <span class="math inline">\(\sigma\)</span> isn’t so Gaussian with that small <span class="math inline">\(n\)</span>.</p>
<p>This is the point in the project where we hop off the grid-approximation train. On the one hand, I think this is a great idea. Most of y’all reading this will never use grid approximation in a real-world applied data analysis. On the other hand, there is some pedagogical utility in practicing with it. It can help you grasp what it is we’re doing when we apply Bayes’ theorem. If you’d like more practice, check out the first several chapters in John Kruschke’s <span class="citation" data-cites="kruschkeDoingBayesianData2015">(<a href="references.html#ref-kruschkeDoingBayesianData2015" role="doc-biblioref">2015</a>)</span> <a href="https://sites.google.com/site/doingbayesiandataanalysis/">textbook</a> and the corresponding chapters in my <span class="citation" data-cites="kurzDoingBayesianDataAnalysis2026">(<a href="references.html#ref-kurzDoingBayesianDataAnalysis2026" role="doc-biblioref">2026</a>)</span> <a href="https://solomon.quarto.pub/dbda2/">ebook</a> translating it into <strong>brms</strong> and <strong>tidyverse</strong>.</p>
</section>
</section>
<section id="finding-the-posterior-distribution-with-quap-brm" class="level3" data-number="4.3.5">
<h3 data-number="4.3.5" class="anchored" data-anchor-id="finding-the-posterior-distribution-with-quap-brm"><span class="header-section-number">4.3.5</span> Finding the posterior distribution with <del><code>quap</code></del> <code>brm()</code></h3>
<p>Here we rewrite the statistical model, this time using font color to help differentiate the likelihood from the prior(s).</p>
<p><span class="math display">\[\begin{align*}
\color{red}{\text{heights}_i} &amp; \color{red}\sim \color{red}{\operatorname{Normal}(\mu, \sigma)} &amp;&amp; \color{red}{\text{likelihood}} \\
\color{blue}\mu &amp; \color{blue}\sim \color{blue}{\operatorname{Normal}(178, 20)} &amp;&amp; \color{blue}{\text{prior}} \\
\color{blue}\sigma &amp; \color{blue}\sim \color{blue}{\operatorname{Uniform}(0, 50)}
\end{align*}\]</span></p>
<p>We won’t actually use <code>rethinking::quap()</code>. It’s time to jump straight to the primary <strong>brms</strong> modeling function, <code>brm()</code>. In the text, McElreath indexed his models with names like <code>m4.1</code>. I will largely follow that convention, but will replace the <em>m</em> with a <em>b</em> to stand for the <strong>brms</strong> package. Here’s how to fit the first model for this chapter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d2, </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  height <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">178</span>, <span class="dv">20</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> sigma, <span class="at">ub =</span> <span class="dv">50</span>)),</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.01"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note our use of the <code>ub</code> parameter for the uniform prior on <span class="math inline">\(\sigma\)</span>. If you want to use an upper-bound prior on <span class="math inline">\(\sigma\)</span> with a <code>brm()</code> model, the <code>up</code> setting will help out a lot. We’ll start to get a sense of why when we cover Hamiltonian Monte Carlo (HMC) in <a href="09.html" class="quarto-xref"><span>Chapter 9</span></a>. This leads to an important point. After running a model fit with HMC, it’s a good idea to inspect the chains. As we’ll see, McElreath covered visual chain diagnostics in <a href="09.html" class="quarto-xref"><span>Chapter 9</span></a>. Here’s a typical way to do so with <strong>brms</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(b4<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>If you want detailed diagnostics for the HMC chains, call <code>launch_shinystan(b4.1)</code>. That’ll keep you busy for a while. But anyway, the chains look good. We can reasonably trust the results. Here’s how to get the model summary of our <code>brm()</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b4<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: height ~ 1 
   Data: d2 (Number of observations: 352) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept   154.61      0.40   153.79   155.41 1.00     3654     2340

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     7.77      0.29     7.23     8.38 1.00     3901     3112

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>The <code>summary()</code> function works in a similar way. You can also get a Stan-like summary [see the <a href="https://CRAN.R-project.org/package=rstan/vignettes/rstan.html"><em>RStan: the R interface to Stan</em></a> vignette; <span class="citation" data-cites="standevelopmentteamRStanInterfaceStan2023">Stan Development Team (<a href="references.html#ref-standevelopmentteamRStanInterfaceStan2023" role="doc-biblioref">2023</a>)</span>] with a little indexing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.1</span><span class="sc">$</span>fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

                mean se_mean   sd     2.5%      25%      50%      75%    97.5% n_eff Rhat
b_Intercept   154.61    0.01 0.40   153.79   154.34   154.61   154.87   155.41  3633    1
sigma           7.77    0.00 0.29     7.23     7.56     7.76     7.96     8.38  3936    1
Intercept     154.61    0.01 0.40   153.79   154.34   154.61   154.87   155.41  3633    1
lprior         -8.51    0.00 0.02    -8.56    -8.53    -8.51    -8.50    -8.46  3636    1
lp__        -1227.02    0.02 0.97 -1229.56 -1227.38 -1226.72 -1226.30 -1226.06  1941    1

Samples were drawn using NUTS(diag_e) at Mon Jan  5 21:53:25 2026.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Whereas <strong>rethinking</strong> defaults to 89% intervals, using <code>print()</code> or <code>summary()</code> with <strong>brms</strong> models defaults to 95% intervals. Unless otherwise specified, I will stick with 95% intervals throughout. However, if you really want those 89% intervals, an easy way is with the <code>prob</code> argument within <code>brms::summary()</code> or <code>brms::print()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(b4<span class="fl">.1</span>, <span class="at">prob =</span> <span class="fl">0.89</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: height ~ 1 
   Data: d2 (Number of observations: 352) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-89% CI u-89% CI Rhat Bulk_ESS Tail_ESS
Intercept   154.61      0.40   153.96   155.26 1.00     3654     2340

Further Distributional Parameters:
      Estimate Est.Error l-89% CI u-89% CI Rhat Bulk_ESS Tail_ESS
sigma     7.77      0.29     7.31     8.25 1.00     3901     3112

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Anyways, here’s the <code>brms::brm()</code> code for the model with the very-narrow-<span class="math inline">\(\mu\)</span>-prior corresponding to the <code>rethinking::quap()</code> code in McElreath’s <strong>R</strong> code 4.31.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d2, </span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  height <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">178</span>, <span class="fl">0.1</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> sigma, <span class="at">ub =</span> <span class="dv">50</span>)),</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.02"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(b4<span class="fl">.2</span>, <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The chains look great. Here’s the model <code>summary()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(b4<span class="fl">.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: height ~ 1 
   Data: d2 (Number of observations: 352) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept   177.86      0.10   177.66   178.07 1.00     2982     2248

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma    24.61      0.94    22.82    26.59 1.00     3163     2678

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Subsetting the <code>summary()</code> output with <code>$fixed</code> provides a convenient way to compare the <code>Intercept</code> summaries between <code>b4.1_hc</code> and <code>b4.2</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="fu">summary</span>(b4<span class="fl">.1</span>)<span class="sc">$</span>fixed,</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summary</span>(b4<span class="fl">.2</span>)<span class="sc">$</span>fixed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Estimate Est.Error l-95% CI u-95% CI     Rhat Bulk_ESS Tail_ESS
Intercept  154.6054 0.4035752 153.7868 155.4105 1.001695 3654.491 2340.199
Intercept1 177.8645 0.1022954 177.6620 178.0650 1.000020 2981.815 2247.967</code></pre>
</div>
</div>
</section>
<section id="sampling-from-a-quap-brm-fit" class="level3" data-number="4.3.6">
<h3 data-number="4.3.6" class="anchored" data-anchor-id="sampling-from-a-quap-brm-fit"><span class="header-section-number">4.3.6</span> Sampling from a <del><code>quap()</code></del> <code>brm()</code> fit</h3>
<p><strong>brms</strong> doesn’t seem to have a convenience function that works the way <code>vcov()</code> does for <strong>rethinking</strong>. For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vcov</span>(b4<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Intercept
Intercept 0.1628729</code></pre>
</div>
</div>
<p>This only returns the first element in the matrix it did for <strong>rethinking</strong>. That is, it appears <code>brms::vcov()</code> only returns the variance/covariance matrix for the single-level <span class="math inline">\(\beta\)</span> parameters. However, if you really wanted this information, you could get it after putting the HMC chains in a data frame. We do that with the <code>as_draws_df()</code> function, which we’ll be using a lot of as we go along.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b4<span class="fl">.1</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(post)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A draws_df: 6 iterations, 1 chains, and 5 variables
  b_Intercept sigma Intercept lprior  lp__
1         154   7.8       154   -8.5 -1226
2         154   7.7       154   -8.5 -1226
3         155   8.5       155   -8.5 -1229
4         155   7.9       155   -8.5 -1226
5         154   8.1       154   -8.5 -1227
6         155   8.0       155   -8.5 -1226
# ... hidden reserved variables {'.chain', '.iteration', '.draw'}</code></pre>
</div>
</div>
<p>Now <code>select()</code> the columns containing the draws from the desired parameters and feed them into <code>cov()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(post, b_Intercept<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              b_Intercept         sigma
b_Intercept  0.1628729253 -0.0002503749
sigma       -0.0002503749  0.0869613252</code></pre>
</div>
</div>
<p>That was “(1) a vector of variances for the parameters and (2) a correlation matrix” for them (p.&nbsp;90). Here are just the variances (i.e., the diagonal elements) and the correlation matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variances</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(post, b_Intercept<span class="sc">:</span>sigma) <span class="sc">|&gt;</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov</span>() <span class="sc">|&gt;</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">diag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>b_Intercept       sigma 
 0.16287293  0.08696133 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(b_Intercept, sigma) <span class="sc">|&gt;</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             b_Intercept        sigma
b_Intercept  1.000000000 -0.002103794
sigma       -0.002103794  1.000000000</code></pre>
</div>
</div>
<p>With our <code>post &lt;- as_draws_df(b4.1)</code> code from a few lines above, we’ve already produced the <strong>brms</strong> version of what McElreath achieved with <code>extract.samples()</code> on page 90. However, what happened under the hood was different. Whereas <strong>rethinking</strong> used the <code>mvnorm()</code> function from the <a href="https://cran.r-project.org/package=MASS"><strong>MASS</strong> package</a> <span class="citation" data-cites="R-MASS MASS2002">(<a href="references.html#ref-R-MASS" role="doc-biblioref">Ripley, 2022</a>; <a href="references.html#ref-MASS2002" role="doc-biblioref">Venables &amp; Ripley, 2002</a>)</span>, with <strong>brms</strong> we just extracted the iterations of the HMC chains and put them in a data frame. It’s also noteworthy that the <code>as_draws_df()</code> is part of a larger class of <code>as_draws()</code> functions <strong>brms</strong> currently imports from the <a href="https://github.com/stan-dev/posterior"><strong>posterior</strong> package</a> <span class="citation" data-cites="R-posterior">(<a href="references.html#ref-R-posterior" role="doc-biblioref">Bürkner et al., 2022</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(post)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>draws_df [4,000 × 8] (S3: draws_df/draws/tbl_df/tbl/data.frame)
 $ b_Intercept: num [1:4000] 154 154 155 155 154 ...
 $ sigma      : num [1:4000] 7.76 7.7 8.52 7.95 8.05 ...
 $ Intercept  : num [1:4000] 154 154 155 155 154 ...
 $ lprior     : num [1:4000] -8.53 -8.52 -8.51 -8.5 -8.54 ...
 $ lp__       : num [1:4000] -1226 -1226 -1229 -1226 -1227 ...
 $ .chain     : int [1:4000] 1 1 1 1 1 1 1 1 1 1 ...
 $ .iteration : int [1:4000] 1 2 3 4 5 6 7 8 9 10 ...
 $ .draw      : int [1:4000] 1 2 3 4 5 6 7 8 9 10 ...</code></pre>
</div>
</div>
<p>Thus, our <code>post</code> object is not just a data frame, but also of class draws_df, which means it contains three metadata variables–<code>.chain</code>, <code>.iteration</code>, and <code>.draw</code>–which will are often hidden from view, but are there in the background when needed. As you’ll see, we’ll make good use of the <code>.draw</code> variable in the future. Notice how our <code>post</code> data frame also includes vectors named <code>lprior</code> and <code>lp__</code>. That’s the log prior, adn the log posterior. For details, see the <a href="https://CRAN.R-project.org/package=brms/brms.pdf"><strong>brms</strong> reference manual</a> <span class="citation" data-cites="brms2022RM">(<a href="references.html#ref-brms2022RM" role="doc-biblioref">Bürkner, 2022a</a>)</span>, the “<a href="https://cran.r-project.org/package=rstan/vignettes/rstan.html#the-log-posterior-function-and-gradient">The Log-Posterior (function and gradient)</a>” section of the Stan Development Team’s <span class="citation" data-cites="standevelopmentteamRStanInterfaceStan2023">(<a href="references.html#ref-standevelopmentteamRStanInterfaceStan2023" role="doc-biblioref">2023</a>)</span> vignette, <a href="https://cran.r-project.org/package=rstan/vignettes/rstan.html"><em>RStan: the R interface to Stan</em></a>, or <a href="https://twitter.com/smartin2018">Stephen Martin</a>’s <a href="https://discourse.mc-stan.org/t/basic-question-what-is-lp-in-posterior-samples-of-a-brms-regression/17567/2">nice explanation</a> of the log posterior on the Stan Forums. The log prior and log posterior will largely be outside of our focus in this ebook.</p>
<p>The <code>summary()</code> function doesn’t work for <strong>brms</strong> posterior data frames quite the way <code>precis()</code> does for posterior data frames from the <strong>rethinking package</strong>. Behold the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(post[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  b_Intercept        sigma      
 Min.   :153.1   Min.   :6.927  
 1st Qu.:154.3   1st Qu.:7.564  
 Median :154.6   Median :7.762  
 Mean   :154.6   Mean   :7.768  
 3rd Qu.:154.9   3rd Qu.:7.961  
 Max.   :156.1   Max.   :8.920  </code></pre>
</div>
</div>
<p>Here’s one option using the transpose of a <code>quantile()</code> call nested within <code>apply()</code>, which is a very general function you can learn more about <a href="https://www.datacamp.com/community/tutorials/r-tutorial-apply-family#gs.f7fyw2s">here</a> or <a href="https://www.r-bloggers.com/r-tutorial-on-the-apply-family-of-functions/">here</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">apply</span>(post[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.025</span>, <span class="fl">0.75</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   50%       2.5%        75%
b_Intercept 154.611940 153.786780 154.865745
sigma         7.761514   7.225498   7.960993</code></pre>
</div>
</div>
<p>The base <strong>R</strong> code is compact, but somewhat opaque. Here’s how to do something similar with more explicit <strong>tidyverse</strong> code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(b_Intercept<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(value),</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd   =</span> <span class="fu">sd</span>(value),</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">2.5%</span><span class="st">`</span>  <span class="ot">=</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">97.5%</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.975</span>)) <span class="sc">|&gt;</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  name          mean    sd `2.5%` `97.5%`
  &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
1 b_Intercept 155.    0.4  154.    155.  
2 sigma         7.77  0.29   7.23    8.38</code></pre>
</div>
</div>
<p>You can always get pretty similar information by just putting the <code>brm()</code> fit object into <code>posterior_summary()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_summary</span>(b4<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                Estimate  Est.Error         Q2.5        Q97.5
b_Intercept   154.605420 0.40357518   153.786780   155.410455
sigma           7.768158 0.29489206     7.225498     8.377223
Intercept     154.605420 0.40357518   153.786780   155.410455
lprior         -8.511030 0.02360932    -8.559544    -8.464553
lp__        -1227.016052 0.97349118 -1229.561352 -1226.061946</code></pre>
</div>
</div>
<p>And if you’re willing to drop the posterior <span class="math inline">\(\textit{SD}\)</span>s, you can use <code>tidybayes::mean_hdi()</code>, too.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span> </span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(b_Intercept<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_qi</span>(value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  name         value .lower .upper .width .point .interval
  &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 b_Intercept 155.   154.   155.     0.95 mean   qi       
2 sigma         7.77   7.23   8.38   0.95 mean   qi       </code></pre>
</div>
</div>
<p>Though none of these solutions get you those sweet little histograms, you can always make those for your HMC models by inserting the desired posterior draws into <code>histospark()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="fu">histospark</span>(post<span class="sc">$</span>b_Intercept),</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">histospark</span>(post<span class="sc">$</span>sigma))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]         
[1,] "▁▁▅▇▂▁▁"    
[2,] "▁▁▂▅▇▇▃▂▁▁▁"</code></pre>
</div>
</div>
<p>Hell, you can even tack those onto the output from our verbose <strong>tidyverse</strong> code from a few blocks up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(b_Intercept<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(value),</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd   =</span> <span class="fu">sd</span>(value),</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">2.5%</span><span class="st">`</span>  <span class="ot">=</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">97.5%</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.975</span>)) <span class="sc">|&gt;</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="at">digits =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">histospark =</span> <span class="fu">c</span>(<span class="fu">histospark</span>(post<span class="sc">$</span>b_Intercept), <span class="fu">histospark</span>(post<span class="sc">$</span>sigma)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  name          mean    sd `2.5%` `97.5%` histospark 
  &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;      
1 b_Intercept 155.    0.4  154.    155.   ▁▁▅▇▂▁▁    
2 sigma         7.77  0.29   7.23    8.38 ▁▁▂▅▇▇▃▂▁▁▁</code></pre>
</div>
</div>
<section id="overthinking-start-values-for-quap-brm" class="level4" data-number="4.3.6.1">
<h4 data-number="4.3.6.1" class="anchored" data-anchor-id="overthinking-start-values-for-quap-brm"><span class="header-section-number">4.3.6.1</span> Overthinking: Start values for <del><code>quap()</code></del> <code>brm()</code></h4>
<p>We won’t be emphasizing start values in this ebook. But, yes, you can set start values for the HMC chains from <strong>brms</strong>, too. Within the <code>brm()</code> function, you do so with the <code>init</code> argument. From the <code>brm</code> section within the <a href="https://CRAN.R-project.org/package=brms/brms.pdf"><strong>brms</strong> reference manual</a>, we read:</p>
<blockquote class="blockquote">
<p>Initial values for the sampler. If <code>NULL</code> (the default) or <code>"random"</code>, Stan will randomly generate initial values for parameters in a reasonable range. If <code>0</code>, all parameters are initialized to zero on the unconstrained space. This option is sometimes useful for certain families, as it happens that default random initial values cause draws to be essentially constant. Generally, setting <code>init = 0</code> is worth a try, if chains do not initialize or behave well. Alternatively, <code>init</code> can be a list of lists containing the initial values, or a function (or function name) generating initial values. The latter options are mainly implemented for internal testing but are available to users if necessary. If specifying initial values using a list or a function then currently the parameter names must correspond to the names used in the generated Stan code (not the names used in <code>R</code>).</p>
</blockquote>
</section>
<section id="overthinking-under-the-hood-with-multivariate-sampling" class="level4" data-number="4.3.6.2">
<h4 data-number="4.3.6.2" class="anchored" data-anchor-id="overthinking-under-the-hood-with-multivariate-sampling"><span class="header-section-number">4.3.6.2</span> Overthinking: Under the hood with multivariate sampling</h4>
<p>Again, <code>brms::as_draws_df()</code> is not the same as <code>rethinking::extract.samples()</code>. Rather than use the <code>MASS::mvnorm()</code>, <strong>brms</strong> takes the draws from the HMC chains. McElreath covered all of this in <a href="09.html" class="quarto-xref"><span>Chapter 9</span></a> and we will too. You might also look at the <a href="https://cran.r-project.org/package=brms/brms.pdf"><strong>brms</strong> reference manual</a> or <a href="https://github.com/paul-buerkner/brms">GitHub page</a> for details. To get documentation in a hurry, you could also just execute <code>?as_draws_df</code>.</p>
</section>
</section>
</section>
<section id="linear-prediction" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="linear-prediction"><span class="header-section-number">4.4</span> Linear prediction</h2>
<p>Here’s our scatter plot of <code>weight</code> and <code>height</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> d2, </span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>There’s obviously a relationship: Knowing a person’s weight helps you predict height.</p>
<p>To make this vague observation into a more precise quantitative model that relates values of <code>weight</code> to plausible values of <code>height</code>, we need some more technology. How do we take our Gaussian model from the previous section and incorporate predictor variables? (p.&nbsp;92)</p>
</blockquote>
<section id="the-linear-model-strategy" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="the-linear-model-strategy"><span class="header-section-number">4.4.1</span> The linear model strategy</h3>
<blockquote class="blockquote">
<p>The strategy is to make the parameter for the mean of a Gaussian distribution, <span class="math inline">\(\mu\)</span>, into a linear function of the predictor variable and other, new parameters that we invent. This strategy is often simply called the <strong>linear model</strong>. The linear model strategy instructs the golem to assume that the predictor variable has a constant and additive relationship to the mean of the outcome. The golem then computes the posterior distribution of this constant relationship. (p.&nbsp;92, <strong>emphasis</strong> in the original)</p>
</blockquote>
<p>Like we did for our first model without a predictor, we’ll use font color to help differentiate between the likelihood and prior(s) of our new univariable model,</p>
<p><span class="math display">\[\begin{align*}
\color{red}{\text{height}_i} &amp; \color{red}\sim \color{red}{\operatorname{Normal}(\mu_i, \sigma)} &amp;&amp; \color{red}{\text{likelihood}} \\
\color{red}{\mu_i} &amp; \color{red}= \color{red}{\alpha + \beta (\text{weight}_i - \overline{\text{weight}})}  &amp;&amp; \color{red}{\text{\{the linear model is just a special part of the likelihood\}} } \\
\color{blue}\alpha &amp; \color{blue}\sim \color{blue}{\operatorname{Normal}(178, 20)} &amp;&amp; \color{blue}{\text{prior(s)}} \\
\color{blue}\beta  &amp; \color{blue}\sim \color{blue}{\operatorname{Normal}(0, 10)} \\
\color{blue}\sigma &amp; \color{blue}\sim \color{blue}{\operatorname{Uniform}(0, 50)}.
\end{align*}\]</span></p>
<p>Do note that <span class="math inline">\((\text{weight}_i - \overline{\text{weight}})\)</span> part. As we’ll see, it’s often advantageous to mean center our predictors.</p>
<section id="probability-of-the-data" class="level4" data-number="4.4.1.1">
<h4 data-number="4.4.1.1" class="anchored" data-anchor-id="probability-of-the-data"><span class="header-section-number">4.4.1.1</span> Probability of the data</h4>
<blockquote class="blockquote">
<p>Let’s begin with just the probability of the observed height, the first line of the model. This is nearly identical to before, except now there is a little index <span class="math inline">\(i\)</span> on the <span class="math inline">\(\mu\)</span> as well as the [<span class="math inline">\(\text{height}\)</span>]. You can read [<span class="math inline">\(\text{height}_i\)</span>] as “each [<span class="math inline">\(\text{height}\)</span>]” and <span class="math inline">\(\mu_i\)</span> as “each <span class="math inline">\(\mu\)</span>.” The mean <span class="math inline">\(\mu\)</span> now depends upon unique values on each row <span class="math inline">\(i\)</span>. So the little <span class="math inline">\(i\)</span> on <span class="math inline">\(\mu_i\)</span> indicates that <em>the mean depends upon the row</em>. (p.&nbsp;93, <em>emphasis</em> in the original)</p>
</blockquote>
</section>
<section id="linear-model" class="level4" data-number="4.4.1.2">
<h4 data-number="4.4.1.2" class="anchored" data-anchor-id="linear-model"><span class="header-section-number">4.4.1.2</span> Linear model</h4>
<blockquote class="blockquote">
<p>The mean <span class="math inline">\(\mu\)</span> is no longer a parameter to be estimated. Rather, as seen in the second line of the model, <span class="math inline">\(\mu_i\)</span> is constructed from other parameters, <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>, and the observed variable [<span class="math inline">\(\text{weight}\)</span>]. This line is not a stochastic relationship–there is no <span class="math inline">\(\sim\)</span> in it, but rather an <span class="math inline">\(=\)</span> in it–because the definition of <span class="math inline">\(\mu_i\)</span> is deterministic. That is to say that, once we know <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> and [<span class="math inline">\(\text{weight}_i\)</span>], we know <span class="math inline">\(\mu_i\)</span> with certainty.</p>
<p>The value [<span class="math inline">\(\text{weight}_i\)</span>] is just the weight value on row <span class="math inline">\(i\)</span>. It refers to the same individual as the height value, [<span class="math inline">\(\text{height}_i\)</span>], on the same row. The parameters <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> are more mysterious. Where did they come from? We made them up….</p>
<p>You’ll be making up all manner of parameters as your skills improve. (p.&nbsp;93)</p>
</blockquote>
<section id="rethinking-nothing-special-or-natural-about-linear-models" class="level5" data-number="4.4.1.2.1">
<h5 data-number="4.4.1.2.1" class="anchored" data-anchor-id="rethinking-nothing-special-or-natural-about-linear-models"><span class="header-section-number">4.4.1.2.1</span> Rethinking: Nothing special or natural about linear models</h5>
<blockquote class="blockquote">
<p>Note that there’s nothing special about the linear model, really. You can choose a different relationship between <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\mu\)</span>. For example, the following is a perfectly legitimate definition for <span class="math inline">\(\mu_i\)</span>:</p>
<p><span class="math display">\[\mu_i = \alpha \exp(- \beta x_i)\]</span></p>
<p>This does not define a linear regression, but it does define a regression model. The linear relationship we are using instead is conventional, but nothing requires that you use it. (p.&nbsp;94)</p>
</blockquote>
</section>
</section>
<section id="priors" class="level4" data-number="4.4.1.3">
<h4 data-number="4.4.1.3" class="anchored" data-anchor-id="priors"><span class="header-section-number">4.4.1.3</span> Priors</h4>
<blockquote class="blockquote">
<p>The remaining lines in the model define distributions for the unobserved variables. These variables are commonly known as parameters, and their distributions as priors. There are three parameters: <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\sigma\)</span>. You’ve seen priors for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\sigma\)</span> before, although <span class="math inline">\(\alpha\)</span> was called <span class="math inline">\(\mu\)</span> back then.</p>
<p>The prior for <span class="math inline">\(\beta\)</span> deserves explanation. Why have a Gaussian prior with mean zero? (p.&nbsp;94)</p>
</blockquote>
<p>We’ll simulate to find out. Instead of using a loop to make our data for Figure 4.5, we’ll stay within the <strong>tidyverse</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2971</span>)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="co"># How many lines would you like?</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>n_lines <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>lines <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>n_lines,</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">a =</span> <span class="fu">rnorm</span>(n_lines, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">20</span>),</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">b =</span> <span class="fu">rnorm</span>(n_lines, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">weight =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight)) <span class="sc">|&gt;</span> </span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">height =</span> a <span class="sc">+</span> b <span class="sc">*</span> (weight <span class="sc">-</span> <span class="fu">mean</span>(d2<span class="sc">$</span>weight)))</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(lines)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
      n     a      b weight height
  &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1     1  191. -7.06    31.1  289. 
2     1  191. -7.06    63.0   63.5
3     2  199.  0.839   31.1  187. 
4     2  199.  0.839   63.0  214. 
5     3  202.  3.93    31.1  147. 
6     3  202.  3.93    63.0  272. </code></pre>
</div>
</div>
<p>Now we’ll plot the left panel from Figure 4.5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>lines <span class="sc">|&gt;</span> </span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height, <span class="at">group =</span> n)) <span class="sc">+</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">272</span>), <span class="at">linetype =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">400</span>)) <span class="sc">+</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"b ~ dnorm(0, 10)"</span>) <span class="sc">+</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>The pattern doesn’t look like any human population at all. It essentially says that the relationship between weight and height could be absurdly positive or negative. Before we’ve even seen the data, this is a bad model. Can we do better?</p>
<p>We can do better immediately. (pp.&nbsp;95–96)</p>
</blockquote>
<p>One thing we know from the outset is that the correlation between human height and weight is positive. We might not be sure of the magnitude, but it’s definitely the case that, on average, taller people are heavier people. Within the univariable regression context, this implies that the regression coefficient for <code>weight</code> predicting <code>height</code> will be positive. It might be unclear how large that coefficient will be, but it will certainly be above zero. One way we might encode this information in our data is by using the log-normal distribution for our <span class="math inline">\(\beta\)</span> prior. Here’s what <span class="math inline">\(\operatorname{Log-Normal}(0, 1)\)</span> looks like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">b =</span> <span class="fu">rlnorm</span>(<span class="fl">1e4</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> b)) <span class="sc">+</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey92"</span>) <span class="sc">+</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-72-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>If you’re unfamiliar with the log-normal distribution, it is the distribution whose logarithm is normally distributed. For example, here’s what happens when we compare <span class="math inline">\(\operatorname{Normal}(0, 1)\)</span> with <span class="math inline">\(\log \big ( \operatorname{Log-Normal}(0, 1) \big)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">rnorm           =</span> <span class="fu">rnorm</span>(<span class="fl">1e5</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>),</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">`</span><span class="at">log(rlognorm)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">log</span>(<span class="fu">rlnorm</span>(<span class="fl">1e5</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey92"</span>) <span class="sc">+</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">nrow =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-73-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>They are the same within simulation variance. Also, did you notice how we simulated those log-normal data with <code>mean = 0, sd = 1</code>? Those values are what the mean and standard deviation of the output from the <code>rlnorm()</code> function <strong>after</strong> they are log transformed. The formulas for the actual mean and standard deviation for the log-normal distribution itself are complicated (see <a href="https://en.wikipedia.org/wiki/Log-normal_distribution">here</a>). They are</p>
<p><span class="math display">\[\begin{align*}
\text{mean}               &amp; = \exp \left (\mu + \frac{\sigma^2}{2} \right) &amp; \text{and} \\
\text{standard deviation} &amp; = \sqrt{[\exp(\sigma ^{2})-1] \; \exp(2\mu +\sigma ^{2})}.
\end{align*}\]</span></p>
<p>Let’s try our hand at those formulas and compute the mean and standard deviation for <span class="math inline">\(\operatorname{Log-Normal}(0, 1)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>mu    <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(mu <span class="sc">+</span> (sigma<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.648721</code></pre>
</div>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SD</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>((<span class="fu">exp</span>(sigma<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">exp</span>(<span class="dv">2</span> <span class="sc">*</span> mu <span class="sc">+</span> sigma<span class="sc">^</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.161197</code></pre>
</div>
</div>
<p>Let’s confirm with simulated draws from <code>rlnorm()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rlnorm</span>(<span class="fl">1e7</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(x),</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd   =</span> <span class="fu">sd</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
   mean    sd
  &lt;dbl&gt; &lt;dbl&gt;
1  1.65  2.17</code></pre>
</div>
</div>
<p>But okay, “so what [do all these complications] earn us? Do the prior predictive simulation again, now with the Log-Normal prior:” (p.&nbsp;96).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a tibble to annotate the plot</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">weight =</span> <span class="fu">c</span>(<span class="dv">34</span>, <span class="dv">43</span>),</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">height =</span> <span class="fu">c</span>(<span class="dv">0</span> <span class="sc">-</span> <span class="dv">25</span>, <span class="dv">272</span> <span class="sc">+</span> <span class="dv">25</span>),</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">label  =</span> <span class="fu">c</span>(<span class="st">"Embryo"</span>, <span class="st">"World's tallest person (272 cm)"</span>))</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2971</span>)</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>n_lines,</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">a =</span> <span class="fu">rnorm</span>(n_lines, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">20</span>),</span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">b =</span> <span class="fu">rlnorm</span>(n_lines, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">weight =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight)) <span class="sc">|&gt;</span> </span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">height =</span> a <span class="sc">+</span> b <span class="sc">*</span> (weight <span class="sc">-</span> <span class="fu">mean</span>(d2<span class="sc">$</span>weight))) <span class="sc">|&gt;</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height, <span class="at">group =</span> n)) <span class="sc">+</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">272</span>), <span class="at">linetype =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> text,</span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label =</span> label),</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">400</span>)) <span class="sc">+</span></span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"log(b) ~ dnorm(0, 1)"</span>) <span class="sc">+</span></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>“This is much more sensible. There is still a rare impossible relationship. But nearly all lines in the joint prior for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> are now within human reason” (p.&nbsp;96)</p>
<section id="rethinking-whats-the-correct-prior" class="level5" data-number="4.4.1.3.1">
<h5 data-number="4.4.1.3.1" class="anchored" data-anchor-id="rethinking-whats-the-correct-prior"><span class="header-section-number">4.4.1.3.1</span> Rethinking: What’s the correct prior?</h5>
<p>Good luck with that question. Hang around on academic Twitter long enough and you’ll see folks debating this.</p>
<blockquote class="blockquote">
<p>This is a mistake. There is no more a uniquely correct prior than there is a uniquely correct likelihood. Statistical models are machines for inference. Many machines will work, but some work better than others. Priors can be wrong, but only in the same sense that a kind of hammer can be wrong for building a table. (p.&nbsp;96)</p>
</blockquote>
</section>
<section id="rethinking-prior-predictive-simulation-and-p-hacking" class="level5" data-number="4.4.1.3.2">
<h5 data-number="4.4.1.3.2" class="anchored" data-anchor-id="rethinking-prior-predictive-simulation-and-p-hacking"><span class="header-section-number">4.4.1.3.2</span> Rethinking: Prior predictive simulation and <span class="math inline">\(p\)</span>-hacking</h5>
<p>“We don’t pay any attention to <span class="math inline">\(p\)</span>-values in this book” (p.&nbsp;97). Off hand, I’m not sure of the exact origin of the term <span class="math inline">\(p\)</span>-hacking. But the paper by Simmons, Nelson and Simonsohn <span class="citation" data-cites="simmonsFalsepositivePsychologyUndisclosed2011">(<a href="references.html#ref-simmonsFalsepositivePsychologyUndisclosed2011" role="doc-biblioref">2011</a>)</span>, <a href="https://doi.org/10.1177/0956797611417632"><em>False-positive psychology: Undisclosed flexibility in data collection and analysis allows presenting anything as significant</em></a>, is often cited as an introduction to the problem.</p>
</section>
</section>
</section>
<section id="finding-the-posterior-distribution" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="finding-the-posterior-distribution"><span class="header-section-number">4.4.2</span> Finding the posterior distribution</h3>
<p>Unlike with McElreath’s <code>quap()</code> formula syntax, I’m not aware that you can just specify something like <code>weight – xbar</code> in the <code>formula</code> argument in <code>brm()</code>. However, the alternative is easy: Just make a new variable in the data that is equivalent to <code>weight – mean(weight)</code>. We’ll call it <code>weight_c</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> d2 <span class="sc">|&gt;</span> </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_c =</span> weight <span class="sc">-</span> <span class="fu">mean</span>(weight))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unlike with McElreath’s <strong>rethinking</strong> package, the conventional <code>brms::brm()</code> syntax doesn’t mirror the statistical notation. But here are the analogues to the exposition at the bottom of page 97:</p>
<ul>
<li><span class="math inline">\(\text{height}_i \sim \operatorname{Normal}(\mu_i, \sigma)\)</span>: <code>family = gaussian</code>,</li>
<li><span class="math inline">\(\mu_i = \alpha + \beta \text{weight}_i\)</span>: <code>height ~ 1 + weight_c</code>,</li>
<li><span class="math inline">\(\alpha \sim \operatorname{Normal}(178, 20)\)</span>: <code>prior(normal(178, 20), class = Intercept</code>,</li>
<li><span class="math inline">\(\beta \sim \operatorname{Log-Normal}(0, 1)\)</span>: <code>prior(lognormal(0, 1), class = b)</code>, and</li>
<li><span class="math inline">\(\sigma \sim \operatorname{Uniform}(0, 50)\)</span>: <code>prior(uniform(0, 50), class = sigma)</code>.</li>
</ul>
<p>Thus, to add a predictor you just the <code>+</code> operator in the model <code>formula</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d2, </span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>  height <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> weight_c,</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">178</span>, <span class="dv">20</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b),</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> sigma, <span class="at">ub =</span> <span class="dv">50</span>)),</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.03"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the trace plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(b4<span class="fl">.3</span>, <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-77-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<section id="sec-Overthinking-Logs-and-exps" class="level4" data-number="4.4.2.1">
<h4 data-number="4.4.2.1" class="anchored" data-anchor-id="sec-Overthinking-Logs-and-exps"><span class="header-section-number">4.4.2.1</span> Overthinking: Logs and exps, oh my</h4>
<p><strong>brms</strong> does not allow users to insert coefficients into functions like <span class="math inline">\(\exp()\)</span> within the conventional <code>formula</code> syntax. We can fit a <strong>brms</strong> model like McElreath’s <code>m4.3b</code> if we adopt what’s called the non-linear syntax <span class="citation" data-cites="Bürkner2022Non_linear">(<a href="references.html#ref-Bürkner2022Non_linear" role="doc-biblioref">Bürkner, 2022b</a>)</span>. The non-linear syntax is a lot like the syntax McElreath uses in <strong>rethinking</strong> in that it typically includes both predictor and variable names in the <code>formula</code>. Since this is so early in the book and we’re just working through a problem in an <strong>Overthinking</strong> tangent, I won’t go into a full-blown explanation, here. There will be many more opportunities to practice with the non-linear syntax in the chapters to come (e.g., <a href="05.html#sec-Many-categories" class="quarto-xref"><span>Section 5.3.2</span></a>, <a href="06.html#sec-A-prior-is-born" class="quarto-xref"><span>Section 6.2.1</span></a>). For now, here’s how we might fit the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.3</span>b <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d2, </span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(height <span class="sc">~</span> a <span class="sc">+</span> <span class="fu">exp</span>(lb) <span class="sc">*</span> weight_c,</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>     a <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>     lb <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">nl =</span> <span class="cn">TRUE</span>),</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">178</span>, <span class="dv">20</span>), <span class="at">class =</span> b, <span class="at">nlpar =</span> a),</span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b, <span class="at">nlpar =</span> lb),</span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> sigma, <span class="at">ub =</span> <span class="dv">50</span>)),</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.03b"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you execute <code>summary(b4.3b)</code>, you’ll see the intercept and <span class="math inline">\(\sigma\)</span> summaries for this model are about the same as those for <code>b4.3</code>, above. The difference is for the <span class="math inline">\(\beta\)</span> parameter, which we called <code>lb</code> in the <code>b4.3b</code> model. If we term that parameter from <code>b4.3</code> as <span class="math inline">\(\beta^\text{b4.3}\)</span> and the one from our new model <span class="math inline">\(\beta^\text{b4.3b}\)</span>, it turns out that <span class="math inline">\(\beta^\text{b4.3} = \exp \left (\beta^\text{b4.3b} \right )\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(b4<span class="fl">.3</span>)[<span class="st">"weight_c"</span>, <span class="st">"Estimate"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9044572</code></pre>
</div>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(b4<span class="fl">.3</span>b)[<span class="st">"lb_Intercept"</span>, <span class="st">"Estimate"</span>] <span class="sc">|&gt;</span> <span class="fu">exp</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9028642</code></pre>
</div>
</div>
<p>They’re the same within simulation variance.</p>
</section>
</section>
<section id="interpreting-the-posterior-distribution" class="level3" data-number="4.4.3">
<h3 data-number="4.4.3" class="anchored" data-anchor-id="interpreting-the-posterior-distribution"><span class="header-section-number">4.4.3</span> Interpreting the posterior distribution</h3>
<p>“One trouble with statistical models is that they are hard to understand” (p.&nbsp;99). Welcome to the world of applied statistics, friends. 😅</p>
<section id="rethinking-what-do-parameters-mean" class="level5" data-number="4.4.3.0.1">
<h5 data-number="4.4.3.0.1" class="anchored" data-anchor-id="rethinking-what-do-parameters-mean"><span class="header-section-number">4.4.3.0.1</span> Rethinking: What do parameters mean?</h5>
<blockquote class="blockquote">
<p>A basic issue with interpreting model-based estimates is in knowing the meaning of parameters. There is no consensus about what a parameter means, however, because different people take different philosophical stances towards models, probability, and prediction. The perspective in this book is a common Bayesian perspective: <em>Posterior probabilities of parameter values describe the relative compatibility of different states of the world with the data, according to the model</em>. (p.&nbsp;99, <em>emphasis</em> in the original)</p>
</blockquote>
</section>
<section id="tables-of-marginal-distributions" class="level4" data-number="4.4.3.1">
<h4 data-number="4.4.3.1" class="anchored" data-anchor-id="tables-of-marginal-distributions"><span class="header-section-number">4.4.3.1</span> Tables of marginal distributions</h4>
<p>With a little <code>[]</code> subsetting we can exclude the log posterior from our summary for <code>b4.3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_summary</span>(b4<span class="fl">.3</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, ] <span class="sc">|&gt;</span> </span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Estimate Est.Error   Q2.5  Q97.5
b_Intercept   154.60      0.27 154.06 155.12
b_weight_c      0.90      0.04   0.82   0.99
sigma           5.11      0.20   4.73   5.53</code></pre>
</div>
</div>
<p>If we put our <strong>brms</strong> fit into the <code>vcov()</code> function, we’ll get the variance/covariance matrix of the intercept and <code>weight_c</code> coefficient.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vcov</span>(b4<span class="fl">.3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Intercept weight_c
Intercept     0.075    0.000
weight_c      0.000    0.002</code></pre>
</div>
</div>
<p>No <span class="math inline">\(\sigma\)</span>, however. To get that, we’ll have to extract the posterior draws and use the <code>cov()</code> function, instead.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(b4<span class="fl">.3</span>) <span class="sc">|&gt;</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(b_Intercept<span class="sc">:</span>sigma) <span class="sc">|&gt;</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov</span>() <span class="sc">|&gt;</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            b_Intercept b_weight_c sigma
b_Intercept       0.075      0.000 0.000
b_weight_c        0.000      0.002 0.000
sigma             0.000      0.000 0.039</code></pre>
</div>
</div>
<p>The <code>pairs()</code> function will work for a <strong>brms</strong> fit much like it would one from <strong>rethinking</strong>. It will show “both the marginal posteriors and the covariance” (p.&nbsp;100).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(b4<span class="fl">.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-82-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plotting-posterior-inference-against-the-data" class="level4" data-number="4.4.3.2">
<h4 data-number="4.4.3.2" class="anchored" data-anchor-id="plotting-posterior-inference-against-the-data"><span class="header-section-number">4.4.3.2</span> Plotting posterior inference against the data</h4>
<p>“It’s almost always much more useful to plot the posterior inference against the data. Not only does plotting help in interpreting the posterior, but it also provides an informal check on model assumptions” (p.&nbsp;100).</p>
<p>Here is the code for Figure 4.6. Note our use of the <code>fixef()</code> function within <code>geom_abline()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="sc">|&gt;</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight_c, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="fu">fixef</span>(b4<span class="fl">.3</span>)[<span class="dv">1</span>], </span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">slope     =</span> <span class="fu">fixef</span>(b4<span class="fl">.3</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"royalblue"</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-83-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>Note how the breaks on our <span class="math inline">\(x\)</span>-axis look off. That’s because we fit the model with <code>weight_c</code> and we plotted the points in that metric, too. Since we computed <code>weight_c</code> by subtracting the mean of <code>weight</code> from the data, we can adjust the <span class="math inline">\(x\)</span>-axis break point labels by simply adding that value back.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">10</span>) <span class="sc">+</span> <span class="fu">mean</span>(d2<span class="sc">$</span>weight) <span class="sc">|&gt;</span> </span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">0</span>)</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>d2 <span class="sc">|&gt;</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight_c, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="fu">fixef</span>(b4<span class="fl">.3</span>)[<span class="dv">1</span>], </span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">slope     =</span> <span class="fu">fixef</span>(b4<span class="fl">.3</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"royalblue"</span>) <span class="sc">+</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"weight"</span>,</span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> labels) <span class="sc">+</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-84-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="adding-uncertainty-around-the-mean" class="level4" data-number="4.4.3.3">
<h4 data-number="4.4.3.3" class="anchored" data-anchor-id="adding-uncertainty-around-the-mean"><span class="header-section-number">4.4.3.3</span> Adding uncertainty around the mean</h4>
<p>Be default, we extract all the posterior draws with <code>as_draws_df()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b4<span class="fl">.3</span>)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)  <span class="co"># This serves a similar function as `head()`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A draws_df: 5 iterations, 1 chains, and 6 variables
  b_Intercept b_weight_c sigma Intercept lprior  lp__
1         155       0.88   5.2       155   -9.3 -1079
2         154       0.96   5.3       154   -9.4 -1080
3         155       0.85   4.9       155   -9.3 -1080
4         155       0.98   5.2       155   -9.4 -1081
5         154       0.99   5.6       154   -9.5 -1087
# ... hidden reserved variables {'.chain', '.iteration', '.draw'}</code></pre>
</div>
</div>
<p>Here are the four models leading up to McElreath’s Figure 4.7.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.3</span>_010 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d2 <span class="sc">|&gt;</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>N),  <span class="co"># Note our tricky use of `N` and `slice()`</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>  height <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> weight_c,</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">178</span>, <span class="dv">20</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b),</span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> sigma, <span class="at">ub =</span> <span class="dv">50</span>)),</span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.03_010"</span>)</span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.3</span>_050 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d2 <span class="sc">|&gt;</span></span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>N), </span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a>  height <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> weight_c,</span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">178</span>, <span class="dv">20</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b),</span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> sigma, <span class="at">ub =</span> <span class="dv">50</span>)),</span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb147-26"><a href="#cb147-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb147-27"><a href="#cb147-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.03_050"</span>)</span>
<span id="cb147-28"><a href="#cb147-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-29"><a href="#cb147-29" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb147-30"><a href="#cb147-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-31"><a href="#cb147-31" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.3</span>_150 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb147-32"><a href="#cb147-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d2 <span class="sc">|&gt;</span></span>
<span id="cb147-33"><a href="#cb147-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>N), </span>
<span id="cb147-34"><a href="#cb147-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb147-35"><a href="#cb147-35" aria-hidden="true" tabindex="-1"></a>  height <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> weight_c,</span>
<span id="cb147-36"><a href="#cb147-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">178</span>, <span class="dv">20</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb147-37"><a href="#cb147-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b),</span>
<span id="cb147-38"><a href="#cb147-38" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> sigma, <span class="at">ub =</span> <span class="dv">50</span>)),</span>
<span id="cb147-39"><a href="#cb147-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb147-40"><a href="#cb147-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb147-41"><a href="#cb147-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.03_150"</span>)</span>
<span id="cb147-42"><a href="#cb147-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-43"><a href="#cb147-43" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">352</span></span>
<span id="cb147-44"><a href="#cb147-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-45"><a href="#cb147-45" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.3</span>_352 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb147-46"><a href="#cb147-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d2 <span class="sc">|&gt;</span></span>
<span id="cb147-47"><a href="#cb147-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>N), </span>
<span id="cb147-48"><a href="#cb147-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb147-49"><a href="#cb147-49" aria-hidden="true" tabindex="-1"></a>  height <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> weight_c,</span>
<span id="cb147-50"><a href="#cb147-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">178</span>, <span class="dv">20</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb147-51"><a href="#cb147-51" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b),</span>
<span id="cb147-52"><a href="#cb147-52" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> sigma, <span class="at">ub =</span> <span class="dv">50</span>)),</span>
<span id="cb147-53"><a href="#cb147-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb147-54"><a href="#cb147-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb147-55"><a href="#cb147-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.03_352"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’m not going to clutter up the document with all the trace plots and coefficient summaries from these four models. But here’s how to get that information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(b4<span class="fl">.3</span>_010)</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b4<span class="fl">.3</span>_010)</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(b4<span class="fl">.3</span>_050)</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b4<span class="fl">.3</span>_050)</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(b4<span class="fl">.3</span>_150)</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b4<span class="fl">.3</span>_150)</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(b4<span class="fl">.3</span>_352)</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b4<span class="fl">.3</span>_352)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll need to put the chains of each model into data frames.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>post010 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b4<span class="fl">.3</span>_010)</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>post050 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b4<span class="fl">.3</span>_050)</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>post150 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b4<span class="fl">.3</span>_150)</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>post352 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b4<span class="fl">.3</span>_352)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the code for the four individual plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span>  d2[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ], </span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> weight_c, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> post010 <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>),</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">intercept =</span> b_Intercept, <span class="at">slope =</span> b_weight_c),</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"royalblue"</span>) <span class="sc">+</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight_c),</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>height)) <span class="sc">+</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"N = 10"</span>)</span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span>  d2[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, ], </span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> weight_c, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> post050 <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>),</span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">intercept =</span> b_Intercept, <span class="at">slope =</span> b_weight_c),</span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"royalblue"</span>) <span class="sc">+</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight_c),</span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>height)) <span class="sc">+</span></span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"N = 50"</span>)</span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span>  d2[<span class="dv">1</span><span class="sc">:</span><span class="dv">150</span>, ], </span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> weight_c, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> post150 <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>),</span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">intercept =</span> b_Intercept, <span class="at">slope =</span> b_weight_c),</span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"royalblue"</span>) <span class="sc">+</span></span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight_c),</span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>height)) <span class="sc">+</span></span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"N = 150"</span>)</span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-31"><a href="#cb150-31" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span>  d2[<span class="dv">1</span><span class="sc">:</span><span class="dv">352</span>, ], </span>
<span id="cb150-32"><a href="#cb150-32" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> weight_c, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb150-33"><a href="#cb150-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> post352 <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>),</span>
<span id="cb150-34"><a href="#cb150-34" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">intercept =</span> b_Intercept, <span class="at">slope =</span> b_weight_c),</span>
<span id="cb150-35"><a href="#cb150-35" aria-hidden="true" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb150-36"><a href="#cb150-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"royalblue"</span>) <span class="sc">+</span></span>
<span id="cb150-37"><a href="#cb150-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight_c),</span>
<span id="cb150-38"><a href="#cb150-38" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>height)) <span class="sc">+</span></span>
<span id="cb150-39"><a href="#cb150-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"N = 352"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can combine the ggplots with <strong>patchwork</strong> syntax to make the full version of Figure 4.7.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3 <span class="sc">+</span> p4) <span class="sc">&amp;</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"weight"</span>,</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> labels) <span class="sc">&amp;</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-89-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>“Notice that the cloud of regression lines grows more compact as the sample size increases. This is a result of the model growing more confident about the location of the mean” (p.&nbsp;102).</p>
</section>
<section id="plotting-regression-intervals-and-contours" class="level4" data-number="4.4.3.4">
<h4 data-number="4.4.3.4" class="anchored" data-anchor-id="plotting-regression-intervals-and-contours"><span class="header-section-number">4.4.3.4</span> Plotting regression intervals and contours</h4>
<p>Since we used <code>weight_c</code> to fit our model, we might first want to understand what exactly the mean value is for <code>weight</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(d2<span class="sc">$</span>weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 44.99049</code></pre>
</div>
</div>
<p>Just a hair under 45. If we’re interested in <span class="math inline">\(\mu\)</span> at <code>weight</code> = 50, that implies we’re also interested in <span class="math inline">\(\mu\)</span> at <code>weight_c</code> + 5.01. Within the context of our model, we compute this with <span class="math inline">\(\alpha + \beta \cdot 5.01\)</span>. Here’s what that looks like with <code>post</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>mu_at_50 <span class="ot">&lt;-</span> post <span class="sc">|&gt;</span> </span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">mu_at_50 =</span> b_Intercept <span class="sc">+</span> b_weight_c <span class="sc">*</span> <span class="fl">5.01</span>)</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mu_at_50)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 1
  mu_at_50
     &lt;dbl&gt;
1     159.
2     159.
3     159.
4     160.
5     159.
6     159.</code></pre>
</div>
</div>
<p>And here is a version McElreath’s Figure 4.8 density plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>mu_at_50 <span class="sc">|&gt;</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu_at_50)) <span class="sc">+</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">linewidth =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"royalblue"</span>) <span class="sc">+</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(mu[<span class="st">"height | weight = 50"</span>])) <span class="sc">+</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-92-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>We’ll use <code>mean_hdi()</code> to get both 89% and 95% HPDIs along with the mean.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean_hdi</span>(mu_at_50[, <span class="dv">1</span>], <span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.89</span>, <span class="fl">0.95</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  mu_at_50 .lower .upper .width .point .interval
     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1     159.   159.   160.   0.89 mean   hdi      
2     159.   158.   160.   0.95 mean   hdi      </code></pre>
</div>
</div>
<p>If you wanted to express those sweet 95% HPDIs on your density plot, you might use <code>tidybayes::stat_halfeye()</code>. Since <code>stat_halfeye()</code> also returns a point estimate, we’ll throw in the mode.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>mu_at_50 <span class="sc">|&gt;</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu_at_50, <span class="at">y =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(<span class="at">point_interval =</span> mode_hdi, <span class="at">.width =</span> <span class="fl">0.95</span>,</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">"royalblue"</span>) <span class="sc">+</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(mu[<span class="st">"height | weight = 50"</span>])) <span class="sc">+</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-94-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>With <strong>brms</strong>, you would use <code>fitted()</code> to do what McElreath accomplished with <code>link()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b4<span class="fl">.3</span>, <span class="at">summary =</span> F)</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(mu)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:4000, 1:352] 157 157 157 157 157 ...</code></pre>
</div>
</div>
<p>When you specify <code>summary = F</code>, <code>fitted()</code> returns a matrix of values with as many rows as there were post-warmup draws across your HMC chains and as many columns as there were cases in your analysis. Because we had 4,000 post-warmup draws and <span class="math inline">\(n = 352\)</span>, <code>fitted()</code> returned a matrix of 4,000 rows and 352 vectors. If you omitted the <code>summary = F</code> argument, the default is <code>TRUE</code> and <code>fitted()</code> will return summary information instead.</p>
<p>Much like <strong>rethinking</strong>’s <code>link()</code>, <code>brms::fitted()</code> can accommodate custom predictor values with its <code>newdata</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>weight_seq <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">weight =</span> <span class="dv">25</span><span class="sc">:</span><span class="dv">70</span>) <span class="sc">|&gt;</span> </span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_c =</span> weight <span class="sc">-</span> <span class="fu">mean</span>(d2<span class="sc">$</span>weight))</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b4<span class="fl">.3</span>,</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">summary =</span> F,</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">newdata =</span> weight_seq) <span class="sc">|&gt;</span></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we name the columns after the `weight` values from which they were computed</span></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="dv">25</span><span class="sc">:</span><span class="dv">70</span>) <span class="sc">|&gt;</span> </span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">iter =</span> <span class="fu">row_number</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Anticipating <strong>ggplot2</strong>, we went ahead and converted the output to a data frame. But we might do a little more data processing with the aid of <code>tidyr::pivot_longer()</code>, which will convert the data from the wide format to the long format. If you are new to the distinction between wide and long data, you can learn more from the <a href="https://tidyr.tidyverse.org/reference/pivot_longer.html"><em>Pivot data from wide to long</em></a> vignette from the <strong>tidyverse</strong> team <span class="citation" data-cites="PivotDataWide2020">(<a href="references.html#ref-PivotDataWide2020" role="doc-biblioref">2020</a>)</span>; Simon Ejdemyr’s blog post, <a href="https://sejdemyr.github.io/r-tutorials/basics/wide-and-long/"><em>Wide &amp; long data</em></a>; or Karen Grace-Martin’s blog post, <a href="https://www.theanalysisfactor.com/wide-and-long-data/"><em>The wide and long data format for repeated measures data</em></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> mu <span class="sc">|&gt;</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>iter,</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"weight"</span>,</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"height"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We might reformat `weight` to numerals</span></span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> <span class="fu">as.numeric</span>(weight))</span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mu)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
   iter weight height
  &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1     1     25   137.
2     1     26   138.
3     1     27   139.
4     1     28   140.
5     1     29   141.
6     1     30   142.</code></pre>
</div>
</div>
<p>Now our data processing is done, here we reproduce McElreath’s Figure 4.9.a.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="sc">|&gt;</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> mu <span class="sc">|&gt;</span> <span class="fu">filter</span>(iter <span class="sc">&lt;</span> <span class="dv">101</span>), </span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="at">color =</span> <span class="st">"navyblue"</span>) <span class="sc">+</span></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">65</span>)) <span class="sc">+</span></span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-98-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>With <code>fitted()</code>, it’s quite easy to plot a regression line and its intervals. Just omit the <code>summary = T</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>mu_summary <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b4<span class="fl">.3</span>, <span class="at">newdata =</span> weight_seq) <span class="sc">|&gt;</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(weight_seq)</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mu_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Estimate Est.Error     Q2.5    Q97.5 weight  weight_c
1 136.5198 0.8960037 134.7233 138.2592     25 -19.99049
2 137.4242 0.8557114 135.7132 139.0705     26 -18.99049
3 138.3287 0.8156337 136.6969 139.8883     27 -17.99049
4 139.2331 0.7758038 137.6715 140.7152     28 -16.99049
5 140.1376 0.7362619 138.6654 141.5488     29 -15.99049
6 141.0421 0.6970569 139.6356 142.3799     30 -14.99049</code></pre>
</div>
</div>
<p>Here it is, our analogue to Figure 4.9.b.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="sc">|&gt;</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">data =</span> mu_summary,</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">y =</span> Estimate, <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">stat =</span> <span class="st">"identity"</span>,</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey70"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"navyblue"</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight)) <span class="sc">+</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Times"</span>),</span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-100-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>If you wanted to use intervals other than the default 95% ones, you’d include the <code>probs</code> argument like this: <code>fitted(b4.3, newdata = weight.seq, probs = c(0.25, 0.75))</code>. The resulting third and fourth vectors from the <code>fitted()</code> object would be named <code>Q25</code> and <code>Q75</code> instead of the default <code>Q2.5</code> and <code>Q97.5</code>. The <a href="https://github.com/paul-buerkner/brms/issues/425"><code>Q</code> prefix</a> stands for quantile.</p>
<section id="rethinking-overconfident-intervals" class="level5" data-number="4.4.3.4.1">
<h5 data-number="4.4.3.4.1" class="anchored" data-anchor-id="rethinking-overconfident-intervals"><span class="header-section-number">4.4.3.4.1</span> Rethinking: Overconfident intervals</h5>
<blockquote class="blockquote">
<p>The compatibility interval for the regression line in Figure 4.9 clings tightly to the MAP line. Thus there is very little uncertainty about the average height as a function of average weight. But you have to keep in mind that these inferences are always conditional on the model. Even a very bad model can have very tight compatibility intervals. It may help if you think of the regression line in Figure 4.9 as saying: <em>Conditional on the assumption that height and weight are related by a straight line, then this is the most plausible line, and these are its plausible bounds</em>. (p.&nbsp;107, <em>emphasis</em> in the original)</p>
</blockquote>
</section>
<section id="overthinking-how-link-fitted-works" class="level5" data-number="4.4.3.4.2">
<h5 data-number="4.4.3.4.2" class="anchored" data-anchor-id="overthinking-how-link-fitted-works"><span class="header-section-number">4.4.3.4.2</span> Overthinking: How <del>link</del> <code>fitted()</code> works</h5>
<p>Similar to <code>rethinking::link()</code>, <code>brms::fitted()</code> uses the formula from your model to compute the model expectations for a given set of predictor values. I use it a lot in this project. If you follow along, you’ll get a good handle on it. But to dive deeper, you can go <a href="https://rdrr.io/cran/brms/man/fitted.brmsfit.html">here</a> for the documentation. Though we won’t be using it in this project, <strong>brms</strong> users might want to know that <code>fitted()</code> is also an alias for the <code>posterior_epred()</code> function, about which you might learn more <a href="https://rdrr.io/cran/brms/man/posterior_epred.brmsfit.html">here</a>. Users can always learn more about them and other functions in the <a href="https://CRAN.R-project.org/package=brms/brms.pdf"><strong>brms</strong> reference manual</a>.</p>
</section>
</section>
<section id="sec-Prediction-intervals" class="level4" data-number="4.4.3.5">
<h4 data-number="4.4.3.5" class="anchored" data-anchor-id="sec-Prediction-intervals"><span class="header-section-number">4.4.3.5</span> Prediction intervals</h4>
<p>Even though our statistical model (omitting priors for the sake of simplicity) is</p>
<p><span class="math display">\[\text{height}_i \sim \operatorname{Normal}(\mu_i = \alpha + \beta x_, \sigma),\]</span></p>
<p>we’ve only been plotting the <span class="math inline">\(\mu\)</span> part. In order to bring in the variability expressed by <span class="math inline">\(\sigma\)</span>, we’ll have to switch to the <code>predict()</code> function. Much as <code>brms::fitted()</code> was our analogue to <code>rethinking::link()</code>, <code>brms::predict()</code> is our analogue to <code>rethinking::sim()</code>.</p>
<p>We can reuse our <code>weight_seq</code> data from before. But in case you forgot, here’s that code again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>weight_seq <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">weight =</span> <span class="dv">25</span><span class="sc">:</span><span class="dv">70</span>) <span class="sc">|&gt;</span> </span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_c =</span> weight <span class="sc">-</span> <span class="fu">mean</span>(d2<span class="sc">$</span>weight))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>predict()</code> code looks a lot like what we used for <code>fitted()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>pred_height <span class="ot">&lt;-</span> <span class="fu">predict</span>(b4<span class="fl">.3</span>, <span class="at">newdata =</span> weight_seq) <span class="sc">|&gt;</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(weight_seq)</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>pred_height <span class="sc">|&gt;</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Estimate Est.Error     Q2.5    Q97.5 weight  weight_c
1 136.5864  5.183359 126.5446 146.9381     25 -19.99049
2 137.2358  5.143941 127.0908 147.1680     26 -18.99049
3 138.3768  5.251728 128.1949 148.9343     27 -17.99049
4 139.2185  5.142894 129.2181 149.4509     28 -16.99049
5 139.9605  5.166576 129.9273 150.0306     29 -15.99049
6 140.9982  5.089318 130.7314 151.1074     30 -14.99049</code></pre>
</div>
</div>
<p>This time the summary information in our data frame is for, as McElreath put it, “simulated heights, not distributions of plausible average height, <span class="math inline">\(\mu\)</span>” (p.&nbsp;108). Another way of saying that is that these simulations are the joint consequence of both <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>, unlike the results of <code>fitted()</code>, which only reflect <span class="math inline">\(\mu\)</span>. Figure 4.10 shows how you might visualize them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="sc">|&gt;</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight)) <span class="sc">+</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> pred_height, </span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey83"</span>) <span class="sc">+</span></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">data =</span> mu_summary,</span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">y =</span> Estimate, <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">stat =</span> <span class="st">"identity"</span>,</span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey70"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> height),</span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"navyblue"</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb172-12"><a href="#cb172-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight),</span>
<span id="cb172-13"><a href="#cb172-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>height)) <span class="sc">+</span></span>
<span id="cb172-14"><a href="#cb172-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Times"</span>),</span>
<span id="cb172-15"><a href="#cb172-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-103-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>Notice that the outline for the wide shaded interval is a little rough. This is the simulation variance in the tails of the sampled Gaussian values. If it really bothers you, increase the number of samples you take from the posterior distribution. (p.&nbsp;109)</p>
</blockquote>
<p>With our <strong>brms</strong> model fitting approach, that would mean we’d have to refit <code>b4.3</code> after specifying a larger number of post-warmup iterations with alterations to the <code>iter</code> and <code>warmup</code> parameters.</p>
<section id="overthinking-rolling-your-own-sim-predict" class="level5" data-number="4.4.3.5.1">
<h5 data-number="4.4.3.5.1" class="anchored" data-anchor-id="overthinking-rolling-your-own-sim-predict"><span class="header-section-number">4.4.3.5.1</span> Overthinking: Rolling your own <del>sim</del> <code>predict()</code></h5>
<p>Here we follow McElreath’s example and do our model-based predictions by hand. Instead of relying on base <strong>R</strong> <code>apply()</code> and <code>sapply()</code>, here the main action is in <code>expand_grid()</code>, the second <code>mutate()</code> line and the <code>group_by()</code> + <code>summarise()</code> combination.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co"># `predict()` by hand</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span> </span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">weight =</span> <span class="dv">25</span><span class="sc">:</span><span class="dv">70</span>) <span class="sc">|&gt;</span> </span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_c =</span> weight <span class="sc">-</span> <span class="fu">mean</span>(d2<span class="sc">$</span>weight)) <span class="sc">|&gt;</span> </span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sim_height =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(),</span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">mean =</span> b_Intercept <span class="sc">+</span> b_weight_c <span class="sc">*</span> weight_c,</span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sd   =</span> sigma)) <span class="sc">|&gt;</span> </span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(weight) <span class="sc">|&gt;</span> </span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(sim_height),</span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll   =</span> <span class="fu">quantile</span>(sim_height, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul   =</span> <span class="fu">quantile</span>(sim_height, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight)) <span class="sc">+</span></span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean, <span class="at">ymin =</span> ll, <span class="at">ymax =</span> ul),</span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">stat =</span> <span class="st">"identity"</span>,</span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey83"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> d2,</span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> height),</span>
<span id="cb173-22"><a href="#cb173-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"navyblue"</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb173-23"><a href="#cb173-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight),</span>
<span id="cb173-24"><a href="#cb173-24" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>height)) <span class="sc">+</span></span>
<span id="cb173-25"><a href="#cb173-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Times"</span>),</span>
<span id="cb173-26"><a href="#cb173-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-104-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>We specifically left out the <code>fitted()</code> intervals to make it more apparent what we were simulating. You might also note that we could have easily replaced that three-line <code>summarise()</code> code with a single line of <code>tidybayes::mean_qi(sim_height)</code>, or whatever combination of central tendency and interval type you wanted (e.g., <code>mode_hdi(sim_height, .width = 0.89)</code>).</p>
</section>
</section>
</section>
</section>
<section id="curves-from-lines" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="curves-from-lines"><span class="header-section-number">4.5</span> Curves from lines</h2>
<p>“The models so far all assume that a straight line describes the relationship. But there’s nothing special about straight lines, aside from their simplicity.” (p.&nbsp;110).</p>
<section id="sec-Polynomial-regression" class="level3" data-number="4.5.1">
<h3 data-number="4.5.1" class="anchored" data-anchor-id="sec-Polynomial-regression"><span class="header-section-number">4.5.1</span> Polynomial regression</h3>
<p>Remember <code>d</code>?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 544
Columns: 4
$ height &lt;dbl&gt; 151.7650, 139.7000, 136.5250, 156.8450, 145.4150, 163.8300, 149.2250, 168.9100, 147.9550, 165.1000, 154.3050, 151…
$ weight &lt;dbl&gt; 47.82561, 36.48581, 31.86484, 53.04191, 41.27687, 62.99259, 38.24348, 55.47997, 34.86988, 54.48774, 49.89512, 41.…
$ age    &lt;dbl&gt; 63.0, 63.0, 65.0, 41.0, 51.0, 35.0, 32.0, 27.0, 19.0, 54.0, 47.0, 66.0, 73.0, 20.0, 65.3, 36.0, 44.0, 31.0, 12.0,…
$ male   &lt;int&gt; 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 0,…</code></pre>
</div>
</div>
<p>McElreath suggested we plot <code>height</code> against <code>weight</code> using the full sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"navyblue"</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>,</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="dv">42</span>, <span class="at">y =</span> <span class="dv">115</span>,</span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"This relation is</span><span class="sc">\n</span><span class="st">visibly curved."</span>,</span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">family =</span> <span class="st">"Times"</span>) <span class="sc">+</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Times"</span>),</span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-106-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>Those variables two appear to follow an orderly relation, but whatever it is, it’s clearly not a simple straight line. The quadratic model is probably the most commonly used polynomial regression model. It follows the generic form</p>
<p><span class="math display">\[\mu = \alpha + \beta_1 x_i + \color{navy}{\beta_2 x_i^2}.\]</span></p>
<p>McElreath warned: “Fitting these models to data is easy. Interpreting them can be hard” (p.&nbsp;111). Standardizing will help <code>brm()</code> fit the model. We might standardize our <code>weight</code> variable like so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_s =</span> (weight <span class="sc">-</span> <span class="fu">mean</span>(weight)) <span class="sc">/</span> <span class="fu">sd</span>(weight)) <span class="sc">|&gt;</span> </span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_s2 =</span> weight_s<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>While we were at it, we just went ahead and computed the <code>weight_s2</code> variable. We can express our statistical model as</p>
<p><span class="math display">\[\begin{align*}
\text{height}_i &amp; \sim \operatorname{Normal}(\mu_i, \sigma) \\
\mu_i   &amp; = \alpha + \beta_1 \text{weight_s}_i + \color{navy}{\beta_2 \text{weight_s}^2_i} \\
\alpha  &amp; \sim \operatorname{Normal}(178, 20) \\
\beta_1 &amp; \sim \operatorname{Log-Normal}(0, 1) \\
\color{navy}{\beta_2} &amp; \color{navy}\sim \color{navy}{\operatorname{Normal}(0, 1)} \\
\sigma  &amp; \sim \operatorname{Uniform}(0, 50).
\end{align*}\]</span></p>
<p>Here’s how we might fit the quadratic model with <strong>brms</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>  height <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> weight_s <span class="sc">+</span> weight_s2,</span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">178</span>, <span class="dv">20</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b, <span class="at">coef =</span> <span class="st">"weight_s"</span>),</span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b, <span class="at">coef =</span> <span class="st">"weight_s2"</span>),</span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> sigma, <span class="at">ub =</span> <span class="dv">50</span>)),</span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.05"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note our use of the <code>coef</code> argument within our prior statements. Since <span class="math inline">\(\beta_1\)</span> and <span class="math inline">\(\beta_2\)</span> are both parameters of <code>class = b</code> within the <strong>brms</strong> set-up, we need to use the <code>coef</code> argument when we want their priors to differ.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(b4<span class="fl">.5</span>, <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-108-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b4<span class="fl">.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: height ~ 1 + weight_s + weight_s2 
   Data: d (Number of observations: 544) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept   146.05      0.37   145.32   146.76 1.00     3313     3090
weight_s     21.73      0.29    21.15    22.32 1.00     2859     2957
weight_s2    -7.80      0.28    -8.34    -7.24 1.00     3017     3089

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     5.80      0.18     5.45     6.15 1.00     3416     2744

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Our quadratic plot requires new <code>fitted()</code>- and <code>predict()</code>-oriented wrangling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>weight_seq <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">weight_s =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="fl">2.5</span>, <span class="at">to =</span> <span class="fl">2.5</span>, <span class="at">length.out =</span> <span class="dv">30</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_s2 =</span> weight_s<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>fitd_quad <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b4<span class="fl">.5</span>, <span class="at">newdata =</span> weight_seq) <span class="sc">|&gt;</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(weight_seq)</span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a>pred_quad <span class="ot">&lt;-</span> <span class="fu">predict</span>(b4<span class="fl">.5</span>, <span class="at">newdata =</span> weight_seq) <span class="sc">|&gt;</span></span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(weight_seq)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Behold the code for our version of Figure 4.11.b.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> d, </span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> weight_s)) <span class="sc">+</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> pred_quad, </span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey83"</span>) <span class="sc">+</span></span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">data =</span> fitd_quad,</span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">y =</span> Estimate, <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">stat =</span> <span class="st">"identity"</span>,</span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey70"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> height),</span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"navyblue"</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"height"</span>,</span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"quadratic"</span>) <span class="sc">+</span></span>
<span id="cb183-14"><a href="#cb183-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d<span class="sc">$</span>weight_s),</span>
<span id="cb183-15"><a href="#cb183-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d<span class="sc">$</span>height)) <span class="sc">+</span></span>
<span id="cb183-16"><a href="#cb183-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Times"</span>),</span>
<span id="cb183-17"><a href="#cb183-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span>
<span id="cb183-18"><a href="#cb183-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-19"><a href="#cb183-19" aria-hidden="true" tabindex="-1"></a>p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-110-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>From a formula perspective, the cubic model is a simple extension of the quadratic:</p>
<p><span class="math display">\[\mu = \alpha + \beta_1 x_i + \beta_2 x_i^2 + \beta_3 x_i^3.\]</span></p>
<p>Before we fit the model, we need to wrangle the data again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_s3 =</span> weight_s<span class="sc">^</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now fit the model like so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>  height <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> weight_s <span class="sc">+</span> weight_s2 <span class="sc">+</span> weight_s3,</span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">178</span>, <span class="dv">20</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b, <span class="at">coef =</span> <span class="st">"weight_s"</span>),</span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b, <span class="at">coef =</span> <span class="st">"weight_s2"</span>),</span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b, <span class="at">coef =</span> <span class="st">"weight_s3"</span>),</span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> sigma, <span class="at">ub =</span> <span class="dv">50</span>)),</span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.06"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we’ll fit the good old linear model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>  height <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> weight_s,</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">178</span>, <span class="dv">20</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b, <span class="at">coef =</span> <span class="st">"weight_s"</span>),</span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> sigma, <span class="at">ub =</span> <span class="dv">50</span>)),</span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.07"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the <code>fitted()</code>, <code>predict()</code>, and <strong>ggplot2</strong> code for Figure 4.11.c, the cubic model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>weight_seq <span class="ot">&lt;-</span> weight_seq <span class="sc">|&gt;</span> </span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_s3 =</span> weight_s<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>fitd_cub <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b4<span class="fl">.6</span>, <span class="at">newdata =</span> weight_seq) <span class="sc">|&gt;</span></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(weight_seq)</span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a>pred_cub <span class="ot">&lt;-</span> <span class="fu">predict</span>(b4<span class="fl">.6</span>, <span class="at">newdata =</span> weight_seq) <span class="sc">|&gt;</span></span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(weight_seq) </span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-12"><a href="#cb187-12" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> d, </span>
<span id="cb187-13"><a href="#cb187-13" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> weight_s)) <span class="sc">+</span></span>
<span id="cb187-14"><a href="#cb187-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> pred_cub, </span>
<span id="cb187-15"><a href="#cb187-15" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb187-16"><a href="#cb187-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey83"</span>) <span class="sc">+</span></span>
<span id="cb187-17"><a href="#cb187-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">data =</span> fitd_cub,</span>
<span id="cb187-18"><a href="#cb187-18" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">y =</span> Estimate, <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb187-19"><a href="#cb187-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">stat =</span> <span class="st">"identity"</span>,</span>
<span id="cb187-20"><a href="#cb187-20" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey70"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb187-21"><a href="#cb187-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> height),</span>
<span id="cb187-22"><a href="#cb187-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"navyblue"</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb187-23"><a href="#cb187-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"height"</span>,</span>
<span id="cb187-24"><a href="#cb187-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"cubic"</span>) <span class="sc">+</span></span>
<span id="cb187-25"><a href="#cb187-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d<span class="sc">$</span>weight_s),</span>
<span id="cb187-26"><a href="#cb187-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d<span class="sc">$</span>height)) <span class="sc">+</span></span>
<span id="cb187-27"><a href="#cb187-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Times"</span>),</span>
<span id="cb187-28"><a href="#cb187-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span>
<span id="cb187-29"><a href="#cb187-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-30"><a href="#cb187-30" aria-hidden="true" tabindex="-1"></a>p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-112-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>And here’s the <code>fitted()</code>, <code>predict()</code>, and <strong>ggplot2</strong> code for Figure 4.11.a, the linear model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>fitd_line <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b4<span class="fl">.7</span>, <span class="at">newdata =</span> weight_seq) <span class="sc">|&gt;</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(weight_seq)</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>pred_line <span class="ot">&lt;-</span> <span class="fu">predict</span>(b4<span class="fl">.7</span>, <span class="at">newdata =</span> weight_seq) <span class="sc">|&gt;</span></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(weight_seq) </span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> d, </span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> weight_s)) <span class="sc">+</span></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> pred_line, </span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey83"</span>) <span class="sc">+</span></span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">data =</span> fitd_line,</span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">y =</span> Estimate, <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">stat =</span> <span class="st">"identity"</span>,</span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey70"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> height),</span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"navyblue"</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb188-20"><a href="#cb188-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"height"</span>,</span>
<span id="cb188-21"><a href="#cb188-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"linear"</span>) <span class="sc">+</span></span>
<span id="cb188-22"><a href="#cb188-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d<span class="sc">$</span>weight_s),</span>
<span id="cb188-23"><a href="#cb188-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d<span class="sc">$</span>height)) <span class="sc">+</span></span>
<span id="cb188-24"><a href="#cb188-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Times"</span>),</span>
<span id="cb188-25"><a href="#cb188-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span>
<span id="cb188-26"><a href="#cb188-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-27"><a href="#cb188-27" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-113-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>Did you notice how we labeled each of the past three plots as <code>p1</code>, <code>p2</code>, and <code>p3</code>? Here we use those names to plot them all together with <strong>patchwork</strong> syntax.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">|</span> p2 <span class="sc">|</span> p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-114-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As fun as this all has been,</p>
<blockquote class="blockquote">
<p>it’s not clear that any of these models make a lot of sense. They are good geocentric descriptions of the sample, yes. But there are two problems. First, a better fit to the sample might not actually be a better model. That’s the subject of Chapter 7. Second, the model contains no biological information. We aren’t learning any causal relationship between height and weight. We’ll deal with this second problem much later, in Chapter 16. (p.&nbsp;113)</p>
</blockquote>
<section id="sec-Converting-back-to-natural-scale" class="level5" data-number="4.5.1.0.1">
<h5 data-number="4.5.1.0.1" class="anchored" data-anchor-id="sec-Converting-back-to-natural-scale"><span class="header-section-number">4.5.1.0.1</span> Overthinking: Converting back to natural scale</h5>
<p>You can apply McElreath’s conversion trick within the <strong>ggplot2</strong> environment, too. Here it is with the cubic model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>at <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> d, </span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> weight_s)) <span class="sc">+</span></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> pred_cub, </span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey83"</span>) <span class="sc">+</span></span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> height),</span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">color =</span> <span class="st">"navyblue"</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d<span class="sc">$</span>weight_s)) <span class="sc">+</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Times"</span>),</span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here it is!</span></span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"standardized weight converted back"</span>,</span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> at,</span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">round</span>(at<span class="sc">*</span><span class="fu">sd</span>(d<span class="sc">$</span>weight) <span class="sc">+</span> <span class="fu">mean</span>(d<span class="sc">$</span>weight), <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-115-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-Splines" class="level3" data-number="4.5.2">
<h3 data-number="4.5.2" class="anchored" data-anchor-id="sec-Splines"><span class="header-section-number">4.5.2</span> Splines</h3>
<p>Load the <code>cherry_blossoms</code> data <span class="citation" data-cites="aonoPhenologicalDataSeries2008 aonoClarifyingSpringtimeTemperature2010 aonoLongTermChange2012">(<a href="references.html#ref-aonoLongTermChange2012" role="doc-biblioref">Aono, 2012</a>; <a href="references.html#ref-aonoPhenologicalDataSeries2008" role="doc-biblioref">Aono &amp; Kazui, 2008</a>; <a href="references.html#ref-aonoClarifyingSpringtimeTemperature2010" role="doc-biblioref">Aono &amp; Saito, 2010</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rethinking)</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(cherry_blossoms)</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> cherry_blossoms</span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(cherry_blossoms)</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a><span class="fu">detach</span>(package<span class="sc">:</span>rethinking, <span class="at">unload =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Minus the mini histograms, here is our ground-up <strong>tidyverse</strong> way to summarize our new <code>d</code> data the way McElreath did with his <code>precis()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>())  <span class="sc">|&gt;</span> </span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span> </span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> T),</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd   =</span> <span class="fu">sd</span>(value, <span class="at">na.rm =</span> T),</span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll   =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.055</span>, <span class="at">na.rm =</span> T),</span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul   =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.945</span>, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span> </span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  name          mean     sd     ll      ul
  &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
1 doy         105.     6.41  94.4   115   
2 temp          6.14   0.66   5.15    7.29
3 temp_lower    5.1    0.85   3.79    6.37
4 temp_upper    7.19   0.99   5.9     8.9 
5 year       1408    351.   868.   1948.  </code></pre>
</div>
</div>
<p>McElreath encouraged us to plot <code>doy</code> against <code>year</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> doy)) <span class="sc">+</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Color from here: https://www.colorhexa.com/ffb7c5</span></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"#ffb7c5"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Color from here: https://www.colordic.org/w/, inspired by https://chichacha.netlify.com/2018/11/29/plotting-traditional-colours-of-japan/</span></span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#4f455c"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-118-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>It looks like there are some wiggly trends, but it’s hard to tell with a scatter plot.</p>
<blockquote class="blockquote">
<p>Our goal is to approximate the blossom trend with a wiggly function. With B-splines, just like with polynomial regression, we do this by generating new predictor variables and using those in the linear model, <span class="math inline">\(\mu_i\)</span>. Unlike polynomial regression, B-splines do not directly transform the predictor by squaring or cubing it. Instead they invent a series of entirely new, synthetic predictor variables. Each of these synthetic variables exists only to gradually turn a specific parameter on and off within a specific range of the real predictor variable. Each of the synthetic variables is called a <strong>basis function</strong>. The linear model ends up looking very familiar:</p>
<p><span class="math display">\[\mu_i = \alpha + w_1 B_{i, 1} + w_2 B_{i, 2} + w_3 B_{i, 3} + \dots\]</span></p>
<p>where <span class="math inline">\(B_{i,n}\)</span> is the <span class="math inline">\(n\)</span>-th basis function’s value on row <span class="math inline">\(i\)</span>, and the <span class="math inline">\(w\)</span> parameters are corresponding weights for each. The parameters act like slopes, adjusting the influence of each basis function on the mean <span class="math inline">\(\mu_i\)</span>. So really this is just another linear regression, but with some fancy, synthetic predictor variables. (p.&nbsp;115, <strong>emphasis</strong> in the original)</p>
</blockquote>
<p>It turns out there are cases with missing data for the <code>doy</code> variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(<span class="fu">is.na</span>(doy)) <span class="sc">|&gt;</span> </span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent =</span> <span class="dv">100</span> <span class="sc">*</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  is.na(doy)   n  percent
1      FALSE 827 68.06584
2       TRUE 388 31.93416</code></pre>
</div>
</div>
<p>Let’s follow McElreath and make a subset of the data that excludes cases with missing data in <code>doy</code>. Within the <strong>tidyverse</strong>, we might do so with the <code>tidyr::drop_na()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(doy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On page 117 in the text, McElreath indirectly explained how to make Figure 4.12 by walking through the workflow for making Figure 4.13. Here we mimic that ordering.</p>
<blockquote class="blockquote">
<p>First, we choose the knots. Remember, the knots are just values of year that serve as pivots for our spline. Where should the knots go? There are different ways to answer this question. You can, in principle, put the knots wherever you like. Their locations are part of the model, and you are responsible for them. Let’s do what we did in the simple example above, place the knots at different evenlyspaced quantiles of the predictor variable. This gives you more knots where there are more observations. We used only 5 knots in the first example. Now let’s go for 15:</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>num_knots <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>knot_list <span class="ot">&lt;-</span> <span class="fu">quantile</span>(d2<span class="sc">$</span>year, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">length.out =</span> num_knots))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our <code>knot_list</code> contains 15 <code>year</code> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>knot_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       0% 7.142857% 14.28571% 21.42857% 28.57143% 35.71429% 42.85714%       50% 57.14286% 64.28571% 71.42857% 78.57143% 85.71429% 
      812      1036      1174      1269      1377      1454      1518      1583      1650      1714      1774      1833      1893 
92.85714%      100% 
     1956      2015 </code></pre>
</div>
</div>
<p>Here’s what it looks like if we use those <code>knot_list</code> values to chop up our <code>year</code>/<code>doy</code> scatter plot, from above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> doy)) <span class="sc">+</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> knot_list, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#ffb7c5"</span>) <span class="sc">+</span></span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#4f455c"</span>),</span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-123-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>The next choice is polynomial degree. This determines how basis functions combine, which determines how the parameters interact to produce the spline. For degree 1, as in Figure 4.12, two basis functions combine at each point. For degree 2, three functions combine at each point. For degree 3, four combine. R already has a nice function that will build basis functions for any list of knots and degree. This code will construct the necessary basis functions for a degree 3 (cubic) spline: (p.&nbsp;117)</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">bs</span>(d2<span class="sc">$</span>year,</span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">knots =</span> knot_list[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, num_knots)], </span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">degree =</span> <span class="dv">3</span>, </span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">intercept =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Look closely at McElreath’s tricky <code>knot_list[-c(1, num_knots)]</code> code. Whereas <code>knot_list</code> contains 15 ordered <code>year</code> values, McElreath shaved off the first and last <code>year</code> values with <code>knot_list[-c(1, num_knots)]</code>, leaving 13. This is because, by default, the <code>bs()</code> function places knots at the boundaries. Since the first and 15<sup>th</sup> values in <code>knot_list</code> were boundary values for <code>year</code>, we removed them to avoid redundancies. We can confirm this with the code, below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>B <span class="sc">|&gt;</span> <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 'bs' num [1:827, 1:17] 1 0.96 0.767 0.563 0.545 ...
 - attr(*, "dimnames")=List of 2
  ..$ : NULL
  ..$ : chr [1:17] "1" "2" "3" "4" ...
 - attr(*, "degree")= int 3
 - attr(*, "knots")= Named num [1:13] 1036 1174 1269 1377 1454 ...
  ..- attr(*, "names")= chr [1:13] "7.142857%" "14.28571%" "21.42857%" "28.57143%" ...
 - attr(*, "Boundary.knots")= int [1:2] 812 2015
 - attr(*, "intercept")= logi TRUE</code></pre>
</div>
</div>
<p>Look at the second to last line, <code>- attr(*, "Boundary.knots")= int [1:2] 812 2015</code>. Those default <code>"Boundary.knots"</code> are the same as <code>knot_list[c(1, num_knots)]</code>. Let’s confirm.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>knot_list[<span class="fu">c</span>(<span class="dv">1</span>, num_knots)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0% 100% 
 812 2015 </code></pre>
</div>
</div>
<p>By the <code>degree = 3</code> argument, we indicated we wanted a cubic spline. McElreath used <code>degree = 1</code> for Figure 4.12. For reasons I’m not prepared to get into, here, splines don’t always include intercept parameters. Indeed, the <code>bs()</code> default is <code>intercept = FALSE</code>. McElreath’s code indicated he wanted to fit a B-spline that included an intercept. Thus: <code>intercept = TRUE</code>.</p>
<p>Here’s how we might make our version of the top panel of Figure 4.13.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrangle a bit</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> B <span class="sc">|&gt;</span> </span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">str_c</span>(<span class="dv">0</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>), <span class="dv">10</span><span class="sc">:</span><span class="dv">17</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">select</span>(d2, year)) <span class="sc">|&gt;</span> </span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>year,</span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"bias_function"</span>,</span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"bias"</span>)</span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a>b <span class="sc">|&gt;</span> </span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> bias, <span class="at">group =</span> bias_function)) <span class="sc">+</span></span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> knot_list, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#ffb7c5"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"bias value"</span>) <span class="sc">+</span></span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb207-17"><a href="#cb207-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#4f455c"</span>),</span>
<span id="cb207-18"><a href="#cb207-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-127-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>To elucidate what’s going on in that plot, we might break it up with <code>facet_wrap()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>b <span class="sc">|&gt;</span> </span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bias_function =</span> <span class="fu">str_c</span>(<span class="st">"bias function "</span>, bias_function)) <span class="sc">|&gt;</span> </span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> bias)) <span class="sc">+</span></span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> knot_list, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#ffb7c5"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"bias value"</span>) <span class="sc">+</span></span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> bias_function, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#4f455c"</span>),</span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb208-12"><a href="#cb208-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(<span class="st">"#ffb7c5"</span>, .<span class="dv">25</span>), <span class="at">color =</span> <span class="st">"transparent"</span>),</span>
<span id="cb208-13"><a href="#cb208-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="fl">0.1</span>, <span class="dv">0</span>, <span class="fl">0.1</span>, <span class="dv">0</span>, <span class="st">"cm"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-128-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>Now to get the parameter weights for each basis function, we need to actually define the model and make it run. The model is just a linear regression. The synthetic basis functions do all the work. We’ll use each column of the matrix <code>B</code> as a variable. We’ll also have an intercept to capture the average blossom day. This will make it easier to define priors on the basis weights, because then we can just conceive of each as a deviation from the intercept. (p.&nbsp;117)</p>
</blockquote>
<p>That last line is another indication for why we set <code>intercept = TRUE</code>. Our model will follow the form</p>
<p><span class="math display">\[\begin{align*}
\text{day_in_year}_i &amp; \sim \operatorname{Normal} (\mu_i, \sigma) \\
\mu_i  &amp; = \alpha + \color{#4f455c}{\sum_{k=1}^K w_k B_{k, i}} \\
\alpha &amp; \sim \operatorname{Normal}(100, 10) \\
\color{#4f455c}{w_j} &amp; \color{#4f455c}\sim \color{#4f455c}{\operatorname{Normal}(0, 10)} \\
\sigma &amp; \sim \operatorname{Exponential}(1),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\alpha\)</span> is the intercept, <span class="math inline">\(B_{k, i}\)</span> is the value of the <span class="math inline">\(k^\text{th}\)</span> bias function on the <span class="math inline">\(i^\text{th}\)</span> row of the data, and <span class="math inline">\(w_k\)</span> is the estimated regression weight for the corresponding <span class="math inline">\(k^\text{th}\)</span> bias function.</p>
<p>As for the new parameter type for <span class="math inline">\(\sigma\)</span>, the exponential distribution is controlled by a single parameter, <span class="math inline">\(\lambda\)</span>, which is also called the <em>rate</em>. As it turns out, the mean of the exponential distribution is the inverse of the rate, <span class="math inline">\(1 / \lambda\)</span>. Here we use the <code>dexp()</code> function to get a sense of what that prior looks like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">10</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">d =</span> <span class="fu">dexp</span>(x, <span class="at">rate =</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> d)) <span class="sc">+</span></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">fill =</span> <span class="st">"#ffb7c5"</span>) <span class="sc">+</span></span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#4f455c"</span>),</span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-129-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>“We’ll use exponential priors for the rest of the book, in place of uniform priors. It is much more common to have a sense of the average deviation than of the maximum” (p.&nbsp;119). 🎉</p>
<p><strong>Acknowledgment</strong>: The workflow to follow is heavily influenced by the <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/issues/22">helpful contributions</a> from <a href="https://github.com/sjwild">Stephen Wild</a>. My first pass through the material in this section was a mess. Wild’s insights knocked it out of the park and I couldn’t be more grateful. 🍻</p>
<p>Before fitting this model in <strong>brms</strong>, well take a minor detour on the data structure. In his <strong>R</strong> code 4.76, McElreath defined his data in a list, <code>list( D=d2$doy , B=B )</code>. Our approach will be a little different. Here, we’ll add the <code>B</code> matrix to our <code>d2</code> data frame and name the results as <code>d3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> d2 <span class="sc">|&gt;</span> </span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">B =</span> B) </span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Take a look at the structure of `d3</span></span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>d3 <span class="sc">|&gt;</span> <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 827
Columns: 6
$ year       &lt;int&gt; 812, 815, 831, 851, 853, 864, 866, 869, 889, 891, 892, 894, 895, 896, 902, 908, 912, 913, 917, 923, 926, 930,…
$ doy        &lt;int&gt; 92, 105, 96, 108, 104, 100, 106, 95, 104, 109, 108, 106, 104, 104, 102, 98, 95, 110, 95, 104, 98, 97, 106, 10…
$ temp       &lt;dbl&gt; NA, NA, NA, 7.38, NA, 6.42, 6.44, NA, 6.83, 6.98, 7.11, 6.98, 7.08, 7.20, 7.50, 7.26, 6.78, 6.61, 6.48, 6.76,…
$ temp_upper &lt;dbl&gt; NA, NA, NA, 12.10, NA, 8.69, 8.11, NA, 8.48, 8.96, 9.11, 8.40, 8.57, 8.69, 8.95, 8.89, 8.83, 8.59, 10.21, 8.5…
$ temp_lower &lt;dbl&gt; NA, NA, NA, 2.66, NA, 4.14, 4.77, NA, 5.19, 5.00, 5.11, 5.55, 5.58, 5.72, 6.06, 5.62, 4.74, 4.63, 2.76, 5.01,…
$ B          &lt;bs[,17]&gt; &lt;bs[43 x 17]&gt;</code></pre>
</div>
</div>
<p>In our <code>d3</code> data, columns <code>year</code> through <code>temp_lower</code> are all standard data columns. The <code>B</code> column is a <em>matrix column</em>, which contains the same number of rows as the others, but also smuggled in 17 columns <em>within</em> that column. Each of those 17 columns corresponds to one of our synthetic <span class="math inline">\(B_k\)</span> variables. The advantage of such a data structure is we can simply define our <code>formula</code> argument as <code>doy ~ 1 + B</code>, where <code>B</code> is a stand-in for <code>B.1 + B.2 + ... + B.17</code>.</p>
<p>Here’s how to fit the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.8</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d3,</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>  doy <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> B,</span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">100</span>, <span class="dv">10</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> b),</span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma)),</span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.08"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b4<span class="fl">.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: doy ~ 1 + B 
   Data: d3 (Number of observations: 827) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept   103.45      2.34    98.73   107.85 1.01      837     1168
B1           -3.03      3.80   -10.38     4.58 1.00     1766     2523
B2           -0.97      3.82    -8.40     6.33 1.00     1648     2555
B3           -1.10      3.60    -8.09     5.95 1.00     1549     2428
B4            4.75      2.84    -0.75    10.37 1.00     1094     1771
B5           -0.95      2.83    -6.48     4.62 1.00     1175     1797
B6            4.19      2.90    -1.41     9.86 1.00     1158     1618
B7           -5.38      2.80   -10.88     0.13 1.00     1177     2079
B8            7.72      2.78     2.32    13.33 1.00     1136     1623
B9           -1.09      2.88    -6.86     4.63 1.00     1141     1926
B10           2.93      2.84    -2.38     8.53 1.00     1187     1735
B11           4.53      2.88    -0.93    10.22 1.00     1112     1921
B12          -0.21      2.80    -5.60     5.32 1.00     1148     1801
B13           5.44      2.86    -0.09    11.00 1.00     1121     1880
B14           0.62      2.96    -5.07     6.51 1.00     1283     2202
B15          -0.91      3.28    -7.32     5.60 1.00     1273     2061
B16          -7.09      3.35   -13.64    -0.58 1.00     1597     2440
B17          -7.73      3.23   -13.83    -1.37 1.00     1333     2187

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     5.94      0.15     5.68     6.24 1.00     4396     2969

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Look at that. Each of the 17 columns in our <code>B</code> matrix was assigned its own parameter. If you fit this model using McElreath’s <strong>rethinking</strong> code, you’ll see the results are very similar. Anyway, McElreath’s comments are in line with the general consensus on spline modes: the parameter estimates are very difficult to interpret directly. It’s often easier to just plot the results. First we’ll use <code>as_draws_df()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b4<span class="fl">.8</span>)</span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(post)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,000
Columns: 25
$ b_Intercept &lt;dbl&gt; 103.6326, 102.7768, 101.9956, 102.1028, 103.7816, 103.7781, 103.8310, 103.1931, 103.8764, 103.9462, 104.3867…
$ b_B1        &lt;dbl&gt; -2.515909346, -6.396048025, -1.757507933, -6.086758705, 1.851128494, -6.273272280, -1.211818462, -2.21875941…
$ b_B2        &lt;dbl&gt; -2.4055377, 2.2012721, 4.5596578, 5.2578616, -4.5009004, -0.3570559, -1.0549341, -1.6574169, 4.1933156, 3.82…
$ b_B3        &lt;dbl&gt; -0.40024205, -5.50521001, -2.06977008, -4.03419467, -1.28138806, -0.16702822, -3.51982460, -0.09964411, -3.2…
$ b_B4        &lt;dbl&gt; 5.3729937, 7.7509294, 6.0321454, 8.0430014, 4.4963196, 2.6613670, 4.0942312, 4.4357873, 7.2099729, 5.2449064…
$ b_B5        &lt;dbl&gt; -1.47992029, -1.27770929, -0.23437035, -0.79954431, -1.53183469, -0.04868177, -0.85925281, 0.17160434, -3.63…
$ b_B6        &lt;dbl&gt; 3.8597801, 3.3251367, 6.9683564, 6.8291320, 2.6671390, 2.5246753, 2.3791679, 4.6908659, 3.4279361, 3.3564081…
$ b_B7        &lt;dbl&gt; -7.481753, -5.007213, -3.709432, -5.683608, -6.016329, -6.134282, -3.815637, -8.509985, -4.773250, -4.470728…
$ b_B8        &lt;dbl&gt; 8.864320, 8.082351, 5.834810, 9.806924, 7.020597, 4.419259, 6.922874, 10.679370, 5.877684, 6.100913, 4.84762…
$ b_B9        &lt;dbl&gt; -3.88164332, 0.01321532, 2.65382118, 0.99134144, -1.22568314, 1.23484623, -0.87732817, -2.23629567, -1.70963…
$ b_B10       &lt;dbl&gt; 5.7781130, 0.6891200, 6.0833892, 3.4788663, 3.2301990, 1.3230426, 0.6162188, 4.0433546, 2.7836713, 1.5450822…
$ b_B11       &lt;dbl&gt; 2.4830288, 8.7237955, 5.9560858, 9.2057690, 4.9453953, 3.9439998, 3.7495933, 7.1866252, 1.2143245, 2.2764813…
$ b_B12       &lt;dbl&gt; 2.06819542, -0.84632502, -0.38432707, -1.08361338, -0.96560203, 1.34327745, -0.02355109, -1.90679848, 1.8162…
$ b_B13       &lt;dbl&gt; 3.8899015, 7.5382242, 8.4717539, 6.9990679, 5.4494915, 2.3500843, 3.2880073, 7.0499862, 5.5464476, 5.3166678…
$ b_B14       &lt;dbl&gt; 0.77105989, -2.67141190, 0.37607076, 4.11485691, -1.35618392, 0.85713697, 3.73958110, -0.20379750, 0.5848544…
$ b_B15       &lt;dbl&gt; -3.9644199, 3.6552835, 2.1946976, -3.3631965, -2.0234479, -2.7736611, -4.6967781, 2.2346964, 3.5460820, 3.20…
$ b_B16       &lt;dbl&gt; -2.406126, -10.441109, -8.766467, -3.526741, -2.991139, -5.873885, -8.684549, -8.930950, -9.812842, -9.82334…
$ b_B17       &lt;dbl&gt; -9.9622206, -2.6057366, -7.8648369, -9.0768901, -10.4270187, -4.8647174, -6.5644432, -7.2663082, -4.8501700,…
$ sigma       &lt;dbl&gt; 6.054284, 5.985893, 5.961017, 5.893135, 6.102580, 5.749992, 5.874712, 6.000066, 6.038545, 5.998703, 5.895834…
$ Intercept   &lt;dbl&gt; 104.5259, 104.2515, 104.4118, 104.5854, 104.4360, 104.2760, 104.3511, 104.6222, 104.9202, 104.8300, 104.3120…
$ lprior      &lt;dbl&gt; -66.08493, -66.61194, -66.32614, -66.94808, -65.84397, -64.84325, -65.36278, -66.59327, -65.94448, -65.69334…
$ lp__        &lt;dbl&gt; -2711.772, -2715.877, -2716.059, -2712.243, -2712.028, -2715.740, -2712.254, -2711.983, -2721.070, -2715.237…
$ .chain      &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ .iteration  &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 3…
$ .draw       &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 3…</code></pre>
</div>
</div>
<p>With a little wrangling, we can use summary information from <code>post</code> to make our version of the middle panel of Figure 4.13.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span> </span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(b_B1<span class="sc">:</span>b_B17) <span class="sc">|&gt;</span> </span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">c</span>(<span class="fu">str_c</span>(<span class="dv">0</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>), <span class="dv">10</span><span class="sc">:</span><span class="dv">17</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"bias_function"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(bias_function) <span class="sc">|&gt;</span> </span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">weight =</span> <span class="fu">mean</span>(value)) <span class="sc">|&gt;</span> </span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(b, <span class="at">by =</span> <span class="st">"bias_function"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> bias <span class="sc">*</span> weight, <span class="at">group =</span> bias_function)) <span class="sc">+</span></span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> knot_list, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#ffb7c5"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb217-14"><a href="#cb217-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#4f455c"</span>),</span>
<span id="cb217-15"><a href="#cb217-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-134-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>In case you missed it, the main action in the <strong>ggplot2</strong> code was <code>y = bias * weight</code>, where we defined the <span class="math inline">\(y\)</span>-axis as the product of <code>bias</code> and <code>weight</code>. This is fulfillment of the <span class="math inline">\(w_k B_{k, i}\)</span> parts of the model. Now here’s how we might use <code>brms::fitted()</code> to make the lower plot of Figure 4.13.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b4<span class="fl">.8</span>)</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>f <span class="sc">|&gt;</span> </span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(d2) <span class="sc">|&gt;</span> </span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> doy, <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>)) <span class="sc">+</span> </span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> knot_list, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">fixef</span>(b4<span class="fl">.8</span>)[<span class="dv">1</span>, <span class="dv">1</span>], <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#ffb7c5"</span>) <span class="sc">+</span></span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"year"</span>,</span>
<span id="cb218-13"><a href="#cb218-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"day in year"</span>) <span class="sc">+</span></span>
<span id="cb218-14"><a href="#cb218-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb218-15"><a href="#cb218-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#4f455c"</span>),</span>
<span id="cb218-16"><a href="#cb218-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-135-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>If it wasn’t clear, the dashed horizontal line intersecting a little above 100 on the <span class="math inline">\(y\)</span>-axis is the posterior mean for the intercept. Now let’s use our skills to remake the simpler model expressed in Figure 4.12. This model, recall, is based on 5 knots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Redo the `B` splines</span></span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>num_knots <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>knot_list <span class="ot">&lt;-</span> <span class="fu">quantile</span>(d2<span class="sc">$</span>year, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">length.out =</span> num_knots))</span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">bs</span>(d2<span class="sc">$</span>year,</span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">knots =</span> knot_list[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, num_knots)], </span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># this makes the splines liner rater than cubic</span></span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">degree =</span> <span class="dv">1</span>, </span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">intercept =</span> <span class="cn">TRUE</span>)</span>
<span id="cb219-10"><a href="#cb219-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-11"><a href="#cb219-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a new `d4` data</span></span>
<span id="cb219-12"><a href="#cb219-12" aria-hidden="true" tabindex="-1"></a>d4 <span class="ot">&lt;-</span> d2 <span class="sc">|&gt;</span> </span>
<span id="cb219-13"><a href="#cb219-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">B =</span> B)</span>
<span id="cb219-14"><a href="#cb219-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-15"><a href="#cb219-15" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.9</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb219-16"><a href="#cb219-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d4,</span>
<span id="cb219-17"><a href="#cb219-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb219-18"><a href="#cb219-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> doy <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> B,</span>
<span id="cb219-19"><a href="#cb219-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">100</span>, <span class="dv">10</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb219-20"><a href="#cb219-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> b),</span>
<span id="cb219-21"><a href="#cb219-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma)),</span>
<span id="cb219-22"><a href="#cb219-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb219-23"><a href="#cb219-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb219-24"><a href="#cb219-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.09"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Review the new model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b4<span class="fl">.9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: doy ~ 1 + B 
   Data: d4 (Number of observations: 827) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept   103.47      4.51    94.58   112.60 1.00      772      795
B1           -0.35      4.61    -9.56     8.89 1.00      803      878
B2            1.50      4.53    -7.54    10.45 1.00      784      778
B3            1.56      4.54    -7.65    10.50 1.00      784      931
B4            3.99      4.52    -5.06    12.98 1.00      783      818
B5           -5.59      4.58   -14.88     3.46 1.00      786      834

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     6.10      0.15     5.80     6.41 1.00     2244     2058

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Here we do all the work in bulk to make and save the three subplots for Figure 4.12.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Top</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrangle a bit</span></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">invoke</span>(data.frame, d4) <span class="sc">|&gt;</span> </span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"B"</span>),</span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"bias_function"</span>,</span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"bias"</span>)</span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb222-9"><a href="#cb222-9" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> b <span class="sc">|&gt;</span> </span>
<span id="cb222-10"><a href="#cb222-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> bias, <span class="at">group =</span> bias_function)) <span class="sc">+</span></span>
<span id="cb222-11"><a href="#cb222-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> knot_list, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb222-12"><a href="#cb222-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#ffb7c5"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb222-13"><a href="#cb222-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb222-14"><a href="#cb222-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"bias value"</span>)</span>
<span id="cb222-15"><a href="#cb222-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-16"><a href="#cb222-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Middle</span></span>
<span id="cb222-17"><a href="#cb222-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrangle</span></span>
<span id="cb222-18"><a href="#cb222-18" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b4<span class="fl">.9</span>) <span class="sc">|&gt;</span> </span>
<span id="cb222-19"><a href="#cb222-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(b_B1<span class="sc">:</span>b_B5) <span class="sc">|&gt;</span> </span>
<span id="cb222-20"><a href="#cb222-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">str_c</span>(<span class="st">"B."</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb222-21"><a href="#cb222-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"bias_function"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb222-22"><a href="#cb222-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(bias_function) <span class="sc">|&gt;</span> </span>
<span id="cb222-23"><a href="#cb222-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">weight =</span> <span class="fu">mean</span>(value)) <span class="sc">|&gt;</span> </span>
<span id="cb222-24"><a href="#cb222-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(b, <span class="at">by =</span> <span class="st">"bias_function"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb222-25"><a href="#cb222-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb222-26"><a href="#cb222-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb222-27"><a href="#cb222-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> bias <span class="sc">*</span> weight, <span class="at">group =</span> bias_function)) <span class="sc">+</span></span>
<span id="cb222-28"><a href="#cb222-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> knot_list, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb222-29"><a href="#cb222-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#ffb7c5"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb222-30"><a href="#cb222-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>)</span>
<span id="cb222-31"><a href="#cb222-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-32"><a href="#cb222-32" aria-hidden="true" tabindex="-1"></a><span class="do">## Bottom</span></span>
<span id="cb222-33"><a href="#cb222-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrangle</span></span>
<span id="cb222-34"><a href="#cb222-34" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b4<span class="fl">.9</span>)</span>
<span id="cb222-35"><a href="#cb222-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-36"><a href="#cb222-36" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> f <span class="sc">|&gt;</span> </span>
<span id="cb222-37"><a href="#cb222-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb222-38"><a href="#cb222-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(d2) <span class="sc">|&gt;</span> </span>
<span id="cb222-39"><a href="#cb222-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb222-40"><a href="#cb222-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb222-41"><a href="#cb222-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> doy, <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>)) <span class="sc">+</span> </span>
<span id="cb222-42"><a href="#cb222-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> knot_list, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb222-43"><a href="#cb222-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">fixef</span>(b4<span class="fl">.9</span>)[<span class="dv">1</span>, <span class="dv">1</span>], <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb222-44"><a href="#cb222-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#ffb7c5"</span>) <span class="sc">+</span></span>
<span id="cb222-45"><a href="#cb222-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb222-46"><a href="#cb222-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"year"</span>,</span>
<span id="cb222-47"><a href="#cb222-47" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"day in year"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now combine the subplots with <strong>patchwork</strong> syntax and behold their glory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">/</span> p2 <span class="sc">/</span> p3) <span class="sc">&amp;</span></span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">&amp;</span></span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#4f455c"</span>),</span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-138-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="smooth-functions-for-a-rough-world" class="level3" data-number="4.5.3">
<h3 data-number="4.5.3" class="anchored" data-anchor-id="smooth-functions-for-a-rough-world"><span class="header-section-number">4.5.3</span> Smooth functions for a rough world</h3>
<blockquote class="blockquote">
<p>The splines in the previous section are just the beginning. A entire class of models, <strong>generalized additive models</strong> (GAMs), focuses on predicting an outcome variable using smooth functions of some predictor variables. The topic is deep enough to deserve its own book. (p.&nbsp;120, <strong>emphasis</strong> in the original)</p>
</blockquote>
<p>McElreath ended that block quote with a reference to his endnote #78. On page 562, we read: “A very popular and comprehensive text is Wood <span class="citation" data-cites="woodGeneralizedAdditiveModels2017">(<a href="references.html#ref-woodGeneralizedAdditiveModels2017" role="doc-biblioref">2017b</a>)</span>.”</p>
</section>
</section>
<section id="sec-smooth-functions-with-s" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="sec-smooth-functions-with-s"><span class="header-section-number">4.6</span> <del>Summary</del> First bonus: Smooth functions with <code>brms::s()</code></h2>
<p>It’s convenient for us how McElreath ended that last section with a reference to Simon Wood’s work because <strong>brms</strong> allows for a variety of non-linear models by borrowing functions from Woods’s <a href="https://CRAN.R-project.org/package=mgcv"><strong>mgcv</strong> package</a> <span class="citation" data-cites="R-mgcv mgcv2003 mgcv2004 mgcv2011 mgcv2017 mgcv2016">(<a href="references.html#ref-mgcv2003" role="doc-biblioref">Wood, 2003</a>, <a href="references.html#ref-mgcv2004" role="doc-biblioref">2004</a>, <a href="references.html#ref-mgcv2011" role="doc-biblioref">2011</a>, <a href="references.html#ref-mgcv2017" role="doc-biblioref">2017a</a>, <a href="references.html#ref-R-mgcv" role="doc-biblioref">2022</a>; <a href="references.html#ref-mgcv2016" role="doc-biblioref">Wood et al., 2016</a>)</span>. The two smooth functions <strong>brms</strong> imports from <strong>mgcv</strong> are <code>s()</code> and <code>t2()</code>. We’ll be exploring <code>s()</code>. We might use the <code>brms::get_prior()</code> function to get a sense of how to set up the priors when using <code>s()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(<span class="at">data =</span> d2,</span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">family =</span> gaussian,</span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a>          doy <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">s</span>(year))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  prior     class    coef group resp dpar nlpar lb ub tag       source
                 (flat)         b                                              default
                 (flat)         b syear_1                                 (vectorized)
 student_t(3, 105, 5.9) Intercept                                              default
   student_t(3, 0, 5.9)       sds                                0             default
   student_t(3, 0, 5.9)       sds s(year)                        0        (vectorized)
   student_t(3, 0, 5.9)     sigma                                0             default</code></pre>
</div>
</div>
<p>We have an overall intercept (<code>class = Intercept</code>), a single <span class="math inline">\(\beta\)</span> parameter for <code>year</code> (<code>class = b</code>), a <span class="math inline">\(\sigma\)</span> parameter (<code>class = sigma</code>), and an unfamiliar parameter of <code>class = sds</code>. I’m not going to go into that last parameter in any detail, here. We’ll need to work our way up through <a href="13.html" class="quarto-xref"><span>Chapter 13</span></a> and the multilevel model to get a full picture of what it means. The important thing to note here is that the priors for our <code>s()</code>-based alternative to the B-spline models, above, are going to look a little different. Here’s how we might fit an alternative to <code>b4.8</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d2,</span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>  doy <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">s</span>(year),</span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">100</span>, <span class="dv">10</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> b),</span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">5.9</span>), <span class="at">class =</span> sds),</span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma)),</span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb226-11"><a href="#cb226-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.99</span>),</span>
<span id="cb226-12"><a href="#cb226-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.10"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check out the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b4<span class="fl">.10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: doy ~ 1 + s(year) 
   Data: d2 (Number of observations: 827) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Smoothing Spline Hyperparameters:
             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sds(syear_1)    22.38      7.21    11.84    40.41 1.00     1032     1765

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept   104.53      0.21   104.11   104.94 1.00     3988     2627
syear_1      -9.74      9.12   -27.80     8.48 1.00     3512     2713

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     6.04      0.15     5.76     6.34 1.00     4243     2972

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Our intercept and <span class="math inline">\(\sigma\)</span> summaries are similar to those we got from <code>b4.8</code>. The rest looks different and maybe a little disorienting. Here’s what happens when we use <code>brms::fitted()</code> to plot the implications of the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fitted</span>(b4<span class="fl">.10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">select</span>(d2, year, doy)) <span class="sc">|&gt;</span> </span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> doy, <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>)) <span class="sc">+</span></span>
<span id="cb229-6"><a href="#cb229-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">fixef</span>(b4<span class="fl">.10</span>)[<span class="dv">1</span>, <span class="dv">1</span>], <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb229-7"><a href="#cb229-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#ffb7c5"</span>) <span class="sc">+</span></span>
<span id="cb229-8"><a href="#cb229-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb229-9"><a href="#cb229-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"day in year"</span>,</span>
<span id="cb229-10"><a href="#cb229-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"b4.7 using s(year)"</span>) <span class="sc">+</span></span>
<span id="cb229-11"><a href="#cb229-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb229-12"><a href="#cb229-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#4f455c"</span>), </span>
<span id="cb229-13"><a href="#cb229-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-142-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>That smooth doesn’t look quite the same. Hopefully this isn’t terribly surprising. We used a function from a different package and ended up with a different underlying statistical model. In fact, we didn’t even use a B-spline. The default for <code>s()</code> is to use what’s called a <em>thin plate</em> regression spline. If we’d like to fit a B-spline, we have to set <code>bs = "bs"</code>. Here’s an example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d2,</span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb230-4"><a href="#cb230-4" aria-hidden="true" tabindex="-1"></a>  doy <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">s</span>(year, <span class="at">bs =</span> <span class="st">"bs"</span>, <span class="at">k =</span> <span class="dv">19</span>),</span>
<span id="cb230-5"><a href="#cb230-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">100</span>, <span class="dv">10</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb230-6"><a href="#cb230-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> b),</span>
<span id="cb230-7"><a href="#cb230-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">5.9</span>), <span class="at">class =</span> sds),</span>
<span id="cb230-8"><a href="#cb230-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma)),</span>
<span id="cb230-9"><a href="#cb230-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb230-10"><a href="#cb230-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb230-11"><a href="#cb230-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.99</span>),</span>
<span id="cb230-12"><a href="#cb230-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.11"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b4<span class="fl">.11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: doy ~ 1 + s(year, bs = "bs", k = 19) 
   Data: d2 (Number of observations: 827) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Smoothing Spline Hyperparameters:
             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sds(syear_1)     1.25      0.58     0.49     2.69 1.00      689     1503

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept   104.54      0.21   104.13   104.94 1.00     5154     3008
syear_1      -0.10      0.32    -0.73     0.51 1.00     1812     1983

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     5.99      0.15     5.72     6.29 1.00     4966     3031

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Now here’s the depiction of our <code>s()</code>-based B-spline model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fitted</span>(b4<span class="fl">.11</span>) <span class="sc">|&gt;</span> </span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">select</span>(d2, year, doy)) <span class="sc">|&gt;</span> </span>
<span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb233-5"><a href="#cb233-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> doy, <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>)) <span class="sc">+</span></span>
<span id="cb233-6"><a href="#cb233-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">fixef</span>(b4<span class="fl">.11</span>)[<span class="dv">1</span>, <span class="dv">1</span>], <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb233-7"><a href="#cb233-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#ffb7c5"</span>) <span class="sc">+</span></span>
<span id="cb233-8"><a href="#cb233-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb233-9"><a href="#cb233-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"day in year"</span>,</span>
<span id="cb233-10"><a href="#cb233-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">'b4.7_bs using s(year, bs = "bs")'</span>) <span class="sc">+</span></span>
<span id="cb233-11"><a href="#cb233-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb233-12"><a href="#cb233-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#4f455c"</span>), </span>
<span id="cb233-13"><a href="#cb233-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-144-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>There are still other important differences between the underlying statistical model for <code>b4.11</code> and the earlier <code>b4.8</code> that I’m just not going to go into, here.</p>
<p>For more on the B-splines and smooths, more generally, check out the blog post by the great <a href="https://twitter.com/ucfagls">Gavin Simpson</a>, <a href="https://fromthebottomoftheheap.net/2020/06/03/extrapolating-with-gams/"><em>Extrapolating with B splines and GAMs</em></a>. For a high-level introduction to the models you can fit with <strong>mgcv</strong>, check out the nice talk by <a href="https://twitter.com/noamross">Noam Ross</a>, <a href="https://youtu.be/q4_t8jXcQgc"><em>Nonlinear models in R: The wonderful world of mgcv</em></a>, or the equally-nice presentation by Simpson, <a href="https://youtu.be/sgw4cu8hrZM"><em>Introduction to generalized additive models with R and mgcv</em></a>. Ross offers a free online course covering <strong>mgcv</strong>, called <a href="https://noamross.github.io/gams-in-r-course/">GAMS in R</a>, and he maintains a GitHub repo cataloguing other GAM-related resources, called <a href="https://github.com/noamross/gam-resources"><em>Resources for learning about and using GAMs in R</em></a>. For specific examples of fitting various GAMS with <strong>brms</strong>, check out Simpson’s blog post, <a href="https://fromthebottomoftheheap.net/2018/04/21/fitting-gams-with-brms/"><strong>Fitting GAMs with brms: part 1</strong></a>. Finally, <a href="https://twitter.com/tjmahr">Tristan Mahr</a> has a nice blog post called <a href="https://www.tjmahr.com/random-effects-penalized-splines-same-thing/"><em>Random effects and penalized splines are the same thing</em></a>, where he outlined the connections between penalized smooths, such as you might fit with <strong>mgcv</strong>, with the multilevel model, which we’ll learn all about starting in <a href="13.html" class="quarto-xref"><span>Chapter 13</span></a>, which helps explain what’s going on with the <code>s()</code> function in our last two models, <code>b4.10</code> and <code>b4.11</code>.</p>
</section>
<section id="sec-Group-predictors-with-matrix-columns" class="level2 page-columns page-full" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="sec-Group-predictors-with-matrix-columns"><span class="header-section-number">4.7</span> Second bonus: Group predictors with matrix columns</h2>
<p>When we fit <code>b4.8</code>, our direct <strong>brms</strong> analogue to McElreath’s <code>m4.7</code>,<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> we used a compact syntax to pass a matrix column of predictors into the <code>formula</code>. If memory serves, this is one of the only places in the text where we see this. It would be easy for the casual reader to think this was only appropriate for something like a spline model. But that’s not the case. One could use the matrix-column trick as a general approach. In this bonus section, we’ll explore how.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;I know. I’m sorry our model numbering diverged from the numbering in the text. The problem popped up in <a href="#sec-Polynomial-regression" class="quarto-xref"><span>Section 4.5.1</span></a> where McElreath fit a linear model with the <code>weight_s</code> predictor, but didn’t show the code in the text and, as a consequence, didn’t assign that model a number. Since we explicitly fit that linear model, we assigned it the next number in the sequence. So it goes. But yes, I am correct in comparing our <code>b4.8</code> to McElreath’s <code>m4.7</code>.</p></div></div><p>In Section 11.2.6 of their <span class="citation" data-cites="gelmanRegressionOtherStories2020">(<a href="references.html#ref-gelmanRegressionOtherStories2020" role="doc-biblioref">2020</a>)</span> text, Gelman, Hill, and Vehtari worked through an example of a multiple regression model,</p>
<p><span class="math display">\[
\begin{align*}
y_i &amp; \sim \operatorname{Normal}(\mu_i, \sigma) \\
\mu_i &amp; = \alpha + \theta z_i + \sum_{k = 1}^K b_k x_{k, i} \\
&amp; \text{&lt;priors&gt;},
\end{align*}
\]</span></p>
<p>where <span class="math inline">\(y_i\)</span> was some continuous variable collected across participants, <span class="math inline">\(i\)</span>. The <span class="math inline">\(\alpha\)</span> term was the intercept and the <span class="math inline">\(\theta\)</span> term was the regression slope for a binary variable <span class="math inline">\(z\)</span>–we’ll practice with binary predictors in <a href="05.html#sec-Categorical-variables" class="quarto-xref"><span>Section 5.3</span></a>. More to our interest, the last portion of the equation is a compact way to convey there are <span class="math inline">\(K\)</span> additional predictors and their associated regression coefficients, which we might more explicitly express as <span class="math inline">\(\beta_1 x_{1, i} + \cdots + \beta_k x_{k, i}\)</span>, where <span class="math inline">\(K \geq 1\)</span>. In this particular example, <span class="math inline">\(K = 10\)</span>, meaning there were ten <span class="math inline">\(x_{k, i}\)</span> predictors, making this an example of a model with 11 total predictor variables.</p>
<p>Riffing off of Gelman and colleagues, here’s how you might simulate data of this kind.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many cases would you like?</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a><span class="co"># How many continuous x predictor variables would you like?</span></span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate a dichotomous dummy variable for `z`</span></span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate an `n` by `k` array for `X`</span></span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">z =</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">size =</span> n, <span class="at">replace =</span> T),</span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">X =</span> <span class="fu">array</span>(<span class="fu">runif</span>(n <span class="sc">*</span> k, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>), <span class="at">dim =</span> <span class="fu">c</span>(n, k)))</span>
<span id="cb234-13"><a href="#cb234-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-14"><a href="#cb234-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the data-generating parameter values</span></span>
<span id="cb234-15"><a href="#cb234-15" aria-hidden="true" tabindex="-1"></a>a     <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb234-16"><a href="#cb234-16" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb234-17"><a href="#cb234-17" aria-hidden="true" tabindex="-1"></a>b     <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>k</span>
<span id="cb234-18"><a href="#cb234-18" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb234-19"><a href="#cb234-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-20"><a href="#cb234-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the criterion</span></span>
<span id="cb234-21"><a href="#cb234-21" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb234-22"><a href="#cb234-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">as.vector</span>(a <span class="sc">+</span> X <span class="sc">%*%</span> b <span class="sc">+</span> theta <span class="sc">*</span> z <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sigma)))</span>
<span id="cb234-23"><a href="#cb234-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-24"><a href="#cb234-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the data structure</span></span>
<span id="cb234-25"><a href="#cb234-25" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb234-26"><a href="#cb234-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100
Columns: 3
$ z &lt;int&gt; 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0…
$ X &lt;dbl[,10]&gt; &lt;matrix[43 x 10]&gt;
$ y &lt;dbl&gt; 19.51231, 26.75217, 28.92495, 20.63144, 29.18219, 43.67198, 36.98107, 36.68241, 28.67696, 24.39985, 24.66649, 31.…</code></pre>
</div>
</div>
<p>Although our <code>d</code> tibble has only three columns, the <code>X</code> column is a matrix column into which we’ve smuggled ten columns more. Here’s how we might access them more directly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(X) <span class="sc">|&gt;</span> </span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:100, 1:10] 0.253 0.63 0.266 0.532 0.468 ...</code></pre>
</div>
</div>
<p>See? There’s an <span class="math inline">\(100 \times 10\)</span> data matrix in there. <em>Tricky</em>. Here’s how to fit the full model with <strong>brms</strong> where we use the compact matrix-column syntax in the <code>formula</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>b4<span class="fl">.12</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> z <span class="sc">+</span> X,</span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> b),</span>
<span id="cb238-7"><a href="#cb238-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma)),</span>
<span id="cb238-8"><a href="#cb238-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb238-9"><a href="#cb238-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb238-10"><a href="#cb238-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b04.12"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the parameter summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b4<span class="fl">.12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: y ~ 1 + z + X 
   Data: d (Number of observations: 100) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     0.95      1.19    -1.30     3.25 1.00     6754     3448
z             4.75      0.42     3.92     5.54 1.00     8441     3485
X1            0.57      0.74    -0.91     2.04 1.00     6140     3288
X2            0.89      0.69    -0.54     2.22 1.00     6425     3219
X3            3.41      0.72     1.98     4.79 1.00     6276     3505
X4            2.81      0.73     1.42     4.25 1.00     6995     3266
X5            5.75      0.72     4.37     7.13 1.00     5745     3119
X6            6.40      0.75     4.94     7.87 1.00     6894     3199
X7            8.51      0.73     7.03     9.95 1.00     6379     3214
X8            8.39      0.72     6.97     9.77 1.00     6943     3015
X9            8.84      0.83     7.23    10.45 1.00     7032     2997
X10           9.30      0.70     7.93    10.67 1.00     5953     2927

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.99      0.15     1.71     2.31 1.00     5710     3133

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p><strong>brms</strong> automatically numbered our <span class="math inline">\(K = 10\)</span> <code>X</code> variables as <code>X1</code> through <code>X10</code>. As far as applications go, I’m not sure where I’d use this way of storing and modeling data in real life. But maybe some of y’all work in domains where this is just the right way to approach your data needs. If so, good luck and happy modeling.</p>
</section>
<section id="session-info" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="session-info">Session info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.1 (2025-06-13)
Platform: aarch64-apple-darwin20
Running under: macOS Ventura 13.4

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] splines   parallel  stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] tidybayes_3.0.7      brms_2.23.0          Rcpp_1.1.0           posterior_1.6.1.9000 cmdstanr_0.9.0       patchwork_1.3.2     
 [7] lubridate_1.9.4      forcats_1.0.1        stringr_1.6.0        dplyr_1.1.4          purrr_1.2.1          readr_2.1.5         
[13] tidyr_1.3.2          tibble_3.3.1         ggplot2_4.0.1        tidyverse_2.0.0     

loaded via a namespace (and not attached):
 [1] svUnit_1.0.8            tidyselect_1.2.1        viridisLite_0.4.2       farver_2.1.2            loo_2.9.0.9000         
 [6] S7_0.2.1                fastmap_1.2.0           TH.data_1.1-4           tensorA_0.36.2.1        digest_0.6.39          
[11] timechange_0.3.0        estimability_1.5.1      lifecycle_1.0.5         StanHeaders_2.36.0.9000 survival_3.8-3         
[16] processx_3.8.6          magrittr_2.0.4          compiler_4.5.1          rlang_1.1.7             tools_4.5.1            
[21] utf8_1.2.6              yaml_2.3.12             knitr_1.51              emo_0.0.0.9000          labeling_0.4.3         
[26] bridgesampling_1.2-1    htmlwidgets_1.6.4       curl_7.0.0              pkgbuild_1.4.8          plyr_1.8.9             
[31] RColorBrewer_1.1-3      abind_1.4-8             multcomp_1.4-29         withr_3.0.2             stats4_4.5.1           
[36] grid_4.5.1              inline_0.3.21           xtable_1.8-4            emmeans_1.11.2-8        scales_1.4.0           
[41] MASS_7.3-65             isoband_0.3.0           cli_3.6.5               mvtnorm_1.3-3           rmarkdown_2.30         
[46] crayon_1.5.3            generics_0.1.4          RcppParallel_5.1.11-1   rstudioapi_0.17.1       reshape2_1.4.5         
[51] tzdb_0.5.0              rstan_2.36.0.9000       bayesplot_1.15.0.9000   assertthat_0.2.1        matrixStats_1.5.0      
[56] vctrs_0.7.0             V8_8.0.1                Matrix_1.7-3            sandwich_3.1-1          jsonlite_2.0.0         
[61] hms_1.1.4               arrayhelpers_1.1-0      ggdist_3.3.3            glue_1.8.0              codetools_0.2-20       
[66] ps_1.9.1                distributional_0.5.0    stringi_1.8.7           shape_1.4.6.1           gtable_0.3.6           
[71] QuickJSR_1.8.1          pillar_1.11.1           htmltools_0.5.9         Brobdingnag_1.2-9       R6_2.6.1               
[76] evaluate_1.0.5          lattice_0.22-7          backports_1.5.0         rstantools_2.5.0.9000   gridExtra_2.3          
[81] coda_0.19-4.1           nlme_3.1-168            checkmate_2.3.3         mgcv_1.9-3              xfun_0.55              
[86] zoo_1.8-14              pkgconfig_2.0.3        </code></pre>
</div>
</div>
</section>
<section id="comments" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="comments">Comments</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list" style="display: none">
<div id="ref-aonoLongTermChange2012" class="csl-entry" role="listitem">
Aono, Y. (2012). Long-term change in climate and floral phenophase. <em>Chikyu Kankyo (Global Environment)</em>, <em>17</em>. <a href="http://atmenv.envi.osakafu-u.ac.jp/aono/kyophenotemp4/">http://atmenv.envi.osakafu-u.ac.jp/aono/kyophenotemp4/</a>
</div>
<div id="ref-aonoPhenologicalDataSeries2008" class="csl-entry" role="listitem">
Aono, Y., &amp; Kazui, K. (2008). Phenological data series of cherry tree flowering in <span>Kyoto</span>, <span>Japan</span>, and its application to reconstruction of springtime temperatures since the 9th century. <em>International Journal of Climatology</em>, <em>28</em>(7), 905–914. <a href="https://doi.org/10.1002/joc.1594">https://doi.org/10.1002/joc.1594</a>
</div>
<div id="ref-aonoClarifyingSpringtimeTemperature2010" class="csl-entry" role="listitem">
Aono, Y., &amp; Saito, S. (2010). Clarifying springtime temperature reconstructions of the medieval period by gap-filling the cherry blossom phenological data series at <span>Kyoto</span>, <span>Japan</span>. <em>International Journal of Biometeorology</em>, <em>54</em>(2), 211–219. <a href="https://doi.org/10.1007/s00484-009-0272-x">https://doi.org/10.1007/s00484-009-0272-x</a>
</div>
<div id="ref-brms2022RM" class="csl-entry" role="listitem">
Bürkner, P.-C. (2022a). <em><span class="nocase">brms</span> reference manual, <span>Version</span> 2.18.0</em>. <a href="https://CRAN.R-project.org/package=brms/brms.pdf">https://CRAN.R-project.org/package=brms/brms.pdf</a>
</div>
<div id="ref-Bürkner2022Non_linear" class="csl-entry" role="listitem">
Bürkner, P.-C. (2022b). <em>Estimating non-linear models with brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_nonlinear.html">https://CRAN.R-project.org/package=brms/vignettes/brms_nonlinear.html</a>
</div>
<div id="ref-R-posterior" class="csl-entry" role="listitem">
Bürkner, P.-C., Gabry, J., Kay, M., &amp; Vehtari, A. (2022). <em><span class="nocase">posterior</span>: <span>Tools</span> for working with posterior distributions</em>. <a href="https://CRAN.R-project.org/package=posterior">https://CRAN.R-project.org/package=posterior</a>
</div>
<div id="ref-gelmanRegressionOtherStories2020" class="csl-entry" role="listitem">
Gelman, A., Hill, J., &amp; Vehtari, A. (2020). <em>Regression and other stories</em>. Cambridge University Press. <a href="https://doi.org/10.1017/9781139161879">https://doi.org/10.1017/9781139161879</a>
</div>
<div id="ref-howell2001demography" class="csl-entry" role="listitem">
Howell, N. (2001). <em>Demography of the dobe! <span>Kung</span></em> (2nd Edition). Routledge. <a href="https://www.routledge.com/Demography-of-the-Dobe-Kung/Howell/p/book/9780202306490">https://www.routledge.com/Demography-of-the-Dobe-Kung/Howell/p/book/9780202306490</a>
</div>
<div id="ref-howell2010life" class="csl-entry" role="listitem">
Howell, N. (2010). <em>Life histories of the <span>Dobe</span>! <span>Kung</span>: <span>Food</span>, fatness, and well-being over the life span</em> (Vol. 4). Univ of California Press. <a href="https://www.ucpress.edu/book/9780520262348/life-histories-of-the-dobe-kung">https://www.ucpress.edu/book/9780520262348/life-histories-of-the-dobe-kung</a>
</div>
<div id="ref-kruschkeDoingBayesianData2015" class="csl-entry" role="listitem">
Kruschke, J. K. (2015). <em>Doing <span>Bayesian</span> data analysis: <span>A</span> tutorial with <span>R</span>, <span>JAGS</span>, and <span>Stan</span></em>. Academic Press. <a href="https://sites.google.com/site/doingbayesiandataanalysis/">https://sites.google.com/site/doingbayesiandataanalysis/</a>
</div>
<div id="ref-kurzDoingBayesianDataAnalysis2026" class="csl-entry" role="listitem">
Kurz, A. S. (2026). <em>Doing <span>Bayesian</span> data analysis in brms and the tidyverse</em> (Version 1.3.0). <a href="https://solomon.quarto.pub/dbda2/">https://solomon.quarto.pub/dbda2/</a>
</div>
<div id="ref-R-rethinking" class="csl-entry" role="listitem">
McElreath, R. (2020a). <em><span class="nocase">rethinking</span> <span>R</span> package</em>. <a href="https://xcelab.net/rm/software/">https://xcelab.net/rm/software/</a>
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2020" class="csl-entry" role="listitem">
McElreath, R. (2020b). <em>Statistical rethinking: <span>A Bayesian</span> course with examples in <span>R</span> and <span>Stan</span></em> (Second Edition). CRC Press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a>
</div>
<div id="ref-pengProgrammingDataScience2022" class="csl-entry" role="listitem">
Peng, R. D. (2022). <em>R programming for data science</em>. <a href="https://bookdown.org/rdpeng/rprogdatascience/">https://bookdown.org/rdpeng/rprogdatascience/</a>
</div>
<div id="ref-PivotDataWide2020" class="csl-entry" role="listitem">
<em>Pivot data from wide to long — pivot_longer</em>. (2020). <a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">https://tidyr.tidyverse.org/reference/pivot_longer.html</a>
</div>
<div id="ref-R-MASS" class="csl-entry" role="listitem">
Ripley, B. (2022). <em><span>MASS</span>: <span>Support</span> functions and datasets for venables and <span>Ripley</span>’s <span>MASS</span></em>. <a href="https://CRAN.R-project.org/package=MASS">https://CRAN.R-project.org/package=MASS</a>
</div>
<div id="ref-simmonsFalsepositivePsychologyUndisclosed2011" class="csl-entry" role="listitem">
Simmons, J. P., Nelson, L. D., &amp; Simonsohn, U. (2011). False-positive psychology: <span>Undisclosed</span> flexibility in data collection and analysis allows presenting anything as significant. <em>Psychological Science</em>, <em>22</em>(11), 1359–1366. <a href="https://doi.org/10.1177/0956797611417632">https://doi.org/10.1177/0956797611417632</a>
</div>
<div id="ref-standevelopmentteamRStanInterfaceStan2023" class="csl-entry" role="listitem">
Stan Development Team. (2023). <em><span>RStan</span>: <span>The R Interface</span> to <span>Stan</span></em>. <a href="https://CRAN.R-project.org/package=rstan/vignettes/rstan.html">https://CRAN.R-project.org/package=rstan/vignettes/rstan.html</a>
</div>
<div id="ref-MASS2002" class="csl-entry" role="listitem">
Venables, W. N., &amp; Ripley, B. D. (2002). <em>Modern applied statistics with <span>S</span></em> (Fourth Edition). Springer. <a href="http://www.stats.ox.ac.uk/pub/MASS4">http://www.stats.ox.ac.uk/pub/MASS4</a>
</div>
<div id="ref-mgcv2003" class="csl-entry" role="listitem">
Wood, S. N. (2003). Thin-plate regression splines. <em>Journal of the Royal Statistical Society (B)</em>, <em>65</em>(1), 95–114. <a href="https://doi.org/10.1111/1467-9868.00374">https://doi.org/10.1111/1467-9868.00374</a>
</div>
<div id="ref-mgcv2004" class="csl-entry" role="listitem">
Wood, S. N. (2004). Stable and efficient multiple smoothing parameter estimation for generalized additive models. <em>Journal of the American Statistical Association</em>, <em>99</em>(467), 673–686. <a href="https://doi.org/10.1198/016214504000000980">https://doi.org/10.1198/016214504000000980</a>
</div>
<div id="ref-mgcv2011" class="csl-entry" role="listitem">
Wood, S. N. (2011). Fast stable restricted maximum likelihood and marginal likelihood estimation of semiparametric generalized linear models. <em>Journal of the Royal Statistical Society (B)</em>, <em>73</em>(1), 3–36. <a href="https://doi.org/10.1111/j.1467-9868.2010.00749.x">https://doi.org/10.1111/j.1467-9868.2010.00749.x</a>
</div>
<div id="ref-mgcv2017" class="csl-entry" role="listitem">
Wood, S. N. (2017a). <em>Generalized additive models: <span>An</span> introduction with <span>R</span></em> (2nd ed.). <span>Chapman and Hall/CRC</span>. <a href="https://www.routledge.com/Generalized-Additive-Models-An-Introduction-with-R-Second-Edition/Wood/p/book/9781498728331?utm_source=crcpress.com&amp;utm_medium=referral">https://www.routledge.com/Generalized-Additive-Models-An-Introduction-with-R-Second-Edition/Wood/p/book/9781498728331?utm_source=crcpress.com&amp;utm_medium=referral</a>
</div>
<div id="ref-woodGeneralizedAdditiveModels2017" class="csl-entry" role="listitem">
Wood, S. N. (2017b). <em>Generalized additive models: <span>An</span> introduction with <span>R</span></em> (Second Edition). CRC Press. <a href="https://www.routledge.com/Generalized-Additive-Models-An-Introduction-with-R-Second-Edition/Wood/p/book/9781498728331">https://www.routledge.com/Generalized-Additive-Models-An-Introduction-with-R-Second-Edition/Wood/p/book/9781498728331</a>
</div>
<div id="ref-R-mgcv" class="csl-entry" role="listitem">
Wood, S. N. (2022). <em><span class="nocase">mgcv</span>: <span>Mixed GAM</span> computation vehicle with automatic smoothness estimation</em>. <a href="https://CRAN.R-project.org/package=mgcv">https://CRAN.R-project.org/package=mgcv</a>
</div>
<div id="ref-mgcv2016" class="csl-entry" role="listitem">
Wood, S. N., Pya, N., &amp; Säfken, B. (2016). Smoothing parameter and model selection for general smooth models (with discussion). <em>Journal of the American Statistical Association</em>, <em>111</em>, 1548–1575. <a href="https://doi.org/10.1080/01621459.2016.1180986">https://doi.org/10.1080/01621459.2016.1180986</a>
</div>
</div>
</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/solomon\.quarto\.pub\/sr2\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed";
    script.dataset.repoId = "MDEwOlJlcG9zaXRvcnkxNjE5MTg0MTE=";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOCaaty84C1AJZ";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03.html" class="pagination-link" aria-label="Sampling the Imaginary">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Sampling the Imaginary</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./05.html" class="pagination-link" aria-label="The Many Variables &amp; The Spurious Waffles">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The Many Variables &amp; The Spurious Waffles</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>