<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>12&nbsp; Monsters and Mixtures – *Statistical rethinking* 2 with brms and the tidyverse</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./13.html" rel="next">
<link href="./11.html" rel="prev">
<link href="./mischa_favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7d082c015fa132ca880f975003d7bf2f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="12&nbsp; Monsters and Mixtures – Statistical rethinking 2 with brms and the tidyverse">
<meta property="og:description" content="">
<meta property="og:image" content="https://solomon.quarto.pub/sr2/12_files/figure-html/unnamed-chunk-2-1.png">
<meta property="og:site_name" content="*Statistical rethinking* 2 with brms and the tidyverse">
<meta property="og:image:height" content="384">
<meta property="og:image:width" content="1344">
</head>

<body class="nav-sidebar floating slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./12.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Monsters and Mixtures</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./"><em>Statistical rethinking</em> 2 with brms and the tidyverse</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Golem of Prague</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Small Worlds and Large Worlds</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Sampling the Imaginary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geocentric Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The Many Variables &amp; The Spurious Waffles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The Haunted DAG &amp; The Causal Terror</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Ulysses’ Compass</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Conditional Manatees</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Big Entropy and the Generalized Linear Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">God Spiked the Integers</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Monsters and Mixtures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Models With Memory</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Adventures in Covariance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Missing Data and Other Opportunities</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Generalized Linear Madness</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title"><del>Horoscopes</del> Insights</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-Over-dispersed-counts" id="toc-sec-Over-dispersed-counts" class="nav-link active" data-scroll-target="#sec-Over-dispersed-counts"><span class="header-section-number">12.1</span> Over-dispersed counts</a>
  <ul>
  <li><a href="#sec-Beta-binomial" id="toc-sec-Beta-binomial" class="nav-link" data-scroll-target="#sec-Beta-binomial"><span class="header-section-number">12.1.1</span> Beta-binomial</a></li>
  <li><a href="#negative-binomial-or-gamma-poisson" id="toc-negative-binomial-or-gamma-poisson" class="nav-link" data-scroll-target="#negative-binomial-or-gamma-poisson"><span class="header-section-number">12.1.2</span> Negative-binomial or gamma-Poisson</a></li>
  <li><a href="#over-dispersion-entropy-and-information-criteria" id="toc-over-dispersion-entropy-and-information-criteria" class="nav-link" data-scroll-target="#over-dispersion-entropy-and-information-criteria"><span class="header-section-number">12.1.3</span> Over-dispersion, entropy, and information criteria</a></li>
  </ul></li>
  <li><a href="#zero-inflated-outcomes" id="toc-zero-inflated-outcomes" class="nav-link" data-scroll-target="#zero-inflated-outcomes"><span class="header-section-number">12.2</span> Zero-inflated outcomes</a>
  <ul>
  <li><a href="#rethinking-breaking-the-law" id="toc-rethinking-breaking-the-law" class="nav-link" data-scroll-target="#rethinking-breaking-the-law"><span class="header-section-number">12.2.0.1</span> Rethinking: Breaking the law</a></li>
  <li><a href="#example-zero-inflated-poisson" id="toc-example-zero-inflated-poisson" class="nav-link" data-scroll-target="#example-zero-inflated-poisson"><span class="header-section-number">12.2.1</span> Example: Zero-inflated Poisson</a>
  <ul>
  <li><a href="#overthinking-zero-inflated-poisson-calculations-in-stan" id="toc-overthinking-zero-inflated-poisson-calculations-in-stan" class="nav-link" data-scroll-target="#overthinking-zero-inflated-poisson-calculations-in-stan"><span class="header-section-number">12.2.1.1</span> Overthinking: Zero-inflated Poisson calculations in Stan</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-Ordered-categorical-outcomes" id="toc-sec-Ordered-categorical-outcomes" class="nav-link" data-scroll-target="#sec-Ordered-categorical-outcomes"><span class="header-section-number">12.3</span> Ordered categorical outcomes</a>
  <ul>
  <li><a href="#example-moral-intuition" id="toc-example-moral-intuition" class="nav-link" data-scroll-target="#example-moral-intuition"><span class="header-section-number">12.3.1</span> Example: Moral intuition</a></li>
  <li><a href="#describing-an-ordered-distribution-with-intercepts" id="toc-describing-an-ordered-distribution-with-intercepts" class="nav-link" data-scroll-target="#describing-an-ordered-distribution-with-intercepts"><span class="header-section-number">12.3.2</span> Describing an ordered distribution with intercepts</a></li>
  <li><a href="#sec-Adding-predictor-variables" id="toc-sec-Adding-predictor-variables" class="nav-link" data-scroll-target="#sec-Adding-predictor-variables"><span class="header-section-number">12.3.3</span> Adding predictor variables</a>
  <ul>
  <li><a href="#rethinking-staring-into-the-abyss" id="toc-rethinking-staring-into-the-abyss" class="nav-link" data-scroll-target="#rethinking-staring-into-the-abyss"><span class="header-section-number">12.3.3.1</span> Rethinking: Staring into the abyss</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-Ordered-categorical-predictors" id="toc-sec-Ordered-categorical-predictors" class="nav-link" data-scroll-target="#sec-Ordered-categorical-predictors"><span class="header-section-number">12.4</span> Ordered categorical predictors</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">12.5</span> Summary</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  <li><a href="#comments" id="toc-comments" class="nav-link" data-scroll-target="#comments">Comments</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-Monsters-and-Mixtures" class="quarto-section-identifier"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Monsters and Mixtures</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<p>Many monsters are hybrids. Many statistical models are too. This chapter is about constructing likelihood and link functions by piecing together the simpler components of previous chapters. Like legendary monsters, these hybrid likelihoods contain pieces of other model types. Endowed with some properties of each piece, they help us model outcome variables with inconvenient, but common, properties….</p>
<p>We’ll consider three common and useful examples. The first are models for handling <strong>over-dispersion</strong>. These models extend the binomial and Poisson models of the previous chapter to cope a bit with unmeasured sources of variation. The second type is a family of <strong>zero-inflated</strong> and <strong>zero-augmented</strong> models, each of which mixes a binary event with an ordinary GLM likelihood like a Poisson or binomial. The third type is the <strong>ordered categorical</strong> model, useful for categorical outcomes with a fixed ordering. This model is built by merging a categorical likelihood function with a special kind of link function, usually a <strong>cumulative link</strong>. We’ll also learn how to construct ordered categorical predictors.</p>
<p>These model types help us transform our modeling to cope with the inconvenient realities of measurement, rather than transforming measurements to cope with the constraints of our models. <span class="citation" data-cites="mcelreathStatisticalRethinkingBayesian2020">(<a href="references.html#ref-mcelreathStatisticalRethinkingBayesian2020" role="doc-biblioref">McElreath, 2020, p. 369</a>, <strong>emphasis</strong> in the original)</span></p>
</blockquote>
<section id="sec-Over-dispersed-counts" class="level2 page-columns page-full" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="sec-Over-dispersed-counts"><span class="header-section-number">12.1</span> Over-dispersed counts</h2>
<blockquote class="blockquote">
<p>When counts arise from a mixture of different processes, then there may be more variation–thicker tails–than a pure count model expects. This can again lead to overly excited models. When counts are more variable than a pure process, they exhibit <strong>over-dispersion</strong>. The variance of a variable is sometimes called its <strong>dispersion</strong>. For a counting process like a binomial, the variance is a function of the same parameters as the expected value. For example, the expected value of a binomial is <span class="math inline">\(Np\)</span> and its variance is <span class="math inline">\(Np(1 - p)\)</span>. When the observed variance exceeds this amount–after conditioning on all the predictor variables–this implies that some omitted variable is producing additional dispersion in the observed counts.</p>
<p>That isn’t necessarily bad. Such a model could still produce perfectly good inferences. But ignoring over-dispersion can also lead to all of the same problems as ignoring any predictor variable. Heterogeneity in counts can be a confound, hiding effects of interest or producing spurious inferences. (p, 370, <strong>emphasis</strong> in the original)</p>
</blockquote>
<p>In this chapter we’ll cope with the problem using continuous mixture models, “models in which a linear model is attached not to the observations themselves but rather to a distribution of observations” (p.&nbsp;370).</p>
<section id="sec-Beta-binomial" class="level3 page-columns page-full" data-number="12.1.1">
<h3 data-number="12.1.1" class="anchored" data-anchor-id="sec-Beta-binomial"><span class="header-section-number">12.1.1</span> Beta-binomial</h3>
<blockquote class="blockquote">
<p>A <strong>beta-binomial</strong> model is a mixture of binomial distributions. It assumes that each binomial count observation has its own probability of success. We estimate the <em>distribution</em> of probabilities of success instead of a single probability of success. Any predictor variables describe the shape of this distribution. (p, 370, <strong>emphasis</strong> in the original)</p>
</blockquote>
<p>Unfortunately, we need to digress. As it turns out, there are multiple ways to parameterize the beta distribution and we’ve run square into two. In the text, McElreath described the beta distribution with two parameters, an average probability <span class="math inline">\(\bar p\)</span> and a shape parameter <span class="math inline">\(\theta\)</span>. In his <strong>R</strong> code 12.1, which we’ll reproduce in a bit, he demonstrated that parameterization with the <code>rethinking::dbeta2()</code> function. The nice thing about this parameterization is how intuitive the <code>pbar</code> parameter is. If you want a beta with an average of 0.2, you set <code>pbar = 0.2</code>. If you want the distribution to be more or less certain, make the <code>theta</code> argument more or less large, respectively.</p>
<p>However, the beta density is often defined in terms of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>. If you denote the data as <span class="math inline">\(y\)</span>, this follows the form</p>
<p><span class="math display">\[\operatorname{Beta}(y \mid \alpha, \beta) = \frac{y^{\alpha - 1} (1 - y)^{\beta - 1}}{\text B (\alpha, \beta)},\]</span></p>
<p>which you can verify in the <a href="https://mc-stan.org/docs/functions-reference/continuous-distributions-on-0-1.html"><em>Continuous distributions on [0, 1]</em> section <em>Stan functions reference</em></a> <span class="citation" data-cites="standevelopmentteamStanFunctionsReference2022">(<a href="references.html#ref-standevelopmentteamStanFunctionsReference2022" role="doc-biblioref">Stan Development Team, 2022</a>)</span>. In the formula, <span class="math inline">\(\text B\)</span> stands for the Beta function, which computes a normalizing constant, which you can learn about in the <a href="https://mc-stan.org/docs/functions-reference/math-functions.html"><em>Mathematical functions</em> chapter</a> of the Stan functions reference. If you look at the base <strong>R</strong> <code>dbeta()</code> function, you’ll learn it takes two parameters, <code>shape1</code> and <code>shape2</code>. Those uncreatively-named parameters are the same <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> from the density, above. They do not correspond to the <code>pbar</code> and <code>theta</code> parameters of McEreath’s <code>rethinking::dbeta2()</code> function.</p>
<p>McElreath had good reason for using <code>dbeta2()</code>. Beta’s typical <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> parameters aren’t the most intuitive to use; the parameters in McElreath’s <code>dbeta2()</code> are much nicer. If you dive a little deeper, it turns out you can find the mean of a beta distribution in terms of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> like this:</p>
<p><span class="math display">\[\mu = \frac{\alpha}{\alpha + \beta}.\]</span></p>
<p>We can talk about the spread of the distribution, sometimes called <span class="math inline">\(\kappa\)</span>, in terms <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> like this:</p>
<p><span class="math display">\[\kappa = \alpha + \beta.\]</span></p>
<p>With <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\kappa\)</span> in hand, we can even find the <span class="math inline">\(\textit{SD}\)</span> of a beta distribution with the formula</p>
<p><span class="math display">\[\sigma = \sqrt{\mu (1 - \mu) / (\kappa + 1)}.\]</span></p>
<p>I explicate all this because McElreath’s <code>pbar</code> is <span class="math inline">\(\mu = \frac{\alpha}{\alpha + \beta}\)</span> and his <code>theta</code> is <span class="math inline">\(\kappa = \alpha + \beta\)</span>, which is great news because it means that we can understand what McElreath did with his <code>beta2()</code> function in terms of the base <strong>R</strong> <code>dbeta()</code> function. This also sets us up to understand the distribution of the beta parameters used in <code>brms::brm()</code>. To demonstrate, let’s walk through McElreath’s <strong>R</strong> code 12.1.</p>
<p>Before we get to <strong>R</strong> code 12.1 and our version of the resulting plot, we should discuss themes. In this chapter we’ll use theme settings and a color palette from the <a href="https://cran.r-project.org/package=ggthemes"><strong>ggthemes</strong> package</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggthemes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll take our basic theme settings from the <code>theme_hc()</code> function. We’ll use the <code>Green fields</code> color palette, which we can inspect with the <code>canva_pal()</code> function and a little help from <code>scales::show_col()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">show_col</span>(<span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "#919636" "#524a3a" "#fffae1" "#5a5f37"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "#fffae1"</code></pre>
</div>
</div>
<p>Now we finally get to <strong>R</strong> code 12.1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_hc</span>() <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"grey92"</span>))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>pbar  <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.01</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density =</span> rethinking<span class="sc">::</span><span class="fu">dbeta2</span>(x, <span class="at">prob =</span> pbar, <span class="at">theta =</span> theta)) <span class="sc">|&gt;</span> </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"probability space"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">expression</span>(The<span class="sc">~</span>beta<span class="sc">~</span>distribution),</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"Defined in terms of "</span><span class="sc">*</span>mu<span class="sc">*</span><span class="st">" (i.e., pbar) and "</span><span class="sc">*</span>kappa<span class="sc">*</span><span class="st">" (i.e., theta)"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>In his <span class="citation" data-cites="kruschkeDoingBayesianData2015">(<a href="references.html#ref-kruschkeDoingBayesianData2015" role="doc-biblioref">2015</a>)</span> text, <a href="https://sites.google.com/site/doingbayesiandataanalysis/"><em>Doing Bayesian data analysis</em></a>, Kruschke provided code for a convenience function that takes <code>pbar</code> and <code>theta</code> as inputs and returns the corresponding <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> values. Here’s the function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>betaABfromMeanKappa <span class="ot">&lt;-</span> <span class="cf">function</span>(mean, kappa) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (mean <span class="sc">&lt;=</span> <span class="dv">0</span> <span class="sc">|</span> mean <span class="sc">&gt;=</span> <span class="dv">1</span>) <span class="fu">stop</span>(<span class="st">"must have 0 &lt; mean &lt; 1"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (kappa <span class="sc">&lt;=</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"kappa must be &gt; 0"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> mean <span class="sc">*</span> kappa</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> (<span class="fl">1.0</span> <span class="sc">-</span> mean) <span class="sc">*</span> kappa</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">a =</span> a, <span class="at">b =</span> b))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can use Kruschke’s <code>betaABfromMeanKappa()</code> to find the <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> values corresponding to <code>pbar</code> and <code>theta</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">betaABfromMeanKappa</span>(<span class="at">mean =</span> pbar, <span class="at">kappa =</span> theta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$a
[1] 2.5

$b
[1] 2.5</code></pre>
</div>
</div>
<p>And finally, we can double check that all of this works. Here’s the same distribution but defined in terms of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.01</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density =</span> <span class="fu">dbeta</span>(x, <span class="at">shape1 =</span> <span class="fl">2.5</span>, <span class="at">shape2 =</span> <span class="fl">2.5</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>]) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"probability space"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">expression</span>(The<span class="sc">~</span>beta<span class="sc">~</span>distribution),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"This time defined in terms of "</span><span class="sc">*</span>alpha<span class="sc">*</span><span class="st">" and "</span><span class="sc">*</span>beta))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>McElreath encouraged us to “explore different values for <code>pbar</code> and <code>theta</code>” (p.&nbsp;371). Here’s a grid of plots with <code>pbar = c(0.25, 0.5, 0.75)</code> and <code>theta = c(5, 10, 15)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">crossing</span>(<span class="at">pbar  =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">theta =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">15</span>, <span class="dv">30</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density =</span> rethinking<span class="sc">::</span><span class="fu">dbeta2</span>(x, <span class="at">prob =</span> pbar, <span class="at">theta =</span> theta),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">mu      =</span> <span class="fu">str_c</span>(<span class="st">"mu == "</span>, pbar <span class="sc">|&gt;</span> <span class="fu">str_remove</span>(<span class="st">"0"</span>)),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">kappa   =</span> <span class="fu">factor</span>(<span class="fu">str_c</span>(<span class="st">"kappa == "</span>, theta), </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"kappa == 30"</span>, <span class="st">"kappa == 15"</span>, <span class="st">"kappa == 5"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>]) <span class="sc">+</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"probability space"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">labels =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(kappa <span class="sc">~</span> mu, <span class="at">labeller =</span> label_parsed) <span class="sc">+</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>If you’d like to see how to make a similar plot in terms of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>, see <a href="https://solomon.quarto.pub/dbda2/06.html">Chapter 6</a> of my <span class="citation" data-cites="kurzDoingBayesianDataAnalysis2026">(<a href="references.html#ref-kurzDoingBayesianDataAnalysis2026" role="doc-biblioref">2026</a>)</span> <a href="https://solomon.quarto.pub/dbda2/">ebook</a> wherein I translated Kruschke’s text into <strong>tidyverse</strong> and <strong>brms</strong> code.</p>
<p>But remember, we’re not fitting a beta model. We’re using the beta-binomial. “We’re going to bind our linear model to <span class="math inline">\(\bar p\)</span>, so that changes in predictor variables change the central tendency of the distribution” (p.&nbsp;371). The statistical model we’ll be fitting follows the form</p>
<p><span class="math display">\[\begin{align*}
\text{admit}_i &amp; \sim \operatorname{BetaBinomial}(n_i, \bar p_i, \phi)\\
\operatorname{logit}(\bar p_i) &amp; = \alpha_{\text{gid}[i]} \\
\alpha_j                       &amp; \sim \operatorname{Normal}(0, 1.5) \\
\phi                           &amp; \sim \operatorname{Exponential}(1).
\end{align*}\]</span></p>
<p>Here the size, <span class="math inline">\(n\)</span>, is defined in the <code>applications</code> column in the data we’ll load in just a moment. In case you’re confused, yes, our statistical model is not quite the same as the one McElreath presented on page 371 in the text. If you look closely, we dropped all mention of <span class="math inline">\(\theta\)</span> and jumped directly to <span class="math inline">\(\phi\)</span>. Instead of implementing McElreath’s <span class="math inline">\(\theta = \phi + 2\)</span> trick, we’re going to set the lower bound for <span class="math inline">\(\phi\)</span> directly. Which brings us to the next issue:</p>
<p>The beta-binomial has historically not been officially supported by <strong>brms</strong> (see <a href="https://github.com/paul-buerkner/brms/issues/144">GitHub issue #144</a>).<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> However, <strong>brms</strong> versions 2.2.0 and above allow users to define custom distributions. To get all the details, you might check out Bürkner’s <span class="citation" data-cites="Bürkner2022Define">(<a href="references.html#ref-Bürkner2022Define" role="doc-biblioref">2022b</a>)</span> vignette, <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_customfamilies.html"><em>Define custom response distributions with brms</em></a>. Happily, Bürkner even used the <a href="https://cran.r-project.org/package=brms/vignettes/brms_customfamilies.html#the-beta-binomial-distribution">beta-binomial distribution as the exemplar</a> in the vignette.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Okay, it’s actually a little more complicated. <strong>brms</strong> has officially supported family <code>beta_binomial</code> since version 2.17.0. For the official news release, see <a href="https://CRAN.R-project.org/package=brms/news/news.html">here</a>. However, I still think it’s worth while to show how to make a custom likelihood with <strong>brms</strong>. But be warned that I consider this advanced. For example, I would be extremely hesitant to make a custom likelihood for my own research work. I’m just not responsible enough for that kind of power.</p></div></div><p>Before we get carried away, let’s load the data and <strong>brms</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(UCBadmit, <span class="at">package =</span> <span class="st">"rethinking"</span>) </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> UCBadmit <span class="sc">|&gt;</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gid =</span> <span class="fu">ifelse</span>(applicant.gender <span class="sc">==</span> <span class="st">"male"</span>, <span class="st">"1"</span>, <span class="st">"2"</span>))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(UCBadmit)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’m not going to go into great detail explaining the ins and outs of making custom distributions for <code>brm()</code>. You’ve got Bürkner’s vignette for that. For our purposes, we need a few preparatory steps. First, we need to use the <code>custom_family()</code> function to define the name and parameters of the beta-binomial distribution for use in <code>brm()</code>. Second, we have to define some functions for Stan which are not defined in Stan itself. We’ll save them as <code>stan_funs</code>. Third, we’ll make a <code>stanvar()</code> statement which will allow us to pass our <code>stan_funs</code> to <code>brm()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>beta_binomial2 <span class="ot">&lt;-</span> <span class="fu">custom_family</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"beta_binomial2"</span>, <span class="at">dpars =</span> <span class="fu">c</span>(<span class="st">"mu"</span>, <span class="st">"phi"</span>),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">links =</span> <span class="fu">c</span>(<span class="st">"logit"</span>, <span class="st">"log"</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">lb =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">ub =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="cn">NA</span>),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"int"</span>, <span class="at">vars =</span> <span class="st">"vint1[n]"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>stan_funs <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_binomial2_lpmf(int y, real mu, real phi, int T) {</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="st">    return beta_binomial_lpmf(y | T, mu * phi, (1 - mu) * phi);</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="st">  int beta_binomial2_rng(real mu, real phi, int T) {</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="st">    return beta_binomial_rng(T, mu * phi, (1 - mu) * phi);</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>stanvars <span class="ot">&lt;-</span> <span class="fu">stanvar</span>(<span class="at">scode =</span> stan_funs, <span class="at">block =</span> <span class="st">"functions"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Did you notice the <code>lb = c(0, 2)</code> portion of the code defining <code>beta_binomial2()</code>? In Bürkner’s vignette, he set the lower bound of <code>phi</code> to zero. Since McElreath wanted the lower bound for <span class="math inline">\(\phi\)</span> to be 2, we just set that as the default in the likelihood. We should clarify two more points:</p>
<p>First, what McElreath referred to as the shape parameter, <span class="math inline">\(\theta\)</span>, Bürkner called the precision parameter, <span class="math inline">\(\phi\)</span>. In our exposition, above, we followed Kruschke’s convention and called it <span class="math inline">\(\kappa\)</span>. These are all the same thing: <span class="math inline">\(\theta\)</span>, <span class="math inline">\(\phi\)</span>, and <span class="math inline">\(\kappa\)</span> are <strong>all the same thing</strong>. Perhaps less confusingly, what McElreath called the <code>pbar</code> parameter, <span class="math inline">\(\bar p\)</span>, Bürkner simply refers to as <span class="math inline">\(\mu\)</span>.</p>
<p>Second, we’ve become accustomed to using the <code>y | trials() ~ ...</code> syntax when defining our <code>formula</code> arguments for binomial models. Here we are replacing <code>trials()</code> with <code>vint()</code>. From Bürkner’s <em>Define custom response distributions with brms</em> vignette, we read:</p>
<blockquote class="blockquote">
<p>To provide information about the number of trials (an integer variable), we are going to use the addition argument <code>vint()</code>, which can only be used in custom families. Similarly, if we needed to include additional vectors of real data, we would use <code>vreal()</code>. Actually, for this particular example, we could more elegantly apply the addition argument <code>trials()</code> instead of <code>vint()</code> as in the basic binomial model. However, since the present vignette is meant to give a general overview of the topic, we will go with the more general method.</p>
<p>We now have all components together to fit our custom beta-binomial model:</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> beta_binomial2,  <span class="co"># Here's our custom likelihood</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  admit <span class="sc">|</span> <span class="fu">vint</span>(applications) <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> gid,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> b),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> phi)),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">stanvars =</span> stanvars,  <span class="co"># Note our `stanvars`</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">12</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b12.01"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Success, our results look a lot like those in the text!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b12<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: beta_binomial2 
  Links: mu = logit 
Formula: admit | vint(applications) ~ 0 + gid 
   Data: d (Number of observations: 12) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
gid1    -0.45      0.40    -1.22     0.34 1.00     3100     2211
gid2    -0.33      0.41    -1.15     0.47 1.00     3346     2229

Further Distributional Parameters:
    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
phi     3.07      0.83     2.05     4.99 1.00     2728     1886

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Just remember that, perhaps confusingly, what McElreath’s output called <code>theta</code>, our <strong>brms</strong> output is calling <code>phi</code>. I know; this section is a lot. Keep your chin up! Here’s what the corresponding <code>as_draws_df()</code> data object looks like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b12<span class="fl">.1</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(post)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A draws_df: 6 iterations, 1 chains, and 5 variables
  b_gid1 b_gid2 phi lprior lp__
1  -0.41  -0.49 4.4   -5.1  -71
2  -0.37  -0.20 3.4   -4.1  -70
3  -0.57  -0.41 3.4   -4.2  -70
4  -0.56  -0.31 3.8   -4.5  -70
5  -0.70  -0.83 3.8   -4.7  -71
6  -0.81  -1.13 3.5   -4.6  -73
# ... hidden reserved variables {'.chain', '.iteration', '.draw'}</code></pre>
</div>
</div>
<p>Now we can compute and summarize a contrast between the two genders, what McElreath called <code>da</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">da =</span> b_gid1 <span class="sc">-</span> b_gid2) <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_qi</span>(<span class="at">.width =</span> <span class="fl">0.89</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
      da .lower .upper .width .point .interval
   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 -0.118  -1.04  0.789   0.89 mean   qi       </code></pre>
</div>
</div>
<p>Much like in the text, the difference between genders on admission rates is near zero with wide uncertainty intervals spanning in either direction.</p>
<p>To stay within the <strong>tidyverse</strong> while making the many thin lines in Figure 12.1.a, we’re going to need to do a bit of data processing. First, we’ll want a variable to index the rows in <code>post</code> (i.e., to index the posterior draws). And we’ll want to convert the <code>b_gid2</code> to the <span class="math inline">\(\bar p\)</span> metric with the <code>plogis()</code> function. Then we’ll use <code>slice_sample()</code> to randomly draw a subset of the posterior draws. With the <code>expand_grid()</code> function, we’ll insert a dense sequence of <code>x</code> values ranging between 0 and 1–the parameter space of beta distribution. Finally, we’ll use <code>pmap_dbl()</code> to compute the density values for the <code>rethinking::dbeta2</code> distribution corresponding to the unique combination of <code>x</code>, <code>p_bar</code>, and <code>phi</code> values in each row.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>lines <span class="ot">&lt;-</span> post <span class="sc">|&gt;</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_bar =</span> <span class="fu">plogis</span>(b_gid2)) <span class="sc">|&gt;</span> </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.draw, p_bar, phi) <span class="sc">|&gt;</span> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.005</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density =</span> <span class="fu">pmap_dbl</span>(<span class="at">.l =</span> <span class="fu">list</span>(x, p_bar, phi), <span class="at">.f =</span> rethinking<span class="sc">::</span>dbeta2))</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(lines)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [20,100 × 5] (S3: tbl_df/tbl/data.frame)
 $ .draw  : int [1:20100] 450 450 450 450 450 450 450 450 450 450 ...
 $ p_bar  : num [1:20100] 0.524 0.524 0.524 0.524 0.524 ...
 $ phi    : num [1:20100] 2.65 2.65 2.65 2.65 2.65 ...
 $ x      : num [1:20100] 0 0.005 0.01 0.015 0.02 0.025 0.03 0.035 0.04 0.045 ...
 $ density: num [1:20100] 0 0.237 0.31 0.362 0.404 ...</code></pre>
</div>
</div>
<p>All that was just for the thin lines. To make the thicker line for the posterior mean, we’ll get tricky with <code>stat_function()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>lines <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> rethinking<span class="sc">::</span>dbeta2,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">prob =</span> <span class="fu">mean</span>(<span class="fu">plogis</span>(post <span class="sc">|&gt;</span> <span class="fu">pull</span>(b_gid2))),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">theta =</span> <span class="fu">mean</span>(post <span class="sc">|&gt;</span> <span class="fu">pull</span>(phi))),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>], <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> .draw),</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>]) <span class="sc">+</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"probability admit"</span>,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"distribution of female admission rates"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>There are other ways to do this. For ideas, check out my blog post, <a href="https://solomonkurz.netlify.app/blog/2018-12-20-make-rotated-gaussians-kruschke-style/"><em>Make rotated Gaussians, Kruschke style</em></a>.</p>
<p>Before we can do our variant of Figure 12.1.b, we’ll need to define a few more custom functions. The <code>log_lik_beta_binomial2()</code> and <code>posterior_predict_beta_binomial2()</code> functions are required for <code>brms::predict()</code> to work with our <code>family = beta_binomial2</code> <code>brmfit</code> object. Similarly, <code>posterior_epred_beta_binomial2()</code> is required for <code>brms::fitted()</code> to work properly. And before all that, we need to throw in a line with the <code>expose_functions()</code> function. Just go with it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expose_functions</span>(b12<span class="fl">.1</span>, <span class="at">vectorize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Required to use `predict()`</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>log_lik_beta_binomial2 <span class="ot">&lt;-</span> <span class="cf">function</span>(i, prep) {</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  mu     <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">get_dpar</span>(prep, <span class="st">"mu"</span>, <span class="at">i =</span> i)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  phi    <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">get_dpar</span>(prep, <span class="st">"phi"</span>, <span class="at">i =</span> i)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  trials <span class="ot">&lt;-</span> prep<span class="sc">$</span>data<span class="sc">$</span>vint1[i]</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  y      <span class="ot">&lt;-</span> prep<span class="sc">$</span>data<span class="sc">$</span>Y[i]</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beta_binomial2_lpmf</span>(y, mu, phi, trials)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>posterior_predict_beta_binomial2 <span class="ot">&lt;-</span> <span class="cf">function</span>(i, prep, ...) {</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  mu     <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">get_dpar</span>(prep, <span class="st">"mu"</span>, <span class="at">i =</span> i)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  phi    <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">get_dpar</span>(prep, <span class="st">"phi"</span>, <span class="at">i =</span> i)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  trials <span class="ot">&lt;-</span> prep<span class="sc">$</span>data<span class="sc">$</span>vint1[i]</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beta_binomial2_rng</span>(mu, phi, trials)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Required to use `fitted()`</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>posterior_epred_beta_binomial2 <span class="ot">&lt;-</span> <span class="cf">function</span>(prep) {</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  mu     <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">get_dpar</span>(prep, <span class="st">"mu"</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  trials <span class="ot">&lt;-</span> prep<span class="sc">$</span>data<span class="sc">$</span>vint1</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  trials <span class="ot">&lt;-</span> <span class="fu">matrix</span>(trials, <span class="at">nrow =</span> <span class="fu">nrow</span>(mu), <span class="at">ncol =</span> <span class="fu">ncol</span>(mu), <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  mu <span class="sc">*</span> trials</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With those intermediary steps out of the way, we’re ready to make Figure 12.1.b.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The prediction intervals</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(b12<span class="fl">.1</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">ll =</span> Q2<span class="fl">.5</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul =</span> Q97<span class="fl">.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The fitted intervals</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fitted</span>(b12<span class="fl">.1</span>) <span class="sc">|&gt;</span> <span class="fu">data.frame</span>(),</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The original data used to fit the model</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    b12<span class="fl">.1</span><span class="sc">$</span>data) <span class="sc">|&gt;</span> </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">case =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>) <span class="sc">|&gt;</span> </span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot!</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> case)) <span class="sc">+</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ll <span class="sc">/</span> applications, </span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ymax =</span> ul <span class="sc">/</span> applications),</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>], </span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">linewidth =</span> <span class="fl">2.5</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>  <span class="sc">/</span> applications, </span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>                      <span class="at">ymax =</span> Q97<span class="fl">.5</span> <span class="sc">/</span> applications, </span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>                      <span class="at">y =</span> Estimate <span class="sc">/</span> applications),</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>],</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> admit<span class="sc">/</span>applications),</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>],</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span> <span class="sc">/</span> <span class="dv">5</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"A"</span>,</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Posterior validation check"</span>,</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="fu">expression</span>(<span class="fu">italic</span>(Note.)<span class="sc">*</span><span class="st">" A = admittance probability"</span>)) <span class="sc">+</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>As in the text, the raw data are consistent with the prediction intervals. But those intervals are so incredibly wide, they’re hardly an endorsement of the model. Once we learn about hierarchical models, we’ll be able to do much better.</p>
</section>
<section id="negative-binomial-or-gamma-poisson" class="level3 page-columns page-full" data-number="12.1.2">
<h3 data-number="12.1.2" class="anchored" data-anchor-id="negative-binomial-or-gamma-poisson"><span class="header-section-number">12.1.2</span> Negative-binomial or gamma-Poisson</h3>
<p>Recall from the last chapter how the Poisson distribution presumes <span class="math inline">\(\sigma^2\)</span> scales with <span class="math inline">\(\mu\)</span>. The negative binomial distribution relaxes this assumption and presumes “each Poisson count observation has its own rate. It estimates the shape of a gamma distribution to describe the Poisson rates across cases” (p.&nbsp;373).</p>
<p>If you execute <code>?dgamma</code>, you’ll see that base <strong>R</strong> will allow you to define the gamma distribution with either the <code>shape</code> and <code>rate</code> or the <code>shape</code> and <code>scale</code>. If we define gamma in terms of shape and rate, it follows the formula</p>
<p><span class="math display">\[\operatorname{Gamma}(y \mid \alpha, \beta) = \frac{\beta^\alpha y^{\alpha - 1} e^{-\beta y}}{\Gamma (\alpha)},\]</span></p>
<p>where <span class="math inline">\(\alpha\)</span> is the shape, <span class="math inline">\(\beta\)</span> is the rate, <span class="math inline">\(e\)</span> is base of the natural logarithm, and <span class="math inline">\(\Gamma\)</span> is the <a href="https://en.wikipedia.org/wiki/Gamma_function">gamma function</a>. It turns out the rate and scale parameters are the reciprocals of each other. Thus if you’d like to define a gamma distribution in terms of shape and scale, it would follow the formula</p>
<p><span class="math display">\[\operatorname{Gamma}(y \mid \alpha, \theta) = \frac{y^{\alpha - 1} e^{-x /\theta}}{\theta^\alpha \Gamma (\alpha)},\]</span></p>
<p>where <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(e\)</span>, and <span class="math inline">\(\Gamma\)</span> are all as they were before and <span class="math inline">\(\theta\)</span> is the scale parameter. If that all wasn’t complicated enough, it turns out there’s one more way to define a gamma distribution. You can use the mean and shape. This would follow the formula</p>
<p><span class="math display">\[\operatorname{Gamma}(y \mid \mu, \alpha) = \frac{ \big (\frac{\alpha}{\mu} \big)^\alpha}{\Gamma (\alpha)} y^{\alpha - 1} \exp (- \frac{\alpha y}{\mu}),\]</span></p>
<p>where <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\Gamma\)</span> are still the shape and gamma function, respectively, and <span class="math inline">\(\mu\)</span> is the mean. I know, this is a lot and it probably all seems really abstract, right now. Think of this section as a reference. As you’ll see after we fit our model, you may well need it. Returning to the content in the text, we might express the gamma-Poisson (negative binomial) as</p>
<p><span class="math display">\[y_i \sim \operatorname{Gamma-Poisson}(\mu, \alpha),\]</span></p>
<p>where <span class="math inline">\(\mu\)</span> is the mean or rate, taking the place of <span class="math inline">\(\lambda\)</span> from the Poisson distribution, and <span class="math inline">\(\alpha\)</span> is the shape. I should warn you that this notation is a little different from the notation McElreath used in the text (p.&nbsp;374), where he used <span class="math inline">\(\lambda\)</span> in place of our <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\phi\)</span> in place of our <span class="math inline">\(\alpha\)</span>. The meaning is really the same. The reason I have diverged from McElreath’s notation is to emphasize the connection with the walk-out, above. If you want to add injury to insult, compare both of these notations with the notation Bürkner used in his <span class="citation" data-cites="Bürkner2022Parameterization">(<a href="references.html#ref-Bürkner2022Parameterization" role="doc-biblioref">2022d</a>)</span> vignette, <a href="https://cran.r-project.org/package=brms/vignettes/brms_families.html#ordinal-and-categorical-models"><em>Parameterization of response distributions in brms</em></a>.</p>
<p>Since this all is already a pedagogical nightmare, let’s throw in one more technical tidbit before we start fitting models. I don’t believe McElreath plainly explained this in the text, but when we talk about the gamma-Poisson model as having two parameters, the <span class="math inline">\(\lambda\)</span> parameter (a.k.a. <span class="math inline">\(\mu\)</span>) is doing double duty. As with conventional Poisson models, <span class="math inline">\(\lambda\)</span> is the mean for the criterion. What might not be as clear is that <span class="math inline">\(\lambda\)</span> is also the mean of the gamma mixture distribution. So when you want to get a sense of the overall shape of the gamma-Poisson model-implied distribution of <span class="math inline">\(\lambda\)</span> parameters—one for each variable in the data set–, the distribution is gamma with a mean of <span class="math inline">\(\lambda\)</span> and shape of <span class="math inline">\(\phi\)</span> (a.k.a. <span class="math inline">\(\alpha\)</span>). For a more detailed walk out of this, see Section 8.2 in <span class="citation" data-cites="hilbeNegativeBinomialRegression2011">Hilbe (<a href="references.html#ref-hilbeNegativeBinomialRegression2011" role="doc-biblioref">2011</a>)</span>.</p>
<p>Okay, that’s enough technical background. Let’s load the <code>Kline</code> data and bring this down to Earth with some models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Kline, <span class="at">package =</span> <span class="st">"rethinking"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> Kline <span class="sc">|&gt;</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p          =</span> rethinking<span class="sc">::</span><span class="fu">standardize</span>(<span class="fu">log</span>(population)),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">contact_id =</span> <span class="fu">ifelse</span>(contact <span class="sc">==</span> <span class="st">"high"</span>, <span class="dv">2</span>L, <span class="dv">1</span>L),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">cid        =</span> contact)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(Kline)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      culture population contact total_tools mean_TU            p contact_id  cid
1    Malekula       1100     low          13     3.2 -1.291473310          1  low
2     Tikopia       1500     low          22     4.7 -1.088550750          1  low
3  Santa Cruz       3600     low          24     4.0 -0.515764892          1  low
4         Yap       4791    high          43     5.0 -0.328773359          2 high
5    Lau Fiji       7400    high          33     5.0 -0.044338980          2 high
6   Trobriand       8000    high          19     4.0  0.006668287          2 high
7       Chuuk       9200    high          40     3.8  0.098109204          2 high
8       Manus      13000     low          28     6.6  0.324317564          1  low
9       Tonga      17500    high          55     5.4  0.518797917          2 high
10     Hawaii     275000     low          71     6.6  2.321008320          1  low</code></pre>
</div>
</div>
<p>If you take a look of McElreath’s <code>m12.2</code>, you’ll see it’s a gamma-Poisson version of the non-linear model he fit in last chapter, <code>m11.11</code>. You might also recall that we had to employ somewhat complicated non-linear syntax to translate that model into <strong>brms</strong>. Instead of jumping straight into a similarly complicated gamma-Poisson version of that model, I’m going to warm us up with a simple intercept-only model of the data. The formula will be</p>
<p><span class="math display">\[\begin{align*}
\text{total\_tools}_i &amp; \sim \operatorname{Gamma-Poisson} (\mu, \alpha) \\
\text{log}(\mu) &amp; = \beta_0 \\
\beta_0         &amp; \sim \operatorname{Normal}(3, 0.5) \\
\alpha          &amp; \sim \operatorname{InvGamma}(0.4, 0.3),
\end{align*}\]</span></p>
<p>where we have deviated from McElreath’s convention of using <span class="math inline">\(\alpha\)</span> for the model in favor <span class="math inline">\(\beta_0\)</span>. This is because <strong>brms</strong> parameterizes the gamma likelihood in terms of <span class="math inline">\(\mu\)</span> and shape and, as we discussed above, shape is typically denoted as <span class="math inline">\(\alpha\)</span>. I mean, technically we could refer to the shape parameter as <span class="math inline">\(\psi\)</span> or <span class="math inline">\(\xi\)</span> or whatever, but then we’d just be abandoning one convention for another. There’s no way to win, here. <em>Sigh</em>. The prior for <span class="math inline">\(\beta_0\)</span> is the same one we used for the intercept way back for model <code>b11.9</code>. We have assigned a gamma prior for our troublesome new <span class="math inline">\(\alpha\)</span> (shape) parameter. Here’s where that prior came from.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(<span class="at">data =</span> d, </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">family =</span> negbinomial,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>          total_tools <span class="sc">~</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  prior     class coef group resp dpar nlpar lb ub tag  source
 student_t(3, 3.4, 2.5) Intercept                                      default
    inv_gamma(0.4, 0.3)     shape                             0        default</code></pre>
</div>
</div>
<p><code>inv_gamma(0.4, 0.3)</code> is the <strong>brms</strong> default for the <code>shape</code> parameter in this model.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Sadly, the base-<strong>R</strong> <strong>stats</strong> package does not have convince functions for the inverse gamma distribution, but we do have access to a <code>dinvgamma()</code> function from the <strong>invgamma</strong> package.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;Back in the day, <strong>brms</strong> used to default to <span class="math inline">\(\operatorname{InvGamma}(0.01, 0.01)\)</span> in this context. Times have changed. For the details, see <a href="https://github.com/paul-buerkner/brms/issues/1614">this issue</a>.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(invgamma)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">14</span>, <span class="at">length.out =</span> <span class="dv">1001</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density =</span> <span class="fu">dinvgamma</span>(x, <span class="at">shape =</span> <span class="fl">0.4</span>, <span class="at">rate =</span> <span class="fl">0.3</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">color =</span> <span class="st">"transparent"</span>, </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">13</span>)) <span class="sc">+</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">expression</span>(brms<span class="sc">~</span>default<span class="sc">~</span>gamma<span class="sc">^</span>{<span class="sc">-</span><span class="dv">1</span>}<span class="sc">*</span>(<span class="fl">0.4</span><span class="sc">*</span><span class="st">", "</span><span class="sc">*</span><span class="fl">0.3</span>)<span class="sc">~</span>shape<span class="sc">~</span>prior))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>Let’s fit the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.2</span>a <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> negbinomial,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  total_tools <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">3</span>, <span class="fl">0.5</span>), <span class="at">class =</span> Intercept),    <span class="co"># beta_0</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">inv_gamma</span>(<span class="fl">0.4</span>, <span class="fl">0.3</span>), <span class="at">class =</span> shape)),  <span class="co"># alpha</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">12</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b12.02a"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how you use the language of <code>family = negbinomial</code> to fit these models with <strong>brms</strong>. Here’s the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b12<span class="fl">.2</span>a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: negbinomial 
  Links: mu = log 
Formula: total_tools ~ 1 
   Data: d (Number of observations: 10) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     3.50      0.16     3.18     3.82 1.00     2165     1918

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
shape     4.57      2.49     1.33    10.83 1.00     2253     1838

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>The intercept is our estimate of <span class="math inline">\(\log \mu\)</span>, similar to <span class="math inline">\(\log \lambda\)</span> from a simple Poisson model. The <code>shape</code> is our estimate of, well, the shape (<span class="math inline">\(\alpha\)</span>). To help us get a sense of what this model is, let’s use the <code>brms::predict()</code> function to return random samples of the poster predictive distribution. Because we want random samples instead of summary values, we will specify <code>summary = F</code>. Let’s take a look of what this returns.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">predict</span>(b12<span class="fl">.2</span>a, <span class="at">summary =</span> F)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>p <span class="sc">|&gt;</span> </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>(<span class="at">give.attr =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:4000, 1:10] 44 23 27 46 56 37 33 10 33 35 ...</code></pre>
</div>
</div>
<p>Because we have 4,000 posterior iterations, we also get back 4,000 rows. We have 10 columns, which correspond to the 10 rows (i.e., cultures) in the original data. In the next block, we’ll put convert that output to a data frame and wrangle a little before plotting the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>p <span class="sc">|&gt;</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(d<span class="sc">$</span>culture) <span class="sc">|&gt;</span> </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"culture"</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"lambda"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lambda)) <span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">color =</span> <span class="st">"transparent"</span>, <span class="at">fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="fu">expression</span>(lambda[<span class="st">"[culture]"</span>]), <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span> <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">210</span>)) <span class="sc">+</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> culture, <span class="at">nrow =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Because this model had no predictors, we have similar posterior-predictive distributions for each case in the data. It’s important, however, to be very clear of what these posterior-predictive distributions are of. They are not of the data, per se. Let’s look back at the text:</p>
<blockquote class="blockquote">
<p>A <strong>negative-binomial</strong> model, more usefully called a <strong>gamma-Poisson</strong> model, assumes that each Poisson count observation has its own rate. It estimates the shape of the gamma distribution to describe the Poisson rates across cases. (p.&nbsp;373, <strong>emphasis</strong> in the original)</p>
</blockquote>
<p>As a reminder, the “rate” for the Poisson distribution is just another word for the mean, also called <span class="math inline">\(\lambda\)</span>. So unlike a simple Poisson model where we use the individual cases to estimate one overall <span class="math inline">\(\lambda\)</span>, here we’re presuming each case has its own <span class="math inline">\(\lambda_i\)</span>. There are 10 <span class="math inline">\(\lambda_i\)</span> values that generated our data and if we look at those <span class="math inline">\(\lambda_i\)</span> values on the whole, their distribution can be described with a gamma distribution. And again, this is not a gamma distribution for our data. This is a gamma distribution of the <span class="math inline">\(\lambda_i\)</span> values from the 10 separate Poisson distributions that presumably made our data.</p>
<p>After exponentiating the intercept parameter <span class="math inline">\((\log \mu)\)</span>, here are the posterior distributions for those two gamma parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b12<span class="fl">.2</span>a)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mu    =</span> <span class="fu">exp</span>(b_Intercept),</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">alpha =</span> shape) <span class="sc">|&gt;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(mu<span class="sc">:</span>alpha, <span class="at">names_to =</span> <span class="st">"parameter"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">color =</span> <span class="st">"transparent"</span>, <span class="at">fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"posterior"</span>,</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Behold our gamma parameters!"</span>) <span class="sc">+</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> parameter, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">labeller =</span> label_parsed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="528"></p>
</figure>
</div>
</div>
</div>
<p>We might want to use these parameters estimates to visualize the model-implied gamma distribution of <span class="math inline">\(\lambda\)</span> parameters. But recall that the base <strong>R</strong> <code>dgamma()</code> function doesn’t take the mean. It is based on either the <code>shape</code> and <code>rate</code> or the <code>shape and</code>scale`. Since we already have the shape (<span class="math inline">\(\alpha\)</span>), we need a way to compute the scale or rate. Happily, we can define the scale in terms of the mean and the shape with the equation</p>
<p><span class="math display">\[\theta = \frac{\mu}{\alpha}.\]</span></p>
<p>Behold <span class="math inline">\(\theta\)</span> in a plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mu    =</span> <span class="fu">exp</span>(b_Intercept),</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">alpha =</span> shape) <span class="sc">|&gt;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">theta =</span> mu <span class="sc">/</span> alpha) <span class="sc">|&gt;</span> </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> theta)) <span class="sc">+</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">color =</span> <span class="st">"transparent"</span>, <span class="at">fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"posterior"</span>,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">expression</span>(We<span class="sc">~</span>define<span class="sc">~</span>the<span class="sc">~</span>scale<span class="sc">~</span>as<span class="sc">~</span>theta<span class="sc">==</span>mu<span class="sc">/</span>alpha)) <span class="sc">+</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">40</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>Now we know how to get both <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\theta\)</span> from the model, we can pump them into <code>dgamma()</code> to get a sense of the model-implied gamma distribution, the presumed underlying distribution of <span class="math inline">\(\lambda\)</span> values that generated the <code>total_tools</code> data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrangle to get 200 draws</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span> </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">alpha =</span> shape,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">theta =</span> <span class="fu">exp</span>(b_Intercept) <span class="sc">/</span> shape) <span class="sc">|&gt;</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">200</span>) <span class="sc">|&gt;</span> </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">x =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">250</span>)<span class="sc">|&gt;</span> </span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density =</span> <span class="fu">dgamma</span>(x, <span class="at">shape =</span> alpha, <span class="at">scale =</span> theta)) <span class="sc">|&gt;</span> </span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> .draw),</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>]) <span class="sc">+</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(lambda),</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"200 credible gamma densities for "</span><span class="sc">*</span>lambda)) <span class="sc">+</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">170</span>),</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.045</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>Now we’ve warmed up with an intercept-only gamma-Poisson, it’s time to fit a <strong>brms</strong> version of McElreath’s <code>m12.2</code>. Our model formula will be</p>
<p><span class="math display">\[\begin{align*}
\text{total\_tools}_i &amp; \sim \operatorname{Gamma-Poisson} (\mu_i, \alpha) \\
\mu_i       &amp; = \exp (\beta_{0,\text{cid}[i]}) \text{population}_i^{\beta_{1,\text{cid}[i]}} / \gamma \\
\beta_{0,j} &amp; \sim \operatorname{Normal}(1, 1) \\
\beta_{1,j} &amp; \sim \operatorname{Exponential}(1) \\
\gamma      &amp; \sim \operatorname{Exponential}(1) \\
\alpha      &amp; \sim \operatorname{Exponential}(1),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\alpha\)</span> and the mean and shape of the gamma distribution for the case-specific <span class="math inline">\(\lambda\)</span> parameters. Here’s how we might fit that model with <strong>brms</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.2</span>b <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">negbinomial</span>(<span class="at">link =</span> <span class="st">"identity"</span>),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(total_tools <span class="sc">~</span> <span class="fu">exp</span>(b0) <span class="sc">*</span> population<span class="sc">^</span>b1 <span class="sc">/</span> g,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>     b0 <span class="sc">+</span> b1 <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> cid,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>     g <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">nl =</span> <span class="cn">TRUE</span>),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">nlpar =</span> b0),</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">nlpar =</span> b1, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">nlpar =</span> g, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> shape)),</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">12</span>,</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.85</span>),</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b12.02b"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b12<span class="fl">.2</span>b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: negbinomial 
  Links: mu = identity 
Formula: total_tools ~ exp(b0) * population^b1/g 
         b0 ~ 0 + cid
         b1 ~ 0 + cid
         g ~ 1
   Data: d (Number of observations: 10) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
b0_cidhigh      1.04      0.93    -0.80     2.85 1.00     2021     2213
b0_cidlow       0.91      0.86    -0.78     2.54 1.00     2270     1994
b1_cidhigh      0.26      0.13     0.03     0.53 1.00     1289      929
b1_cidlow       0.25      0.10     0.07     0.45 1.00     1901     1439
g_Intercept     1.08      0.88     0.14     3.42 1.00     1571     1631

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
shape     3.69      1.64     1.24     7.60 1.00     2314     1739

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Compute and check the PSIS-LOO estimates along with their diagnostic Pareto <span class="math inline">\(k\)</span> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.2</span>b <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(b12<span class="fl">.2</span>b, <span class="at">criterion =</span> <span class="st">"loo"</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(b12<span class="fl">.2</span>b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 10 log-likelihood matrix.

         Estimate  SE
elpd_loo    -41.3 1.6
p_loo         1.2 0.2
looic        82.7 3.3
------
MCSE of elpd_loo is 0.0.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.5, 1.1]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>With the current version of <strong>brms</strong> and <strong>loo</strong>, all of the Pareto <span class="math inline">\(k\)</span> values are reasonably low. This wasn’t always the case, with earlier versions of the software showing a somewhat higher <span class="math inline">\(k\)</span> value for Hawaii.</p>
<p>Before we can make our version of Figure 12.2, we’ll need to reload <code>b11.11</code> from last chapter. One way is with the <code>readRDS()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>b11<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"fits/b11.11.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we make the left panel of the figure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The new data</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">distinct</span>(d, cid) <span class="sc">|&gt;</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">population =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">300000</span>, <span class="at">length.out =</span> <span class="dv">100</span>))</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the expected trajectories</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b11<span class="fl">.11</span>,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">newdata =</span> nd,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>)) <span class="sc">|&gt;</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(nd) <span class="sc">|&gt;</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> population, <span class="at">group =</span> cid, <span class="at">color =</span> cid)) <span class="sc">+</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">y =</span> Estimate, <span class="at">ymin =</span> Q5<span class="fl">.5</span>, <span class="at">ymax =</span> Q94<span class="fl">.5</span>, <span class="at">fill =</span> cid),</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">stat =</span> <span class="st">"identity"</span>,</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">bind_cols</span>(d, b11<span class="fl">.11</span><span class="sc">$</span>criteria<span class="sc">$</span>loo<span class="sc">$</span>diagnostics),</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> total_tools, <span class="at">size =</span> pareto_k),</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="dv">4</span><span class="sc">/</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"total tools"</span>,</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"pure Poisson model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now make the right panel.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For the annotation</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">distinct</span>(d, cid) <span class="sc">|&gt;</span> </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">population  =</span> <span class="fu">c</span>(<span class="dv">150000</span>, <span class="dv">110000</span>),</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">total_tools =</span> <span class="fu">c</span>(<span class="dv">57</span>, <span class="dv">69</span>),</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">label       =</span> <span class="fu">str_c</span>(cid, <span class="st">" contact"</span>))</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b12<span class="fl">.2</span>b,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">newdata =</span> nd,</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(nd) <span class="sc">|&gt;</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> population, <span class="at">group =</span> cid, <span class="at">color =</span> cid)) <span class="sc">+</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">y =</span> Estimate, <span class="at">ymin =</span> Q5<span class="fl">.5</span>, <span class="at">ymax =</span> Q94<span class="fl">.5</span>, <span class="at">fill =</span> cid),</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">stat =</span> <span class="st">"identity"</span>,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">bind_cols</span>(d, b12<span class="fl">.2</span>b<span class="sc">$</span>criteria<span class="sc">$</span>loo<span class="sc">$</span>diagnostics),</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> total_tools, <span class="at">size =</span> pareto_k),</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="dv">4</span><span class="sc">/</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> text,</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> total_tools, <span class="at">label =</span> label)) <span class="sc">+</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">labels =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"gamma-Poisson model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Combine the two ggplots with <strong>patchwork</strong> syntax to make the full version of Figure 12.2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">|</span> p2) <span class="sc">&amp;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"population"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50000</span>, <span class="dv">150000</span>, <span class="dv">250000</span>)) <span class="sc">&amp;</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">1</span>)]) <span class="sc">&amp;</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">1</span>)]) <span class="sc">&amp;</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>)) <span class="sc">&amp;</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d<span class="sc">$</span>population),</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d<span class="sc">$</span>total_tools)) <span class="sc">&amp;</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="696"></p>
</figure>
</div>
</div>
</div>
<p>Oh man!</p>
<blockquote class="blockquote">
<p>Recall that Hawaii was a highly influential point in the pure Poisson model. It does all the work of pulling the low-contact trend down. In this new model, Hawaii is still influential, but it exerts a lot less influence on the trends. Now the high and low contact trends are much more similar, very hard to reliably distinguish. This is because the gamma-Poisson model expects rate variation, and the estimated amount of variation is quite large. Population is still strongly related to the total tools, but the influence of contact rate has greatly diminished. (p.&nbsp;374)</p>
</blockquote>
<p>Before we move on, let’s use <code>predict()</code> to generate posterior predictive distributions for each of our 10 cultures.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(b12<span class="fl">.2</span>b, <span class="at">summary =</span> F) <span class="sc">|&gt;</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(d<span class="sc">$</span>culture) <span class="sc">|&gt;</span> </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(),</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"culture"</span>,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"lambda"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d, <span class="at">by =</span> <span class="st">"culture"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lambda)) <span class="sc">+</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fl">0.5</span>,</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>],</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> total_tools),</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">3</span>]) <span class="sc">+</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="fu">expression</span>(lambda[<span class="st">"[culture]"</span>]), <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span> <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">210</span>)) <span class="sc">+</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> culture, <span class="at">nrow =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Because we used predictors in the model, this time the posterior predictive distributions differ across the cultures. The mean and interquartile range of each distribution are marked off by the light-green dot and horizontal line below each. The vertical lines in the foreground mark off the corresponding <code>total_tools</code> values from the data. Recall that these distributions are not based on the <code>total_tools</code> values themselves, but rather are estimates of the <span class="math inline">\(\lambda\)</span> values from the underlying Poisson distributions that might have generated such <code>total_tools</code> values.</p>
</section>
<section id="over-dispersion-entropy-and-information-criteria" class="level3" data-number="12.1.3">
<h3 data-number="12.1.3" class="anchored" data-anchor-id="over-dispersion-entropy-and-information-criteria"><span class="header-section-number">12.1.3</span> Over-dispersion, entropy, and information criteria</h3>
<blockquote class="blockquote">
<p>In terms of model comparison using information criteria, a beta-binomial model is a binomial model, and a gamma-Poisson (negative-binomial) is a Poisson model.</p>
<p>You should not use WAIC and PSIS with these models, however, unless you are very sure of what you are doing. The reason is that while ordinary binomial and Poisson models can be aggregated and disaggregated across rows in the data, without changing any causal assumptions, the same is not true of beta-binomial and gamma-Poisson models. The reason is that a beta-binomial or gamma-Poisson likelihood applies an unobserved parameter to each row in the data. When we then go to calculate log-likelihoods, how the data are structured will determine how the beta-distributed or gamma-distributed variation enters the model. (pp.&nbsp;374–375)</p>
</blockquote>
</section>
</section>
<section id="zero-inflated-outcomes" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="zero-inflated-outcomes"><span class="header-section-number">12.2</span> Zero-inflated outcomes</h2>
<blockquote class="blockquote">
<p>Very often, the things we can measure are not emissions from any pure process. Instead, they are <em>mixtures</em> of multiple processes. Whenever there are different causes for the same observation, then a <strong>mixture model</strong> may be useful. A mixture model uses more than one simple probability distribution to model a mixture of causes. In effect, these models use more than one likelihood for the same outcome variable.</p>
<p>Count variables are especially prone to needing a mixture treatment. The reason is that a count of zero can often arise more than one way. A “zero” means that nothing happened, and nothing can happen either because the rate of events is low or rather because the process that generates events failed to get started. (p.&nbsp;376, <strong>emphasis</strong> in the original)</p>
</blockquote>
<section id="rethinking-breaking-the-law" class="level4" data-number="12.2.0.1">
<h4 data-number="12.2.0.1" class="anchored" data-anchor-id="rethinking-breaking-the-law"><span class="header-section-number">12.2.0.1</span> Rethinking: Breaking the law</h4>
<p>McElreath discussed how advances in computing have made it possible for working scientists to define their own data generating models. If you’d like to dive deeper into the topic, check out Bürkner’s <span class="citation" data-cites="Bürkner2022Define">(<a href="references.html#ref-Bürkner2022Define" role="doc-biblioref">2022b</a>)</span> vignette, <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_customfamilies.html"><em>Define custom response distributions with brms</em></a>.</p>
</section>
<section id="example-zero-inflated-poisson" class="level3" data-number="12.2.1">
<h3 data-number="12.2.1" class="anchored" data-anchor-id="example-zero-inflated-poisson"><span class="header-section-number">12.2.1</span> Example: Zero-inflated Poisson</h3>
<p>Do you remember the monk data from back in <a href="11.html#sec-Exposure-and-the-offset" class="quarto-xref"><span>Section 11.2.3</span></a>? Here we simulate some more. This time we’ll work in a little alcohol.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define parameters</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>prob_drink <span class="ot">&lt;-</span> <span class="fl">0.2</span>  <span class="co"># 20% of days</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>rate_work  <span class="ot">&lt;-</span> <span class="dv">1</span>    <span class="co"># Average 1 manuscript per day</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample one year of production</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">365</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate days monks drink</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">365</span>)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>drink <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> prob_drink)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate manuscripts completed</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> drink) <span class="sc">*</span> <span class="fu">rpois</span>(n, <span class="at">lambda =</span> rate_work)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll put those data in a tidy tibble before plotting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">drink =</span> <span class="fu">factor</span>(drink, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>), </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">y     =</span> y)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> y)) <span class="sc">+</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">fill =</span> drink),</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"grey92"</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Manuscripts completed"</span>) <span class="sc">+</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>With these data, the likelihood of observing zero on <code>y</code>, (i.e., the likelihood zero manuscripts were completed on a given occasion) is</p>
<p><span class="math display">\[\begin{align*}
\Pr(0 \mid p, \lambda) &amp; = \Pr(\text{drink} \mid p) + \Pr(\text{work} \mid p) \times \Pr(0 \mid \lambda) \\
                                   &amp; = p + (1 - p) \exp (- \lambda).
\end{align*}\]</span></p>
<p>And</p>
<blockquote class="blockquote">
<p>since the Poisson likelihood of <span class="math inline">\(y\)</span> is <span class="math inline">\(\Pr(y \mid \lambda) = \lambda^y \exp (- \lambda) / y!\)</span>, the likelihood of <span class="math inline">\(y = 0\)</span> is just <span class="math inline">\(\exp (- \lambda)\)</span>. The above is just the mathematics for:</p>
<blockquote class="blockquote">
<p><em>The probability of observing a zero is the probability that the monks didn’t drink OR (<span class="math inline">\(+\)</span>) the probability that the monks worked AND (<span class="math inline">\(\times\)</span>) failed to finish anything</em>.</p>
</blockquote>
<p>And the likelihood of a non-zero value <span class="math inline">\(y\)</span> is:</p>
<p><span class="math display">\[\Pr(y \mid y &gt; 0, p, \lambda) = \Pr(\text{drink} \mid p) (0) + \Pr(\text{work} \mid p) \Pr(y \mid \lambda) = (1 - p) \frac{\lambda^y \exp (- \lambda)}{y!}\]</span></p>
<p>Since drinking monks never produce <span class="math inline">\(y &gt; 0\)</span>, the expression above is just the chance the monks both work <span class="math inline">\(1 - p\)</span>, and finish <span class="math inline">\(y\)</span> manuscripts. (pp.&nbsp;377–378, <em>emphasis</em> in the original)</p>
</blockquote>
<p>So letting <span class="math inline">\(p\)</span> be the probability <span class="math inline">\(y\)</span> is zero and <span class="math inline">\(\lambda\)</span> be the shape of the distribution, the zero-inflated Poisson (<span class="math inline">\(\operatorname{ZIPoisson}\)</span>) regression model might take the basic form</p>
<p><span class="math display">\[\begin{align*}
y_i &amp; \sim \operatorname{ZIPoisson}(\color{#5a5f37}{p_i}, \color{#524a3a}{\lambda_i})\\
\color{#5a5f37}{\operatorname{logit}(p_i)} &amp; \color{#5a5f37}= \color{#5a5f37}{\alpha_p + \beta_p x_i} \\
\color{#524a3a}{\log (\lambda_i)} &amp; \color{#524a3a}= \color{#524a3a}{\alpha_\lambda + \beta_\lambda x_i},
\end{align*}\]</span></p>
<p>where both parameters in the likelihood, <span class="math inline">\(p_i\)</span> and <span class="math inline">\(\lambda_i\)</span> might get their own statistical model, making this a special case of what Bürkner <span class="citation" data-cites="Bürkner2022Distributional">(<a href="references.html#ref-Bürkner2022Distributional" role="doc-biblioref">2022a</a>)</span> calls distributional models. One last thing to note is that in <strong>brms</strong>, <span class="math inline">\(p_i\)</span> is denoted <code>zi</code>. To fit a zero-inflated Poisson model with <strong>brms</strong>, make sure to specify the correct likelihood with <code>family = zero_inflated_poisson</code>. To use a non-default prior for <code>zi</code>, make sure to indicate <code>class = zi</code> within the <code>prior()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> zero_inflated_poisson,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">1</span>, <span class="fl">0.5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">beta</span>(<span class="dv">2</span>, <span class="dv">6</span>), <span class="at">class =</span> zi)),  <span class="co"># the brms default is `beta(1, 1)`</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">12</span>,</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b12.03"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b12<span class="fl">.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: zero_inflated_poisson 
  Links: mu = log 
Formula: y ~ 1 
   Data: d (Number of observations: 365) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     0.02      0.09    -0.16     0.19 1.00     1316     1466

Further Distributional Parameters:
   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
zi     0.23      0.06     0.12     0.34 1.00     1344     1112

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>If you look at the <a href="https://cran.r-project.org/package=brms/vignettes/brms_families.html#zero-inflated-and-hurdle-models"><em>Zero-inflated and hurdle models</em> section</a> of Bürkner’s <span class="citation" data-cites="Bürkner2022Parameterization">(<a href="references.html#ref-Bürkner2022Parameterization" role="doc-biblioref">2022d</a>)</span> <a href="https://cran.r-project.org/package=brms/vignettes/brms_families.html"><em>Parameterization of response distributions in brms</em></a> document, you’ll see the zero-inflated Poisson is set up a little differently in <strong>brms</strong> than it is in <strong>rethinking</strong>. The difference did not influence the estimate for the intercept, <span class="math inline">\(\lambda\)</span>. In both here and in the text, <span class="math inline">\(\lambda\)</span> was about zero. However, it did influence the summary of <code>zi</code>. Note how McElreath’s <code>mean( inv_logit( post$ap ) )</code> returned 0.2241255, which seems rather close to our <code>zi</code> estimate of 0.233. Hopefully it’s clear that <code>zi</code> in <strong>brms</strong> is already in the probability metric. There’s no need to convert it. You can further confirm this by looking at the second line from the <code>print()</code> output, <code>Links: mu = log; zi = identity</code>. When there are no predictors for <code>zi</code>, the <strong>brms</strong> default is to use the identity link. In the text, however, McElreath used the logit link for <code>p</code>.</p>
<p>In the <code>prior</code> argument, we used <code>beta(2, 6)</code> for <code>zi</code> and also mentioned in the margin that the <strong>brms</strong> default is <code>beta(1, 1)</code>. The beta distribution ranges from 0 to 1, making it a natural distribution to use for priors on probabilities when using the identity link. To give you a sense of what those two versions of the beta look like, let’s plot.</p>
<p>A typical way to plot a beta distribution would be to use the base <strong>R</strong> <code>dbeta()</code> function. Let’s try a different approach, instead. The <strong>tidybayes</strong> package includes a <code>parse_dist()</code> function which takes the kind of string specifications you would usually include in the <code>brms::prior()</code> function and converts them into a format one can plot with. For example, here’s what the preparatory work would be in our case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>priors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">beta</span>(<span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">beta</span>(<span class="dv">2</span>, <span class="dv">6</span>)))</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>priors <span class="sc">|&gt;</span> </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_dist</span>(prior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       prior class coef group resp dpar nlpar   lb   ub tag source .dist .args  .dist_obj
1 beta(1, 1)     b                            &lt;NA&gt; &lt;NA&gt;       user  beta  1, 1 beta(1, 1)
2 beta(2, 6)     b                            &lt;NA&gt; &lt;NA&gt;       user  beta  2, 6 beta(2, 6)</code></pre>
</div>
</div>
<p>The first several columns look a lot like the kind of output we’d get from the <code>brms::get_prior()</code> function. The <code>parse_dist()</code> function added those last two columns. Here we put them to work by feeding them into a ggplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>priors <span class="sc">|&gt;</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_dist</span>(prior) <span class="sc">|&gt;</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> prior, <span class="at">dist =</span> .dist, <span class="at">args =</span> .args, <span class="at">fill =</span> prior)) <span class="sc">+</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_dist_halfeye</span>(<span class="at">.width =</span> <span class="fl">0.95</span>) <span class="sc">+</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"zi"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">add =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">1</span>)]) <span class="sc">+</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>Whereas the <strong>brms</strong> default is flat, our prior guided the posterior a bit toward 0. In case you were curious, we might write our statistical model for <code>b12.3</code> as</p>
<p><span class="math display">\[\begin{align*}
y_i            &amp; \sim \operatorname{ZIPoisson} (p, \lambda) \\
p              &amp; = \alpha_p \\
\log \lambda   &amp; = \alpha_\lambda \\
\alpha_p       &amp; \sim \operatorname{Beta}(2, 6) \\
\alpha_\lambda &amp; \sim \operatorname{Normal}(1, 0.5).
\end{align*}\]</span></p>
<p>Anyway, here’s that exponentiated <span class="math inline">\(\alpha_\lambda\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(b12<span class="fl">.3</span>)[<span class="dv">1</span>, <span class="sc">-</span><span class="dv">2</span>] <span class="sc">|&gt;</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Estimate     Q2.5    Q97.5 
1.022214 0.852194 1.211660 </code></pre>
</div>
</div>
<section id="overthinking-zero-inflated-poisson-calculations-in-stan" class="level4" data-number="12.2.1.1">
<h4 data-number="12.2.1.1" class="anchored" data-anchor-id="overthinking-zero-inflated-poisson-calculations-in-stan"><span class="header-section-number">12.2.1.1</span> Overthinking: Zero-inflated Poisson calculations in Stan</h4>
<p>If you’re curious, here’s the Stan code underlying our <strong>brms</strong> fit, <code>b12.3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.3</span><span class="sc">$</span>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>// generated with brms 2.23.0
functions {
  /* zero-inflated poisson log-PDF of a single response
   * Args:
   *   y: the response value
   *   lambda: mean parameter of the poisson distribution
   *   zi: zero-inflation probability
   * Returns:
   *   a scalar to be added to the log posterior
   */
  real zero_inflated_poisson_lpmf(int y, real lambda, real zi) {
    if (y == 0) {
      return log_sum_exp(bernoulli_lpmf(1 | zi),
                         bernoulli_lpmf(0 | zi) +
                         poisson_lpmf(0 | lambda));
    } else {
      return bernoulli_lpmf(0 | zi) +
             poisson_lpmf(y | lambda);
    }
  }
  /* zero-inflated poisson log-PDF of a single response
   * logit parameterization of the zero-inflation part
   * Args:
   *   y: the response value
   *   lambda: mean parameter of the poisson distribution
   *   zi: linear predictor for zero-inflation part
   * Returns:
   *   a scalar to be added to the log posterior
   */
  real zero_inflated_poisson_logit_lpmf(int y, real lambda, real zi) {
    if (y == 0) {
      return log_sum_exp(bernoulli_logit_lpmf(1 | zi),
                         bernoulli_logit_lpmf(0 | zi) +
                         poisson_lpmf(0 | lambda));
    } else {
      return bernoulli_logit_lpmf(0 | zi) +
             poisson_lpmf(y | lambda);
    }
  }
  /* zero-inflated poisson log-PDF of a single response
   * log parameterization for the poisson part
   * Args:
   *   y: the response value
   *   eta: linear predictor for poisson distribution
   *   zi: zero-inflation probability
   * Returns:
   *   a scalar to be added to the log posterior
   */
  real zero_inflated_poisson_log_lpmf(int y, real eta, real zi) {
    if (y == 0) {
      return log_sum_exp(bernoulli_lpmf(1 | zi),
                         bernoulli_lpmf(0 | zi) +
                         poisson_log_lpmf(0 | eta));
    } else {
      return bernoulli_lpmf(0 | zi) +
             poisson_log_lpmf(y | eta);
    }
  }
  /* zero-inflated poisson log-PDF of a single response
   * log parameterization for the poisson part
   * logit parameterization of the zero-inflation part
   * Args:
   *   y: the response value
   *   eta: linear predictor for poisson distribution
   *   zi: linear predictor for zero-inflation part
   * Returns:
   *   a scalar to be added to the log posterior
   */
  real zero_inflated_poisson_log_logit_lpmf(int y, real eta, real zi) {
    if (y == 0) {
      return log_sum_exp(bernoulli_logit_lpmf(1 | zi),
                         bernoulli_logit_lpmf(0 | zi) +
                         poisson_log_lpmf(0 | eta));
    } else {
      return bernoulli_logit_lpmf(0 | zi) +
             poisson_log_lpmf(y | eta);
    }
  }
  // zero-inflated poisson log-CCDF and log-CDF functions
  real zero_inflated_poisson_lccdf(int y, real lambda, real zi) {
    return bernoulli_lpmf(0 | zi) + poisson_lccdf(y | lambda);
  }
  real zero_inflated_poisson_lcdf(int y, real lambda, real zi) {
    return log1m_exp(zero_inflated_poisson_lccdf(y | lambda, zi));
  }
}
data {
  int&lt;lower=1&gt; N;  // total number of observations
  array[N] int Y;  // response variable
  int prior_only;  // should the likelihood be ignored?
}
transformed data {
}
parameters {
  real Intercept;  // temporary intercept for centered predictors
  real&lt;lower=0,upper=1&gt; zi;  // zero-inflation probability
}
transformed parameters {
  // prior contributions to the log posterior
  real lprior = 0;
  lprior += normal_lpdf(Intercept | 1, 0.5);
  lprior += beta_lpdf(zi | 2, 6);
}
model {
  // likelihood including constants
  if (!prior_only) {
    // initialize linear predictor term
    vector[N] mu = rep_vector(0.0, N);
    mu += Intercept;
    for (n in 1:N) {
      target += zero_inflated_poisson_log_lpmf(Y[n] | mu[n], zi);
    }
  }
  // priors including constants
  target += lprior;
}
generated quantities {
  // actual population-level intercept
  real b_Intercept = Intercept;
}</code></pre>
</div>
</div>
<p>For more on how to fit this model with <strong>rstan</strong>, go to my companion book <a href="https://solomon.quarto.pub/sr2rstan/12.html#zero-inflated-outcomes">here</a>.</p>
</section>
</section>
</section>
<section id="sec-Ordered-categorical-outcomes" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="sec-Ordered-categorical-outcomes"><span class="header-section-number">12.3</span> Ordered categorical outcomes</h2>
<blockquote class="blockquote">
<p>It is very common in the social sciences, and occasional in the natural sciences, to have an outcome variable that is discrete, like a count, but in which the values merely indicate different ordered levels along some dimension. For example, if I were to ask you how much you like to eat fish,on a scale from 1 to 7, you might say 5. If I were to ask 100 people the same question, I’d end up with 100 values between 1 and 7. In modeling each outcome value, I’d have to keep in mind that these values are <em>ordered</em>, because 7 is greater than 6, which is greater than 5, and so on. The result is a set of <strong>ordered categories</strong>. Unlike a count, the differences in value are not necessarily equal….</p>
<p>In principle, an ordered categorical variable is just a multinomial prediction problem (page 359). But the constraint that the categories be ordered demands special treatment….</p>
<p>The conventional solution is to use a <strong>cumulative link</strong> function. The cumulative probability of a value is the probability of that value <em>or any smaller value</em>. In the context of ordered categories, the cumulative probability of 3 is the sum of the probabilities of 3, 2, and 1. Ordered categories by convention begin at 1, so a result less than 1 has no probability at all. By linking a linear model to cumulative probability, it is possible to guarantee the ordering of the outcomes. (p.&nbsp;380, <em>emphasis</em> in the original)</p>
</blockquote>
<section id="example-moral-intuition" class="level3" data-number="12.3.1">
<h3 data-number="12.3.1" class="anchored" data-anchor-id="example-moral-intuition"><span class="header-section-number">12.3.1</span> Example: Moral intuition</h3>
<p>Let’s get the <code>Trolley</code> data from <strong>rethinking</strong> <span class="citation" data-cites="cushmanRoleConsciousReasoning2006">(see <a href="references.html#ref-cushmanRoleConsciousReasoning2006" role="doc-biblioref">Cushman et al., 2006</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Trolley, <span class="at">package =</span> <span class="st">"rethinking"</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> Trolley</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(Trolley)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use the <code>dplyr::glimpse()</code> to get a sense of the dimensions of the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 9,930
Columns: 12
$ case      &lt;fct&gt; cfaqu, cfbur, cfrub, cibox, cibur, cispe, fkaqu, fkboa, fkbox, fkbur, fkcar, fkspe, fkswi, flboa, flcar, flche…
$ response  &lt;int&gt; 4, 3, 4, 3, 3, 3, 5, 4, 4, 4, 4, 4, 4, 5, 4, 4, 4, 4, 4, 3, 3, 3, 4, 4, 5, 4, 4, 3, 4, 4, 4, 2, 4, 1, 1, 1, 7,…
$ order     &lt;int&gt; 2, 31, 16, 32, 4, 9, 29, 12, 23, 22, 27, 19, 14, 3, 18, 15, 30, 5, 1, 13, 20, 17, 28, 10, 6, 11, 21, 26, 24, 7…
$ id        &lt;fct&gt; 96;434, 96;434, 96;434, 96;434, 96;434, 96;434, 96;434, 96;434, 96;434, 96;434, 96;434, 96;434, 96;434, 96;434…
$ age       &lt;int&gt; 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14…
$ male      &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1,…
$ edu       &lt;fct&gt; Middle School, Middle School, Middle School, Middle School, Middle School, Middle School, Middle School, Middl…
$ action    &lt;int&gt; 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1,…
$ intention &lt;int&gt; 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0,…
$ contact   &lt;int&gt; 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0,…
$ story     &lt;fct&gt; aqu, bur, rub, box, bur, spe, aqu, boa, box, bur, car, spe, swi, boa, car, che, sha, swi, box, bur, pon, shi, …
$ action2   &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1,…</code></pre>
</div>
</div>
<p>Though we have 9,930 rows, we only have 331 unique individuals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    n
1 331</code></pre>
</div>
</div>
</section>
<section id="describing-an-ordered-distribution-with-intercepts" class="level3" data-number="12.3.2">
<h3 data-number="12.3.2" class="anchored" data-anchor-id="describing-an-ordered-distribution-with-intercepts"><span class="header-section-number">12.3.2</span> Describing an ordered distribution with intercepts</h3>
<p>Make our version of the simple Figure 12.4 histogram of our primary variable, <code>response</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> response, <span class="at">fill =</span> <span class="fu">after_stat</span>(x))) <span class="sc">+</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>],</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">high =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>),</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Our cumulative proportion plot, Figure 12.4.b, will require some pre-plot wrangling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(response) <span class="sc">|&gt;</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pr_k     =</span> n <span class="sc">/</span> <span class="fu">nrow</span>(d),</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">cum_pr_k =</span> <span class="fu">cumsum</span>(pr_k)) <span class="sc">|&gt;</span> </span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> response, <span class="at">y =</span> cum_pr_k, <span class="at">fill =</span> response)) <span class="sc">+</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"grey92"</span>, <span class="at">shape =</span> <span class="dv">21</span>,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"cumulative proportion"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>],</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">high =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>),</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>Then to re-describe the histogram as log-cumulative odds, we’ll need a series of intercept parameters. Each intercept will be on the log-cumulative-odds scale and stand in for the cumulative probability of each outcome. So this is just the application of the link function. The log-cumulative-odds that a response value <span class="math inline">\(y_i\)</span> is equal-to-or-less-than some possible outcome value <span class="math inline">\(k\)</span> is:</p>
<p><span class="math display">\[\log \frac{\Pr(y_i \leq k)}{1 - \Pr(y_i \leq k)} = \alpha_k\]</span></p>
<p>where <span class="math inline">\(\alpha_k\)</span> is an “intercept” unique to each possible outcome value <span class="math inline">\(k\)</span>. (p.&nbsp;383)</p>
</blockquote>
<p>We can compute the <span class="math inline">\(\alpha_k\)</span> estimates directly with a little help from McElreath’s custom <code>logit()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">log</span>(x <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> x))  <span class="co"># Convenience function</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(response) <span class="sc">|&gt;</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pr_k     =</span> n <span class="sc">/</span> <span class="fu">nrow</span>(d),</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">cum_pr_k =</span> <span class="fu">cumsum</span>(n <span class="sc">/</span> <span class="fu">nrow</span>(d))) <span class="sc">|&gt;</span> </span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">alpha =</span> <span class="fu">logit</span>(cum_pr_k) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  response    n       pr_k  cum_pr_k alpha
1        1 1274 0.12829809 0.1282981 -1.92
2        2  909 0.09154079 0.2198389 -1.27
3        3 1071 0.10785498 0.3276939 -0.72
4        4 2323 0.23393756 0.5616314  0.25
5        5 1462 0.14723061 0.7088620  0.89
6        6 1445 0.14551863 0.8543807  1.77
7        7 1446 0.14561934 1.0000000   NaN</code></pre>
</div>
</div>
<p>Now we plot those joints to make our version of Figure 12.4.c.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(response) <span class="sc">|&gt;</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_pr_k =</span> <span class="fu">cumsum</span>(n <span class="sc">/</span> <span class="fu">nrow</span>(d))) <span class="sc">|&gt;</span> </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(response <span class="sc">&lt;</span> <span class="dv">7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We can do the `logit()` conversion right in `ggplot() </span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> response, <span class="at">y =</span> <span class="fu">logit</span>(cum_pr_k), <span class="at">fill =</span> response)) <span class="sc">+</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">"grey92"</span>, <span class="at">shape =</span> <span class="dv">21</span>,</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)) <span class="sc">+</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>],</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">high =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"log-cumulative-odds"</span>) <span class="sc">+</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>),</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Why not combine the three subplots with patchwork?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">|</span> p2 <span class="sc">|</span> p3) <span class="sc">+</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Re-describing a discrete distribution using log-cumulative-odds."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The code for Figure 12.5 is itself something of a monster.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Primary data</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>d_plot <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(response) <span class="sc">|&gt;</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pr_k     =</span> n <span class="sc">/</span> <span class="fu">nrow</span>(d),</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">cum_pr_k =</span> <span class="fu">cumsum</span>(n <span class="sc">/</span> <span class="fu">nrow</span>(d))) <span class="sc">|&gt;</span> </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">discrete_probability =</span> <span class="fu">ifelse</span>(response <span class="sc">==</span> <span class="dv">1</span>, cum_pr_k, cum_pr_k <span class="sc">-</span> pr_k))</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotation</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">text     =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>,</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">response =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span> <span class="sc">+</span> <span class="fl">0.25</span>,</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">cum_pr_k =</span> d_plot<span class="sc">$</span>cum_pr_k <span class="sc">-</span> <span class="fl">0.065</span>) </span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>d_plot <span class="sc">|&gt;</span> </span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> response, <span class="at">y =</span> cum_pr_k,</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> cum_pr_k, <span class="at">fill =</span> cum_pr_k)) <span class="sc">+</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">"grey92"</span>, <span class="at">shape =</span> <span class="dv">21</span>,</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> cum_pr_k),</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">x =</span> response <span class="sc">+</span> <span class="fl">0.025</span>,</span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ymin =</span> <span class="fu">ifelse</span>(response <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, discrete_probability), </span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ymax =</span> cum_pr_k),</span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Number annotation</span></span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> text, </span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label =</span> text),</span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"cumulative proportion"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>],</span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>                      <span class="at">high =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(<span class="at">low =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>],</span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>                       <span class="at">high =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>),</span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>A compact way to express the formula for this first type of statistical model is</p>
<p><span class="math display">\[\begin{align*}
\text{response}_i &amp; \sim \operatorname{Categorical} (\mathbf p) \\
\operatorname{logit}(p_k) &amp; = \alpha_k - \phi \\
\phi              &amp; = 0 \\
\alpha_k          &amp; \sim \operatorname{Normal}(0, 1.5),
\end{align*}\]</span></p>
<p>where the <span class="math inline">\(\alpha_k\)</span> term denotes the <span class="math inline">\(K - 1\)</span> intercepts (cut points or thresholds) we use to describe each possible outcome value <span class="math inline">\(k\)</span> and. The mysterious looking <span class="math inline">\(\phi\)</span> term is a stand-in for the potential terms of the linear model. In the case where we have no predictors, it’s just 0. Just hold on to your hats; this will make more sense in the next section.</p>
<blockquote class="blockquote">
<p>An ordered-logit distribution is really just a categorical distribution that takes a vector <span class="math inline">\(\mathbf p = \{p_1, p_2, p_3, p_4, p_5, p_6\}\)</span> of probabilities of each response value below the maximum response (7 in this example). Each response value <span class="math inline">\(k\)</span> in this vector is defined by its link to an intercept parameter, <span class="math inline">\(\alpha_k\)</span>. Finally, some weakly regularizing priors are placed on these intercepts. (p.&nbsp;385)</p>
</blockquote>
<p>Whereas in <code>rethinking::ulam()</code> you indicate the likelihood by <code>&lt;criterion&gt; ~ dordlogit(0 , c(&lt;the thresholds&gt;)</code>, in <code>brms::brm()</code> you code <code>family = cumulative</code>. Here’s how to fit the intercepts-only model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the start values</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">`</span><span class="at">Intercept[1]</span><span class="st">`</span> <span class="ot">=</span> <span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">Intercept[2]</span><span class="st">`</span> <span class="ot">=</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">Intercept[3]</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">Intercept[4]</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">Intercept[5]</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">2</span>,</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">Intercept[6]</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">2.5</span>)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(init, init, init, init)</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> cumulative,</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>  response <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">init =</span> init_list,  <span class="co"># here we add our start values</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b12.04"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>McElreath needed to include the <code>depth=2</code> argument in the <code>rethinking::precis()</code> function to show the threshold parameters from his <code>m11.1stan</code> model (<strong>R</strong> code 12.24). With a <code>brm()</code> fit, we just use <code>print()</code> or <code>summary()</code> as usual.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b12<span class="fl">.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: cumulative 
  Links: mu = logit 
Formula: response ~ 1 
   Data: d (Number of observations: 9930) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept[1]    -1.92      0.03    -1.98    -1.86 1.00     2947     2579
Intercept[2]    -1.27      0.02    -1.31    -1.22 1.00     3944     3248
Intercept[3]    -0.72      0.02    -0.76    -0.68 1.00     4036     3072
Intercept[4]     0.25      0.02     0.21     0.29 1.00     4642     3212
Intercept[5]     0.89      0.02     0.85     0.93 1.00     4673     3486
Intercept[6]     1.77      0.03     1.71     1.82 1.00     4947     3682

Further Distributional Parameters:
     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
disc     1.00      0.00     1.00     1.00   NA       NA       NA

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>What McElreath’s <code>m12.4</code> summary termed <code>cutpoints[k]</code>, our <strong>brms</strong> summary termed <code>Intercept[k]</code>. In both cases, these are the <span class="math inline">\(\alpha_k\)</span> parameters from the formula, above (i.e., the thresholds). The summaries look like those in the text, the <span class="math inline">\(\widehat R\)</span> values are great, and both measures of effective sample size are high. The results looks good.</p>
<p>We can use the <code>plogis()</code> function to get these into the probability metric.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.4</span> <span class="sc">|&gt;</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fixef</span>() <span class="sc">|&gt;</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plogis</span>() <span class="sc">|&gt;</span> </span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Estimate Est.Error  Q2.5 Q97.5
Intercept[1]    0.128     0.508 0.122 0.135
Intercept[2]    0.220     0.506 0.212 0.228
Intercept[3]    0.328     0.505 0.319 0.337
Intercept[4]    0.562     0.505 0.552 0.571
Intercept[5]    0.709     0.506 0.700 0.718
Intercept[6]    0.854     0.507 0.847 0.861</code></pre>
</div>
</div>
<p>But recall that the posterior <span class="math inline">\(\textit{SD}\)</span> (i.e., the ‘Est.Error’ values) are not valid using that approach. If you really care about them, you’ll need to work with the <code>as_draws_df()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(b12<span class="fl">.4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>)), plogis) <span class="sc">|&gt;</span> </span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span> </span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(value),</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd   =</span> <span class="fu">sd</span>(value),</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll   =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul   =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  name            mean      sd    ll    ul
  &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 b_Intercept[1] 0.128 0.00335 0.122 0.135
2 b_Intercept[2] 0.220 0.00416 0.212 0.228
3 b_Intercept[3] 0.328 0.00467 0.319 0.337
4 b_Intercept[4] 0.562 0.00495 0.552 0.571
5 b_Intercept[5] 0.709 0.00457 0.700 0.718
6 b_Intercept[6] 0.854 0.00347 0.847 0.861</code></pre>
</div>
</div>
<p>Just to confirm, those posterior means are centered right around the <code>cum_pr_k</code> we computed for Figure 12.4.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>d_plot <span class="sc">|&gt;</span> </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(response, cum_pr_k)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  response  cum_pr_k
1        1 0.1282981
2        2 0.2198389
3        3 0.3276939
4        4 0.5616314
5        5 0.7088620
6        6 0.8543807
7        7 1.0000000</code></pre>
</div>
</div>
<p>To walk out our results even further, we can make <code>b12.4</code>-based version of Figure 12.4.c after formatting our posterior summary a little.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(b12<span class="fl">.4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"intercept"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">str_extract</span>(intercept, <span class="st">"</span><span class="sc">\\</span><span class="st">d"</span>) <span class="sc">|&gt;</span> <span class="fu">as.double</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> response, <span class="at">y =</span> Estimate,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>,</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> response)) <span class="sc">+</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">"grey92"</span>, <span class="at">shape =</span> <span class="dv">21</span>,</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)) <span class="sc">+</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>],</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>                      <span class="at">high =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"log-cumulative-odds"</span>) <span class="sc">+</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>),</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Now the dots are the posterior means and the vertical lines layered on top of them are their 95% posterior intervals. Given the large amount of data, the posteriors for our <span class="math inline">\(\alpha_k\)</span> parameters are rather narrow, which is expressed in tightness of those vertical lines.</p>
</section>
<section id="sec-Adding-predictor-variables" class="level3" data-number="12.3.3">
<h3 data-number="12.3.3" class="anchored" data-anchor-id="sec-Adding-predictor-variables"><span class="header-section-number">12.3.3</span> Adding predictor variables</h3>
<p>Now we define the generic linear model as <span class="math inline">\(\phi_i = \beta x_i\)</span>. Accordingly, the formula for our cumulative logit model becomes</p>
<p><span class="math display">\[\begin{align*}
\log \frac{\Pr(y_i \leq k)}{1 - \Pr(y_i \leq k)} &amp; = \alpha_k - \phi_i \\
\phi_i &amp; = \beta x_i.
\end{align*}\]</span></p>
<blockquote class="blockquote">
<p>This form automatically ensures the correct ordering of the outcome values, while still morphing the likelihood of each individual value as the predictor <span class="math inline">\(x_i\)</span> changes value. Why is the linear model <span class="math inline">\(\phi\)</span> subtracted from each intercept? Because if we decrease the log-cumulative-odds of every outcome value <span class="math inline">\(k\)</span> below the maximum, this necessarily shifts probability mass upwards towards higher outcome values. So then positive values of <span class="math inline">\(\beta\)</span> mean increasing <span class="math inline">\(x\)</span> also increases the mean <span class="math inline">\(y\)</span>. You could add <span class="math inline">\(\phi\)</span> instead like <span class="math inline">\(\alpha_k + \phi_i\)</span>. But then <span class="math inline">\(\beta &gt; 0\)</span> would indicate increasing <span class="math inline">\(x\)</span> decreases the mean. (p.&nbsp;386)</p>
</blockquote>
<p>I’m not aware that <strong>brms</strong> has an equivalent to the <code>rethinking::dordlogit()</code> function. So here we’ll make it by hand. The code comes from McElreath’s <a href="https://github.com/rmcelreath/rethinking/blob/a309712d904d1db7af1e08a76c521ab994006fd5/R/distributions.r">GitHub repo for <strong>rethinking</strong></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>x))</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(x <span class="sc">==</span> <span class="cn">Inf</span>, <span class="dv">1</span>, p)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  p</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we get down to it</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>dordlogit <span class="ot">&lt;-</span> <span class="cf">function</span>(x, phi, a, <span class="at">log =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>  a  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">as.numeric</span>(a), <span class="cn">Inf</span>)</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>  p  <span class="ot">&lt;-</span> <span class="fu">logistic</span>(a[x] <span class="sc">-</span> phi)</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>  na <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, a)</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>  np <span class="ot">&lt;-</span> <span class="fu">logistic</span>(na[x] <span class="sc">-</span> phi)</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>  p  <span class="ot">&lt;-</span> p <span class="sc">-</span> np</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (log <span class="sc">==</span> <span class="cn">TRUE</span>) p <span class="ot">&lt;-</span> <span class="fu">log</span>(p)</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>  p</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>dordlogit()</code> function works like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>pk <span class="ot">&lt;-</span> <span class="fu">dordlogit</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="dv">0</span>, <span class="fu">fixef</span>(b12<span class="fl">.4</span>)[, <span class="dv">1</span>])</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>pk <span class="sc">|&gt;</span> </span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.13 0.09 0.11 0.23 0.15 0.15 0.15</code></pre>
</div>
</div>
<p>Note the slight difference in how we used <code>dordlogit()</code> with a <code>brm()</code> fit summarized by <code>fixef()</code> than the way McElreath did with a <code>ulam()</code> fit summarized by <code>coef()</code>. McElreath just put <code>coef(m12.4)</code> into <code>dordlogit()</code>. We, however, more specifically placed <code>fixef(b12.4)[, 1]</code> into the function. With the <code>[, 1]</code> part, we specified that we were working with the posterior means (i.e., <code>Estimate</code>) and neglecting the other summaries (i.e., the posterior <span class="math inline">\(\textit{SD}\)</span>s and 95% intervals). If you forget to subset, chaos ensues.</p>
<p>Next, as McElreath further noted on page 338, “these probabilities imply an average outcome of:”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(pk <span class="sc">*</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.199704</code></pre>
</div>
</div>
<p>I found that a bit abstract. Here’s the thing in a more elaborate tibble format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  explicit_example <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">probability_of_a_response =</span> pk) <span class="sc">|&gt;</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">the_response =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) <span class="sc">|&gt;</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">their_product =</span> probability_of_a_response <span class="sc">*</span> the_response)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  probability_of_a_response the_response their_product
                      &lt;dbl&gt;        &lt;int&gt;         &lt;dbl&gt;
1                    0.128             1         0.128
2                    0.0917            2         0.183
3                    0.108             3         0.324
4                    0.234             4         0.935
5                    0.147             5         0.736
6                    0.146             6         0.873
7                    0.146             7         1.02 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>explicit_example <span class="sc">|&gt;</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_outcome_value =</span> <span class="fu">sum</span>(their_product))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  average_outcome_value
                  &lt;dbl&gt;
1                  4.20</code></pre>
</div>
</div>
<p>Now we’ll try it by subtracting 0.5 from each.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The probabilities of a given response</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>pk <span class="ot">&lt;-</span> <span class="fu">dordlogit</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">phi =</span> <span class="dv">0</span>, <span class="at">a =</span> <span class="fu">fixef</span>(b12<span class="fl">.4</span>)[, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.5</span>)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>pk <span class="sc">|&gt;</span> </span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.08 0.06 0.08 0.21 0.16 0.18 0.22</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The average rating</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(pk <span class="sc">*</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.730111</code></pre>
</div>
</div>
<p>So the rule is we <em>subtract the linear model from each intercept</em>. “This way, a positive <span class="math inline">\(\beta\)</span> value indicates that an increase in the predictor variable <span class="math inline">\(x\)</span> results in an increase in the average response” (p.&nbsp;387). Happily, even though this makes for a somewhat confusing statistical formula, we still enter our predictor terms into the <code>brm()</code> <code>formula</code> argument much the same way we always have. As to our upcoming model, we might express the statistical formula as</p>
<p><span class="math display">\[\begin{align*}
\text{response}_i &amp; \sim \operatorname{Categorical} (\mathbf p) \\
\text{logit}(p_k)     &amp; = \alpha_k - \phi_i \\
\phi_i                &amp; = \beta_1 \text{action}_i + \beta_2 \text{contact}_i +  (\beta_3 + \beta_4 \text{action}_i + \beta_5 \text{contact}_i) \text{intention}_i \\
\alpha_k              &amp; \sim \operatorname{Normal}(0, 1.5) \\
\beta_1, \dots, \beta_5 &amp; \sim \operatorname{Normal}(0, 0.5),
\end{align*}\]</span></p>
<p>where, because we have included predictors, <span class="math inline">\(\phi\)</span> is no longer set to 0. Using our skills from back in <a href="08.html" class="quarto-xref"><span>Chapter 8</span></a>, we might also rewrite the linear model for <span class="math inline">\(\phi\)</span> as</p>
<p><span class="math display">\[\phi_i = \beta_1 \text{action}_i + \beta_2 \text{contact}_i + \beta_3 \text{intention}_i + \beta_4 (\text{action}_i \times \text{intention}_i) + \beta_5 (\text{contact}_i \times \text{intention}_i).\]</span></p>
<p>Let’s fit the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> cumulative,</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  response <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> action <span class="sc">+</span> contact <span class="sc">+</span> intention <span class="sc">+</span> intention<span class="sc">:</span>action <span class="sc">+</span> intention<span class="sc">:</span>contact,</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">class =</span> b)),</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">12</span>,</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b12.05"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are ways with <strong>brms</strong> to mirror how McElreath coded his <code>phi &lt;- bA*A + bC*C + BI*I</code> and <code>BI &lt;- bI + bIA*A + bIC*C</code>. Here we just used a more conventional style of syntax. Behold the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b12<span class="fl">.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: cumulative 
  Links: mu = logit 
Formula: response ~ 1 + action + contact + intention + intention:action + intention:contact 
   Data: d (Number of observations: 9930) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept[1]         -2.64      0.05    -2.74    -2.53 1.00     3284     2917
Intercept[2]         -1.94      0.05    -2.03    -1.84 1.00     3326     3182
Intercept[3]         -1.35      0.05    -1.44    -1.26 1.00     3240     3271
Intercept[4]         -0.31      0.04    -0.40    -0.22 1.00     3162     3096
Intercept[5]          0.36      0.04     0.27     0.45 1.00     3147     3083
Intercept[6]          1.27      0.05     1.17     1.36 1.00     3273     3276
action               -0.48      0.06    -0.59    -0.37 1.00     3222     3273
contact              -0.35      0.07    -0.48    -0.20 1.00     3259     2937
intention            -0.29      0.06    -0.41    -0.18 1.00     3045     2762
action:intention     -0.43      0.08    -0.59    -0.27 1.00     3045     3146
contact:intention    -1.23      0.10    -1.44    -1.04 1.00     3056     3137

Further Distributional Parameters:
     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
disc     1.00      0.00     1.00     1.00   NA       NA       NA

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>For a little variety, we’ll make our coefficient plot with a little help from the <code>tidybayes::stat_gradientinterval()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>labs <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">"beta["</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="st">"]"</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(b12<span class="fl">.5</span>) <span class="sc">|&gt;</span> </span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(b_action<span class="sc">:</span><span class="st">`</span><span class="at">b_contact:intention</span><span class="st">`</span>) <span class="sc">|&gt;</span> </span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(labs) <span class="sc">|&gt;</span> </span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> name)) <span class="sc">+</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span>, <span class="at">linetype =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_gradientinterval</span>(<span class="at">.width =</span> <span class="fl">0.5</span>, <span class="at">point_size =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>                        <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>], </span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>                        <span class="at">fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>],</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">point_fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">3</span>],) <span class="sc">+</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"marginal posterior"</span>, <span class="at">breaks =</span> <span class="sc">-</span><span class="dv">5</span><span class="sc">:</span><span class="dv">0</span> <span class="sc">/</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="cn">NULL</span>, <span class="at">labels =</span> <span class="fu">parse</span>(<span class="at">text =</span> labs)) <span class="sc">+</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.4</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>As always, this will all be easier to see if we plot the posterior predictions. There is no perfect way to plot the predictions of these log-cumulative-odds models. Why? Because each prediction is really a vector of probabilities, one for each possible outcome value. So as a predictor variable changes value, the entire vector changes. This kind of thing can be visualized in several different ways. (p.&nbsp;388)</p>
</blockquote>
<p>Our approach to making the top panels of Figure 12.6 will start with <code>fitted()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(action, contact, intention) <span class="sc">|&gt;</span> </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">combination =</span> <span class="fu">str_c</span>(action, contact, intention, <span class="at">sep =</span> <span class="st">"_"</span>))</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b12<span class="fl">.5</span>,</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">newdata =</span> nd,</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">summary =</span> F)</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="co"># What have we done?</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>f <span class="sc">|&gt;</span> <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:4000, 1:6, 1:7] 0.0899 0.0886 0.0936 0.0907 0.0942 ...
 - attr(*, "dimnames")=List of 3
  ..$ : chr [1:4000] "1" "2" "3" "4" ...
  ..$ : NULL
  ..$ : chr [1:7] "1" "2" "3" "4" ...</code></pre>
</div>
</div>
<p>That returned a three-dimensional array. The 4,000 rows correspond to the 4,000 post-warmup iterations. The six columns correspond to the six unique combinations of <code>action</code>, <code>contact</code>, and <code>intention</code> within the data (i.e., <code>d |&gt; distinct(action, contact, intention)</code>). The three levels of the third dimension correspond to the seven levels of our <code>response</code> variable. This is all the information we need to plot our posterior in the triptych in the top row of Figure 12.6. It will take a bit of tricky wrangling to get it into a useful format. Our first several steps have to do with arranging the data into a long tibble format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">rbind</span>(f[, , <span class="dv">1</span>],</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>           f[, , <span class="dv">2</span>],</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>           f[, , <span class="dv">3</span>],</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>           f[, , <span class="dv">4</span>],</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>           f[, , <span class="dv">5</span>],</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>           f[, , <span class="dv">6</span>],</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>           f[, , <span class="dv">7</span>]) <span class="sc">|&gt;</span> </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">pull</span>(nd, combination)) <span class="sc">|&gt;</span> </span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">each =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">draw     =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4000</span>, <span class="at">times =</span> <span class="dv">7</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(draw, response),</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"action"</span>, <span class="st">"contact"</span>, <span class="st">"intention"</span>),</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>,</span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"pk"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">intention =</span> intention <span class="sc">|&gt;</span> <span class="fu">as.integer</span>())</span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a><span class="co"># How do the data look, now?</span></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 168,000
Columns: 6
$ response  &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ draw      &lt;int&gt; 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 7,…
$ action    &lt;chr&gt; "0", "0", "1", "0", "1", "0", "0", "0", "1", "0", "1", "0", "0", "0", "1", "0", "1", "0", "0", "0", "1", "0", …
$ contact   &lt;chr&gt; "1", "1", "0", "0", "0", "0", "1", "1", "0", "0", "0", "0", "1", "1", "0", "0", "0", "0", "1", "1", "0", "0", …
$ intention &lt;int&gt; 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0,…
$ pk        &lt;dbl&gt; 0.08991828, 0.31044381, 0.10102966, 0.06819220, 0.19327757, 0.08614161, 0.08857309, 0.31999125, 0.10063826, 0.…</code></pre>
</div>
</div>
<p>We’re moving pretty quickly, here. If it wasn’t apparent, the original values in the <code>f</code> data were in the probability metric. This is why we followed the convention from earlier in this section and named them <code>pk</code>. However, we need them to be in the cumulative-probability metric to make the top panels of the figure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To order our factor levels for `facet`</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"action=0, contact=0"</span>, <span class="st">"action=1, contact=0"</span>, <span class="st">"action=0, contact=1"</span>)</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> f <span class="sc">|&gt;</span> </span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unnecessary for these plots</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(response <span class="sc">&lt;</span> <span class="dv">7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This will help us define the three panels of the triptych</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">facet =</span> <span class="fu">factor</span>(<span class="fu">str_c</span>(<span class="st">"action="</span>, action, <span class="st">", contact="</span>, contact),</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">levels =</span> levels)) <span class="sc">|&gt;</span> </span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># These next three lines allow us to compute the cumulative probabilities</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(draw, facet, intention) <span class="sc">|&gt;</span> </span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(draw, facet, intention, response) <span class="sc">|&gt;</span> </span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">probability =</span> <span class="fu">cumsum</span>(pk)) <span class="sc">|&gt;</span> </span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># These next three lines are how we randomly selected 50 posterior draws</span></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>draw) <span class="sc">|&gt;</span> </span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data) <span class="sc">|&gt;</span> </span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot!</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> intention, <span class="at">y =</span> probability)) <span class="sc">+</span></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> <span class="fu">interaction</span>(draw, response), <span class="at">color =</span> probability),</span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> d <span class="sc">|&gt;</span>  <span class="co"># Wrangle the original data to make the dots</span></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>               <span class="fu">group_by</span>(intention, contact, action) <span class="sc">|&gt;</span> </span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>               <span class="fu">count</span>(response) <span class="sc">|&gt;</span> </span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>               <span class="fu">mutate</span>(<span class="at">probability =</span> <span class="fu">cumsum</span>(n <span class="sc">/</span> <span class="fu">sum</span>(n)),</span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>                      <span class="at">facet =</span> <span class="fu">factor</span>(<span class="fu">str_c</span>(<span class="st">"action="</span>, action, <span class="st">", contact="</span>, contact),</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">levels =</span> levels)) <span class="sc">|&gt;</span> </span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a>               <span class="fu">filter</span>(response <span class="sc">&lt;</span> <span class="dv">7</span>),</span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"intention"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">limits =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(<span class="at">low =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>],</span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>                       <span class="at">high =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> facet) <span class="sc">+</span></span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will look at the results of our code in just a bit. For now, we’ll focus on the code for the triptych in the bottom panels of Figure 12.6. These plots will be based on <code>predict()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">predict</span>(b12<span class="fl">.5</span>,</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">newdata =</span> nd,</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">ndraws =</span> <span class="dv">1000</span>,</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">scale =</span> <span class="st">"response"</span>,</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">summary =</span> F)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>p <span class="sc">|&gt;</span> <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:1000, 1:6] 4 2 1 4 7 5 6 5 7 4 ...
 - attr(*, "dimnames")=List of 2
  ..$ : NULL
  ..$ : NULL
 - attr(*, "levels")= chr [1:7] "1" "2" "3" "4" ...</code></pre>
</div>
</div>
<p>This time we have a simple two-dimensional array. There are only 1,000 rows because we set <code>ndraws = 1000</code>. Much like with <code>fitted()</code>, above, the six columns correspond to the six unique combinations of our three predictor variables. With the <code>scale = "response"</code> argument, we requested our results were in the metric of the original data, which were <code>response</code> values ranging from <code>1</code> to <code>7</code>. Compared to the last plot, the post-<code>predict()</code> data wrangling for this triptych is low-key. We just need the data in a long tibble format that includes a variable with which we might facet.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> p <span class="sc">|&gt;</span> </span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">pull</span>(nd, combination)) <span class="sc">|&gt;</span> </span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(),</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"action"</span>, <span class="st">"contact"</span>, <span class="st">"intention"</span>),</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>,</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"response"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">facet =</span> <span class="fu">factor</span>(<span class="fu">str_c</span>(<span class="st">"action="</span>, action, <span class="st">", contact="</span>, contact),</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">levels =</span> levels)) <span class="sc">|&gt;</span> </span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> response, <span class="at">fill =</span> intention)) <span class="sc">+</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.4</span>), <span class="at">width =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"response"</span>, <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> facet) <span class="sc">+</span></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we’re ready to combine our two triptychs into one glorious remake of Figure 12.6.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">/</span> p2) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"grey94"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Just for kicks and giggles, I’d like to make an alternative version of Figure 12.6. The triptych on the top panels did a pretty good job depicting the model in terms of the thresholds, <span class="math inline">\(\alpha_k\)</span>. It’s important that we, the data analysts, have a good sense of what those are. However, I suspect many of our substantively-oriented colleagues will find themselves confused by a plot like that. In my field, people generally just want to know <em>What’s the mean for each group?</em> At this point, you and I know that such a question is a bit impoverished compared the to the rich output from a model like this. But if we do want to boil these analyses down to comparisons of means, McElreath has already showed us how. Look back to <strong>R</strong> code 12.20 through 12.23 (pp.&nbsp;386–387). In those blocks, we multiplied the vector of probability values (<code>pk</code>) by their respective <code>response</code> values and summed, which produced an average outcome value. We can use that same approach so that our top triptych might express the results of the model in terms of means rather than parameters. All it takes is a slightly amended wrangling workflow with respect to the <code>f</code> data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> f <span class="sc">|&gt;</span> </span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">facet =</span> <span class="fu">factor</span>(<span class="fu">str_c</span>(<span class="st">"action="</span>, action, <span class="st">", contact="</span>, contact),</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">levels =</span> levels)) <span class="sc">|&gt;</span> </span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(draw, facet, intention) <span class="sc">|&gt;</span> </span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_response =</span> <span class="fu">sum</span>(pk <span class="sc">*</span> response)) <span class="sc">|&gt;</span> </span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>draw) <span class="sc">|&gt;</span> </span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data) <span class="sc">|&gt;</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> intention, <span class="at">y =</span> mean_response)) <span class="sc">+</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> draw, <span class="at">color =</span> mean_response),</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"intention"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"resopnse"</span>, <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)) <span class="sc">+</span></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(<span class="at">low =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>],</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">high =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> facet) <span class="sc">+</span></span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I really like how intuitive the histograms were in McElreath’s bottom triptych. A limitation of that approach, however, is there is no direct expression of uncertainty. To address this, we might recall that the bars in the histogram are basically just reparameterizations of the <code>pk</code> values already in our <code>f</code> data and, happily, our vector of <code>pk</code> values already contains the uncertainty in the posterior. One way we might express that is with the <code>tidybayes::stat_ccdfinterval()</code> function, which will return a bar plot where the top parts of the bars depict our uncertainty in terms of cumulative density curves.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> f <span class="sc">|&gt;</span> </span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">facet =</span> <span class="fu">factor</span>(<span class="fu">str_c</span>(<span class="st">"action="</span>, action, <span class="st">", contact="</span>, contact),</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">levels =</span> levels)) <span class="sc">|&gt;</span> </span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> response, <span class="at">y =</span> pk, <span class="at">fill =</span> <span class="fu">factor</span>(intention))) <span class="sc">+</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ccdfinterval</span>(<span class="at">.width =</span> <span class="fl">0.95</span>, <span class="at">justification =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, </span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">point_fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">3</span>], <span class="at">point_size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>,</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">width =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"resopnse"</span>, <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"count"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span> <span class="sc">/</span> <span class="dv">10</span>, <span class="at">labels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span> <span class="sc">*</span> <span class="dv">100</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> facet) <span class="sc">+</span></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s our alternative plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">/</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-70-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>I suspect our <code>stat_ccdfinterval()</code> approach would work better in plots with fewer bars. But hopefully it gives you some ideas.</p>
<section id="rethinking-staring-into-the-abyss" class="level4" data-number="12.3.3.1">
<h4 data-number="12.3.3.1" class="anchored" data-anchor-id="rethinking-staring-into-the-abyss"><span class="header-section-number">12.3.3.1</span> Rethinking: Staring into the abyss</h4>
<blockquote class="blockquote">
<p>The plotting code for ordered logistic models is complicated, compared to that of models from previous chapters. But as models become more monstrous, so too does the code needed to compute predictions and display them. With power comes hardship. It’s better to see the guts of the machine than to live in awe or fear of it. (p.&nbsp;391)</p>
</blockquote>
</section>
</section>
</section>
<section id="sec-Ordered-categorical-predictors" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="sec-Ordered-categorical-predictors"><span class="header-section-number">12.4</span> Ordered categorical predictors</h2>
<blockquote class="blockquote">
<p>We can handle ordered outcome variables using a categorical model with a cumulative link. That was the previous section. What about ordered predictor variables? We could just include them as continuous predictors like in any linear model. But this isn’t ideal. Just like with ordered outcomes, we don’t really want to assume that the distance between each ordinal value is the same. Luckily, we don’t have to. (p.&nbsp;391)</p>
</blockquote>
<p>Here are the eight levels of <code>edu</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(d, edu)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   edu
1        Middle School
2    Bachelor's Degree
3         Some College
4      Master's Degree
5 High School Graduate
6      Graduate Degree
7     Some High School
8    Elementary School</code></pre>
</div>
</div>
<p>McElreath defined his <code>edu_new</code> variable with an impressively compact couple lines of code. I’m going to take a more explicit approach with the <code>dplyr::recode()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">edu_new =</span> <span class="fu">recode</span>(</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    edu,</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Elementary School"</span>    <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Middle School"</span>        <span class="ot">=</span> <span class="dv">2</span>,</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Some High School"</span>     <span class="ot">=</span> <span class="dv">3</span>,</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"High School Graduate"</span> <span class="ot">=</span> <span class="dv">4</span>,</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Some College"</span>         <span class="ot">=</span> <span class="dv">5</span>, </span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bachelor's Degree"</span>    <span class="ot">=</span> <span class="dv">6</span>,</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Master's Degree"</span>      <span class="ot">=</span> <span class="dv">7</span>,</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Graduate Degree"</span>      <span class="ot">=</span> <span class="dv">8</span>) <span class="sc">|&gt;</span> </span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.integer</span>())</span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a><span class="co"># What did we do?</span></span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(edu, edu_new) <span class="sc">|&gt;</span> </span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(edu_new)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   edu edu_new
1    Elementary School       1
2        Middle School       2
3     Some High School       3
4 High School Graduate       4
5         Some College       5
6    Bachelor's Degree       6
7      Master's Degree       7
8      Graduate Degree       8</code></pre>
</div>
</div>
<p>The prior often used to handle monotonic effects is the Dirichlet distribution. The Dirichlet distribution is the multivariate extension of the beta distribution, which we met back in <a href="#sec-Beta-binomial" class="quarto-xref"><span>Section 12.1.1</span></a>. Here we follow McElreath’s <strong>R</strong> code 12.32 to simulate a few draws from the Dirichlet distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtools)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1805</span>)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> <span class="fu">rdirichlet</span>(<span class="dv">10</span>, <span class="at">alpha =</span> <span class="fu">rep</span>(<span class="dv">2</span>, <span class="dv">7</span>)) </span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(delta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:10, 1:7] 0.1053 0.2504 0.1917 0.1241 0.0877 ...</code></pre>
</div>
</div>
<p>Plot <code>delta</code> with <strong>ggplot2</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>delta <span class="sc">|&gt;</span> </span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>row, <span class="at">names_to =</span> <span class="st">"index"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> index, <span class="at">y =</span> value, <span class="at">group =</span> row,</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> row <span class="sc">==</span> <span class="dv">3</span>, <span class="at">color =</span> row <span class="sc">==</span> <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"probability"</span>) <span class="sc">+</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-74-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>The <strong>brms</strong> package has a <code>rdirichlet()</code> function, too. Here we use that to make an alternative version of the plot, above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12</span>)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>brms<span class="sc">::</span><span class="fu">rdirichlet</span>(<span class="at">n =</span> <span class="fl">1e4</span>, <span class="at">alpha =</span> <span class="fu">rep</span>(<span class="dv">2</span>, <span class="dv">7</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name  =</span> name <span class="sc">|&gt;</span> <span class="fu">as.double</span>(),</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">alpha =</span> <span class="fu">str_c</span>(<span class="st">"alpha["</span>, name, <span class="st">"]"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> name, <span class="at">group =</span> name, <span class="at">fill=</span> name)) <span class="sc">+</span> </span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span> </span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"probability"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>],</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>                      <span class="at">high =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">3</span>]) <span class="sc">+</span></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(<span class="at">low =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>],</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">high =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">3</span>]) <span class="sc">+</span></span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"Dirichlet"</span><span class="sc">*</span>(<span class="dv">2</span><span class="sc">*</span><span class="st">", "</span><span class="sc">*</span><span class="dv">2</span><span class="sc">*</span><span class="st">", "</span><span class="sc">*</span><span class="dv">2</span><span class="sc">*</span><span class="st">", "</span><span class="sc">*</span><span class="dv">2</span><span class="sc">*</span><span class="st">", "</span><span class="sc">*</span><span class="dv">2</span><span class="sc">*</span><span class="st">", "</span><span class="sc">*</span><span class="dv">2</span><span class="sc">*</span><span class="st">", "</span><span class="sc">*</span><span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> alpha, <span class="at">labeller =</span> label_parsed, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>When using <strong>brms</strong>, the issue of treating a predictor in the way McElreath covered in this section is referred to as <strong>monotonic effects</strong>. Bürkner outlined the issue in his <span class="citation" data-cites="Bürkner2022Monotonic">(<a href="references.html#ref-Bürkner2022Monotonic" role="doc-biblioref">2022c</a>)</span> vignette, <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_monotonic.html"><em>Estimating monotonic effects with with brms</em></a>, and in his <span class="citation" data-cites="burknerModellingMonotonicEffects2020">(<a href="references.html#ref-burknerModellingMonotonicEffects2020" role="doc-biblioref">2020</a>)</span> article with Emmanuel Charpentier, <em>Modelling monotonic effects of ordinal predictors in Bayesian regression models</em> (click <a href="https://psyarxiv.com/9qkhj/">here</a> for the freely-available preprint). From the introduction in Bürkner’s vignette, we read:</p>
<blockquote class="blockquote">
<p>For a single monotonic predictor, <span class="math inline">\(x\)</span>, the linear predictor term of observation <span class="math inline">\(n\)</span> looks as follows:</p>
<p><span class="math display">\[\eta_n = bD \sum_{i = 1}^{x_n} \zeta_i\]</span></p>
<p>The parameter <span class="math inline">\(b\)</span> can take on any real value, while <span class="math inline">\(\zeta\)</span> is a simplex, which means that it satisfies <span class="math inline">\(\zeta_i \in [0, 1]\)</span> and <span class="math inline">\(\sum_{i = 1}^D \zeta_i = 1\)</span> with <span class="math inline">\(D\)</span> being the number of elements of <span class="math inline">\(\zeta\)</span>. Equivalently, <span class="math inline">\(D\)</span> is the number of categories (or highest integer in the data) minus 1, since we start counting categories from zero to simplify the notation.</p>
</blockquote>
<p>In this context, <span class="math inline">\(n\)</span> indexes the observations in the hypothetical data and <span class="math inline">\(\eta\)</span> denotes the linear model for some outcome <span class="math inline">\(y\)</span>. Unlike with <strong>rethinking</strong>, the <strong>brms</strong> syntax for fitting models with monotonic predictors is fairly simple. Just place your monotonic predictors within the <code>mo()</code> function and enter them into the <code>formula</code>.</p>
<p>In the text (p.&nbsp;394), McElreath remarked it took about 20 minutes to fit this model in his computer. Using my 2023 MacBook Pro with the M2 chip, it took me just about the same amount of time. If you’re following along on your computer, get ready to wait a while when fitting a model like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> cumulative,</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  response <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> action <span class="sc">+</span> contact <span class="sc">+</span> intention <span class="sc">+</span> <span class="fu">mo</span>(edu_new),  <span class="co"># Note the `mo()` syntax</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b),</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Note the new kinds of prior statements</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.143</span>), <span class="at">class =</span> b, <span class="at">coef =</span> moedu_new),</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">dirichlet</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>), <span class="at">class =</span> simo, <span class="at">coef =</span> moedu_new1)),</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">12</span>,</span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b12.06"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b12<span class="fl">.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: cumulative 
  Links: mu = logit 
Formula: response ~ 1 + action + contact + intention + mo(edu_new) 
   Data: d (Number of observations: 9930) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept[1]    -3.14      0.17    -3.52    -2.86 1.00     1966     2021
Intercept[2]    -2.46      0.16    -2.83    -2.18 1.00     1976     2075
Intercept[3]    -1.87      0.16    -2.24    -1.60 1.00     1967     2104
Intercept[4]    -0.85      0.16    -1.22    -0.58 1.00     1976     2122
Intercept[5]    -0.18      0.16    -0.55     0.10 1.00     1957     2064
Intercept[6]     0.72      0.16     0.36     1.00 1.00     1977     2004
action          -0.71      0.04    -0.79    -0.63 1.00     4027     2725
contact         -0.96      0.05    -1.05    -0.86 1.00     4535     3268
intention       -0.72      0.04    -0.79    -0.65 1.00     4372     2423
moedu_new       -0.05      0.03    -0.11    -0.01 1.00     1959     2056

Monotonic Simplex Parameters:
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
moedu_new1[1]     0.26      0.15     0.03     0.59 1.00     2369     2284
moedu_new1[2]     0.14      0.09     0.02     0.36 1.00     4760     2183
moedu_new1[3]     0.19      0.11     0.03     0.44 1.00     4318     2272
moedu_new1[4]     0.16      0.09     0.03     0.39 1.00     3964     2297
moedu_new1[5]     0.03      0.04     0.00     0.12 1.00     2967     2482
moedu_new1[6]     0.09      0.06     0.01     0.25 1.00     3208     2532
moedu_new1[7]     0.12      0.07     0.02     0.28 1.00     4002     2620

Further Distributional Parameters:
     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
disc     1.00      0.00     1.00     1.00   NA       NA       NA

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>If you compare our results to those in the text, you may be surprised by how small our summary values are for <code>moedu_new</code>. <strong>brms</strong> and <strong>rethinking</strong> have an important difference in how they parameterize <span class="math inline">\(\beta_\text{Education}\)</span>. From page 392 in the text, McElreath explained the</p>
<blockquote class="blockquote">
<p>sum of all the <span class="math inline">\(\delta\)</span> parameters is the maximum education effect. It will be very convenient for interpretation if we call this maximum sum an ordinary coefficient like <span class="math inline">\(\beta_\text{E}\)</span> and then let the <span class="math inline">\(\delta\)</span> parameters be fractions of it. If we also make a dummy <span class="math inline">\(\delta_0 = 0\)</span> then we can write it all very compactly. Like this:</p>
<p><span class="math display">\[\phi_i = \beta_\text{E} \sum_{j = 0}^{\text{E}_i - 1} \delta_j + \text{other stuff}\]</span></p>
<p>where <span class="math inline">\(\text{E}_i\)</span> is the completed education level of individual <span class="math inline">\(i\)</span>. Now the sum of every <span class="math inline">\(\delta_j\)</span> is 1, and we can interpret the maximum education effect by looking at <span class="math inline">\(\beta_\text{E}\)</span>.</p>
</blockquote>
<p>The current version of <strong>brms</strong> takes expresses <span class="math inline">\(\beta_\text{E}\)</span> as an average effect. From <span class="citation" data-cites="burknerModellingMonotonicEffects2020">Bürkner &amp; Charpentier (<a href="references.html#ref-burknerModellingMonotonicEffects2020" role="doc-biblioref">2020</a>)</span>, we read:</p>
<blockquote class="blockquote">
<p>If the monotonic effect is used in a linear model, <span class="math inline">\(b\)</span> can be interpreted as the expected average difference between two adjacent categories of <span class="math inline">\(x\)</span>, while <span class="math inline">\(\zeta_i\)</span> describes the expected difference between the categories <span class="math inline">\(i\)</span> and <span class="math inline">\(i - 1\)</span> in the form of a proportion of the overall difference between lowest and highest categories. Thus, this parameterization has an intuitive interpretation while guaranteeing the monotonicity of the effect (p.&nbsp;6)</p>
</blockquote>
<p>To clarify, the <span class="math inline">\(b\)</span> in this section is what we’re calling <span class="math inline">\(\beta_\text{E}\)</span> in the current example and Bürkner and Charpentier used <span class="math inline">\(\zeta_i\)</span> in place of McElreath’s <span class="math inline">\(\delta_j\)</span>. The upshot of all this is that if we’d like to compare the summary of our <code>b12.6</code> to the results McElreath reported for his <code>m12.6</code>, we’ll need to multiply our <code>moedu_new</code> by 7.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(b12<span class="fl">.6</span>) <span class="sc">|&gt;</span> </span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">bE =</span> bsp_moedu_new <span class="sc">*</span> <span class="dv">7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median_qi</span>(<span class="at">.width =</span> <span class="fl">0.89</span>) <span class="sc">|&gt;</span> </span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
     bE .lower .upper .width .point .interval
  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 -0.37  -0.69  -0.12   0.89 median qi       </code></pre>
</div>
</div>
<p>This parameterization difference between <strong>brms</strong> and <strong>rethinking</strong> is also the reason why we set <code>prior(normal(0, 0.143), class = b, coef = moedu_new)</code> within <code>b12.6</code> whereas McElreath used a <span class="math inline">\(\operatorname{Normal}(0, 1)\)</span> prior for all his <span class="math inline">\(\beta\)</span> coefficients, including for his <code>bE</code>. Because our <code>moedu_new</code> (i.e., <span class="math inline">\(\beta_\text{E}\)</span>) is parameterized as the average of seven <span class="math inline">\(\delta\)</span> parameters, it made sense to divide our hyperparameter for <span class="math inline">\(\sigma\)</span> by 7. That is, <span class="math inline">\(1 / 7 \approx 0.143\)</span>.</p>
<p>This might be a good place to practice expressing our model in formal statistical notation. Here we’ll complement McElreath’s formula from page 392 by mixing in a little notation from <span class="citation" data-cites="burknerModellingMonotonicEffects2020">Bürkner &amp; Charpentier (<a href="references.html#ref-burknerModellingMonotonicEffects2020" role="doc-biblioref">2020</a>)</span>:</p>
<p><span class="math display">\[\begin{align*}
\text{response}_i &amp; \sim \operatorname{Categorical} (\mathbf p) \\
\operatorname{logit}(p_k) &amp; = \alpha_k - \phi_i \\
\phi_i &amp; = \beta_1 \text{action}_i + \beta_2 \text{contact}_i + \beta_3 \text{intention}_i + \color{#524a3a}{\beta_4 \operatorname{mo}(\text{edu\_new}_i, \boldsymbol{\delta})} \\
\alpha_k &amp; \sim \operatorname{Normal}(0, 1.5) \\
\beta_1, \dots, \beta_3 &amp; \sim \operatorname{Normal}(0, 1) \\
\color{#524a3a}{\beta_4} &amp; \color{#524a3a}\sim \color{#524a3a}{\operatorname{Normal}(0, 0.143)} \\
\color{#524a3a}{\boldsymbol{\delta}} &amp; \color{#524a3a}\sim \color{#524a3a}{\operatorname{Dirichlet}(2, 2, 2, 2, 2, 2, 2)},
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\operatorname{mo}(x, \boldsymbol{\delta})\)</span> is an operator indicating some predictor <span class="math inline">\(x\)</span> is has undergone the monotonic transform and <span class="math inline">\(\boldsymbol{\delta}\)</span> is our vector of simplex parameters <span class="math inline">\(\delta_1, \dots, \delta_7\)</span>. That is, <span class="math inline">\(\beta_4 \operatorname{mo}(\text{edu\_new}_i, \boldsymbol{\delta})\)</span> is our alternative <strong>brms</strong>-oriented way of expressing McElreath’s <span class="math inline">\(\beta_\text{E} \sum_{j = 0}^{\text{E}_i - 1} \delta_j\)</span>. I don’t know that one is better. 🤷🏻 At first contact, I found them both confusing.</p>
<p>Since this will be our only pairs plot for this chapter, let’s use <code>GGally::ggpairs()</code> to make it fancy. First we customize the panels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>my_lower <span class="ot">&lt;-</span> <span class="cf">function</span>(data, mapping, ...) {</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the x and y data to use the other code</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">eval_data_col</span>(data, mapping<span class="sc">$</span>x)</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">eval_data_col</span>(data, mapping<span class="sc">$</span>y)</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the correlations</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>  corr <span class="ot">&lt;-</span> <span class="fu">cor</span>(x, y, <span class="at">method =</span> <span class="st">"p"</span>, <span class="at">use =</span> <span class="st">"pairwise"</span>)</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>  abs_corr <span class="ot">&lt;-</span> <span class="fu">abs</span>(corr)</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the cor value</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggally_text</span>(</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">formatC</span>(corr, <span class="at">digits =</span> <span class="dv">2</span>, <span class="at">format =</span> <span class="st">"f"</span>) <span class="sc">|&gt;</span> <span class="fu">str_replace</span>(<span class="st">"0."</span>, <span class="st">"."</span>),</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(),</span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>],</span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>)</span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>my_diag <span class="ot">&lt;-</span> <span class="cf">function</span>(data, mapping, ...) {</span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> data, <span class="at">mapping =</span> mapping) <span class="sc">+</span> </span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>], <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>)</span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a>my_upper <span class="ot">&lt;-</span> <span class="cf">function</span>(data, mapping, ...) {</span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> data, <span class="at">mapping =</span> mapping) <span class="sc">+</span> </span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hex</span>(<span class="at">bins =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>],</span>
<span id="cb127-34"><a href="#cb127-34" aria-hidden="true" tabindex="-1"></a>                        <span class="at">high =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">3</span>]) <span class="sc">+</span></span>
<span id="cb127-35"><a href="#cb127-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]))</span>
<span id="cb127-36"><a href="#cb127-36" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are ready to make our custom version of the pairs plot in Figure 12.8.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>delta_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Elem"</span>, <span class="st">"MidSch"</span>, <span class="st">"SHS"</span>, <span class="st">"HSG"</span>, <span class="st">"SCol"</span>, <span class="st">"Bach"</span>, <span class="st">"Mast"</span>, <span class="st">"Grad"</span>)</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(b12<span class="fl">.6</span>) <span class="sc">|&gt;</span> </span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">"simo_moedu_new1"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">str_c</span>(delta_labels[<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>], <span class="st">"~(delta["</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="st">"])"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggpairs</span>(<span class="at">upper =</span> <span class="fu">list</span>(<span class="at">continuous =</span> my_upper),</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">diag =</span> <span class="fu">list</span>(<span class="at">continuous =</span> my_diag),</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">lower =</span> <span class="fu">list</span>(<span class="at">continuous =</span> my_lower),</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">labeller =</span> label_parsed) <span class="sc">+</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-79-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Here we add a normalized version of <code>edu_new</code> called <code>edu_norm</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">edu_norm =</span> (edu_new <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">7</span>)</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What does this look like?</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(edu, edu_new, edu_norm) <span class="sc">|&gt;</span> </span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(edu_new)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   edu edu_new  edu_norm
1    Elementary School       1 0.0000000
2        Middle School       2 0.1428571
3     Some High School       3 0.2857143
4 High School Graduate       4 0.4285714
5         Some College       5 0.5714286
6    Bachelor's Degree       6 0.7142857
7      Master's Degree       7 0.8571429
8      Graduate Degree       8 1.0000000</code></pre>
</div>
</div>
<p>Now fit the more conventional model in which we treat <code>edu_norm</code> as a simple continuous predictor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> cumulative,</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  response <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> action <span class="sc">+</span> contact <span class="sc">+</span> intention <span class="sc">+</span> edu_norm,</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> b)),</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">12</span>,</span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b12.07"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(b12<span class="fl">.7</span>)[<span class="dv">7</span><span class="sc">:</span><span class="dv">10</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Estimate  Est.Error       Q2.5       Q97.5
action    -0.7076040 0.04003921 -0.7834841 -0.63060464
contact   -0.9595411 0.04927724 -1.0570859 -0.86507226
intention -0.7199648 0.03635679 -0.7942429 -0.64744431
edu_norm  -0.1150526 0.09117114 -0.2922633  0.06046044</code></pre>
</div>
</div>
<p>It might be nice to get a better sense of the two models with a plot. For our approach, we’ll use <code>fitted()</code>. Start with <code>b12.6</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">edu_new   =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>,</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">action    =</span> <span class="dv">0</span>,</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">contact   =</span> <span class="dv">0</span>,</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">intention =</span> <span class="dv">0</span>)</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b12<span class="fl">.6</span>, <span class="at">newdata =</span> nd) </span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>f <span class="sc">|&gt;</span> <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:8, 1:4, 1:7] 0.042 0.0466 0.0489 0.0523 0.0552 ...
 - attr(*, "dimnames")=List of 3
  ..$ : NULL
  ..$ : chr [1:4] "Estimate" "Est.Error" "Q2.5" "Q97.5"
  ..$ : chr [1:7] "P(Y = 1)" "P(Y = 2)" "P(Y = 3)" "P(Y = 4)" ...</code></pre>
</div>
</div>
<p>The rows correspond to the eight educational levels. The columns are the typical summary columns. The seven levels of the third dimension are the seven levels of <code>response</code>. Before we plot, we’re going to need to wrangle that a little and then do the same thing all over for <code>b12.7</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># b12.6</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>f12<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">rbind</span>(f[, , <span class="dv">1</span>],</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">2</span>],</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">3</span>],</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">4</span>],</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">5</span>],</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">6</span>],</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">7</span>]) <span class="sc">|&gt;</span> </span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">edu      =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="at">times =</span> <span class="dv">7</span>)),</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">response =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">each =</span> <span class="dv">8</span>))</span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a><span class="co"># b12.7</span></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> nd <span class="sc">|&gt;</span> </span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">edu_norm  =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b12<span class="fl">.7</span>, <span class="at">newdata =</span> nd) </span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>f12<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">rbind</span>(f[, , <span class="dv">1</span>],</span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">2</span>],</span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">3</span>],</span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">4</span>],</span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">5</span>],</span>
<span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">6</span>],</span>
<span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a>               f[, , <span class="dv">7</span>]) <span class="sc">|&gt;</span> </span>
<span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">edu      =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="at">times =</span> <span class="dv">7</span>)),</span>
<span id="cb136-28"><a href="#cb136-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">response =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">each =</span> <span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now combine the two data objects and plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This will help with `scale_color_manual()`</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> scales<span class="sc">::</span><span class="fu">seq_gradient_pal</span>(</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>], </span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">3</span>])(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">8</span>))</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(f12<span class="fl">.6</span>, f12<span class="fl">.7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fit =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"b12.6 with `mo()` syntax"</span>, <span class="st">"b12.7 with conventional syntax"</span>), </span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">each =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> response, <span class="at">y =</span> Estimate,</span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>,</span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> edu, <span class="at">group =</span> edu)) <span class="sc">+</span></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>), <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"probability"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.43</span>)) <span class="sc">+</span></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="st">"education"</span>, <span class="at">values =</span> colors, <span class="at">labels =</span> delta_labels) <span class="sc">+</span></span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> fit)   <span class="sc">+</span></span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-84-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In case you were curious, the PSIS-LOO suggests the monotonic model (<code>b12.6</code>) made better sense of the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(b12<span class="fl">.6</span>, <span class="at">criterion =</span> <span class="st">"loo"</span>)</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>b12<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(b12<span class="fl">.7</span>, <span class="at">criterion =</span> <span class="st">"loo"</span>)</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(b12<span class="fl">.6</span>, b12<span class="fl">.7</span>, <span class="at">criterion =</span> <span class="st">"loo"</span>) <span class="sc">|&gt;</span> <span class="fu">print</span>(<span class="at">simplify =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      elpd_diff se_diff  elpd_loo se_elpd_loo p_loo    se_p_loo looic    se_looic
b12.6      0.0       0.0 -18540.4     38.1        11.0      0.1  37080.9     76.2
b12.7     -4.6       1.8 -18545.1     38.1         9.9      0.1  37090.1     76.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">model_weights</span>(b12<span class="fl">.6</span>, b12<span class="fl">.7</span>, <span class="at">weights =</span> <span class="st">"loo"</span>) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>b12.6 b12.7 
 0.99  0.01 </code></pre>
</div>
</div>
<p>We might explore the monotonic effects of <code>b12.6</code> in one more way. If you were reading closely along in the text, you may have noticed that “the sum of every <span class="math inline">\(\delta_j\)</span> is 1” (p.&nbsp;392). When using HMC, this is true for each posterior draw. We can exploit that information to visualize the <span class="math inline">\(\delta_j\)</span> parameters in a cumulative fashion.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(b12<span class="fl">.6</span>) <span class="sc">|&gt;</span> </span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">"new1"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">draw =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(), </span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">0</span><span class="st">`</span>  <span class="ot">=</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>draw, <span class="at">names_to =</span> <span class="st">"delta"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(delta) <span class="sc">|&gt;</span> </span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(draw) <span class="sc">|&gt;</span> </span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_sum =</span> <span class="fu">cumsum</span>(value)) <span class="sc">|&gt;</span> </span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> delta, <span class="at">y =</span> cum_sum)) <span class="sc">+</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_pointinterval</span>(<span class="at">.width =</span> <span class="fl">0.95</span>, <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_pointinterval</span>(<span class="at">.width =</span> <span class="fl">0.5</span>,</span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">4</span>],</span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">point_color =</span> <span class="fu">canva_pal</span>(<span class="st">"Green fields"</span>)(<span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="cn">NULL</span>, <span class="at">labels =</span> <span class="fu">parse</span>(<span class="at">text =</span> <span class="fu">str_c</span>(<span class="st">"delta["</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">7</span> , <span class="st">"]"</span>))) <span class="sc">+</span></span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"cumulative sum"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12_files/figure-html/unnamed-chunk-86-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>This is another way to show that the largest effects of education are when going from <code>Elementary School</code> to <code>Middle School</code> (<span class="math inline">\(\delta_0 \rightarrow \delta_1\)</span>) and when going from <code>Some High School</code> to <code>High School Graduate</code> (<span class="math inline">\(\delta_2 \rightarrow \delta_3\)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(edu, edu_new) <span class="sc">|&gt;</span> </span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(edu_new) <span class="sc">|&gt;</span> </span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">delta[j]</span><span class="st">`</span> <span class="ot">=</span> edu_new <span class="sc">-</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   edu edu_new delta[j]
1    Elementary School       1        0
2        Middle School       2        1
3     Some High School       3        2
4 High School Graduate       4        3
5         Some College       5        4
6    Bachelor's Degree       6        5
7      Master's Degree       7        6
8      Graduate Degree       8        7</code></pre>
</div>
</div>
</section>
<section id="summary" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="summary"><span class="header-section-number">12.5</span> Summary</h2>
<p>“This chapter introduced several new types of regression, all of which are generalizations of generalized linear models (GLMs)” (p.&nbsp;397). This chapter has been a ride. If you’d like more practice with the negative-binomial model and some of the others models for categorical data we covered in this chapter and in <a href="11.html" class="quarto-xref"><span>Chapter 11</span></a>, Alan Agresti covered them extensively in his <span class="citation" data-cites="agrestiFoundationsLinearGeneralized2015">(<a href="references.html#ref-agrestiFoundationsLinearGeneralized2015" role="doc-biblioref">2015</a>)</span> text, <a href="https://www.wiley.com/en-us/Foundations+of+Linear+and+Generalized+Linear+Models-p-9781118730034"><em>Foundations of linear and generalized linear models</em></a>. For more on different kinds of zero-inflated count models, check out <span class="citation" data-cites="atkinsTutorialCountRegression2013">Atkins et al. (<a href="references.html#ref-atkinsTutorialCountRegression2013" role="doc-biblioref">2013</a>)</span>, <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3513584/pdf/nihms396181.pdf"><em>A tutorial on count regression and zero-altered count models for longitudinal substance use data</em></a>. If you’d like to learn more about using cumulative probabilities to model ordinal data in <strong>brms</strong>, check out Bürkner and Vuorre’s <span class="citation" data-cites="burknerOrdinalRegressionModels2019">(<a href="references.html#ref-burknerOrdinalRegressionModels2019" role="doc-biblioref">2019</a>)</span> <a href="https://doi.org/10.1177/2515245918823199"><em>Ordinal regression models in psychology: A tutorial</em></a> and its repository on the Open Science Framework (<a href="https://osf.io/cu8jv/">https://osf.io/cu8jv/</a>). Also check out <a href="https://solomon.quarto.pub/dbda2/23.html">Chapter 23</a> of my <span class="citation" data-cites="kurzDoingBayesianDataAnalysis2026">(<a href="references.html#ref-kurzDoingBayesianDataAnalysis2026" role="doc-biblioref">2026</a>)</span> ebook <a href="https://solomon.quarto.pub/dbda2/"><em>Doing Bayesian Data Analysis in brms and the tidyverse</em></a> were we model ordinal data with a series of cumulative <em>probit</em> models.</p>
</section>
<section id="session-info" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="session-info">Session info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.1 (2025-06-13)
Platform: aarch64-apple-darwin20
Running under: macOS Ventura 13.4

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] GGally_2.4.0    gtools_3.9.5    patchwork_1.3.2 invgamma_1.2    tidybayes_3.0.7 brms_2.23.0     Rcpp_1.1.0     
 [8] lubridate_1.9.4 forcats_1.0.1   stringr_1.6.0   dplyr_1.1.4     purrr_1.2.1     readr_2.1.5     tidyr_1.3.2    
[15] tibble_3.3.1    ggplot2_4.0.1   tidyverse_2.0.0 ggthemes_5.1.0 

loaded via a namespace (and not attached):
 [1] gridExtra_2.3           inline_0.3.21           sandwich_3.1-1          rlang_1.1.7             magrittr_2.0.4         
 [6] multcomp_1.4-29         matrixStats_1.5.0       compiler_4.5.1          loo_2.9.0.9000          callr_3.7.6            
[11] vctrs_0.7.0             reshape2_1.4.5          pkgconfig_2.0.3         shape_1.4.6.1           arrayhelpers_1.1-0     
[16] crayon_1.5.3            fastmap_1.2.0           backports_1.5.0         labeling_0.4.3          utf8_1.2.6             
[21] cmdstanr_0.9.0          rmarkdown_2.30          BH_1.90.0-1             tzdb_0.5.0              ps_1.9.1               
[26] xfun_0.55               jsonlite_2.0.0          parallel_4.5.1          R6_2.6.1                stringi_1.8.7          
[31] RColorBrewer_1.1-3      StanHeaders_2.36.0.9000 estimability_1.5.1      assertthat_0.2.1        rstan_2.36.0.9000      
[36] knitr_1.51              zoo_1.8-14              bayesplot_1.15.0.9000   Matrix_1.7-3            splines_4.5.1          
[41] timechange_0.3.0        tidyselect_1.2.1        rstudioapi_0.17.1       abind_1.4-8             yaml_2.3.12            
[46] codetools_0.2-20        rethinking_2.42         curl_7.0.0              processx_3.8.6          pkgbuild_1.4.8         
[51] lattice_0.22-7          plyr_1.8.9              withr_3.0.2             bridgesampling_1.2-1    S7_0.2.1               
[56] posterior_1.6.1.9000    coda_0.19-4.1           evaluate_1.0.5          survival_3.8-3          ggstats_0.11.0         
[61] RcppParallel_5.1.11-1   ggdist_3.3.3            RcppEigen_0.3.4.0.2     pillar_1.11.1           tensorA_0.36.2.1       
[66] checkmate_2.3.3         stats4_4.5.1            distributional_0.5.0    generics_0.1.4          hms_1.1.4              
[71] rstantools_2.5.0.9000   scales_1.4.0            xtable_1.8-4            glue_1.8.0              emo_0.0.0.9000         
[76] emmeans_1.11.2-8        tools_4.5.1             hexbin_1.28.5           mvtnorm_1.3-3           grid_4.5.1             
[81] QuickJSR_1.8.1          nlme_3.1-168            cli_3.6.5               svUnit_1.0.8            Brobdingnag_1.2-9      
[86] V8_8.0.1                gtable_0.3.6            digest_0.6.39           TH.data_1.1-4           htmlwidgets_1.6.4      
[91] farver_2.1.2            htmltools_0.5.9         lifecycle_1.0.5         MASS_7.3-65            </code></pre>
</div>
</div>
</section>
<section id="comments" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="comments">Comments</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list" style="display: none">
<div id="ref-agrestiFoundationsLinearGeneralized2015" class="csl-entry" role="listitem">
Agresti, A. (2015). <em>Foundations of linear and generalized linear models</em>. John Wiley &amp; Sons. <a href="https://www.wiley.com/en-us/Foundations+of+Linear+and+Generalized+Linear+Models-p-9781118730034">https://www.wiley.com/en-us/Foundations+of+Linear+and+Generalized+Linear+Models-p-9781118730034</a>
</div>
<div id="ref-atkinsTutorialCountRegression2013" class="csl-entry" role="listitem">
Atkins, D. C., Baldwin, S. A., Zheng, C., Gallop, R. J., &amp; Neighbors, C. (2013). A tutorial on count regression and zero-altered count models for longitudinal substance use data. <em>Psychology of Addictive Behaviors : Journal of the Society of Psychologists in Addictive Behaviors</em>, <em>27</em>(1), 166–177. <a href="https://doi.org/10.1037/a0029508">https://doi.org/10.1037/a0029508</a>
</div>
<div id="ref-Bürkner2022Distributional" class="csl-entry" role="listitem">
Bürkner, P.-C. (2022a). <em>Estimating distributional models with brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_distreg.html">https://CRAN.R-project.org/package=brms/vignettes/brms_distreg.html</a>
</div>
<div id="ref-Bürkner2022Define" class="csl-entry" role="listitem">
Bürkner, P.-C. (2022b). <em>Define custom response distributions with brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_customfamilies.html">https://CRAN.R-project.org/package=brms/vignettes/brms_customfamilies.html</a>
</div>
<div id="ref-Bürkner2022Monotonic" class="csl-entry" role="listitem">
Bürkner, P.-C. (2022c). <em>Estimating monotonic effects with brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_monotonic.html">https://CRAN.R-project.org/package=brms/vignettes/brms_monotonic.html</a>
</div>
<div id="ref-Bürkner2022Parameterization" class="csl-entry" role="listitem">
Bürkner, P.-C. (2022d). <em>Parameterization of response distributions in brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_families.html">https://CRAN.R-project.org/package=brms/vignettes/brms_families.html</a>
</div>
<div id="ref-burknerModellingMonotonicEffects2020" class="csl-entry" role="listitem">
Bürkner, P.-C., &amp; Charpentier, E. (2020). Modelling monotonic effects of ordinal predictors in <span>Bayesian</span> regression models. <em>British Journal of Mathematical and Statistical Psychology</em>. <a href="https://doi.org/10.1111/bmsp.12195">https://doi.org/10.1111/bmsp.12195</a>
</div>
<div id="ref-burknerOrdinalRegressionModels2019" class="csl-entry" role="listitem">
Bürkner, P.-C., &amp; Vuorre, M. (2019). Ordinal regression models in psychology: <span>A</span> tutorial. <em>Advances in Methods and Practices in Psychological Science</em>, <em>2</em>(1), 77–101. <a href="https://doi.org/10.1177/2515245918823199">https://doi.org/10.1177/2515245918823199</a>
</div>
<div id="ref-cushmanRoleConsciousReasoning2006" class="csl-entry" role="listitem">
Cushman, F., Young, L., &amp; Hauser, M. (2006). The role of conscious reasoning and intuition in moral judgment: <span>Testing</span> three principles of harm. <em>Psychological Science</em>, <em>17</em>(12), 1082–1089. <a href="https://doi.org/10.1111/j.1467-9280.2006.01834.x">https://doi.org/10.1111/j.1467-9280.2006.01834.x</a>
</div>
<div id="ref-hilbeNegativeBinomialRegression2011" class="csl-entry" role="listitem">
Hilbe, J. M. (2011). <em>Negative binomial regression</em> (Second Edition). <a href="https://doi.org/10.1017/CBO9780511973420">https://doi.org/10.1017/CBO9780511973420</a>
</div>
<div id="ref-kruschkeDoingBayesianData2015" class="csl-entry" role="listitem">
Kruschke, J. K. (2015). <em>Doing <span>Bayesian</span> data analysis: <span>A</span> tutorial with <span>R</span>, <span>JAGS</span>, and <span>Stan</span></em>. Academic Press. <a href="https://sites.google.com/site/doingbayesiandataanalysis/">https://sites.google.com/site/doingbayesiandataanalysis/</a>
</div>
<div id="ref-kurzDoingBayesianDataAnalysis2026" class="csl-entry" role="listitem">
Kurz, A. S. (2026). <em>Doing <span>Bayesian</span> data analysis in brms and the tidyverse</em> (Version 1.3.0). <a href="https://solomon.quarto.pub/dbda2/">https://solomon.quarto.pub/dbda2/</a>
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2020" class="csl-entry" role="listitem">
McElreath, R. (2020). <em>Statistical rethinking: <span>A Bayesian</span> course with examples in <span>R</span> and <span>Stan</span></em> (Second Edition). CRC Press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a>
</div>
<div id="ref-standevelopmentteamStanFunctionsReference2022" class="csl-entry" role="listitem">
Stan Development Team. (2022). <em>Stan functions reference, <span>Version</span> 2.31</em>. <a href="https://mc-stan.org/docs/functions-reference/">https://mc-stan.org/docs/functions-reference/</a>
</div>
</div>
</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/solomon\.quarto\.pub\/sr2\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed";
    script.dataset.repoId = "MDEwOlJlcG9zaXRvcnkxNjE5MTg0MTE=";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOCaaty84C1AJZ";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./11.html" class="pagination-link" aria-label="God Spiked the Integers">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">God Spiked the Integers</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./13.html" class="pagination-link" aria-label="Models With Memory">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Models With Memory</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>