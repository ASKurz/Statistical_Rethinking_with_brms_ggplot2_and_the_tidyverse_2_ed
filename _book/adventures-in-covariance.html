<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>14 Adventures in Covariance | Statistical rethinking with brms, ggplot2, and the tidyverse: Second edition</title>
  <meta name="description" content="This book is an attempt to re-express the code in the second edition of McElreath’s textbook, ‘Statistical rethinking.’ His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="14 Adventures in Covariance | Statistical rethinking with brms, ggplot2, and the tidyverse: Second edition" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book is an attempt to re-express the code in the second edition of McElreath’s textbook, ‘Statistical rethinking.’ His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  <meta name="github-repo" content="ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="14 Adventures in Covariance | Statistical rethinking with brms, ggplot2, and the tidyverse: Second edition" />
  <meta name="twitter:site" content="@SolomonKurz" />
  <meta name="twitter:description" content="This book is an attempt to re-express the code in the second edition of McElreath’s textbook, ‘Statistical rethinking.’ His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  

<meta name="author" content="A Solomon Kurz" />


<meta name="date" content="2020-08-20" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="models-with-memory.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>What and why</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#caution-work-in-progress"><i class="fa fa-check"></i>Caution: Work in progress</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#thank-yous-are-in-order"><i class="fa fa-check"></i>Thank-you’s are in order</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="the-golem-of-prague.html"><a href="the-golem-of-prague.html"><i class="fa fa-check"></i><b>1</b> The Golem of Prague</a><ul>
<li class="chapter" data-level="" data-path="the-golem-of-prague.html"><a href="the-golem-of-prague.html#session-info"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html"><i class="fa fa-check"></i><b>2</b> Small Worlds and Large Worlds</a><ul>
<li class="chapter" data-level="2.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#the-garden-of-forking-data"><i class="fa fa-check"></i><b>2.1</b> The garden of forking data</a><ul>
<li class="chapter" data-level="2.1.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#counting-possibilities."><i class="fa fa-check"></i><b>2.1.1</b> Counting possibilities.</a></li>
<li class="chapter" data-level="2.1.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#combining-other-information."><i class="fa fa-check"></i><b>2.1.2</b> Combining other information.</a></li>
<li class="chapter" data-level="2.1.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#from-counts-to-probability."><i class="fa fa-check"></i><b>2.1.3</b> From counts to probability.</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#building-a-model"><i class="fa fa-check"></i><b>2.2</b> Building a model</a><ul>
<li class="chapter" data-level="2.2.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#a-data-story."><i class="fa fa-check"></i><b>2.2.1</b> A data story.</a></li>
<li class="chapter" data-level="2.2.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#bayesian-updating."><i class="fa fa-check"></i><b>2.2.2</b> Bayesian updating.</a></li>
<li class="chapter" data-level="2.2.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#evaluate."><i class="fa fa-check"></i><b>2.2.3</b> Evaluate.</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#components-of-the-model"><i class="fa fa-check"></i><b>2.3</b> Components of the model</a><ul>
<li class="chapter" data-level="2.3.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#variables."><i class="fa fa-check"></i><b>2.3.1</b> Variables.</a></li>
<li class="chapter" data-level="2.3.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#definitions."><i class="fa fa-check"></i><b>2.3.2</b> Definitions.</a></li>
<li class="chapter" data-level="2.3.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#a-model-is-born."><i class="fa fa-check"></i><b>2.3.3</b> A model is born.</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#making-the-model-go"><i class="fa fa-check"></i><b>2.4</b> Making the model go</a><ul>
<li class="chapter" data-level="2.4.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#bayes-theorem."><i class="fa fa-check"></i><b>2.4.1</b> Bayes’ theorem.</a></li>
<li class="chapter" data-level="2.4.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#motors."><i class="fa fa-check"></i><b>2.4.2</b> Motors.</a></li>
<li class="chapter" data-level="2.4.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#grid-approximation."><i class="fa fa-check"></i><b>2.4.3</b> Grid approximation.</a></li>
<li class="chapter" data-level="2.4.4" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#quadratic-approximation."><i class="fa fa-check"></i><b>2.4.4</b> Quadratic approximation.</a></li>
<li class="chapter" data-level="2.4.5" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#markov-chain-monte-carlo."><i class="fa fa-check"></i><b>2.4.5</b> Markov chain Monte Carlo.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#session-info-1"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html"><i class="fa fa-check"></i><b>3</b> Sampling the Imaginary</a><ul>
<li class="chapter" data-level="3.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-from-a-grid-approximate-posterior"><i class="fa fa-check"></i><b>3.1</b> Sampling from a grid-approximate posterior</a></li>
<li class="chapter" data-level="3.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-to-summarize"><i class="fa fa-check"></i><b>3.2</b> Sampling to summarize</a><ul>
<li class="chapter" data-level="3.2.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#intervals-of-defined-boundaries."><i class="fa fa-check"></i><b>3.2.1</b> Intervals of defined boundaries.</a></li>
<li class="chapter" data-level="3.2.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#intervals-of-defined-mass."><i class="fa fa-check"></i><b>3.2.2</b> Intervals of defined mass.</a></li>
<li class="chapter" data-level="3.2.3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#point-estimates."><i class="fa fa-check"></i><b>3.2.3</b> Point estimates.</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-to-simulate-prediction"><i class="fa fa-check"></i><b>3.3</b> Sampling to simulate prediction</a><ul>
<li class="chapter" data-level="3.3.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#dummy-data."><i class="fa fa-check"></i><b>3.3.1</b> Dummy data.</a></li>
<li class="chapter" data-level="3.3.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#model-checking."><i class="fa fa-check"></i><b>3.3.2</b> Model checking.</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#summary-lets-practice-with-brms"><i class="fa fa-check"></i><b>3.4</b> <del>Summary</del> Let’s practice with brms</a></li>
<li class="chapter" data-level="" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#session-info-2"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="geocentric-models.html"><a href="geocentric-models.html"><i class="fa fa-check"></i><b>4</b> Geocentric Models</a><ul>
<li class="chapter" data-level="4.1" data-path="geocentric-models.html"><a href="geocentric-models.html#why-normal-distributions-are-normal"><i class="fa fa-check"></i><b>4.1</b> Why normal distributions are normal</a><ul>
<li class="chapter" data-level="4.1.1" data-path="geocentric-models.html"><a href="geocentric-models.html#normal-by-addition."><i class="fa fa-check"></i><b>4.1.1</b> Normal by addition.</a></li>
<li class="chapter" data-level="4.1.2" data-path="geocentric-models.html"><a href="geocentric-models.html#normal-by-multiplication."><i class="fa fa-check"></i><b>4.1.2</b> Normal by multiplication.</a></li>
<li class="chapter" data-level="4.1.3" data-path="geocentric-models.html"><a href="geocentric-models.html#normal-by-log-multiplication."><i class="fa fa-check"></i><b>4.1.3</b> Normal by log-multiplication.</a></li>
<li class="chapter" data-level="4.1.4" data-path="geocentric-models.html"><a href="geocentric-models.html#using-gaussian-distributions."><i class="fa fa-check"></i><b>4.1.4</b> Using Gaussian distributions.</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="geocentric-models.html"><a href="geocentric-models.html#a-language-for-describing-models"><i class="fa fa-check"></i><b>4.2</b> A language for describing models</a><ul>
<li class="chapter" data-level="4.2.1" data-path="geocentric-models.html"><a href="geocentric-models.html#re-describing-the-globe-tossing-model."><i class="fa fa-check"></i><b>4.2.1</b> Re-describing the globe tossing model.</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="geocentric-models.html"><a href="geocentric-models.html#a-gaussian-model-of-height"><i class="fa fa-check"></i><b>4.3</b> A Gaussian model of height</a><ul>
<li class="chapter" data-level="4.3.1" data-path="geocentric-models.html"><a href="geocentric-models.html#the-data."><i class="fa fa-check"></i><b>4.3.1</b> The data.</a></li>
<li class="chapter" data-level="4.3.2" data-path="geocentric-models.html"><a href="geocentric-models.html#the-model."><i class="fa fa-check"></i><b>4.3.2</b> The model.</a></li>
<li class="chapter" data-level="4.3.3" data-path="geocentric-models.html"><a href="geocentric-models.html#grid-approximation-of-the-posterior-distribution."><i class="fa fa-check"></i><b>4.3.3</b> Grid approximation of the posterior distribution.</a></li>
<li class="chapter" data-level="4.3.4" data-path="geocentric-models.html"><a href="geocentric-models.html#sampling-from-the-posterior."><i class="fa fa-check"></i><b>4.3.4</b> Sampling from the posterior.</a></li>
<li class="chapter" data-level="4.3.5" data-path="geocentric-models.html"><a href="geocentric-models.html#finding-the-posterior-distribution-with-quap-brm."><i class="fa fa-check"></i><b>4.3.5</b> Finding the posterior distribution with <del><code>quap</code></del> <code>brm()</code>.</a></li>
<li class="chapter" data-level="4.3.6" data-path="geocentric-models.html"><a href="geocentric-models.html#sampling-from-a-quap-brm-fit."><i class="fa fa-check"></i><b>4.3.6</b> Sampling from a <del><code>quap()</code></del> <code>brm()</code> fit.</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="geocentric-models.html"><a href="geocentric-models.html#linear-prediction"><i class="fa fa-check"></i><b>4.4</b> Linear prediction</a><ul>
<li class="chapter" data-level="4.4.1" data-path="geocentric-models.html"><a href="geocentric-models.html#the-linear-model-strategy."><i class="fa fa-check"></i><b>4.4.1</b> The linear model strategy.</a></li>
<li class="chapter" data-level="4.4.2" data-path="geocentric-models.html"><a href="geocentric-models.html#finding-the-posterior-distribution."><i class="fa fa-check"></i><b>4.4.2</b> Finding the posterior distribution.</a></li>
<li class="chapter" data-level="4.4.3" data-path="geocentric-models.html"><a href="geocentric-models.html#interpreting-the-posterior-distribution."><i class="fa fa-check"></i><b>4.4.3</b> Interpreting the posterior distribution.</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="geocentric-models.html"><a href="geocentric-models.html#curves-from-lines"><i class="fa fa-check"></i><b>4.5</b> Curves from lines</a><ul>
<li class="chapter" data-level="4.5.1" data-path="geocentric-models.html"><a href="geocentric-models.html#polynomial-regression"><i class="fa fa-check"></i><b>4.5.1</b> Polynomial regression</a></li>
<li class="chapter" data-level="4.5.2" data-path="geocentric-models.html"><a href="geocentric-models.html#splines."><i class="fa fa-check"></i><b>4.5.2</b> Splines.</a></li>
<li class="chapter" data-level="4.5.3" data-path="geocentric-models.html"><a href="geocentric-models.html#smooth-functions-for-a-rough-world."><i class="fa fa-check"></i><b>4.5.3</b> Smooth functions for a rough world.</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="geocentric-models.html"><a href="geocentric-models.html#summary-b-splines-with-brms"><i class="fa fa-check"></i><b>4.6</b> <del>Summary</del> B-splines with <strong>brms</strong></a></li>
<li class="chapter" data-level="" data-path="geocentric-models.html"><a href="geocentric-models.html#session-info-3"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html"><i class="fa fa-check"></i><b>5</b> The Many Variables &amp; The Spurious Waffles</a><ul>
<li class="chapter" data-level="5.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#spurious-associations"><i class="fa fa-check"></i><b>5.1</b> Spurious associations</a><ul>
<li class="chapter" data-level="5.1.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#think-before-you-regress."><i class="fa fa-check"></i><b>5.1.1</b> Think before you regress.</a></li>
<li class="chapter" data-level="5.1.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#testable-implications."><i class="fa fa-check"></i><b>5.1.2</b> Testable implications.</a></li>
<li class="chapter" data-level="5.1.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#multiple-regression-notation."><i class="fa fa-check"></i><b>5.1.3</b> Multiple regression notation.</a></li>
<li class="chapter" data-level="5.1.4" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#approximating-the-posterior."><i class="fa fa-check"></i><b>5.1.4</b> Approximating the posterior.</a></li>
<li class="chapter" data-level="5.1.5" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#plotting-multivariate-posteriors."><i class="fa fa-check"></i><b>5.1.5</b> Plotting multivariate posteriors.</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#masked-relationship"><i class="fa fa-check"></i><b>5.2</b> Masked relationship</a></li>
<li class="chapter" data-level="5.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#categorical-varaibles"><i class="fa fa-check"></i><b>5.3</b> Categorical varaibles</a><ul>
<li class="chapter" data-level="5.3.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#binary-categories."><i class="fa fa-check"></i><b>5.3.1</b> Binary categories.</a></li>
<li class="chapter" data-level="5.3.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#many-categories."><i class="fa fa-check"></i><b>5.3.2</b> Many categories.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#session-info-4"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html"><i class="fa fa-check"></i><b>6</b> The Haunted DAG &amp; The Causal Terror</a><ul>
<li class="chapter" data-level="6.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#multicollinearity"><i class="fa fa-check"></i><b>6.1</b> Multicollinearity</a><ul>
<li class="chapter" data-level="6.1.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#multicollinear-legs."><i class="fa fa-check"></i><b>6.1.1</b> Multicollinear legs.</a></li>
<li class="chapter" data-level="6.1.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#multicollinear-milk."><i class="fa fa-check"></i><b>6.1.2</b> Multicollinear <code>milk</code>.</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#post-treatment-bias"><i class="fa fa-check"></i><b>6.2</b> Post-treatment bias</a><ul>
<li class="chapter" data-level="6.2.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#a-prior-is-born."><i class="fa fa-check"></i><b>6.2.1</b> A prior is born.</a></li>
<li class="chapter" data-level="6.2.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#blocked-by-consequence."><i class="fa fa-check"></i><b>6.2.2</b> Blocked by consequence.</a></li>
<li class="chapter" data-level="6.2.3" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#fungus-and-d-separation."><i class="fa fa-check"></i><b>6.2.3</b> Fungus and <span class="math inline">\(d\)</span>-separation.</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#collider-bias"><i class="fa fa-check"></i><b>6.3</b> Collider bias</a><ul>
<li class="chapter" data-level="6.3.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#collider-of-false-sorrow."><i class="fa fa-check"></i><b>6.3.1</b> Collider of false sorrow.</a></li>
<li class="chapter" data-level="6.3.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#the-haunted-dag."><i class="fa fa-check"></i><b>6.3.2</b> The haunted DAG.</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#confronting-confounding"><i class="fa fa-check"></i><b>6.4</b> Confronting confounding</a><ul>
<li class="chapter" data-level="6.4.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#shutting-the-backdoor."><i class="fa fa-check"></i><b>6.4.1</b> Shutting the backdoor.</a></li>
<li class="chapter" data-level="6.4.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#two-roads."><i class="fa fa-check"></i><b>6.4.2</b> Two roads.</a></li>
<li class="chapter" data-level="6.4.3" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#backdoor-waffles."><i class="fa fa-check"></i><b>6.4.3</b> Backdoor waffles.</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#summary-and-a-little-more-practice"><i class="fa fa-check"></i><b>6.5</b> Summary [and a little more practice]</a></li>
<li class="chapter" data-level="" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#session-info-5"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ulysses-compass.html"><a href="ulysses-compass.html"><i class="fa fa-check"></i><b>7</b> Ulysses’ Compass</a><ul>
<li class="chapter" data-level="7.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#the-problem-with-parameters"><i class="fa fa-check"></i><b>7.1</b> The problem with parameters</a><ul>
<li class="chapter" data-level="7.1.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#more-parameters-almost-always-improve-fit."><i class="fa fa-check"></i><b>7.1.1</b> More parameters (almost) always improve fit.</a></li>
<li class="chapter" data-level="7.1.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#too-few-parameters-hurts-too."><i class="fa fa-check"></i><b>7.1.2</b> Too few parameters hurts, too.</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#entropy-and-accuracy"><i class="fa fa-check"></i><b>7.2</b> Entropy and accuracy</a><ul>
<li class="chapter" data-level="7.2.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#firing-the-weatherperson."><i class="fa fa-check"></i><b>7.2.1</b> Firing the weatherperson.</a></li>
<li class="chapter" data-level="7.2.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#information-and-uncertainty."><i class="fa fa-check"></i><b>7.2.2</b> Information and uncertainty.</a></li>
<li class="chapter" data-level="7.2.3" data-path="ulysses-compass.html"><a href="ulysses-compass.html#from-entropy-to-accuracy."><i class="fa fa-check"></i><b>7.2.3</b> From entropy to accuracy.</a></li>
<li class="chapter" data-level="7.2.4" data-path="ulysses-compass.html"><a href="ulysses-compass.html#estimating-divergence."><i class="fa fa-check"></i><b>7.2.4</b> Estimating divergence.</a></li>
<li class="chapter" data-level="7.2.5" data-path="ulysses-compass.html"><a href="ulysses-compass.html#scoring-the-right-data."><i class="fa fa-check"></i><b>7.2.5</b> Scoring the right data.</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ulysses-compass.html"><a href="ulysses-compass.html#golem-taming-regularization"><i class="fa fa-check"></i><b>7.3</b> Golem taming: regularization</a></li>
<li class="chapter" data-level="7.4" data-path="ulysses-compass.html"><a href="ulysses-compass.html#predicting-predictive-accuracy"><i class="fa fa-check"></i><b>7.4</b> Predicting predictive accuracy</a><ul>
<li class="chapter" data-level="7.4.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#cross-validation."><i class="fa fa-check"></i><b>7.4.1</b> Cross-validation.</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="ulysses-compass.html"><a href="ulysses-compass.html#information-criteria"><i class="fa fa-check"></i><b>7.5</b> Information criteria</a><ul>
<li class="chapter" data-level="7.5.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#comparing-cv-psis-and-waic."><i class="fa fa-check"></i><b>7.5.1</b> Comparing CV, PSIS, and WAIC.</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="ulysses-compass.html"><a href="ulysses-compass.html#model-comparison"><i class="fa fa-check"></i><b>7.6</b> Model comparison</a><ul>
<li class="chapter" data-level="7.6.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#model-mis-selection."><i class="fa fa-check"></i><b>7.6.1</b> Model mis-selection.</a></li>
<li class="chapter" data-level="7.6.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#outliers-and-other-illusions."><i class="fa fa-check"></i><b>7.6.2</b> Outliers and other illusions.</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="ulysses-compass.html"><a href="ulysses-compass.html#summarybonus-r2-talk"><i class="fa fa-check"></i><b>7.7</b> <del>Summary</del>Bonus: <span class="math inline">\(R^2\)</span> talk</a></li>
<li class="chapter" data-level="" data-path="ulysses-compass.html"><a href="ulysses-compass.html#session-info-6"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="conditional-manatees.html"><a href="conditional-manatees.html"><i class="fa fa-check"></i><b>8</b> Conditional Manatees</a><ul>
<li class="chapter" data-level="8.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#building-an-interaction."><i class="fa fa-check"></i><b>8.1</b> Building an interaction.</a><ul>
<li class="chapter" data-level="8.1.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#making-a-rugged-model."><i class="fa fa-check"></i><b>8.1.1</b> Making a rugged model.</a></li>
<li class="chapter" data-level="8.1.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#adding-an-indicator-variable-isnt-enough."><i class="fa fa-check"></i><b>8.1.2</b> Adding an indicator variable isn’t enough.</a></li>
<li class="chapter" data-level="8.1.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#adding-an-interaction-does-work."><i class="fa fa-check"></i><b>8.1.3</b> Adding an interaction does work.</a></li>
<li class="chapter" data-level="8.1.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-the-interaction."><i class="fa fa-check"></i><b>8.1.4</b> Plotting the interaction.</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#symmetry-of-interactions"><i class="fa fa-check"></i><b>8.2</b> Symmetry of interactions</a></li>
<li class="chapter" data-level="8.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#continuous-interactions"><i class="fa fa-check"></i><b>8.3</b> Continuous interactions</a><ul>
<li class="chapter" data-level="8.3.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#a-winter-flower."><i class="fa fa-check"></i><b>8.3.1</b> A winter flower.</a></li>
<li class="chapter" data-level="8.3.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#the-models."><i class="fa fa-check"></i><b>8.3.2</b> The models.</a></li>
<li class="chapter" data-level="8.3.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-posterior-predictions."><i class="fa fa-check"></i><b>8.3.3</b> Plotting posterior predictions.</a></li>
<li class="chapter" data-level="8.3.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-prior-predictions."><i class="fa fa-check"></i><b>8.3.4</b> Plotting prior predictions.</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#summary-bonus-conditional_effects"><i class="fa fa-check"></i><b>8.4</b> <del>Summary</del> Bonus: <code>conditional_effects()</code></a></li>
<li class="chapter" data-level="" data-path="conditional-manatees.html"><a href="conditional-manatees.html#session-info-7"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html"><i class="fa fa-check"></i><b>9</b> Markov Chain Monte Carlo</a><ul>
<li class="chapter" data-level="9.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#good-king-markov-and-his-island-kingdom"><i class="fa fa-check"></i><b>9.1</b> Good King Markov and his island kingdom</a></li>
<li class="chapter" data-level="9.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#metropolis-algorithms"><i class="fa fa-check"></i><b>9.2</b> Metropolis algorithms</a><ul>
<li class="chapter" data-level="9.2.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#gibbs-sampling."><i class="fa fa-check"></i><b>9.2.1</b> Gibbs sampling.</a></li>
<li class="chapter" data-level="9.2.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#high-dimensional-problems."><i class="fa fa-check"></i><b>9.2.2</b> High-dimensional problems.</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#hamiltonian-monte-carlo"><i class="fa fa-check"></i><b>9.3</b> Hamiltonian Monte Carlo</a><ul>
<li class="chapter" data-level="9.3.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#limitations."><i class="fa fa-check"></i><b>9.3.1</b> Limitations.</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#easy-hmc-ulam-brm"><i class="fa fa-check"></i><b>9.4</b> Easy HMC: <del>ulam</del> <code>brm()</code></a><ul>
<li class="chapter" data-level="9.4.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#preparation."><i class="fa fa-check"></i><b>9.4.1</b> Preparation.</a></li>
<li class="chapter" data-level="9.4.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#estimation."><i class="fa fa-check"></i><b>9.4.2</b> Estimation.</a></li>
<li class="chapter" data-level="9.4.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#sampling-again-in-parallel."><i class="fa fa-check"></i><b>9.4.3</b> Sampling again, in parallel.</a></li>
<li class="chapter" data-level="9.4.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#visualization."><i class="fa fa-check"></i><b>9.4.4</b> Visualization.</a></li>
<li class="chapter" data-level="9.4.5" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#checking-the-chain."><i class="fa fa-check"></i><b>9.4.5</b> Checking the chain.</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#care-and-feeding-of-your-markov-chain."><i class="fa fa-check"></i><b>9.5</b> Care and feeding of your Markov chain.</a><ul>
<li class="chapter" data-level="9.5.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#how-many-samples-do-you-need"><i class="fa fa-check"></i><b>9.5.1</b> How many samples do you need?</a></li>
<li class="chapter" data-level="9.5.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#how-many-chains-do-you-need"><i class="fa fa-check"></i><b>9.5.2</b> How many chains do you need?</a></li>
<li class="chapter" data-level="9.5.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#taming-a-wild-chain."><i class="fa fa-check"></i><b>9.5.3</b> Taming a wild chain.</a></li>
<li class="chapter" data-level="9.5.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#non-identifiable-parameters."><i class="fa fa-check"></i><b>9.5.4</b> Non-identifiable parameters.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#session-info-8"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html"><i class="fa fa-check"></i><b>10</b> Big Entropy and the Generalized Linear Model</a><ul>
<li class="chapter" data-level="10.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#maximum-entropy"><i class="fa fa-check"></i><b>10.1</b> Maximum entropy</a><ul>
<li class="chapter" data-level="10.1.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#gaussian."><i class="fa fa-check"></i><b>10.1.1</b> Gaussian.</a></li>
<li class="chapter" data-level="10.1.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#binomial."><i class="fa fa-check"></i><b>10.1.2</b> Binomial.</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#generalized-linear-models"><i class="fa fa-check"></i><b>10.2</b> Generalized linear models</a><ul>
<li class="chapter" data-level="10.2.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#meet-the-family."><i class="fa fa-check"></i><b>10.2.1</b> Meet the family.</a></li>
<li class="chapter" data-level="10.2.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#linking-linear-models-to-distributions."><i class="fa fa-check"></i><b>10.2.2</b> Linking linear models to distributions.</a></li>
<li class="chapter" data-level="10.2.3" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#omitted-variable-bias-again."><i class="fa fa-check"></i><b>10.2.3</b> Omitted variable bias again.</a></li>
<li class="chapter" data-level="10.2.4" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#absolute-and-relative-differences."><i class="fa fa-check"></i><b>10.2.4</b> Absolute and relative differences.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#session-info-9"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html"><i class="fa fa-check"></i><b>11</b> God Spiked the Integers</a><ul>
<li class="chapter" data-level="11.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#binomial-regression"><i class="fa fa-check"></i><b>11.1</b> Binomial regression</a><ul>
<li class="chapter" data-level="11.1.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#logistic-regression-prosocial-chimpanzees."><i class="fa fa-check"></i><b>11.1.1</b> Logistic regression: Prosocial chimpanzees.</a></li>
<li class="chapter" data-level="11.1.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#relative-shark-and-absolute-deer."><i class="fa fa-check"></i><b>11.1.2</b> Relative shark and absolute deer.</a></li>
<li class="chapter" data-level="11.1.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#aggregated-binomial-chimpanzees-again-condensed."><i class="fa fa-check"></i><b>11.1.3</b> Aggregated binomial: Chimpanzees again, condensed.</a></li>
<li class="chapter" data-level="11.1.4" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#aggregated-binomial-graduate-school-admissions."><i class="fa fa-check"></i><b>11.1.4</b> Aggregated binomial: Graduate school admissions.</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#poisson-regression"><i class="fa fa-check"></i><b>11.2</b> Poisson regression</a><ul>
<li class="chapter" data-level="11.2.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#example-oceanic-tool-complexity."><i class="fa fa-check"></i><b>11.2.1</b> Example: Oceanic tool complexity.</a></li>
<li class="chapter" data-level="11.2.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#negative-binomial-gamma-poisson-models."><i class="fa fa-check"></i><b>11.2.2</b> Negative binomial (gamma-Poisson) models.</a></li>
<li class="chapter" data-level="11.2.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#example-exposure-and-the-offset."><i class="fa fa-check"></i><b>11.2.3</b> Example: Exposure and the offset.</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#multinomial-and-categorical-models"><i class="fa fa-check"></i><b>11.3</b> Multinomial and categorical models</a><ul>
<li class="chapter" data-level="11.3.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#predictors-matched-to-observations."><i class="fa fa-check"></i><b>11.3.1</b> Predictors matched to observations.</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#summary"><i class="fa fa-check"></i><b>11.4</b> Summary</a></li>
<li class="chapter" data-level="" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#session-info-10"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html"><i class="fa fa-check"></i><b>12</b> Monsters and Mixtures</a><ul>
<li class="chapter" data-level="12.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#over-dispersed-counts"><i class="fa fa-check"></i><b>12.1</b> Over-dispersed counts</a><ul>
<li class="chapter" data-level="12.1.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#beta-binomial."><i class="fa fa-check"></i><b>12.1.1</b> Beta-binomial.</a></li>
<li class="chapter" data-level="12.1.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#negative-binomial-or-gamma-poisson."><i class="fa fa-check"></i><b>12.1.2</b> Negative-binomial or gamma-Poisson.</a></li>
<li class="chapter" data-level="12.1.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#over-dispersion-entropy-and-information-criteria."><i class="fa fa-check"></i><b>12.1.3</b> Over-dispersion, entropy, and information criteria.</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#zero-inflated-outcomes"><i class="fa fa-check"></i><b>12.2</b> Zero-inflated outcomes</a><ul>
<li class="chapter" data-level="12.2.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#example-zero-inflated-poisson."><i class="fa fa-check"></i><b>12.2.1</b> Example: Zero-inflated Poisson.</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#ordered-categorical-outcomes"><i class="fa fa-check"></i><b>12.3</b> Ordered categorical outcomes</a><ul>
<li class="chapter" data-level="12.3.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#example-moral-intuition."><i class="fa fa-check"></i><b>12.3.1</b> Example: Moral intuition.</a></li>
<li class="chapter" data-level="12.3.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#describing-an-ordered-distribution-with-intercepts."><i class="fa fa-check"></i><b>12.3.2</b> Describing an ordered distribution with intercepts.</a></li>
<li class="chapter" data-level="12.3.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#adding-predictor-variables."><i class="fa fa-check"></i><b>12.3.3</b> Adding predictor variables.</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#ordered-categorical-predictors"><i class="fa fa-check"></i><b>12.4</b> Ordered categorical predictors</a></li>
<li class="chapter" data-level="12.5" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#summary-1"><i class="fa fa-check"></i><b>12.5</b> Summary</a></li>
<li class="chapter" data-level="" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#session-info-11"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="models-with-memory.html"><a href="models-with-memory.html"><i class="fa fa-check"></i><b>13</b> Models With Memory</a><ul>
<li class="chapter" data-level="13.1" data-path="models-with-memory.html"><a href="models-with-memory.html#example-multilevel-tadpoles"><i class="fa fa-check"></i><b>13.1</b> Example: Multilevel tadpoles</a></li>
<li class="chapter" data-level="13.2" data-path="models-with-memory.html"><a href="models-with-memory.html#varying-effects-and-the-underfittingoverfitting-trade-off"><i class="fa fa-check"></i><b>13.2</b> Varying effects and the underfitting/overfitting trade-off</a><ul>
<li class="chapter" data-level="13.2.1" data-path="models-with-memory.html"><a href="models-with-memory.html#the-model.-1"><i class="fa fa-check"></i><b>13.2.1</b> The model.</a></li>
<li class="chapter" data-level="13.2.2" data-path="models-with-memory.html"><a href="models-with-memory.html#assign-values-to-the-parameters."><i class="fa fa-check"></i><b>13.2.2</b> Assign values to the parameters.</a></li>
<li class="chapter" data-level="13.2.3" data-path="models-with-memory.html"><a href="models-with-memory.html#sumulate-survivors."><i class="fa fa-check"></i><b>13.2.3</b> Sumulate survivors.</a></li>
<li class="chapter" data-level="13.2.4" data-path="models-with-memory.html"><a href="models-with-memory.html#compute-the-no-pooling-estimates."><i class="fa fa-check"></i><b>13.2.4</b> Compute the no-pooling estimates.</a></li>
<li class="chapter" data-level="13.2.5" data-path="models-with-memory.html"><a href="models-with-memory.html#compute-the-partial-pooling-estimates."><i class="fa fa-check"></i><b>13.2.5</b> Compute the partial-pooling estimates.</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="models-with-memory.html"><a href="models-with-memory.html#more-than-one-type-of-cluster"><i class="fa fa-check"></i><b>13.3</b> More than one type of cluster</a><ul>
<li class="chapter" data-level="13.3.1" data-path="models-with-memory.html"><a href="models-with-memory.html#multilevel-chimpanzees."><i class="fa fa-check"></i><b>13.3.1</b> Multilevel chimpanzees.</a></li>
<li class="chapter" data-level="13.3.2" data-path="models-with-memory.html"><a href="models-with-memory.html#even-more-clusters."><i class="fa fa-check"></i><b>13.3.2</b> Even more clusters.</a></li>
</ul></li>
<li class="chapter" data-level="13.4" data-path="models-with-memory.html"><a href="models-with-memory.html#divergent-transitions-and-non-centered-priors"><i class="fa fa-check"></i><b>13.4</b> Divergent transitions and non-centered priors</a><ul>
<li class="chapter" data-level="13.4.1" data-path="models-with-memory.html"><a href="models-with-memory.html#the-devils-funnel."><i class="fa fa-check"></i><b>13.4.1</b> The Devil’s Funnel.</a></li>
<li class="chapter" data-level="13.4.2" data-path="models-with-memory.html"><a href="models-with-memory.html#non-centered-chimpanzees."><i class="fa fa-check"></i><b>13.4.2</b> Non-centered chimpanzees.</a></li>
</ul></li>
<li class="chapter" data-level="13.5" data-path="models-with-memory.html"><a href="models-with-memory.html#multilevel-posterior-predictions"><i class="fa fa-check"></i><b>13.5</b> Multilevel posterior predictions</a><ul>
<li class="chapter" data-level="13.5.1" data-path="models-with-memory.html"><a href="models-with-memory.html#posterior-prediction-for-same-clusters."><i class="fa fa-check"></i><b>13.5.1</b> Posterior prediction for same clusters.</a></li>
<li class="chapter" data-level="13.5.2" data-path="models-with-memory.html"><a href="models-with-memory.html#posterior-prediction-for-new-clusters."><i class="fa fa-check"></i><b>13.5.2</b> Posterior prediction for new clusters.</a></li>
<li class="chapter" data-level="13.5.3" data-path="models-with-memory.html"><a href="models-with-memory.html#post-stratification."><i class="fa fa-check"></i><b>13.5.3</b> Post-stratification.</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="models-with-memory.html"><a href="models-with-memory.html#summary-bonus-post-stratification-in-an-example"><i class="fa fa-check"></i><b>13.6</b> <del>Summary</del> Bonus: Post-stratification in an example</a><ul>
<li class="chapter" data-level="13.6.1" data-path="models-with-memory.html"><a href="models-with-memory.html#meet-the-data."><i class="fa fa-check"></i><b>13.6.1</b> Meet the data.</a></li>
<li class="chapter" data-level="13.6.2" data-path="models-with-memory.html"><a href="models-with-memory.html#settle-the-mr-part-of-mrp."><i class="fa fa-check"></i><b>13.6.2</b> Settle the MR part of MRP.</a></li>
<li class="chapter" data-level="13.6.3" data-path="models-with-memory.html"><a href="models-with-memory.html#post-stratify-to-put-the-p-in-mrp."><i class="fa fa-check"></i><b>13.6.3</b> Post-stratify to put the P in MRP.</a></li>
<li class="chapter" data-level="13.6.4" data-path="models-with-memory.html"><a href="models-with-memory.html#wrap-this-mrp-up."><i class="fa fa-check"></i><b>13.6.4</b> Wrap this MRP up.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="models-with-memory.html"><a href="models-with-memory.html#session-info-12"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html"><i class="fa fa-check"></i><b>14</b> Adventures in Covariance</a><ul>
<li class="chapter" data-level="14.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#varying-slopes-by-construction"><i class="fa fa-check"></i><b>14.1</b> Varying slopes by construction</a><ul>
<li class="chapter" data-level="14.1.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#simulate-the-population."><i class="fa fa-check"></i><b>14.1.1</b> Simulate the population.</a></li>
<li class="chapter" data-level="14.1.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#simulate-observations."><i class="fa fa-check"></i><b>14.1.2</b> Simulate observations.</a></li>
<li class="chapter" data-level="14.1.3" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#the-varying-slopes-model."><i class="fa fa-check"></i><b>14.1.3</b> The varying slopes model.</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#advanced-varying-slopes"><i class="fa fa-check"></i><b>14.2</b> Advanced varying slopes</a></li>
<li class="chapter" data-level="14.3" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#instruments-and-causal-designs"><i class="fa fa-check"></i><b>14.3</b> Instruments and causal designs</a><ul>
<li class="chapter" data-level="14.3.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#instrumental-variables."><i class="fa fa-check"></i><b>14.3.1</b> Instrumental variables.</a></li>
<li class="chapter" data-level="14.3.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#other-designs."><i class="fa fa-check"></i><b>14.3.2</b> Other designs.</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#social-relations-as-correlated-varying-effects"><i class="fa fa-check"></i><b>14.4</b> Social relations as correlated varying effects</a></li>
<li class="chapter" data-level="14.5" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#continuous-categories-and-the-gaussian-process"><i class="fa fa-check"></i><b>14.5</b> Continuous categories and the Gaussian process</a><ul>
<li class="chapter" data-level="14.5.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#example-spatial-autocorrelation-in-oceanic-tools."><i class="fa fa-check"></i><b>14.5.1</b> Example: Spatial autocorrelation in Oceanic tools.</a></li>
<li class="chapter" data-level="14.5.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#example-phylogenetic-distance."><i class="fa fa-check"></i><b>14.5.2</b> Example: Phylogenetic distance.</a></li>
</ul></li>
<li class="chapter" data-level="14.6" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#summary-bonus-multilevel-growth-models-and-the-melsm"><i class="fa fa-check"></i><b>14.6</b> <del>Summary</del> Bonus: Multilevel growth models and the MELSM</a><ul>
<li class="chapter" data-level="14.6.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#borrow-some-data."><i class="fa fa-check"></i><b>14.6.1</b> Borrow some data.</a></li>
<li class="chapter" data-level="14.6.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#conventional-multilevel-growth-model."><i class="fa fa-check"></i><b>14.6.2</b> Conventional multilevel growth model.</a></li>
<li class="chapter" data-level="14.6.3" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#learn-more-about-your-data-with-the-melsm."><i class="fa fa-check"></i><b>14.6.3</b> Learn more about your data with the MELSM.</a></li>
<li class="chapter" data-level="14.6.4" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#time-to-go-multivariate."><i class="fa fa-check"></i><b>14.6.4</b> Time to go multivariate.</a></li>
<li class="chapter" data-level="14.6.5" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#growth-modelmelsm-wrap-up."><i class="fa fa-check"></i><b>14.6.5</b> Growth model/MELSM wrap-up.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#session-info-13"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><em>Statistical rethinking</em> with brms, ggplot2, and the tidyverse: Second edition</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="adventures-in-covariance" class="section level1">
<h1><span class="header-section-number">14</span> Adventures in Covariance</h1>
<blockquote>
<p>In this chapter, you’ll see how to… specify <strong>varying slopes</strong> in combination with the varying intercepts of the previous chapter. This will enable pooling that will improve estimates of how different units respond to or are influenced by predictor variables. It will also improve estimates of intercepts, by borrowing information across parameter types. Essentially, varying slopes models are massive interaction machines. They allow every unit in the data to have its own response to any treatment or exposure or event, while also improv- ing estimates via pooling. When the variation in slopes is large, the average slope is of less interest. Sometimes, the pattern of variation in slopes provides hints about omitted variables that explain why some units respond more or less. We’ll see an example in this chapter.</p>
<p>The machinery that makes such complex varying effects possible will be used later in the chapter to extend the varying effects strategy to more subtle model types, including the use of continuous categories, using <strong>Gaussian process</strong>. Ordinary varying effects work only with discrete, unordered categories, such as individuals, countries, or ponds. In these cases, each category is equally different from all of the others. But it is possible to use pooling with categories such as age or location. In these cases, some ages and some locations are more similar than others. You’ll see how to model covariation among continuous categories of this kind, as well as how to generalize the strategy to seemingly unrelated types of models such as phylogenetic and network regressions. Finally, we’ll circle back to causal inference and use our new powers over covariance to go beyond the tools of Chapter 6, introducing <strong>instrumental variables</strong>. Instruments are ways of inferring cause without closing backdoor paths. However they are very tricky both in design and estimation. <span class="citation">(McElreath, <a href="#ref-mcelreathStatisticalRethinkingBayesian2020">2020</a><a href="#ref-mcelreathStatisticalRethinkingBayesian2020">a</a>, pp. 436–437, <strong>emphasis</strong> in the original)</span></p>
</blockquote>
<div id="varying-slopes-by-construction" class="section level2">
<h2><span class="header-section-number">14.1</span> Varying slopes by construction</h2>
<blockquote>
<p>How should the robot pool information across intercepts and slopes? By modeling the joint population of intercepts and slopes, which means by modeling their covariance. In conventional multilevel models, the device that makes this possible is a joint multivariate Gaussian distribution for all of the varying effects, both intercepts and slopes. So instead of having two independent Gaussian distributions of intercepts and of slopes, the robot can do better by assigning a two-dimensional Gaussian distribution to both the intercepts (first dimension) and the slopes (second dimension). (p. 437)</p>
</blockquote>
<div id="rethinking-why-gaussian" class="section level4">
<h4><span class="header-section-number">14.1.0.1</span> Rethinking: Why Gaussian?</h4>
<blockquote>
<p>There is no reason the multivariate distribution of intercepts and slopes must be Gaussian. But there are both practical and epistemological justifications. On the practical side, there aren’t many multivariate distributions that are easy to work with. The only common ones are multivariate Gaussian and multivariate Student-t distributions. On the epistemological side, if all we want to say about these intercepts and slopes is their means, variances, and covariances, then the maximum entropy distribution is multivariate Gaussian. (p. 437)</p>
</blockquote>
<p>As it turns out, <strong>brms</strong> does currently allow users to use the multivariate Student-<span class="math inline">\(t\)</span> distribution in this way. For details, check out <a href="https://github.com/paul-buerkner/brms/issues/231">this discussion from the <strong>brms</strong> GitHub repository</a>. Bürkner’s exemplar syntax from his comment on May 13, 2018, was <code>y ~ x + (x | gr(g, dist = &quot;student&quot;))</code>. I haven’t experimented with this, but if you do, do consider <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/issues">sharing how it went</a>.</p>
</div>
<div id="simulate-the-population." class="section level3">
<h3><span class="header-section-number">14.1.1</span> Simulate the population.</h3>
<p>If you follow this section closely, it’s a great template for simulating multilevel code for any of your future projects. You might think of this as an alternative to a frequentist power analysis. Vourre has done <a href="https://gitlab.com/vuorre/bayesplan">some nice work along these lines</a>, I have a <a href="https://solomonkurz.netlify.com/post/bayesian-power-analysis-part-i/">blog series</a> on Bayesian power analysis, and Kruschke covered the topic in Chapter 13 of his <span class="citation">(<a href="#ref-kruschkeDoingBayesianData2015">2015</a>)</span> <a href="https://sites.google.com/site/doingbayesiandataanalysis/">text</a>.</p>
<div class="sourceCode" id="cb1679"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1679-1" data-line-number="1">a       &lt;-<span class="st">  </span><span class="fl">3.5</span>  <span class="co"># average morning wait time</span></a>
<a class="sourceLine" id="cb1679-2" data-line-number="2">b       &lt;-<span class="st"> </span><span class="dv">-1</span>    <span class="co"># average difference afternoon wait time</span></a>
<a class="sourceLine" id="cb1679-3" data-line-number="3">sigma_a &lt;-<span class="st">  </span><span class="dv">1</span>    <span class="co"># std dev in intercepts</span></a>
<a class="sourceLine" id="cb1679-4" data-line-number="4">sigma_b &lt;-<span class="st">  </span><span class="fl">0.5</span>  <span class="co"># std dev in slopes</span></a>
<a class="sourceLine" id="cb1679-5" data-line-number="5">rho     &lt;-<span class="st"> </span><span class="fl">-.7</span>   <span class="co"># correlation between intercepts and slopes</span></a>
<a class="sourceLine" id="cb1679-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1679-7" data-line-number="7"><span class="co"># the next three lines of code simply combine the terms, above</span></a>
<a class="sourceLine" id="cb1679-8" data-line-number="8">mu     &lt;-<span class="st"> </span><span class="kw">c</span>(a, b)</a>
<a class="sourceLine" id="cb1679-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1679-10" data-line-number="10">cov_ab &lt;-<span class="st"> </span>sigma_a <span class="op">*</span><span class="st"> </span>sigma_b <span class="op">*</span><span class="st"> </span>rho</a>
<a class="sourceLine" id="cb1679-11" data-line-number="11">sigma  &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(sigma_a<span class="op">^</span><span class="dv">2</span>, cov_ab, </a>
<a class="sourceLine" id="cb1679-12" data-line-number="12">                   cov_ab, sigma_b<span class="op">^</span><span class="dv">2</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</a></code></pre></div>
<p>It’s common to refer to a covariance matrix as <span class="math inline">\(\mathbf \Sigma\)</span>. The mathematical notation for those last couple lines of code is</p>
<p><span class="math display">\[
\mathbf \Sigma = \begin{bmatrix} \sigma_\alpha^2 &amp; \sigma_\alpha \sigma_\beta \rho \\ \sigma_\alpha \sigma_\beta \rho &amp; \sigma_\beta^2 \end{bmatrix}.
\]</span></p>
<p>Anyway, if you haven’t used the <code>matirx()</code> function before, you might get a sense of the elements like so.</p>
<div class="sourceCode" id="cb1680"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1680-1" data-line-number="1"><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">nrow =</span> <span class="dv">2</span>, <span class="dt">ncol =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]    1    3
## [2,]    2    4</code></pre>
<p>This next block of code will finally yield our café data.</p>
<div class="sourceCode" id="cb1682"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1682-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1682-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1682-3" data-line-number="3">sigmas &lt;-<span class="st"> </span><span class="kw">c</span>(sigma_a, sigma_b)          <span class="co"># standard deviations</span></a>
<a class="sourceLine" id="cb1682-4" data-line-number="4">rho    &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, rho,             <span class="co"># correlation matrix</span></a>
<a class="sourceLine" id="cb1682-5" data-line-number="5">                   rho, <span class="dv">1</span>), <span class="dt">nrow =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1682-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1682-7" data-line-number="7"><span class="co"># now matrix multiply to get covariance matrix</span></a>
<a class="sourceLine" id="cb1682-8" data-line-number="8">sigma &lt;-<span class="st"> </span><span class="kw">diag</span>(sigmas) <span class="op">%*%</span><span class="st"> </span>rho <span class="op">%*%</span><span class="st"> </span><span class="kw">diag</span>(sigmas)</a>
<a class="sourceLine" id="cb1682-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1682-10" data-line-number="10"><span class="co"># how many cafes would you like?</span></a>
<a class="sourceLine" id="cb1682-11" data-line-number="11">n_cafes &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb1682-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1682-13" data-line-number="13"><span class="kw">set.seed</span>(<span class="dv">5</span>)  <span class="co"># used to replicate example</span></a>
<a class="sourceLine" id="cb1682-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1682-15" data-line-number="15">vary_effects &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1682-16" data-line-number="16"><span class="st">  </span>MASS<span class="op">::</span><span class="kw">mvrnorm</span>(n_cafes, mu, sigma) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1682-17" data-line-number="17"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1682-18" data-line-number="18"><span class="st">  </span><span class="kw">set_names</span>(<span class="st">&quot;a_cafe&quot;</span>, <span class="st">&quot;b_cafe&quot;</span>)</a>
<a class="sourceLine" id="cb1682-19" data-line-number="19"></a>
<a class="sourceLine" id="cb1682-20" data-line-number="20"><span class="kw">head</span>(vary_effects)</a></code></pre></div>
<pre><code>##     a_cafe     b_cafe
## 1 4.223962 -1.6093565
## 2 2.010498 -0.7517704
## 3 4.565811 -1.9482646
## 4 3.343635 -1.1926539
## 5 1.700971 -0.5855618
## 6 4.134373 -1.1444539</code></pre>
<p>Let’s make sure we’re keeping this all straight. <code>a_cafe</code> = our café-specific intercepts; <code>b_cafe</code> = our café-specific slopes. These aren’t the actual data, yet. But at this stage, it might make sense to ask <em>What’s the distribution of <code>a_cafe</code> and <code>b_cafe</code>?</em> Our variant of Figure 14.2 contains the answer.</p>
<p>For our plots in this chapter, we’ll make our own custom <strong>ggplot2</strong> theme. The color palette will come from the “pearl_earring” palette of the <a href="https://github.com/EdwinTh/dutchmasters"><strong>dutchmasters</strong> package</a> <span class="citation">(Thoen, <a href="#ref-R-dutchmasters">2019</a>)</span>. You can learn more about the original painting, Vermeer’s <span class="citation">(<a href="#ref-vermeerGirlPearlEarring1665">1665</a>)</span> <em>Girl with a Pearl Earring</em>, <a href="https://en.wikipedia.org/wiki/Girl_with_a_Pearl_Earring">here</a>.</p>
<div class="sourceCode" id="cb1684"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1684-1" data-line-number="1"><span class="co"># devtools::install_github(&quot;EdwinTh/dutchmasters&quot;)</span></a>
<a class="sourceLine" id="cb1684-2" data-line-number="2"><span class="kw">library</span>(dutchmasters)</a>
<a class="sourceLine" id="cb1684-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1684-4" data-line-number="4">dutchmasters<span class="op">$</span>pearl_earring</a></code></pre></div>
<pre><code>##         red(lips)              skin      blue(scarf1)      blue(scarf2)      white(colar)       gold(dress) 
##         &quot;#A65141&quot;         &quot;#E7CDC2&quot;         &quot;#80A0C7&quot;         &quot;#394165&quot;         &quot;#FCF9F0&quot;         &quot;#B1934A&quot; 
##      gold(dress2) black(background)      grey(scarf3)    yellow(scarf4)                   
##         &quot;#DCA258&quot;         &quot;#100F14&quot;         &quot;#8B9DAF&quot;         &quot;#EEDA9D&quot;         &quot;#E8DCCF&quot;</code></pre>
<div class="sourceCode" id="cb1686"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1686-1" data-line-number="1">scales<span class="op">::</span><span class="kw">show_col</span>(dutchmasters<span class="op">$</span>pearl_earring)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-5-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>We’ll name our custom theme <code>theme_pearl_earring()</code>. I cobbled together this approach to defining a custom <strong>ggplot2</strong> theme with help from</p>
<ul>
<li><a href="https://ggplot2-book.org/programming.html">Chapter 17</a> of Wichkam’s <span class="citation">(<a href="#ref-wickhamGgplot2ElegantGraphics2016">2016</a>)</span> <em>ggplot2: Elegant graphics for data analysis</em>;</li>
<li><a href="https://bookdown.org/rdpeng/RProgDA/building-a-new-theme.html">Section 4.6</a> of Peng, Kross, and Anderson’s <span class="citation">(<a href="#ref-pengMasteringSoftwareDevelopment2017">2017</a>)</span> <a href="https://bookdown.org/rdpeng/RProgDA/building-a-new-theme.html"><em>Mastering Software Development in R</em></a>;</li>
<li>Lea Waniek’s blog post, <a href="https://www.statworx.com/de/blog/custom-themes-in-ggplot2/"><em>Custom themes in ggplot2</em></a>, and</li>
<li>Joey Stanley’s blog post of the same name, <a href="https://joeystanley.com/blog/custom-themes-in-ggplot2"><em>Custom themes in ggplot2</em></a>.</li>
</ul>
<div class="sourceCode" id="cb1687"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1687-1" data-line-number="1">theme_pearl_earring &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">light_color =</span> <span class="st">&quot;#E8DCCF&quot;</span>, </a>
<a class="sourceLine" id="cb1687-2" data-line-number="2">                                <span class="dt">dark_color =</span> <span class="st">&quot;#100F14&quot;</span>, </a>
<a class="sourceLine" id="cb1687-3" data-line-number="3">                                <span class="dt">my_family =</span> <span class="st">&quot;Courier&quot;</span>,</a>
<a class="sourceLine" id="cb1687-4" data-line-number="4">                                ...) {</a>
<a class="sourceLine" id="cb1687-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb1687-6" data-line-number="6">  <span class="kw">theme</span>(<span class="dt">line =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> light_color),</a>
<a class="sourceLine" id="cb1687-7" data-line-number="7">        <span class="dt">text =</span> <span class="kw">element_text</span>(<span class="dt">color =</span> light_color, <span class="dt">family =</span> my_family),</a>
<a class="sourceLine" id="cb1687-8" data-line-number="8">        <span class="dt">strip.text =</span> <span class="kw">element_text</span>(<span class="dt">color =</span> light_color, <span class="dt">family =</span> my_family),</a>
<a class="sourceLine" id="cb1687-9" data-line-number="9">        <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">color =</span> light_color),</a>
<a class="sourceLine" id="cb1687-10" data-line-number="10">        <span class="dt">axis.ticks =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> light_color),</a>
<a class="sourceLine" id="cb1687-11" data-line-number="11">        <span class="dt">axis.line =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1687-12" data-line-number="12">        <span class="dt">legend.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> dark_color, <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>),</a>
<a class="sourceLine" id="cb1687-13" data-line-number="13">        <span class="dt">legend.key =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> dark_color, <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>),</a>
<a class="sourceLine" id="cb1687-14" data-line-number="14">        <span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> dark_color, <span class="dt">color =</span> light_color),</a>
<a class="sourceLine" id="cb1687-15" data-line-number="15">        <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1687-16" data-line-number="16">        <span class="dt">plot.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> dark_color, <span class="dt">color =</span> dark_color),</a>
<a class="sourceLine" id="cb1687-17" data-line-number="17">        <span class="dt">strip.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> dark_color, <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>),</a>
<a class="sourceLine" id="cb1687-18" data-line-number="18">        ...)</a>
<a class="sourceLine" id="cb1687-19" data-line-number="19">  </a>
<a class="sourceLine" id="cb1687-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb1687-21" data-line-number="21"></a>
<a class="sourceLine" id="cb1687-22" data-line-number="22"><span class="co"># now set `theme_pearl_earring()` as the default theme</span></a>
<a class="sourceLine" id="cb1687-23" data-line-number="23"><span class="kw">theme_set</span>(<span class="kw">theme_pearl_earring</span>())</a></code></pre></div>
<p>Note how our custom <code>theme_pearl_earing()</code> function has a few adjustable parameters. Feel free to play around with alternative settings to see how they work. If we just use the defaults as we have defined them, here is our Figure 14.2.</p>
<div class="sourceCode" id="cb1688"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1688-1" data-line-number="1">vary_effects <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1688-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> a_cafe, <span class="dt">y =</span> b_cafe)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1688-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1688-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_rug</span>(<span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">7</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-7-1.png" width="312" style="display: block; margin: auto;" /></p>
<p>Again, these are not “data.” Figure 14.2 shows a distribution of <em>parameters</em>. Here’s their Pearson’s correlation coefficient.</p>
<div class="sourceCode" id="cb1689"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1689-1" data-line-number="1"><span class="kw">cor</span>(vary_effects<span class="op">$</span>a_cafe, vary_effects<span class="op">$</span>b_cafe)</a></code></pre></div>
<pre><code>## [1] -0.5721537</code></pre>
<p>Since there are only 20 rows in our <code>vary_effects</code> simulation, it shouldn’t be a surprise that the Pearson’s correlation is a bit off from the population value of <span class="math inline">\(\rho = -.7\)</span>. If you rerun the simulation with <code>n_cafes &lt;- 200</code>, the Pearson’s correlation is much closer to the data generating value.</p>
</div>
<div id="simulate-observations." class="section level3">
<h3><span class="header-section-number">14.1.2</span> Simulate observations.</h3>
<p>Here we put those simulated parameters to use and simulate actual data from them.</p>
<div class="sourceCode" id="cb1691"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1691-1" data-line-number="1">n_visits &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb1691-2" data-line-number="2">sigma    &lt;-<span class="st">  </span><span class="fl">0.5</span>  <span class="co"># std dev within cafes</span></a>
<a class="sourceLine" id="cb1691-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1691-4" data-line-number="4"><span class="kw">set.seed</span>(<span class="dv">22</span>)  <span class="co"># used to replicate example</span></a>
<a class="sourceLine" id="cb1691-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1691-6" data-line-number="6">d &lt;-</a>
<a class="sourceLine" id="cb1691-7" data-line-number="7"><span class="st">  </span>vary_effects <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1691-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cafe =</span> <span class="dv">1</span><span class="op">:</span>n_cafes) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1691-9" data-line-number="9"><span class="st">  </span><span class="kw">expand</span>(<span class="kw">nesting</span>(cafe, a_cafe, b_cafe), <span class="dt">visit =</span> <span class="dv">1</span><span class="op">:</span>n_visits) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1691-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">afternoon =</span> <span class="kw">rep</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">times =</span> <span class="kw">n</span>() <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1691-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">mu =</span> a_cafe <span class="op">+</span><span class="st"> </span>b_cafe <span class="op">*</span><span class="st"> </span>afternoon) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1691-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">wait =</span> <span class="kw">rnorm</span>(<span class="dt">n =</span> <span class="kw">n</span>(), <span class="dt">mean =</span> mu, <span class="dt">sd =</span> sigma))</a></code></pre></div>
<p>We might peek at the data.</p>
<div class="sourceCode" id="cb1692"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1692-1" data-line-number="1">d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1692-2" data-line-number="2"><span class="st">  </span><span class="kw">glimpse</span>()</a></code></pre></div>
<pre><code>## Rows: 200
## Columns: 7
## $ cafe      &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,…
## $ a_cafe    &lt;dbl&gt; 4.223962, 4.223962, 4.223962, 4.223962, 4.223962, 4.223962, 4.223962, 4.223962, 4.223962,…
## $ b_cafe    &lt;dbl&gt; -1.6093565, -1.6093565, -1.6093565, -1.6093565, -1.6093565, -1.6093565, -1.6093565, -1.60…
## $ visit     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, …
## $ afternoon &lt;int&gt; 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,…
## $ mu        &lt;dbl&gt; 4.223962, 2.614606, 4.223962, 2.614606, 4.223962, 2.614606, 4.223962, 2.614606, 4.223962,…
## $ wait      &lt;dbl&gt; 3.9678929, 3.8571978, 4.7278755, 2.7610133, 4.1194827, 3.5436522, 4.1909492, 2.5332235, 4…</code></pre>
<p>Now we’ve finally simulated our data, we are ready to make our version of Figure 14.1, from way back on page 436.</p>
<div class="sourceCode" id="cb1694"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1694-1" data-line-number="1">d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1694-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">afternoon =</span> <span class="kw">ifelse</span>(afternoon <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;M&quot;</span>, <span class="st">&quot;A&quot;</span>),</a>
<a class="sourceLine" id="cb1694-3" data-line-number="3">         <span class="dt">day       =</span> <span class="kw">rep</span>(<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">each =</span> <span class="dv">2</span>), <span class="dt">times =</span> n_cafes)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1694-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(cafe <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">5</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1694-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cafe =</span> <span class="kw">str_c</span>(<span class="st">&quot;café #&quot;</span>, cafe)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1694-6" data-line-number="6"><span class="st">  </span></a>
<a class="sourceLine" id="cb1694-7" data-line-number="7"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> visit, <span class="dt">y =</span> wait, <span class="dt">group =</span> day)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1694-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> afternoon), <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1694-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1694-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#EEDA9D&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1694-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">labels =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;M&quot;</span>, <span class="st">&quot;A&quot;</span>), <span class="dt">times =</span> <span class="dv">5</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1694-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;wait time in minutes&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="ot">NA</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1694-13" data-line-number="13"><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>,</a>
<a class="sourceLine" id="cb1694-14" data-line-number="14">                      <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb1694-15" data-line-number="15"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>cafe, <span class="dt">ncol =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-11-1.png" width="336" style="display: block; margin: auto;" /></p>
<div id="rethinking-simulation-and-misspecification." class="section level4">
<h4><span class="header-section-number">14.1.2.1</span> Rethinking: Simulation and misspecification.</h4>
<blockquote>
<p>In this exercise, we are simulating data from a generative process and then analyzing that data with a model that reflects exactly the correct structure of that process. But in the real world, we’re never so lucky. Instead we are always forced to analyze data with a model that is misspecified: The true data-generating process is different than the model. Simulation can be used however to explore misspecification. Just simulate data from a process and then see how a number of models, none of which match exactly the data-generating process, perform. And always remember that Bayesian inference does not depend upon data-generating assumptions, such as the likelihood, being true. (p. 441)</p>
</blockquote>
</div>
</div>
<div id="the-varying-slopes-model." class="section level3">
<h3><span class="header-section-number">14.1.3</span> The varying slopes model.</h3>
<p>The statistical formula for our varying intercepts and slopes café model follows the form</p>
<p><span class="math display">\[\begin{align*}
\text{wait}_i &amp; \sim \operatorname{Normal}(\mu_i, \sigma) \\
\mu_i         &amp; = \alpha_{\text{café}[i]} + \beta_{\text{café}[i]} \text{afternoon}_i \\
\begin{bmatrix} \alpha_\text{café} \\ \beta_\text{café} \end{bmatrix} &amp; \sim \operatorname{MVNormal} \begin{pmatrix} \begin{bmatrix} \alpha \\ \beta \end{bmatrix}, \mathbf{S} \end{pmatrix} \\
\mathbf S     &amp; = \begin{bmatrix} \sigma_\alpha &amp; 0 \\ 0 &amp; \sigma_\beta \end{bmatrix} \mathbf R \begin{bmatrix} \sigma_\alpha &amp; 0 \\ 0 &amp; \sigma_\beta \end{bmatrix} \\
\alpha        &amp; \sim \operatorname{Normal}(5, 2) \\
\beta         &amp; \sim \operatorname{Normal}(-1, 0.5) \\
\sigma        &amp; \sim \operatorname{Exponential}(1) \\
\sigma_\alpha &amp; \sim \operatorname{Exponential}(1) \\
\sigma_\beta  &amp; \sim \operatorname{Exponential}(1) \\
\mathbf R     &amp; \sim \operatorname{LKJcorr}(2),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\mathbf S\)</span> is the covariance matrix and <span class="math inline">\(\mathbf R\)</span> is the corresponding correlation matrix, which we might more fully express as</p>
<p><span class="math display">\[\mathbf R = \begin{bmatrix} 1 &amp; \rho \\ \rho &amp; 1 \end{bmatrix}.\]</span></p>
<p>And according to our prior, <span class="math inline">\(\mathbf R\)</span> is distributed as <span class="math inline">\(\operatorname{LKJcorr}(2)\)</span>. We’ll use <code>rethinking::rlkjcorr()</code> to get a better sense of what that even is.</p>
<div class="sourceCode" id="cb1695"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1695-1" data-line-number="1"><span class="kw">library</span>(rethinking)</a>
<a class="sourceLine" id="cb1695-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1695-3" data-line-number="3">n_sim &lt;-<span class="st"> </span><span class="fl">1e4</span></a>
<a class="sourceLine" id="cb1695-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1695-5" data-line-number="5"><span class="kw">set.seed</span>(<span class="dv">14</span>)</a>
<a class="sourceLine" id="cb1695-6" data-line-number="6">r_<span class="dv">1</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1695-7" data-line-number="7"><span class="st">  </span><span class="kw">rlkjcorr</span>(n_sim, <span class="dt">K =</span> <span class="dv">2</span>, <span class="dt">eta =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1695-8" data-line-number="8"><span class="st">  </span><span class="kw">as_tibble</span>()</a>
<a class="sourceLine" id="cb1695-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1695-10" data-line-number="10"><span class="kw">set.seed</span>(<span class="dv">14</span>)</a>
<a class="sourceLine" id="cb1695-11" data-line-number="11">r_<span class="dv">2</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1695-12" data-line-number="12"><span class="st">  </span><span class="kw">rlkjcorr</span>(n_sim, <span class="dt">K =</span> <span class="dv">2</span>, <span class="dt">eta =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1695-13" data-line-number="13"><span class="st">  </span><span class="kw">as_tibble</span>()</a>
<a class="sourceLine" id="cb1695-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1695-15" data-line-number="15"><span class="kw">set.seed</span>(<span class="dv">14</span>)</a>
<a class="sourceLine" id="cb1695-16" data-line-number="16">r_<span class="dv">4</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1695-17" data-line-number="17"><span class="st">  </span><span class="kw">rlkjcorr</span>(n_sim, <span class="dt">K =</span> <span class="dv">2</span>, <span class="dt">eta =</span> <span class="dv">4</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1695-18" data-line-number="18"><span class="st">  </span><span class="kw">as_tibble</span>()</a></code></pre></div>
<p>Here are the <span class="math inline">\(\text{LKJcorr}\)</span> distributions of Figure 14.3.</p>
<div class="sourceCode" id="cb1696"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1696-1" data-line-number="1"><span class="co"># for annotation</span></a>
<a class="sourceLine" id="cb1696-2" data-line-number="2">text &lt;-</a>
<a class="sourceLine" id="cb1696-3" data-line-number="3"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">x     =</span> <span class="kw">c</span>(.<span class="dv">83</span>, <span class="fl">.625</span>, <span class="fl">.45</span>),</a>
<a class="sourceLine" id="cb1696-4" data-line-number="4">         <span class="dt">y     =</span> <span class="kw">c</span>(.<span class="dv">56</span>, <span class="fl">.75</span>, <span class="fl">1.05</span>),</a>
<a class="sourceLine" id="cb1696-5" data-line-number="5">         <span class="dt">label =</span> <span class="kw">c</span>(<span class="st">&quot;eta = 1&quot;</span>, <span class="st">&quot;eta = 2&quot;</span>, <span class="st">&quot;eta = 4&quot;</span>))</a>
<a class="sourceLine" id="cb1696-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1696-7" data-line-number="7"><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1696-8" data-line-number="8">r_<span class="dv">1</span> <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1696-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> V2)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1696-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#394165&quot;</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">adjust =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1696-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">data =</span> r_<span class="dv">2</span>,</a>
<a class="sourceLine" id="cb1696-12" data-line-number="12">               <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#DCA258&quot;</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">adjust =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1696-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">data =</span> r_<span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1696-14" data-line-number="14">               <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">adjust =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1696-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> text,</a>
<a class="sourceLine" id="cb1696-16" data-line-number="16">            <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">label =</span> label),</a>
<a class="sourceLine" id="cb1696-17" data-line-number="17">            <span class="dt">color =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1696-18" data-line-number="18"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1696-19" data-line-number="19"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">LKJcorr</span>(eta)),</a>
<a class="sourceLine" id="cb1696-20" data-line-number="20">       <span class="dt">x =</span> <span class="st">&quot;correlation&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-13-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>As it turns out, the shape of the LKJ is sensitive to both <span class="math inline">\(\eta\)</span> and the <span class="math inline">\(K\)</span> dimensions of the correlation matrix. Our simulations only considered the shapes for when <span class="math inline">\(K = 2\)</span>. We can use a combination of the <code>parse_dist()</code> and <code>stat_dist_halfeye()</code> functions from the <strong>tidybayes</strong> package to derive analytic solutions for different combinations of <span class="math inline">\(\eta\)</span> and <span class="math inline">\(K\)</span>.</p>
<div class="sourceCode" id="cb1697"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1697-1" data-line-number="1"><span class="kw">library</span>(tidybayes)</a>
<a class="sourceLine" id="cb1697-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1697-3" data-line-number="3"><span class="kw">crossing</span>(<span class="dt">k   =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">5</span>,</a>
<a class="sourceLine" id="cb1697-4" data-line-number="4">         <span class="dt">eta =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1697-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prior =</span> <span class="kw">str_c</span>(<span class="st">&quot;lkjcorr_marginal(&quot;</span>, k, <span class="st">&quot;, &quot;</span>, eta, <span class="st">&quot;)&quot;</span>),</a>
<a class="sourceLine" id="cb1697-6" data-line-number="6">         <span class="dt">strip =</span> <span class="kw">str_c</span>(<span class="st">&quot;K==&quot;</span>, k)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1697-7" data-line-number="7"><span class="st">  </span><span class="kw">parse_dist</span>(prior) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1697-8" data-line-number="8"><span class="st">  </span></a>
<a class="sourceLine" id="cb1697-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> eta, <span class="dt">dist =</span> .dist, <span class="dt">args =</span> .args)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1697-10" data-line-number="10"><span class="st">  </span><span class="kw">stat_dist_halfeye</span>(<span class="dt">.width =</span> <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">.95</span>),</a>
<a class="sourceLine" id="cb1697-11" data-line-number="11">                    <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#A65141&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1697-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(rho), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1697-13" data-line-number="13">                     <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="fl">-.5</span>, <span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>), <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;-1&quot;</span>, <span class="st">&quot;-.5&quot;</span>, <span class="st">&quot;0&quot;</span>, <span class="st">&quot;.5&quot;</span>, <span class="st">&quot;1&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1697-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="kw">expression</span>(eta), <span class="dt">breaks =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1697-15" data-line-number="15"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="kw">expression</span>(<span class="st">&quot;Marginal correlation for the LKJ prior relative to K and &quot;</span><span class="op">*</span>eta)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1697-16" data-line-number="16"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>strip, <span class="dt">labeller =</span> label_parsed, <span class="dt">ncol =</span> <span class="dv">4</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-14-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>To learn more about this method, check out Kay’s <span class="citation">(<a href="#ref-kayMarginalDistributionSingle2020">2020</a><a href="#ref-kayMarginalDistributionSingle2020">b</a>)</span> <a href="https://mjskay.github.io/ggdist/reference/lkjcorr_marginal.html"><em>Marginal distribution of a single correlation from an LKJ distribution</em></a>.</p>
<p>Okay, let’s get ready to model and switch out <strong>rethinking</strong> for <strong>brms</strong>.</p>
<div class="sourceCode" id="cb1698"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1698-1" data-line-number="1"><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</a>
<a class="sourceLine" id="cb1698-2" data-line-number="2"><span class="kw">library</span>(brms)</a></code></pre></div>
<p>As defined above, our first model has both varying intercepts and <code>afternoon</code> slopes. I should point out that the <code>(1 + afternoon | cafe)</code> syntax specifies that we’d like <code>brm()</code> to fit the random effects for <code>1</code> (i.e., the intercept) and the <code>afternoon</code> slope as correlated. Had we wanted to fit a model in which they were orthogonal, we’d have coded <code>(1 + afternoon || cafe)</code>.</p>
<div class="sourceCode" id="cb1699"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1699-1" data-line-number="1"> b14<span class="fl">.1</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1699-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1699-3" data-line-number="3">      <span class="dt">family =</span> gaussian,</a>
<a class="sourceLine" id="cb1699-4" data-line-number="4">      wait <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>afternoon <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>afternoon <span class="op">|</span><span class="st"> </span>cafe),</a>
<a class="sourceLine" id="cb1699-5" data-line-number="5">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">5</span>, <span class="dv">2</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1699-6" data-line-number="6">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="op">-</span><span class="dv">1</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b),</a>
<a class="sourceLine" id="cb1699-7" data-line-number="7">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd),</a>
<a class="sourceLine" id="cb1699-8" data-line-number="8">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sigma),</a>
<a class="sourceLine" id="cb1699-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">2</span>), <span class="dt">class =</span> cor)),</a>
<a class="sourceLine" id="cb1699-10" data-line-number="10">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1699-11" data-line-number="11">      <span class="dt">seed =</span> <span class="dv">867530</span>,</a>
<a class="sourceLine" id="cb1699-12" data-line-number="12">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.01&quot;</span>)</a></code></pre></div>
<p>With Figure 14.4, we assess how the posterior for the correlation of the random effects compares to its prior.</p>
<div class="sourceCode" id="cb1700"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1700-1" data-line-number="1">post &lt;-<span class="st"> </span><span class="kw">posterior_samples</span>(b14<span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb1700-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1700-3" data-line-number="3">post <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1700-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb1700-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">data =</span> r_<span class="dv">2</span>, <span class="kw">aes</span>(<span class="dt">x =</span> V2),</a>
<a class="sourceLine" id="cb1700-6" data-line-number="6">               <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#EEDA9D&quot;</span>, <span class="dt">alpha =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1700-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="dt">x =</span> cor_cafe__Intercept__afternoon),</a>
<a class="sourceLine" id="cb1700-8" data-line-number="8">               <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">alpha =</span> <span class="dv">9</span><span class="op">/</span><span class="dv">10</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1700-9" data-line-number="9"><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="fl">-0.15</span>, <span class="dt">y =</span> <span class="fl">2.275</span>, </a>
<a class="sourceLine" id="cb1700-10" data-line-number="10">           <span class="dt">label =</span> <span class="st">&quot;posterior&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1700-11" data-line-number="11"><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="dv">0</span>, <span class="dt">y =</span> <span class="fl">0.85</span>, </a>
<a class="sourceLine" id="cb1700-12" data-line-number="12">           <span class="dt">label =</span> <span class="st">&quot;prior&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1700-13" data-line-number="13"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1700-14" data-line-number="14"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Correlation between intercepts</span><span class="ch">\n</span><span class="st">and slopes, prior and posterior&quot;</span>,</a>
<a class="sourceLine" id="cb1700-15" data-line-number="15">  <span class="dt">x =</span> <span class="st">&quot;correlation&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-16-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>McElreath then depicted multidimensional shrinkage by plotting the posterior mean of the varying effects compared to their raw, unpooled estimated. With <strong>brms</strong>, we can get the <code>cafe</code>-specific intercepts and <code>afternoon</code> slopes with <code>coef()</code>, which returns a three-dimensional list.</p>
<div class="sourceCode" id="cb1701"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1701-1" data-line-number="1"><span class="co"># coef(b14.1) %&gt;% glimpse()</span></a>
<a class="sourceLine" id="cb1701-2" data-line-number="2"><span class="kw">coef</span>(b14<span class="fl">.1</span>)</a></code></pre></div>
<pre><code>## $cafe
## , , Intercept
## 
##    Estimate Est.Error     Q2.5    Q97.5
## 1  4.217447 0.2018019 3.824741 4.610678
## 2  2.157117 0.2023030 1.752369 2.554617
## 3  4.374876 0.2055618 3.969601 4.770744
## 4  3.247926 0.1974200 2.859321 3.623184
## 5  1.876235 0.1987167 1.486781 2.258197
## 6  4.263969 0.2049154 3.856609 4.675718
## 7  3.612005 0.1947422 3.229293 3.998222
## 8  3.947382 0.1989205 3.555953 4.345577
## 9  3.986117 0.1973238 3.598177 4.367915
## 10 3.561080 0.1994722 3.187764 3.954724
## 11 1.930770 0.2012895 1.532160 2.332417
## 12 3.842972 0.1981214 3.454764 4.226797
## 13 3.881033 0.2005934 3.484184 4.253935
## 14 3.173598 0.1989779 2.777426 3.561954
## 15 4.455068 0.2068003 4.044761 4.861744
## 16 3.388183 0.2032259 2.992205 3.785476
## 17 4.214856 0.1958688 3.829784 4.595347
## 18 5.746429 0.2031975 5.339666 6.131445
## 19 3.242601 0.2074594 2.832662 3.648870
## 20 3.739702 0.1991852 3.355478 4.140396
## 
## , , afternoon
## 
##      Estimate Est.Error       Q2.5       Q97.5
## 1  -1.1564079 0.2611610 -1.6767645 -0.65013377
## 2  -0.9076589 0.2694590 -1.4638938 -0.38975992
## 3  -1.9373011 0.2785979 -2.4700939 -1.38910869
## 4  -1.2396792 0.2628824 -1.7576545 -0.71588756
## 5  -0.1331505 0.2790300 -0.6664555  0.41253932
## 6  -1.3015290 0.2737102 -1.8296546 -0.75805762
## 7  -1.0199397 0.2568145 -1.5313213 -0.52430180
## 8  -1.6364944 0.2687794 -2.1668908 -1.12748662
## 9  -1.3101210 0.2623046 -1.8215215 -0.79761190
## 10 -0.9470151 0.2602688 -1.4644125 -0.43085249
## 11 -0.4317661 0.2742758 -0.9794932  0.09951761
## 12 -1.1893695 0.2610251 -1.6903426 -0.66509228
## 13 -1.8127721 0.2678092 -2.3502321 -1.30977936
## 14 -0.9425814 0.2610761 -1.4714922 -0.42861871
## 15 -2.1954867 0.2854975 -2.7748484 -1.65267872
## 16 -1.0392753 0.2712236 -1.5678736 -0.51128431
## 17 -1.2228926 0.2653407 -1.7500057 -0.71077267
## 18 -1.0166955 0.2769046 -1.5612484 -0.47911096
## 19 -0.2510217 0.2787934 -0.7963454  0.32858114
## 20 -1.0668519 0.2665278 -1.5984522 -0.55614157</code></pre>
<p>Here’s the code to extract the relevant elements from the <code>coef()</code> list, convert them to a tibble, and add the <code>cafe</code> index.</p>
<div class="sourceCode" id="cb1703"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1703-1" data-line-number="1">partially_pooled_params &lt;-</a>
<a class="sourceLine" id="cb1703-2" data-line-number="2"><span class="st">  </span><span class="co"># with this line we select each of the 20 cafe&#39;s posterior mean (i.e., Estimate)</span></a>
<a class="sourceLine" id="cb1703-3" data-line-number="3"><span class="st">  </span><span class="co"># for both `Intercept` and `afternoon`</span></a>
<a class="sourceLine" id="cb1703-4" data-line-number="4"><span class="st">  </span><span class="kw">coef</span>(b14<span class="fl">.1</span>)<span class="op">$</span>cafe[ , <span class="dv">1</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1703-5" data-line-number="5"><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st">               </span><span class="co"># convert the two vectors to a tibble</span></a>
<a class="sourceLine" id="cb1703-6" data-line-number="6"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Slope =</span> afternoon) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1703-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cafe =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(.)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># add the `cafe` index</span></a>
<a class="sourceLine" id="cb1703-8" data-line-number="8"><span class="st">  </span><span class="kw">select</span>(cafe, <span class="kw">everything</span>())    <span class="co"># simply moving `cafe` to the leftmost position</span></a></code></pre></div>
<p>Like McElreath, we’ll compute the unpooled estimates directly from the data.</p>
<div class="sourceCode" id="cb1704"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1704-1" data-line-number="1"><span class="co"># compute unpooled estimates directly from data</span></a>
<a class="sourceLine" id="cb1704-2" data-line-number="2">un_pooled_params &lt;-</a>
<a class="sourceLine" id="cb1704-3" data-line-number="3"><span class="st">  </span>d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1704-4" data-line-number="4"><span class="st">  </span><span class="co"># with these two lines, we compute the mean value for each cafe&#39;s wait time </span></a>
<a class="sourceLine" id="cb1704-5" data-line-number="5"><span class="st">  </span><span class="co"># in the morning and then the afternoon</span></a>
<a class="sourceLine" id="cb1704-6" data-line-number="6"><span class="st">  </span><span class="kw">group_by</span>(afternoon, cafe) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1704-7" data-line-number="7"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(wait)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1704-8" data-line-number="8"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># ungrouping allows us to alter afternoon, one of the grouping variables</span></a>
<a class="sourceLine" id="cb1704-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">afternoon =</span> <span class="kw">ifelse</span>(afternoon <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;Intercept&quot;</span>, <span class="st">&quot;Slope&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1704-10" data-line-number="10"><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> afternoon, <span class="dt">value =</span> mean) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># use `spread()` just as in the previous block</span></a>
<a class="sourceLine" id="cb1704-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Slope =</span> Slope <span class="op">-</span><span class="st"> </span>Intercept)          <span class="co"># finally, here&#39;s our slope!</span></a>
<a class="sourceLine" id="cb1704-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1704-13" data-line-number="13"><span class="co"># here we combine the partially-pooled and unpooled means into a single data object, </span></a>
<a class="sourceLine" id="cb1704-14" data-line-number="14"><span class="co"># which will make plotting easier.</span></a>
<a class="sourceLine" id="cb1704-15" data-line-number="15">params &lt;-</a>
<a class="sourceLine" id="cb1704-16" data-line-number="16"><span class="st">  </span><span class="co"># `bind_rows()` will stack the second tibble below the first</span></a>
<a class="sourceLine" id="cb1704-17" data-line-number="17"><span class="st">  </span><span class="kw">bind_rows</span>(partially_pooled_params, un_pooled_params) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1704-18" data-line-number="18"><span class="st">  </span><span class="co"># index whether the estimates are pooled</span></a>
<a class="sourceLine" id="cb1704-19" data-line-number="19"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pooled =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;partially&quot;</span>, <span class="st">&quot;not&quot;</span>), <span class="dt">each =</span> <span class="kw">nrow</span>(.)<span class="op">/</span><span class="dv">2</span>)) </a>
<a class="sourceLine" id="cb1704-20" data-line-number="20"></a>
<a class="sourceLine" id="cb1704-21" data-line-number="21"><span class="co"># here&#39;s a glimpse at what we&#39;ve been working for</span></a>
<a class="sourceLine" id="cb1704-22" data-line-number="22">params <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1704-23" data-line-number="23"><span class="st">  </span><span class="kw">slice</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">36</span><span class="op">:</span><span class="dv">40</span>))</a></code></pre></div>
<pre><code>## # A tibble: 10 x 4
##     cafe Intercept   Slope pooled   
##    &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;    
##  1     1      4.22 -1.16   partially
##  2     2      2.16 -0.908  partially
##  3     3      4.37 -1.94   partially
##  4     4      3.25 -1.24   partially
##  5     5      1.88 -0.133  partially
##  6    16      3.37 -1.03   not      
##  7    17      4.24 -1.22   not      
##  8    18      5.76 -0.877  not      
##  9    19      3.12  0.0144 not      
## 10    20      3.73 -1.04   not</code></pre>
<p>Finally, here’s our code for Figure 14.5.a, showing shrinkage in two dimensions.</p>
<div class="sourceCode" id="cb1706"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1706-1" data-line-number="1">p1 &lt;-</a>
<a class="sourceLine" id="cb1706-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">data =</span> params, <span class="kw">aes</span>(<span class="dt">x =</span> Intercept, <span class="dt">y =</span> Slope)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-3" data-line-number="3"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-4" data-line-number="4"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-5" data-line-number="5"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-6" data-line-number="6"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">4</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-7" data-line-number="7"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">5</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-8" data-line-number="8"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">6</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-9" data-line-number="9"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">7</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-10" data-line-number="10"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">8</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-11" data-line-number="11"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">9</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-12" data-line-number="12"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="fl">.99</span>,  <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">group =</span> cafe, <span class="dt">color =</span> pooled)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> cafe), <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="st">&quot;Pooled?&quot;</span>,</a>
<a class="sourceLine" id="cb1706-16" data-line-number="16">                     <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1706-17" data-line-number="17"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(params<span class="op">$</span>Intercept),</a>
<a class="sourceLine" id="cb1706-18" data-line-number="18">                  <span class="dt">ylim =</span> <span class="kw">range</span>(params<span class="op">$</span>Slope))</a>
<a class="sourceLine" id="cb1706-19" data-line-number="19">p1</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-20-1.png" width="480" style="display: block; margin: auto;" /></p>
<p>Learn more about <code>stat_ellipse()</code>, <a href="https://ggplot2.tidyverse.org/reference/stat_ellipse.html">here</a>. Let’s prep for Figure 14.5.b.</p>
<div class="sourceCode" id="cb1707"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1707-1" data-line-number="1"><span class="co"># retrieve the partially-pooled estimates with `coef()`</span></a>
<a class="sourceLine" id="cb1707-2" data-line-number="2">partially_pooled_estimates &lt;-</a>
<a class="sourceLine" id="cb1707-3" data-line-number="3"><span class="st">  </span><span class="kw">coef</span>(b14<span class="fl">.1</span>)<span class="op">$</span>cafe[ , <span class="dv">1</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1707-4" data-line-number="4"><span class="st">  </span><span class="co"># convert the two vectors to a tibble</span></a>
<a class="sourceLine" id="cb1707-5" data-line-number="5"><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1707-6" data-line-number="6"><span class="st">  </span><span class="co"># the Intercept is the wait time for morning (i.e., `afternoon == 0`)</span></a>
<a class="sourceLine" id="cb1707-7" data-line-number="7"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">morning =</span> Intercept) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1707-8" data-line-number="8"><span class="st">  </span><span class="co"># `afternoon` wait time is the `morning` wait time plus the afternoon slope</span></a>
<a class="sourceLine" id="cb1707-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">afternoon =</span> morning <span class="op">+</span><span class="st"> </span>afternoon,</a>
<a class="sourceLine" id="cb1707-10" data-line-number="10">         <span class="dt">cafe      =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># add the `cafe` index</span></a>
<a class="sourceLine" id="cb1707-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(cafe, <span class="kw">everything</span>()) </a>
<a class="sourceLine" id="cb1707-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1707-13" data-line-number="13"><span class="co"># compute unpooled estimates directly from data</span></a>
<a class="sourceLine" id="cb1707-14" data-line-number="14">un_pooled_estimates &lt;-</a>
<a class="sourceLine" id="cb1707-15" data-line-number="15"><span class="st">  </span>d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1707-16" data-line-number="16"><span class="st">  </span><span class="co"># as above, with these two lines, we compute each cafe&#39;s mean wait value by time of day</span></a>
<a class="sourceLine" id="cb1707-17" data-line-number="17"><span class="st">  </span><span class="kw">group_by</span>(afternoon, cafe) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1707-18" data-line-number="18"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(wait)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1707-19" data-line-number="19"><span class="st">  </span><span class="co"># ungrouping allows us to alter the grouping variable, afternoon</span></a>
<a class="sourceLine" id="cb1707-20" data-line-number="20"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1707-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">afternoon =</span> <span class="kw">ifelse</span>(afternoon <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;morning&quot;</span>, <span class="st">&quot;afternoon&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1707-22" data-line-number="22"><span class="st">  </span><span class="co"># this seperates out the values into morning and afternoon columns</span></a>
<a class="sourceLine" id="cb1707-23" data-line-number="23"><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> afternoon, <span class="dt">value =</span> mean)</a>
<a class="sourceLine" id="cb1707-24" data-line-number="24"></a>
<a class="sourceLine" id="cb1707-25" data-line-number="25">estimates &lt;-</a>
<a class="sourceLine" id="cb1707-26" data-line-number="26"><span class="st">  </span><span class="kw">bind_rows</span>(partially_pooled_estimates, un_pooled_estimates) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1707-27" data-line-number="27"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pooled =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;partially&quot;</span>, <span class="st">&quot;not&quot;</span>), <span class="dt">each =</span> <span class="kw">n</span>() <span class="op">/</span><span class="st"> </span><span class="dv">2</span>))</a></code></pre></div>
<p>The code for Figure 14.5.b.</p>
<div class="sourceCode" id="cb1708"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1708-1" data-line-number="1">p2 &lt;-</a>
<a class="sourceLine" id="cb1708-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">data =</span> estimates, <span class="kw">aes</span>(<span class="dt">x =</span> morning, <span class="dt">y =</span> afternoon)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1708-3" data-line-number="3"><span class="st">  </span><span class="co"># nesting `stat_ellipse()` within `mapply()` is a less redundant way to produce the </span></a>
<a class="sourceLine" id="cb1708-4" data-line-number="4"><span class="st">  </span><span class="co"># ten-layered semitransparent ellipses we did with ten lines of `stat_ellipse()` </span></a>
<a class="sourceLine" id="cb1708-5" data-line-number="5"><span class="st">  </span><span class="co"># functions in the previous plot</span></a>
<a class="sourceLine" id="cb1708-6" data-line-number="6"><span class="st">  </span><span class="kw">mapply</span>(<span class="cf">function</span>(level) {</a>
<a class="sourceLine" id="cb1708-7" data-line-number="7">    <span class="kw">stat_ellipse</span>(<span class="dt">geom  =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>,</a>
<a class="sourceLine" id="cb1708-8" data-line-number="8">                 <span class="dt">size  =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>,</a>
<a class="sourceLine" id="cb1708-9" data-line-number="9">                 <span class="dt">level =</span> level)</a>
<a class="sourceLine" id="cb1708-10" data-line-number="10">    }, </a>
<a class="sourceLine" id="cb1708-11" data-line-number="11">    <span class="co"># enter the levels here</span></a>
<a class="sourceLine" id="cb1708-12" data-line-number="12">    <span class="dt">level =</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">9</span> <span class="op">/</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">.99</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1708-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">group =</span> cafe, <span class="dt">color =</span> pooled)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1708-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> cafe), <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1708-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="st">&quot;Pooled?&quot;</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1708-16" data-line-number="16"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;morning wait (mins)&quot;</span>,</a>
<a class="sourceLine" id="cb1708-17" data-line-number="17">       <span class="dt">y =</span> <span class="st">&quot;afternoon wait (mins)&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1708-18" data-line-number="18"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(estimates<span class="op">$</span>morning),</a>
<a class="sourceLine" id="cb1708-19" data-line-number="19">                  <span class="dt">ylim =</span> <span class="kw">range</span>(estimates<span class="op">$</span>afternoon))</a></code></pre></div>
<p>Here we combine the two subplots together with <strong>patchwork</strong> syntax.</p>
<div class="sourceCode" id="cb1709"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1709-1" data-line-number="1"><span class="kw">library</span>(patchwork)</a>
<a class="sourceLine" id="cb1709-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1709-3" data-line-number="3">(p1 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1709-4" data-line-number="4"><span class="st">  </span>p2 <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1709-5" data-line-number="5"><span class="st">  </span><span class="kw">plot_annotation</span>(<span class="dt">title =</span> <span class="st">&quot;Shrinkage in two dimensions&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-23-1.png" width="768" style="display: block; margin: auto;" /></p>
<blockquote>
<p>What I want you to appreciate in this plot is that shrinkage on the parameter scale naturally produces shrinkage where we actually care about it: on the outcome scale. And it also implies a population of wait times, shown by the [semitransparent ellipses]. That population is now positively correlated–cafés with longer morning waits also tend to have longer afternoon waits. They are popular, after all. But the population lies mostly below the dashed line where the waits are equal. You’ll wait less in the afternoon, on average. (p. 446)</p>
</blockquote>
</div>
</div>
<div id="advanced-varying-slopes" class="section level2">
<h2><span class="header-section-number">14.2</span> Advanced varying slopes</h2>
<p>In <a href="models-with-memory.html#more-than-one-type-of-cluster">Section 13.3</a> we saw that data can be considered <strong>cross-classified</strong> if they have multiple grouping factors. We used the <code>chipanzees</code> data in that section and we only considered cross-cassification by single intercepts. Turns out cross-classified models can be extended further. Let’s load and wrangle those data.</p>
<div class="sourceCode" id="cb1710"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1710-1" data-line-number="1"><span class="kw">library</span>(rethinking)</a>
<a class="sourceLine" id="cb1710-2" data-line-number="2"><span class="kw">data</span>(chimpanzees)</a>
<a class="sourceLine" id="cb1710-3" data-line-number="3">d &lt;-<span class="st"> </span>chimpanzees</a>
<a class="sourceLine" id="cb1710-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1710-5" data-line-number="5"><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</a>
<a class="sourceLine" id="cb1710-6" data-line-number="6"><span class="kw">library</span>(brms)</a>
<a class="sourceLine" id="cb1710-7" data-line-number="7"><span class="kw">rm</span>(chimpanzees)</a>
<a class="sourceLine" id="cb1710-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1710-9" data-line-number="9"><span class="co"># wrangle.</span></a>
<a class="sourceLine" id="cb1710-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1710-11" data-line-number="11">d &lt;-</a>
<a class="sourceLine" id="cb1710-12" data-line-number="12"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1710-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">actor     =</span> <span class="kw">factor</span>(actor),</a>
<a class="sourceLine" id="cb1710-14" data-line-number="14">         <span class="dt">block     =</span> <span class="kw">factor</span>(block),</a>
<a class="sourceLine" id="cb1710-15" data-line-number="15">         <span class="dt">treatment =</span> <span class="kw">factor</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>prosoc_left <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>condition),</a>
<a class="sourceLine" id="cb1710-16" data-line-number="16">         <span class="co"># this will come in handy, later</span></a>
<a class="sourceLine" id="cb1710-17" data-line-number="17">         <span class="dt">labels    =</span> <span class="kw">factor</span>(treatment,</a>
<a class="sourceLine" id="cb1710-18" data-line-number="18">                            <span class="dt">levels =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1710-19" data-line-number="19">                            <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;r/n&quot;</span>, <span class="st">&quot;l/n&quot;</span>, <span class="st">&quot;r/p&quot;</span>, <span class="st">&quot;l/p&quot;</span>)))</a>
<a class="sourceLine" id="cb1710-20" data-line-number="20"></a>
<a class="sourceLine" id="cb1710-21" data-line-number="21"><span class="kw">glimpse</span>(d)</a></code></pre></div>
<pre><code>## Rows: 504
## Columns: 10
## $ actor        &lt;fct&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ recipient    &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ condition    &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ block        &lt;fct&gt; 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5,…
## $ trial        &lt;int&gt; 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44, 46…
## $ prosoc_left  &lt;int&gt; 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0,…
## $ chose_prosoc &lt;int&gt; 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1,…
## $ pulled_left  &lt;int&gt; 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0,…
## $ treatment    &lt;fct&gt; 1, 1, 2, 1, 2, 2, 2, 2, 1, 1, 1, 2, 1, 2, 1, 2, 2, 1, 2, 1, 1, 1, 2, 2, 1, 1, 2, 2, 1,…
## $ labels       &lt;fct&gt; r/n, r/n, l/n, r/n, l/n, l/n, l/n, l/n, r/n, r/n, r/n, l/n, r/n, l/n, r/n, l/n, l/n, r…</code></pre>
<p>If I’m following along correctly with the text, McElreath’s <code>m14.2</code> uses the centered parameterization. Recall from the last chapter that <strong>brms</strong> only supports the non-centered parameterization. Happily, McElreath’s <code>m14.3</code> appears to use the non-centered parameterization. Thus, we’ll skip making a <code>b14/2</code> and jump directly into making a <code>b14.3</code>. I believe one could describe the statistical model as</p>
<p><span class="math display">\[\begin{align*}
\text{left_pull}_i &amp; \sim \operatorname{Binomial}(n_i = 1, p_i) \\
\operatorname{logit} (p_i) &amp; = \gamma_{\text{treatment}[i]} + \alpha_{\text{actor}[i], \text{treatment}[i]} + \beta_{\text{block}[i], \text{treatment}[i]} \\
\gamma_j &amp; \sim \operatorname{Normal}(0, 1), \;\;\; \text{for } j = 1..4 \\
\begin{bmatrix} \alpha_{j, 1} \\ \alpha_{j, 2} \\ \alpha_{j, 3} \\ \alpha_{j, 4} \end{bmatrix} &amp; \sim \operatorname{MVNormal} \begin{pmatrix} \begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \end{bmatrix}, \mathbf \Sigma_\text{actor} \end{pmatrix} \\
\begin{bmatrix} \beta_{j, 1} \\ \beta_{j, 2} \\ \beta_{j, 3} \\ \beta_{j, 4} \end{bmatrix} &amp; \sim \operatorname{MVNormal} \begin{pmatrix} \begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \end{bmatrix}, \mathbf \Sigma_\text{block} \end{pmatrix} \\
\mathbf \Sigma_\text{actor} &amp; = \mathbf{S_\alpha R_\alpha S_\alpha} \\
\mathbf \Sigma_\text{block} &amp; = \mathbf{S_\beta R_\beta S_\beta} \\
\sigma_{\alpha, [1]}, ..., \sigma_{\alpha, [4]} &amp; \sim \operatorname{Exponential}(1) \\
\sigma_{\beta, [1]}, ..., \sigma_{\beta, [4]}   &amp; \sim \operatorname{Exponential}(1) \\
\mathbf R_\alpha &amp; \sim \operatorname{LKJ}(2) \\
\mathbf R_\beta  &amp; \sim \operatorname{LKJ}(2).
\end{align*}\]</span></p>
<p>In this model, we have four population-level intercepts, <span class="math inline">\(\gamma_1, ..., \gamma_4\)</span>, one for each of the four levels of <code>treatment</code>. There are two higher-level grouping variables, <code>actor</code> and <code>block</code>, making this a cross-classified model.</p>
<p>The term <span class="math inline">\(\alpha_{\text{actor}[i], \text{treatment}[i]}\)</span> is meant to convey that each of the <code>treatment</code> effects can vary by <code>actor</code>. The first line containing the <span class="math inline">\(\operatorname{MVNormal}(\cdot)\)</span> operator indicates the <code>actor</code>-level deviations from the population-level estimates for <span class="math inline">\(\gamma_j\)</span> follow the multivariate normal distribution where the four means are set to zero (i.e., they are deviations) and their spread around those zeros are controlled by <span class="math inline">\(\Sigma_\text{actor}\)</span>. In the first line below the last line containing <span class="math inline">\(\operatorname{MVNormal}(\cdot)\)</span>, we learn that <span class="math inline">\(\Sigma_\text{actor}\)</span> can be decomposed into two terms, <span class="math inline">\(\mathbf S_\alpha\)</span> and <span class="math inline">\(\mathbf R_\alpha\)</span>. It may not yet be clear by the notation, but <span class="math inline">\(\mathbf S_\alpha\)</span> is a <span class="math inline">\(4 \times 4\)</span> matrix,</p>
<p><span class="math display">\[
\mathbf S_\alpha = \begin{bmatrix} \sigma_{\alpha, [1]} &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; \sigma_{\alpha, [2]} &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; \sigma_{\alpha, [3]} &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; \sigma_{\alpha, [4]} \end{bmatrix}.
\]</span></p>
<p>In a similar way, <span class="math inline">\(\mathbf R_\alpha\)</span> is a <span class="math inline">\(4 \times 4\)</span> matrix,</p>
<p><span class="math display">\[
\mathbf R_\alpha = \begin{bmatrix} 1 &amp; \rho_{\alpha, [1, 2]} &amp; \rho_{\alpha, [1, 3]} &amp; \rho_{\alpha, [1, 4]} \\ \rho_{\alpha, [2, 1]} &amp; 1 &amp; \rho_{\alpha, [2, 3]} &amp; \rho_{\alpha, [2, 4]} \\ \rho_{\alpha, [3, 1]} &amp; \rho_{\alpha, [3, 2]} &amp; 1 &amp; \rho_{\alpha, [3, 4]} \\ \rho_{\alpha, [4, 1]} &amp; \rho_{\alpha, [4, 2]} &amp; \rho_{\alpha, [4, 3]} &amp; 1 \end{bmatrix}.
\]</span></p>
<p>The same overall pattern holds true for <span class="math inline">\(\beta_{\text{block}[i], \text{treatment}[i]}\)</span> and the associated <span class="math inline">\(\beta\)</span> parameters connected to the <code>block</code> grouping variable. All the population parameters <span class="math inline">\(\sigma_{\alpha, [1]}, ..., \sigma_{\alpha, [4]}\)</span> and <span class="math inline">\(\sigma_{\beta, [1]}, ..., \sigma_{\beta, [4]}\)</span> have individual <span class="math inline">\(\operatorname{Exponential}(1)\)</span> priors. The two <span class="math inline">\(\mathbf R_{&lt; \cdot &gt;}\)</span> matrices have the priors <span class="math inline">\(\operatorname{LKJ}(2)\)</span>.</p>
<p>I know; this is a lot. This all takes time to grapple with. Here’s how to fit such a model with <strong>brms</strong>.</p>
<div class="sourceCode" id="cb1712"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1712-1" data-line-number="1">b14<span class="fl">.3</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1712-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1712-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1712-4" data-line-number="4">      pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>treatment <span class="op">+</span><span class="st"> </span>(<span class="dv">0</span> <span class="op">+</span><span class="st"> </span>treatment <span class="op">|</span><span class="st"> </span>actor) <span class="op">+</span><span class="st"> </span>(<span class="dv">0</span> <span class="op">+</span><span class="st"> </span>treatment <span class="op">|</span><span class="st"> </span>block),</a>
<a class="sourceLine" id="cb1712-5" data-line-number="5">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b),</a>
<a class="sourceLine" id="cb1712-6" data-line-number="6">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd, <span class="dt">group =</span> actor),</a>
<a class="sourceLine" id="cb1712-7" data-line-number="7">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd, <span class="dt">group =</span> block),</a>
<a class="sourceLine" id="cb1712-8" data-line-number="8">                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">2</span>), <span class="dt">class =</span> cor, <span class="dt">group =</span> actor),</a>
<a class="sourceLine" id="cb1712-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">2</span>), <span class="dt">class =</span> cor, <span class="dt">group =</span> block)),</a>
<a class="sourceLine" id="cb1712-10" data-line-number="10">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,  </a>
<a class="sourceLine" id="cb1712-11" data-line-number="11">      <span class="dt">seed =</span> <span class="dv">4387510</span>,</a>
<a class="sourceLine" id="cb1712-12" data-line-number="12">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.03&quot;</span>)</a></code></pre></div>
<p>Happily, we got no warnings about divergent transitions. Since it’s been a while, we’ll use <code>bayesplotmcmc_rank_overlay()</code> to examine the primary parameters with a trank plot.</p>
<div class="sourceCode" id="cb1713"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1713-1" data-line-number="1"><span class="kw">library</span>(bayesplot)</a>
<a class="sourceLine" id="cb1713-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1713-3" data-line-number="3"><span class="co"># give the parameters fancy names</span></a>
<a class="sourceLine" id="cb1713-4" data-line-number="4">names &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1713-5" data-line-number="5"><span class="st">  </span><span class="kw">c</span>(<span class="kw">str_c</span>(<span class="st">&quot;treatment[&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="st">&quot;]&quot;</span>), </a>
<a class="sourceLine" id="cb1713-6" data-line-number="6">    <span class="kw">str_c</span>(<span class="st">&quot;sigma[&#39;actor[&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="st">&quot;]&#39;]&quot;</span>), </a>
<a class="sourceLine" id="cb1713-7" data-line-number="7">    <span class="kw">str_c</span>(<span class="st">&quot;sigma[&#39;block[&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="st">&quot;]&#39;]&quot;</span>), </a>
<a class="sourceLine" id="cb1713-8" data-line-number="8">    <span class="kw">str_c</span>(<span class="st">&quot;rho[&#39;actor:treatment[&quot;</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="st">&quot;,&quot;</span>, <span class="kw">rep</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">times =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="st">&quot;]&#39;]&quot;</span>), </a>
<a class="sourceLine" id="cb1713-9" data-line-number="9">    <span class="kw">str_c</span>(<span class="st">&quot;rho[&#39;block:treatment[&quot;</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="st">&quot;,&quot;</span>, <span class="kw">rep</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">times =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="st">&quot;]&#39;]&quot;</span>), </a>
<a class="sourceLine" id="cb1713-10" data-line-number="10">    <span class="st">&quot;chain&quot;</span>)</a>
<a class="sourceLine" id="cb1713-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1713-12" data-line-number="12"><span class="co"># wrangle</span></a>
<a class="sourceLine" id="cb1713-13" data-line-number="13"><span class="kw">posterior_samples</span>(b14<span class="fl">.3</span>, <span class="dt">add_chain =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1713-14" data-line-number="14"><span class="st">  </span><span class="kw">select</span>(b_treatment1<span class="op">:</span><span class="st">`</span><span class="dt">cor_block__treatment3__treatment4</span><span class="st">`</span>, chain) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1713-15" data-line-number="15"><span class="st">  </span><span class="kw">set_names</span>(names) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1713-16" data-line-number="16"><span class="st">  </span></a>
<a class="sourceLine" id="cb1713-17" data-line-number="17"><span class="st">  </span><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1713-18" data-line-number="18"><span class="st">  </span><span class="kw">mcmc_rank_overlay</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb1713-19" data-line-number="19"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#B1934A&quot;</span>, <span class="st">&quot;#A65141&quot;</span>, <span class="st">&quot;#EEDA9D&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1713-20" data-line-number="20"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">4</span> <span class="op">*</span><span class="st"> </span><span class="fl">1e3</span>, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">str_c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="st">&quot;K&quot;</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb1713-21" data-line-number="21"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">30</span>, <span class="ot">NA</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1713-22" data-line-number="22"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1713-23" data-line-number="23"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>parameter, <span class="dt">labeller =</span> label_parsed, <span class="dt">ncol =</span> <span class="dv">4</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-25-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>Because we only fit a non-centered version of the model, we aren’t able to make a faithful version of McElreath’s Figure 14.6. However, we can still use <code>posterior::summarise_draws()</code> to help make histograms of the two kinds of effective sample sizes for our <code>b14.3</code>.</p>
<div class="sourceCode" id="cb1714"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1714-1" data-line-number="1"><span class="kw">library</span>(posterior)</a>
<a class="sourceLine" id="cb1714-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1714-3" data-line-number="3"><span class="kw">posterior_samples</span>(b14<span class="fl">.3</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1714-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise_draws</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1714-5" data-line-number="5"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;ess&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1714-6" data-line-number="6"><span class="st">  </span></a>
<a class="sourceLine" id="cb1714-7" data-line-number="7"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1714-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">250</span>, <span class="dt">fill =</span> <span class="st">&quot;#EEDA9D&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1714-9" data-line-number="9"><span class="st">  </span><span class="kw">xlim</span>(<span class="dv">0</span>, <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1714-10" data-line-number="10"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>name)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-26-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>Here is a summary of the model parameters.</p>
<div class="sourceCode" id="cb1715"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1715-1" data-line-number="1"><span class="kw">print</span>(b14<span class="fl">.3</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: pulled_left | trials(1) ~ 0 + treatment + (0 + treatment | actor) + (0 + treatment | block) 
##    Data: d (Number of observations: 504) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Group-Level Effects: 
## ~actor (Number of levels: 7) 
##                            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(treatment1)                 1.39      0.48     0.72     2.64 1.00     2201     2815
## sd(treatment2)                 0.91      0.40     0.35     1.91 1.00     3282     3127
## sd(treatment3)                 1.86      0.56     1.05     3.16 1.00     3399     2236
## sd(treatment4)                 1.58      0.58     0.75     2.97 1.00     3663     3013
## cor(treatment1,treatment2)     0.44      0.28    -0.16     0.87 1.00     3489     3054
## cor(treatment1,treatment3)     0.52      0.25    -0.04     0.90 1.00     2995     2774
## cor(treatment2,treatment3)     0.48      0.26    -0.09     0.88 1.00     3492     3420
## cor(treatment1,treatment4)     0.44      0.27    -0.17     0.87 1.00     2936     2992
## cor(treatment2,treatment4)     0.45      0.27    -0.18     0.88 1.00     3654     2849
## cor(treatment3,treatment4)     0.57      0.24     0.01     0.92 1.00     3571     3250
## 
## ~block (Number of levels: 6) 
##                            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(treatment1)                 0.41      0.32     0.02     1.19 1.00     2134     2402
## sd(treatment2)                 0.43      0.34     0.02     1.28 1.00     2055     2192
## sd(treatment3)                 0.30      0.28     0.01     1.02 1.00     3257     2160
## sd(treatment4)                 0.47      0.37     0.02     1.41 1.00     2494     2728
## cor(treatment1,treatment2)    -0.07      0.37    -0.73     0.64 1.00     5141     2860
## cor(treatment1,treatment3)    -0.01      0.38    -0.72     0.70 1.00     8342     2957
## cor(treatment2,treatment3)    -0.03      0.38    -0.73     0.71 1.00     5812     2737
## cor(treatment1,treatment4)     0.05      0.37    -0.67     0.72 1.00     5716     2841
## cor(treatment2,treatment4)     0.05      0.38    -0.69     0.75 1.00     4646     2892
## cor(treatment3,treatment4)     0.01      0.38    -0.70     0.72 1.00     3508     3356
## 
## Population-Level Effects: 
##            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## treatment1     0.22      0.50    -0.72     1.25 1.00     2269     2882
## treatment2     0.63      0.40    -0.18     1.44 1.00     2961     2622
## treatment3    -0.03      0.58    -1.12     1.15 1.00     3060     2884
## treatment4     0.69      0.55    -0.38     1.79 1.00     3378     2795
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Like McElreath explained on page 450, our <code>b14.3</code> has 76 parameters:</p>
<ul>
<li>4 average <code>treatment</code> effects, as listed in the ‘Population-Level Effects’ section;</li>
<li>7 <span class="math inline">\(\times\)</span> 4 = 28 varying effects on <code>actor</code>, as indicated in the ‘~actor:treatment (Number of levels: 7)’ header multiplied by the four levels of <code>treatment</code>;</li>
<li>6 <span class="math inline">\(\times\)</span> 4 = 24 varying effects on <code>block</code>, as indicated in the ‘~block:treatment (Number of levels: 6)’ header multiplied by the four levels of <code>treatment</code>;</li>
<li>8 standard deviations listed in the eight rows beginning with <code>sd(</code>; and</li>
<li>12 free correlation parameters listed in the eight rows beginning with <code>cor(</code>.</li>
</ul>
<p>Compute the WAIC estmiate.</p>
<div class="sourceCode" id="cb1717"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1717-1" data-line-number="1">b14<span class="fl">.3</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b14<span class="fl">.3</span>, <span class="st">&quot;waic&quot;</span>)</a>
<a class="sourceLine" id="cb1717-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1717-3" data-line-number="3"><span class="kw">waic</span>(b14<span class="fl">.3</span>)</a></code></pre></div>
<pre><code>## 
## Computed from 4000 by 504 log-likelihood matrix
## 
##           Estimate   SE
## elpd_waic   -272.1  9.9
## p_waic        26.7  1.4
## waic         544.2 19.7
## 
## 1 (0.2%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
<p>Like the <span class="math inline">\(p_\text{WAIC}\)</span>, our <strong>brms</strong> version of the model has about 27 effective parameters. Now we’ll get a better sense of the model with a posterior predictive check in the form of our version of Figure 14.7. McElreath described his <strong>R</strong> code 14.22 as “a big chunk of code” (p. 451). I’ll leave up to the reader to decide whether our big code chunk is any better.</p>
<div class="sourceCode" id="cb1719"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1719-1" data-line-number="1"><span class="co"># for annotation</span></a>
<a class="sourceLine" id="cb1719-2" data-line-number="2">text &lt;-</a>
<a class="sourceLine" id="cb1719-3" data-line-number="3"><span class="st">  </span><span class="kw">distinct</span>(d, labels) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1719-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">actor =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1719-5" data-line-number="5">         <span class="dt">prop  =</span> <span class="kw">c</span>(.<span class="dv">07</span>, <span class="fl">.8</span>, <span class="fl">.08</span>, <span class="fl">.795</span>))</a>
<a class="sourceLine" id="cb1719-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1719-7" data-line-number="7">nd &lt;-</a>
<a class="sourceLine" id="cb1719-8" data-line-number="8"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1719-9" data-line-number="9"><span class="st">  </span><span class="kw">distinct</span>(actor, condition, labels, prosoc_left, treatment) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1719-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">block =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb1719-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1719-12" data-line-number="12"><span class="co"># compute and wrangle the posterior predictions</span></a>
<a class="sourceLine" id="cb1719-13" data-line-number="13"><span class="kw">fitted</span>(b14<span class="fl">.3</span>,</a>
<a class="sourceLine" id="cb1719-14" data-line-number="14">       <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1719-15" data-line-number="15"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1719-16" data-line-number="16"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1719-17" data-line-number="17"><span class="st">  </span><span class="co"># add the empirical proportions</span></a>
<a class="sourceLine" id="cb1719-18" data-line-number="18"><span class="st">  </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb1719-19" data-line-number="19">    d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1719-20" data-line-number="20"><span class="st">      </span><span class="kw">group_by</span>(actor, treatment) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1719-21" data-line-number="21"><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">proportion =</span> <span class="kw">mean</span>(pulled_left)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1719-22" data-line-number="22"><span class="st">      </span><span class="kw">distinct</span>(actor, treatment, proportion),</a>
<a class="sourceLine" id="cb1719-23" data-line-number="23">    <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;actor&quot;</span>, <span class="st">&quot;treatment&quot;</span>)</a>
<a class="sourceLine" id="cb1719-24" data-line-number="24">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1719-25" data-line-number="25"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">condition =</span> <span class="kw">factor</span>(condition)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1719-26" data-line-number="26"><span class="st">  </span></a>
<a class="sourceLine" id="cb1719-27" data-line-number="27"><span class="st">  </span><span class="co"># plot!</span></a>
<a class="sourceLine" id="cb1719-28" data-line-number="28"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> labels)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1719-29" data-line-number="29"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="fl">.5</span>, <span class="dt">color =</span> <span class="st">&quot;#E8DCCF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1719-30" data-line-number="30"><span class="st">  </span><span class="co"># empirical proportions</span></a>
<a class="sourceLine" id="cb1719-31" data-line-number="31"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> proportion, <span class="dt">group =</span> prosoc_left),</a>
<a class="sourceLine" id="cb1719-32" data-line-number="32">            <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">color =</span> <span class="st">&quot;#394165&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1719-33" data-line-number="33"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> proportion, <span class="dt">shape =</span> condition),</a>
<a class="sourceLine" id="cb1719-34" data-line-number="34">             <span class="dt">color =</span> <span class="st">&quot;#394165&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">size =</span> <span class="fl">2.5</span>, <span class="dt">show.legend =</span> F) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1719-35" data-line-number="35"><span class="st">  </span><span class="co"># posterior predictions</span></a>
<a class="sourceLine" id="cb1719-36" data-line-number="36"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimate, <span class="dt">group =</span> prosoc_left),</a>
<a class="sourceLine" id="cb1719-37" data-line-number="37">            <span class="dt">size =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1719-38" data-line-number="38"><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimate, <span class="dt">ymin =</span> Q2<span class="fl">.5</span>, <span class="dt">ymax =</span> Q97<span class="fl">.5</span>, <span class="dt">shape =</span> condition),</a>
<a class="sourceLine" id="cb1719-39" data-line-number="39">             <span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">fatten =</span> <span class="dv">8</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">show.legend =</span> F) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1719-40" data-line-number="40"><span class="st">  </span><span class="co"># annotation for the conditions</span></a>
<a class="sourceLine" id="cb1719-41" data-line-number="41"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> text,</a>
<a class="sourceLine" id="cb1719-42" data-line-number="42">            <span class="kw">aes</span>(<span class="dt">y =</span> prop, <span class="dt">label =</span> labels), </a>
<a class="sourceLine" id="cb1719-43" data-line-number="43">            <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>, <span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1719-44" data-line-number="44"><span class="st">  </span><span class="kw">scale_shape_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="dv">21</span>, <span class="dv">19</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1719-45" data-line-number="45"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1719-46" data-line-number="46"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;proportion left lever&quot;</span>, <span class="dt">breaks =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;0&quot;</span>, <span class="st">&quot;.5&quot;</span>, <span class="st">&quot;1&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1719-47" data-line-number="47"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Posterior predictions, in light blue, against the raw data, in dark blue, for</span><span class="ch">\n</span><span class="st">model b14.3, the cross-classified varying effects model.&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1719-48" data-line-number="48"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>actor, <span class="dt">nrow =</span> <span class="dv">1</span>, <span class="dt">labeller =</span> label_both)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-29-1.png" width="768" style="display: block; margin: auto;" /></p>
<blockquote>
<p>These chimpanzees simply did not behave in any consistently different way in the partner treatments. The model we’ve used here does have some advantages, though. Since it allows for some individuals to differ in how they respond to the treatments, it could reveal a situation in which a treatment has no effect on average, even though some of the individuals respond strongly. That wasn’t the case here. But often we are more interested in the distribution of responses than in the average response, so a model that estimates the distribution of treatment effects is very useful. (p. 452)</p>
</blockquote>
</div>
<div id="instruments-and-causal-designs" class="section level2">
<h2><span class="header-section-number">14.3</span> Instruments and causal designs</h2>
<blockquote>
<p>Sometimes it won’t be possible to close all of the non-causal paths or rule of unobserved confounds. What can be done in that case? More than nothing. If you are lucky, there are ways to exploit a combination of natural experiments and clever modeling that allow causal inference even when non-causal paths cannot be closed. (p. 445)</p>
</blockquote>
<div id="instrumental-variables." class="section level3">
<h3><span class="header-section-number">14.3.1</span> Instrumental variables.</h3>
<p>Say were are interested in the causal impact of education <span class="math inline">\(E\)</span> on wages <span class="math inline">\(W\)</span>, <span class="math inline">\(E \rightarrow W\)</span>. Further imagine there is some unmeasured variable <span class="math inline">\(U\)</span> that has causal relations with both, <span class="math inline">\(E \leftarrow U \rightarrow W\)</span>, creating a backdoor path. We might use good old <strong>ggdag</strong> to plot the DAG.</p>
<div class="sourceCode" id="cb1720"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1720-1" data-line-number="1"><span class="kw">library</span>(ggdag)</a>
<a class="sourceLine" id="cb1720-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1720-3" data-line-number="3">dag_coords &lt;-</a>
<a class="sourceLine" id="cb1720-4" data-line-number="4"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">name =</span> <span class="kw">c</span>(<span class="st">&quot;E&quot;</span>, <span class="st">&quot;U&quot;</span>, <span class="st">&quot;W&quot;</span>),</a>
<a class="sourceLine" id="cb1720-5" data-line-number="5">         <span class="dt">x    =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1720-6" data-line-number="6">         <span class="dt">y    =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>))</a></code></pre></div>
<p>Before we make the plot, we’ll make a custom theme, <code>theme_pearl_dag()</code>, to streamline our DAG plots.</p>
<div class="sourceCode" id="cb1721"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1721-1" data-line-number="1">theme_pearl_dag &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb1721-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb1721-3" data-line-number="3">  <span class="kw">theme_pearl_earring</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb1721-4" data-line-number="4"><span class="st">    </span><span class="kw">theme_dag</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1721-5" data-line-number="5"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;#100F14&quot;</span>),</a>
<a class="sourceLine" id="cb1721-6" data-line-number="6">          ...)</a>
<a class="sourceLine" id="cb1721-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb1721-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb1721-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1721-10" data-line-number="10"><span class="kw">dagify</span>(E <span class="op">~</span><span class="st"> </span>U,</a>
<a class="sourceLine" id="cb1721-11" data-line-number="11">       W <span class="op">~</span><span class="st"> </span>E <span class="op">+</span><span class="st"> </span>U,</a>
<a class="sourceLine" id="cb1721-12" data-line-number="12">       <span class="dt">coords =</span> dag_coords) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1721-13" data-line-number="13"><span class="st">  </span></a>
<a class="sourceLine" id="cb1721-14" data-line-number="14"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">xend =</span> xend, <span class="dt">yend =</span> yend)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1721-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_dag_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> name <span class="op">==</span><span class="st"> &quot;U&quot;</span>),</a>
<a class="sourceLine" id="cb1721-16" data-line-number="16">                 <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">stroke =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">6</span>, <span class="dt">show.legend =</span> F) <span class="op">+</span></a>
<a class="sourceLine" id="cb1721-17" data-line-number="17"><span class="st">  </span><span class="kw">geom_dag_text</span>(<span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1721-18" data-line-number="18"><span class="st">  </span><span class="kw">geom_dag_edges</span>(<span class="dt">edge_colour =</span> <span class="st">&quot;#FCF9F0&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1721-19" data-line-number="19"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#EEDA9D&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1721-20" data-line-number="20"><span class="st">  </span><span class="kw">theme_pearl_dag</span>()</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-31-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>Instrumental variables will solve some of the difficulties we have in not being able to condition on <span class="math inline">\(U\)</span>. Here we’ll call our instrumental variable <span class="math inline">\(Q\)</span>. In the terms of the present example, the <strong>instrumental variable</strong> has the qualities that</p>
<ul>
<li><span class="math inline">\(Q\)</span> is independent of <span class="math inline">\(U\)</span>,</li>
<li><span class="math inline">\(Q\)</span> is not independent of <span class="math inline">\(E\)</span>, and</li>
<li><span class="math inline">\(Q\)</span> can only influence <span class="math inline">\(W\)</span> through <span class="math inline">\(E\)</span> (i.e., the effect of <span class="math inline">\(Q\)</span> on <span class="math inline">\(W\)</span> is fully mediated by <span class="math inline">\(E\)</span>).</li>
</ul>
<p>There is what this looks like in a DAG.</p>
<div class="sourceCode" id="cb1722"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1722-1" data-line-number="1">dag_coords &lt;-</a>
<a class="sourceLine" id="cb1722-2" data-line-number="2"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">name =</span> <span class="kw">c</span>(<span class="st">&quot;Q&quot;</span>, <span class="st">&quot;E&quot;</span>, <span class="st">&quot;U&quot;</span>, <span class="st">&quot;W&quot;</span>),</a>
<a class="sourceLine" id="cb1722-3" data-line-number="3">         <span class="dt">x    =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1722-4" data-line-number="4">         <span class="dt">y    =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb1722-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1722-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1722-7" data-line-number="7"><span class="kw">dagify</span>(E <span class="op">~</span><span class="st"> </span>Q <span class="op">+</span><span class="st"> </span>U,</a>
<a class="sourceLine" id="cb1722-8" data-line-number="8">       W <span class="op">~</span><span class="st"> </span>E <span class="op">+</span><span class="st"> </span>U,</a>
<a class="sourceLine" id="cb1722-9" data-line-number="9">       <span class="dt">coords =</span> dag_coords) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1722-10" data-line-number="10"><span class="st">  </span></a>
<a class="sourceLine" id="cb1722-11" data-line-number="11"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">xend =</span> xend, <span class="dt">yend =</span> yend)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1722-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_dag_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> name <span class="op">==</span><span class="st"> &quot;U&quot;</span>),</a>
<a class="sourceLine" id="cb1722-13" data-line-number="13">                 <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">stroke =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">6</span>, <span class="dt">show.legend =</span> F) <span class="op">+</span></a>
<a class="sourceLine" id="cb1722-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_dag_text</span>(<span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1722-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_dag_edges</span>(<span class="dt">edge_colour =</span> <span class="st">&quot;#FCF9F0&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1722-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#EEDA9D&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1722-17" data-line-number="17"><span class="st">  </span><span class="kw">theme_pearl_dag</span>()</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-32-1.png" width="336" style="display: block; margin: auto;" /></p>
<p>Sadly, our condition that <span class="math inline">\(Q\)</span> can only influence <span class="math inline">\(W\)</span> through <span class="math inline">\(E\)</span>–often called the <strong>exclusion restriction</strong>–generally cannot be tested. Given <span class="math inline">\(U\)</span> is unmeasured, by definition, we also cannot test that <span class="math inline">\(Q\)</span> is independent of <span class="math inline">\(U\)</span>. These are model assumptions.</p>
<p>Let’s simulate data based on <span class="citation">Angrist &amp; Keueger (<a href="#ref-angristDoesCompulsorySchool1991">1991</a>)</span> to get a sense of how this works.</p>
<div class="sourceCode" id="cb1723"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1723-1" data-line-number="1"><span class="co"># make a standardizing function</span></a>
<a class="sourceLine" id="cb1723-2" data-line-number="2">standardize &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb1723-3" data-line-number="3">  (x <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(x)) <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(x)</a>
<a class="sourceLine" id="cb1723-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb1723-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1723-6" data-line-number="6"><span class="co"># simulate</span></a>
<a class="sourceLine" id="cb1723-7" data-line-number="7"><span class="kw">set.seed</span>(<span class="dv">73</span>) </a>
<a class="sourceLine" id="cb1723-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1723-9" data-line-number="9">n &lt;-<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb1723-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1723-11" data-line-number="11">dat_sim &lt;-</a>
<a class="sourceLine" id="cb1723-12" data-line-number="12"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">u_sim =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1723-13" data-line-number="13">         <span class="dt">q_sim =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">size =</span> n, <span class="dt">replace =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1723-14" data-line-number="14"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">e_sim =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> u_sim <span class="op">+</span><span class="st"> </span>q_sim, <span class="dt">sd =</span> <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1723-15" data-line-number="15"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">w_sim =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> u_sim <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">*</span><span class="st"> </span>e_sim, <span class="dt">sd =</span> <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1723-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">w =</span> <span class="kw">standardize</span>(w_sim),</a>
<a class="sourceLine" id="cb1723-17" data-line-number="17">         <span class="dt">e =</span> <span class="kw">standardize</span>(e_sim),</a>
<a class="sourceLine" id="cb1723-18" data-line-number="18">         <span class="dt">q =</span> <span class="kw">standardize</span>(q_sim))</a>
<a class="sourceLine" id="cb1723-19" data-line-number="19"></a>
<a class="sourceLine" id="cb1723-20" data-line-number="20">dat_sim</a></code></pre></div>
<pre><code>## # A tibble: 500 x 7
##      u_sim q_sim e_sim   w_sim       w       e      q
##      &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
##  1 -0.145      1 1.51   0.216   0.173  -0.575  -1.36 
##  2  0.291      1 0.664  0.846   0.584  -1.09   -1.36 
##  3  0.0938     3 2.44  -0.664  -0.402  -0.0185  0.428
##  4 -0.127      3 4.09  -0.725  -0.442   0.978   0.428
##  5 -0.847      4 2.62  -1.24   -0.780   0.0939  1.32 
##  6  0.141      4 3.54  -0.0700 -0.0146  0.651   1.32 
##  7  1.54       2 3.65   1.88    1.26    0.714  -0.464
##  8  2.74       3 4.91   2.52    1.67    1.48    0.428
##  9  1.55       3 4.18   0.624   0.439   1.04    0.428
## 10  0.462      1 0.360  0.390   0.286  -1.27   -1.36 
## # … with 490 more rows</code></pre>
<p><span class="math inline">\(Q\)</span> in this context is like quarter in the school year, but inversely scaled such that larger numbers indicate more quarters. In this simulation, we have set the true effect of education on wages–<span class="math inline">\(E \rightarrow W\)</span>–to be zero. Any univariate association is through the coufounding variable <span class="math inline">\(U\)</span>. Also, <span class="math inline">\(Q\)</span> has no direct effect on <span class="math inline">\(W\)</span> or <span class="math inline">\(U\)</span>, but it does have a causal relation with <span class="math inline">\(E\)</span>, which is <span class="math inline">\(Q \rightarrow E \leftarrow U\)</span>. First we fit the univariable model corresponding to <span class="math inline">\(E \rightarrow W\)</span>.</p>
<div class="sourceCode" id="cb1725"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1725-1" data-line-number="1">b14<span class="fl">.4</span> &lt;-</a>
<a class="sourceLine" id="cb1725-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> dat_sim,</a>
<a class="sourceLine" id="cb1725-3" data-line-number="3">      <span class="dt">family =</span> gaussian,</a>
<a class="sourceLine" id="cb1725-4" data-line-number="4">      w <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>e,</a>
<a class="sourceLine" id="cb1725-5" data-line-number="5">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1725-6" data-line-number="6">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b),</a>
<a class="sourceLine" id="cb1725-7" data-line-number="7">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sigma)),</a>
<a class="sourceLine" id="cb1725-8" data-line-number="8">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,  </a>
<a class="sourceLine" id="cb1725-9" data-line-number="9">      <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1725-10" data-line-number="10">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.04&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb1726"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1726-1" data-line-number="1"><span class="kw">print</span>(b14<span class="fl">.4</span>)</a></code></pre></div>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: w ~ 1 + e 
##    Data: dat_sim (Number of observations: 500) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     0.00      0.04    -0.08     0.08 1.00     3649     2979
## e             0.40      0.04     0.32     0.48 1.00     3939     3096
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.92      0.03     0.86     0.98 1.00     4064     2876
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Because we have not conditioned on <span class="math inline">\(U\)</span>, then model suggests a moderately large spurious causal relation for <span class="math inline">\(E \rightarrow W\)</span>. Now see what happens when we also condition directly on <span class="math inline">\(Q\)</span>, as in <span class="math inline">\(Q \rightarrow W \leftarrow E\)</span>.</p>
<div class="sourceCode" id="cb1728"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1728-1" data-line-number="1">b14<span class="fl">.5</span> &lt;-</a>
<a class="sourceLine" id="cb1728-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> dat_sim,</a>
<a class="sourceLine" id="cb1728-3" data-line-number="3">      <span class="dt">family =</span> gaussian,</a>
<a class="sourceLine" id="cb1728-4" data-line-number="4">      w <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>e <span class="op">+</span><span class="st"> </span>q,</a>
<a class="sourceLine" id="cb1728-5" data-line-number="5">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1728-6" data-line-number="6">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b),</a>
<a class="sourceLine" id="cb1728-7" data-line-number="7">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sigma)),</a>
<a class="sourceLine" id="cb1728-8" data-line-number="8">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,  </a>
<a class="sourceLine" id="cb1728-9" data-line-number="9">      <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1728-10" data-line-number="10">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.05&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb1729"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1729-1" data-line-number="1"><span class="kw">print</span>(b14<span class="fl">.5</span>)</a></code></pre></div>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: w ~ 1 + e + q 
##    Data: dat_sim (Number of observations: 500) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     0.00      0.04    -0.08     0.07 1.00     3237     2650
## e             0.64      0.05     0.54     0.72 1.00     3398     2874
## q            -0.40      0.05    -0.49    -0.32 1.00     3290     2794
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.86      0.03     0.81     0.92 1.00     3915     2920
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Holy smokes that’s a mess. This model suggests both <span class="math inline">\(E\)</span> and <span class="math inline">\(Q\)</span> have moderate to strong causal effects on <span class="math inline">\(W\)</span>, even though we know neither do based on the true data-generating model. Like McElreath said, “bad stuff happens” when we condition on an instrumental variable this way.</p>
<blockquote>
<p>There is no backdoor path through <span class="math inline">\(Q\)</span>, as you can see. But there is a non-causal path from <span class="math inline">\(Q\)</span> to <span class="math inline">\(W\)</span> through <span class="math inline">\(U\)</span>: <span class="math inline">\(Q \rightarrow E \leftarrow U \rightarrow W\)</span>. This is a non-causal path, because changing <span class="math inline">\(Q\)</span> doesn’t result in any change in W through this path. But since we are conditioning on <span class="math inline">\(E\)</span> in the same model, and <span class="math inline">\(E\)</span> is a collider of <span class="math inline">\(Q\)</span> and <span class="math inline">\(U\)</span>, the non-causal path is open. This confounds the coefficient on <span class="math inline">\(Q\)</span>. It won’t be zero, because it’ll pick up the association between <span class="math inline">\(U\)</span> and <span class="math inline">\(W\)</span>. And then, as a result, the coefficient on <span class="math inline">\(E\)</span> can get even more confounded. Used this way, an instrument like <span class="math inline">\(Q\)</span> might be called a <strong>bias amplifier</strong>. (p. 456, <strong>emphasis</strong> in the original)</p>
</blockquote>
<p>The statistical solution to this mess is to express the data-generating DAG as a multivariate statistical model following the form</p>
<p><span class="math display">\[\begin{align*}
\begin{bmatrix} W_i \\ E_i \end{bmatrix} &amp; \sim \operatorname{MVNormal} \begin{pmatrix} \begin{bmatrix} \mu_{\text w,i} \\ \mu_{\text E,i} \end{bmatrix}, \mathbf S \end{pmatrix} \\
\mu_{\text W,i} &amp; = \alpha_\text W + \beta_\text{EW} E_i \\
\mu_{\text E,i} &amp; = \alpha_\text E + \beta_\text{QE} Q_i \\
\mathbf S &amp; = \begin{bmatrix} \sigma_\text W &amp; 0 \\ 0  &amp; \sigma_\text E \end{bmatrix} \mathbf R \begin{bmatrix} \sigma_\text W &amp; 0 \\ 0  &amp; \sigma_\text E \end{bmatrix} \\
\mathbf R &amp; = \begin{bmatrix} 1 &amp; \rho \\ \rho &amp; 1 \end{bmatrix} \\
\alpha_\text W \text{ and } \alpha_\text E &amp; \sim \operatorname{Normal}(0, 0.2) \\
\beta_\text{EW} \text{ and } \beta_\text{QE} &amp; \sim \operatorname{Normal}(0, 0.5) \\
\sigma_\text W \text{ and } \sigma_\text E &amp; \sim \operatorname{Exponential}(1) \\
\rho &amp; \sim \operatorname{LKJ}(2).
\end{align*}\]</span></p>
<p>You might not remember, but we’ve actually fit a model like this before. It was <code>b5.3_A</code> from way back in <a href="the-many-variables-the-spurious-waffles.html#counterfactual-plots.">Section 5.1.5.3</a>. The big difference between that earlier model and this one is whereas the former did not include a residual correlation, <span class="math inline">\(\rho\)</span>, this one will. Thus, this time we will make sure to set <code>set_rescor(TRUE)</code> in the <code>formula</code>. Within <strong>brms</strong> parlance, priors for residual correlations are of <code>class = rescor</code>.</p>
<div class="sourceCode" id="cb1731"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1731-1" data-line-number="1">e_model &lt;-<span class="st"> </span><span class="kw">bf</span>(e <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>q)</a>
<a class="sourceLine" id="cb1731-2" data-line-number="2">w_model &lt;-<span class="st"> </span><span class="kw">bf</span>(w <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>e)</a>
<a class="sourceLine" id="cb1731-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1731-4" data-line-number="4">b14<span class="fl">.6</span> &lt;-</a>
<a class="sourceLine" id="cb1731-5" data-line-number="5"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> dat_sim, </a>
<a class="sourceLine" id="cb1731-6" data-line-number="6">      <span class="dt">family =</span> gaussian,</a>
<a class="sourceLine" id="cb1731-7" data-line-number="7">      e_model <span class="op">+</span><span class="st"> </span>w_model <span class="op">+</span><span class="st"> </span><span class="kw">set_rescor</span>(<span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1731-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="co"># E model</span></a>
<a class="sourceLine" id="cb1731-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">class =</span> Intercept, <span class="dt">resp =</span> e),</a>
<a class="sourceLine" id="cb1731-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b, <span class="dt">resp =</span> e),</a>
<a class="sourceLine" id="cb1731-11" data-line-number="11">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sigma, <span class="dt">resp =</span> e),</a>
<a class="sourceLine" id="cb1731-12" data-line-number="12">                </a>
<a class="sourceLine" id="cb1731-13" data-line-number="13">                <span class="co"># W model</span></a>
<a class="sourceLine" id="cb1731-14" data-line-number="14">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">class =</span> Intercept, <span class="dt">resp =</span> w),</a>
<a class="sourceLine" id="cb1731-15" data-line-number="15">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b, <span class="dt">resp =</span> w),</a>
<a class="sourceLine" id="cb1731-16" data-line-number="16">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sigma, <span class="dt">resp =</span> w),</a>
<a class="sourceLine" id="cb1731-17" data-line-number="17">                </a>
<a class="sourceLine" id="cb1731-18" data-line-number="18">                <span class="co"># rho</span></a>
<a class="sourceLine" id="cb1731-19" data-line-number="19">                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">2</span>), <span class="dt">class =</span> rescor)),</a>
<a class="sourceLine" id="cb1731-20" data-line-number="20">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1731-21" data-line-number="21">      <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1731-22" data-line-number="22">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.06&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb1732"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1732-1" data-line-number="1"><span class="kw">print</span>(b14<span class="fl">.6</span>)</a></code></pre></div>
<pre><code>##  Family: MV(gaussian, gaussian) 
##   Links: mu = identity; sigma = identity
##          mu = identity; sigma = identity 
## Formula: e ~ 1 + q 
##          w ~ 1 + e 
##    Data: dat_sim (Number of observations: 500) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## e_Intercept    -0.00      0.04    -0.07     0.07 1.00     2772     2681
## w_Intercept    -0.00      0.04    -0.08     0.08 1.00     2892     2778
## e_q             0.59      0.04     0.52     0.66 1.00     2572     2564
## w_e            -0.05      0.08    -0.21     0.09 1.00     1534     2104
## 
## Family Specific Parameters: 
##         Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma_e     0.81      0.03     0.76     0.86 1.00     3899     2716
## sigma_w     1.02      0.05     0.94     1.12 1.00     1917     2157
## 
## Residual Correlations: 
##             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## rescor(e,w)     0.54      0.05     0.44     0.64 1.00     1676     2040
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Now the parameter for <span class="math inline">\(E \rightarrow W\)</span>, <code>w_e</code>, is just where it should be–near zero. The residual correlation between <span class="math inline">\(E\)</span> and <span class="math inline">\(Q\)</span> is positive and large in magnitude, indicating their common influence from the unmeasured variable <span class="math inline">\(U\)</span>. Next we’ll take McElreath’s direction to “adjust the simulation and try other scenarios” (p. 459) by adjusting the causal relations, as in his <strong>R</strong> code 14.28.</p>
<div class="sourceCode" id="cb1734"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1734-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">73</span>) </a>
<a class="sourceLine" id="cb1734-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1734-3" data-line-number="3">n &lt;-<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb1734-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1734-5" data-line-number="5">dat_sim &lt;-</a>
<a class="sourceLine" id="cb1734-6" data-line-number="6"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">u_sim =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1734-7" data-line-number="7">         <span class="dt">q_sim =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">size =</span> n, <span class="dt">replace =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1734-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">e_sim =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> u_sim <span class="op">+</span><span class="st"> </span>q_sim, <span class="dt">sd =</span> <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1734-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">w_sim =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> <span class="op">-</span>u_sim <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>e_sim, <span class="dt">sd =</span> <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1734-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">w =</span> <span class="kw">standardize</span>(w_sim),</a>
<a class="sourceLine" id="cb1734-11" data-line-number="11">         <span class="dt">e =</span> <span class="kw">standardize</span>(e_sim),</a>
<a class="sourceLine" id="cb1734-12" data-line-number="12">         <span class="dt">q =</span> <span class="kw">standardize</span>(q_sim))</a>
<a class="sourceLine" id="cb1734-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1734-14" data-line-number="14">dat_sim</a></code></pre></div>
<pre><code>## # A tibble: 500 x 7
##      u_sim q_sim e_sim  w_sim       w       e      q
##      &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
##  1 -0.145      1 1.51   0.809  0.248  -0.575  -1.36 
##  2  0.291      1 0.664  0.396 -0.0563 -1.09   -1.36 
##  3  0.0938     3 2.44  -0.364 -0.615  -0.0185  0.428
##  4 -0.127      3 4.09   0.347 -0.0922  0.978   0.428
##  5 -0.847      4 2.62   0.976  0.370   0.0939  1.32 
##  6  0.141      4 3.54   0.357 -0.0852  0.651   1.32 
##  7  1.54       2 3.65  -0.466 -0.690   0.714  -0.464
##  8  2.74       3 4.91  -1.98  -1.80    1.48    0.428
##  9  1.55       3 4.18  -1.64  -1.55    1.04    0.428
## 10  0.462      1 0.360 -0.461 -0.686  -1.27   -1.36 
## # … with 490 more rows</code></pre>
<p>We’ll use <code>update()</code> to avoid re-compiling the models.</p>
<div class="sourceCode" id="cb1736"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1736-1" data-line-number="1">b14<span class="fl">.4</span>x &lt;-</a>
<a class="sourceLine" id="cb1736-2" data-line-number="2"><span class="st">  </span><span class="kw">update</span>(b14<span class="fl">.4</span>,</a>
<a class="sourceLine" id="cb1736-3" data-line-number="3">         <span class="dt">newdata =</span> dat_sim,</a>
<a class="sourceLine" id="cb1736-4" data-line-number="4">         <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,  </a>
<a class="sourceLine" id="cb1736-5" data-line-number="5">         <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1736-6" data-line-number="6">         <span class="dt">file =</span> <span class="st">&quot;fits/b14.04x&quot;</span>)</a>
<a class="sourceLine" id="cb1736-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1736-8" data-line-number="8">b14<span class="fl">.6</span>x &lt;-</a>
<a class="sourceLine" id="cb1736-9" data-line-number="9"><span class="st">  </span><span class="kw">update</span>(b14<span class="fl">.6</span>,</a>
<a class="sourceLine" id="cb1736-10" data-line-number="10">         <span class="dt">newdata =</span> dat_sim,</a>
<a class="sourceLine" id="cb1736-11" data-line-number="11">         <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,  </a>
<a class="sourceLine" id="cb1736-12" data-line-number="12">         <span class="dt">seed =</span> <span class="dv">14</span>, </a>
<a class="sourceLine" id="cb1736-13" data-line-number="13">         <span class="dt">file =</span> <span class="st">&quot;fits/b14.06x&quot;</span>)</a></code></pre></div>
<p>Just for kicks, let’s examine the results with a coefficient plot.</p>
<div class="sourceCode" id="cb1737"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1737-1" data-line-number="1">text &lt;-</a>
<a class="sourceLine" id="cb1737-2" data-line-number="2"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">Estimate =</span> <span class="kw">c</span>(<span class="kw">fixef</span>(b14<span class="fl">.4</span>x)[<span class="dv">2</span>, <span class="dv">3</span>], <span class="kw">fixef</span>(b14<span class="fl">.6</span>x)[<span class="dv">4</span>, <span class="dv">4</span>]),</a>
<a class="sourceLine" id="cb1737-3" data-line-number="3">         <span class="dt">y        =</span> <span class="kw">c</span>(<span class="fl">4.3</span>, <span class="fl">3.7</span>),</a>
<a class="sourceLine" id="cb1737-4" data-line-number="4">         <span class="dt">hjust    =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1737-5" data-line-number="5">         <span class="dt">fit      =</span> <span class="kw">c</span>(<span class="st">&quot;b14.4x&quot;</span>, <span class="st">&quot;b14.6x&quot;</span>))</a>
<a class="sourceLine" id="cb1737-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1737-7" data-line-number="7"><span class="kw">bind_rows</span>(</a>
<a class="sourceLine" id="cb1737-8" data-line-number="8">  <span class="co"># b_14.4x</span></a>
<a class="sourceLine" id="cb1737-9" data-line-number="9">  <span class="kw">posterior_summary</span>(b14<span class="fl">.4</span>x)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, ] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1737-10" data-line-number="10"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1737-11" data-line-number="11"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">param =</span> <span class="kw">c</span>(<span class="st">&quot;alpha[W]&quot;</span>, <span class="st">&quot;beta[EW]&quot;</span>, <span class="st">&quot;sigma[W]&quot;</span>),</a>
<a class="sourceLine" id="cb1737-12" data-line-number="12">           <span class="dt">fit =</span> <span class="st">&quot;b14.4x&quot;</span>),</a>
<a class="sourceLine" id="cb1737-13" data-line-number="13">  <span class="co"># b_14.6x</span></a>
<a class="sourceLine" id="cb1737-14" data-line-number="14">  <span class="kw">posterior_summary</span>(b14<span class="fl">.6</span>x)[<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>, ] <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb1737-15" data-line-number="15"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1737-16" data-line-number="16"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">param =</span> <span class="kw">c</span>(<span class="st">&quot;alpha[E]&quot;</span>, <span class="st">&quot;alpha[W]&quot;</span>, <span class="st">&quot;beta[QE]&quot;</span>, <span class="st">&quot;beta[EW]&quot;</span>, <span class="st">&quot;sigma[E]&quot;</span>, <span class="st">&quot;sigma[W]&quot;</span>, <span class="st">&quot;rho&quot;</span>),</a>
<a class="sourceLine" id="cb1737-17" data-line-number="17">           <span class="dt">fit =</span> <span class="st">&quot;b14.6x&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1737-18" data-line-number="18"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">param =</span> <span class="kw">factor</span>(param,</a>
<a class="sourceLine" id="cb1737-19" data-line-number="19">                        <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;rho&quot;</span>, <span class="st">&quot;sigma[W]&quot;</span>, <span class="st">&quot;sigma[E]&quot;</span>, <span class="st">&quot;beta[EW]&quot;</span>, <span class="st">&quot;beta[QE]&quot;</span>, <span class="st">&quot;alpha[W]&quot;</span>, <span class="st">&quot;alpha[E]&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1737-20" data-line-number="20"><span class="st">  </span></a>
<a class="sourceLine" id="cb1737-21" data-line-number="21"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> param, <span class="dt">y =</span> Estimate, <span class="dt">color =</span> fit)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1737-22" data-line-number="22"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#E8DCCF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1737-23" data-line-number="23"><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> Q2<span class="fl">.5</span>, <span class="dt">ymax =</span> Q97<span class="fl">.5</span>),</a>
<a class="sourceLine" id="cb1737-24" data-line-number="24">                  <span class="dt">fatten =</span> <span class="dv">2</span>, <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">0.5</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1737-25" data-line-number="25"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> text,</a>
<a class="sourceLine" id="cb1737-26" data-line-number="26">            <span class="kw">aes</span>(<span class="dt">x =</span> y, <span class="dt">label =</span> fit, <span class="dt">hjust =</span> hjust)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1737-27" data-line-number="27"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">labels =</span> ggplot2<span class="op">:::</span>parse_safe) <span class="op">+</span></a>
<a class="sourceLine" id="cb1737-28" data-line-number="28"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="ot">NULL</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#E7CDC2&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1737-29" data-line-number="29"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;marginal posterior&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1737-30" data-line-number="30"><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb1737-31" data-line-number="31"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1737-32" data-line-number="32">        <span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1737-33" data-line-number="33">        <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-41-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>With the help from <code>b14.6x</code>, we found “that <span class="math inline">\(E\)</span> and <span class="math inline">\(W\)</span> have a negative correlation in their residual variance, because the confound positively influences one and negatively influences the other” (p. 459).</p>
<p>One can use the <code>dagitty()</code> and <code>instrumentalVariables()</code> functions from the <strong>dagitty</strong> package to first define a DAG and then query whether there are instrumental variables for a given exposure and outcome.</p>
<div class="sourceCode" id="cb1738"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1738-1" data-line-number="1"><span class="kw">library</span>(dagitty)</a>
<a class="sourceLine" id="cb1738-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1738-3" data-line-number="3">dagIV &lt;-<span class="st"> </span><span class="kw">dagitty</span>(<span class="st">&quot;dag{Q -&gt; E &lt;- U -&gt; W &lt;- E}&quot;</span>)</a>
<a class="sourceLine" id="cb1738-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1738-5" data-line-number="5"><span class="kw">instrumentalVariables</span>(dagIV, <span class="dt">exposure =</span> <span class="st">&quot;E&quot;</span>, <span class="dt">outcome =</span> <span class="st">&quot;W&quot;</span>)</a></code></pre></div>
<pre><code>##  Q</code></pre>
<blockquote>
<p>The hardest thing about instrumental variables is believing in any particular instrument. If you believe in your DAG, they are easy to believe. But should you believe in your DAG?…</p>
<p>In general, it is not possible to statistically prove whether a variable is a good instrument. As always, we need scientific knowledge outside of the data to make sense of the data. (p. 460)</p>
</blockquote>
</div>
<div id="other-designs." class="section level3">
<h3><span class="header-section-number">14.3.2</span> Other designs.</h3>
<blockquote>
<p>There are potentially many ways to find natural experiments. Not all of them are strictly instrumental variables. But they can provide theoretically correct designs for causal inference, if you can believe the assumptions. Let’s consider two more.</p>
<p>In addition to the backdoor criterion you met in Chapter 6, there is something called the <strong>front-door criterion</strong>. (p. 460, <strong>emphasis</strong> in the original)</p>
</blockquote>
<p>To get a sense of the front-door criterion, consider the following DAG with observed variables <span class="math inline">\(X\)</span>, <span class="math inline">\(Y\)</span>, and <span class="math inline">\(Z\)</span> and an unobserved variable, <span class="math inline">\(U\)</span>.</p>
<div class="sourceCode" id="cb1740"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1740-1" data-line-number="1">dag_coords &lt;-</a>
<a class="sourceLine" id="cb1740-2" data-line-number="2"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">name =</span> <span class="kw">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Z&quot;</span>, <span class="st">&quot;U&quot;</span>, <span class="st">&quot;Y&quot;</span>),</a>
<a class="sourceLine" id="cb1740-3" data-line-number="3">         <span class="dt">x    =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1740-4" data-line-number="4">         <span class="dt">y    =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb1740-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1740-6" data-line-number="6"><span class="kw">dagify</span>(X <span class="op">~</span><span class="st"> </span>U,</a>
<a class="sourceLine" id="cb1740-7" data-line-number="7">       Z <span class="op">~</span><span class="st"> </span>X,</a>
<a class="sourceLine" id="cb1740-8" data-line-number="8">       Y <span class="op">~</span><span class="st"> </span>U <span class="op">+</span><span class="st"> </span>Z,</a>
<a class="sourceLine" id="cb1740-9" data-line-number="9">       <span class="dt">coords =</span> dag_coords) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1740-10" data-line-number="10"><span class="st">  </span></a>
<a class="sourceLine" id="cb1740-11" data-line-number="11"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">xend =</span> xend, <span class="dt">yend =</span> yend)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1740-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_dag_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> name <span class="op">==</span><span class="st"> &quot;U&quot;</span>),</a>
<a class="sourceLine" id="cb1740-13" data-line-number="13">                 <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">stroke =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">6</span>, <span class="dt">show.legend =</span> F) <span class="op">+</span></a>
<a class="sourceLine" id="cb1740-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_dag_text</span>(<span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1740-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_dag_edges</span>(<span class="dt">edge_colour =</span> <span class="st">&quot;#FCF9F0&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1740-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#EEDA9D&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1740-17" data-line-number="17"><span class="st">  </span><span class="kw">theme_pearl_dag</span>()</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-43-1.png" width="288" style="display: block; margin: auto;" /></p>
<blockquote>
<p>We are interested, as usual, in the causal influence of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>. But there is an unobserved confound <span class="math inline">\(U\)</span>, again as usual. It turns out that, if we can find a perfect mediator <span class="math inline">\(Z\)</span>, then we can possibly estimate the causal effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>. It isn’t crazy to think that causes are mediated by other causes. Everything has a mechanism. <span class="math inline">\(Z\)</span> in the DAG above is such a mechanism. If you have a believable <span class="math inline">\(Z\)</span> variable, then the causal effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> is estimated by expressing the generative model as a statistical model, similar to the instrumental variable example before. (p. 461)</p>
</blockquote>
<p>McElreath’s second example is the <strong>regression discontinuity</strong> approach. If you have a time series where the variable of interest is measured before and after some relevant intervention variable, you can estimate intercepts and slopes before and after the intervention, the cuttoff. However,</p>
<blockquote>
<p>in practice, one trend is fit for individuals above the cutoff and another to those below the cutoff. Then an estimate of the causal effect is the average difference between individuals just above and just below the cutoff. While the difference near the cuttoff if of interest, the entire function influences this difference. So some care is needed in choosing functions for the overall relationship between the exposure and the outcome. (p. 461)</p>
</blockquote>
<p>McElreath’s not kidding about the need for care when fitting regression discontinuity models. Gleman’s blog is littered with awful examples (e.g., <a href="https://statmodeling.stat.columbia.edu/2019/06/25/another-regression-discontinuity-disaster-and-what-can-we-learn-from-it/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2018/08/02/38160/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2020/07/02/no-i-dont-believe-that-claim-based-on-regression-discontinuity-analysis-that/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2020/01/13/how-to-get-out-of-the-credulity-rut-regression-discontinuity-edition-getting-beyond-whack-a-mole/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2020/07/18/please-socially-distance-me-from-this-regression-model/">here</a>). See also Gelman and Imbens’ <span class="citation">(<a href="#ref-gelmanWhyHighorderPolynomials2019">2019</a>)</span> paper, <a href="https://amstat.tandfonline.com/doi/pdf/10.1080/07350015.2017.1366909?needAccess=true"><em>Why high-order polynomials should not be used in regression discontinuity designs</em></a>.</p>
</div>
</div>
<div id="social-relations-as-correlated-varying-effects" class="section level2">
<h2><span class="header-section-number">14.4</span> Social relations as correlated varying effects</h2>
<p>It looks like <strong>brms</strong> is not set up to fit a model like this, at this time. See the <a href="https://discourse.mc-stan.org/t/social-relations-model-srm/17121">Social relations model (SRM) thread</a> on the Stan Forums and <a href="https://github.com/paul-buerkner/brms/issues/502">issue #502</a> on the <strong>brms</strong> GitHub repo for details. In short, the difficulty is <strong>brms</strong> is not set up to allow covariances among distinct random effects with the same levels and it looks like this will not change any time soon. So, in this section we will fit the model with <strong>rethinking</strong>, but still use <strong>ggplot2</strong> and friends in the post processing.</p>
<p>Let’s load the <code>kl_dyads</code> data <span class="citation">(Koster &amp; Leckie, <a href="#ref-kosterFoodSharingNetworks2014">2014</a>)</span>.</p>
<div class="sourceCode" id="cb1741"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1741-1" data-line-number="1"><span class="kw">library</span>(rethinking)</a>
<a class="sourceLine" id="cb1741-2" data-line-number="2"><span class="kw">data</span>(KosterLeckie)</a></code></pre></div>
<p>Take a look at the data.</p>
<div class="sourceCode" id="cb1742"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1742-1" data-line-number="1">kl_dyads <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">glimpse</span>()</a></code></pre></div>
<pre><code>## Rows: 300
## Columns: 13
## $ hidA    &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2…
## $ hidB    &lt;int&gt; 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 3, …
## $ did     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, …
## $ giftsAB &lt;int&gt; 0, 6, 2, 4, 8, 2, 1, 0, 10, 1, 0, 0, 1, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 1, 2, 0, 3, 0, 43…
## $ giftsBA &lt;int&gt; 4, 31, 5, 2, 2, 1, 2, 1, 110, 0, 0, 6, 11, 0, 1, 4, 0, 2, 0, 7, 0, 13, 0, 2, 3, 1, 1, 0, 1,…
## $ offset  &lt;dbl&gt; 0.000, -0.003, -0.019, 0.000, -0.003, 0.000, 0.000, 0.000, -0.186, 0.000, -0.471, -0.019, -…
## $ drel1   &lt;int&gt; 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1…
## $ drel2   &lt;int&gt; 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0…
## $ drel3   &lt;int&gt; 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0…
## $ drel4   &lt;int&gt; 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ dlndist &lt;dbl&gt; -2.790, -2.817, -1.886, -1.892, -3.499, -1.853, -1.475, -1.644, -1.897, -2.379, -2.200, -2.…
## $ dass    &lt;dbl&gt; 0.000, 0.044, 0.025, 0.011, 0.022, 0.071, 0.046, 0.003, 0.552, 0.018, 0.004, 0.004, 0.036, …
## $ d0125   &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0…</code></pre>
<div class="sourceCode" id="cb1744"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1744-1" data-line-number="1"><span class="co"># kl_households %&gt;% glimpse()</span></a></code></pre></div>
<p>“The variables <code>hidA</code> and <code>hidB</code> tell us the household IDs in each dyad, and <code>did</code> is a unique dyad ID number” (p. 462). To get a sense of the interrelation among those three ID variables, we’ll make a tile plot.</p>
<div class="sourceCode" id="cb1745"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1745-1" data-line-number="1">kl_dyads <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1745-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> hidA, <span class="dt">y =</span> hidB, <span class="dt">label =</span> did)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1745-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> did),</a>
<a class="sourceLine" id="cb1745-4" data-line-number="4">            <span class="dt">show.legend =</span> F) <span class="op">+</span></a>
<a class="sourceLine" id="cb1745-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">size =</span> <span class="fl">2.25</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1745-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">24</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>, <span class="dt">color =</span> <span class="st">&quot;#394165&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1745-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">25</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>, <span class="dt">color =</span> <span class="st">&quot;#394165&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1745-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="dt">low =</span> <span class="st">&quot;#DCA258&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#EEDA9D&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="ot">NA</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1745-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">24</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1745-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">25</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1745-11" data-line-number="11"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">9</span>),</a>
<a class="sourceLine" id="cb1745-12" data-line-number="12">        <span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-46-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>The orange/yellow gradient fill is a little silly, but I couldn’t stop myself. Here is our version of Figure 14.8, the bivariate distribution of dyadic gifts, collapsing across dyads.</p>
<div class="sourceCode" id="cb1746"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1746-1" data-line-number="1">kl_dyads <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1746-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> giftsAB, <span class="dt">y =</span> giftsBA)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1746-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">70</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1746-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>, <span class="dt">linetype =</span> <span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1746-5" data-line-number="5"><span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="dt">low =</span> <span class="st">&quot;#E7CDC2&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="ot">NA</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1746-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;gifts household A to household B&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">113</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1746-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;gifts from B to A&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">113</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1746-8" data-line-number="8"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Distribution of dyadic gifts&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1746-9" data-line-number="9"><span class="st">  </span><span class="kw">coord_equal</span>()</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-47-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Here’s the overall Pearson’s correlation coefficient, collapsing across grouping levels.</p>
<div class="sourceCode" id="cb1747"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1747-1" data-line-number="1"><span class="kw">cor</span>(kl_dyads<span class="op">$</span>giftsAB, kl_dyads<span class="op">$</span>giftsBA) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a></code></pre></div>
<pre><code>## [1] 0.239</code></pre>
<p>However, it would be a mistake to take this correlation seriously. It is a disentangled mixture of various kinds of associations, none of which are guaranteed to be even close to <span class="math inline">\(r = .24\)</span>. Remember this as we move along with the analyses and let the consequences burn a methodological mark into your soul.</p>
<div class="sourceCode" id="cb1749"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1749-1" data-line-number="1">kl_data &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1749-2" data-line-number="2"><span class="st">  </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb1749-3" data-line-number="3">    <span class="dt">N            =</span> <span class="kw">nrow</span>(kl_dyads),</a>
<a class="sourceLine" id="cb1749-4" data-line-number="4">    <span class="dt">N_households =</span> <span class="kw">max</span>(kl_dyads<span class="op">$</span>hidB), </a>
<a class="sourceLine" id="cb1749-5" data-line-number="5">    <span class="dt">did          =</span> kl_dyads<span class="op">$</span>did,</a>
<a class="sourceLine" id="cb1749-6" data-line-number="6">    <span class="dt">hidA         =</span> kl_dyads<span class="op">$</span>hidA,</a>
<a class="sourceLine" id="cb1749-7" data-line-number="7">    <span class="dt">hidB         =</span> kl_dyads<span class="op">$</span>hidB,</a>
<a class="sourceLine" id="cb1749-8" data-line-number="8">    <span class="dt">giftsAB      =</span> kl_dyads<span class="op">$</span>giftsAB, </a>
<a class="sourceLine" id="cb1749-9" data-line-number="9">    <span class="dt">giftsBA      =</span> kl_dyads<span class="op">$</span>giftsBA</a>
<a class="sourceLine" id="cb1749-10" data-line-number="10">  )</a>
<a class="sourceLine" id="cb1749-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1749-12" data-line-number="12">m14<span class="fl">.7</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1749-13" data-line-number="13"><span class="st">  </span><span class="kw">ulam</span>( </a>
<a class="sourceLine" id="cb1749-14" data-line-number="14">    <span class="kw">alist</span>(</a>
<a class="sourceLine" id="cb1749-15" data-line-number="15">      giftsAB <span class="op">~</span><span class="st"> </span><span class="kw">poisson</span>(lambdaAB),</a>
<a class="sourceLine" id="cb1749-16" data-line-number="16">      giftsBA <span class="op">~</span><span class="st"> </span><span class="kw">poisson</span>(lambdaBA),</a>
<a class="sourceLine" id="cb1749-17" data-line-number="17">      <span class="kw">log</span>(lambdaAB) &lt;-<span class="st"> </span>a <span class="op">+</span><span class="st"> </span>gr[hidA, <span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>gr[hidB, <span class="dv">2</span>] <span class="op">+</span><span class="st"> </span>d[did, <span class="dv">1</span>] , </a>
<a class="sourceLine" id="cb1749-18" data-line-number="18">      <span class="kw">log</span>(lambdaBA) &lt;-<span class="st"> </span>a <span class="op">+</span><span class="st"> </span>gr[hidB, <span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>gr[hidA, <span class="dv">2</span>] <span class="op">+</span><span class="st"> </span>d[did, <span class="dv">2</span>] , </a>
<a class="sourceLine" id="cb1749-19" data-line-number="19">      a <span class="op">~</span><span class="st"> </span><span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1749-20" data-line-number="20">      </a>
<a class="sourceLine" id="cb1749-21" data-line-number="21">      <span class="co">## gr matrix of varying effects</span></a>
<a class="sourceLine" id="cb1749-22" data-line-number="22">      vector[<span class="dv">2</span>]<span class="op">:</span>gr[N_households] <span class="op">~</span><span class="st"> </span><span class="kw">multi_normal</span>(<span class="dv">0</span>, Rho_gr, sigma_gr), </a>
<a class="sourceLine" id="cb1749-23" data-line-number="23">      Rho_gr <span class="op">~</span><span class="st"> </span><span class="kw">lkj_corr</span>(<span class="dv">4</span>),</a>
<a class="sourceLine" id="cb1749-24" data-line-number="24">      sigma_gr <span class="op">~</span><span class="st"> </span><span class="kw">exponential</span>(<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1749-25" data-line-number="25">      </a>
<a class="sourceLine" id="cb1749-26" data-line-number="26">      <span class="co">## dyad effects</span></a>
<a class="sourceLine" id="cb1749-27" data-line-number="27">      transpars<span class="op">&gt;</span><span class="st"> </span>matrix[N,<span class="dv">2</span>]<span class="op">:</span>d &lt;-</a>
<a class="sourceLine" id="cb1749-28" data-line-number="28"><span class="st">        </span><span class="kw">compose_noncentered</span>(<span class="kw">rep_vector</span>(sigma_d, <span class="dv">2</span>), L_Rho_d, z), </a>
<a class="sourceLine" id="cb1749-29" data-line-number="29">      matrix[<span class="dv">2</span>,N]<span class="op">:</span>z <span class="op">~</span><span class="st"> </span><span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1749-30" data-line-number="30">      cholesky_factor_corr[<span class="dv">2</span>]<span class="op">:</span>L_Rho_d <span class="op">~</span><span class="st"> </span><span class="kw">lkj_corr_cholesky</span>(<span class="dv">8</span>), </a>
<a class="sourceLine" id="cb1749-31" data-line-number="31">      sigma_d <span class="op">~</span><span class="st"> </span><span class="kw">exponential</span>(<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1749-32" data-line-number="32">      </a>
<a class="sourceLine" id="cb1749-33" data-line-number="33">      <span class="co">## compute correlation matrix for dyads</span></a>
<a class="sourceLine" id="cb1749-34" data-line-number="34">      gq<span class="op">&gt;</span><span class="st"> </span>matrix[<span class="dv">2</span>, <span class="dv">2</span>]<span class="op">:</span>Rho_d &lt;&lt;-<span class="st"> </span><span class="kw">Chol_to_Corr</span>(L_Rho_d)</a>
<a class="sourceLine" id="cb1749-35" data-line-number="35">    ), </a>
<a class="sourceLine" id="cb1749-36" data-line-number="36">    <span class="dt">data =</span> kl_data, </a>
<a class="sourceLine" id="cb1749-37" data-line-number="37">    <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">iter =</span> <span class="dv">2000</span></a>
<a class="sourceLine" id="cb1749-38" data-line-number="38">  )</a></code></pre></div>
<p>We don’t get a lot of information from the default <code>precis()</code> output for this model, but at least we’ll get a summary for <span class="math inline">\(\alpha\)</span>.</p>
<div class="sourceCode" id="cb1750"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1750-1" data-line-number="1"><span class="kw">precis</span>(m14<span class="fl">.7</span>)</a></code></pre></div>
<pre><code>## 1264 vector or matrix parameters hidden. Use depth=2 to show them.</code></pre>
<pre><code>##              mean         sd      5.5%     94.5%     n_eff    Rhat4
## a       0.5425828 0.17069448 0.2788992 0.8200983  633.0907 1.003374
## sigma_d 1.1008880 0.05684433 1.0139311 1.1948653 1106.7396 1.000834</code></pre>
<p>One of the interesting things about this model is we only have one <span class="math inline">\(\alpha\)</span> parameter for two criterion variables. This makes <span class="math inline">\(\alpha\)</span> like the grand mean of counts. Here is a focused look at the <code>precis()</code> output when you set <code>depth = 3</code>.</p>
<div class="sourceCode" id="cb1753"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1753-1" data-line-number="1"><span class="kw">precis</span>(m14<span class="fl">.7</span>, <span class="dt">depth =</span> <span class="dv">3</span>, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;Rho_gr&quot;</span>, <span class="st">&quot;sigma_gr&quot;</span>))</a></code></pre></div>
<pre><code>##                   mean           sd       5.5%       94.5%    n_eff     Rhat4
## Rho_gr[1,1]  1.0000000 0.000000e+00  1.0000000  1.00000000      NaN       NaN
## Rho_gr[1,2] -0.4043048 1.971661e-01 -0.6909339 -0.07675351 1335.866 1.0004850
## Rho_gr[2,1] -0.4043048 1.971661e-01 -0.6909339 -0.07675351 1335.866 1.0004850
## Rho_gr[2,2]  1.0000000 8.296194e-17  1.0000000  1.00000000 3692.386 0.9989995
## sigma_gr[1]  0.8303181 1.384847e-01  0.6399042  1.06842157 1860.543 1.0012698
## sigma_gr[2]  0.4214374 9.036310e-02  0.2870140  0.57051380 1060.689 1.0014661</code></pre>
<p>These are the posterior summaries for the part of the model McElreath defined in the middle of page 463,</p>
<p><span class="math display">\[
\begin{bmatrix} g_i \\ r_i \end{bmatrix} \sim \operatorname{MVNormal}\begin{pmatrix} \begin{bmatrix} 0 \\ 0 \end{bmatrix}, \begin{bmatrix} \sigma_g^2 &amp; \sigma_g \sigma_r \rho_{gr} \\ \sigma_g \sigma_r \rho_{rg} &amp; \sigma_r^2 \end{bmatrix} \end{pmatrix},
\]</span></p>
<p>the population of household effects. But as per usual with Stan, the variance parameters are expressed in a <span class="math inline">\(\sigma\)</span> metric. Also, <code>rethinking::precis()</code> returned the summary for <span class="math inline">\(\rho_{gr}\)</span> in matrix form,</p>
<p><span class="math display">\[
\begin{bmatrix} 1 &amp; \rho_{gr} \\ \rho_{rg} &amp; 1 \end{bmatrix},
\]</span></p>
<p>where <span class="math inline">\(\rho_{gr} = \rho_{rg}\)</span>. The correlation is negative. Let’s view <span class="math inline">\(\sigma_g\)</span>, <span class="math inline">\(\sigma_r\)</span>, and their correlation in a plot.</p>
<div class="sourceCode" id="cb1755"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1755-1" data-line-number="1">post &lt;-<span class="st"> </span><span class="kw">extract.samples</span>(m14<span class="fl">.7</span>)</a>
<a class="sourceLine" id="cb1755-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1755-3" data-line-number="3"><span class="kw">tibble</span>(<span class="st">`</span><span class="dt">sigma[italic(g)]</span><span class="st">`</span>          =<span class="st"> </span>post<span class="op">$</span>sigma_gr[, <span class="dv">1</span>],</a>
<a class="sourceLine" id="cb1755-4" data-line-number="4">       <span class="st">`</span><span class="dt">sigma[italic(r)]</span><span class="st">`</span>          =<span class="st"> </span>post<span class="op">$</span>sigma_gr[, <span class="dv">2</span>],</a>
<a class="sourceLine" id="cb1755-5" data-line-number="5">       <span class="st">`</span><span class="dt">rho[italic(g)][italic(r)]</span><span class="st">`</span> =<span class="st"> </span>post<span class="op">$</span>Rho_gr[, <span class="dv">2</span>, <span class="dv">1</span>]) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1755-6" data-line-number="6"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1755-7" data-line-number="7"><span class="st">  </span></a>
<a class="sourceLine" id="cb1755-8" data-line-number="8"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> name, <span class="dt">fill =</span> name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1755-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1755-10" data-line-number="10"><span class="st">  </span><span class="kw">stat_halfeye</span>(<span class="dt">.width =</span> <span class="fl">.89</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1755-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="ot">NULL</span>, <span class="dt">labels =</span> ggplot2<span class="op">:::</span>parse_safe) <span class="op">+</span></a>
<a class="sourceLine" id="cb1755-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#EEDA9D&quot;</span>, <span class="st">&quot;#DCA258&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1755-13" data-line-number="13"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;marginal posterior&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1755-14" data-line-number="14"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(<span class="fl">1.5</span>, <span class="fl">3.5</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1755-15" data-line-number="15"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-52-1.png" width="432" style="display: block; margin: auto;" /></p>
<p>“This implies that individuals who give more across all dyads tend to receive less[, and ] clear evidence that rates of giving are more variable than rates of receiving” (p. 465). McElreath suggested we “try <code>plot(exp(g[,1]),exp(r[,1]))</code> for example to show the posterior distribution of giving/receiving for household number 1” (p. 465). Here’s a <strong>tidyverse</strong> version of that plot.</p>
<div class="sourceCode" id="cb1756"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1756-1" data-line-number="1">g &lt;-<span class="st"> </span><span class="kw">sapply</span>( <span class="dv">1</span><span class="op">:</span><span class="dv">25</span> , <span class="cf">function</span>(i) post<span class="op">$</span>a <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>gr[,i,<span class="dv">1</span>] ) </a>
<a class="sourceLine" id="cb1756-2" data-line-number="2">r &lt;-<span class="st"> </span><span class="kw">sapply</span>( <span class="dv">1</span><span class="op">:</span><span class="dv">25</span> , <span class="cf">function</span>(i) post<span class="op">$</span>a <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>gr[,i,<span class="dv">2</span>] ) </a>
<a class="sourceLine" id="cb1756-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1756-4" data-line-number="4"><span class="kw">tibble</span>(<span class="dt">g =</span> <span class="kw">exp</span>(g[, <span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb1756-5" data-line-number="5">       <span class="dt">r =</span> <span class="kw">exp</span>(r[, <span class="dv">1</span>])) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1756-6" data-line-number="6"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> g, <span class="dt">y =</span> r)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1756-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span><span class="st"> </span><span class="co"># white &quot;#FCF9F0&quot; # gold &quot;#B1934A&quot;</span></a>
<a class="sourceLine" id="cb1756-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">&quot;#B1934A&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1756-9" data-line-number="9"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="fl">.5</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1756-10" data-line-number="10"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="fl">.9</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1756-11" data-line-number="11"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="kw">expression</span>(giving[<span class="kw">italic</span>(i)<span class="op">==</span><span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb1756-12" data-line-number="12">       <span class="dt">y =</span> <span class="kw">expression</span>(receiving[<span class="kw">italic</span>(i)<span class="op">==</span><span class="dv">1</span>])) <span class="op">+</span></a>
<a class="sourceLine" id="cb1756-13" data-line-number="13"><span class="st">  </span><span class="kw">coord_equal</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">5</span>),</a>
<a class="sourceLine" id="cb1756-14" data-line-number="14">              <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">5</span>))</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-53-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The gold dots are the bivariate posterior draws and the two blue ellipses mark off the 50% and 90% intervals, presuming a bivariate Gaussian distribution. Here’s a programmatic way to make our version of Figure 14.9.a.</p>
<div class="sourceCode" id="cb1757"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1757-1" data-line-number="1"><span class="kw">rbind</span>(<span class="kw">exp</span>(g), <span class="kw">exp</span>(r)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1757-2" data-line-number="2"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1757-3" data-line-number="3"><span class="st">  </span><span class="kw">set_names</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">25</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1757-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parameter =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;g&quot;</span>, <span class="st">&quot;r&quot;</span>), <span class="dt">each =</span> <span class="kw">n</span>() <span class="op">/</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1757-5" data-line-number="5">         <span class="dt">iter      =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4000</span>, <span class="dt">times =</span> <span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1757-6" data-line-number="6"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span><span class="kw">c</span>(parameter, iter),</a>
<a class="sourceLine" id="cb1757-7" data-line-number="7">               <span class="dt">names_to =</span> <span class="st">&quot;household&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1757-8" data-line-number="8"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> parameter,</a>
<a class="sourceLine" id="cb1757-9" data-line-number="9">              <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1757-10" data-line-number="10"><span class="st">  </span><span class="kw">group_by</span>(household) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1757-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">mu_g =</span> <span class="kw">mean</span>(g),</a>
<a class="sourceLine" id="cb1757-12" data-line-number="12">         <span class="dt">mu_r =</span> <span class="kw">mean</span>(r)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1757-13" data-line-number="13"><span class="st">  </span><span class="kw">nest</span>(<span class="dt">data =</span> <span class="kw">c</span>(<span class="st">&quot;g&quot;</span>, <span class="st">&quot;r&quot;</span>, <span class="st">&quot;iter&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1757-14" data-line-number="14"><span class="st">  </span></a>
<a class="sourceLine" id="cb1757-15" data-line-number="15"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">group =</span> household)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1757-16" data-line-number="16"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1757-17" data-line-number="17"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">data =</span> . <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unnest</span>(data),</a>
<a class="sourceLine" id="cb1757-18" data-line-number="18">               <span class="kw">aes</span>(<span class="dt">x =</span> g, <span class="dt">y =</span> r),</a>
<a class="sourceLine" id="cb1757-19" data-line-number="19">               <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="fl">.5</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1757-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> mu_g, <span class="dt">y =</span> mu_r),</a>
<a class="sourceLine" id="cb1757-21" data-line-number="21">             <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1757-22" data-line-number="22"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;generalized giving&quot;</span>,</a>
<a class="sourceLine" id="cb1757-23" data-line-number="23">       <span class="dt">y =</span> <span class="st">&quot;generalized receiving&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1757-24" data-line-number="24"><span class="st">  </span><span class="kw">coord_equal</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">8.5</span>),</a>
<a class="sourceLine" id="cb1757-25" data-line-number="25">              <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">8.5</span>))</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-54-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Here is a look at the covariance matrix for the dyadic effects, the posterior summaries for the part of the model McElreath defined in the middle of page 463 as,</p>
<p><span class="math display">\[
\begin{bmatrix} d_{ij} \\ d_{ji} \end{bmatrix} \sim \operatorname{MVNormal}\begin{pmatrix} \begin{bmatrix} 0 \\ 0 \end{bmatrix}, \begin{bmatrix} \sigma_d^2 &amp; \sigma_d^2 \rho_d \\ \sigma_d^2 \rho_d &amp; \sigma_d^2 \end{bmatrix} \end{pmatrix},
\]</span></p>
<p>where there is only one standard deviation parameter <span class="math inline">\(\sigma_d\)</span> because the labels for each dyad are arbitrary.</p>
<div class="sourceCode" id="cb1758"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1758-1" data-line-number="1"><span class="kw">precis</span>(m14<span class="fl">.7</span>, <span class="dt">depth =</span> <span class="dv">3</span>, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;Rho_d&quot;</span>, <span class="st">&quot;sigma_d&quot;</span>))</a></code></pre></div>
<pre><code>##                 mean         sd      5.5%     94.5%    n_eff    Rhat4
## Rho_d[1,1] 1.0000000 0.00000000 1.0000000 1.0000000      NaN      NaN
## Rho_d[1,2] 0.8812754 0.03313453 0.8234015 0.9294063 1039.922 1.005997
## Rho_d[2,1] 0.8812754 0.03313453 0.8234015 0.9294063 1039.922 1.005997
## Rho_d[2,2] 1.0000000 0.00000000 1.0000000 1.0000000      NaN      NaN
## sigma_d    1.1008880 0.05684433 1.0139311 1.1948653 1106.740 1.000834</code></pre>
<p>Here they are in a plot.</p>
<div class="sourceCode" id="cb1760"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1760-1" data-line-number="1"><span class="kw">tibble</span>(<span class="st">`</span><span class="dt">sigma[italic(d)]</span><span class="st">`</span> =<span class="st"> </span>post<span class="op">$</span>sigma_d,</a>
<a class="sourceLine" id="cb1760-2" data-line-number="2">       <span class="st">`</span><span class="dt">rho[italic(d)]</span><span class="st">`</span>   =<span class="st"> </span>post<span class="op">$</span>Rho_d[, <span class="dv">2</span>, <span class="dv">1</span>]) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1760-3" data-line-number="3"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1760-4" data-line-number="4"><span class="st">  </span></a>
<a class="sourceLine" id="cb1760-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> name, <span class="dt">fill =</span> name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1760-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1760-7" data-line-number="7"><span class="st">  </span><span class="kw">stat_halfeye</span>(<span class="dt">.width =</span> <span class="fl">.89</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1760-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="ot">NULL</span>, <span class="dt">labels =</span> ggplot2<span class="op">:::</span>parse_safe) <span class="op">+</span></a>
<a class="sourceLine" id="cb1760-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#A65141&quot;</span>, <span class="st">&quot;#B1934A&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1760-10" data-line-number="10"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;marginal posterior&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1760-11" data-line-number="11"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(<span class="fl">1.5</span>, <span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1760-12" data-line-number="12"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-56-1.png" width="432" style="display: block; margin: auto;" /></p>
<p>“The correlation here is positive and strong. And there is more variation among dyads than there is among household in giving rates” (p. 467). Now make the right hand panel of Figure 14.9.</p>
<div class="sourceCode" id="cb1761"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1761-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">dy1 =</span> <span class="kw">apply</span>(post<span class="op">$</span>d[, , <span class="dv">1</span>], <span class="dv">2</span>, mean),</a>
<a class="sourceLine" id="cb1761-2" data-line-number="2">       <span class="dt">dy2 =</span> <span class="kw">apply</span>(post<span class="op">$</span>d[, , <span class="dv">2</span>], <span class="dv">2</span>, mean)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1761-3" data-line-number="3"><span class="st">  </span></a>
<a class="sourceLine" id="cb1761-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> dy1, <span class="dt">y =</span> dy2)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1761-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1761-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1761-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1761-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1761-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">x =</span> <span class="kw">mean</span>(post<span class="op">$</span>d[, <span class="dv">1</span>, <span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb1761-10" data-line-number="10">            <span class="dt">y =</span> <span class="kw">mean</span>(post<span class="op">$</span>d[, <span class="dv">1</span>, <span class="dv">2</span>]),</a>
<a class="sourceLine" id="cb1761-11" data-line-number="11">            <span class="dt">label =</span> <span class="st">&quot;1&quot;</span>,</a>
<a class="sourceLine" id="cb1761-12" data-line-number="12">            <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1761-13" data-line-number="13"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;household A in dyad&quot;</span>,</a>
<a class="sourceLine" id="cb1761-14" data-line-number="14">       <span class="dt">y =</span> <span class="st">&quot;household B in dyad&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1761-15" data-line-number="15"><span class="st">  </span><span class="kw">coord_equal</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="fl">3.5</span>),</a>
<a class="sourceLine" id="cb1761-16" data-line-number="16">              <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="fl">3.5</span>))</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-57-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>As McElreath pointed out, each dot is the posterior mean for one of the 300 levels of <code>did</code>. Do you see the yellow #1 toward the middle? It’s marking off the posterior mean for <code>did == 1</code>. To give a better sense of the uncertainty in each of the levels of <code>did</code>, here is the full bivariate distribution for <code>did == 1</code>.</p>
<div class="sourceCode" id="cb1762"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1762-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">dy1 =</span> post<span class="op">$</span>d[, <span class="dv">1</span>, <span class="dv">1</span>],</a>
<a class="sourceLine" id="cb1762-2" data-line-number="2">       <span class="dt">dy2 =</span> post<span class="op">$</span>d[, <span class="dv">1</span>, <span class="dv">2</span>]) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1762-3" data-line-number="3"><span class="st">  </span></a>
<a class="sourceLine" id="cb1762-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> dy1, <span class="dt">y =</span> dy2)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1762-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1762-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1762-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1762-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1762-9" data-line-number="9"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="fl">.5</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1762-10" data-line-number="10"><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="fl">.9</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1762-11" data-line-number="11"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="kw">expression</span>(<span class="st">&quot;household A in dyad&quot;</span>[<span class="kw">italic</span>(i)<span class="op">==</span><span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb1762-12" data-line-number="12">       <span class="dt">y =</span> <span class="kw">expression</span>(<span class="st">&quot;household B in dyad&quot;</span>[<span class="kw">italic</span>(i)<span class="op">==</span><span class="dv">1</span>])) <span class="op">+</span></a>
<a class="sourceLine" id="cb1762-13" data-line-number="13"><span class="st">  </span><span class="kw">coord_equal</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="fl">3.5</span>),</a>
<a class="sourceLine" id="cb1762-14" data-line-number="14">              <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="fl">3.5</span>))</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-58-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The two yellow ellipses mark off the 50% and 90% intervals, again presuming a bivariate Gaussian distribution for the posterior.</p>
</div>
<div id="continuous-categories-and-the-gaussian-process" class="section level2">
<h2><span class="header-section-number">14.5</span> Continuous categories and the Gaussian process</h2>
<blockquote>
<p>There is a way to apply the varying effects approach to continuous categories… The general approach is known as <strong>Gaussian process regression</strong>. This name is unfortunately wholly uninformative about what it is for and how it works.</p>
<p>We’ll proceed to work through a basic example that demonstrates both what it is for and how it works. The general purpose is to define some dimension along which cases differ. This might be individual differences in age. Or it could be differences in location. Then we measure the distance between each pair of cases. What the model then does is estimate a function for the covariance between pairs of cases at different distances. This covariance function provides one continuous category generalization of the varying effects approach. (p. 468, <strong>emphasis</strong> in the original)</p>
</blockquote>
<div id="example-spatial-autocorrelation-in-oceanic-tools." class="section level3">
<h3><span class="header-section-number">14.5.1</span> Example: Spatial autocorrelation in Oceanic tools.</h3>
<p>We start by loading the matrix of geographic distances.</p>
<div class="sourceCode" id="cb1763"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1763-1" data-line-number="1"><span class="co"># load the distance matrix</span></a>
<a class="sourceLine" id="cb1763-2" data-line-number="2"><span class="kw">library</span>(rethinking)</a>
<a class="sourceLine" id="cb1763-3" data-line-number="3"><span class="kw">data</span>(islandsDistMatrix)</a>
<a class="sourceLine" id="cb1763-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1763-5" data-line-number="5"><span class="co"># display (measured in thousands of km)</span></a>
<a class="sourceLine" id="cb1763-6" data-line-number="6">d_mat &lt;-<span class="st"> </span>islandsDistMatrix</a>
<a class="sourceLine" id="cb1763-7" data-line-number="7"><span class="kw">colnames</span>(d_mat) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Ml&quot;</span>, <span class="st">&quot;Ti&quot;</span>, <span class="st">&quot;SC&quot;</span>, <span class="st">&quot;Ya&quot;</span>, <span class="st">&quot;Fi&quot;</span>, <span class="st">&quot;Tr&quot;</span>, <span class="st">&quot;Ch&quot;</span>, <span class="st">&quot;Mn&quot;</span>, <span class="st">&quot;To&quot;</span>, <span class="st">&quot;Ha&quot;</span>)</a>
<a class="sourceLine" id="cb1763-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1763-9" data-line-number="9"><span class="kw">round</span>(d_mat, <span class="dv">1</span>)</a></code></pre></div>
<pre><code>##             Ml  Ti  SC  Ya  Fi  Tr  Ch  Mn  To  Ha
## Malekula   0.0 0.5 0.6 4.4 1.2 2.0 3.2 2.8 1.9 5.7
## Tikopia    0.5 0.0 0.3 4.2 1.2 2.0 2.9 2.7 2.0 5.3
## Santa Cruz 0.6 0.3 0.0 3.9 1.6 1.7 2.6 2.4 2.3 5.4
## Yap        4.4 4.2 3.9 0.0 5.4 2.5 1.6 1.6 6.1 7.2
## Lau Fiji   1.2 1.2 1.6 5.4 0.0 3.2 4.0 3.9 0.8 4.9
## Trobriand  2.0 2.0 1.7 2.5 3.2 0.0 1.8 0.8 3.9 6.7
## Chuuk      3.2 2.9 2.6 1.6 4.0 1.8 0.0 1.2 4.8 5.8
## Manus      2.8 2.7 2.4 1.6 3.9 0.8 1.2 0.0 4.6 6.7
## Tonga      1.9 2.0 2.3 6.1 0.8 3.9 4.8 4.6 0.0 5.0
## Hawaii     5.7 5.3 5.4 7.2 4.9 6.7 5.8 6.7 5.0 0.0</code></pre>
<p>If you wanted to use color to more effectively visualize the values in the matirx, you might do something like this.</p>
<div class="sourceCode" id="cb1765"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1765-1" data-line-number="1">d_mat <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1765-2" data-line-number="2"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1765-3" data-line-number="3"><span class="st">  </span><span class="kw">rownames_to_column</span>(<span class="st">&quot;row&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1765-4" data-line-number="4"><span class="st">  </span><span class="kw">gather</span>(column, distance, <span class="op">-</span>row) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1765-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">column =</span> <span class="kw">factor</span>(column, <span class="dt">levels =</span> <span class="kw">colnames</span>(d_mat)),</a>
<a class="sourceLine" id="cb1765-6" data-line-number="6">         <span class="dt">row    =</span> <span class="kw">factor</span>(row,    <span class="dt">levels =</span> <span class="kw">rownames</span>(d_mat)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fct_rev</span>(),</a>
<a class="sourceLine" id="cb1765-7" data-line-number="7">         <span class="dt">label  =</span> <span class="kw">formatC</span>(distance, <span class="dt">format =</span> <span class="st">&#39;f&#39;</span>, <span class="dt">digits =</span> <span class="dv">2</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1765-8" data-line-number="8"><span class="st">  </span></a>
<a class="sourceLine" id="cb1765-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> column, <span class="dt">y =</span> row)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1765-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> distance)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1765-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> label),</a>
<a class="sourceLine" id="cb1765-12" data-line-number="12">            <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1765-13" data-line-number="13"><span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="dt">low =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#A65141&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1765-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">position =</span> <span class="st">&quot;top&quot;</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1765-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="ot">NULL</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1765-16" data-line-number="16"><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1765-17" data-line-number="17"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-60-1.png" width="528" style="display: block; margin: auto;" /></p>
<p>Figure 14.10 shows the “shape of the function relating distance to the covariance <span class="math inline">\(\mathbf K_{ij}\)</span>.”</p>
<div class="sourceCode" id="cb1766"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1766-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">x       =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">4</span>, <span class="dt">by =</span> <span class="fl">.01</span>),</a>
<a class="sourceLine" id="cb1766-2" data-line-number="2">       <span class="dt">linear  =</span> <span class="kw">exp</span>(<span class="op">-</span><span class="dv">1</span> <span class="op">*</span><span class="st"> </span>x),</a>
<a class="sourceLine" id="cb1766-3" data-line-number="3">       <span class="dt">squared =</span> <span class="kw">exp</span>(<span class="op">-</span><span class="dv">1</span> <span class="op">*</span><span class="st"> </span>x<span class="op">^</span><span class="dv">2</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1766-4" data-line-number="4"><span class="st">  </span></a>
<a class="sourceLine" id="cb1766-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1766-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> linear),</a>
<a class="sourceLine" id="cb1766-7" data-line-number="7">            <span class="dt">color =</span> <span class="st">&quot;#B1934A&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1766-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> squared),</a>
<a class="sourceLine" id="cb1766-9" data-line-number="9">            <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1766-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;distance&quot;</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1766-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;correlation&quot;</span>, </a>
<a class="sourceLine" id="cb1766-12" data-line-number="12">                     <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1766-13" data-line-number="13">                     <span class="dt">labels =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="st">&quot;.5&quot;</span>, <span class="dv">1</span>))</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-61-1.png" width="312" style="display: block; margin: auto;" /></p>
<p>Now load the primary data.</p>
<div class="sourceCode" id="cb1767"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1767-1" data-line-number="1"><span class="kw">data</span>(Kline2) <span class="co"># load the ordinary data, now with coordinates</span></a>
<a class="sourceLine" id="cb1767-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1767-3" data-line-number="3">d &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1767-4" data-line-number="4"><span class="st">  </span>Kline2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1767-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">society =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb1767-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1767-7" data-line-number="7"><span class="kw">rm</span>(Kline2)</a>
<a class="sourceLine" id="cb1767-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1767-9" data-line-number="9">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">glimpse</span>()</a></code></pre></div>
<pre><code>## Rows: 10
## Columns: 10
## $ culture     &lt;fct&gt; Malekula, Tikopia, Santa Cruz, Yap, Lau Fiji, Trobriand, Chuuk, Manus, Tonga, Hawaii
## $ population  &lt;int&gt; 1100, 1500, 3600, 4791, 7400, 8000, 9200, 13000, 17500, 275000
## $ contact     &lt;fct&gt; low, low, low, high, high, high, high, low, high, low
## $ total_tools &lt;int&gt; 13, 22, 24, 43, 33, 19, 40, 28, 55, 71
## $ mean_TU     &lt;dbl&gt; 3.2, 4.7, 4.0, 5.0, 5.0, 4.0, 3.8, 6.6, 5.4, 6.6
## $ lat         &lt;dbl&gt; -16.3, -12.3, -10.7, 9.5, -17.7, -8.7, 7.4, -2.1, -21.2, 19.9
## $ lon         &lt;dbl&gt; 167.5, 168.8, 166.0, 138.1, 178.1, 150.9, 151.6, 146.9, -175.2, -155.6
## $ lon2        &lt;dbl&gt; -12.5, -11.2, -14.0, -41.9, -1.9, -29.1, -28.4, -33.1, 4.8, 24.4
## $ logpop      &lt;dbl&gt; 7.003065, 7.313220, 8.188689, 8.474494, 8.909235, 8.987197, 9.126959, 9.472705, 9.76995…
## $ society     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10</code></pre>
<p>👋 <strong>Heads up</strong>: The <strong>brms</strong> package is capable of handling a variety of Gaussian process models using the <code>gp()</code> function. As we will see throughout this section, this method will depart in important ways from how McElreath fits Gaussian process models with <strong>rethinking</strong>. Due in large part to these differences, this section and its analogue in the first edition of <em>Statistical Rethinking</em> <span class="citation">(McElreath, <a href="#ref-mcelreathStatisticalRethinkingBayesian2015">2015</a>)</span> baffled me, at first. Happily, fellow enthusiasts <a href="https://twitter.com/LBliard">Louis Bliard</a> and <a href="https://twitter.com/rtorkar">Richard Torkar</a> reached out and helped me hammer this section out behind the scenes. The method to follow is due in large part to their efforts. 🤝</p>
<p>The <code>brms::gp()</code> function takes a handful of arguments. The first and most important argument, <code>...</code>, accepts the names of one or more predictors from the data. When fitting a spatial Gaussian process of this kind, we’ll enter in the latitude and longitude data for each of levels of <code>culture</code>. This will be an important departure from the text. For his <code>m14.8</code>, McElreath directly entered in the <code>Dmat</code> distance matrix data into <code>ulam()</code>. In so doing, he defined <span class="math inline">\(D_{ij}\)</span>, the matrix of distances between each of the societies. When using <strong>brms</strong>, we instead <em>estimate</em> the distance matrix from the latitude and longitude variables.</p>
<p>Before we practice fitting a Gaussian process with the <code>brms::gp()</code> function, we’ll first need to think a little bit about our data. McElreath’s <code>Dmat</code> measured the distances in thousands of km. However, the <code>lat</code> and <code>lon2</code> variables in the data above are in decimal degrees, which means they need to be transformed to keep our model in the same metric as McElreath’s. Turns out that <a href="https://en.wikipedia.org/wiki/Decimal_degrees#:~:text=A%20value%20in%20decimal%20degrees,1.1132%20m%20at%20the%20equator.">one decimal degree is 111.32km (at the equator)</a>. Thus, we can turn both <code>lat</code> and <code>lon2</code> into 1000 km units by multiplying each by 0.11132. Here’s the conversion.</p>
<div class="sourceCode" id="cb1769"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1769-1" data-line-number="1">d &lt;-</a>
<a class="sourceLine" id="cb1769-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1769-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lat_adj  =</span> lat  <span class="op">*</span><span class="st"> </span><span class="fl">0.11132</span>,</a>
<a class="sourceLine" id="cb1769-4" data-line-number="4">         <span class="dt">lon2_adj =</span> lon2 <span class="op">*</span><span class="st"> </span><span class="fl">0.11132</span>)</a>
<a class="sourceLine" id="cb1769-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1769-6" data-line-number="6">d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1769-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(culture, lat, lon2, lat_adj<span class="op">:</span>lon2_adj)</a></code></pre></div>
<pre><code>##       culture   lat  lon2   lat_adj  lon2_adj
## 1    Malekula -16.3 -12.5 -1.814516 -1.391500
## 2     Tikopia -12.3 -11.2 -1.369236 -1.246784
## 3  Santa Cruz -10.7 -14.0 -1.191124 -1.558480
## 4         Yap   9.5 -41.9  1.057540 -4.664308
## 5    Lau Fiji -17.7  -1.9 -1.970364 -0.211508
## 6   Trobriand  -8.7 -29.1 -0.968484 -3.239412
## 7       Chuuk   7.4 -28.4  0.823768 -3.161488
## 8       Manus  -2.1 -33.1 -0.233772 -3.684692
## 9       Tonga -21.2   4.8 -2.359984  0.534336
## 10     Hawaii  19.9  24.4  2.215268  2.716208</code></pre>
<p>Note that because this conversion is valid <strong>at the equator</strong>, it is only an <em>approximation</em> for latitude and longitude coordinates for our island societies.</p>
<p>Now we’ve scaled our two spatial variables, the basic way to use them in a <strong>brms</strong> Gaussian process is including <code>gp(lat_adj, lon2_adj)</code> into the <code>formula</code> argument within the <code>brm()</code> function. Note however that one of the default <code>gp()</code> settings is <code>scale = TRUE</code>, which scales predictors so that the maximum distance between two points is 1. We don’t want this for our example, so we will set <code>scale = FALSE</code> instead.</p>
<p>Our Gaussian process model is an extension of the non-linear model from <a href="god-spiked-the-integers.html#overthinking-modeling-tool-innovation.">Section 11.2.1.1</a>, <code>b11.11</code>. Thus our model here will also use the non-linear syntax. Here’s how we might use <strong>brms</strong> to fit our amended non-centered version of McElreath’s <code>m14.8</code>.</p>
<div class="sourceCode" id="cb1771"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1771-1" data-line-number="1">b14<span class="fl">.8</span> &lt;-</a>
<a class="sourceLine" id="cb1771-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1771-3" data-line-number="3">      <span class="dt">family =</span> <span class="kw">poisson</span>(<span class="dt">link =</span> <span class="st">&quot;identity&quot;</span>),</a>
<a class="sourceLine" id="cb1771-4" data-line-number="4">      <span class="kw">bf</span>(total_tools <span class="op">~</span><span class="st"> </span><span class="kw">exp</span>(a) <span class="op">*</span><span class="st"> </span>population<span class="op">^</span>b <span class="op">/</span><span class="st"> </span>g,</a>
<a class="sourceLine" id="cb1771-5" data-line-number="5">         a  <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">gp</span>(lat_adj, lon2_adj, <span class="dt">scale =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb1771-6" data-line-number="6">         b <span class="op">+</span><span class="st"> </span>g <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1771-7" data-line-number="7">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1771-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1771-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">nlpar =</span> b, <span class="dt">lb =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1771-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">nlpar =</span> g, <span class="dt">lb =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1771-11" data-line-number="11">                <span class="kw">prior</span>(<span class="kw">inv_gamma</span>(<span class="fl">2.874624</span>, <span class="fl">2.941204</span>), <span class="dt">class =</span> lscale, <span class="dt">coef =</span> gplat_adjlon2_adj, <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1771-12" data-line-number="12">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sdgp, <span class="dt">coef =</span> gplat_adjlon2_adj, <span class="dt">nlpar =</span> a)),</a>
<a class="sourceLine" id="cb1771-13" data-line-number="13">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1771-14" data-line-number="14">      <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1771-15" data-line-number="15">      <span class="dt">sample_prior =</span> T,</a>
<a class="sourceLine" id="cb1771-16" data-line-number="16">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.08&quot;</span>)</a></code></pre></div>
<p>Check the results.</p>
<div class="sourceCode" id="cb1772"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1772-1" data-line-number="1"><span class="kw">print</span>(b14<span class="fl">.8</span>)</a></code></pre></div>
<pre><code>##  Family: poisson 
##   Links: mu = identity 
## Formula: total_tools ~ exp(a) * population^b/g 
##          a ~ 1 + gp(lat_adj, lon2_adj, scale = FALSE)
##          b ~ 1
##          g ~ 1
##    Data: d (Number of observations: 10) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Gaussian Process Terms: 
##                             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sdgp(a_gplat_adjlon2_adj)       0.48      0.30     0.15     1.29 1.00     1469     2069
## lscale(a_gplat_adjlon2_adj)     1.63      0.92     0.50     3.95 1.00     1471     2037
## 
## Population-Level Effects: 
##             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a_Intercept     0.34      0.85    -1.40     1.96 1.00     2889     2725
## b_Intercept     0.26      0.09     0.09     0.44 1.00     1751     1518
## g_Intercept     0.66      0.64     0.05     2.37 1.00     2227     1907
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>The <code>posterior_summary()</code> function will return a summary that looks more like the one in the text.</p>
<div class="sourceCode" id="cb1774"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1774-1" data-line-number="1"><span class="kw">posterior_summary</span>(b14<span class="fl">.8</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>, ] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##                             Estimate Est.Error  Q2.5 Q97.5
## b_a_Intercept                   0.34      0.85 -1.40  1.96
## b_b_Intercept                   0.26      0.09  0.09  0.44
## b_g_Intercept                   0.66      0.64  0.05  2.37
## sdgp_a_gplat_adjlon2_adj        0.48      0.30  0.15  1.29
## lscale_a_gplat_adjlon2_adj      1.63      0.92  0.50  3.95
## zgp_a_gplat_adjlon2_adj[1]     -0.48      0.74 -1.96  0.94
## zgp_a_gplat_adjlon2_adj[2]      0.44      0.84 -1.27  2.08
## zgp_a_gplat_adjlon2_adj[3]     -0.62      0.71 -1.98  0.88
## zgp_a_gplat_adjlon2_adj[4]      0.96      0.70 -0.31  2.42
## zgp_a_gplat_adjlon2_adj[5]      0.23      0.75 -1.26  1.70
## zgp_a_gplat_adjlon2_adj[6]     -1.05      0.78 -2.56  0.51
## zgp_a_gplat_adjlon2_adj[7]      0.15      0.71 -1.37  1.49
## zgp_a_gplat_adjlon2_adj[8]     -0.21      0.86 -1.92  1.53
## zgp_a_gplat_adjlon2_adj[9]      0.43      0.90 -1.37  2.14
## zgp_a_gplat_adjlon2_adj[10]    -0.41      0.81 -2.00  1.17</code></pre>
<p>Let’s focus on our three non-linear parameters, first. Happily, both our <code>b_b_Intercept</code> and <code>b_g_Intercept</code> summaries look a lot like those for McElreath’s <code>b</code> and <code>g</code>, respectively. Our <code>b_a_Intercept</code> might look distressingly small, but that’s just because of how we parameterized our model. It’s actually very close to McElreath’s <code>a</code> after you exponentiate.</p>
<div class="sourceCode" id="cb1776"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1776-1" data-line-number="1"><span class="kw">fixef</span>(b14<span class="fl">.8</span>, <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">055</span>, <span class="fl">.945</span>))[<span class="st">&quot;a_Intercept&quot;</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span><span class="op">:</span><span class="dv">4</span>)] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1776-2" data-line-number="2"><span class="st">  </span><span class="kw">exp</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1776-3" data-line-number="3"><span class="st">  </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## Estimate     Q5.5    Q94.5 
##     1.40     0.36     5.37</code></pre>
<p>Our Gaussian process parameters are different from McElreath’s. From the <code>gp</code> section of the <a href="https://cran.r-project.org/package=brms/brms.pdf"><strong>brms</strong> reference manual</a> <span class="citation">(Bürkner, <a href="#ref-brms2020RM">2020</a><a href="#ref-brms2020RM">h</a>)</span>, we learn the <strong>brms</strong> parameterization follows the form</p>
<p><span class="math display">\[k(x_{i},x_{j}) = sdgp^2 \exp \big (-||x_i - x_j||^2 / (2 lscale^2) \big ),\]</span></p>
<p>where <span class="math inline">\(k(x_{i},x_{j})\)</span> is the same as McElreath’s <span class="math inline">\(\mathbf K_{ij}\)</span> and <span class="math inline">\(||x_i - x_j||^2\)</span> is the Euclidean distance, the same as McElreath’s <span class="math inline">\(D_{ij}^2\)</span>. Thus we could also express the <strong>brms</strong> parameterization as</p>
<p><span class="math display">\[\mathbf K_{ij} = sdgp^2 \exp \big (-D_{ij}^2 / (2 lscale^2) \big ),\]</span></p>
<p>which is much closer to McElreath’s</p>
<p><span class="math display">\[\mathbf K_{ij} = \eta^2 \exp \big (-\rho^2 D_{ij}^2 \big ) + \delta_{ij} \sigma^2\]</span></p>
<p>On page 470, McElreath explained that the final <span class="math inline">\(\delta_{ij} \sigma^2\)</span> term is mute with the Oceanic societies data. Thus we won’t consider it further. This reduces McElreath’s equation to</p>
<p><span class="math display">\[\mathbf K_{ij} = \eta^2 \exp \big (-\rho^2 D_{ij}^2 \big ).\]</span></p>
<p>Importantly, what McElreath called <span class="math inline">\(\eta\)</span>, Bürkner called <span class="math inline">\(sdgp\)</span>. While McElreath estimated <span class="math inline">\(\eta^2\)</span>, <strong>brms</strong> simply estimated <span class="math inline">\(sdgp\)</span>. So we’ll have to square our <code>sdgp(a_gplat_adjlon2_adj)</code> before it’s on the same scale as <code>etasq</code> in the text. Here it is.</p>
<div class="sourceCode" id="cb1778"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1778-1" data-line-number="1">post &lt;-</a>
<a class="sourceLine" id="cb1778-2" data-line-number="2"><span class="st">  </span><span class="kw">posterior_samples</span>(b14<span class="fl">.8</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1778-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">etasq =</span> sdgp_a_gplat_adjlon2_adj<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1778-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1778-5" data-line-number="5">post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1778-6" data-line-number="6"><span class="st">  </span><span class="kw">mean_hdi</span>(etasq, <span class="dt">.width =</span> <span class="fl">.89</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1778-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">3</span>)</a></code></pre></div>
<pre><code>##   etasq .lower .upper .width .point .interval
## 1  0.32      0  0.629   0.89   mean       hdi</code></pre>
<p>Though our posterior is a little bit larger than McElreath’s, we’re in the ballpark. You may have noticed that in our model <code>brm()</code> code, above, we just went with the flow and kept the <code>exponential(1)</code> prior on <code>sdgp</code>. The <strong>brms</strong> default would have been <code>student_t(3, 0, 15.6)</code>.</p>
<p>Now look at the denominator of the inner part of Bürkner’s equation, <span class="math inline">\(2 lscale^2\)</span>. This appears to be the <strong>brms</strong> equivalent to McElreath’s <span class="math inline">\(\rho^2\)</span>. Or at least it’s what we’ve got. Anyway, also note that McElreath estimated <span class="math inline">\(\rho^2\)</span> directly as <code>rhosq</code>. If I’m doing the algebra correctly, we might expect</p>
<p><span class="math display">\[\begin{align*}
\rho^2 &amp; = 1/(2 \cdot lscale^2) &amp; \text{and thus} \\
lscale &amp; = \sqrt{1 / (2 \cdot \rho^2)}.
\end{align*}\]</span></p>
<p>To get a sense of this relationship, it might be helpful to plot.</p>
<div class="sourceCode" id="cb1780"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1780-1" data-line-number="1">p1 &lt;-</a>
<a class="sourceLine" id="cb1780-2" data-line-number="2"><span class="st">  </span><span class="kw">tibble</span>(<span class="st">`</span><span class="dt">rho^2</span><span class="st">`</span> =<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">11</span>, <span class="dt">by =</span> <span class="fl">0.01</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1780-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lscale =</span> <span class="kw">sqrt</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> `</span><span class="dt">rho^2</span><span class="st">`</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1780-4" data-line-number="4"><span class="st">  </span></a>
<a class="sourceLine" id="cb1780-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">rho^2</span><span class="st">`</span>, <span class="dt">y =</span> lscale)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1780-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1780-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1780-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;#A65141&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1780-9" data-line-number="9"><span class="st">  </span><span class="kw">xlab</span>(<span class="kw">expression</span>(rho<span class="op">^</span><span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1780-10" data-line-number="10"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>),</a>
<a class="sourceLine" id="cb1780-11" data-line-number="11">                  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb1780-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1780-13" data-line-number="13">p2 &lt;-</a>
<a class="sourceLine" id="cb1780-14" data-line-number="14"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">lscale =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">11</span>, <span class="dt">by =</span> <span class="fl">0.01</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1780-15" data-line-number="15"><span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">rho^2</span><span class="st">`</span> =<span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>lscale<span class="op">^</span><span class="dv">2</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1780-16" data-line-number="16"><span class="st">  </span></a>
<a class="sourceLine" id="cb1780-17" data-line-number="17"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> lscale, <span class="dt">y =</span> <span class="st">`</span><span class="dt">rho^2</span><span class="st">`</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1780-18" data-line-number="18"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1780-19" data-line-number="19"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1780-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1780-21" data-line-number="21"><span class="st">  </span><span class="kw">ylab</span>(<span class="kw">expression</span>(rho<span class="op">^</span><span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1780-22" data-line-number="22"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>),</a>
<a class="sourceLine" id="cb1780-23" data-line-number="23">                  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb1780-24" data-line-number="24"></a>
<a class="sourceLine" id="cb1780-25" data-line-number="25">p1 <span class="op">+</span><span class="st"> </span>p2</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-68-1.png" width="624" style="display: block; margin: auto;" /></p>
<p>The two aren’t quite inverses of one another, but the overall pattern is when one is large, the other is small. Now we have a sense of how they compare and how to covert one to the other, let’s see how our posterior for <span class="math inline">\(lscale\)</span> looks when we convert it to the scale of McElreath’s <span class="math inline">\(\rho^2\)</span>.</p>
<div class="sourceCode" id="cb1781"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1781-1" data-line-number="1">post &lt;-</a>
<a class="sourceLine" id="cb1781-2" data-line-number="2"><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1781-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rhosq =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>lscale_a_gplat_adjlon2_adj<span class="op">^</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb1781-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1781-5" data-line-number="5">post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1781-6" data-line-number="6"><span class="st">  </span><span class="kw">mean_hdi</span>(rhosq, <span class="dt">.width =</span> <span class="fl">.89</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1781-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">3</span>)</a></code></pre></div>
<pre><code>##   rhosq .lower .upper .width .point .interval
## 1 0.434  0.008  0.932   0.89   mean       hdi</code></pre>
<p>This is about a third of the size of the McElreath’s <span class="math inline">\(\rho^2 = 1.31, 89 \text{% HDI } [0.08, 4.41]\)</span>. The plot deepens. If you look back, you’ll see we used a very different prior for <code>lscale</code>. Here it is: <code>inv_gamma(2.874624, 2.941204)</code>. Use <code>get_prior()</code> to discover where that came from.</p>
<div class="sourceCode" id="cb1783"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1783-1" data-line-number="1"><span class="kw">get_prior</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1783-2" data-line-number="2">          <span class="dt">family =</span> <span class="kw">poisson</span>(<span class="dt">link =</span> <span class="st">&quot;identity&quot;</span>),</a>
<a class="sourceLine" id="cb1783-3" data-line-number="3">          <span class="kw">bf</span>(total_tools <span class="op">~</span><span class="st"> </span><span class="kw">exp</span>(a) <span class="op">*</span><span class="st"> </span>population<span class="op">^</span>b <span class="op">/</span><span class="st"> </span>g,</a>
<a class="sourceLine" id="cb1783-4" data-line-number="4">             a  <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">gp</span>(lat_adj, lon2_adj, <span class="dt">scale =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb1783-5" data-line-number="5">             b <span class="op">+</span><span class="st"> </span>g <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1783-6" data-line-number="6">             <span class="dt">nl =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<pre><code>##                            prior  class              coef group resp dpar nlpar bound
## 1                                     b                                       a      
## 2                                     b         Intercept                     a      
## 3                                lscale                                       a      
## 4  inv_gamma(2.874624, 2.941204) lscale gplat_adjlon2_adj                     a      
## 5          student_t(3, 0, 15.6)   sdgp                                       a      
## 6                                  sdgp gplat_adjlon2_adj                     a      
## 7                                     b                                       b      
## 8                                     b         Intercept                     b      
## 9                                     b                                       g      
## 10                                    b         Intercept                     g</code></pre>
<p>That is, we used the <strong>brms</strong> default prior for <span class="math inline">\(lscale\)</span>. In a <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse/issues/8">GitHub exchange</a>, Bürkner pointed out that <strong>brms</strong> uses special priors for <span class="math inline">\(lscale\)</span> parameters based on Michael Betancourt’s <span class="citation">(<a href="#ref-betancourtRobustGaussianProcesses2017">2017</a>)</span> vignette, <a href="https://betanalpha.github.io/assets/case_studies/gp_part3/part3.html"><em>Robust Gaussian processes in Stan</em></a>. We can use the <code>dinvgamma()</code> function from the well-named <a href="https://CRAN.R-project.org/package=invgamma"><strong>invgamma</strong> package</a> <span class="citation">(Kahle &amp; Stamey, <a href="#ref-R-invgamma">2017</a>)</span> to get a sense of what that prior looks like.</p>
<div class="sourceCode" id="cb1785"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1785-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">lscale =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">9</span>, <span class="dt">by =</span> <span class="fl">0.01</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1785-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">density =</span> invgamma<span class="op">::</span><span class="kw">dinvgamma</span>(lscale, <span class="fl">2.874624</span>, <span class="fl">2.941204</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1785-3" data-line-number="3"><span class="st">  </span></a>
<a class="sourceLine" id="cb1785-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> lscale, <span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">ymax =</span> density)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1785-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">fill =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1785-6" data-line-number="6"><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="fl">4.75</span>, <span class="dt">y =</span> <span class="fl">0.75</span>,</a>
<a class="sourceLine" id="cb1785-7" data-line-number="7">           <span class="dt">label =</span> <span class="st">&quot;inverse gamma(2.874624, 2.941204)&quot;</span>,</a>
<a class="sourceLine" id="cb1785-8" data-line-number="8">           <span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1785-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1785-10" data-line-number="10"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">8</span>))</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-71-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>Anyways, let’s make the subplots for our version of Figure 14.11 to get a sense of what this all means. Start with the left panel, the prior predictive distribution for the covariance.</p>
<div class="sourceCode" id="cb1786"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1786-1" data-line-number="1"><span class="co"># for `sample_n()`</span></a>
<a class="sourceLine" id="cb1786-2" data-line-number="2"><span class="kw">set.seed</span>(<span class="dv">14</span>)</a>
<a class="sourceLine" id="cb1786-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1786-4" data-line-number="4"><span class="co"># wrangle</span></a>
<a class="sourceLine" id="cb1786-5" data-line-number="5">p1 &lt;-</a>
<a class="sourceLine" id="cb1786-6" data-line-number="6"><span class="st">  </span><span class="kw">prior_samples</span>(b14<span class="fl">.8</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1786-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">iter  =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>(),</a>
<a class="sourceLine" id="cb1786-8" data-line-number="8">         <span class="dt">etasq =</span> sdgp_a_gplat_adjlon2_adj<span class="op">^</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb1786-9" data-line-number="9">         <span class="dt">rhosq =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>lscale_a_<span class="dv">1</span>_gplat_adjlon2_adj<span class="op">^</span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1786-10" data-line-number="10"><span class="st">  </span><span class="kw">sample_n</span>(<span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1786-11" data-line-number="11"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">expand</span>(<span class="kw">nesting</span>(iter, etasq, rhosq),</a>
<a class="sourceLine" id="cb1786-12" data-line-number="12">         <span class="dt">x =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">10</span>, <span class="dt">by =</span> <span class="fl">.05</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1786-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">covariance =</span> etasq <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>rhosq <span class="op">*</span><span class="st"> </span>x<span class="op">^</span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1786-14" data-line-number="14"><span class="st">  </span></a>
<a class="sourceLine" id="cb1786-15" data-line-number="15"><span class="st">  </span><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1786-16" data-line-number="16"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> covariance)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1786-17" data-line-number="17"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> iter),</a>
<a class="sourceLine" id="cb1786-18" data-line-number="18">            <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1786-19" data-line-number="19"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;distance (thousand km)&quot;</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1786-20" data-line-number="20">                     <span class="dt">breaks =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">5</span> <span class="op">*</span><span class="st"> </span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1786-21" data-line-number="21"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>),</a>
<a class="sourceLine" id="cb1786-22" data-line-number="22">                  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1786-23" data-line-number="23"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Gaussian process prior&quot;</span>)</a></code></pre></div>
<p>Now make the right panel, the posterior distribution.</p>
<div class="sourceCode" id="cb1787"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1787-1" data-line-number="1"><span class="co"># for `sample_n()`</span></a>
<a class="sourceLine" id="cb1787-2" data-line-number="2"><span class="kw">set.seed</span>(<span class="dv">14</span>)</a>
<a class="sourceLine" id="cb1787-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1787-4" data-line-number="4"><span class="co"># wrangle</span></a>
<a class="sourceLine" id="cb1787-5" data-line-number="5">p2 &lt;-</a>
<a class="sourceLine" id="cb1787-6" data-line-number="6"><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1787-7" data-line-number="7"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">iter  =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>(),</a>
<a class="sourceLine" id="cb1787-8" data-line-number="8">            <span class="dt">etasq =</span> sdgp_a_gplat_adjlon2_adj<span class="op">^</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb1787-9" data-line-number="9">         <span class="dt">rhosq =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>lscale_a_gplat_adjlon2_adj<span class="op">^</span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1787-10" data-line-number="10"><span class="st">  </span><span class="kw">sample_n</span>(<span class="dv">50</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1787-11" data-line-number="11"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">expand</span>(<span class="kw">nesting</span>(iter, etasq, rhosq),</a>
<a class="sourceLine" id="cb1787-12" data-line-number="12">         <span class="dt">x =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">10</span>, <span class="dt">by =</span> <span class="fl">.05</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1787-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">covariance =</span> etasq <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>rhosq <span class="op">*</span><span class="st"> </span>x<span class="op">^</span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1787-14" data-line-number="14"><span class="st">  </span></a>
<a class="sourceLine" id="cb1787-15" data-line-number="15"><span class="st">  </span><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1787-16" data-line-number="16"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> covariance)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1787-17" data-line-number="17"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> iter),</a>
<a class="sourceLine" id="cb1787-18" data-line-number="18">            <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1787-19" data-line-number="19"><span class="st">  </span><span class="kw">stat_function</span>(<span class="dt">fun =</span> <span class="cf">function</span>(x) <span class="kw">mean</span>(post<span class="op">$</span>sdgp_a_gplat_adjlon2_adj)<span class="op">^</span><span class="dv">2</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb1787-20" data-line-number="20"><span class="st">                  </span><span class="kw">exp</span>(<span class="op">-</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">mean</span>(post<span class="op">$</span>lscale_a_gplat_adjlon2_adj)<span class="op">^</span><span class="dv">2</span>)) <span class="op">*</span><span class="st"> </span>x<span class="op">^</span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1787-21" data-line-number="21">                <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1787-22" data-line-number="22"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;distance (thousand km)&quot;</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1787-23" data-line-number="23">                     <span class="dt">breaks =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">5</span> <span class="op">*</span><span class="st"> </span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1787-24" data-line-number="24"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>),</a>
<a class="sourceLine" id="cb1787-25" data-line-number="25">                  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1787-26" data-line-number="26"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Gaussian process posterior&quot;</span>)</a></code></pre></div>
<p>Combine the two with <strong>patchwork</strong>.</p>
<div class="sourceCode" id="cb1788"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1788-1" data-line-number="1">p1 <span class="op">|</span><span class="st"> </span>p2</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-74-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Though the Gaussian process parameters from our <strong>brms</strong> parameterization looked different from McElreath’s, they resulted in a similar decline in spatial covariance.</p>
<p>Let’s finish this up and “push the parameters back through the function for <span class="math inline">\(\mathbf{K}\)</span>, the covariance matrix” (p. 473).</p>
<div class="sourceCode" id="cb1789"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1789-1" data-line-number="1"><span class="co"># compute posterior median covariance among societies</span></a>
<a class="sourceLine" id="cb1789-2" data-line-number="2">k &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">10</span>, <span class="dt">ncol =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb1789-3" data-line-number="3"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb1789-4" data-line-number="4">    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb1789-5" data-line-number="5">        k[i, j] &lt;-<span class="st"> </span><span class="kw">median</span>(post<span class="op">$</span>etasq) <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1789-6" data-line-number="6"><span class="st">  </span><span class="kw">exp</span>(<span class="op">-</span><span class="kw">median</span>(post<span class="op">$</span>rhosq) <span class="op">*</span><span class="st"> </span>islandsDistMatrix[i, j]<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1789-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1789-8" data-line-number="8"><span class="kw">diag</span>(k) &lt;-<span class="st"> </span><span class="kw">median</span>(post<span class="op">$</span>etasq) <span class="op">+</span><span class="st"> </span><span class="fl">0.01</span></a>
<a class="sourceLine" id="cb1789-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1789-10" data-line-number="10">k <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
##  [1,] 0.17 0.15 0.14 0.00 0.11 0.06 0.01 0.02 0.07  0.00
##  [2,] 0.15 0.17 0.16 0.00 0.11 0.06 0.02 0.03 0.06  0.00
##  [3,] 0.14 0.16 0.17 0.00 0.09 0.08 0.03 0.04 0.04  0.00
##  [4,] 0.00 0.00 0.00 0.17 0.00 0.04 0.09 0.08 0.00  0.00
##  [5,] 0.11 0.11 0.09 0.00 0.17 0.01 0.00 0.00 0.14  0.00
##  [6,] 0.06 0.06 0.08 0.04 0.01 0.17 0.07 0.13 0.00  0.00
##  [7,] 0.01 0.02 0.03 0.09 0.00 0.07 0.17 0.11 0.00  0.00
##  [8,] 0.02 0.03 0.04 0.08 0.00 0.13 0.11 0.17 0.00  0.00
##  [9,] 0.07 0.06 0.04 0.00 0.14 0.00 0.00 0.00 0.17  0.00
## [10,] 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00  0.17</code></pre>
<p>We’ll continue to follow suit and change these to a correlation matrix.</p>
<div class="sourceCode" id="cb1791"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1791-1" data-line-number="1"><span class="co"># convert to correlation matrix</span></a>
<a class="sourceLine" id="cb1791-2" data-line-number="2">rho &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">cov2cor</span>(k), <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1791-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1791-4" data-line-number="4"><span class="co"># add row/col names for convenience</span></a>
<a class="sourceLine" id="cb1791-5" data-line-number="5"><span class="kw">colnames</span>(rho) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Ml&quot;</span>, <span class="st">&quot;Ti&quot;</span>, <span class="st">&quot;SC&quot;</span>, <span class="st">&quot;Ya&quot;</span>, <span class="st">&quot;Fi&quot;</span>, <span class="st">&quot;Tr&quot;</span>, <span class="st">&quot;Ch&quot;</span>, <span class="st">&quot;Mn&quot;</span>, <span class="st">&quot;To&quot;</span>, <span class="st">&quot;Ha&quot;</span>)</a>
<a class="sourceLine" id="cb1791-6" data-line-number="6"><span class="kw">rownames</span>(rho) &lt;-<span class="st"> </span><span class="kw">colnames</span>(rho)</a>
<a class="sourceLine" id="cb1791-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1791-8" data-line-number="8">rho <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##      Ml   Ti   SC   Ya   Fi   Tr   Ch   Mn   To Ha
## Ml 1.00 0.89 0.85 0.01 0.64 0.33 0.08 0.13 0.40  0
## Ti 0.89 1.00 0.92 0.01 0.64 0.34 0.12 0.16 0.36  0
## SC 0.85 0.92 1.00 0.02 0.52 0.45 0.18 0.24 0.26  0
## Ya 0.01 0.01 0.02 1.00 0.00 0.21 0.52 0.49 0.00  0
## Fi 0.64 0.64 0.52 0.00 1.00 0.07 0.02 0.02 0.81  0
## Tr 0.33 0.34 0.45 0.21 0.07 1.00 0.42 0.79 0.02  0
## Ch 0.08 0.12 0.18 0.52 0.02 0.42 1.00 0.65 0.00  0
## Mn 0.13 0.16 0.24 0.49 0.02 0.79 0.65 1.00 0.00  0
## To 0.40 0.36 0.26 0.00 0.81 0.02 0.00 0.00 1.00  0
## Ha 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00  1</code></pre>
<p>Here are those correlations in a plot.</p>
<div class="sourceCode" id="cb1793"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1793-1" data-line-number="1">rho <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1793-2" data-line-number="2"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1793-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">row =</span> d<span class="op">$</span>culture) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1793-4" data-line-number="4"><span class="st">  </span><span class="kw">gather</span>(column, distance, <span class="op">-</span>row) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1793-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">column =</span> <span class="kw">factor</span>(column, <span class="dt">levels =</span> <span class="kw">colnames</span>(d_mat)),</a>
<a class="sourceLine" id="cb1793-6" data-line-number="6">         <span class="dt">row    =</span> <span class="kw">factor</span>(row,    <span class="dt">levels =</span> <span class="kw">rownames</span>(d_mat)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fct_rev</span>(),</a>
<a class="sourceLine" id="cb1793-7" data-line-number="7">         <span class="dt">label  =</span> <span class="kw">formatC</span>(distance, <span class="dt">format =</span> <span class="st">&#39;f&#39;</span>, <span class="dt">digits =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_replace</span>(., <span class="st">&quot;0.&quot;</span>, <span class="st">&quot;.&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1793-8" data-line-number="8"><span class="st">  </span><span class="co"># omit this line to keep the diagonal of 1&#39;s</span></a>
<a class="sourceLine" id="cb1793-9" data-line-number="9"><span class="st">  </span><span class="kw">filter</span>(distance <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1793-10" data-line-number="10"><span class="st">  </span></a>
<a class="sourceLine" id="cb1793-11" data-line-number="11"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> column, <span class="dt">y =</span> row)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1793-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> distance)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1793-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> label),</a>
<a class="sourceLine" id="cb1793-14" data-line-number="14">            <span class="dt">size =</span> <span class="fl">2.75</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1793-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="kw">expression</span>(rho), <span class="dt">low =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1793-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">position =</span> <span class="st">&quot;top&quot;</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1793-17" data-line-number="17"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="ot">NULL</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1793-18" data-line-number="18"><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1793-19" data-line-number="19"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-77-1.png" width="456" style="display: block; margin: auto;" /></p>
<p>The correlations in our <code>rho</code> matrix look a little higher than those in the text (p. 474). Before we move on to the next plot, let’s consider <code>psize</code>. If you really want to scale the points in Figure 14.12.a like McElreath did, you can make the <code>psize</code> variable in a <strong>tidyverse</strong> sort of way as follows. However, if you compare the <code>psize</code> method and the default <strong>ggplot2</strong> method using just <code>logpop</code>, you’ll see the difference is negligible. In that light, I’m going to be lazy and just use <code>logpop</code> in my plots.</p>
<div class="sourceCode" id="cb1794"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1794-1" data-line-number="1">d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1794-2" data-line-number="2"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">psize =</span> logpop <span class="op">/</span><span class="st"> </span><span class="kw">max</span>(logpop)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1794-3" data-line-number="3"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">psize =</span> <span class="kw">exp</span>(psize <span class="op">*</span><span class="st"> </span><span class="fl">1.5</span>) <span class="op">-</span><span class="st"> </span><span class="dv">2</span>)</a></code></pre></div>
<pre><code>##        psize
## 1  0.3134090
## 2  0.4009582
## 3  0.6663711
## 4  0.7592196
## 5  0.9066890
## 6  0.9339560
## 7  0.9834797
## 8  1.1096138
## 9  1.2223112
## 10 2.4816891</code></pre>
<p>As far as I can figure, you still have to get <code>rho</code> into a tidy data frame before feeding it into <strong>ggplot2</strong>. Here’s my attempt at doing so.</p>
<div class="sourceCode" id="cb1796"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1796-1" data-line-number="1">tidy_rho &lt;-</a>
<a class="sourceLine" id="cb1796-2" data-line-number="2"><span class="st">  </span>rho <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1796-3" data-line-number="3"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1796-4" data-line-number="4"><span class="st">  </span><span class="kw">rownames_to_column</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1796-5" data-line-number="5"><span class="st">  </span><span class="kw">bind_cols</span>(d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(culture, logpop, total_tools, lon2, lat)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1796-6" data-line-number="6"><span class="st">  </span><span class="kw">pivot_longer</span>(Ml<span class="op">:</span>Ha,</a>
<a class="sourceLine" id="cb1796-7" data-line-number="7">               <span class="dt">names_to =</span> <span class="st">&quot;colname&quot;</span>, </a>
<a class="sourceLine" id="cb1796-8" data-line-number="8">               <span class="dt">values_to =</span> <span class="st">&quot;correlation&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1796-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">str_c</span>(<span class="kw">pmin</span>(rowname, colname), <span class="kw">pmax</span>(rowname, colname))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1796-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(rowname, colname, group, culture, <span class="kw">everything</span>())  </a>
<a class="sourceLine" id="cb1796-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1796-12" data-line-number="12"><span class="kw">head</span>(tidy_rho)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 9
##   rowname colname group culture  logpop total_tools  lon2   lat correlation
##   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;fct&gt;     &lt;dbl&gt;       &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;
## 1 Ml      Ml      MlMl  Malekula   7.00          13 -12.5 -16.3        1   
## 2 Ml      Ti      MlTi  Malekula   7.00          13 -12.5 -16.3        0.89
## 3 Ml      SC      MlSC  Malekula   7.00          13 -12.5 -16.3        0.85
## 4 Ml      Ya      MlYa  Malekula   7.00          13 -12.5 -16.3        0.01
## 5 Ml      Fi      FiMl  Malekula   7.00          13 -12.5 -16.3        0.64
## 6 Ml      Tr      MlTr  Malekula   7.00          13 -12.5 -16.3        0.33</code></pre>
<p>Okay, here’s the code for our version of Figure 14.12.a.</p>
<div class="sourceCode" id="cb1798"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1798-1" data-line-number="1"><span class="kw">library</span>(ggrepel)</a>
<a class="sourceLine" id="cb1798-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1798-3" data-line-number="3">p1 &lt;-</a>
<a class="sourceLine" id="cb1798-4" data-line-number="4"><span class="st">  </span>tidy_rho <span class="op">%&gt;%</span><span class="st">       </span></a>
<a class="sourceLine" id="cb1798-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> lon2, <span class="dt">y =</span> lat)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1798-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1798-7" data-line-number="7">             <span class="kw">aes</span>(<span class="dt">size =</span> logpop), <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1798-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">alpha =</span> correlation<span class="op">^</span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1798-9" data-line-number="9">            <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1798-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_text_repel</span>(<span class="dt">data =</span> d, <span class="kw">aes</span>(<span class="dt">label =</span> culture), </a>
<a class="sourceLine" id="cb1798-11" data-line-number="11">                  <span class="dt">seed =</span> <span class="dv">14</span>, <span class="dt">point.padding =</span> <span class="fl">.2</span>, <span class="dt">size =</span> <span class="fl">2.75</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1798-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_alpha_continuous</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1798-13" data-line-number="13"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Among societies in geographic space</span><span class="ch">\n</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb1798-14" data-line-number="14">       <span class="dt">x =</span> <span class="st">&quot;longitude&quot;</span>,</a>
<a class="sourceLine" id="cb1798-15" data-line-number="15">       <span class="dt">y =</span> <span class="st">&quot;latitude&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1798-16" data-line-number="16"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(d<span class="op">$</span>lon2),</a>
<a class="sourceLine" id="cb1798-17" data-line-number="17">                  <span class="dt">ylim =</span> <span class="kw">range</span>(d<span class="op">$</span>lat)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1798-18" data-line-number="18"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p>Here’s our the code for our version of Figure 14.12.b.</p>
<div class="sourceCode" id="cb1799"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1799-1" data-line-number="1"><span class="co"># compute the average posterior predictive relationship between </span></a>
<a class="sourceLine" id="cb1799-2" data-line-number="2"><span class="co"># log population and total tools, summarized by the median and 80% interval</span></a>
<a class="sourceLine" id="cb1799-3" data-line-number="3">f &lt;-</a>
<a class="sourceLine" id="cb1799-4" data-line-number="4"><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1799-5" data-line-number="5"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">expand</span>(<span class="dt">logpop =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">6</span>, <span class="dt">to =</span> <span class="dv">14</span>, <span class="dt">length.out =</span> <span class="dv">30</span>),</a>
<a class="sourceLine" id="cb1799-6" data-line-number="6">         <span class="kw">nesting</span>(b_a_Intercept, b_b_Intercept, b_g_Intercept)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1799-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">population =</span> <span class="kw">exp</span>(logpop)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1799-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lambda =</span> <span class="kw">exp</span>(b_a_Intercept) <span class="op">*</span><span class="st"> </span>population<span class="op">^</span>b_b_Intercept <span class="op">/</span><span class="st"> </span>b_g_Intercept) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1799-9" data-line-number="9"><span class="st">  </span><span class="kw">group_by</span>(logpop) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1799-10" data-line-number="10"><span class="st">  </span><span class="kw">median_qi</span>(lambda, <span class="dt">.width =</span> <span class="fl">.8</span>)</a>
<a class="sourceLine" id="cb1799-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1799-12" data-line-number="12"><span class="co"># plot</span></a>
<a class="sourceLine" id="cb1799-13" data-line-number="13">p2 &lt;-</a>
<a class="sourceLine" id="cb1799-14" data-line-number="14"><span class="st">  </span>tidy_rho <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1799-15" data-line-number="15"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> logpop)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1799-16" data-line-number="16"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">data =</span> f,</a>
<a class="sourceLine" id="cb1799-17" data-line-number="17">              <span class="kw">aes</span>(<span class="dt">y =</span> lambda, <span class="dt">ymin =</span> .lower, <span class="dt">ymax =</span> .upper),</a>
<a class="sourceLine" id="cb1799-18" data-line-number="18">              <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>,</a>
<a class="sourceLine" id="cb1799-19" data-line-number="19">              <span class="dt">fill =</span> <span class="st">&quot;#394165&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>, <span class="dt">size =</span> <span class="fl">1.1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1799-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1799-21" data-line-number="21">             <span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">size =</span> logpop), </a>
<a class="sourceLine" id="cb1799-22" data-line-number="22">             <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1799-23" data-line-number="23"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">group =</span> group, <span class="dt">alpha =</span> correlation<span class="op">^</span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1799-24" data-line-number="24">            <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1799-25" data-line-number="25"><span class="st">  </span><span class="kw">geom_text_repel</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1799-26" data-line-number="26">                  <span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">label =</span> culture), </a>
<a class="sourceLine" id="cb1799-27" data-line-number="27">                  <span class="dt">seed =</span> <span class="dv">14</span>, <span class="dt">point.padding =</span> <span class="fl">.2</span>, <span class="dt">size =</span> <span class="fl">2.75</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1799-28" data-line-number="28"><span class="st">  </span><span class="kw">scale_alpha_continuous</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1799-29" data-line-number="29"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Shown against the relation between</span><span class="ch">\n</span><span class="st">total tools and log pop&quot;</span>,</a>
<a class="sourceLine" id="cb1799-30" data-line-number="30">       <span class="dt">x =</span> <span class="st">&quot;log population&quot;</span>,</a>
<a class="sourceLine" id="cb1799-31" data-line-number="31">       <span class="dt">y =</span> <span class="st">&quot;total tools&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1799-32" data-line-number="32"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(d<span class="op">$</span>logpop),</a>
<a class="sourceLine" id="cb1799-33" data-line-number="33">                  <span class="dt">ylim =</span> <span class="kw">range</span>(d<span class="op">$</span>total_tools)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1799-34" data-line-number="34"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p>Now we combine them to make the full version of Figure 14.12.</p>
<div class="sourceCode" id="cb1800"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1800-1" data-line-number="1">p1 <span class="op">+</span><span class="st"> </span>p2 <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1800-2" data-line-number="2"><span class="st">  </span><span class="kw">plot_annotation</span>(<span class="dt">title =</span> <span class="st">&quot;Posterior median correlations&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-82-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>As expressed by the intensity of the colors of those connecting lines, our correlations are a bit more pronounced than those in the text, making for a more densely webbed plot. It is still the case that the correlations among Malekula, Tikopia, and Santa Cruz are the most pronounced. The next two notable correlations are between Manus and Trobriand and between Lau Fiji and Tonga.</p>
<div id="rethinking-dispersion-by-other-names." class="section level5">
<h5><span class="header-section-number">14.5.1.0.1</span> Rethinking: Dispersion by other names.</h5>
<p>McElreath remarked it might be a good idea to fit an alternative of this model using the gamma-Poisson likelihood. Let’s take him up on the challenge. Remember that gamma-Poisson models are also referred to as negative binomial models. When using <strong>brms</strong>, you specify this using <code>family = negbinomial</code>.</p>
<div class="sourceCode" id="cb1801"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1801-1" data-line-number="1">b14<span class="fl">.8</span>_nb &lt;-</a>
<a class="sourceLine" id="cb1801-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1801-3" data-line-number="3">      <span class="dt">family =</span> <span class="kw">negbinomial</span>(<span class="dt">link =</span> <span class="st">&quot;identity&quot;</span>),</a>
<a class="sourceLine" id="cb1801-4" data-line-number="4">      <span class="kw">bf</span>(total_tools <span class="op">~</span><span class="st"> </span><span class="kw">exp</span>(a) <span class="op">*</span><span class="st"> </span>population<span class="op">^</span>b <span class="op">/</span><span class="st"> </span>g,</a>
<a class="sourceLine" id="cb1801-5" data-line-number="5">         a  <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">gp</span>(lat_adj, lon2_adj, <span class="dt">scale =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb1801-6" data-line-number="6">         b <span class="op">+</span><span class="st"> </span>g <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1801-7" data-line-number="7">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1801-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1801-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">nlpar =</span> b, <span class="dt">lb =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1801-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">nlpar =</span> g, <span class="dt">lb =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1801-11" data-line-number="11">                <span class="kw">prior</span>(<span class="kw">inv_gamma</span>(<span class="fl">2.874624</span>, <span class="fl">2.941204</span>), <span class="dt">class =</span> lscale, <span class="dt">coef =</span> gplat_adjlon2_adj, <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1801-12" data-line-number="12">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sdgp, <span class="dt">coef =</span> gplat_adjlon2_adj, <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1801-13" data-line-number="13">                <span class="co"># default prior</span></a>
<a class="sourceLine" id="cb1801-14" data-line-number="14">                <span class="kw">prior</span>(<span class="kw">gamma</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>), <span class="dt">class =</span> shape)),</a>
<a class="sourceLine" id="cb1801-15" data-line-number="15">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1801-16" data-line-number="16">      <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1801-17" data-line-number="17">      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">.9</span>),</a>
<a class="sourceLine" id="cb1801-18" data-line-number="18">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.08_nb&quot;</span>)</a></code></pre></div>
<p>Check the summary</p>
<div class="sourceCode" id="cb1802"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1802-1" data-line-number="1"><span class="kw">print</span>(b14<span class="fl">.8</span>_nb)</a></code></pre></div>
<pre><code>##  Family: negbinomial 
##   Links: mu = identity; shape = identity 
## Formula: total_tools ~ exp(a) * population^b/g 
##          a ~ 1 + gp(lat_adj, lon2_adj, scale = FALSE)
##          b ~ 1
##          g ~ 1
##    Data: d (Number of observations: 10) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Gaussian Process Terms: 
##                             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sdgp(a_gplat_adjlon2_adj)       0.37      0.30     0.02     1.12 1.00     1092     1782
## lscale(a_gplat_adjlon2_adj)     1.67      1.47     0.46     4.61 1.00     2270     2343
## 
## Population-Level Effects: 
##             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a_Intercept     0.28      0.85    -1.48     1.92 1.00     2838     2139
## b_Intercept     0.27      0.09     0.10     0.44 1.00     1806     1268
## g_Intercept     0.71      0.68     0.06     2.61 1.00     2748     2074
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## shape    50.91     58.87     4.44   214.37 1.00     1230     2118
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>This resulted in a slightly less pronounced correlation matrix.</p>
<div class="sourceCode" id="cb1804"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1804-1" data-line-number="1">post &lt;-<span class="st"> </span><span class="kw">posterior_samples</span>(b14<span class="fl">.8</span>_nb)</a>
<a class="sourceLine" id="cb1804-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1804-3" data-line-number="3"><span class="co"># compute posterior median covariance among societies</span></a>
<a class="sourceLine" id="cb1804-4" data-line-number="4">k &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">10</span>, <span class="dt">ncol =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb1804-5" data-line-number="5"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb1804-6" data-line-number="6">    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb1804-7" data-line-number="7">        k[i, j] &lt;-<span class="st"> </span><span class="kw">median</span>(post<span class="op">$</span>sdgp_a_gplat_adjlon2_adj<span class="op">^</span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1804-8" data-line-number="8"><span class="st">  </span><span class="kw">exp</span>(<span class="op">-</span>islandsDistMatrix[i, j]<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">median</span>(post<span class="op">$</span>lscale_a_gplat_adjlon2_adj)<span class="op">^</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb1804-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1804-10" data-line-number="10"><span class="kw">diag</span>(k) &lt;-<span class="st"> </span><span class="kw">median</span>(post<span class="op">$</span>sdgp_a_gplat_adjlon2_adj<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="fl">0.01</span></a>
<a class="sourceLine" id="cb1804-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1804-12" data-line-number="12"><span class="co"># convert to correlation matrix</span></a>
<a class="sourceLine" id="cb1804-13" data-line-number="13">rho &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">cov2cor</span>(k), <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1804-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1804-15" data-line-number="15"><span class="co"># add row/col names for convenience</span></a>
<a class="sourceLine" id="cb1804-16" data-line-number="16"><span class="kw">colnames</span>(rho) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Ml&quot;</span>, <span class="st">&quot;Ti&quot;</span>, <span class="st">&quot;SC&quot;</span>, <span class="st">&quot;Ya&quot;</span>, <span class="st">&quot;Fi&quot;</span>, <span class="st">&quot;Tr&quot;</span>, <span class="st">&quot;Ch&quot;</span>, <span class="st">&quot;Mn&quot;</span>, <span class="st">&quot;To&quot;</span>, <span class="st">&quot;Ha&quot;</span>)</a>
<a class="sourceLine" id="cb1804-17" data-line-number="17"><span class="kw">rownames</span>(rho) &lt;-<span class="st"> </span><span class="kw">colnames</span>(rho)</a>
<a class="sourceLine" id="cb1804-18" data-line-number="18"></a>
<a class="sourceLine" id="cb1804-19" data-line-number="19">rho <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##      Ml   Ti   SC   Ya   Fi   Tr   Ch   Mn   To Ha
## Ml 1.00 0.85 0.80 0.00 0.58 0.28 0.05 0.10 0.34  0
## Ti 0.85 1.00 0.88 0.01 0.58 0.28 0.08 0.12 0.30  0
## SC 0.80 0.88 1.00 0.01 0.45 0.39 0.13 0.18 0.20  0
## Ya 0.00 0.01 0.01 1.00 0.00 0.16 0.45 0.43 0.00  0
## Fi 0.58 0.58 0.45 0.00 1.00 0.05 0.01 0.01 0.76  0
## Tr 0.28 0.28 0.39 0.16 0.05 1.00 0.36 0.73 0.01  0
## Ch 0.05 0.08 0.13 0.45 0.01 0.36 1.00 0.59 0.00  0
## Mn 0.10 0.12 0.18 0.43 0.01 0.73 0.59 1.00 0.00  0
## To 0.34 0.30 0.20 0.00 0.76 0.01 0.00 0.00 1.00  0
## Ha 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00  1</code></pre>
<p>Like before, we’ll view them in a plot.</p>
<div class="sourceCode" id="cb1806"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1806-1" data-line-number="1">rho <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1806-2" data-line-number="2"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1806-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">row =</span> d<span class="op">$</span>culture) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1806-4" data-line-number="4"><span class="st">  </span><span class="kw">gather</span>(column, distance, <span class="op">-</span>row) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1806-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">column =</span> <span class="kw">factor</span>(column, <span class="dt">levels =</span> <span class="kw">colnames</span>(d_mat)),</a>
<a class="sourceLine" id="cb1806-6" data-line-number="6">         <span class="dt">row    =</span> <span class="kw">factor</span>(row,    <span class="dt">levels =</span> <span class="kw">rownames</span>(d_mat)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fct_rev</span>(),</a>
<a class="sourceLine" id="cb1806-7" data-line-number="7">         <span class="dt">label  =</span> <span class="kw">formatC</span>(distance, <span class="dt">format =</span> <span class="st">&#39;f&#39;</span>, <span class="dt">digits =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_replace</span>(., <span class="st">&quot;0.&quot;</span>, <span class="st">&quot;.&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1806-8" data-line-number="8"><span class="st">  </span><span class="co"># omit this line to keep the diagonal of 1&#39;s</span></a>
<a class="sourceLine" id="cb1806-9" data-line-number="9"><span class="st">  </span><span class="kw">filter</span>(distance <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1806-10" data-line-number="10"><span class="st">  </span></a>
<a class="sourceLine" id="cb1806-11" data-line-number="11"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> column, <span class="dt">y =</span> row)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1806-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> distance)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1806-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> label),</a>
<a class="sourceLine" id="cb1806-14" data-line-number="14">            <span class="dt">size =</span> <span class="fl">2.75</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1806-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="kw">expression</span>(rho), <span class="dt">low =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1806-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">position =</span> <span class="st">&quot;top&quot;</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1806-17" data-line-number="17"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="ot">NULL</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1806-18" data-line-number="18"><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1806-19" data-line-number="19"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-85-1.png" width="456" style="display: block; margin: auto;" /></p>
<p>On the whole, the correlation medians appear a just little bit lower than from the Poisson model. Now let’s make a gamma-Poisson alternative to Figure 14.12.</p>
<div class="sourceCode" id="cb1807"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1807-1" data-line-number="1"><span class="co"># tidy up rho</span></a>
<a class="sourceLine" id="cb1807-2" data-line-number="2">tidy_rho &lt;-</a>
<a class="sourceLine" id="cb1807-3" data-line-number="3"><span class="st">  </span>rho <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1807-4" data-line-number="4"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1807-5" data-line-number="5"><span class="st">  </span><span class="kw">rownames_to_column</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1807-6" data-line-number="6"><span class="st">  </span><span class="kw">bind_cols</span>(d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(culture, logpop, total_tools, lon2, lat)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1807-7" data-line-number="7"><span class="st">  </span><span class="kw">pivot_longer</span>(Ml<span class="op">:</span>Ha,</a>
<a class="sourceLine" id="cb1807-8" data-line-number="8">               <span class="dt">names_to =</span> <span class="st">&quot;colname&quot;</span>, </a>
<a class="sourceLine" id="cb1807-9" data-line-number="9">               <span class="dt">values_to =</span> <span class="st">&quot;correlation&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1807-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">str_c</span>(<span class="kw">pmin</span>(rowname, colname), <span class="kw">pmax</span>(rowname, colname))) </a>
<a class="sourceLine" id="cb1807-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1807-12" data-line-number="12"><span class="co"># left panel</span></a>
<a class="sourceLine" id="cb1807-13" data-line-number="13">p1 &lt;-</a>
<a class="sourceLine" id="cb1807-14" data-line-number="14"><span class="st">  </span>tidy_rho <span class="op">%&gt;%</span><span class="st">       </span></a>
<a class="sourceLine" id="cb1807-15" data-line-number="15"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> lon2, <span class="dt">y =</span> lat)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-16" data-line-number="16"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1807-17" data-line-number="17">             <span class="kw">aes</span>(<span class="dt">size =</span> logpop), <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-18" data-line-number="18"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">alpha =</span> correlation<span class="op">^</span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1807-19" data-line-number="19">            <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_text_repel</span>(<span class="dt">data =</span> d, <span class="kw">aes</span>(<span class="dt">label =</span> culture), </a>
<a class="sourceLine" id="cb1807-21" data-line-number="21">                  <span class="dt">seed =</span> <span class="dv">14</span>, <span class="dt">point.padding =</span> <span class="fl">.2</span>, <span class="dt">size =</span> <span class="fl">2.75</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-22" data-line-number="22"><span class="st">  </span><span class="kw">scale_alpha_continuous</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-23" data-line-number="23"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Among societies in geographic space</span><span class="ch">\n</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb1807-24" data-line-number="24">       <span class="dt">x =</span> <span class="st">&quot;longitude&quot;</span>,</a>
<a class="sourceLine" id="cb1807-25" data-line-number="25">       <span class="dt">y =</span> <span class="st">&quot;latitude&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-26" data-line-number="26"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(d<span class="op">$</span>lon2),</a>
<a class="sourceLine" id="cb1807-27" data-line-number="27">                  <span class="dt">ylim =</span> <span class="kw">range</span>(d<span class="op">$</span>lat)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-28" data-line-number="28"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a>
<a class="sourceLine" id="cb1807-29" data-line-number="29"></a>
<a class="sourceLine" id="cb1807-30" data-line-number="30"><span class="co"># compute the average posterior predictive relationship between </span></a>
<a class="sourceLine" id="cb1807-31" data-line-number="31"><span class="co"># log population and total tools, summarized by the median and 80% interval</span></a>
<a class="sourceLine" id="cb1807-32" data-line-number="32">f &lt;-</a>
<a class="sourceLine" id="cb1807-33" data-line-number="33"><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1807-34" data-line-number="34"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">expand</span>(<span class="dt">logpop =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">6</span>, <span class="dt">to =</span> <span class="dv">14</span>, <span class="dt">length.out =</span> <span class="dv">30</span>),</a>
<a class="sourceLine" id="cb1807-35" data-line-number="35">         <span class="kw">nesting</span>(b_a_Intercept, b_b_Intercept, b_g_Intercept)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1807-36" data-line-number="36"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">population =</span> <span class="kw">exp</span>(logpop)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1807-37" data-line-number="37"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lambda =</span> <span class="kw">exp</span>(b_a_Intercept) <span class="op">*</span><span class="st"> </span>population<span class="op">^</span>b_b_Intercept <span class="op">/</span><span class="st"> </span>b_g_Intercept) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1807-38" data-line-number="38"><span class="st">  </span><span class="kw">group_by</span>(logpop) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1807-39" data-line-number="39"><span class="st">  </span><span class="kw">median_qi</span>(lambda, <span class="dt">.width =</span> <span class="fl">.8</span>)</a>
<a class="sourceLine" id="cb1807-40" data-line-number="40"></a>
<a class="sourceLine" id="cb1807-41" data-line-number="41"><span class="co"># right panel</span></a>
<a class="sourceLine" id="cb1807-42" data-line-number="42">p2 &lt;-</a>
<a class="sourceLine" id="cb1807-43" data-line-number="43"><span class="st">  </span>tidy_rho <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1807-44" data-line-number="44"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> logpop)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-45" data-line-number="45"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">data =</span> f,</a>
<a class="sourceLine" id="cb1807-46" data-line-number="46">              <span class="kw">aes</span>(<span class="dt">y =</span> lambda, <span class="dt">ymin =</span> .lower, <span class="dt">ymax =</span> .upper),</a>
<a class="sourceLine" id="cb1807-47" data-line-number="47">              <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>,</a>
<a class="sourceLine" id="cb1807-48" data-line-number="48">              <span class="dt">fill =</span> <span class="st">&quot;#394165&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>, <span class="dt">size =</span> <span class="fl">1.1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-49" data-line-number="49"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1807-50" data-line-number="50">             <span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">size =</span> logpop), </a>
<a class="sourceLine" id="cb1807-51" data-line-number="51">             <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-52" data-line-number="52"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">group =</span> group, <span class="dt">alpha =</span> correlation<span class="op">^</span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1807-53" data-line-number="53">            <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-54" data-line-number="54"><span class="st">  </span><span class="kw">geom_text_repel</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1807-55" data-line-number="55">                  <span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">label =</span> culture), </a>
<a class="sourceLine" id="cb1807-56" data-line-number="56">                  <span class="dt">seed =</span> <span class="dv">14</span>, <span class="dt">point.padding =</span> <span class="fl">.2</span>, <span class="dt">size =</span> <span class="fl">2.75</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-57" data-line-number="57"><span class="st">  </span><span class="kw">scale_alpha_continuous</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-58" data-line-number="58"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Shown against the relation between</span><span class="ch">\n</span><span class="st">total tools and log pop&quot;</span>,</a>
<a class="sourceLine" id="cb1807-59" data-line-number="59">       <span class="dt">x =</span> <span class="st">&quot;log population&quot;</span>,</a>
<a class="sourceLine" id="cb1807-60" data-line-number="60">       <span class="dt">y =</span> <span class="st">&quot;total tools&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-61" data-line-number="61"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(d<span class="op">$</span>logpop),</a>
<a class="sourceLine" id="cb1807-62" data-line-number="62">                  <span class="dt">ylim =</span> <span class="kw">range</span>(d<span class="op">$</span>total_tools)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1807-63" data-line-number="63"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a>
<a class="sourceLine" id="cb1807-64" data-line-number="64"></a>
<a class="sourceLine" id="cb1807-65" data-line-number="65"><span class="co"># combine</span></a>
<a class="sourceLine" id="cb1807-66" data-line-number="66">p1 <span class="op">+</span><span class="st"> </span>p2 <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1807-67" data-line-number="67"><span class="st">  </span><span class="kw">plot_annotation</span>(<span class="dt">title =</span> <span class="st">&quot;Posterior median correlations based on the gamma-Poisson model&quot;</span>) </a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-86-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>There is very little difference. Finish off by comparing the two models with the WAIC.</p>
<div class="sourceCode" id="cb1808"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1808-1" data-line-number="1">b14<span class="fl">.8</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b14<span class="fl">.8</span>, <span class="st">&quot;waic&quot;</span>)</a>
<a class="sourceLine" id="cb1808-2" data-line-number="2">b14<span class="fl">.8</span>_nb &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b14<span class="fl">.8</span>_nb, <span class="st">&quot;waic&quot;</span>)</a>
<a class="sourceLine" id="cb1808-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1808-4" data-line-number="4"><span class="kw">loo_compare</span>(b14<span class="fl">.8</span>, b14<span class="fl">.8</span>_nb, <span class="dt">criterion =</span> <span class="st">&quot;waic&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</a></code></pre></div>
<pre><code>##          elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic  se_waic
## b14.8      0.0       0.0   -33.4       1.3          3.7    0.6      66.8   2.6  
## b14.8_nb  -3.4       0.5   -36.8       1.7          3.3    0.6      73.7   3.5</code></pre>
<p>The WAIC comparison suggests we gain little by switching to the gamma-Poisson. If anything, we may have overfit.</p>
</div>
</div>
<div id="example-phylogenetic-distance." class="section level3">
<h3><span class="header-section-number">14.5.2</span> Example: Phylogenetic distance.</h3>
<blockquote>
<p>Consider as an example the causal influence of group size (<span class="math inline">\(G\)</span>) on brain size (<span class="math inline">\(B\)</span>). Hypotheses connecting these variables are popular, because primates (including humans) are unusual in both. Most primates live in social groups. Most mammals do not. Second, primates have relatively large brains. There is a family of hypotheses linking these two features. Suppose for example that group living, whatever its cause, could select for larger brains, because once you live with others, a larger brain helps to cope with the complexity of cooperation and manipulation. (p. 477)</p>
</blockquote>
<p>There are also many potential confounds, which we’ll call <span class="math inline">\(U\)</span>. Also imagine there are two time points, indicated by subscripts 1 and 2. Here is the basic DAG.</p>
<div class="sourceCode" id="cb1810"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1810-1" data-line-number="1">dag_coords &lt;-</a>
<a class="sourceLine" id="cb1810-2" data-line-number="2"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">name  =</span> <span class="kw">c</span>(<span class="st">&quot;G1&quot;</span>, <span class="st">&quot;B1&quot;</span>, <span class="st">&quot;U1&quot;</span>, <span class="st">&quot;G2&quot;</span>, <span class="st">&quot;B2&quot;</span>, <span class="st">&quot;U2&quot;</span>),</a>
<a class="sourceLine" id="cb1810-3" data-line-number="3">         <span class="dt">x     =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">each =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1810-4" data-line-number="4">         <span class="dt">y     =</span> <span class="kw">rep</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">times =</span> <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb1810-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1810-6" data-line-number="6"><span class="kw">dagify</span>(G2 <span class="op">~</span><span class="st"> </span>G1 <span class="op">+</span><span class="st"> </span>U1,</a>
<a class="sourceLine" id="cb1810-7" data-line-number="7">       B2 <span class="op">~</span><span class="st"> </span>G1 <span class="op">+</span><span class="st"> </span>B1 <span class="op">+</span><span class="st"> </span>U1,</a>
<a class="sourceLine" id="cb1810-8" data-line-number="8">       U2 <span class="op">~</span><span class="st"> </span>U1,</a>
<a class="sourceLine" id="cb1810-9" data-line-number="9">       <span class="dt">coords =</span> dag_coords) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1810-10" data-line-number="10"><span class="st">  </span><span class="kw">tidy_dagitty</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1810-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">color =</span> <span class="kw">ifelse</span>(name <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;G1&quot;</span>, <span class="st">&quot;B1&quot;</span>), <span class="st">&quot;a&quot;</span>,</a>
<a class="sourceLine" id="cb1810-12" data-line-number="12">                        <span class="kw">ifelse</span>(name <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;G2&quot;</span>, <span class="st">&quot;B2&quot;</span>), <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1810-13" data-line-number="13"><span class="st">  </span></a>
<a class="sourceLine" id="cb1810-14" data-line-number="14"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">xend =</span> xend, <span class="dt">yend =</span> yend)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1810-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_dag_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> color),</a>
<a class="sourceLine" id="cb1810-16" data-line-number="16">                 <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">stroke =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">7</span>, <span class="dt">show.legend =</span> F) <span class="op">+</span></a>
<a class="sourceLine" id="cb1810-17" data-line-number="17"><span class="st">  </span><span class="kw">geom_dag_text</span>(<span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>, <span class="dt">parse =</span> T,</a>
<a class="sourceLine" id="cb1810-18" data-line-number="18">                <span class="dt">label =</span> <span class="kw">c</span>(<span class="kw">expression</span>(B[<span class="dv">1</span>]), <span class="kw">expression</span>(G[<span class="dv">1</span>]), <span class="kw">expression</span>(U[<span class="dv">1</span>]), </a>
<a class="sourceLine" id="cb1810-19" data-line-number="19">                          <span class="kw">expression</span>(B[<span class="dv">2</span>]), <span class="kw">expression</span>(G[<span class="dv">2</span>]), <span class="kw">expression</span>(U[<span class="dv">2</span>]))) <span class="op">+</span></a>
<a class="sourceLine" id="cb1810-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_dag_edges</span>(<span class="dt">edge_colour =</span> <span class="st">&quot;#FCF9F0&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1810-21" data-line-number="21"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#EEDA9D&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1810-22" data-line-number="22"><span class="st">  </span><span class="kw">theme_pearl_dag</span>()</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-88-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>However, this will not be our model. Rather, we’ll consider this one.</p>
<div class="sourceCode" id="cb1811"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1811-1" data-line-number="1">dag_coords &lt;-</a>
<a class="sourceLine" id="cb1811-2" data-line-number="2"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">name =</span> <span class="kw">c</span>(<span class="st">&quot;G&quot;</span>, <span class="st">&quot;U&quot;</span>, <span class="st">&quot;M&quot;</span>, <span class="st">&quot;P&quot;</span>, <span class="st">&quot;B&quot;</span>),</a>
<a class="sourceLine" id="cb1811-3" data-line-number="3">         <span class="dt">x    =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1811-4" data-line-number="4">         <span class="dt">y    =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb1811-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1811-6" data-line-number="6"><span class="kw">dagify</span>(G <span class="op">~</span><span class="st"> </span>U <span class="op">+</span><span class="st"> </span>M,</a>
<a class="sourceLine" id="cb1811-7" data-line-number="7">       U <span class="op">~</span><span class="st"> </span>P,</a>
<a class="sourceLine" id="cb1811-8" data-line-number="8">       M <span class="op">~</span><span class="st"> </span>U,</a>
<a class="sourceLine" id="cb1811-9" data-line-number="9">       B <span class="op">~</span><span class="st"> </span>G <span class="op">+</span><span class="st"> </span>M <span class="op">+</span><span class="st"> </span>U,</a>
<a class="sourceLine" id="cb1811-10" data-line-number="10">       <span class="dt">coords =</span> dag_coords) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1811-11" data-line-number="11"><span class="st">  </span></a>
<a class="sourceLine" id="cb1811-12" data-line-number="12"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">xend =</span> xend, <span class="dt">yend =</span> yend)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1811-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_dag_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> name <span class="op">==</span><span class="st"> &quot;U&quot;</span>),</a>
<a class="sourceLine" id="cb1811-14" data-line-number="14">                 <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">stroke =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">6</span>, <span class="dt">show.legend =</span> F) <span class="op">+</span></a>
<a class="sourceLine" id="cb1811-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_dag_text</span>(<span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>, <span class="dt">parse =</span> T) <span class="op">+</span></a>
<a class="sourceLine" id="cb1811-16" data-line-number="16"><span class="st">  </span><span class="kw">geom_dag_edges</span>(<span class="dt">edge_colour =</span> <span class="st">&quot;#FCF9F0&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1811-17" data-line-number="17"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#EEDA9D&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1811-18" data-line-number="18"><span class="st">  </span><span class="kw">theme_pearl_dag</span>()</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-89-1.png" width="288" style="display: block; margin: auto;" /></p>
<blockquote>
<p>There’s a lot going on here, but we can take it one piece at a time. Again, we’re interested in <span class="math inline">\(G \rightarrow B\)</span>. There is one confound we know for sure, body mass (<span class="math inline">\(M\)</span>). It possibly influences both <span class="math inline">\(G\)</span> and <span class="math inline">\(B\)</span>. So we’ll include that in the model. The unobserved confounds <span class="math inline">\(U\)</span> could potentially influence all three variables. Finally, we let the phylogenetic relationships (<span class="math inline">\(P\)</span>) influence <span class="math inline">\(U\)</span>. How is <span class="math inline">\(P\)</span> causal? If we traveled back in time and delayed a split between two species, it could influence the expected differences in their traits. So it is really the timing of the split that is causal, not the phylogeny. Of course <span class="math inline">\(P\)</span> may also influence <span class="math inline">\(G\)</span> and <span class="math inline">\(B\)</span> and <span class="math inline">\(M\)</span> directly. But those arrows aren’t our concern right now, so I’ve omitted them for clarity. (p. 478)</p>
</blockquote>
<p><strong>Phylogenetic regression</strong> models, which “use some function of phylogenetic distance to model the covariation among species” (p. 478) attempt to grapple with all this. To see how, load the primates data and its phylogeny <span class="citation">(see Street et al., <a href="#ref-streetCoevolutionCulturalIntelligence2017">2017</a>)</span>.</p>
<div class="sourceCode" id="cb1812"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1812-1" data-line-number="1"><span class="kw">library</span>(rethinking) </a>
<a class="sourceLine" id="cb1812-2" data-line-number="2"><span class="kw">data</span>(Primates301) </a>
<a class="sourceLine" id="cb1812-3" data-line-number="3"><span class="kw">data</span>(Primates301_nex)</a></code></pre></div>
<p>When working within the <strong>ggplot2</strong> framework, one can plot a phylogeny with help from the <a href="https://github.com/YuLab-SMU/ggtree"><strong>ggtree</strong> package</a> <span class="citation">(Yu, <a href="#ref-yuDataIntegrationManipulation2020">2020</a><a href="#ref-yuDataIntegrationManipulation2020">a</a>, <a href="#ref-yuUsingGgtreeVisualize2020">2020</a><a href="#ref-yuUsingGgtreeVisualize2020">b</a>; Yu et al., <a href="#ref-yuTwoMethodsMapping2018">2018</a>, <a href="#ref-yuGgtreePackageVisualization2017">2017</a>)</span>. To my knowledge, it is not currently available on CRAN but you can download it directly from GitHub with <code>devtools::install_github()</code>. Here’s a basic plot for our version of Figure 14.13.</p>
<div class="sourceCode" id="cb1813"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1813-1" data-line-number="1"><span class="co"># devtools::install_github(&quot;GuangchuangYu/ggtree&quot;)</span></a>
<a class="sourceLine" id="cb1813-2" data-line-number="2"><span class="kw">library</span>(ggtree)</a>
<a class="sourceLine" id="cb1813-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1813-4" data-line-number="4">Primates301_nex <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1813-5" data-line-number="5"><span class="st">  </span><span class="kw">ggtree</span>(<span class="dt">layout =</span> <span class="st">&quot;circular&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#394165&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1813-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_tiplab</span>(<span class="dt">size =</span> <span class="dv">5</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-91-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Let’s format the data.</p>
<div class="sourceCode" id="cb1814"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1814-1" data-line-number="1">d &lt;-</a>
<a class="sourceLine" id="cb1814-2" data-line-number="2"><span class="st">  </span>Primates301 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1814-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">as.character</span>(name)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1814-4" data-line-number="4"><span class="st">  </span><span class="kw">drop_na</span>(group_size, body, brain) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1814-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">m =</span> <span class="kw">log</span>(body) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">standardize</span>(),</a>
<a class="sourceLine" id="cb1814-6" data-line-number="6">         <span class="dt">b =</span> <span class="kw">log</span>(brain) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">standardize</span>(),</a>
<a class="sourceLine" id="cb1814-7" data-line-number="7">         <span class="dt">g =</span> <span class="kw">log</span>(group_size) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">standardize</span>())</a>
<a class="sourceLine" id="cb1814-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1814-9" data-line-number="9"><span class="kw">glimpse</span>(d)</a></code></pre></div>
<pre><code>## Rows: 151
## Columns: 19
## $ name                &lt;chr&gt; &quot;Allenopithecus_nigroviridis&quot;, &quot;Alouatta_belzebul&quot;, &quot;Alouatta_caraya&quot;, &quot;Alouatt…
## $ genus               &lt;fct&gt; Allenopithecus, Alouatta, Alouatta, Alouatta, Alouatta, Alouatta, Alouatta, Aot…
## $ species             &lt;fct&gt; nigroviridis, belzebul, caraya, guariba, palliata, pigra, seniculus, azarai, tr…
## $ subspecies          &lt;fct&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ spp_id              &lt;int&gt; 1, 3, 4, 5, 6, 7, 9, 10, 18, 22, 23, 25, 26, 28, 29, 32, 33, 34, 40, 41, 46, 49…
## $ genus_id            &lt;int&gt; 1, 3, 3, 3, 3, 3, 3, 4, 4, 6, 7, 7, 7, 8, 8, 10, 11, 11, 13, 14, 14, 14, 14, 15…
## $ social_learning     &lt;int&gt; 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 1, 17, 5, …
## $ research_effort     &lt;int&gt; 6, 15, 45, 37, 79, 25, 82, 22, 58, 1, 12, 58, 30, 10, 6, 24, 11, 8, 43, 16, 161…
## $ brain               &lt;dbl&gt; 58.02, 52.84, 52.63, 51.70, 49.88, 51.13, 55.22, 20.67, 16.85, 6.92, 117.02, 10…
## $ body                &lt;dbl&gt; 4655, 6395, 5383, 5175, 6250, 8915, 5950, 1205, 989, 309, 8167, 7535, 8280, 120…
## $ group_size          &lt;dbl&gt; 40.00, 7.40, 8.90, 7.40, 13.10, 5.50, 7.90, 4.10, 3.15, 1.00, 14.50, 42.00, 20.…
## $ gestation           &lt;dbl&gt; NA, NA, 185.92, NA, 185.42, 185.92, 189.90, NA, 133.47, 133.74, 138.20, 226.37,…
## $ weaning             &lt;dbl&gt; 106.15, NA, 323.16, NA, 495.60, NA, 370.04, 229.69, 76.21, 109.26, NA, 816.35, …
## $ longevity           &lt;dbl&gt; 276.0, NA, 243.6, NA, 300.0, 240.0, 300.0, NA, 303.6, 156.0, 336.0, 327.6, 453.…
## $ sex_maturity        &lt;dbl&gt; NA, NA, 1276.72, NA, 1578.42, NA, 1690.22, NA, 736.60, 298.91, NA, 2104.57, 210…
## $ maternal_investment &lt;dbl&gt; NA, NA, 509.08, NA, 681.02, NA, 559.94, NA, 209.68, 243.00, NA, 1042.72, 1033.5…
## $ m                   &lt;dbl&gt; 0.36958768, 0.57601585, 0.46403740, 0.43842259, 0.56110778, 0.79196303, 0.52913…
## $ b                   &lt;dbl&gt; 0.4039485, 0.3285765, 0.3253670, 0.3109981, 0.2821147, 0.3020630, 0.3640841, -0…
## $ g                   &lt;dbl&gt; 1.397272713, 0.003132082, 0.155626096, 0.003132082, 0.475005322, -0.242029791, …</code></pre>
<p>Our first model, which we might call the naïve model, explores the conditional relations of <span class="math inline">\(\log(\text{body mass})\)</span> and <span class="math inline">\(\log(\text{group size})\)</span> on <span class="math inline">\(\log(\text{brain size})\)</span> without accounting for phylogenetic relationships.</p>
<div class="sourceCode" id="cb1816"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1816-1" data-line-number="1">b14<span class="fl">.9</span> &lt;-</a>
<a class="sourceLine" id="cb1816-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d,</a>
<a class="sourceLine" id="cb1816-3" data-line-number="3">      <span class="dt">family =</span> gaussian,</a>
<a class="sourceLine" id="cb1816-4" data-line-number="4">      b <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>m <span class="op">+</span><span class="st"> </span>g,</a>
<a class="sourceLine" id="cb1816-5" data-line-number="5">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1816-6" data-line-number="6">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b),</a>
<a class="sourceLine" id="cb1816-7" data-line-number="7">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sigma)),</a>
<a class="sourceLine" id="cb1816-8" data-line-number="8">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1816-9" data-line-number="9">      <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1816-10" data-line-number="10">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.09&quot;</span>)</a></code></pre></div>
<p>Check the summary of the naïve model.</p>
<div class="sourceCode" id="cb1817"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1817-1" data-line-number="1"><span class="kw">print</span>(b14<span class="fl">.9</span>)</a></code></pre></div>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: b ~ 1 + m + g 
##    Data: d (Number of observations: 151) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept    -0.00      0.02    -0.04     0.03 1.00     3775     2475
## m             0.89      0.02     0.85     0.94 1.00     3044     2485
## g             0.12      0.02     0.08     0.17 1.00     3207     2158
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.22      0.01     0.19     0.24 1.00     3971     2911
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>If you want <span class="math inline">\(\sigma\)</span> in the <span class="math inline">\(\sigma^2\)</span> metric, you can square that by hand.</p>
<div class="sourceCode" id="cb1819"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1819-1" data-line-number="1"><span class="kw">posterior_samples</span>(b14<span class="fl">.9</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1819-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sigma_sq =</span> sigma<span class="op">^</span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1819-3" data-line-number="3"><span class="st">  </span><span class="kw">mean_qi</span>(sigma_sq) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1819-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##   sigma_sq .lower .upper .width .point .interval
## 1     0.05   0.04   0.06   0.95   mean        qi</code></pre>
<p>The oldest and most conservative way to include information about phylogenetic relationships is with a Brownian motion model.</p>
<blockquote>
<p>Brownian motion just means Gaussian random walks. If species traits drift randomly with respect to one another after speciation, then the covariance between a pair of species ends up being linearly related to the phylogenetic branch distance between them–the further apart, the less covariance, as a proportion of distance. (p. 481)</p>
</blockquote>
<p>We’ll use functions from the <a href="https://CRAN.R-project.org/package=ape"><strong>ape</strong> package</a> <span class="citation">(Paradis et al., <a href="#ref-R-ape">2020</a>; Paradis &amp; Schliep, <a href="#ref-ape2019">2019</a>)</span> to make the covariance matrix (<code>V</code>) and the distance matrix (<code>Dmat</code>).</p>
<div class="sourceCode" id="cb1821"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1821-1" data-line-number="1"><span class="kw">library</span>(ape)</a>
<a class="sourceLine" id="cb1821-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1821-3" data-line-number="3">spp_obs &lt;-<span class="st"> </span>d<span class="op">$</span>name</a>
<a class="sourceLine" id="cb1821-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1821-5" data-line-number="5">tree_trimmed &lt;-<span class="st"> </span><span class="kw">keep.tip</span>(Primates301_nex, spp_obs)</a>
<a class="sourceLine" id="cb1821-6" data-line-number="6">Rbm &lt;-<span class="st"> </span><span class="kw">corBrownian</span>(<span class="dt">phy =</span> tree_trimmed)</a>
<a class="sourceLine" id="cb1821-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1821-8" data-line-number="8">V &lt;-<span class="st"> </span><span class="kw">vcv</span>(Rbm)</a>
<a class="sourceLine" id="cb1821-9" data-line-number="9">Dmat &lt;-<span class="st"> </span><span class="kw">cophenetic</span>( tree_trimmed )</a></code></pre></div>
<p>Here’s the distance by covariance scatter plot McElreath alluded to but did not show in the text.</p>
<div class="sourceCode" id="cb1822"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1822-1" data-line-number="1"><span class="kw">full_join</span>(</a>
<a class="sourceLine" id="cb1822-2" data-line-number="2">  Dmat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1822-3" data-line-number="3"><span class="st">    </span><span class="kw">as_tibble</span>(<span class="dt">rownames =</span> <span class="st">&quot;row&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1822-4" data-line-number="4"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="op">-</span>row,</a>
<a class="sourceLine" id="cb1822-5" data-line-number="5">                 <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>,</a>
<a class="sourceLine" id="cb1822-6" data-line-number="6">                 <span class="dt">values_to =</span> <span class="st">&quot;distance&quot;</span>),</a>
<a class="sourceLine" id="cb1822-7" data-line-number="7">  V <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1822-8" data-line-number="8"><span class="st">    </span><span class="kw">as_tibble</span>(<span class="dt">rownames =</span> <span class="st">&quot;row&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1822-9" data-line-number="9"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="op">-</span>row,</a>
<a class="sourceLine" id="cb1822-10" data-line-number="10">                 <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>,</a>
<a class="sourceLine" id="cb1822-11" data-line-number="11">                 <span class="dt">values_to =</span> <span class="st">&quot;covariance&quot;</span>),</a>
<a class="sourceLine" id="cb1822-12" data-line-number="12">  <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;row&quot;</span>, <span class="st">&quot;col&quot;</span>)</a>
<a class="sourceLine" id="cb1822-13" data-line-number="13">) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1822-14" data-line-number="14"><span class="st">  </span></a>
<a class="sourceLine" id="cb1822-15" data-line-number="15"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> distance, <span class="dt">y =</span> covariance)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1822-16" data-line-number="16"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1822-17" data-line-number="17"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;These variables are the</span><span class="ch">\n</span><span class="st">inverse of one another.&quot;</span>,</a>
<a class="sourceLine" id="cb1822-18" data-line-number="18">       <span class="dt">x =</span> <span class="st">&quot;phylogenetic distance&quot;</span>, </a>
<a class="sourceLine" id="cb1822-19" data-line-number="19">       <span class="dt">y =</span> <span class="st">&quot;covariance&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-97-1.png" width="312" style="display: block; margin: auto;" /></p>
<p>McElreath suggested executing <code>image(V)</code> and <code>image(Dmat)</code> to plot heat maps of each matrix. We’ll have to work a little harder to make decent-looking head maps within our <strong>tidyverse</strong> workflow.</p>
<div class="sourceCode" id="cb1823"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1823-1" data-line-number="1"><span class="co"># headmap of Dmat</span></a>
<a class="sourceLine" id="cb1823-2" data-line-number="2">p1 &lt;-</a>
<a class="sourceLine" id="cb1823-3" data-line-number="3"><span class="st">  </span>Dmat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1823-4" data-line-number="4"><span class="st">  </span><span class="kw">as_tibble</span>(<span class="dt">rownames =</span> <span class="st">&quot;row&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1823-5" data-line-number="5"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>row,</a>
<a class="sourceLine" id="cb1823-6" data-line-number="6">               <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>,</a>
<a class="sourceLine" id="cb1823-7" data-line-number="7">               <span class="dt">values_to =</span> <span class="st">&quot;distance&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1823-8" data-line-number="8"><span class="st">  </span></a>
<a class="sourceLine" id="cb1823-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> col, <span class="dt">y =</span> row, <span class="dt">fill =</span> distance)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1823-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_tile</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb1823-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="dt">low =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1823-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1823-13" data-line-number="13"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1823-14" data-line-number="14"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;top&quot;</span>)</a>
<a class="sourceLine" id="cb1823-15" data-line-number="15"></a>
<a class="sourceLine" id="cb1823-16" data-line-number="16"><span class="co"># headmap of V</span></a>
<a class="sourceLine" id="cb1823-17" data-line-number="17">p2 &lt;-</a>
<a class="sourceLine" id="cb1823-18" data-line-number="18"><span class="st">  </span>V <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1823-19" data-line-number="19"><span class="st">  </span><span class="kw">as_tibble</span>(<span class="dt">rownames =</span> <span class="st">&quot;row&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1823-20" data-line-number="20"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>row,</a>
<a class="sourceLine" id="cb1823-21" data-line-number="21">               <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>,</a>
<a class="sourceLine" id="cb1823-22" data-line-number="22">               <span class="dt">values_to =</span> <span class="st">&quot;covariance&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1823-23" data-line-number="23"><span class="st">  </span></a>
<a class="sourceLine" id="cb1823-24" data-line-number="24"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> col, <span class="dt">y =</span> row, <span class="dt">fill =</span> covariance)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1823-25" data-line-number="25"><span class="st">  </span><span class="kw">geom_tile</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb1823-26" data-line-number="26"><span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="dt">low =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1823-27" data-line-number="27"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1823-28" data-line-number="28"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1823-29" data-line-number="29"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;top&quot;</span>)</a>
<a class="sourceLine" id="cb1823-30" data-line-number="30"></a>
<a class="sourceLine" id="cb1823-31" data-line-number="31"><span class="co"># combine</span></a>
<a class="sourceLine" id="cb1823-32" data-line-number="32">(p1 <span class="op">|</span><span class="st"> </span>p2) <span class="op">+</span><span class="st"> </span><span class="kw">plot_annotation</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Again, distance is the inverse of covariance.&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-98-1.png" width="600" style="display: block; margin: auto;" /></p>
<p>Within the <strong>brms</strong> paradigm, one inserts a known covariance matrix into a model using the <code>fcor()</code> function. For any longer-term <strong>brms</strong> users, <code>fcor()</code> is the replacement for the now-depreciated <code>cor_fixed()</code> function. Along with <code>fcor()</code>, one tells <strong>brms</strong> about the data with the <code>data2</code> function. Here’s how to use it for our version of McElreath’s <code>m14.10</code>.</p>
<div class="sourceCode" id="cb1824"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1824-1" data-line-number="1">R &lt;-<span class="st"> </span>V[spp_obs, spp_obs] <span class="op">/</span><span class="st"> </span><span class="kw">max</span>(V)</a>
<a class="sourceLine" id="cb1824-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1824-3" data-line-number="3">b14<span class="fl">.10</span> &lt;-</a>
<a class="sourceLine" id="cb1824-4" data-line-number="4"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d,</a>
<a class="sourceLine" id="cb1824-5" data-line-number="5">      <span class="dt">data2 =</span> <span class="kw">list</span>(<span class="dt">R =</span> R),</a>
<a class="sourceLine" id="cb1824-6" data-line-number="6">      <span class="dt">family =</span> gaussian,</a>
<a class="sourceLine" id="cb1824-7" data-line-number="7">      b <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>m <span class="op">+</span><span class="st"> </span>g <span class="op">+</span><span class="st"> </span><span class="kw">fcor</span>(R),</a>
<a class="sourceLine" id="cb1824-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1824-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">class =</span> b),</a>
<a class="sourceLine" id="cb1824-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sigma)),</a>
<a class="sourceLine" id="cb1824-11" data-line-number="11">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1824-12" data-line-number="12">      <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1824-13" data-line-number="13">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.10&quot;</span>)</a></code></pre></div>
<p>Check the summary of the Brownian model.</p>
<div class="sourceCode" id="cb1825"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1825-1" data-line-number="1"><span class="kw">print</span>(b14<span class="fl">.10</span>)</a></code></pre></div>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: b ~ 1 + m + g + fcor(R) 
##    Data: d (Number of observations: 151) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept    -0.19      0.16    -0.51     0.12 1.00     4451     3315
## m             0.70      0.04     0.63     0.77 1.00     4336     2704
## g            -0.01      0.02    -0.05     0.03 1.00     3996     2711
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.40      0.02     0.36     0.45 1.00     4152     2551
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Since our residual variance is still in the <span class="math inline">\(\sigma\)</span> metric, it will be easier to compare it to McElreath’s <code>sigma_sq</code> parameter after transforming the posterior samples.</p>
<div class="sourceCode" id="cb1827"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1827-1" data-line-number="1"><span class="kw">posterior_samples</span>(b14<span class="fl">.10</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1827-2" data-line-number="2"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">sigma_sq =</span> sigma<span class="op">^</span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1827-3" data-line-number="3"><span class="st">  </span><span class="kw">mean_hdi</span>(sigma_sq, <span class="dt">.width =</span> <span class="fl">.89</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1827-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##   sigma_sq .lower .upper .width .point .interval
## 1     0.16   0.13   0.19   0.89   mean       hdi</code></pre>
<p>McElreath introduced the Ornstein–Uhlenbeck (OU) process as an alternative to the Brownian motion model. The OU model proposes the covariance between two species <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> is</p>
<p><span class="math display">\[K(i, j) = \eta^2 \exp(\rho^2 D_{ij}),\]</span></p>
<p>where, in our case, <span class="math inline">\(D_{ij}\)</span> is the distance matrix we’ve saved above as <code>Dmat</code>. Sadly for us, <strong>brms</strong> only supports the exponentiated-quadratic kernel for Gaussian process models, at this time. However, the Ornstein–Uhlenbeck kernel is one of the alternative kernels Bürkner has on his to-do list (see <a href="https://github.com/paul-buerkner/brms/issues/234">GitHub issue #234</a>). To follow along with McElreath, we will have to use <strong>rethinking</strong> or raw Stan. Our approach will be the former. First we make the <code>dat_list</code>.</p>
<div class="sourceCode" id="cb1829"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1829-1" data-line-number="1">dat_list &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1829-2" data-line-number="2"><span class="st">  </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb1829-3" data-line-number="3">    <span class="dt">N_spp =</span> <span class="kw">nrow</span>(d),</a>
<a class="sourceLine" id="cb1829-4" data-line-number="4">    <span class="dt">M     =</span> <span class="kw">standardize</span>(<span class="kw">log</span>(d<span class="op">$</span>body)),</a>
<a class="sourceLine" id="cb1829-5" data-line-number="5">    <span class="dt">B     =</span> <span class="kw">standardize</span>(<span class="kw">log</span>(d<span class="op">$</span>brain)),</a>
<a class="sourceLine" id="cb1829-6" data-line-number="6">    <span class="dt">G     =</span> <span class="kw">standardize</span>(<span class="kw">log</span>(d<span class="op">$</span>group_size)), <span class="dt">Imat =</span> <span class="kw">diag</span>(<span class="kw">nrow</span>(d)),</a>
<a class="sourceLine" id="cb1829-7" data-line-number="7">    <span class="dt">V     =</span> V[spp_obs, spp_obs],</a>
<a class="sourceLine" id="cb1829-8" data-line-number="8">    <span class="dt">R     =</span> V[spp_obs, spp_obs] <span class="op">/</span><span class="st"> </span><span class="kw">max</span>(V[spp_obs, spp_obs]),</a>
<a class="sourceLine" id="cb1829-9" data-line-number="9">    <span class="dt">Dmat  =</span> Dmat[spp_obs, spp_obs] <span class="op">/</span><span class="st"> </span><span class="kw">max</span>(Dmat)</a>
<a class="sourceLine" id="cb1829-10" data-line-number="10">  )</a></code></pre></div>
<p>Now fit the OU model with <code>rethinking::ulam()</code>.</p>
<div class="sourceCode" id="cb1830"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1830-1" data-line-number="1">m14<span class="fl">.11</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1830-2" data-line-number="2"><span class="st">  </span><span class="kw">ulam</span>( </a>
<a class="sourceLine" id="cb1830-3" data-line-number="3">    <span class="kw">alist</span>(</a>
<a class="sourceLine" id="cb1830-4" data-line-number="4">      B <span class="op">~</span><span class="st"> </span><span class="kw">multi_normal</span>(mu, SIGMA),</a>
<a class="sourceLine" id="cb1830-5" data-line-number="5">      mu &lt;-<span class="st"> </span>a <span class="op">+</span><span class="st"> </span>bM <span class="op">*</span><span class="st"> </span>M <span class="op">+</span><span class="st"> </span>bG <span class="op">*</span><span class="st"> </span>G,</a>
<a class="sourceLine" id="cb1830-6" data-line-number="6">      matrix[N_spp,N_spp]<span class="op">:</span><span class="st"> </span>SIGMA &lt;-<span class="st"> </span><span class="kw">cov_GPL1</span>(Dmat, etasq, rhosq, <span class="fl">0.01</span>), </a>
<a class="sourceLine" id="cb1830-7" data-line-number="7">      a <span class="op">~</span><span class="st"> </span><span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1830-8" data-line-number="8">      <span class="kw">c</span>(bM,bG) <span class="op">~</span><span class="st"> </span><span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>),</a>
<a class="sourceLine" id="cb1830-9" data-line-number="9">      etasq <span class="op">~</span><span class="st"> </span><span class="kw">half_normal</span>(<span class="dv">1</span>, <span class="fl">0.25</span>),</a>
<a class="sourceLine" id="cb1830-10" data-line-number="10">      rhosq <span class="op">~</span><span class="st"> </span><span class="kw">half_normal</span>(<span class="dv">3</span>, <span class="fl">0.25</span>)</a>
<a class="sourceLine" id="cb1830-11" data-line-number="11">    ), </a>
<a class="sourceLine" id="cb1830-12" data-line-number="12">    <span class="dt">data =</span> dat_list, </a>
<a class="sourceLine" id="cb1830-13" data-line-number="13">    <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>)</a></code></pre></div>
<p>Happily, our results are much like those in the text.</p>
<div class="sourceCode" id="cb1831"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1831-1" data-line-number="1"><span class="kw">precis</span>(m14<span class="fl">.11</span>)</a></code></pre></div>
<pre><code>##              mean          sd        5.5%      94.5%    n_eff     Rhat4
## a     -0.06685178 0.078105688 -0.19439289 0.05394255 2395.814 1.0009010
## bG     0.04879575 0.023524685  0.01150523 0.08657337 1842.324 1.0017992
## bM     0.83489313 0.029181439  0.78727399 0.87972311 1888.968 0.9998068
## etasq  0.03501903 0.006619957  0.02554830 0.04624305 1927.700 0.9992260
## rhosq  2.80390498 0.248733524  2.38440028 3.18522999 2060.497 0.9988617</code></pre>
<p>To get a sense of the covariance function implied by <code>etasq</code> and <code>rhosq</code>, here we’ll plot the posterior against the prior for our <strong>tidyverse</strong> variant of Figure 14.14.</p>
<div class="sourceCode" id="cb1833"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1833-1" data-line-number="1">post &lt;-<span class="st"> </span><span class="kw">extract.samples</span>(m14<span class="fl">.11</span>)</a>
<a class="sourceLine" id="cb1833-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1833-3" data-line-number="3"><span class="kw">set.seed</span>(<span class="dv">14</span>)</a>
<a class="sourceLine" id="cb1833-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1833-5" data-line-number="5"><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb1833-6" data-line-number="6">  <span class="co"># posterior</span></a>
<a class="sourceLine" id="cb1833-7" data-line-number="7">  post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1833-8" data-line-number="8"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1833-9" data-line-number="9"><span class="st">    </span><span class="kw">sample_n</span>(<span class="dt">size =</span> <span class="dv">30</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1833-10" data-line-number="10"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">iter =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1833-11" data-line-number="11"><span class="st">    </span>tidyr<span class="op">::</span><span class="kw">expand</span>(<span class="kw">nesting</span>(iter, etasq, rhosq),</a>
<a class="sourceLine" id="cb1833-12" data-line-number="12">                  <span class="dt">d_seq =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">1</span>, <span class="dt">length.out =</span> <span class="dv">50</span>)),</a>
<a class="sourceLine" id="cb1833-13" data-line-number="13">  <span class="co"># prior</span></a>
<a class="sourceLine" id="cb1833-14" data-line-number="14">  <span class="kw">tibble</span>(<span class="dt">eta =</span> <span class="kw">abs</span>(<span class="kw">rnorm</span>(<span class="fl">1e5</span>, <span class="dt">mean =</span> <span class="dv">1</span>, <span class="dt">sd =</span> <span class="fl">0.25</span>)),</a>
<a class="sourceLine" id="cb1833-15" data-line-number="15">         <span class="dt">rho =</span> <span class="kw">abs</span>(<span class="kw">rnorm</span>(<span class="fl">1e5</span>, <span class="dt">mean =</span> <span class="dv">3</span>, <span class="dt">sd =</span> <span class="fl">0.25</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1833-16" data-line-number="16"><span class="st">    </span>tidyr<span class="op">::</span><span class="kw">expand</span>(<span class="kw">nesting</span>(eta, rho), </a>
<a class="sourceLine" id="cb1833-17" data-line-number="17">                  <span class="dt">d_seq =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">1</span>, <span class="dt">length.out =</span> <span class="dv">50</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1833-18" data-line-number="18"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">k =</span> eta <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>rho <span class="op">*</span><span class="st"> </span>d_seq)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1833-19" data-line-number="19"><span class="st">    </span><span class="kw">group_by</span>(d_seq) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1833-20" data-line-number="20"><span class="st">    </span><span class="kw">mean_hdi</span>(k, <span class="dt">.width =</span> <span class="fl">.89</span>),</a>
<a class="sourceLine" id="cb1833-21" data-line-number="21">  <span class="co"># join them</span></a>
<a class="sourceLine" id="cb1833-22" data-line-number="22">  <span class="dt">by =</span> <span class="st">&quot;d_seq&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1833-23" data-line-number="23"><span class="st">  </span></a>
<a class="sourceLine" id="cb1833-24" data-line-number="24"><span class="st">  </span><span class="co"># plot!</span></a>
<a class="sourceLine" id="cb1833-25" data-line-number="25"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> d_seq)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1833-26" data-line-number="26"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> etasq <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>rhosq <span class="op">*</span><span class="st"> </span>d_seq), <span class="dt">group =</span> iter),</a>
<a class="sourceLine" id="cb1833-27" data-line-number="27">            <span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1833-28" data-line-number="28"><span class="st">  </span><span class="kw">geom_lineribbon</span>(<span class="dt">data =</span> . <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(iter <span class="op">==</span><span class="st"> </span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1833-29" data-line-number="29">            <span class="kw">aes</span>(<span class="dt">y =</span> k, <span class="dt">ymin =</span> .lower, <span class="dt">ymax =</span> .upper),</a>
<a class="sourceLine" id="cb1833-30" data-line-number="30">            <span class="dt">color =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1833-31" data-line-number="31"><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>,</a>
<a class="sourceLine" id="cb1833-32" data-line-number="32">           <span class="dt">x =</span> <span class="kw">c</span>(<span class="fl">0.2</span>, <span class="fl">0.5</span>), <span class="dt">y =</span> <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>),</a>
<a class="sourceLine" id="cb1833-33" data-line-number="33">           <span class="dt">label =</span> <span class="kw">c</span>(<span class="st">&quot;posterior&quot;</span>, <span class="st">&quot;prior&quot;</span>),</a>
<a class="sourceLine" id="cb1833-34" data-line-number="34">           <span class="dt">color =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#E7CDC2&quot;</span>),</a>
<a class="sourceLine" id="cb1833-35" data-line-number="35">           <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1833-36" data-line-number="36"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;phylogenetic distance&quot;</span>, </a>
<a class="sourceLine" id="cb1833-37" data-line-number="37">       <span class="dt">y =</span> <span class="st">&quot;covariance&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1833-38" data-line-number="38"><span class="st">  </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">1.5</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-104-1.png" width="312" style="display: block; margin: auto;" /></p>
<blockquote>
<p>There just isn’t a lot of phylogenetic covariance for brain sizes, at least according to this model and these data. As a result, the phylogenetic distance doesn’t completely explain away the association between group size and brain size, as it did in the Brownian motion model. (p. 485)</p>
</blockquote>
<p>For a thorough discussion on how to fit phylogenetic models with <strong>brms</strong>, particularly within the multilevel paradigm, see Bürkner’s <span class="citation">(<a href="#ref-Bürkner2020Phylogenetic">2020</a><a href="#ref-Bürkner2020Phylogenetic">f</a>)</span> vignette, <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_phylogenetics.html"><em>Estimating phylogenetic multilevel models with brms</em></a>.</p>
</div>
</div>
<div id="summary-bonus-multilevel-growth-models-and-the-melsm" class="section level2">
<h2><span class="header-section-number">14.6</span> <del>Summary</del> Bonus: Multilevel growth models and the MELSM</h2>
<p>To this point in the chapter and most of the text, the data have largely had a cross-sectional feel. In fairness, we did incorporate an element of time with the café example from model <code>b14.1</code> by looking at the differences between mornings and evenings. However, even then we collapsed across longer time spans, such as days, weeks, months, and so on. One of the two goals of this bonus section to provide a brief introduction multilevel models designed to express change over time. The particular brand of multilevel models we’ll focus on are often called multilevel growth models. Though we will focus on simple linear models, this basic framework can be generalized along many lines. The second goal is to build on our appreciation of covariance structures by introducing a class of multilevel models designed to investigate variation in variation called the mixed-effects location scale models (MELSM). For our final model, we get a little fancy and fit a multivariate MELSM.</p>
<div id="borrow-some-data." class="section level3">
<h3><span class="header-section-number">14.6.1</span> Borrow some data.</h3>
<p>All the models in this bonus section are based on the preprint by <span class="citation">Williams, Liu, et al. (<a href="#ref-williamsBayesianMultivariateMixedeffects2019a">2019</a>)</span>, <a href="https://psyarxiv.com/4kfjp"><em>Bayesian multivariate mixed-effects location scale modeling of longitudinal relations among affective traits, states, and physical activity</em></a>. Williams and colleagues’ data and supporting scripts are available in the <code>example_analyses</code> folder from their OSF project at <a href="https://osf.io/3bmdh/">https://osf.io/3bmdh/</a>. You can also download the data from the <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/tree/master/data"><code>data</code> folder</a> of this ebook’s GitHub repo.</p>
<p>Load the data.</p>
<div class="sourceCode" id="cb1834"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1834-1" data-line-number="1">dat &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1834-2" data-line-number="2"><span class="st">  </span>readr<span class="op">::</span><span class="kw">read_csv</span>(<span class="st">&quot;/Users/solomonkurz/Dropbox/Recoding Statistical Rethinking 2nd ed/data/m_melsm_dat.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1834-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">day01 =</span> (day <span class="op">-</span><span class="st"> </span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span><span class="kw">max</span>((day <span class="op">-</span><span class="st"> </span><span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb1834-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1834-5" data-line-number="5"><span class="kw">glimpse</span>(dat)</a></code></pre></div>
<pre><code>## Rows: 13,033
## Columns: 10
## $ X1        &lt;dbl&gt; 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 24, 25, 26, 27, 2…
## $ P_A.std   &lt;dbl&gt; 1.74740876, -0.23109384, 0.34155950, 0.45664827, -0.23484069, 1.12785344, 1.11272629, 0.5…
## $ day       &lt;dbl&gt; 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 24, 25, 26, 27, 2…
## $ P_A.lag   &lt;dbl&gt; 0.7478597, 1.4674156, -0.3772641, 0.1286055, 0.3292090, 1.4107233, 0.7696644, 0.7304159, …
## $ N_A.lag   &lt;dbl&gt; 0.25399356, -0.85363386, 0.96144592, -0.19620339, -0.16047347, -0.90365575, -0.77502805, …
## $ steps.pm  &lt;dbl&gt; 0.955171, 0.955171, 0.955171, 0.955171, 0.955171, 0.955171, 0.955171, 0.955171, 0.955171,…
## $ steps.pmd &lt;dbl&gt; 0.5995578, -0.3947168, -1.5193587, -1.3442335, 0.4175970, -0.3231042, 0.3764198, 0.317665…
## $ record_id &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ N_A.std   &lt;dbl&gt; -0.73357975, 0.53856559, 0.60161616, 0.27807249, 0.54674641, 0.05660701, -0.08417053, 0.1…
## $ day01     &lt;dbl&gt; 0.00000000, 0.01020408, 0.02040816, 0.03061224, 0.04081633, 0.05102041, 0.06122449, 0.071…</code></pre>
<p>These data are from 193 participants.</p>
<div class="sourceCode" id="cb1836"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1836-1" data-line-number="1"><span class="kw">distinct</span>(dat, record_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1836-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>()</a></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##       n
##   &lt;int&gt;
## 1   193</code></pre>
<p>Participants were asked to complete self-report ratings once a day for a few months. People varied by how many days they participated in the study, with number of days ranging from 8 to 99 and a median of 74.</p>
<div class="sourceCode" id="cb1838"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1838-1" data-line-number="1">dat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1838-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>(record_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1838-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">median =</span> <span class="kw">median</span>(n),</a>
<a class="sourceLine" id="cb1838-4" data-line-number="4">            <span class="dt">min =</span> <span class="kw">min</span>(n),</a>
<a class="sourceLine" id="cb1838-5" data-line-number="5">            <span class="dt">max =</span> <span class="kw">max</span>(n))</a></code></pre></div>
<pre><code>## # A tibble: 1 x 3
##   median   min   max
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1     74     8    99</code></pre>
<p>Here is a plot of that distribution.</p>
<div class="sourceCode" id="cb1840"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1840-1" data-line-number="1">dat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1840-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>(record_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1840-3" data-line-number="3"><span class="st">  </span></a>
<a class="sourceLine" id="cb1840-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> n)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1840-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">fill =</span> <span class="st">&quot;#B1934A&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1840-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;number of days&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="ot">NA</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1840-7" data-line-number="7"><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-108-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>Our primary variables of interest were taken from the Positive and Negative Affect Schedule <span class="citation">(PANAS, Watson et al., <a href="#ref-watsonPANASDevelopment1988">1988</a>)</span>, which is widely used in certain areas of psychology to measure mood or emotion. In this study, participants completed the PANAS once a day by endorsing the extent to which they experienced various positive (e.g., excited, inspired) and negative (e.g., upset, afraid) emotional states. These responses are summed into two composite scores: positive affect (PA) and negative affect (NA). In the current data, the standardized versions of these scores are in the <code>P_A.std</code> and <code>N_A.std</code> columns, respectively. To get a sense of what these look like, here are the daily <code>N_A.std</code> scores from a random sample of 16 participants.</p>
<div class="sourceCode" id="cb1841"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1841-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">14</span>)</a>
<a class="sourceLine" id="cb1841-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1841-3" data-line-number="3">dat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1841-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>(<span class="dt">data =</span> <span class="kw">c</span>(X1, P_A.std, day, P_A.lag, N_A.lag, steps.pm, steps.pmd, N_A.std, day01)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1841-5" data-line-number="5"><span class="st">  </span><span class="kw">sample_n</span>(<span class="dt">size =</span> <span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1841-6" data-line-number="6"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1841-7" data-line-number="7"><span class="st">  </span></a>
<a class="sourceLine" id="cb1841-8" data-line-number="8"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> day, <span class="dt">y =</span> N_A.lag)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1841-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1841-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1841-11" data-line-number="11"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;negative affect (standardized)&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1841-12" data-line-number="12"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>record_id)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-109-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="conventional-multilevel-growth-model." class="section level3">
<h3><span class="header-section-number">14.6.2</span> Conventional multilevel growth model.</h3>
<p>In the social sciences, a typical way to analyze data like these is with a multilevel growth model in which participants vary in their intercepts (starting point) and time slopes (change over time). In the sample of the data, above, it looks like most participants have fairly constant levels of NA over time (i.e., near-zero slopes) but some (e.g., #128 and 147) show some evidence of systemic decreases in NA (i.e., negative slopes). There is also some variation in starting points, though most of the participants in this subset of the data seemed to have endorsed relatively low levels of NA both at baseline and throughout the study.</p>
<p>We want a model that can capture all these kinds of variation. Eventually, we will fit a model that accounts for both PA and NA. But to keep things simple while we’re warming up, we will restrict our focus to NA. If we let <span class="math inline">\(\text{NA}_{ij}\)</span> be the standardized NA score for the <span class="math inline">\(i\)</span>th participant on the <span class="math inline">\(j\)</span>th day, our first Bayesian multilevel growth model will follow the form</p>
<p><span class="math display">\[\begin{align*}
\text{NA}_{ij} &amp; \sim \operatorname{Normal}\begin{pmatrix} \mu_{ij}, \sigma \end{pmatrix} \\
\mu_{ij}       &amp; = \beta_0 + \beta_1 \text{time}_{ij} + u_{0i} + u_{1i} \text{time}_{ij} \\
\sigma &amp; = \sigma_\epsilon \\
\begin{bmatrix} u_{0i} \\ u_{1i} \end{bmatrix} &amp; \sim \operatorname{MVNormal}\begin{pmatrix} \begin{bmatrix} 0 \\ 0 \end{bmatrix}, \mathbf S \mathbf R \mathbf S \end{pmatrix} \\
\mathbf S &amp; = \begin{bmatrix} \sigma_0 &amp; 0 \\ 0 &amp; \sigma_1 \end{bmatrix} \\
\mathbf R &amp; = \begin{bmatrix} 1 &amp; \rho_{12} \\ \rho_{21} &amp; 1 \end{bmatrix} \\
\beta_0   &amp; \sim \operatorname{Normal}(0, 0.2) \\
\beta_1   &amp; \sim \operatorname{Normal}(0, 1) \\
\sigma_0 \text{ and } \sigma_1 &amp; \sim \operatorname{Exponential}(1) \\
\sigma_\epsilon &amp; \sim \operatorname{Exponential}(1) \\
\mathbf R &amp; \sim \operatorname{LKJ}(2),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\beta_0\)</span> is the intercept (i.e., starting point) and <span class="math inline">\(u_{0i}\)</span> captures variations in that intercept across participants. Similarly, <span class="math inline">\(\beta_1\)</span> is the slope depicting linear change in <span class="math inline">\(\text{NA}\)</span> across time and <span class="math inline">\(u_{1i}\)</span> captures variations in that linear change across participants. The <span class="math inline">\(u_{0i}\)</span> and <span class="math inline">\(u_{1i}\)</span> parameters are modeled as multivariate normal with zero means (i.e., they are deviations from the population parameters) and standard deviations <span class="math inline">\(\sigma_0\)</span> and <span class="math inline">\(\sigma_1\)</span>. We express the correlation between those two group-level <span class="math inline">\(\sigma\)</span> parameters with <span class="math inline">\(\mathbf R\)</span>, the symmetric correlation matrix. Here we just have one correlation, <span class="math inline">\(\rho_{21}\)</span>, which is the same as <span class="math inline">\(\rho_{12}\)</span>. Finally, variation not accounted for by the other parameters is captured by the single parameter <span class="math inline">\(\sigma_\epsilon\)</span>, which is often just called <span class="math inline">\(\epsilon\)</span>.</p>
<p>We have two variables measuring time in these data. The <code>day</code> variable measures time by integers, ranging from 2 to 100. To make it a little easier to set the priors and fit the model with Stan, we have a rescaled version of the variable, <code>day01</code>, which ranges from 0 to 1. In this way, <span class="math inline">\(\beta_0\)</span> is the value for the first day in the data set and <span class="math inline">\(\beta_1\)</span> is the expected change by the end of the collection (i.e., the 100th day). For consistency, we are largely following McElreath’s weakly-regularizing approach to priors.</p>
<p>You may have noticed my statistical notation differs a bit from McElreath’s, here. It follows a blend of sensibilities from McElreath, Williams, and from the notation I used in <a href="https://bookdown.org/content/4253/">my translation</a> of Singer and Willett’s <span class="citation">(<a href="#ref-singerAppliedLongitudinalData2003">2003</a>)</span> text, <a href="https://oxford.universitypressscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968"><em>Applied longitudinal data analysis: Modeling change and event occurrence</em></a>. I hope it’s clear.</p>
<p>Here is how to fit our simple multilevel growth model with <strong>brms</strong>.</p>
<div class="sourceCode" id="cb1842"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1842-1" data-line-number="1"><span class="co"># 5.583446 mins</span></a>
<a class="sourceLine" id="cb1842-2" data-line-number="2">b14<span class="fl">.12</span> &lt;-</a>
<a class="sourceLine" id="cb1842-3" data-line-number="3"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> dat,</a>
<a class="sourceLine" id="cb1842-4" data-line-number="4">      <span class="dt">family =</span> gaussian,</a>
<a class="sourceLine" id="cb1842-5" data-line-number="5">      N_A.std <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">|</span><span class="st"> </span>record_id),</a>
<a class="sourceLine" id="cb1842-6" data-line-number="6">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1842-7" data-line-number="7">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b),</a>
<a class="sourceLine" id="cb1842-8" data-line-number="8">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd),</a>
<a class="sourceLine" id="cb1842-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sigma),</a>
<a class="sourceLine" id="cb1842-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">2</span>), <span class="dt">class =</span> cor)),</a>
<a class="sourceLine" id="cb1842-11" data-line-number="11">      <span class="dt">iter =</span> <span class="dv">3000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1842-12" data-line-number="12">      <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1842-13" data-line-number="13">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.12&quot;</span>)</a></code></pre></div>
<p>Check the summary.</p>
<div class="sourceCode" id="cb1843"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1843-1" data-line-number="1"><span class="kw">print</span>(b14<span class="fl">.12</span>)</a></code></pre></div>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: N_A.std ~ 1 + day01 + (1 + day01 | record_id) 
##    Data: dat (Number of observations: 13033) 
## Samples: 4 chains, each with iter = 3000; warmup = 1000; thin = 1;
##          total post-warmup samples = 8000
## 
## Group-Level Effects: 
## ~record_id (Number of levels: 193) 
##                      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)            0.78      0.04     0.70     0.86 1.00     1396     2647
## sd(day01)                0.65      0.05     0.57     0.75 1.00     2952     4640
## cor(Intercept,day01)    -0.34      0.08    -0.49    -0.19 1.00     2874     4159
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     0.03      0.06    -0.08     0.14 1.00      809     1767
## day01        -0.16      0.06    -0.27    -0.04 1.00     1778     3357
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.61      0.00     0.60     0.62 1.00    14649     5390
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Hopefully it makes sense that the population-level intercept (<span class="math inline">\(\beta_0\)</span>) is near zero. It would be odd if it wasn’t given these are standardized data. The coefficient for <code>day01</code> (<span class="math inline">\(\beta_1\)</span>) is mildly negative, suggesting an overall trend for participants to endorse lower NA scores over time.</p>
<p>The two group-level <span class="math inline">\(\sigma\)</span> parameters are fairly large given the scale of the data. They suggest participants varied quite a bit in terms of both intercepts and slopes. They also have a moderate negative correlation, suggesting that participants with higher intercepts tended to have more negative slopes.</p>
<p>To get a sense of the model, we’ll plot the posterior means for each participants’ fitted trajectory across time (thin lines), along with the population-average trajectory (thick line).</p>
<div class="sourceCode" id="cb1845"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1845-1" data-line-number="1">nd &lt;-</a>
<a class="sourceLine" id="cb1845-2" data-line-number="2"><span class="st">  </span>dat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1845-3" data-line-number="3"><span class="st">  </span><span class="kw">distinct</span>(record_id, day01)</a>
<a class="sourceLine" id="cb1845-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1845-5" data-line-number="5"><span class="kw">fitted</span>(b14<span class="fl">.12</span>,</a>
<a class="sourceLine" id="cb1845-6" data-line-number="6">       <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1845-7" data-line-number="7"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1845-8" data-line-number="8"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1845-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb1845-10" data-line-number="10"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> day01, <span class="dt">y =</span> Estimate, <span class="dt">group =</span> record_id)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1845-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1845-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_segment</span>(<span class="dt">x =</span> <span class="dv">0</span>, <span class="dt">xend =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1845-13" data-line-number="13">               <span class="dt">y =</span> <span class="kw">fixef</span>(b14<span class="fl">.12</span>)[<span class="dv">1</span>, <span class="dv">1</span>],</a>
<a class="sourceLine" id="cb1845-14" data-line-number="14">               <span class="dt">yend =</span> <span class="kw">fixef</span>(b14<span class="fl">.12</span>)[<span class="dv">1</span>, <span class="dv">1</span>] <span class="op">+</span><span class="st"> </span><span class="kw">fixef</span>(b14<span class="fl">.12</span>)[<span class="dv">2</span>, <span class="dv">1</span>],</a>
<a class="sourceLine" id="cb1845-15" data-line-number="15">               <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1845-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1845-17" data-line-number="17"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;negative affect (standardized)&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-111-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>If you look back up to the model summary from before the plot, the one parameter we didn’t focus on was the lone <code>sigma</code> parameter at the bottom. That’s our <span class="math inline">\(\sigma_\epsilon\)</span>, which captures the variation in NA not accounted for by the intercepts, slopes, and their correlation. An important characteristic of the conventional multilevel growth model is that <span class="math inline">\(\sigma_\epsilon\)</span> does not vary across persons, occasions, or other variables. To give a sense of why this might not be the best assumption, let’s take a focused look at the model implied trajectories for two participants. Here we will take cues from some Figure 4.8 from way back in <a href="geocentric-models.html#prediction-intervals.">Section 4.4.3.5</a>. We will plot the original data atop both the fitted lines and their 95% intervals, which expresses the mean structure, along with the 95% posterior predictive interval, which expresses the uncertainty of the <span class="math inline">\(\sigma_\epsilon\)</span> parameter.</p>
<div class="sourceCode" id="cb1846"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1846-1" data-line-number="1">nd &lt;-</a>
<a class="sourceLine" id="cb1846-2" data-line-number="2"><span class="st">  </span>dat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1846-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(record_id <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">30</span>, <span class="dv">115</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1846-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(record_id, N_A.std, day01)</a>
<a class="sourceLine" id="cb1846-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1846-6" data-line-number="6"><span class="kw">bind_cols</span>(</a>
<a class="sourceLine" id="cb1846-7" data-line-number="7">  <span class="kw">fitted</span>(b14<span class="fl">.12</span>,</a>
<a class="sourceLine" id="cb1846-8" data-line-number="8">         <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1846-9" data-line-number="9"><span class="st">    </span><span class="kw">data.frame</span>(),</a>
<a class="sourceLine" id="cb1846-10" data-line-number="10">  <span class="kw">predict</span>(b14<span class="fl">.12</span>,</a>
<a class="sourceLine" id="cb1846-11" data-line-number="11">          <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1846-12" data-line-number="12"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1846-13" data-line-number="13"><span class="st">    </span><span class="kw">select</span>(Q2<span class="fl">.5</span><span class="op">:</span>Q97<span class="fl">.5</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1846-14" data-line-number="14"><span class="st">    </span><span class="kw">set_names</span>(<span class="st">&quot;p_lower&quot;</span>, <span class="st">&quot;p_upper&quot;</span>)</a>
<a class="sourceLine" id="cb1846-15" data-line-number="15">) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1846-16" data-line-number="16"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1846-17" data-line-number="17"><span class="st">  </span></a>
<a class="sourceLine" id="cb1846-18" data-line-number="18"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> day01)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1846-19" data-line-number="19"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimate, <span class="dt">ymin =</span> Q2<span class="fl">.5</span>, <span class="dt">ymax =</span> Q97<span class="fl">.5</span>),</a>
<a class="sourceLine" id="cb1846-20" data-line-number="20">              <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>,</a>
<a class="sourceLine" id="cb1846-21" data-line-number="21">              <span class="dt">fill =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1846-22" data-line-number="22"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> p_lower, <span class="dt">ymax =</span> p_upper),</a>
<a class="sourceLine" id="cb1846-23" data-line-number="23">              <span class="dt">fill =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1846-24" data-line-number="24"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N_A.std),</a>
<a class="sourceLine" id="cb1846-25" data-line-number="25">             <span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1846-26" data-line-number="26"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1846-27" data-line-number="27"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;negative affect (standardized)&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1846-28" data-line-number="28"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>record_id)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-112-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Because of our fixed <span class="math inline">\(\sigma_\epsilon\)</span> parameter, the 95% posterior predictive interval is the same width for both participants. Yet look how closely participant the data points for participant 30 cluster not only within the center region of the posterior prediction intervals, but also almost completely within the 95% interval for the fitted line. In contrast, notice how much more spread out the data points for participant 115 are, and how many of them extend well beyond the posterior predictive interval. This difference in variability is ignored by conventional growth models. However, there’s no reason we can’t adjust our model to capture this kind of person-level variability, too. Enter the MELSM.</p>
</div>
<div id="learn-more-about-your-data-with-the-melsm." class="section level3">
<h3><span class="header-section-number">14.6.3</span> Learn more about your data with the MELSM.</h3>
<p>Mixed-effects location scale models (MELSMs) have their origins in the work of <a href="https://health.uchicago.edu/faculty/donald-hedeker-phd">Donald Hedeker</a> and colleagues <span class="citation">(Hedeker et al., <a href="#ref-hedekerApplicationMixedeffectsLocation2008">2008</a>, <a href="#ref-hedekerModelingWithinsubjectVariance2012">2012</a>)</span>. <span class="citation">Rast et al. (<a href="#ref-rastModelingIndividualDifferences2012">2012</a>)</span> showcased an early application of the framework to the BUGS/JAGS software. More recently <a href="https://twitter.com/rastlab">Philippe Rast</a> and colleagues (particularly graduate student, <a href="wdonald_1985">Donald Williams</a>) have adapted this approach for use within the Stan/<strong>brms</strong> ecosystem <span class="citation">(Williams, Liu, et al., <a href="#ref-williamsBayesianMultivariateMixedeffects2019a">2019</a>; Williams, Rouder, et al., <a href="#ref-williamsSurfaceUnearthingWithinperson2019">2019</a>; Williams, Martin, et al., <a href="#ref-williamsPuttingIndividualReliability2019">2019</a>; Williams, Zimprich, et al., <a href="#ref-williamsBayesianNonlinearMixedeffects2019a">2019</a>)</span>.</p>
<p>Within the <strong>brms</strong>, MELSMs apply a distributional modeling approach <span class="citation">(see Bürkner, <a href="#ref-Bürkner2020Distributional">2020</a><a href="#ref-Bürkner2020Distributional">b</a>)</span> to the multilevel growth model. Not only are parameters from the mean structure allowed to vary across groups, but parameters applied to <span class="math inline">\(\sigma\)</span> are allowed to vary across groups, too. Do you remember the little practice model <code>b10.1</code> from <a href="big-entropy-and-the-generalized-linear-model.html#linking-linear-models-to-distributions.">Section 10.2.2</a>? We simulated Gaussian data for two groups with the same mean parameter but different parameters for <span class="math inline">\(\sigma\)</span>. If you check back in that section, you’ll see that the <strong>brms</strong> default was to model <span class="math inline">\(\log \sigma\)</span> in that case. This is smart because when you define a model for <span class="math inline">\(\sigma\)</span>, you want to use a link function that ensures the predictions will be stay at zero and above. The MELSM approach of Hedeker, Rast, Williams and friends applies this logic to <span class="math inline">\(\sigma_\epsilon\)</span> in multilevel growth models. However, not only can <span class="math inline">\(\sigma_\epsilon\)</span> vary across groups in a fixed-effects sort of way, we can use multilevel partial pooling, too.</p>
<p>To get a sense of what this looks like, we’ll augment our previous model, but this time allowing <span class="math inline">\(\sigma_\epsilon\)</span> to vary across participants. You might express the updated statistical model as</p>
<p><span class="math display">\[\begin{align*}
\text{NA}_{ij} &amp; \sim \operatorname{Normal}\begin{pmatrix} \mu_{ij}, \sigma_{i} \end{pmatrix} \\
\mu_{ij} &amp; = \beta_0 + \beta_1 \text{time}_{ij} + u_{0i} + u_{1i} \text{time}_{ij} \\ 
\log \begin{pmatrix} \sigma_i \end{pmatrix} &amp; = \eta_0 + u_{2i} \\
\begin{bmatrix} u_{0i} \\ u_{1i} \\ u_{2i} \end{bmatrix} &amp; \sim \operatorname{MVNormal}\begin{pmatrix} \begin{bmatrix} 0 \\ 0 \\ 0 \end{bmatrix}, \mathbf S \mathbf R \mathbf S \end{pmatrix} \\
\mathbf S &amp; = \begin{bmatrix} \sigma_0 &amp; 0 &amp; 0 \\ 0 &amp; \sigma_1 &amp; 0 \\ 0 &amp; 0 &amp; \sigma_2 \end{bmatrix} \\
\mathbf R &amp; = \begin{bmatrix} 1 &amp; \rho_{12} &amp; \rho_{13} \\ \rho_{21} &amp; 1 &amp; \rho_{23} \\ \rho_{31} &amp; \rho_{32} &amp; 1 \end{bmatrix} \\
\beta_0   &amp; \sim \operatorname{Normal}(0, 0.2) \\
\beta_1 \text{and } \eta_0 &amp; \sim \operatorname{Normal}(0, 1) \\
\sigma_0,..., \sigma_2     &amp; \sim \operatorname{Exponential}(1) \\
\mathbf R &amp; \sim \operatorname{LKJ}(2).
\end{align*}\]</span></p>
<p>In the opening likelihood statement from the prior model, we simply set <span class="math inline">\(\text{NA}_{ij} \sim \operatorname{Normal}\begin{pmatrix} \mu_{ij}, \sigma \end{pmatrix}\)</span>. For our first MELSM, we now refer to <span class="math inline">\(\sigma_i\)</span>, meaning the levels of variation not accounted for by the mean structure can vary across participants (hence the <span class="math inline">\(i\)</span> subscript). Two lines down, we see the formula for <span class="math inline">\(\log \begin{pmatrix} \sigma_i \end{pmatrix}\)</span> contains population-level intercept, <span class="math inline">\(\eta_0\)</span>, and participant-specific deviations around that parameter, <span class="math inline">\(u_{2i}\)</span>. In the next three lines, the plot deepens. We see that all three participant-level deviations, <span class="math inline">\(u_{0i},...,u_{2i}\)</span> are multivariate normal with means set to zero and variation expressed in the parameters <span class="math inline">\(\sigma_0,...,\sigma_2\)</span> of the <span class="math inline">\(\mathbf S\)</span> matrix. In the <span class="math inline">\(\mathbf R\)</span> matrix, we now have three correlation parameters, with <span class="math inline">\(\rho_{31}\)</span> and <span class="math inline">\(\rho_{32}\)</span> allowing us to assess the correlations among individual differences in variability and individual differences in starting points and change over time, respectively. Let’s fit the model.</p>
<div class="sourceCode" id="cb1847"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1847-1" data-line-number="1">b14<span class="fl">.13</span> &lt;-</a>
<a class="sourceLine" id="cb1847-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> dat,</a>
<a class="sourceLine" id="cb1847-3" data-line-number="3">      <span class="dt">family =</span> gaussian,</a>
<a class="sourceLine" id="cb1847-4" data-line-number="4">      <span class="kw">bf</span>(N_A.std <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">|</span>i<span class="op">|</span><span class="st"> </span>record_id),</a>
<a class="sourceLine" id="cb1847-5" data-line-number="5">         sigma <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span>i<span class="op">|</span><span class="st"> </span>record_id)),</a>
<a class="sourceLine" id="cb1847-6" data-line-number="6">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1847-7" data-line-number="7">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b),</a>
<a class="sourceLine" id="cb1847-8" data-line-number="8">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd),</a>
<a class="sourceLine" id="cb1847-9" data-line-number="9">                </a>
<a class="sourceLine" id="cb1847-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept, <span class="dt">dpar =</span> sigma),</a>
<a class="sourceLine" id="cb1847-11" data-line-number="11">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd, <span class="dt">dpar =</span> sigma),</a>
<a class="sourceLine" id="cb1847-12" data-line-number="12">                </a>
<a class="sourceLine" id="cb1847-13" data-line-number="13">                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">2</span>), <span class="dt">class =</span> cor)),</a>
<a class="sourceLine" id="cb1847-14" data-line-number="14">      <span class="dt">iter =</span> <span class="dv">3000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1847-15" data-line-number="15">      <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1847-16" data-line-number="16">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.13&quot;</span>)</a></code></pre></div>
<p>We should note a few things about the <code>brm()</code> syntax. First, because we modeled both <span class="math inline">\(\mu_{ij}\)</span> and <span class="math inline">\(\sigma_i\)</span>, we nested both model formulas within the <code>bf()</code> function. Second, because the <strong>brms</strong> default is to use the log link when modeling <span class="math inline">\(\sigma_i\)</span>, there was no need to explicitly set it that wah in the <code>family</code> line. However, we could have if we wanted to. Third, notice our use of the <code>|i|</code> syntax within the parentheses in the <code>formula</code> lines. If we had used the conventional <code>|</code> syntax, that would have not allowed our <span class="math inline">\(u_{2i}\)</span> parameters to correlate with <span class="math inline">\(u_{0i}\)</span> and <span class="math inline">\(u_{1i}\)</span> from the mean structure. It would have effectively set <span class="math inline">\(\rho_{31} = \rho_{32} = 0\)</span>. Finally, notice how within the <code>prior()</code> functions, we explicitly referred to those for the new <span class="math inline">\(\sigma\)</span> structure with the <code>dpar = sigma</code> operator.</p>
<p>Okay, time to check the model summary.</p>
<div class="sourceCode" id="cb1848"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1848-1" data-line-number="1"><span class="kw">print</span>(b14<span class="fl">.13</span>)</a></code></pre></div>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = log 
## Formula: N_A.std ~ 1 + day01 + (1 + day01 | i | record_id) 
##          sigma ~ 1 + (1 | i | record_id)
##    Data: dat (Number of observations: 13033) 
## Samples: 4 chains, each with iter = 3000; warmup = 1000; thin = 1;
##          total post-warmup samples = 8000
## 
## Group-Level Effects: 
## ~record_id (Number of levels: 193) 
##                                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)                      0.76      0.04     0.69     0.85 1.01      652     1475
## sd(day01)                          0.61      0.04     0.53     0.69 1.00     1548     2982
## sd(sigma_Intercept)                0.70      0.04     0.63     0.77 1.00      679     1170
## cor(Intercept,day01)              -0.34      0.08    -0.48    -0.17 1.01      998     2661
## cor(Intercept,sigma_Intercept)     0.61      0.05     0.51     0.70 1.01      705     1251
## cor(day01,sigma_Intercept)        -0.10      0.08    -0.25     0.06 1.00      747     1939
## 
## Population-Level Effects: 
##                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept           0.03      0.05    -0.08     0.14 1.01      288      427
## sigma_Intercept    -0.78      0.05    -0.89    -0.68 1.01      481      978
## day01              -0.15      0.05    -0.26    -0.05 1.01      769     1532
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>The ‘sigma_Intercept’ lines in the ‘Population-Level Effects’ section is the summary for our <span class="math inline">\(\eta_0\)</span> parameter. To get a sense of what this means out of the log space, just exponentiate.</p>
<div class="sourceCode" id="cb1850"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1850-1" data-line-number="1"><span class="kw">fixef</span>(b14<span class="fl">.13</span>)[<span class="st">&quot;sigma_Intercept&quot;</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span><span class="op">:</span><span class="dv">4</span>)] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">exp</span>()</a></code></pre></div>
<pre><code>##  Estimate      Q2.5     Q97.5 
## 0.4577889 0.4126544 0.5058946</code></pre>
<p>To get a sense of the variation in that parameter across participants [i.e., <span class="math inline">\(\exp(\eta_0 + u_{2i})\)</span>], it’s best to plot.</p>
<div class="sourceCode" id="cb1852"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1852-1" data-line-number="1"><span class="kw">coef</span>(b14<span class="fl">.13</span>)<span class="op">$</span>record_id[, , <span class="st">&quot;sigma_Intercept&quot;</span>] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1852-2" data-line-number="2"><span class="st">  </span><span class="kw">exp</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1852-3" data-line-number="3"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1852-4" data-line-number="4"><span class="st">  </span><span class="kw">arrange</span>(Estimate) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1852-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rank =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1852-6" data-line-number="6"><span class="st">  </span></a>
<a class="sourceLine" id="cb1852-7" data-line-number="7"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> rank, <span class="dt">y =</span> Estimate, <span class="dt">ymin =</span> Q2<span class="fl">.5</span>, <span class="dt">ymax =</span> Q97<span class="fl">.5</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1852-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="dt">size =</span> <span class="fl">.4</span>, <span class="dt">fatten =</span> <span class="fl">.3</span>, <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1852-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;participants ranked by posterior mean&quot;</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1852-10" data-line-number="10"><span class="st">  </span><span class="kw">ylab</span>(<span class="kw">expression</span>(<span class="kw">exp</span>(eta[<span class="dv">0</span>]<span class="op">+</span><span class="kw">italic</span>(u)[<span class="dv">2</span>][<span class="kw">italic</span>(i)])))</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-115-1.png" width="432" style="display: block; margin: auto;" /></p>
<p>Looks like there’s a lot of variation in a parameter that was formerly fixed across participants as a single value <span class="math inline">\(\sigma_\epsilon\)</span>. Here’s what this looks like in terms of our posterior predictive distributions for participants 30 and 115, from before.</p>
<div class="sourceCode" id="cb1853"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1853-1" data-line-number="1">nd &lt;-</a>
<a class="sourceLine" id="cb1853-2" data-line-number="2"><span class="st">  </span>dat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1853-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(record_id <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">30</span>, <span class="dv">115</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1853-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(record_id, N_A.std, day01)</a>
<a class="sourceLine" id="cb1853-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1853-6" data-line-number="6"><span class="kw">bind_cols</span>(</a>
<a class="sourceLine" id="cb1853-7" data-line-number="7">  <span class="kw">fitted</span>(b14<span class="fl">.13</span>,</a>
<a class="sourceLine" id="cb1853-8" data-line-number="8">         <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1853-9" data-line-number="9"><span class="st">    </span><span class="kw">data.frame</span>(),</a>
<a class="sourceLine" id="cb1853-10" data-line-number="10">  <span class="kw">predict</span>(b14<span class="fl">.13</span>,</a>
<a class="sourceLine" id="cb1853-11" data-line-number="11">          <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1853-12" data-line-number="12"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1853-13" data-line-number="13"><span class="st">    </span><span class="kw">select</span>(Q2<span class="fl">.5</span><span class="op">:</span>Q97<span class="fl">.5</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1853-14" data-line-number="14"><span class="st">    </span><span class="kw">set_names</span>(<span class="st">&quot;p_lower&quot;</span>, <span class="st">&quot;p_upper&quot;</span>)</a>
<a class="sourceLine" id="cb1853-15" data-line-number="15">) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1853-16" data-line-number="16"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1853-17" data-line-number="17"><span class="st">  </span></a>
<a class="sourceLine" id="cb1853-18" data-line-number="18"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> day01)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1853-19" data-line-number="19"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimate, <span class="dt">ymin =</span> Q2<span class="fl">.5</span>, <span class="dt">ymax =</span> Q97<span class="fl">.5</span>),</a>
<a class="sourceLine" id="cb1853-20" data-line-number="20">              <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>,</a>
<a class="sourceLine" id="cb1853-21" data-line-number="21">              <span class="dt">fill =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1853-22" data-line-number="22"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> p_lower, <span class="dt">ymax =</span> p_upper),</a>
<a class="sourceLine" id="cb1853-23" data-line-number="23">              <span class="dt">fill =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1853-24" data-line-number="24"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N_A.std),</a>
<a class="sourceLine" id="cb1853-25" data-line-number="25">             <span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1853-26" data-line-number="26"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1853-27" data-line-number="27"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;negative affect (standardized)&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1853-28" data-line-number="28"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>record_id)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-116-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>That’s a big improvement. Let’s expand our skill set. Within the MELSM paradigm, one can use multiple variables to model participant-specific variation. Here we’ll add in our time variable.</p>
<p><span class="math display">\[\begin{align*}
\text{NA}_{ij} &amp; \sim \operatorname{Normal}\begin{pmatrix} \mu_{ij}, \sigma_{ij} \end{pmatrix} \\
\mu_{ij} &amp; = \beta_0 + \beta_1 \text{time}_{ij} + u_{0i} + u_{1i} \text{time}_{ij} \\ \log \begin{pmatrix} \sigma_{ij} \end{pmatrix} &amp; = \eta_0 + \eta_1 \text{time}_{ij} + u_{2i} + u_{3i} \text{time}_{ij} \\
\begin{bmatrix} u_{0i} \\ u_{1i} \\ u_{2i} \\ u_{3i} \end{bmatrix} &amp; \sim \operatorname{MVNormal}\begin{pmatrix} \begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \end{bmatrix}, \mathbf S \mathbf R \mathbf S \end{pmatrix} \\
\mathbf S &amp; = \begin{bmatrix} \sigma_0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; \sigma_1 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; \sigma_2 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; \sigma_3 \end{bmatrix} \\
\mathbf R &amp; = \begin{bmatrix} 1 &amp; \rho_{12} &amp; \rho_{13} &amp; \rho_{14} \\ \rho_{21} &amp; 1 &amp; \rho_{23} &amp; \rho_{24} \\ \rho_{31} &amp; \rho_{32} &amp; 1 &amp; \rho_{34} \\ \rho_{41} &amp; \rho_{42} &amp; \rho_{43} &amp; 1 \end{bmatrix} \\
\beta_0   &amp; \sim \operatorname{Normal}(0, 0.2) \\
\beta_1, \eta_0, \text{and } \eta_1 &amp; \sim \operatorname{Normal}(0, 1) \\
\sigma_0,..., \sigma_3 &amp; \sim \operatorname{Exponential}(1) \\
\mathbf R &amp; \sim \operatorname{LKJ}(2).
\end{align*}\]</span></p>
<p>Note how in the very first line we are now speaking in terms of <span class="math inline">\(\sigma_{ij}\)</span>. Variation in the criterion <span class="math inline">\(\text{NA}_{ij}\)</span> not accounted for by the mean structure can now vary across participants, <span class="math inline">\(i\)</span>, and time, <span class="math inline">\(j\)</span>. This results in four <span class="math inline">\(u_{xi}\)</span> terms, a <span class="math inline">\(4 \times 4\)</span> <span class="math inline">\(\mathbf S\)</span> matrix and a <span class="math inline">\(4 \times 4\)</span> <span class="math inline">\(\mathbf R\)</span> matrix. Here’s how you might fit the model with <code>brms::brm()</code>. <strong>Warning</strong>: it’ll probably take a couple hours.</p>
<div class="sourceCode" id="cb1854"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1854-1" data-line-number="1">b14<span class="fl">.14</span> &lt;-</a>
<a class="sourceLine" id="cb1854-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> dat,</a>
<a class="sourceLine" id="cb1854-3" data-line-number="3">      <span class="dt">family =</span> gaussian,</a>
<a class="sourceLine" id="cb1854-4" data-line-number="4">      <span class="kw">bf</span>(N_A.std <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">|</span>i<span class="op">|</span><span class="st"> </span>record_id),</a>
<a class="sourceLine" id="cb1854-5" data-line-number="5">         sigma <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">|</span>i<span class="op">|</span><span class="st"> </span>record_id)),</a>
<a class="sourceLine" id="cb1854-6" data-line-number="6">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1854-7" data-line-number="7">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b),</a>
<a class="sourceLine" id="cb1854-8" data-line-number="8">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd),</a>
<a class="sourceLine" id="cb1854-9" data-line-number="9">                </a>
<a class="sourceLine" id="cb1854-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept, <span class="dt">dpar =</span> sigma),</a>
<a class="sourceLine" id="cb1854-11" data-line-number="11">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">dpar =</span> sigma),</a>
<a class="sourceLine" id="cb1854-12" data-line-number="12">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd, <span class="dt">dpar =</span> sigma),</a>
<a class="sourceLine" id="cb1854-13" data-line-number="13">                </a>
<a class="sourceLine" id="cb1854-14" data-line-number="14">                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">2</span>), <span class="dt">class =</span> cor)),</a>
<a class="sourceLine" id="cb1854-15" data-line-number="15">      <span class="dt">iter =</span> <span class="dv">3000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1854-16" data-line-number="16">      <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1854-17" data-line-number="17">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.14&quot;</span>)</a></code></pre></div>
<p>At this point, <code>print()</code> is starting to return a lot of output.</p>
<div class="sourceCode" id="cb1855"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1855-1" data-line-number="1"><span class="kw">print</span>(b14<span class="fl">.14</span>)</a></code></pre></div>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = log 
## Formula: N_A.std ~ 1 + day01 + (1 + day01 | i | record_id) 
##          sigma ~ 1 + day01 + (1 + day01 | i | record_id)
##    Data: dat (Number of observations: 13033) 
## Samples: 4 chains, each with iter = 3000; warmup = 1000; thin = 1;
##          total post-warmup samples = 8000
## 
## Group-Level Effects: 
## ~record_id (Number of levels: 193) 
##                                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)                        0.76      0.04     0.68     0.84 1.01     1113     2097
## sd(day01)                            0.60      0.04     0.52     0.69 1.00     2368     4274
## sd(sigma_Intercept)                  0.70      0.04     0.63     0.78 1.00     1933     3371
## sd(sigma_day01)                      0.36      0.04     0.29     0.44 1.00     4282     5832
## cor(Intercept,day01)                -0.31      0.08    -0.46    -0.14 1.00     1700     3099
## cor(Intercept,sigma_Intercept)       0.64      0.05     0.54     0.72 1.00     1781     3498
## cor(day01,sigma_Intercept)          -0.20      0.08    -0.35    -0.04 1.00     1297     2795
## cor(Intercept,sigma_day01)          -0.16      0.11    -0.37     0.05 1.00     4531     5944
## cor(day01,sigma_day01)               0.61      0.09     0.42     0.76 1.00     4671     5794
## cor(sigma_Intercept,sigma_day01)    -0.15      0.10    -0.34     0.04 1.00     3872     5824
## 
## Population-Level Effects: 
##                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept           0.03      0.06    -0.08     0.14 1.00      500      949
## sigma_Intercept    -0.75      0.05    -0.85    -0.65 1.00      810     2121
## day01              -0.15      0.05    -0.25    -0.06 1.00     1416     2760
## sigma_day01        -0.11      0.04    -0.19    -0.03 1.00     3920     5043
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Our new line for ‘sigma_day01’ suggests there is a general trend for less variation in negative affect ratings over time. However, the ‘sd(sigma_day01)’ line in the ‘Group-Level Effects’ section indicates even this varies a bit across participants. At this point, a lot of the action is now in the estimates for the <span class="math inline">\(\mathbf R\)</span> matrix. Here that is in a coefficient plot.</p>
<div class="sourceCode" id="cb1857"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1857-1" data-line-number="1"><span class="kw">posterior_summary</span>(b14<span class="fl">.14</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1857-2" data-line-number="2"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1857-3" data-line-number="3"><span class="st">  </span><span class="kw">rownames_to_column</span>(<span class="st">&quot;par&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1857-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(par, <span class="st">&quot;cor_&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1857-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rho =</span> <span class="kw">str_c</span>(<span class="st">&quot;(rho[&quot;</span>, <span class="kw">c</span>(<span class="dv">21</span>, <span class="dv">31</span>, <span class="dv">32</span>, <span class="dv">41</span>, <span class="dv">42</span>, <span class="dv">43</span>), <span class="st">&quot;])&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1857-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">par =</span> <span class="kw">str_c</span>(<span class="st">&quot;&#39;&quot;</span>, par, <span class="st">&quot;&#39;~&quot;</span>, rho)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1857-7" data-line-number="7"><span class="st">  </span></a>
<a class="sourceLine" id="cb1857-8" data-line-number="8"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Estimate, <span class="dt">xmin =</span> Q2<span class="fl">.5</span>, <span class="dt">xmax =</span> Q97<span class="fl">.5</span>, <span class="dt">y =</span> par)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1857-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">5</span>, <span class="dv">0</span>, <span class="fl">.5</span>), <span class="dt">linetype =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">size =</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>), <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1857-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="dt">color =</span> <span class="st">&quot;#B1934A&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1857-11" data-line-number="11"><span class="st">  </span><span class="kw">xlim</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1857-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="dt">labels =</span> ggplot2<span class="op">:::</span>parse_safe) <span class="op">+</span></a>
<a class="sourceLine" id="cb1857-13" data-line-number="13"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;marginal posterior&quot;</span>,</a>
<a class="sourceLine" id="cb1857-14" data-line-number="14">       <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1857-15" data-line-number="15"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>, <span class="dt">size =</span> <span class="dv">9</span>),</a>
<a class="sourceLine" id="cb1857-16" data-line-number="16">        <span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-118-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>Note how we attached the statistical terms from the lower triangle of the <span class="math inline">\(\mathbf R\)</span> matrix to the names from the <strong>brms</strong> output. Coefficient plots like this are somewhat helpful with MELSM parameter summaries, like this. But they leave something to be desired and they won’t scale well. One alternative is to present the posterior means in a correlation matrix plot. Our first step to prepare for the plot is to extract and wrangle the posterior summaries.</p>
<div class="sourceCode" id="cb1858"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1858-1" data-line-number="1">levels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;beta[0]&quot;</span>, <span class="st">&quot;beta[1]&quot;</span>, <span class="st">&quot;eta[0]&quot;</span>, <span class="st">&quot;eta[1]&quot;</span>)</a>
<a class="sourceLine" id="cb1858-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1858-3" data-line-number="3">r &lt;-</a>
<a class="sourceLine" id="cb1858-4" data-line-number="4"><span class="st">  </span><span class="kw">posterior_summary</span>(b14<span class="fl">.14</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1858-5" data-line-number="5"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1858-6" data-line-number="6"><span class="st">  </span><span class="kw">rownames_to_column</span>(<span class="st">&quot;param&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1858-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(param, <span class="st">&quot;cor_&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1858-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">param =</span> <span class="kw">str_remove</span>(param, <span class="st">&quot;cor_record_id__&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1858-9" data-line-number="9"><span class="st">  </span><span class="kw">separate</span>(param, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;right&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;__&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1858-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb1858-11" data-line-number="11">    <span class="dt">left =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb1858-12" data-line-number="12">      left <span class="op">==</span><span class="st"> &quot;Intercept&quot;</span>       <span class="op">~</span><span class="st"> &quot;beta[0]&quot;</span>,</a>
<a class="sourceLine" id="cb1858-13" data-line-number="13">      left <span class="op">==</span><span class="st"> &quot;day01&quot;</span>           <span class="op">~</span><span class="st"> &quot;beta[1]&quot;</span>,</a>
<a class="sourceLine" id="cb1858-14" data-line-number="14">      left <span class="op">==</span><span class="st"> &quot;sigma_Intercept&quot;</span> <span class="op">~</span><span class="st"> &quot;eta[0]&quot;</span>),</a>
<a class="sourceLine" id="cb1858-15" data-line-number="15">    <span class="dt">right =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb1858-16" data-line-number="16">      right <span class="op">==</span><span class="st"> &quot;day01&quot;</span>           <span class="op">~</span><span class="st"> &quot;beta[1]&quot;</span>,</a>
<a class="sourceLine" id="cb1858-17" data-line-number="17">      right <span class="op">==</span><span class="st"> &quot;sigma_Intercept&quot;</span> <span class="op">~</span><span class="st"> &quot;eta[0]&quot;</span>,</a>
<a class="sourceLine" id="cb1858-18" data-line-number="18">      right <span class="op">==</span><span class="st"> &quot;sigma_day01&quot;</span>     <span class="op">~</span><span class="st"> &quot;eta[1]&quot;</span></a>
<a class="sourceLine" id="cb1858-19" data-line-number="19">    )</a>
<a class="sourceLine" id="cb1858-20" data-line-number="20">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1858-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">label =</span> <span class="kw">formatC</span>(Estimate, <span class="dt">digits =</span> <span class="dv">2</span>, <span class="dt">format =</span> <span class="st">&quot;f&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_replace</span>(., <span class="st">&quot;0.&quot;</span>, <span class="st">&quot;.&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1858-22" data-line-number="22"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">left  =</span> <span class="kw">factor</span>(left, <span class="dt">levels =</span> levels),</a>
<a class="sourceLine" id="cb1858-23" data-line-number="23">         <span class="dt">right =</span> <span class="kw">factor</span>(right, <span class="dt">levels =</span> levels)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1858-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">right =</span> <span class="kw">fct_rev</span>(right))</a>
<a class="sourceLine" id="cb1858-25" data-line-number="25"></a>
<a class="sourceLine" id="cb1858-26" data-line-number="26">r</a></code></pre></div>
<pre><code>##      left   right   Estimate  Est.Error       Q2.5       Q97.5 label
## 1 beta[0] beta[1] -0.3089508 0.08386411 -0.4629906 -0.13655524  -.31
## 2 beta[0]  eta[0]  0.6409912 0.04611116  0.5425778  0.72436842   .64
## 3 beta[1]  eta[0] -0.2031949 0.08102187 -0.3532224 -0.04002514  -.20
## 4 beta[0]  eta[1] -0.1634277 0.10668266 -0.3686215  0.05152164  -.16
## 5 beta[1]  eta[1]  0.6067130 0.08825829  0.4203622  0.76378213   .61
## 6  eta[0]  eta[1] -0.1536633 0.09818593 -0.3388578  0.04149388  -.15</code></pre>
<p>Note how instead of naming the correlations in terms of <span class="math inline">\(\rho_{xx}\)</span>, we are now referring to them as the correlations of the deviations among the population parameters, <span class="math inline">\(\beta_0\)</span> through <span class="math inline">\(\eta_1\)</span>. I’m hoping this will make sense in the plot. Here it is.</p>
<div class="sourceCode" id="cb1860"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1860-1" data-line-number="1">r <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1860-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> left, <span class="dt">y =</span> right)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1860-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Estimate)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1860-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> label),</a>
<a class="sourceLine" id="cb1860-5" data-line-number="5">            <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>, <span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1860-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_fill_gradient2</span>(<span class="kw">expression</span>(rho),</a>
<a class="sourceLine" id="cb1860-7" data-line-number="7">                       <span class="dt">low =</span> <span class="st">&quot;#59708b&quot;</span>, <span class="dt">mid =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">midpoint =</span> <span class="dv">0</span>, </a>
<a class="sourceLine" id="cb1860-8" data-line-number="8">                       <span class="dt">labels =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="st">&quot;&quot;</span>, <span class="dv">0</span>, <span class="st">&quot;&quot;</span>, <span class="dv">1</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1860-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">drop =</span> F, <span class="dt">labels =</span> ggplot2<span class="op">:::</span>parse_safe, <span class="dt">position =</span> <span class="st">&quot;top&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1860-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="ot">NULL</span>, <span class="dt">drop =</span> F, <span class="dt">labels =</span> ggplot2<span class="op">:::</span>parse_safe) <span class="op">+</span></a>
<a class="sourceLine" id="cb1860-11" data-line-number="11"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="kw">expression</span>(<span class="st">&quot;The lower triangle for &quot;</span><span class="op">*</span><span class="kw">bold</span>(R)),</a>
<a class="sourceLine" id="cb1860-12" data-line-number="12">          <span class="dt">subtitle =</span> <span class="st">&quot;Note, each cell is summarized by</span><span class="ch">\n</span><span class="st">its posterior mean.&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1860-13" data-line-number="13"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">12</span>),</a>
<a class="sourceLine" id="cb1860-14" data-line-number="14">        <span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1860-15" data-line-number="15">        <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">1</span>))</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-120-1.png" width="336" style="display: block; margin: auto;" /></p>
<p>Interestingly, the strongest two associations involve variation around our <span class="math inline">\(\eta\)</span> parameters. The posterior mean for <span class="math inline">\(\rho_{31}\)</span> indicates participants with higher baseline levels of <span class="math inline">\(\text{NA}_{ij}\)</span> tend to vary more in their responses, particularly in the beginning. The posterior mean for <span class="math inline">\(\rho_{42}\)</span> indicates participants who show greater increases in their <span class="math inline">\(\text{NA}_{ij}\)</span> responses over time also tend to show greater relative increases in variation in those responses. You can get a little bit of a sense for this by returning once again to our participants 30 and 115.</p>
<div class="sourceCode" id="cb1861"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1861-1" data-line-number="1">nd &lt;-</a>
<a class="sourceLine" id="cb1861-2" data-line-number="2"><span class="st">  </span>dat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1861-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(record_id <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">30</span>, <span class="dv">115</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1861-4" data-line-number="4"><span class="st">  </span><span class="co"># filter(record_id &lt; 20) %&gt;% </span></a>
<a class="sourceLine" id="cb1861-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(record_id, N_A.std, day01)</a>
<a class="sourceLine" id="cb1861-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1861-7" data-line-number="7"><span class="kw">bind_cols</span>(</a>
<a class="sourceLine" id="cb1861-8" data-line-number="8">  <span class="kw">fitted</span>(b14<span class="fl">.14</span>,</a>
<a class="sourceLine" id="cb1861-9" data-line-number="9">         <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1861-10" data-line-number="10"><span class="st">    </span><span class="kw">data.frame</span>(),</a>
<a class="sourceLine" id="cb1861-11" data-line-number="11">  <span class="kw">predict</span>(b14<span class="fl">.14</span>,</a>
<a class="sourceLine" id="cb1861-12" data-line-number="12">          <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1861-13" data-line-number="13"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1861-14" data-line-number="14"><span class="st">    </span><span class="kw">select</span>(Q2<span class="fl">.5</span><span class="op">:</span>Q97<span class="fl">.5</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1861-15" data-line-number="15"><span class="st">    </span><span class="kw">set_names</span>(<span class="st">&quot;p_lower&quot;</span>, <span class="st">&quot;p_upper&quot;</span>)</a>
<a class="sourceLine" id="cb1861-16" data-line-number="16">) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1861-17" data-line-number="17"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1861-18" data-line-number="18"><span class="st">  </span></a>
<a class="sourceLine" id="cb1861-19" data-line-number="19"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> day01)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1861-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimate, <span class="dt">ymin =</span> Q2<span class="fl">.5</span>, <span class="dt">ymax =</span> Q97<span class="fl">.5</span>),</a>
<a class="sourceLine" id="cb1861-21" data-line-number="21">              <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>,</a>
<a class="sourceLine" id="cb1861-22" data-line-number="22">              <span class="dt">fill =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1861-23" data-line-number="23"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> p_lower, <span class="dt">ymax =</span> p_upper),</a>
<a class="sourceLine" id="cb1861-24" data-line-number="24">              <span class="dt">fill =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1861-25" data-line-number="25"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N_A.std),</a>
<a class="sourceLine" id="cb1861-26" data-line-number="26">             <span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1861-27" data-line-number="27"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1861-28" data-line-number="28"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;negative affect (standardized)&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1861-29" data-line-number="29"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>record_id)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-121-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>With respect to <span class="math inline">\(\rho_{31}\)</span>, participant 115 showed both a higher intercept and higher level of variability toward the beginning of the study than participant 30 did. The meaning of <span class="math inline">\(\rho_{42}\)</span> is less clear, with these two. But at least you can get a sense of why you might want to include a <span class="math inline">\(\eta_1\)</span> parameter to allow response variability to change over time, and why you might want to allow that parameter to vary across participants. Whereas response variability increased quite a bit for participant 115 over time, it stayed about the same for participant 30, perhaps even decreasing a bit.</p>
</div>
<div id="time-to-go-multivariate." class="section level3">
<h3><span class="header-section-number">14.6.4</span> Time to go multivariate.</h3>
<p>For our final stage in this progression, we will fit what <span class="citation">Williams, Liu, et al. (<a href="#ref-williamsBayesianMultivariateMixedeffects2019a">2019</a>)</span> called a M-MELSM, a multivariate mixed-effects location scale model. Recall these data have measures of both negative and positive affect. The standardized values for PA are waiting for us in the <code>P_A.std</code> column. Within the <strong>brms</strong> framework, this is a combination of sensibilities from Bürkner’s vignettes on distributional models <span class="citation">(Bürkner, <a href="#ref-Bürkner2020Distributional">2020</a><a href="#ref-Bürkner2020Distributional">b</a>)</span> and multivariate models <span class="citation">(Bürkner, <a href="#ref-Bürkner2020Multivariate">2020</a><a href="#ref-Bürkner2020Multivariate">c</a>)</span>. We might express the statistical model as</p>
<p><span class="math display">\[\begin{align*}
\begin{bmatrix} \text{NA}_{ij} \\ \text{PA}_{ij} \end{bmatrix} &amp; \sim \operatorname{MVNormal}\begin{pmatrix} \begin{bmatrix} 
\mu_{ij}^\text{NA} \\ \mu_{ij}^\text{PA} \end{bmatrix}, \mathbf \Sigma \end{pmatrix} \\

\mu_{ij}^\text{NA} &amp; = \beta_0^\text{NA} + \beta_1^\text{NA} \text{time}_{ij} + u_{0i}^\text{NA} + u_{1i}^\text{NA} \\
\mu_{ij}^\text{PA} &amp; = \beta_0^\text{PA} + \beta_1^\text{PA} \text{time}_{ij} + u_{0i}^\text{PA} + u_{1i}^\text{PA} \\
\log \begin{pmatrix} \sigma_{ij}^\text{NA} \end{pmatrix} &amp; = \eta_0^\text{NA} + \eta_1^\text{NA} \text{time}_{ij} + u_{2i}^\text{NA} + u_{3i}^\text{NA} \\
\log \begin{pmatrix} \sigma_{ij}^\text{PA} \end{pmatrix} &amp; = \eta_0^\text{PA} + \eta_1^\text{PA} \text{time}_{ij} + u_{2i}^\text{PA} + u_{3i}^\text{PA}  \\

\begin{bmatrix} u_{0i}^\text{NA}, u_{1i}^\text{NA}, u_{2i}^\text{NA}, u_{3i}^\text{NA}, u_{0i}^\text{PA}, u_{1i}^\text{PA}, u_{2i}^\text{PA}, u_{3i}^\text{PA} \end{bmatrix}&#39; &amp; \sim \operatorname{MVNormal}(\mathbf 0, \mathbf S \mathbf R \mathbf S) \\

\mathbf S &amp; = \begin{bmatrix} \sigma_0^\text{NA} &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; \sigma_1^\text{NA} &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; \sigma_2^\text{NA} &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; \sigma_3^\text{NA} &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; \sigma_0^\text{PA} &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; \sigma_1^\text{PA} &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; \sigma_2^\text{PA} &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; \sigma_3^\text{PA}  \end{bmatrix} \\

\mathbf R &amp; = \begin{bmatrix} 
1 &amp; \rho_{12} &amp; \rho_{13} &amp; \rho_{14} &amp; \rho_{15} &amp; \rho_{16} &amp; \rho_{17} &amp; \rho_{18} \\ 
\rho_{21} &amp; 1 &amp; \rho_{23} &amp; \rho_{24} &amp; \rho_{25} &amp; \rho_{26} &amp; \rho_{27} &amp; \rho_{28} \\ 
\rho_{31} &amp; \rho_{32} &amp; 1 &amp; \rho_{34} &amp; \rho_{35} &amp; \rho_{36} &amp; \rho_{37} &amp; \rho_{38} \\ 
\rho_{41} &amp; \rho_{42} &amp; \rho_{43} &amp; 1 &amp; \rho_{45} &amp; \rho_{46} &amp; \rho_{47} &amp; \rho_{48} \\ 
\rho_{51} &amp; \rho_{52} &amp; \rho_{53} &amp; \rho_{54} &amp; 1 &amp; \rho_{56} &amp; \rho_{57} &amp; \rho_{58} \\ 
\rho_{61} &amp; \rho_{62} &amp; \rho_{63} &amp; \rho_{64} &amp; \rho_{65} &amp; 1 &amp; \rho_{67} &amp; \rho_{68} \\ 
\rho_{71} &amp; \rho_{72} &amp; \rho_{73} &amp; \rho_{74} &amp; \rho_{75} &amp; \rho_{76} &amp; 1 &amp; \rho_{78} \\ 
\rho_{81} &amp; \rho_{82} &amp; \rho_{83} &amp; \rho_{84} &amp; \rho_{85} &amp; \rho_{86} &amp; \rho_{87} &amp; 1
\end{bmatrix} \\

\beta_0^\text{NA} \text{ and } \beta_0^\text{PA} &amp; \sim \operatorname{Normal}(0, 0.2) \\
\beta_1^\text{NA} \text{ and } \beta_1^\text{PA} &amp; \sim \operatorname{Normal}(0, 1) \\
\eta_0^\text{NA},..., \eta_1^\text{PA} &amp; \sim \operatorname{Normal}(0, 1) \\
\sigma_0^\text{NA},..., \sigma_1^\text{PA} &amp; \sim \operatorname{Exponential}(1) \\
\mathbf R &amp; \sim \operatorname{LKJ}(2),
\end{align*}\]</span></p>
<p>where the <span class="math inline">\(\text{NA}\)</span> and <span class="math inline">\(\text{PA}\)</span> superscripts indicate which variable is connected with which parameter. This is a straight multivariate generalization from the previous model, <code>b14.14</code>. Now we have eight parameters varying across participants, resulting in an <span class="math inline">\(8 \times 8\)</span> <span class="math inline">\(\mathbf S\)</span> matrix and an <span class="math inline">\(8 \times 8\)</span> <span class="math inline">\(\mathbf R\)</span> matrix. Here’s the <code>brms::brm()</code> code.</p>
<div class="sourceCode" id="cb1862"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1862-1" data-line-number="1">b14<span class="fl">.15</span> &lt;-</a>
<a class="sourceLine" id="cb1862-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> dat,</a>
<a class="sourceLine" id="cb1862-3" data-line-number="3">      <span class="dt">family =</span> gaussian,</a>
<a class="sourceLine" id="cb1862-4" data-line-number="4">      <span class="kw">bf</span>(<span class="kw">mvbind</span>(N_A.std, P_A.std) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">|</span>i<span class="op">|</span><span class="st"> </span>record_id),</a>
<a class="sourceLine" id="cb1862-5" data-line-number="5">         sigma <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>day01 <span class="op">|</span>i<span class="op">|</span><span class="st"> </span>record_id)) <span class="op">+</span><span class="st"> </span><span class="kw">set_rescor</span>(<span class="dt">rescor =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb1862-6" data-line-number="6">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">class =</span> Intercept, <span class="dt">resp =</span> NAstd),</a>
<a class="sourceLine" id="cb1862-7" data-line-number="7">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">resp =</span> NAstd),</a>
<a class="sourceLine" id="cb1862-8" data-line-number="8">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd, <span class="dt">resp =</span> NAstd),</a>
<a class="sourceLine" id="cb1862-9" data-line-number="9">                </a>
<a class="sourceLine" id="cb1862-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept, <span class="dt">dpar =</span> sigma, <span class="dt">resp =</span> NAstd),</a>
<a class="sourceLine" id="cb1862-11" data-line-number="11">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">dpar =</span> sigma, <span class="dt">resp =</span> NAstd),</a>
<a class="sourceLine" id="cb1862-12" data-line-number="12">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd, <span class="dt">dpar =</span> sigma, <span class="dt">resp =</span> NAstd),</a>
<a class="sourceLine" id="cb1862-13" data-line-number="13">                </a>
<a class="sourceLine" id="cb1862-14" data-line-number="14">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">class =</span> Intercept, <span class="dt">resp =</span> PAstd),</a>
<a class="sourceLine" id="cb1862-15" data-line-number="15">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">resp =</span> PAstd),</a>
<a class="sourceLine" id="cb1862-16" data-line-number="16">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd, <span class="dt">resp =</span> PAstd),</a>
<a class="sourceLine" id="cb1862-17" data-line-number="17">                </a>
<a class="sourceLine" id="cb1862-18" data-line-number="18">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept, <span class="dt">dpar =</span> sigma, <span class="dt">resp =</span> PAstd),</a>
<a class="sourceLine" id="cb1862-19" data-line-number="19">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">dpar =</span> sigma, <span class="dt">resp =</span> PAstd),</a>
<a class="sourceLine" id="cb1862-20" data-line-number="20">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd, <span class="dt">dpar =</span> sigma, <span class="dt">resp =</span> PAstd),</a>
<a class="sourceLine" id="cb1862-21" data-line-number="21"></a>
<a class="sourceLine" id="cb1862-22" data-line-number="22">                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">2</span>), <span class="dt">class =</span> cor)),</a>
<a class="sourceLine" id="cb1862-23" data-line-number="23">      <span class="dt">iter =</span> <span class="dv">3000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1862-24" data-line-number="24">      <span class="dt">seed =</span> <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb1862-25" data-line-number="25">      <span class="dt">file =</span> <span class="st">&quot;fits/b14.15&quot;</span>)</a></code></pre></div>
<p>Note how we used the <code>resp</code> argument to indicate which priors went with which criterion variables. For the sake of space, I’ll skip showing the <code>print()</code> output. By all means, check that summary out if you fit this model on your own. Though there may be some substantive insights to glean from looking at the population-level parameters and the hierarchical <span class="math inline">\(\sigma\)</span>’s, I’d argue the main action is in the <span class="math inline">\(\mathbf R\)</span> matrix. This time we’ll jump straight to showcasing their posterior means in a correlation matrix plot.</p>
<p>First we wrangle.</p>
<div class="sourceCode" id="cb1863"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1863-1" data-line-number="1">levels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;beta[0]^&#39;NA&#39;&quot;</span>, <span class="st">&quot;beta[1]^&#39;NA&#39;&quot;</span>, <span class="st">&quot;eta[0]^&#39;NA&#39;&quot;</span>, <span class="st">&quot;eta[1]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-2" data-line-number="2">            <span class="st">&quot;beta[0]^&#39;PA&#39;&quot;</span>, <span class="st">&quot;beta[1]^&#39;PA&#39;&quot;</span>, <span class="st">&quot;eta[0]^&#39;PA&#39;&quot;</span>, <span class="st">&quot;eta[1]^&#39;PA&#39;&quot;</span>)</a>
<a class="sourceLine" id="cb1863-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1863-4" data-line-number="4"><span class="co"># two different options for ordering the parameters</span></a>
<a class="sourceLine" id="cb1863-5" data-line-number="5"><span class="co"># levels &lt;- c(&quot;beta[0]^&#39;NA&#39;&quot;, &quot;beta[1]^&#39;NA&#39;&quot;, &quot;beta[0]^&#39;PA&#39;&quot;, &quot;beta[1]^&#39;PA&#39;&quot;, &quot;eta[0]^&#39;NA&#39;&quot;, &quot;eta[1]^&#39;NA&#39;&quot;, &quot;eta[0]^&#39;PA&#39;&quot;, &quot;eta[1]^&#39;PA&#39;&quot;)</span></a>
<a class="sourceLine" id="cb1863-6" data-line-number="6"><span class="co"># levels &lt;- c(&quot;beta[0]^&#39;NA&#39;&quot;, &quot;beta[0]^&#39;PA&#39;&quot;, &quot;beta[1]^&#39;NA&#39;&quot;, &quot;beta[1]^&#39;PA&#39;&quot;,&quot;eta[0]^&#39;NA&#39;&quot;, &quot;eta[0]^&#39;PA&#39;&quot;, &quot;eta[1]^&#39;NA&#39;&quot;, &quot;eta[1]^&#39;PA&#39;&quot;)</span></a>
<a class="sourceLine" id="cb1863-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1863-8" data-line-number="8">r &lt;-</a>
<a class="sourceLine" id="cb1863-9" data-line-number="9"><span class="st">  </span><span class="kw">posterior_summary</span>(b14<span class="fl">.15</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1863-10" data-line-number="10"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1863-11" data-line-number="11"><span class="st">  </span><span class="kw">rownames_to_column</span>(<span class="st">&quot;param&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1863-12" data-line-number="12"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(param, <span class="st">&quot;cor_&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1863-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">param =</span> <span class="kw">str_remove</span>(param, <span class="st">&quot;cor_record_id__&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1863-14" data-line-number="14"><span class="st">  </span><span class="kw">separate</span>(param, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;right&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;__&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1863-15" data-line-number="15"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb1863-16" data-line-number="16">    <span class="dt">left =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb1863-17" data-line-number="17">      left <span class="op">==</span><span class="st"> &quot;NAstd_Intercept&quot;</span>       <span class="op">~</span><span class="st"> &quot;beta[0]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-18" data-line-number="18">      left <span class="op">==</span><span class="st"> &quot;NAstd_day01&quot;</span>           <span class="op">~</span><span class="st"> &quot;beta[1]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-19" data-line-number="19">      left <span class="op">==</span><span class="st"> &quot;sigma_NAstd_Intercept&quot;</span> <span class="op">~</span><span class="st"> &quot;eta[0]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-20" data-line-number="20">      left <span class="op">==</span><span class="st"> &quot;sigma_NAstd_day01&quot;</span>     <span class="op">~</span><span class="st"> &quot;eta[1]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-21" data-line-number="21">      left <span class="op">==</span><span class="st"> &quot;PAstd_Intercept&quot;</span>       <span class="op">~</span><span class="st"> &quot;beta[0]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-22" data-line-number="22">      left <span class="op">==</span><span class="st"> &quot;PAstd_day01&quot;</span>           <span class="op">~</span><span class="st"> &quot;beta[1]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-23" data-line-number="23">      left <span class="op">==</span><span class="st"> &quot;sigma_PAstd_Intercept&quot;</span> <span class="op">~</span><span class="st"> &quot;eta[0]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-24" data-line-number="24">      left <span class="op">==</span><span class="st"> &quot;sigma_PAstd_day01&quot;</span>     <span class="op">~</span><span class="st"> &quot;eta[1]^&#39;PA&#39;&quot;</span></a>
<a class="sourceLine" id="cb1863-25" data-line-number="25">      ),</a>
<a class="sourceLine" id="cb1863-26" data-line-number="26">    <span class="dt">right =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb1863-27" data-line-number="27">      right <span class="op">==</span><span class="st"> &quot;NAstd_Intercept&quot;</span>       <span class="op">~</span><span class="st"> &quot;beta[0]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-28" data-line-number="28">      right <span class="op">==</span><span class="st"> &quot;NAstd_day01&quot;</span>           <span class="op">~</span><span class="st"> &quot;beta[1]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-29" data-line-number="29">      right <span class="op">==</span><span class="st"> &quot;sigma_NAstd_Intercept&quot;</span> <span class="op">~</span><span class="st"> &quot;eta[0]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-30" data-line-number="30">      right <span class="op">==</span><span class="st"> &quot;sigma_NAstd_day01&quot;</span>     <span class="op">~</span><span class="st"> &quot;eta[1]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-31" data-line-number="31">      right <span class="op">==</span><span class="st"> &quot;PAstd_Intercept&quot;</span>       <span class="op">~</span><span class="st"> &quot;beta[0]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-32" data-line-number="32">      right <span class="op">==</span><span class="st"> &quot;PAstd_day01&quot;</span>           <span class="op">~</span><span class="st"> &quot;beta[1]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-33" data-line-number="33">      right <span class="op">==</span><span class="st"> &quot;sigma_PAstd_Intercept&quot;</span> <span class="op">~</span><span class="st"> &quot;eta[0]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1863-34" data-line-number="34">      right <span class="op">==</span><span class="st"> &quot;sigma_PAstd_day01&quot;</span>     <span class="op">~</span><span class="st"> &quot;eta[1]^&#39;PA&#39;&quot;</span></a>
<a class="sourceLine" id="cb1863-35" data-line-number="35">    )</a>
<a class="sourceLine" id="cb1863-36" data-line-number="36">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1863-37" data-line-number="37"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">label =</span> <span class="kw">formatC</span>(Estimate, <span class="dt">digits =</span> <span class="dv">2</span>, <span class="dt">format =</span> <span class="st">&quot;f&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_replace</span>(., <span class="st">&quot;0.&quot;</span>, <span class="st">&quot;.&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1863-38" data-line-number="38"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">left  =</span> <span class="kw">factor</span>(left, <span class="dt">levels =</span> levels),</a>
<a class="sourceLine" id="cb1863-39" data-line-number="39">         <span class="dt">right =</span> <span class="kw">factor</span>(right, <span class="dt">levels =</span> levels)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1863-40" data-line-number="40"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">right =</span> <span class="kw">fct_rev</span>(right))</a>
<a class="sourceLine" id="cb1863-41" data-line-number="41"></a>
<a class="sourceLine" id="cb1863-42" data-line-number="42">r <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>##           left        right   Estimate  Est.Error       Q2.5       Q97.5 label
## 1 beta[0]^&#39;NA&#39; beta[1]^&#39;NA&#39; -0.2936392 0.08011244 -0.4418254 -0.12977800  -.29
## 2 beta[0]^&#39;NA&#39;  eta[0]^&#39;NA&#39;  0.6305495 0.04710695  0.5321697  0.71560820   .63
## 3 beta[1]^&#39;NA&#39;  eta[0]^&#39;NA&#39; -0.1861780 0.07788801 -0.3338475 -0.03154498  -.19
## 4 beta[0]^&#39;NA&#39;  eta[1]^&#39;NA&#39; -0.1492830 0.10268515 -0.3456739  0.05497218  -.15
## 5 beta[1]^&#39;NA&#39;  eta[1]^&#39;NA&#39;  0.5760261 0.09054524  0.3815385  0.73786003   .58
## 6  eta[0]^&#39;NA&#39;  eta[1]^&#39;NA&#39; -0.1435354 0.09518244 -0.3287338  0.04559049  -.14</code></pre>
<p>Now we plot!</p>
<div class="sourceCode" id="cb1865"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1865-1" data-line-number="1">r <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1865-2" data-line-number="2"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">rename</span>(r, <span class="dt">right =</span> left, <span class="dt">left =</span> right),</a>
<a class="sourceLine" id="cb1865-3" data-line-number="3">            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;right&quot;</span>, <span class="st">&quot;Estimate&quot;</span>, <span class="st">&quot;Est.Error&quot;</span>, <span class="st">&quot;Q2.5&quot;</span>, <span class="st">&quot;Q97.5&quot;</span>, <span class="st">&quot;label&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1865-4" data-line-number="4"><span class="st">  </span></a>
<a class="sourceLine" id="cb1865-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> left, <span class="dt">y =</span> right)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1865-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Estimate)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1865-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="fl">4.5</span>, <span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1865-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">4.5</span>, <span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1865-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> label),</a>
<a class="sourceLine" id="cb1865-10" data-line-number="10">            <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>, <span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1865-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_fill_gradient2</span>(<span class="kw">expression</span>(rho),</a>
<a class="sourceLine" id="cb1865-12" data-line-number="12">                       <span class="dt">low =</span> <span class="st">&quot;#59708b&quot;</span>, <span class="dt">mid =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">midpoint =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb1865-13" data-line-number="13">                       <span class="dt">labels =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="st">&quot;&quot;</span>, <span class="dv">0</span>, <span class="st">&quot;&quot;</span>, <span class="dv">1</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1865-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="dt">labels =</span> ggplot2<span class="op">:::</span>parse_safe, <span class="dt">position =</span> <span class="st">&quot;top&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1865-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="ot">NULL</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="dt">labels =</span> ggplot2<span class="op">:::</span>parse_safe) <span class="op">+</span></a>
<a class="sourceLine" id="cb1865-16" data-line-number="16"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">12</span>),</a>
<a class="sourceLine" id="cb1865-17" data-line-number="17">        <span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1865-18" data-line-number="18">        <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">1</span>))</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-126-1.png" width="600" style="display: block; margin: auto;" /></p>
<p>The <code>full_join()</code> business just before the <strong>ggplot2</strong> code is how we got the full <span class="math inline">\(8 \times 8\)</span> matrix. If you’re curious, see what happens if you run the code without that part.</p>
<p>To help orient you to the plot, I’ve divided it into four quadrants. The upper left and lower right quadrants are the correlations among the varying parameters for the <code>N_A.std</code> and <code>P_A.std</code> ratings, respectively. The other two quadrants are the correlations for those parameters between <code>N_A.std</code> and <code>P_A.std</code>. As a reminder, this matrix, as with any other correlation matrix, is symmetrical across the diagonal.</p>
<p>To my eye, a few things pop out. First, the correlations within <code>N_A.std</code> are generally higher than those within <code>P_A.std</code>. Second, the correlations among the parameters between <code>N_A.std</code> and <code>P_A.std</code> are generally higher than those within them. Finally, all three of the largest correlations have to do with variation in the <span class="math inline">\(\eta\)</span> parameters. Two of them are basically the same as those we focused on for <code>fit3</code>. The new one, <span class="math inline">\(\rho_{73}\)</span>, indicates that participants’ baseline ratings for <code>N_A.std</code> tended to vary in a similar way as their baseline ratings for <code>P_A.std</code>.</p>
<div id="plot-with-uncertainty." class="section level4">
<h4><span class="header-section-number">14.6.4.1</span> Plot with uncertainty.</h4>
<p>As fond as I am with that last correlation plot, it has a glaring defect: there is no expression of uncertainty. Sometimes we express uncertainty with percentile-based intervals. Other times we do so with marginal densities. But the correlation plots only describe the marginal posteriors for all the <span class="math inline">\(\rho\)</span> parameters with their means–no uncertainty. If you have one or a small few correlations to plot, coefficient or density plots might do. However, they don’t scale well. If you don’t believe me, just try. I’m not sure there are any good solutions to this, but it can be helpful to at least try grappling with the issue.</p>
<p>Fortunately for us, <a href="https://twitter.com/mjskay">Matthew Kay</a> (creator of the <a href="http://mjskay.github.io/tidybayes"><strong>tidybayes</strong> package</a>) has already tried his hand at a few approaches. For all the deets, check out the <a href="https://github.com/mjskay/uncertainty-examples/blob/master/multivariate-regression.md">multivariate-regression.md</a> file in his <a href="https://github.com/mjskay/uncertainty-examples">uncertainty-examples</a> GitHub repo. One of his more imaginative approaches is to use what he calls dithering. Imagine breaking each of the cells in our correlation plot, above, into a <span class="math inline">\(50 \times 50 = 2,500\)</span>-cell grid. Now assign each of the cells within that grid one of the values from the HMC draws of that correlation’s posterior distribution. Then color code each of those cells by that value in the same basic way we color coded our previous correlation plots. Simultaneously do that for all of the correlations within the <span class="math inline">\(\mathbf R\)</span> matrix and plot them in a faceted plot. That’s the essence of the dithering approach. This is all probably hard to make sense of in words. Hopefully it will all come together with a little code and the resulting plot. Hold on to your hat.</p>
<div class="sourceCode" id="cb1866"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1866-1" data-line-number="1">levels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;beta[0]^&#39;NA&#39;&quot;</span>, <span class="st">&quot;beta[1]^&#39;NA&#39;&quot;</span>, <span class="st">&quot;eta[0]^&#39;NA&#39;&quot;</span>, <span class="st">&quot;eta[1]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-2" data-line-number="2">            <span class="st">&quot;beta[0]^&#39;PA&#39;&quot;</span>, <span class="st">&quot;beta[1]^&#39;PA&#39;&quot;</span>, <span class="st">&quot;eta[0]^&#39;PA&#39;&quot;</span>, <span class="st">&quot;eta[1]^&#39;PA&#39;&quot;</span>)</a>
<a class="sourceLine" id="cb1866-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1866-4" data-line-number="4">r &lt;-</a>
<a class="sourceLine" id="cb1866-5" data-line-number="5"><span class="st">  </span><span class="kw">posterior_samples</span>(b14<span class="fl">.15</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1866-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;cor_&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1866-7" data-line-number="7"><span class="st">  </span><span class="kw">sample_n</span>(<span class="dt">size =</span> <span class="dv">50</span> <span class="op">*</span><span class="st"> </span><span class="dv">50</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1866-8" data-line-number="8"><span class="st">  </span><span class="kw">bind_cols</span>(<span class="kw">crossing</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">50</span>, <span class="dt">y =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">50</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1866-9" data-line-number="9"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span><span class="kw">c</span>(x<span class="op">:</span>y)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1866-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">str_remove</span>(name, <span class="st">&quot;cor_record_id__&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1866-11" data-line-number="11"><span class="st">  </span><span class="kw">separate</span>(name, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;col&quot;</span>, <span class="st">&quot;row&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;__&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1866-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb1866-13" data-line-number="13">    <span class="dt">col =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb1866-14" data-line-number="14">      col <span class="op">==</span><span class="st"> &quot;NAstd_Intercept&quot;</span>       <span class="op">~</span><span class="st"> &quot;beta[0]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-15" data-line-number="15">      col <span class="op">==</span><span class="st"> &quot;NAstd_day01&quot;</span>           <span class="op">~</span><span class="st"> &quot;beta[1]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-16" data-line-number="16">      col <span class="op">==</span><span class="st"> &quot;sigma_NAstd_Intercept&quot;</span> <span class="op">~</span><span class="st"> &quot;eta[0]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-17" data-line-number="17">      col <span class="op">==</span><span class="st"> &quot;sigma_NAstd_day01&quot;</span>     <span class="op">~</span><span class="st"> &quot;eta[1]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-18" data-line-number="18">      col <span class="op">==</span><span class="st"> &quot;PAstd_Intercept&quot;</span>       <span class="op">~</span><span class="st"> &quot;beta[0]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-19" data-line-number="19">      col <span class="op">==</span><span class="st"> &quot;PAstd_day01&quot;</span>           <span class="op">~</span><span class="st"> &quot;beta[1]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-20" data-line-number="20">      col <span class="op">==</span><span class="st"> &quot;sigma_PAstd_Intercept&quot;</span> <span class="op">~</span><span class="st"> &quot;eta[0]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-21" data-line-number="21">      col <span class="op">==</span><span class="st"> &quot;sigma_PAstd_day01&quot;</span>     <span class="op">~</span><span class="st"> &quot;eta[1]^&#39;PA&#39;&quot;</span></a>
<a class="sourceLine" id="cb1866-22" data-line-number="22">    ),</a>
<a class="sourceLine" id="cb1866-23" data-line-number="23">    <span class="dt">row =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb1866-24" data-line-number="24">      row <span class="op">==</span><span class="st"> &quot;NAstd_Intercept&quot;</span>       <span class="op">~</span><span class="st"> &quot;beta[0]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-25" data-line-number="25">      row <span class="op">==</span><span class="st"> &quot;NAstd_day01&quot;</span>           <span class="op">~</span><span class="st"> &quot;beta[1]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-26" data-line-number="26">      row <span class="op">==</span><span class="st"> &quot;sigma_NAstd_Intercept&quot;</span> <span class="op">~</span><span class="st"> &quot;eta[0]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-27" data-line-number="27">      row <span class="op">==</span><span class="st"> &quot;sigma_NAstd_day01&quot;</span>     <span class="op">~</span><span class="st"> &quot;eta[1]^&#39;NA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-28" data-line-number="28">      row <span class="op">==</span><span class="st"> &quot;PAstd_Intercept&quot;</span>       <span class="op">~</span><span class="st"> &quot;beta[0]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-29" data-line-number="29">      row <span class="op">==</span><span class="st"> &quot;PAstd_day01&quot;</span>           <span class="op">~</span><span class="st"> &quot;beta[1]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-30" data-line-number="30">      row <span class="op">==</span><span class="st"> &quot;sigma_PAstd_Intercept&quot;</span> <span class="op">~</span><span class="st"> &quot;eta[0]^&#39;PA&#39;&quot;</span>,</a>
<a class="sourceLine" id="cb1866-31" data-line-number="31">      row <span class="op">==</span><span class="st"> &quot;sigma_PAstd_day01&quot;</span>     <span class="op">~</span><span class="st"> &quot;eta[1]^&#39;PA&#39;&quot;</span></a>
<a class="sourceLine" id="cb1866-32" data-line-number="32">    )</a>
<a class="sourceLine" id="cb1866-33" data-line-number="33">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1866-34" data-line-number="34"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">col =</span> <span class="kw">factor</span>(col, <span class="dt">levels =</span> levels),</a>
<a class="sourceLine" id="cb1866-35" data-line-number="35">         <span class="dt">row =</span> <span class="kw">factor</span>(row, <span class="dt">levels =</span> levels))</a>
<a class="sourceLine" id="cb1866-36" data-line-number="36"></a>
<a class="sourceLine" id="cb1866-37" data-line-number="37">r <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1866-38" data-line-number="38"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">rename</span>(r, <span class="dt">col =</span> row, <span class="dt">row =</span> col),</a>
<a class="sourceLine" id="cb1866-39" data-line-number="39">            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;col&quot;</span>, <span class="st">&quot;row&quot;</span>, <span class="st">&quot;value&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1866-40" data-line-number="40"><span class="st">  </span></a>
<a class="sourceLine" id="cb1866-41" data-line-number="41"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">fill =</span> value)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1866-42" data-line-number="42"><span class="st">  </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb1866-43" data-line-number="43"><span class="st">  </span><span class="kw">scale_fill_gradient2</span>(<span class="kw">expression</span>(rho),</a>
<a class="sourceLine" id="cb1866-44" data-line-number="44">                       <span class="dt">low =</span> <span class="st">&quot;#59708b&quot;</span>, <span class="dt">mid =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">midpoint =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb1866-45" data-line-number="45">                       <span class="dt">labels =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="st">&quot;&quot;</span>, <span class="dv">0</span>, <span class="st">&quot;&quot;</span>, <span class="dv">1</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1866-46" data-line-number="46"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1866-47" data-line-number="47"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1866-48" data-line-number="48"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">strip.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">12</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1866-49" data-line-number="49"><span class="st">  </span><span class="kw">facet_grid</span>(row<span class="op">~</span>col, <span class="dt">labeller =</span> label_parsed, <span class="dt">switch =</span> <span class="st">&quot;y&quot;</span>)</a></code></pre></div>
<p><img src="14_files/figure-gfm/unnamed-chunk-127-1.png" width="600" style="display: block; margin: auto;" /></p>
<p>From Kay’s GitHub repo, we read: “This is akin to something like an icon array. You should still be able to see the average color (thanks to the human visual system’s ensembling processing), but also get a sense of the uncertainty by how ‘dithered’ a square looks.” Hopefully this will give you a little inspiration to find new and better ways to express the posterior uncertainty in your Bayesian correlation plots. If you come up with any great solutions, <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/issues">let the rest of us know</a>!</p>
</div>
</div>
<div id="growth-modelmelsm-wrap-up." class="section level3">
<h3><span class="header-section-number">14.6.5</span> Growth model/MELSM wrap-up.</h3>
<p>This bonus section introduced a lot of material. To learn more about the conventional multilevel growth model and its extensions, check out</p>
<ul>
<li>Singer and Willett’s <span class="citation">(<a href="#ref-singerAppliedLongitudinalData2003">2003</a>)</span> text, <a href="https://oxford.universitypressscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968"><em>Applied longitudinal data analysis: Modeling change and event occurrence</em></a>;</li>
<li>My <strong>brms</strong>/<strong>tidyverse</strong> translation of that text, <a href="https://bookdown.org/content/4253/"><em>Applied Longitudinal Data Analysis in brms and the tidyverse </em></a>; or</li>
<li>Hoffman’s <span class="citation">(<a href="#ref-hoffmanLongitudinalAnalysisModeling2015">2015</a>)</span> text, <a href="https://www.routledge.com/Longitudinal-Analysis-Modeling-Within-Person-Fluctuation-and-Change/Hoffman/p/book/9780415876025"><em>Longitudinal analysis: Modeling within-person fluctuation and change</em></a>.</li>
</ul>
<p>To learn more about the MELSM approach and its extensions, check out</p>
<ul>
<li><span class="citation">Hedeker et al. (<a href="#ref-hedekerApplicationMixedeffectsLocation2008">2008</a>)</span>, <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2424261/"><em>An application of a mixed-effects location scale model for analysis of ecological momentary assessment (EMA) data</em></a>;</li>
<li><span class="citation">Hedeker et al. (<a href="#ref-hedekerModelingWithinsubjectVariance2012">2012</a>)</span>, <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3655706/"><em>Modeling between- and within-subject variance in ecological momentary assessment (EMA) data using mixed-effects location scale models</em></a>;</li>
<li>Williams’ and colleagues’ <span class="citation">(<a href="#ref-williamsBayesianMultivariateMixedeffects2019a">2019</a>)</span> preprint, <a href="https://psyarxiv.com/4kfjp/"><em>Bayesian multivariate mixed-effects location scale modeling of longitudinal relations among affective traits, states, and physical activity</em></a>;</li>
<li>Williams’ and colleagues’ <span class="citation">(<a href="#ref-williamsSurfaceUnearthingWithinperson2019">2019</a>)</span> preprint, <a href="https://osf.io/gwatq"><em>Beneath the surface: Unearthing within-person variability and mean relations with Bayesian mixed models</em></a>;</li>
<li>Williams’ and colleagues’ <span class="citation">(<a href="#ref-williamsBayesianNonlinearMixedeffects2019a">2019</a>)</span> paper, <a href="https://doi.org/10.3758/s13428-019-01255-9"><em>A Bayesian nonlinear mixed-effects location scale model for learning</em></a>;</li>
<li>Williams’ tutorial blog post, <a href="https://donaldrwilliams.github.io/2020/04/04/a-defining-feature-of-cognitive-interference-tasks-heterogeneous-within-person-variance/"><em>A defining feature of cognitive interference tasks: Heterogeneous within-person variance</em></a>.</li>
</ul>
<p>From a <strong>brms</strong> standpoint, it might also be helpful to brush up on</p>
<ul>
<li>Bürkner’s <span class="citation">(<a href="#ref-Bürkner2020Distributional">2020</a><a href="#ref-Bürkner2020Distributional">b</a>)</span> vignette, <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_distreg.html"><em>Estimating distributional models with brms</em></a> and</li>
<li>Bürkner’s <span class="citation">(<a href="#ref-Bürkner2020Multivariate">2020</a><a href="#ref-Bürkner2020Multivariate">c</a>)</span> vignette, <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_multivariate.html"><em>Estimating multivariate models with brms</em></a>.</li>
</ul>
</div>
</div>
<div id="session-info-13" class="section level2 unnumbered">
<h2>Session info</h2>
<div class="sourceCode" id="cb1867"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1867-1" data-line-number="1"><span class="kw">sessionInfo</span>()</a></code></pre></div>
<pre><code>## R version 3.6.3 (2020-02-29)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS Catalina 10.15.3
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] parallel  stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] ape_5.4              ggtree_2.3.3.993     ggrepel_0.8.2        rethinking_2.01      ggdag_0.2.2         
##  [6] posterior_0.1.0      bayesplot_1.7.1      patchwork_1.0.1.9000 brms_2.13.0          Rcpp_1.0.5          
## [11] tidybayes_2.1.1      dagitty_0.2-2        rstan_2.19.3         StanHeaders_2.21.0-1 dutchmasters_0.1.0  
## [16] forcats_0.5.0        stringr_1.4.0        dplyr_1.0.1          purrr_0.3.4          readr_1.3.1         
## [21] tidyr_1.1.1          tibble_3.0.3         ggplot2_3.3.2        tidyverse_1.3.0     
## 
## loaded via a namespace (and not attached):
##   [1] readxl_1.3.1         backports_1.1.8      plyr_1.8.6           igraph_1.2.5         lazyeval_0.2.2      
##   [6] splines_3.6.3        svUnit_1.0.3         crosstalk_1.1.0.1    TH.data_1.0-10       rstantools_2.0.0    
##  [11] inline_0.3.15        digest_0.6.25        invgamma_1.1         htmltools_0.5.0      viridis_0.5.1       
##  [16] rsconnect_0.8.16     fansi_0.4.1          magrittr_1.5         checkmate_2.0.0      graphlayouts_0.7.0  
##  [21] modelr_0.1.6         matrixStats_0.56.0   xts_0.12-0           sandwich_2.5-1       prettyunits_1.1.1   
##  [26] colorspace_1.4-1     rvest_0.3.5          ggdist_2.1.1         haven_2.2.0          xfun_0.13           
##  [31] hexbin_1.28.1        callr_3.4.3          crayon_1.3.4         jsonlite_1.7.0       survival_3.1-12     
##  [36] zoo_1.8-7            glue_1.4.1           polyclip_1.10-0      gtable_0.3.0         emmeans_1.4.5       
##  [41] V8_3.0.2             pkgbuild_1.1.0       shape_1.4.4          abind_1.4-5          scales_1.1.1        
##  [46] mvtnorm_1.1-0        emo_0.0.0.9000       DBI_1.1.0            miniUI_0.1.1.1       viridisLite_0.3.0   
##  [51] xtable_1.8-4         HDInterval_0.2.0     tidytree_0.3.3       stats4_3.6.3         DT_0.13             
##  [56] htmlwidgets_1.5.1    httr_1.4.1           threejs_0.3.3        arrayhelpers_1.1-0   ellipsis_0.3.1      
##  [61] pkgconfig_2.0.3      loo_2.2.0            farver_2.0.3         dbplyr_1.4.2         utf8_1.1.4          
##  [66] tidyselect_1.1.0     labeling_0.3         rlang_0.4.7          reshape2_1.4.4       later_1.1.0.1       
##  [71] munsell_0.5.0        cellranger_1.1.0     tools_3.6.3          cli_2.0.2            generics_0.0.2      
##  [76] broom_0.5.5          ggridges_0.5.2       evaluate_0.14        fastmap_1.0.1        yaml_2.2.1          
##  [81] processx_3.4.3       knitr_1.28           fs_1.4.1             tidygraph_1.2.0      ggraph_2.0.3        
##  [86] nlme_3.1-144         mime_0.9             aplot_0.0.5          xml2_1.3.1           compiler_3.6.3      
##  [91] shinythemes_1.1.2    rstudioapi_0.11      curl_4.3             treeio_1.13.1        reprex_0.3.0        
##  [96] tweenr_1.0.1         stringi_1.4.6        ps_1.3.4             Brobdingnag_1.2-6    lattice_0.20-38     
## [101] Matrix_1.2-18        markdown_1.1         shinyjs_1.1          vctrs_0.3.2          pillar_1.4.6        
## [106] lifecycle_0.2.0      BiocManager_1.30.10  bridgesampling_1.0-0 estimability_1.3     httpuv_1.5.4        
## [111] R6_2.4.1             bookdown_0.18        promises_1.1.1       gridExtra_2.3        nleqslv_3.3.2       
## [116] codetools_0.2-16     boot_1.3-24          colourpicker_1.0     MASS_7.3-51.5        gtools_3.8.2        
## [121] assertthat_0.2.1     withr_2.2.0          shinystan_2.5.0      multcomp_1.4-13      hms_0.5.3           
## [126] grid_3.6.3           coda_0.19-3          rvcheck_0.1.8        rmarkdown_2.1        ggforce_0.3.1       
## [131] shiny_1.5.0          lubridate_1.7.8      base64enc_0.1-3      dygraphs_1.1.1.6</code></pre>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-angristDoesCompulsorySchool1991">
<p>Angrist, J. D., &amp; Keueger, A. B. (1991). Does compulsory school attendance affect schooling and earnings? <em>The Quarterly Journal of Economics</em>, <em>106</em>(4), 979–1014. <a href="https://doi.org/10.2307/2937954">https://doi.org/10.2307/2937954</a></p>
</div>
<div id="ref-betancourtRobustGaussianProcesses2017">
<p>Betancourt, M. (2017). <em>Robust Gaussian processes in Stan</em>. <a href="https://betanalpha.github.io/assets/case_studies/gp_part3/part3.html">https://betanalpha.github.io/assets/case_studies/gp_part3/part3.html</a></p>
</div>
<div id="ref-Bürkner2020Distributional">
<p>Bürkner, P.-C. (2020b). <em>Estimating distributional models with brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_distreg.html">https://CRAN.R-project.org/package=brms/vignettes/brms_distreg.html</a></p>
</div>
<div id="ref-Bürkner2020Multivariate">
<p>Bürkner, P.-C. (2020c). <em>Estimating multivariate models with brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_multivariate.html">https://CRAN.R-project.org/package=brms/vignettes/brms_multivariate.html</a></p>
</div>
<div id="ref-Bürkner2020Phylogenetic">
<p>Bürkner, P.-C. (2020f). <em>Estimating phylogenetic multilevel models with brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_phylogenetics.html">https://CRAN.R-project.org/package=brms/vignettes/brms_phylogenetics.html</a></p>
</div>
<div id="ref-brms2020RM">
<p>Bürkner, P.-C. (2020h). <em>brms reference manual, Version 2.13.5</em>. <a href="https://CRAN.R-project.org/package=brms/brms.pdf">https://CRAN.R-project.org/package=brms/brms.pdf</a></p>
</div>
<div id="ref-gelmanWhyHighorderPolynomials2019">
<p>Gelman, A., &amp; Imbens, G. (2019). Why high-order polynomials should not be used in regression discontinuity designs. <em>Journal of Business &amp; Economic Statistics</em>, <em>37</em>(3), 447–456. <a href="https://doi.org/10.1080/07350015.2017.1366909">https://doi.org/10.1080/07350015.2017.1366909</a></p>
</div>
<div id="ref-hedekerApplicationMixedeffectsLocation2008">
<p>Hedeker, D., Mermelstein, R. J., &amp; Demirtas, H. (2008). An application of a mixed-effects location scale model for analysis of ecological momentary assessment (EMA) data. <em>Biometrics</em>, <em>64</em>(2), 627–634. <a href="https://doi.org/10.1111/j.1541-0420.2007.00924.x">https://doi.org/10.1111/j.1541-0420.2007.00924.x</a></p>
</div>
<div id="ref-hedekerModelingWithinsubjectVariance2012">
<p>Hedeker, D., Mermelstein, R. J., &amp; Demirtas, H. (2012). Modeling between- and within-subject variance in ecological momentary assessment (EMA) data using mixed-effects location scale models. <em>Statistics in Medicine</em>, <em>31</em>(27). <a href="https://doi.org/10.1002/sim.5338">https://doi.org/10.1002/sim.5338</a></p>
</div>
<div id="ref-hoffmanLongitudinalAnalysisModeling2015">
<p>Hoffman, L. (2015). <em>Longitudinal analysis: Modeling within-person fluctuation and change</em> (1 edition). Routledge. <a href="https://www.routledge.com/Longitudinal-Analysis-Modeling-Within-Person-Fluctuation-and-Change/Hoffman/p/book/9780415876025">https://www.routledge.com/Longitudinal-Analysis-Modeling-Within-Person-Fluctuation-and-Change/Hoffman/p/book/9780415876025</a></p>
</div>
<div id="ref-R-invgamma">
<p>Kahle, D., &amp; Stamey, J. (2017). <em>invgamma: The inverse gamma distribution</em> [Manual]. <a href="https://CRAN.R-project.org/package=invgamma">https://CRAN.R-project.org/package=invgamma</a></p>
</div>
<div id="ref-kayMarginalDistributionSingle2020">
<p>Kay, M. (2020b). <em>Marginal distribution of a single correlation from an LKJ distribution</em>. <a href="https://mjskay.github.io/ggdist/reference/lkjcorr_marginal.html">https://mjskay.github.io/ggdist/reference/lkjcorr_marginal.html</a></p>
</div>
<div id="ref-kosterFoodSharingNetworks2014">
<p>Koster, J. M., &amp; Leckie, G. (2014). Food sharing networks in lowland Nicaragua: An application of the social relations model to count data. <em>Social Networks</em>, <em>38</em>, 100–110. <a href="https://doi.org/10.1016/j.socnet.2014.02.002">https://doi.org/10.1016/j.socnet.2014.02.002</a></p>
</div>
<div id="ref-kruschkeDoingBayesianData2015">
<p>Kruschke, J. K. (2015). <em>Doing Bayesian data analysis: A tutorial with R, JAGS, and Stan</em>. Academic Press. <a href="https://sites.google.com/site/doingbayesiandataanalysis/">https://sites.google.com/site/doingbayesiandataanalysis/</a></p>
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2020">
<p>McElreath, R. (2020a). <em>Statistical rethinking: A Bayesian course with examples in R and Stan</em> (Second edition). CRC Press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a></p>
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2015">
<p>McElreath, R. (2015). <em>Statistical rethinking: A Bayesian course with examples in R and Stan</em>. CRC press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a></p>
</div>
<div id="ref-R-ape">
<p>Paradis, E., Blomberg, S., Bolker, B., Brown, J., Claramunt, S., Claude, J., Cuong, H. S., Desper, R., Didier, G., Durand, B., Dutheil, J., Ewing, R., Gascuel, O., Guillerme, T., Heibl, C., Ives, A., Jones, B., Krah, F., Lawson, D., … de Vienne, D. (2020). <em>ape: Analyses of phylogenetics and evolution</em> [Manual]. <a href="https://CRAN.R-project.org/package=ape">https://CRAN.R-project.org/package=ape</a></p>
</div>
<div id="ref-ape2019">
<p>Paradis, E., &amp; Schliep, K. (2019). ape 5.0: An environment for modern phylogenetics and evolutionary analyses in R. <em>Bioinformatics</em>, <em>35</em>, 526–528. <a href="https://doi.org/10.1093/bioinformatics/bty633">https://doi.org/10.1093/bioinformatics/bty633</a></p>
</div>
<div id="ref-pengMasteringSoftwareDevelopment2017">
<p>Peng, R. D., Kross, S., &amp; Anderson, B. (2017). <em>Mastering software development in {}R{}</em>. <a href="https://github.com/rdpeng/RProgDA">https://github.com/rdpeng/RProgDA</a></p>
</div>
<div id="ref-rastModelingIndividualDifferences2012">
<p>Rast, P., Hofer, S. M., &amp; Sparks, C. (2012). Modeling individual differences in within-person variation of negative and positive affect in a mixed effects location scale model using BUGS/JAGS. <em>Multivariate Behavioral Research</em>, <em>47</em>(2), 177–200. <a href="https://doi.org/10.1080/00273171.2012.658328">https://doi.org/10.1080/00273171.2012.658328</a></p>
</div>
<div id="ref-singerAppliedLongitudinalData2003">
<p>Singer, J. D., &amp; Willett, J. B. (2003). <em>Applied longitudinal data analysis: Modeling change and event occurrence</em>. Oxford University Press, USA. <a href="https://oxford.universitypressscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968">https://oxford.universitypressscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968</a></p>
</div>
<div id="ref-streetCoevolutionCulturalIntelligence2017">
<p>Street, S. E., Navarrete, A. F., Reader, S. M., &amp; Laland, K. N. (2017). Coevolution of cultural intelligence, extended life history, sociality, and brain size in primates. <em>Proceedings of the National Academy of Sciences</em>, <em>114</em>(30), 7908–7914. <a href="https://doi.org/10.1073/pnas.1620734114">https://doi.org/10.1073/pnas.1620734114</a></p>
</div>
<div id="ref-R-dutchmasters">
<p>Thoen, E. (2019). <em>dutchmasters</em> [Manual]. <a href="https://github.com/EdwinTh/dutchmasters">https://github.com/EdwinTh/dutchmasters</a></p>
</div>
<div id="ref-vermeerGirlPearlEarring1665">
<p>Vermeer, J. (1665). <em>Girl with a pearl earring</em>.</p>
</div>
<div id="ref-watsonPANASDevelopment1988">
<p>Watson, D., Clark, L. A., &amp; Tellegen, A. (1988). Development and validation of brief measures of positive and negative affect: The PANAS scales. <em>Journal of Personality and Social Psychology</em>, <em>54</em>(6), 1063–1070. <a href="https://doi.org/10.1037/0022-3514.54.6.1063">https://doi.org/10.1037/0022-3514.54.6.1063</a></p>
</div>
<div id="ref-wickhamGgplot2ElegantGraphics2016">
<p>Wickham, H. (2016). <em>ggplot2: Elegant graphics for data analysis</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a></p>
</div>
<div id="ref-williamsBayesianMultivariateMixedeffects2019a">
<p>Williams, D. R., Liu, S., Martin, S. R., &amp; Rast, P. (2019). <em>Bayesian multivariate mixed-effects location scale modeling of longitudinal relations among affective traits, states, and physical activity</em>. <a href="https://doi.org/10.31234/osf.io/4kfjp">https://doi.org/10.31234/osf.io/4kfjp</a></p>
</div>
<div id="ref-williamsPuttingIndividualReliability2019">
<p>Williams, D. R., Martin, S. R., &amp; Rast, P. (2019). <em>Putting the individual into reliability: Bayesian testing of homogeneous within-person variance in hierarchical models</em>. <a href="https://doi.org/10.31234/osf.io/hpq7w">https://doi.org/10.31234/osf.io/hpq7w</a></p>
</div>
<div id="ref-williamsSurfaceUnearthingWithinperson2019">
<p>Williams, D. R., Rouder, J., &amp; Rast, P. (2019). <em>Beneath the surface: Unearthing within-Person variability and mean relations with Bayesian mixed models</em>. <a href="https://doi.org/10.31234/osf.io/gwatq">https://doi.org/10.31234/osf.io/gwatq</a></p>
</div>
<div id="ref-williamsBayesianNonlinearMixedeffects2019a">
<p>Williams, D. R., Zimprich, D. R., &amp; Rast, P. (2019). A Bayesian nonlinear mixed-effects location scale model for learning. <em>Behavior Research Methods</em>, <em>51</em>(5), 1968–1986. <a href="https://doi.org/10.3758/s13428-019-01255-9">https://doi.org/10.3758/s13428-019-01255-9</a></p>
</div>
<div id="ref-yuDataIntegrationManipulation2020">
<p>Yu, G. (2020a). <em>Data integration, manipulation and visualization of phylogenetic trees</em>. <a href="https://yulab-smu.github.io/treedata-book/">https://yulab-smu.github.io/treedata-book/</a></p>
</div>
<div id="ref-yuUsingGgtreeVisualize2020">
<p>Yu, G. (2020b). Using ggtree to visualize data on tree-like structures. <em>Current Protocols in Bioinformatics</em>, <em>69</em>(1), e96. <a href="https://doi.org/10.1002/cpbi.96">https://doi.org/10.1002/cpbi.96</a></p>
</div>
<div id="ref-yuTwoMethodsMapping2018">
<p>Yu, G., Lam, T. T.-Y., Zhu, H., &amp; Guan, Y. (2018). Two methods for mapping and visualizing associated data on phylogeny using ggtree. <em>Molecular Biology and Evolution</em>, <em>35</em>(12), 3041–3043. <a href="https://doi.org/10.1093/molbev/msy194">https://doi.org/10.1093/molbev/msy194</a></p>
</div>
<div id="ref-yuGgtreePackageVisualization2017">
<p>Yu, G., Smith, D. K., Zhu, H., Guan, Y., &amp; Lam, T. T.-Y. (2017). ggtree: An r package for visualization and annotation of phylogenetic trees with their covariates and other associated data. <em>Methods in Ecology and Evolution</em>, <em>8</em>(1), 28–36. <a href="https://doi.org/10.1111/2041-210X.12628">https://doi.org/10.1111/2041-210X.12628</a></p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="models-with-memory.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
