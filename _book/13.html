<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>13&nbsp; Models With Memory – *Statistical rethinking* 2 with rstan and the tidyverse</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./14.html" rel="next">
<link href="./12.html" rel="prev">
<link href="./mischa_favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7d082c015fa132ca880f975003d7bf2f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./13.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Models With Memory</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./"><em>Statistical rethinking</em> 2 with rstan and the tidyverse</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Golem of Prague</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Small Worlds and Large Worlds</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Sampling the Imaginary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geocentric Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The Many Variables &amp; The Spurious Waffles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The Haunted DAG &amp; The Causal Terror</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Ulysses’ Compass</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Conditional Manatees</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Big Entropy and the Generalized Linear Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">God Spiked the Integers</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Monsters and Mixtures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Models With Memory</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Adventures in Covariance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Missing Data and Other Opportunities</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Generalized Linear Madness</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title"><del>Horoscopes</del> Insights</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#example-multilevel-tadpoles" id="toc-example-multilevel-tadpoles" class="nav-link active" data-scroll-target="#example-multilevel-tadpoles"><span class="header-section-number">13.1</span> Example: Multilevel tadpoles</a>
  <ul>
  <li><a href="#rethinking-varying-intercepts-as-over-dispersion" id="toc-rethinking-varying-intercepts-as-over-dispersion" class="nav-link" data-scroll-target="#rethinking-varying-intercepts-as-over-dispersion"><span class="header-section-number">13.1.0.1</span> Rethinking: Varying intercepts as over-dispersion</a></li>
  <li><a href="#overthinking-prior-for-variance-components" id="toc-overthinking-prior-for-variance-components" class="nav-link" data-scroll-target="#overthinking-prior-for-variance-components"><span class="header-section-number">13.1.0.2</span> Overthinking: Prior for variance components</a></li>
  </ul></li>
  <li><a href="#varying-effects-and-the-underfittingoverfitting-trade-off" id="toc-varying-effects-and-the-underfittingoverfitting-trade-off" class="nav-link" data-scroll-target="#varying-effects-and-the-underfittingoverfitting-trade-off"><span class="header-section-number">13.2</span> Varying effects and the underfitting/overfitting trade-off</a>
  <ul>
  <li><a href="#the-model" id="toc-the-model" class="nav-link" data-scroll-target="#the-model"><span class="header-section-number">13.2.1</span> The model</a></li>
  <li><a href="#assign-values-to-the-parameters" id="toc-assign-values-to-the-parameters" class="nav-link" data-scroll-target="#assign-values-to-the-parameters"><span class="header-section-number">13.2.2</span> Assign values to the parameters</a></li>
  <li><a href="#sumulate-survivors" id="toc-sumulate-survivors" class="nav-link" data-scroll-target="#sumulate-survivors"><span class="header-section-number">13.2.3</span> Sumulate survivors</a></li>
  <li><a href="#compute-the-no-pooling-estimates" id="toc-compute-the-no-pooling-estimates" class="nav-link" data-scroll-target="#compute-the-no-pooling-estimates"><span class="header-section-number">13.2.4</span> Compute the no-pooling estimates</a></li>
  <li><a href="#compute-the-partial-pooling-estimates" id="toc-compute-the-partial-pooling-estimates" class="nav-link" data-scroll-target="#compute-the-partial-pooling-estimates"><span class="header-section-number">13.2.5</span> Compute the partial-pooling estimates</a>
  <ul>
  <li><a href="#overthinking-repeating-the-pond-simulation" id="toc-overthinking-repeating-the-pond-simulation" class="nav-link" data-scroll-target="#overthinking-repeating-the-pond-simulation"><span class="header-section-number">13.2.5.1</span> Overthinking: Repeating the pond simulation</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-More-than-one-type-of-cluster" id="toc-sec-More-than-one-type-of-cluster" class="nav-link" data-scroll-target="#sec-More-than-one-type-of-cluster"><span class="header-section-number">13.3</span> More than one type of cluster</a>
  <ul>
  <li><a href="#rethinking-cross-classification-and-hierarchy" id="toc-rethinking-cross-classification-and-hierarchy" class="nav-link" data-scroll-target="#rethinking-cross-classification-and-hierarchy"><span class="header-section-number">13.3.0.1</span> Rethinking: Cross-classification and hierarchy</a></li>
  <li><a href="#multilevel-chimpanzees" id="toc-multilevel-chimpanzees" class="nav-link" data-scroll-target="#multilevel-chimpanzees"><span class="header-section-number">13.3.1</span> Multilevel chimpanzees</a></li>
  <li><a href="#even-more-clusters" id="toc-even-more-clusters" class="nav-link" data-scroll-target="#even-more-clusters"><span class="header-section-number">13.3.2</span> Even more clusters</a></li>
  </ul></li>
  <li><a href="#sec-Divergent-transitions-and-non-centered-priors" id="toc-sec-Divergent-transitions-and-non-centered-priors" class="nav-link" data-scroll-target="#sec-Divergent-transitions-and-non-centered-priors"><span class="header-section-number">13.4</span> Divergent transitions and non-centered priors</a>
  <ul>
  <li><a href="#the-devils-funnel" id="toc-the-devils-funnel" class="nav-link" data-scroll-target="#the-devils-funnel"><span class="header-section-number">13.4.1</span> The Devil’s Funnel</a></li>
  <li><a href="#sec-Non-centered-chimpanzees" id="toc-sec-Non-centered-chimpanzees" class="nav-link" data-scroll-target="#sec-Non-centered-chimpanzees"><span class="header-section-number">13.4.2</span> Non-centered chimpanzees</a></li>
  </ul></li>
  <li><a href="#multilevel-posterior-predictions" id="toc-multilevel-posterior-predictions" class="nav-link" data-scroll-target="#multilevel-posterior-predictions"><span class="header-section-number">13.5</span> Multilevel posterior predictions</a>
  <ul>
  <li><a href="#posterior-prediction-for-same-clusters" id="toc-posterior-prediction-for-same-clusters" class="nav-link" data-scroll-target="#posterior-prediction-for-same-clusters"><span class="header-section-number">13.5.1</span> Posterior prediction for same clusters</a></li>
  <li><a href="#posterior-prediction-for-new-clusters" id="toc-posterior-prediction-for-new-clusters" class="nav-link" data-scroll-target="#posterior-prediction-for-new-clusters"><span class="header-section-number">13.5.2</span> Posterior prediction for new clusters</a>
  <ul>
  <li><a href="#sec-Lets-use-fitted-this-time" id="toc-sec-Lets-use-fitted-this-time" class="nav-link" data-scroll-target="#sec-Lets-use-fitted-this-time"><span class="header-section-number">13.5.2.1</span> Bonus: Let’s use <code>fitted()</code> this time</a></li>
  </ul></li>
  <li><a href="#sec-Post-stratification" id="toc-sec-Post-stratification" class="nav-link" data-scroll-target="#sec-Post-stratification"><span class="header-section-number">13.5.3</span> Post-stratification</a></li>
  </ul></li>
  <li><a href="#summary-bonus-post-stratification-in-an-example" id="toc-summary-bonus-post-stratification-in-an-example" class="nav-link" data-scroll-target="#summary-bonus-post-stratification-in-an-example"><span class="header-section-number">13.6</span> <del>Summary</del> Bonus: Post-stratification in an example</a>
  <ul>
  <li><a href="#meet-the-data" id="toc-meet-the-data" class="nav-link" data-scroll-target="#meet-the-data"><span class="header-section-number">13.6.1</span> Meet the data</a></li>
  <li><a href="#settle-the-mr-part-of-mrp" id="toc-settle-the-mr-part-of-mrp" class="nav-link" data-scroll-target="#settle-the-mr-part-of-mrp"><span class="header-section-number">13.6.2</span> Settle the MR part of MRP</a></li>
  <li><a href="#post-stratify-to-put-the-p-in-mrp" id="toc-post-stratify-to-put-the-p-in-mrp" class="nav-link" data-scroll-target="#post-stratify-to-put-the-p-in-mrp"><span class="header-section-number">13.6.3</span> Post-stratify to put the P in MRP</a>
  <ul>
  <li><a href="#estimates-by-age-group" id="toc-estimates-by-age-group" class="nav-link" data-scroll-target="#estimates-by-age-group"><span class="header-section-number">13.6.3.1</span> Estimates by age group</a></li>
  <li><a href="#estimates-by-us-state" id="toc-estimates-by-us-state" class="nav-link" data-scroll-target="#estimates-by-us-state"><span class="header-section-number">13.6.3.2</span> Estimates by US state</a></li>
  </ul></li>
  <li><a href="#wrap-this-mrp-up" id="toc-wrap-this-mrp-up" class="nav-link" data-scroll-target="#wrap-this-mrp-up"><span class="header-section-number">13.6.4</span> Wrap this MRP up</a></li>
  </ul></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  <li><a href="#comments" id="toc-comments" class="nav-link" data-scroll-target="#comments">Comments</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-Models-With-Memory" class="quarto-section-identifier"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Models With Memory</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<p><strong>Multilevel models</strong>… remember features of each cluster in the data as they learn about all of the clusters. Depending upon the variation among clusters, which is learned from the data as well, the model pools information across clusters. This pooling tends to improve estimates about each cluster. This improved estimation leads to several, more pragmatic sounding, benefits of the multilevel approach. <span class="citation" data-cites="mcelreathStatisticalRethinkingBayesian2020">(<a href="references.html#ref-mcelreathStatisticalRethinkingBayesian2020" role="doc-biblioref">McElreath, 2020, p. 400</a>, <strong>emphasis</strong> in the original)</span></p>
</blockquote>
<p>These benefits include:</p>
<ul>
<li>better estimates for repeated sampling (i.e., in longitudinal data),</li>
<li>better estimates when there are imbalances among subsamples,</li>
<li>estimates of the variation across subsamples, and</li>
<li>avoiding simplistic averaging by retaining variation across subsamples.</li>
</ul>
<blockquote class="blockquote">
<p>All of these benefits flow out of the same strategy and model structure. You learn one basic design and you get all of this for free.</p>
<p>When it comes to regression, multilevel regression deserves to be the default approach. There are certainly contexts in which it would be better to use an old-fashioned single-level model. But the contexts in which multilevel models are superior are much more numerous. It is better to begin to build a multilevel analysis, and then realize it’s unnecessary, than to overlook it. And once you grasp the basic multilevel strategy, it becomes much easier to incorporate related tricks such as allowing for measurement error in the data and even modeling missing data itself (<a href="15.html" class="quarto-xref"><span>Chapter 15</span></a>). (p.&nbsp;400)</p>
</blockquote>
<p>I’m totally on board with this. After learning about the multilevel model, I see it everywhere. For more on the sentiment it should be the default, check out McElreath’s blog post, <a href="https://elevanth.org/blog/2017/08/24/multilevel-regression-as-default/"><em>Multilevel regression as default</em></a>.</p>
<section id="example-multilevel-tadpoles" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="example-multilevel-tadpoles"><span class="header-section-number">13.1</span> Example: Multilevel tadpoles</h2>
<p>Let’s load the <code>reedfrogs</code> data <span class="citation" data-cites="voneshCompensatoryLarvalResponses2005">(see <a href="references.html#ref-voneshCompensatoryLarvalResponses2005" role="doc-biblioref">Vonesh &amp; Bolker, 2005</a>)</span> and fire up <strong>brms</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(reedfrogs, <span class="at">package =</span> <span class="st">"rethinking"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> reedfrogs</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(reedfrogs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Go ahead and acquaint yourself with the <code>reedfrogs</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 48
Columns: 5
$ density  &lt;int&gt; 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,…
$ pred     &lt;fct&gt; no, no, no, no, no, no, no, no, pred, pred, pred, pred, pred, pred, pred, pred, no, no, no, no, no, no, no, no,…
$ size     &lt;fct&gt; big, big, big, big, small, small, small, small, big, big, big, big, small, small, small, small, big, big, big, …
$ surv     &lt;int&gt; 9, 10, 7, 10, 9, 9, 10, 9, 4, 9, 7, 6, 7, 5, 9, 9, 24, 23, 22, 25, 23, 23, 23, 21, 6, 13, 4, 9, 13, 20, 8, 10, …
$ propsurv &lt;dbl&gt; 0.9000000, 1.0000000, 0.7000000, 1.0000000, 0.9000000, 0.9000000, 1.0000000, 0.9000000, 0.4000000, 0.9000000, 0…</code></pre>
</div>
</div>
<p>Making the <code>tank</code> cluster variable is easy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tank =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the formula for the un-pooled model in which each <code>tank</code> gets its own intercept:</p>
<p><span class="math display">\[\begin{align*}
\text{surv}_i             &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_{\text{tank}[i]} \\
\alpha_j                  &amp; \sim \operatorname{Normal} (0, 1.5) &amp; \text{for } j = 1, \dots, 48,
\end{align*}\]</span></p>
<p>where <span class="math inline">\(n_i\)</span> is indexed by the <code>density</code> column. Its values are distributed like so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(density)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  density  n
1      10 16
2      25 16
3      35 16</code></pre>
</div>
</div>
<p>Now fit this simple aggregated binomial model much like we practiced in <a href="11.html#sec-Chimpanzees-again-condensed" class="quarto-xref"><span>Section 11.1.3</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  surv <span class="sc">|</span> <span class="fu">trials</span>(density) <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">factor</span>(tank),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> b),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b13.01"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We don’t need a <code>depth=2</code> argument to discover we have 48 different intercepts. The default <code>print()</code> behavior will do.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b13<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: surv | trials(density) ~ 0 + factor(tank) 
   Data: d (Number of observations: 48) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
factortank1      1.72      0.75     0.36     3.28 1.00     6727     2922
factortank2      2.39      0.87     0.85     4.24 1.00     5009     2249
factortank3      0.75      0.63    -0.45     2.06 1.00     5975     2721
factortank4      2.41      0.90     0.84     4.40 1.00     5413     2712
factortank5      1.72      0.78     0.34     3.36 1.00     6346     2332
factortank6      1.73      0.75     0.36     3.39 1.00     5673     2882
factortank7      2.40      0.87     0.87     4.24 1.00     6013     2773
factortank8      1.71      0.76     0.32     3.29 1.00     5652     2920
factortank9     -0.37      0.61    -1.60     0.80 1.00     5643     2887
factortank10     1.70      0.75     0.39     3.31 1.00     6262     2260
factortank11     0.74      0.63    -0.46     2.05 1.00     6269     2696
factortank12     0.39      0.63    -0.82     1.64 1.00     5644     2858
factortank13     0.76      0.66    -0.46     2.12 1.00     5430     2848
factortank14     0.01      0.61    -1.16     1.22 1.00     6416     3038
factortank15     1.72      0.76     0.34     3.34 1.00     5830     2712
factortank16     1.72      0.78     0.36     3.42 1.00     5907     2726
factortank17     2.54      0.67     1.36     4.01 1.00     4795     2497
factortank18     2.14      0.61     1.05     3.44 1.00     6054     2619
factortank19     1.80      0.54     0.83     2.92 1.00     6042     3107
factortank20     3.09      0.79     1.72     4.82 1.00     5402     2768
factortank21     2.15      0.62     1.05     3.49 1.00     5870     2806
factortank22     2.14      0.57     1.12     3.36 1.00     5687     2898
factortank23     2.13      0.59     1.10     3.41 1.00     5338     3008
factortank24     1.55      0.51     0.61     2.60 1.00     6469     3086
factortank25    -1.11      0.45    -2.04    -0.26 1.00     5811     2806
factortank26     0.08      0.38    -0.65     0.81 1.00     5386     3054
factortank27    -1.54      0.49    -2.54    -0.63 1.00     5931     2981
factortank28    -0.55      0.40    -1.36     0.20 1.00     5774     2862
factortank29     0.07      0.40    -0.72     0.84 1.00     5880     2852
factortank30     1.32      0.48     0.44     2.30 1.00     5203     2097
factortank31    -0.72      0.42    -1.55     0.09 1.00     7194     3016
factortank32    -0.39      0.42    -1.23     0.40 1.00     5849     2924
factortank33     2.85      0.67     1.71     4.33 1.00     5415     2328
factortank34     2.47      0.59     1.42     3.76 1.00     5835     2769
factortank35     2.46      0.57     1.46     3.68 1.00     5369     2660
factortank36     1.91      0.49     1.02     2.97 1.00     6166     2748
factortank37     1.91      0.49     1.00     2.93 1.00     6123     2860
factortank38     3.37      0.77     2.05     5.04 1.00     5313     2355
factortank39     2.46      0.58     1.43     3.72 1.00     6008     2835
factortank40     2.16      0.53     1.21     3.32 1.00     5945     2463
factortank41    -1.91      0.49    -2.95    -1.02 1.00     6293     2323
factortank42    -0.63      0.35    -1.32     0.04 1.00     6646     3016
factortank43    -0.51      0.34    -1.19     0.16 1.00     5326     3035
factortank44    -0.39      0.33    -1.05     0.24 1.00     6226     3190
factortank45     0.52      0.35    -0.15     1.22 1.00     7301     2643
factortank46    -0.63      0.35    -1.34     0.04 1.00     5798     2948
factortank47     1.91      0.49     1.03     2.91 1.00     5941     2893
factortank48    -0.07      0.34    -0.74     0.59 1.00     7503     2958

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>This is much like the models we’ve fit in earlier chapters using McElreath’s index approach, but on steroids. It’ll be instructive to take a look at distribution of the <span class="math inline">\(\alpha_j\)</span> parameters in density plots. We’ll plot them in both their log-odds and probability metrics.</p>
<p>For kicks and giggles, let’s use a <a href="https://github.com/alex23lemm/theme_fivethirtyeight">FiveThirtyEight-like theme</a> for this chapter’s plots. An easy way to do so is with help from the <a href="https://cran.r-project.org/package=ggthemes"><strong>ggthemes</strong> package</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggthemes) </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Change the default</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_gray</span>() <span class="sc">+</span> <span class="fu">theme_fivethirtyeight</span>())</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">estimate =</span> <span class="fu">fixef</span>(b13<span class="fl">.1</span>)[, <span class="dv">1</span>]) <span class="sc">|&gt;</span> </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">plogis</span>(estimate)) <span class="sc">|&gt;</span> </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(estimate<span class="sc">:</span>p) <span class="sc">|&gt;</span> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">if_else</span>(name <span class="sc">==</span> <span class="st">"p"</span>, <span class="st">"expected survival probability"</span>, <span class="st">"expected survival log-odds"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_dots</span>(<span class="at">size =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"orange1"</span>, <span class="st">"orange4"</span>)) <span class="sc">+</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Tank-level intercepts from the no-pooling model"</span>,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Notice how inspecting the distributions of the posterior means can offer insights you</span><span class="sc">\n</span><span class="st">might not get if you looked at them one at a time."</span>) <span class="sc">+</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Even though it seems like we can derive important insights from how the <code>tank</code>-level intercepts are distributed, that information is not explicitly encoded in the statistical model. Keep that in mind as we now consider the multilevel alternative. Its formula is</p>
<p><span class="math display">\[\begin{align*}
\text{surv}_i             &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_{\text{tank}[i]} \\
\alpha_j                  &amp; \sim \operatorname{Normal}(\color{#CD8500}{\bar \alpha}, \color{#CD8500} \sigma) \\
\color{#CD8500}{\bar \alpha} &amp; \color{#CD8500} \sim \color{#CD8500}{\operatorname{Normal}(0, 1.5)} \\
\color{#CD8500} \sigma       &amp; \color{#CD8500} \sim \color{#CD8500}{\operatorname{Exponential}(1)},
\end{align*}\]</span></p>
<p>where</p>
<blockquote class="blockquote">
<p>the prior for the tank intercepts is now a function of two parameters, <span class="math inline">\(\bar \alpha\)</span> and <span class="math inline">\(\sigma\)</span>. You can say <span class="math inline">\(\bar \alpha\)</span> like “bar alpha.” The bar means average. These two parameters inside the prior is where the “multi” in multilevel arises. The Gaussian distribution with mean <span class="math inline">\(\bar \alpha\)</span> standard deviation <span class="math inline">\(\sigma\)</span> is the prior for each tank’s intercept. But that prior itself has priors for <span class="math inline">\(\bar \alpha\)</span> and <span class="math inline">\(\sigma\)</span>. So there are two levels in the model, each resembling a simpler model. (p.&nbsp;403, <em>emphasis</em> in the original)</p>
</blockquote>
<p>With <strong>brms</strong>, you might specify the corresponding multilevel model like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  surv <span class="sc">|</span> <span class="fu">trials</span>(density) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> tank),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> Intercept),  <span class="co"># alpha bar</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sd)),        <span class="co"># sigma</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">5000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_prior =</span> <span class="st">"yes"</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b13.02"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The syntax for the varying effects follows the <a href="https://cran.r-project.org/package=brms/vignettes/brms_overview.pdf"><strong>lme4</strong> style</a>, <code>( &lt;varying parameter(s)&gt; | &lt;grouping variable(s)&gt; )</code>. In this case <code>(1 | tank)</code> indicates only the intercept, <code>1</code>, varies by <code>tank</code>. The extent to which parameters vary is controlled by the prior, <code>prior(exponential(1), class = sd)</code>, which is <u>parameterized in the standard deviation metric</u>. Do note that last part. It’s common in multilevel software to model in the variance metric, instead. For technical reasons we won’t really get into until <a href="14.html" class="quarto-xref"><span>Chapter 14</span></a>, Stan parameterizes this as a standard deviation.</p>
<p>Let’s compute the WAIC comparisons.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(b13<span class="fl">.1</span>, <span class="at">criterion =</span> <span class="st">"waic"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(b13<span class="fl">.2</span>, <span class="at">criterion =</span> <span class="st">"waic"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">loo_compare</span>(b13<span class="fl">.1</span>, b13<span class="fl">.2</span>, <span class="at">criterion =</span> <span class="st">"waic"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(w, <span class="at">simplify =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
b13.2    0.0       0.0  -100.1       3.7         20.9    0.8     200.1    7.4 
b13.1   -6.9       1.8  -107.0       2.3         25.3    1.2     214.0    4.7 </code></pre>
</div>
</div>
<p>The <code>se_diff</code> is small relative to the <code>elpd_diff</code>. If we convert the <span class="math inline">\(\text{elpd}\)</span> difference to the WAIC metric, the message stays the same.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">waic_diff =</span> w[, <span class="dv">1</span>] <span class="sc">*</span> <span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">se        =</span> w[, <span class="dv">2</span>] <span class="sc">*</span>  <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      waic_diff       se
b13.2   0.00000 0.000000
b13.1  13.89515 3.601405</code></pre>
</div>
</div>
<p>Here are the WAIC weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">model_weights</span>(b13<span class="fl">.1</span>, b13<span class="fl">.2</span>, <span class="at">weights =</span> <span class="st">"waic"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>b13.1 b13.2 
    0     1 </code></pre>
</div>
</div>
<p>I’m not going to show it here, but if you’d like a challenge, try comparing the models with the PSIS-LOO. You’ll get some great practice with high <code>pareto_k</code> values and the moment matching for problematic observations <span class="citation" data-cites="paananenMomentMatching2020 paananenImplicitlyAdaptiveImportance2020">(<a href="references.html#ref-paananenImplicitlyAdaptiveImportance2020" role="doc-biblioref">Paananen, Piironen, et al., 2020</a>; see <a href="references.html#ref-paananenMomentMatching2020" role="doc-biblioref">Paananen, Bürkner, et al., 2020</a>)</span>.</p>
<p>But back on track, McElreath commented on the number of effective parameters for the two models. This, recall, is listed in the column for <span class="math inline">\(p_\text{WAIC}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>w[, <span class="st">"p_waic"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   b13.2    b13.1 
20.94163 25.26743 </code></pre>
</div>
</div>
<p>And indeed, even though our multilevel model (<code>b13.2</code>) technically had two more parameters than the conventional single-level model (<code>b13.1</code>), its <span class="math inline">\(p_\text{WAIC}\)</span> is substantially smaller, due to the regularizing level-2 <span class="math inline">\(\sigma\)</span> parameter. Speaking of which, let’s examine the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b13<span class="fl">.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: surv | trials(density) ~ 1 + (1 | tank) 
   Data: d (Number of observations: 48) 
  Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
         total post-warmup draws = 16000

Multilevel Hyperparameters:
~tank (Number of levels: 48) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.62      0.21     1.26     2.08 1.00     4231     7747

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     1.35      0.26     0.85     1.87 1.00     2380     4074

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>This time we don’t get a list of 48 separate <code>tank</code>-level parameters. However, we do get a description of their distribution in terms of <span class="math inline">\(\bar \alpha\)</span> (i.e., <code>Intercept</code>) and <span class="math inline">\(\sigma\)</span> (i.e., <code>sd(Intercept)</code>). If you’d like the actual <code>tank</code>-level parameters, don’t worry; they’re coming in Figure 13.1. We’ll need to do a little prep work, though.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b13<span class="fl">.2</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>post_mdn <span class="ot">&lt;-</span> <span class="fu">coef</span>(b13<span class="fl">.2</span>, <span class="at">robust =</span> T)<span class="sc">$</span>tank[, , ] <span class="sc">|&gt;</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(d) <span class="sc">|&gt;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">post_mdn =</span> <span class="fu">plogis</span>(Estimate))</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(post_mdn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Estimate Est.Error       Q2.5    Q97.5 density pred  size surv propsurv tank  post_mdn
1 2.0845608 0.8526477  0.6141390 4.061139      10   no   big    9      0.9    1 0.8893935
2 2.9897777 1.0718215  1.1857960 5.561650      10   no   big   10      1.0    2 0.9521102
3 0.9711338 0.6601700 -0.2474613 2.384460      10   no   big    7      0.7    3 0.7253454
4 2.9724097 1.0907821  1.1761693 5.561312      10   no   big   10      1.0    4 0.9513120
5 2.0781692 0.8624828  0.5942470 4.053401      10   no small    9      0.9    5 0.8887632
6 2.0778971 0.8486711  0.5925602 4.056686      10   no small    9      0.9    6 0.8887363</code></pre>
</div>
</div>
<p>Here’s the <strong>ggplot2</strong> code to reproduce Figure 13.1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>post_mdn <span class="sc">|&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> tank)) <span class="sc">+</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">plogis</span>(<span class="fu">median</span>(post<span class="sc">$</span>b_Intercept)), <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="fl">16.5</span>, <span class="fl">32.5</span>), <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">color =</span> <span class="st">"grey25"</span>) <span class="sc">+</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> propsurv), <span class="at">color =</span> <span class="st">"orange2"</span>) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> post_mdn), <span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">16</span> <span class="sc">+</span> <span class="dv">8</span>, <span class="dv">32</span> <span class="sc">+</span> <span class="dv">8</span>), <span class="at">y =</span> <span class="dv">0</span>, </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">c</span>(<span class="st">"small tanks"</span>, <span class="st">"medium tanks"</span>, <span class="st">"large tanks"</span>)) <span class="sc">+</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">16</span>, <span class="dv">32</span>, <span class="dv">48</span>)) <span class="sc">+</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span> <span class="sc">/</span> <span class="dv">5</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Multilevel shrinkage!"</span>,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"The empirical proportions are in orange while the model-</span><span class="sc">\n</span><span class="st">implied proportions are the black circles. The dashed line is</span><span class="sc">\n</span><span class="st">the model-implied average survival proportion."</span>) <span class="sc">+</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Here is the code for our version of Figure 13.2.a, where we visualize the model-implied population distribution of log-odds survival (i.e., the population distribution yielding all the <code>tank</code>-level intercepts).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This makes the output of `slice_sample()` reproducible</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> post <span class="sc">|&gt;</span> </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="dv">4</span>, <span class="at">to =</span> <span class="dv">5</span>, <span class="at">length.out =</span> <span class="dv">100</span>)) <span class="sc">|&gt;</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density =</span> <span class="fu">dnorm</span>(x, <span class="at">mean =</span> b_Intercept, <span class="at">sd =</span> sd_tank__Intercept)) <span class="sc">|&gt;</span> </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density, <span class="at">group =</span> .draw)) <span class="sc">+</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="st">"orange2"</span>) <span class="sc">+</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Population survival distribution"</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"log-odds scale"</span>) <span class="sc">+</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we make our Figure 13.2.b and then bind the two subplots with <strong>patchwork</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> post <span class="sc">|&gt;</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">8000</span>, <span class="at">replace =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sim_tanks =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="at">mean =</span> b_Intercept, <span class="at">sd =</span> sd_tank__Intercept)) <span class="sc">|&gt;</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">plogis</span>(sim_tanks))) <span class="sc">+</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">linewidth =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"orange2"</span>, <span class="at">adjust =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Probability of survival"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"transformed by the inverse-logit function"</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2) <span class="sc">&amp;</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Both plots show different ways of expressing the model uncertainty in terms of both location <span class="math inline">\(\alpha\)</span> and scale <span class="math inline">\(\sigma\)</span>.</p>
<section id="rethinking-varying-intercepts-as-over-dispersion" class="level4" data-number="13.1.0.1">
<h4 data-number="13.1.0.1" class="anchored" data-anchor-id="rethinking-varying-intercepts-as-over-dispersion"><span class="header-section-number">13.1.0.1</span> Rethinking: Varying intercepts as over-dispersion</h4>
<blockquote class="blockquote">
<p>In the previous chapter (<a href="12.html#sec-Over-dispersed-counts" class="quarto-xref"><span>Section 12.1</span></a>), the beta-binomial and gamma-Poisson models were presented as ways for coping with <strong>over-dispersion</strong> of count data. Varying intercepts accomplish the same thing, allowing count outcomes to be over-dispersed. They accomplish this, because when each observed count gets its own unique intercept, but these intercepts are pooled through a common distribution, the predictions expect over-dispersion just like a beta-binomial or gamma-Poisson model would. Multilevel models are also mixtures. Compared to a beta-binomial or gamma-Poisson model, a binomial or Poisson model with a varying intercept on every observed outcome will often be easier to estimate and easier to extend. (p.&nbsp;407, <strong>emphasis</strong> in the original)</p>
</blockquote>
</section>
<section id="overthinking-prior-for-variance-components" class="level4" data-number="13.1.0.2">
<h4 data-number="13.1.0.2" class="anchored" data-anchor-id="overthinking-prior-for-variance-components"><span class="header-section-number">13.1.0.2</span> Overthinking: Prior for variance components</h4>
<p>Yep, you can use the half-Normal distribution for your priors in <strong>brms</strong>, too. Here it is for model <code>b13.2</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.2</span>b <span class="ot">&lt;-</span> <span class="fu">update</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  b13<span class="fl">.2</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> sd)),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">5000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_prior =</span> <span class="st">"yes"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b13.02b"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>McElreath mentioned how one might set a lower bound at zero for the half-Normal prior when using <code>rethinking::ulam()</code>. There’s no need to do so when using <code>brms::brm()</code>. The lower bounds for priors of <code>class = sd</code> are already set to zero by default.</p>
<p>Check the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b13<span class="fl">.2</span>b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: surv | trials(density) ~ 1 + (1 | tank) 
   Data: d (Number of observations: 48) 
  Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
         total post-warmup draws = 16000

Multilevel Hyperparameters:
~tank (Number of levels: 48) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.59      0.20     1.24     2.03 1.00     4568     8722

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     1.35      0.25     0.87     1.84 1.00     3673     6410

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>If you’re curious how the exponential and half-Normal priors compare to one another and to their posteriors, you might just plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For annotation</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">value        =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">2.4</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">density      =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">1.85</span>),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">distribution =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>), <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>)),</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior        =</span> <span class="st">"Exponential(1)"</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Gather up and wrangle the prior and posterior draws</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="st">`</span><span class="at">prior_Exponential(1)</span><span class="st">`</span>        <span class="ot">=</span> <span class="fu">prior_draws</span>(b13<span class="fl">.2</span>)  <span class="sc">|&gt;</span> <span class="fu">pull</span>(sd_tank),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>       <span class="st">`</span><span class="at">posterior_Exponential(1)</span><span class="st">`</span>    <span class="ot">=</span> <span class="fu">as_draws_df</span>(b13<span class="fl">.2</span>)  <span class="sc">|&gt;</span> <span class="fu">pull</span>(sd_tank__Intercept),</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>       <span class="st">`</span><span class="at">prior_Half-Normal(0, 1)</span><span class="st">`</span>     <span class="ot">=</span> <span class="fu">prior_draws</span>(b13<span class="fl">.2</span>b) <span class="sc">|&gt;</span> <span class="fu">pull</span>(sd_tank),</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>       <span class="st">`</span><span class="at">posterior_Half-Normal(0, 1)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as_draws_df</span>(b13<span class="fl">.2</span>b) <span class="sc">|&gt;</span> <span class="fu">pull</span>(sd_tank__Intercept)) <span class="sc">|&gt;</span> </span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(),</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"distribution"</span>, <span class="st">"prior"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">distribution =</span> <span class="fu">factor</span>(distribution, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> distribution)) <span class="sc">+</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">linewidth =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">adjust =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> text,</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> density, <span class="at">label =</span> distribution, <span class="at">color =</span> distribution)) <span class="sc">+</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="cn">NULL</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"orange4"</span>, <span class="st">"orange2"</span>)) <span class="sc">+</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="cn">NULL</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"orange4"</span>, <span class="st">"orange2"</span>)) <span class="sc">+</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="fu">expression</span>(Hierarchical<span class="sc">~</span>sigma<span class="sc">~</span>parameter)) <span class="sc">+</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> prior) <span class="sc">+</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="528"></p>
</figure>
</div>
</div>
</div>
<p>By the way, this is why we set <code>iter = 5000</code> and <code>sample_prior = "yes"</code> for the last two models. Neither were necessary to fit the models, but both helped us out with this plot.</p>
</section>
</section>
<section id="varying-effects-and-the-underfittingoverfitting-trade-off" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="varying-effects-and-the-underfittingoverfitting-trade-off"><span class="header-section-number">13.2</span> Varying effects and the underfitting/overfitting trade-off</h2>
<blockquote class="blockquote">
<p>Varying intercepts are just regularized estimates, but adaptively regularized by estimating how diverse the clusters are while estimating the features of each cluster. This fact is not easy to grasp….</p>
<p>A major benefit of using varying effects estimates, instead of the empirical raw estimates, is that they provide more accurate estimates of the individual cluster (tank) intercepts. On average, the varying effects actually provide a better estimate of the individual tank (cluster) means. The reason that the varying intercepts provide better estimates is that they do a better job of trading off underfitting and overfitting. (p.&nbsp;408)</p>
</blockquote>
<p>In this section, we explicate this by contrasting three perspectives:</p>
<ul>
<li>complete pooling (i.e., a single-<span class="math inline">\(\alpha\)</span> model),</li>
<li>no pooling (i.e., the single-level <span class="math inline">\(\alpha_{\text{tank}[i]}\)</span> model), and</li>
<li>partial pooling [i.e., the multilevel model for which <span class="math inline">\(\alpha_j \sim \operatorname{Normal} (\bar \alpha, \sigma)\)</span>].</li>
</ul>
<blockquote class="blockquote">
<p>To demonstrate [the magic of the multilevel model], we’ll simulate some tadpole data. That way, we’ll know the true per-pond survival probabilities. Then we can compare the no-pooling estimates to the partial pooling estimates, by computing how close each gets to the true values they are trying to estimate. The rest of this section shows how to do such a simulation. (p.&nbsp;409)</p>
</blockquote>
<section id="the-model" class="level3" data-number="13.2.1">
<h3 data-number="13.2.1" class="anchored" data-anchor-id="the-model"><span class="header-section-number">13.2.1</span> The model</h3>
<p>The simulation formula should look familiar.</p>
<p><span class="math display">\[\begin{align*}
\text{surv}_i &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_{\text{pond}[i]} \\
\alpha_j                  &amp; \sim \operatorname{Normal}(\bar \alpha, \sigma) \\
\bar \alpha               &amp; \sim \operatorname{Normal}(0, 1.5) \\
\sigma                    &amp; \sim \operatorname{Exponential}(1)
\end{align*}\]</span></p>
</section>
<section id="assign-values-to-the-parameters" class="level3" data-number="13.2.2">
<h3 data-number="13.2.2" class="anchored" data-anchor-id="assign-values-to-the-parameters"><span class="header-section-number">13.2.2</span> Assign values to the parameters</h3>
<p>Here we follow along with McElreath and “assign specific values representative of the actual tadpole data” (p.&nbsp;409). Because he included a <code>set.seed()</code> line in his <strong>R</strong> code 13.8, our results should match his exactly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>a_bar   <span class="ot">&lt;-</span>  <span class="fl">1.5</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>sigma   <span class="ot">&lt;-</span>  <span class="fl">1.5</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>n_ponds <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5005</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>dsim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pond   =</span> <span class="dv">1</span><span class="sc">:</span>n_ponds,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">ni     =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">35</span>), <span class="at">each =</span> n_ponds <span class="sc">/</span> <span class="dv">4</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>(),</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">true_a =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_ponds, <span class="at">mean =</span> a_bar, <span class="at">sd =</span> sigma))</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dsim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
   pond    ni true_a
  &lt;int&gt; &lt;int&gt;  &lt;dbl&gt;
1     1     5  0.567
2     2     5  1.99 
3     3     5 -0.138
4     4     5  1.86 
5     5     5  3.91 
6     6     5  1.95 </code></pre>
</div>
</div>
<p>McElreath twice urged us to inspect the contents of this simulation. In addition to looking at the data with <code>head()</code>, we might well plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>dsim <span class="sc">|&gt;</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ni =</span> <span class="fu">factor</span>(ni)) <span class="sc">|&gt;</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> true_a, <span class="at">y =</span> ni)) <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_dotsinterval</span>(<span class="at">fill =</span> <span class="st">"orange2"</span>, <span class="at">slab_size =</span> <span class="dv">0</span>, <span class="at">.width =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Log-odds varying by # tadpoles per pond"</span>) <span class="sc">+</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sumulate-survivors" class="level3" data-number="13.2.3">
<h3 data-number="13.2.3" class="anchored" data-anchor-id="sumulate-survivors"><span class="header-section-number">13.2.3</span> Sumulate survivors</h3>
<blockquote class="blockquote">
<p>Each pond <span class="math inline">\(i\)</span> has <span class="math inline">\(n_i\)</span> potential survivors, and nature flips each tadpole’s coin, so to speak, with probability of survival <span class="math inline">\(p_i\)</span>. This probability <span class="math inline">\(p_i\)</span> is implied by the model definition, and is equal to:</p>
<p><span class="math display">\[p_i = \frac{\exp (\alpha_i)}{1 + \exp (\alpha_i)}\]</span></p>
<p>The model uses a logit link, and so the probability is defined by the [<code>plogis()</code>] function. (p.&nbsp;411)</p>
</blockquote>
<p>Although McElreath shared his <code>set.seed()</code> number in the last section, he didn’t share it for this bit. We’ll go ahead and carry over the one from last time. However, in a moment we’ll see this clearly wasn’t the one he used here. As a consequence, our results will deviate a bit from his.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5005</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>dsim <span class="ot">&lt;-</span> dsim <span class="sc">|&gt;</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">si =</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">prob =</span> <span class="fu">plogis</span>(true_a), <span class="at">size =</span> ni))</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>dsim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 60 × 4
    pond    ni true_a    si
   &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;int&gt;
 1     1     5  0.567     4
 2     2     5  1.99      4
 3     3     5 -0.138     3
 4     4     5  1.86      5
 5     5     5  3.91      5
 6     6     5  1.95      4
 7     7     5  1.49      4
 8     8     5  2.52      4
 9     9     5  2.18      3
10    10     5  2.05      4
# ℹ 50 more rows</code></pre>
</div>
</div>
</section>
<section id="compute-the-no-pooling-estimates" class="level3" data-number="13.2.4">
<h3 data-number="13.2.4" class="anchored" data-anchor-id="compute-the-no-pooling-estimates"><span class="header-section-number">13.2.4</span> Compute the no-pooling estimates</h3>
<p>The no-pooling estimates (i.e., <span class="math inline">\(\alpha_{\text{tank}[i]}\)</span>) are the results of simple algebra.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>dsim <span class="ot">&lt;-</span> dsim <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_nopool =</span> si <span class="sc">/</span> ni)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>dsim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 60 × 5
    pond    ni true_a    si p_nopool
   &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt;
 1     1     5  0.567     4      0.8
 2     2     5  1.99      4      0.8
 3     3     5 -0.138     3      0.6
 4     4     5  1.86      5      1  
 5     5     5  3.91      5      1  
 6     6     5  1.95      4      0.8
 7     7     5  1.49      4      0.8
 8     8     5  2.52      4      0.8
 9     9     5  2.18      3      0.6
10    10     5  2.05      4      0.8
# ℹ 50 more rows</code></pre>
</div>
</div>
<p>“These are the same no-pooling estimates you’d get by fitting a model with a dummy variable for each pond and flat priors that induce no regularization” (p.&nbsp;411). That is, these are the same kinds of estimates we got back when we fit <code>b13.1</code>.</p>
</section>
<section id="compute-the-partial-pooling-estimates" class="level3" data-number="13.2.5">
<h3 data-number="13.2.5" class="anchored" data-anchor-id="compute-the-partial-pooling-estimates"><span class="header-section-number">13.2.5</span> Compute the partial-pooling estimates</h3>
<p>Fit the multilevel (partial-pooling) model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dsim, </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  si <span class="sc">|</span> <span class="fu">trials</span>(ni) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> pond),</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sd)),</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b13.03"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s our standard <strong>brms</strong> summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b13<span class="fl">.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: si | trials(ni) ~ 1 + (1 | pond) 
   Data: dsim (Number of observations: 60) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~pond (Number of levels: 60) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.50      0.20     1.15     1.93 1.00     1401     2469

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     1.48      0.23     1.05     1.95 1.00     1076     2151

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>I’m not aware that you can use McElreath’s <code>depth=2</code> trick in <strong>brms</strong> for <code>summary()</code> or <code>print()</code>. However, you can get most of that information and more with the Stan-like summary using the <code>$fit</code> syntax.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.3</span><span class="sc">$</span>fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

                        mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
b_Intercept             1.48    0.01 0.23    1.05    1.32    1.47    1.63    1.95  1076 1.00
sd_pond__Intercept      1.50    0.01 0.20    1.15    1.36    1.48    1.62    1.93  1357 1.01
Intercept               1.48    0.01 0.23    1.05    1.32    1.47    1.63    1.95  1076 1.00
r_pond[1,Intercept]     0.09    0.01 0.94   -1.66   -0.54    0.05    0.71    2.05  6629 1.00
r_pond[2,Intercept]     0.09    0.01 0.94   -1.60   -0.56    0.03    0.70    2.07  7378 1.00
r_pond[3,Intercept]    -0.70    0.01 0.88   -2.39   -1.27   -0.73   -0.14    1.12  7412 1.00
r_pond[4,Intercept]     1.13    0.01 1.09   -0.79    0.35    1.07    1.81    3.54  6255 1.00
r_pond[5,Intercept]     1.14    0.01 1.15   -0.86    0.36    1.03    1.86    3.66  7031 1.00
r_pond[6,Intercept]     0.08    0.01 0.95   -1.65   -0.57    0.05    0.66    2.10  6449 1.00
r_pond[7,Intercept]     0.11    0.01 0.97   -1.68   -0.55    0.06    0.71    2.16  5907 1.00
r_pond[8,Intercept]     0.09    0.01 0.95   -1.61   -0.58    0.06    0.73    1.99  5613 1.00
r_pond[9,Intercept]    -0.68    0.01 0.86   -2.32   -1.24   -0.70   -0.13    1.12  5743 1.00
r_pond[10,Intercept]    0.09    0.01 0.94   -1.63   -0.55    0.06    0.67    2.12  7382 1.00
r_pond[11,Intercept]    1.13    0.01 1.15   -0.86    0.31    1.03    1.85    3.59  5931 1.00
r_pond[12,Intercept]   -1.36    0.01 0.84   -3.01   -1.91   -1.37   -0.82    0.27  7206 1.00
r_pond[13,Intercept]    1.14    0.01 1.14   -0.86    0.35    1.06    1.89    3.47  6121 1.00
r_pond[14,Intercept]    0.08    0.01 0.93   -1.62   -0.56    0.03    0.66    2.01  6706 1.00
r_pond[15,Intercept]    1.12    0.01 1.14   -0.91    0.31    1.07    1.85    3.51  7435 1.00
r_pond[16,Intercept]   -0.85    0.01 0.64   -2.05   -1.29   -0.87   -0.43    0.47  4031 1.00
r_pond[17,Intercept]   -1.97    0.01 0.66   -3.37   -2.40   -1.95   -1.53   -0.68  5017 1.00
r_pond[18,Intercept]   -1.23    0.01 0.64   -2.47   -1.66   -1.22   -0.79    0.06  4629 1.00
r_pond[19,Intercept]   -1.24    0.01 0.66   -2.56   -1.68   -1.24   -0.79    0.05  5152 1.00
r_pond[20,Intercept]   -0.43    0.01 0.70   -1.77   -0.91   -0.45    0.00    1.01  5574 1.00
r_pond[21,Intercept]   -1.59    0.01 0.63   -2.84   -2.01   -1.58   -1.17   -0.34  4659 1.00
r_pond[22,Intercept]    0.66    0.01 0.86   -0.88    0.07    0.60    1.18    2.55  5591 1.00
r_pond[23,Intercept]    1.54    0.01 1.08   -0.38    0.77    1.44    2.20    4.02  5819 1.00
r_pond[24,Intercept]   -0.85    0.01 0.65   -2.09   -1.29   -0.87   -0.44    0.48  4425 1.00
r_pond[25,Intercept]    0.03    0.01 0.73   -1.27   -0.46    0.01    0.49    1.58  5744 1.00
r_pond[26,Intercept]    0.66    0.01 0.86   -0.90    0.07    0.62    1.21    2.48  6059 1.00
r_pond[27,Intercept]    0.04    0.01 0.77   -1.39   -0.48    0.01    0.52    1.65  5419 1.00
r_pond[28,Intercept]   -0.44    0.01 0.70   -1.72   -0.93   -0.46    0.03    0.96  5242 1.00
r_pond[29,Intercept]   -0.84    0.01 0.64   -2.08   -1.28   -0.86   -0.43    0.44  5404 1.00
r_pond[30,Intercept]   -0.43    0.01 0.71   -1.75   -0.91   -0.44    0.04    0.97  4563 1.00
r_pond[31,Intercept]    1.41    0.01 0.82   -0.02    0.83    1.36    1.90    3.22  5761 1.00
r_pond[32,Intercept]    0.54    0.01 0.61   -0.59    0.12    0.51    0.91    1.80  4727 1.00
r_pond[33,Intercept]    1.40    0.01 0.75    0.05    0.86    1.35    1.89    3.00  4635 1.00
r_pond[34,Intercept]   -0.45    0.01 0.50   -1.43   -0.78   -0.45   -0.12    0.54  3287 1.00
r_pond[35,Intercept]   -0.98    0.01 0.46   -1.87   -1.28   -0.97   -0.68   -0.08  2724 1.00
r_pond[36,Intercept]    2.12    0.01 0.99    0.47    1.42    2.03    2.70    4.34  4609 1.00
r_pond[37,Intercept]   -3.38    0.01 0.61   -4.68   -3.75   -3.34   -2.96   -2.28  3598 1.00
r_pond[38,Intercept]   -2.08    0.01 0.47   -3.03   -2.38   -2.08   -1.76   -1.14  3120 1.00
r_pond[39,Intercept]   -0.98    0.01 0.47   -1.87   -1.30   -0.98   -0.67   -0.03  3074 1.00
r_pond[40,Intercept]    2.09    0.01 0.94    0.47    1.46    2.00    2.67    4.14  5770 1.00
r_pond[41,Intercept]    2.10    0.01 0.95    0.51    1.43    2.00    2.68    4.20  4919 1.00
r_pond[42,Intercept]    0.54    0.01 0.61   -0.55    0.11    0.50    0.93    1.84  3953 1.00
r_pond[43,Intercept]   -1.75    0.01 0.46   -2.66   -2.06   -1.74   -1.45   -0.88  2981 1.00
r_pond[44,Intercept]   -0.63    0.01 0.47   -1.52   -0.97   -0.64   -0.31    0.31  2922 1.00
r_pond[45,Intercept]   -2.63    0.01 0.51   -3.69   -2.95   -2.60   -2.29   -1.70  3416 1.00
r_pond[46,Intercept]   -1.44    0.01 0.40   -2.23   -1.71   -1.44   -1.18   -0.66  2546 1.00
r_pond[47,Intercept]    2.32    0.01 0.92    0.75    1.69    2.23    2.88    4.42  4424 1.00
r_pond[48,Intercept]    2.33    0.01 0.92    0.77    1.71    2.24    2.87    4.39  4950 1.00
r_pond[49,Intercept]    0.14    0.01 0.50   -0.81   -0.20    0.13    0.46    1.14  3564 1.00
r_pond[50,Intercept]    0.14    0.01 0.49   -0.78   -0.19    0.12    0.45    1.14  3190 1.00
r_pond[51,Intercept]    0.14    0.01 0.48   -0.76   -0.18    0.14    0.47    1.11  3041 1.00
r_pond[52,Intercept]   -1.45    0.01 0.40   -2.24   -1.72   -1.45   -1.18   -0.67  2401 1.00
r_pond[53,Intercept]    0.14    0.01 0.48   -0.77   -0.18    0.12    0.46    1.12  3074 1.00
r_pond[54,Intercept]    2.31    0.01 0.90    0.77    1.69    2.23    2.84    4.32  5291 1.00
r_pond[55,Intercept]   -0.88    0.01 0.42   -1.68   -1.16   -0.88   -0.61   -0.07  2819 1.00
r_pond[56,Intercept]    1.69    0.01 0.76    0.31    1.17    1.63    2.15    3.28  4509 1.00
r_pond[57,Intercept]   -0.77    0.01 0.43   -1.61   -1.05   -0.77   -0.48    0.08  2568 1.00
r_pond[58,Intercept]    1.20    0.01 0.64    0.07    0.74    1.18    1.62    2.57  5191 1.00
r_pond[59,Intercept]    0.35    0.01 0.50   -0.60    0.01    0.33    0.68    1.35  3766 1.00
r_pond[60,Intercept]    1.21    0.01 0.65    0.03    0.75    1.17    1.63    2.60  4938 1.00
lprior                 -3.32    0.01 0.28   -3.93   -3.48   -3.30   -3.13   -2.85  1361 1.00
lp__                 -185.98    0.25 7.55 -202.04 -190.92 -185.50 -180.69 -172.22   908 1.00

Samples were drawn using NUTS(diag_e) at Fri Jan  9 13:10:10 2026.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>As an aside, notice how this summary still reports the old-style <code>n_eff</code> values, rather than the updated <code>Bulk_ESS</code> and <code>Tail_ESS</code> values. I suspect this will change sometime soon. In the meantime, here’s a <a href="https://discourse.mc-stan.org/t/new-r-hat-and-ess/8165">thread on the Stan Forums</a> featuring members of the Stan team discussing how.</p>
<p>Let’s get ready for the diagnostic plot of Figure 13.3. First we add the partially-pooled estimates, as summarized by their posterior means, to the <code>dsim</code> data. Then we compute error values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We could have included this step in the block of code below, if we wanted to</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>p_partpool <span class="ot">&lt;-</span> <span class="fu">coef</span>(b13<span class="fl">.3</span>)<span class="sc">$</span>pond[, , ] <span class="sc">|&gt;</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">p_partpool =</span> <span class="fu">plogis</span>(Estimate))</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>dsim <span class="ot">&lt;-</span> dsim <span class="sc">|&gt;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(p_partpool) <span class="sc">|&gt;</span> </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_true =</span> <span class="fu">plogis</span>(true_a)) <span class="sc">|&gt;</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nopool_error   =</span> <span class="fu">abs</span>(p_nopool   <span class="sc">-</span> p_true),</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">partpool_error =</span> <span class="fu">abs</span>(p_partpool <span class="sc">-</span> p_true)) <span class="sc">|&gt;</span> </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ni_factor =</span> <span class="fu">factor</span>(ni, </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>                            <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">35</span>),</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>                            <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"tiny (5)"</span>, <span class="st">"small (10)"</span>, <span class="st">"medium (25)"</span>, <span class="st">"large (35)"</span>)))</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>dsim <span class="sc">|&gt;</span> </span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 60
Columns: 10
$ pond           &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29…
$ ni             &lt;int&gt; 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, …
$ true_a         &lt;dbl&gt; 0.56673123, 1.99002317, -0.13775688, 1.85676651, 3.91208800, 1.95414869, 1.48963805, 2.52407196, 2.178280…
$ si             &lt;int&gt; 4, 4, 3, 5, 5, 4, 4, 4, 3, 4, 5, 2, 5, 4, 5, 6, 3, 5, 5, 7, 4, 9, 10, 6, 8, 9, 8, 7, 6, 7, 24, 22, 24, 18…
$ p_nopool       &lt;dbl&gt; 0.80, 0.80, 0.60, 1.00, 1.00, 0.80, 0.80, 0.80, 0.60, 0.80, 1.00, 0.40, 1.00, 0.80, 1.00, 0.60, 0.30, 0.5…
$ p_partpool     &lt;dbl&gt; 0.8270110, 0.8277081, 0.6861836, 0.9314136, 0.9317488, 0.8261827, 0.8303546, 0.8279099, 0.6888539, 0.8274…
$ p_true         &lt;dbl&gt; 0.6380086, 0.8797456, 0.4656151, 0.8649196, 0.9803934, 0.8758983, 0.8160239, 0.9258122, 0.8982820, 0.8857…
$ nopool_error   &lt;dbl&gt; 0.161991419, 0.079745589, 0.134384860, 0.135080387, 0.019606594, 0.075898310, 0.016023939, 0.125812219, 0…
$ partpool_error &lt;dbl&gt; 0.189002439, 0.052037481, 0.220568419, 0.066494026, 0.048644576, 0.049715648, 0.014330707, 0.097902333, 0…
$ ni_factor      &lt;fct&gt; tiny (5), tiny (5), tiny (5), tiny (5), tiny (5), tiny (5), tiny (5), tiny (5), tiny (5), tiny (5), tiny …</code></pre>
</div>
</div>
<p>Here is our code for Figure 13.3. The extra data processing for <code>dfline</code> is how we get the values necessary for the horizontal summary lines.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>dfline <span class="ot">&lt;-</span> dsim <span class="sc">|&gt;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ni_factor, nopool_error<span class="sc">:</span>partpool_error) <span class="sc">|&gt;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(nopool_error<span class="sc">:</span>partpool_error) <span class="sc">|&gt;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name, ni_factor) <span class="sc">|&gt;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_error =</span> <span class="fu">mean</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x    =</span> <span class="fu">c</span>( <span class="dv">1</span>, <span class="dv">16</span>, <span class="dv">31</span>, <span class="dv">46</span>),</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">xend =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">30</span>, <span class="dv">45</span>, <span class="dv">60</span>))</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>dsim <span class="sc">|&gt;</span> </span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pond)) <span class="sc">+</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> nopool_error), <span class="at">color =</span> <span class="st">"orange2"</span>) <span class="sc">+</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> partpool_error), <span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> dfline, </span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">xend =</span> xend, </span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> mean_error, <span class="at">yend =</span> mean_error),</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"orange2"</span>, <span class="st">"black"</span>), <span class="at">each =</span> <span class="dv">4</span>),</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>               <span class="at">linetype =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">each =</span> <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>)) <span class="sc">+</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"absolute error"</span>,</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Estimate error by model type"</span>,</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"The horizontal axis displays pond number. The vertical axis measures</span><span class="sc">\n</span><span class="st">the absolute error in the predicted proportion of survivors, compared to</span><span class="sc">\n</span><span class="st">the true value used in the simulation. The higher the point, the worse</span><span class="sc">\n</span><span class="st">the estimate. No-pooling shown in orange. Partial pooling shown in black.</span><span class="sc">\n</span><span class="st">The orange and dashed black lines show the average error for each kind</span><span class="sc">\n</span><span class="st">of estimate, across each initial density of tadpoles (pond size)."</span>) <span class="sc">+</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> ni_factor, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>If you wanted to quantify the difference in simple summaries, you might execute something like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>dsim <span class="sc">|&gt;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ni, nopool_error<span class="sc">:</span>partpool_error) <span class="sc">|&gt;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>ni) <span class="sc">|&gt;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_error   =</span> <span class="fu">mean</span>(value) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">median_error =</span> <span class="fu">median</span>(value) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  name           mean_error median_error
  &lt;chr&gt;               &lt;dbl&gt;        &lt;dbl&gt;
1 nopool_error        0.059        0.042
2 partpool_error      0.054        0.033</code></pre>
</div>
</div>
<p>Although many years of work in statistics have shown that partially pooled estimates are better, on average, this is not always the case. Our results are an example of this. McElreath addressed this directly:</p>
<blockquote class="blockquote">
<p>But there are some cases in which the no-pooling estimates are better. These exceptions often result from ponds with extreme probabilities of survival. The partial pooling estimates shrink such extreme ponds towards the mean, because few ponds exhibit such extreme behavior. But sometimes outliers really are outliers. (p.&nbsp;414)</p>
</blockquote>
<p>I originally learned about the multilevel in order to work with <a href="https://gseacademic.harvard.edu/alda/">longitudinal data</a>. In that context, I found the basic principles of a multilevel structure quite intuitive. The concept of partial pooling, however, took me some time to wrap my head around. If you’re struggling with this, be patient and keep chipping away.</p>
<p>When McElreath <a href="https://youtu.be/82TaniPgzQc?t=2048">lectured on this topic in 2015</a>, he traced partial pooling to statistician <a href="https://imstat.org/2017/05/15/obituary-charles-m-stein-1920-2016/">Charles M. Stein</a>. Efron and Morris <span class="citation" data-cites="efronSteinParadoxStatistics1977">(<a href="references.html#ref-efronSteinParadoxStatistics1977" role="doc-biblioref">1977</a>)</span> wrote the now classic paper, <a href="https://statweb.stanford.edu/~ckirby/brad/other/Article1977.pdf"><em>Stein’s paradox in statistics</em></a>, which does a nice job breaking down why partial pooling can be so powerful. One of the primary examples they used in the paper was of 1970 batting average data. If you’d like more practice seeing how partial pooling works–or if you just like baseball–, check out my blog post, <a href="https://solomonkurz.netlify.app/blog/2019-02-23-stein-s-paradox-and-what-partial-pooling-can-do-for-you/"><em>Stein’s paradox and what partial pooling can do for you</em></a>.</p>
<section id="overthinking-repeating-the-pond-simulation" class="level4" data-number="13.2.5.1">
<h4 data-number="13.2.5.1" class="anchored" data-anchor-id="overthinking-repeating-the-pond-simulation"><span class="header-section-number">13.2.5.1</span> Overthinking: Repeating the pond simulation</h4>
<p>Within the <strong>brms</strong> workflow, we can reuse a compiled model with <code>update()</code>. But first, we’ll simulate new data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>a_bar   <span class="ot">&lt;-</span> <span class="fl">1.5</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>sigma   <span class="ot">&lt;-</span> <span class="fl">1.5</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>n_ponds <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1999</span>)  <span class="co"># For new data, set a new seed</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>new_dsim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pond   =</span> <span class="dv">1</span><span class="sc">:</span>n_ponds,</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">ni     =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">35</span>), <span class="at">each =</span> n_ponds <span class="sc">/</span> <span class="dv">4</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>(),</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">true_a =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_ponds, <span class="at">mean =</span> a_bar, <span class="at">sd =</span> sigma)) <span class="sc">|&gt;</span> </span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">si =</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">prob =</span> <span class="fu">plogis</span>(true_a), <span class="at">size =</span> ni)) <span class="sc">|&gt;</span> </span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_nopool =</span> si <span class="sc">/</span> ni)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(new_dsim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 60
Columns: 5
$ pond     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, …
$ ni       &lt;int&gt; 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 25, 25…
$ true_a   &lt;dbl&gt; 2.5990087, 1.4432554, 3.3045137, 3.7047030, 1.7005354, 2.2797409, 0.6759270, -0.2784119, -0.2209196, 3.2411130,…
$ si       &lt;int&gt; 4, 4, 5, 4, 4, 4, 2, 4, 3, 5, 4, 5, 2, 2, 5, 10, 8, 10, 10, 9, 10, 9, 5, 10, 10, 6, 7, 7, 8, 6, 10, 22, 5, 25, …
$ p_nopool &lt;dbl&gt; 0.80, 0.80, 1.00, 0.80, 0.80, 0.80, 0.40, 0.80, 0.60, 1.00, 0.80, 1.00, 0.40, 0.40, 1.00, 1.00, 0.80, 1.00, 1.0…</code></pre>
</div>
</div>
<p>Fit the new model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.3</span>_new <span class="ot">&lt;-</span> <span class="fu">update</span>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  b13<span class="fl">.3</span>,</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> new_dsim,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b13.03_new"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b13<span class="fl">.3</span>_new)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: si | trials(ni) ~ 1 + (1 | pond) 
   Data: new_dsim (Number of observations: 60) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~pond (Number of levels: 60) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.33      0.19     1.00     1.75 1.00     1383     2118

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     1.64      0.21     1.25     2.06 1.00     1601     2273

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Why not plot the first simulation versus the second one?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">as_draws_df</span>(b13<span class="fl">.3</span>),</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>          <span class="fu">as_draws_df</span>(b13<span class="fl">.3</span>_new)) <span class="sc">|&gt;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"b13.3"</span>, <span class="st">"b13.3_new"</span>), <span class="at">each =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> b_Intercept, <span class="at">y =</span> sd_pond__Intercept)) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density_2d</span>(<span class="at">geom =</span> <span class="st">"raster"</span>, </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">contour =</span> F, <span class="at">n =</span> <span class="dv">200</span>) <span class="sc">+</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> a_bar, <span class="at">color =</span> <span class="st">"orange3"</span>, <span class="at">linetype =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> sigma, <span class="at">color =</span> <span class="st">"orange3"</span>, <span class="at">linetype =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"grey25"</span>, <span class="at">high =</span> <span class="st">"orange3"</span>) <span class="sc">+</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Our simulation posteriors contrast a bit"</span>,</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(alpha<span class="sc">*</span><span class="st">" is on the x and "</span><span class="sc">*</span>sigma<span class="sc">*</span><span class="st">" is on the y, both in log-odds. The dotted lines intersect at the true values."</span>)) <span class="sc">+</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="dv">2</span>),</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">1.9</span>)) <span class="sc">+</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> model, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>If you’d like the <code>stanfit</code> portion of your <code>brm()</code> object, subset with <code>$fit</code>. Take <code>b13.3</code>, for example. You might check out its structure via <code>b13.3$fit |&gt; str()</code>. Here’s the actual Stan code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.3</span><span class="sc">$</span>fit<span class="sc">@</span>stanmodel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>S4 class stanmodel 'anon_model' coded as follows:
// generated with brms 2.23.0
functions {
}
data {
  int&lt;lower=1&gt; N;  // total number of observations
  array[N] int Y;  // response variable
  array[N] int trials;  // number of trials
  // data for group-level effects of ID 1
  int&lt;lower=1&gt; N_1;  // number of grouping levels
  int&lt;lower=1&gt; M_1;  // number of coefficients per level
  array[N] int&lt;lower=1&gt; J_1;  // grouping indicator per observation
  // group-level predictor values
  vector[N] Z_1_1;
  int prior_only;  // should the likelihood be ignored?
}
transformed data {
}
parameters {
  real Intercept;  // temporary intercept for centered predictors
  vector&lt;lower=0&gt;[M_1] sd_1;  // group-level standard deviations
  array[M_1] vector[N_1] z_1;  // standardized group-level effects
}
transformed parameters {
  vector[N_1] r_1_1;  // actual group-level effects
  // prior contributions to the log posterior
  real lprior = 0;
  r_1_1 = (sd_1[1] * (z_1[1]));
  lprior += normal_lpdf(Intercept | 0, 1.5);
  lprior += exponential_lpdf(sd_1 | 1);
}
model {
  // likelihood including constants
  if (!prior_only) {
    // initialize linear predictor term
    vector[N] mu = rep_vector(0.0, N);
    mu += Intercept;
    for (n in 1:N) {
      // add more terms to the linear predictor
      mu[n] += r_1_1[J_1[n]] * Z_1_1[n];
    }
    target += binomial_logit_lpmf(Y | trials, mu);
  }
  // priors including constants
  target += lprior;
  target += std_normal_lpdf(z_1[1]);
}
generated quantities {
  // actual population-level intercept
  real b_Intercept = Intercept;
} </code></pre>
</div>
</div>
<p>For more on how to fit this model with <strong>rstan</strong>, go to my companion book <a href="https://solomon.quarto.pub/sr2rstan/13.html#varying-effects-and-the-underfittingoverfitting-trade-off">here</a>.</p>
</section>
</section>
</section>
<section id="sec-More-than-one-type-of-cluster" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="sec-More-than-one-type-of-cluster"><span class="header-section-number">13.3</span> More than one type of cluster</h2>
<p>“We can use and often should use more than one type of cluster in the same model” (p.&nbsp;415).</p>
<section id="rethinking-cross-classification-and-hierarchy" class="level4" data-number="13.3.0.1">
<h4 data-number="13.3.0.1" class="anchored" data-anchor-id="rethinking-cross-classification-and-hierarchy"><span class="header-section-number">13.3.0.1</span> Rethinking: Cross-classification and hierarchy</h4>
<blockquote class="blockquote">
<p>The kind of data structure in <code>data(chimpanzees)</code> is usually called a <strong>cross-classified multilevel</strong> model. It is cross-classified, because actors are not nested within unique blocks. If each chimpanzee had instead done all of his or her pulls on a single day, within a single block, then the data structure would instead be <em>hierarchical</em>. However, the model specification would typically be the same. So the model structure and code you’ll see below will apply both to cross-classified designs and hierarchical designs. (p.&nbsp;415, <strong>emphasis</strong> in the original)</p>
</blockquote>
</section>
<section id="multilevel-chimpanzees" class="level3" data-number="13.3.1">
<h3 data-number="13.3.1" class="anchored" data-anchor-id="multilevel-chimpanzees"><span class="header-section-number">13.3.1</span> Multilevel chimpanzees</h3>
<p>The initial multilevel update from model <code>b11.4</code> from <a href="11.html#sec-Prosocial-chimpanzees" class="quarto-xref"><span>Section 11.1.1</span></a> follows the statistical formula</p>
<p><span class="math display">\[\begin{align*}
\text{left\_pull}_i         &amp; \sim \operatorname{Binomial}(n_i = 1, p_i) \\
\operatorname{logit} (p_i) &amp; = \alpha_{\text{actor}[i]}  + \color{#CD8500}{\gamma_{\text{block}[i]}} + \beta_{\text{treatment}[i]} \\
\beta_j  &amp; \sim \operatorname{Normal}(0, 0.5) \;\;\; , \text{for } j = 1, \dots, 4 \\
\alpha_j &amp; \sim \operatorname{Normal}(\bar \alpha, \sigma_\alpha) \;\;\; , \text{for } j = 1, \dots, 7 \\
\color{#CD8500}{\gamma_j} &amp; \color{#CD8500} \sim \color{#CD8500}{\operatorname{Normal}(0, \sigma_\gamma) \;\;\; , \text{for } j = 1, \dots, 6} \\
\bar \alpha   &amp; \sim \operatorname{Normal}(0, 1.5) \\
\sigma_\alpha &amp; \sim \operatorname{Exponential}(1) \\
\color{#CD8500}{\sigma_\gamma} &amp; \color{#CD8500} \sim \color{#CD8500}{\operatorname{Exponential}(1)}.
\end{align*}\]</span></p>
<p>⚠️ WARNING ⚠️</p>
<p>I am so sorry, but we are about to head straight into a load of confusion. If you follow along linearly in the text, we won’t have the language to parse this all out until <a href="#sec-Divergent-transitions-and-non-centered-priors" class="quarto-xref"><span>Section 13.4</span></a>. In short, our difficulties will have to do with what are called the centered and the non-centered parameterizations for multilevel models. For the next several models in the text, McElreath used the <strong>centered parameterization</strong>. As we’ll learn in Section 13.4, this often causes problems when you use Stan to fit your multilevel models. Happily, the solution to those problems is often the <strong>non-centered parameterization</strong>, which is well known among the Stan team. This issue is so well known, in fact, that Bürkner only supports the non-centered parameterization with <strong>brms</strong> (see <a href="https://discourse.mc-stan.org/t/disable-non-centered-parameterization-in-brms/7184/7">here</a>). To my knowledge, there is no easy way around this. In the long run, this is a good thing. Your <strong>brms</strong> models will likely avoid some of the problems McElreath highlighted in this part of the text. In the short term, this also means that our results will not completely match up with those in the text. If you really want to reproduce McElreath’s models <code>m13.4</code> through <code>m13.6</code>, you’ll have to fit them with the <strong>rethinking</strong> package or directly in Stan. Our models <code>b13.4</code> through <code>b13.6</code> will be the non-centered <strong>brms</strong> alternatives. Either way, the models make the same predictions, but the nuts and bolts and gears we’ll use to construct our multilevel golems will look a little different. With all that in mind, here’s how we might express our statistical model using the non-centered parameterization more faithful to the way it will be expressed with <code>brms::brm()</code>:</p>
<p><span class="math display">\[\begin{align*}
\text{left\_pull}_i         &amp; \sim \operatorname{Binomial}(n_i = 1, p_i) \\
\operatorname{logit} (p_i) &amp; = \bar \alpha + \beta_{\text{treatment}[i]} + \color{#CD8500}{z_{\text{actor}[i]} \sigma_\alpha + x_{\text{block}[i]} \sigma_\gamma} \\
\bar \alpha   &amp; \sim \operatorname{Normal}(0, 1.5) \\
\beta_j       &amp; \sim \operatorname{Normal}(0, 0.5) \;\;\; , \text{for } j = 1, \dots, 4 \\
\color{#CD8500}{z_j} &amp; \color{#CD8500}\sim \color{#CD8500}{\operatorname{Normal}(0, 1)} \\
\color{#CD8500}{x_j} &amp; \color{#CD8500}\sim \color{#CD8500}{\operatorname{Normal}(0, 1)} \\
\sigma_\alpha &amp; \sim \operatorname{Exponential}(1) \\
\sigma_\gamma &amp; \sim \operatorname{Exponential}(1).
\end{align*}\]</span></p>
<p>If you jump ahead to <a href="#sec-Non-centered-chimpanzees" class="quarto-xref"><span>Section 13.4.2</span></a>, you’ll see this is just re-write of the formula on the top of page 424. For now, let’s load the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(chimpanzees, <span class="at">package =</span> <span class="st">"rethinking"</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> chimpanzees</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(chimpanzees)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Wrangle and view.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">actor     =</span> <span class="fu">factor</span>(actor),</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">block     =</span> <span class="fu">factor</span>(block),</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">treatment =</span> <span class="fu">factor</span>(<span class="dv">1</span> <span class="sc">+</span> prosoc_left <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> condition))</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 504
Columns: 9
$ actor        &lt;fct&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ recipient    &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ condition    &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ block        &lt;fct&gt; 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6,…
$ trial        &lt;int&gt; 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44, 46, 48, 50, 52, 54, 56,…
$ prosoc_left  &lt;int&gt; 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 0, 0,…
$ chose_prosoc &lt;int&gt; 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1,…
$ pulled_left  &lt;int&gt; 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0,…
$ treatment    &lt;fct&gt; 1, 1, 2, 1, 2, 2, 2, 2, 1, 1, 1, 2, 1, 2, 1, 2, 2, 1, 2, 1, 1, 1, 2, 2, 1, 1, 2, 2, 1, 2, 1, 2, 2, 2, 1, 1,…</code></pre>
</div>
</div>
<p>Even when using the non-centered parameterization, McElreath’s <code>m13.4</code> is a bit of an odd model to translate into <strong>brms</strong> syntax. To my knowledge, it can’t be done with conventional syntax. But we can fit the model with careful use of the non-linear syntax, which might look like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(pulled_left <span class="sc">|</span> <span class="fu">trials</span>(<span class="dv">1</span>) <span class="sc">~</span> a <span class="sc">+</span> b,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>     a <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> actor) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> block), </span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>     b <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> treatment,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">nl =</span> <span class="cn">TRUE</span>),</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">nlpar =</span> b),</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> b, <span class="at">coef =</span> Intercept, <span class="at">nlpar =</span> a),</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sd, <span class="at">group =</span> actor, <span class="at">nlpar =</span> a),</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sd, <span class="at">group =</span> block, <span class="at">nlpar =</span> a)),</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b13.04"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>b ~ 0 + treatment</code> part of the <code>formula</code> is our expression of what we wrote above as <span class="math inline">\(\beta_{\text{treatment}[i]}\)</span>. There’s a lot going on with the <code>a ~ 1 + (1 | actor) + (1 | block)</code> part of the formula. The initial <code>1</code> outside of the parenthesis is <span class="math inline">\(\bar \alpha\)</span>. The <code>(1 | actor)</code> and <code>(1 | block)</code> parts correspond to <span class="math inline">\(z_{\text{actor}[i]} \sigma_\alpha\)</span> and <span class="math inline">\(x_{\text{block}[i]} \sigma_\gamma\)</span>, respectively.</p>
<p>Check the trace plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">color_scheme_set</span>(<span class="st">"orange"</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(b13<span class="fl">.4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mcmc_trace</span>(<span class="at">pars =</span> <span class="fu">vars</span>(b_a_Intercept<span class="sc">:</span><span class="st">`</span><span class="at">r_block__a[6,Intercept]</span><span class="st">`</span>),</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">facet_args =</span> <span class="fu">list</span>(<span class="at">ncol =</span> <span class="dv">4</span>), </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">linewidth =</span> <span class="fl">0.15</span>) <span class="sc">+</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>They all look fine. In the text (e.g., page 416), McElreath briefly mentioned warnings about divergent transitions. We didn’t get any warnings like that. Keep following along and you’ll soon learn why.</p>
<p>Here’s a look at the summary when using <code>print()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b13<span class="fl">.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: pulled_left | trials(1) ~ a + b 
         a ~ 1 + (1 | actor) + (1 | block)
         b ~ 0 + treatment
   Data: d (Number of observations: 504) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~actor (Number of levels: 7) 
                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(a_Intercept)     2.02      0.65     1.08     3.61 1.00     1396     2247

~block (Number of levels: 6) 
                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(a_Intercept)     0.21      0.18     0.01     0.66 1.00     1700     1525

Regression Coefficients:
             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
a_Intercept      0.66      0.73    -0.80     2.15 1.01     1044     1758
b_treatment1    -0.13      0.30    -0.69     0.45 1.00     2548     3040
b_treatment2     0.40      0.30    -0.16     0.97 1.00     2740     2522
b_treatment3    -0.48      0.30    -1.05     0.11 1.00     2723     2820
b_treatment4     0.28      0.30    -0.29     0.86 1.00     2711     2626

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>When you use the <code>(1 | &lt;group&gt;)</code> syntax within <code>brm()</code>, the group-specific parameters are not shown with <code>print()</code>. You only get the hierarchical <span class="math inline">\(\sigma_\text{&lt;group&gt;}\)</span> summaries, shown here as the two rows for <code>sd(a_Intercept)</code>. However, you can get a summary of all the parameters with the <code>posterior_summary()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_summary</span>(b13<span class="fl">.4</span>) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                        Estimate Est.Error    Q2.5   Q97.5
b_a_Intercept               0.66      0.73   -0.80    2.15
b_b_treatment1             -0.13      0.30   -0.69    0.45
b_b_treatment2              0.40      0.30   -0.16    0.97
b_b_treatment3             -0.48      0.30   -1.05    0.11
b_b_treatment4              0.28      0.30   -0.29    0.86
sd_actor__a_Intercept       2.02      0.65    1.08    3.61
sd_block__a_Intercept       0.21      0.18    0.01    0.66
r_actor__a[1,Intercept]    -1.02      0.74   -2.51    0.40
r_actor__a[2,Intercept]     4.05      1.37    1.95    7.44
r_actor__a[3,Intercept]    -1.31      0.74   -2.82    0.17
r_actor__a[4,Intercept]    -1.32      0.74   -2.83    0.17
r_actor__a[5,Intercept]    -1.01      0.75   -2.55    0.49
r_actor__a[6,Intercept]    -0.07      0.74   -1.58    1.38
r_actor__a[7,Intercept]     1.45      0.78   -0.08    2.96
r_block__a[1,Intercept]    -0.17      0.22   -0.73    0.13
r_block__a[2,Intercept]     0.04      0.18   -0.30    0.45
r_block__a[3,Intercept]     0.05      0.18   -0.28    0.48
r_block__a[4,Intercept]     0.01      0.19   -0.37    0.42
r_block__a[5,Intercept]    -0.03      0.18   -0.43    0.33
r_block__a[6,Intercept]     0.11      0.20   -0.18    0.58
lprior                     -6.34      1.18   -9.19   -4.54
lp__                     -286.68      3.71 -294.62 -280.28</code></pre>
</div>
</div>
<p>We might make the coefficient plot of Figure 13.4.a with <code>bayesplot::mcmc_plot()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.4</span> <span class="sc">|&gt;</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mcmc_plot</span>(<span class="at">variable =</span> <span class="fu">c</span>(<span class="st">"^r_"</span>, <span class="st">"^b_"</span>, <span class="st">"^sd_"</span>), <span class="at">regex =</span> T) <span class="sc">+</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="360"></p>
</figure>
</div>
</div>
</div>
<p>For a little more control, we might switch to a <strong>tidybayes</strong>-oriented approach.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the posterior draws</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b13<span class="fl">.4</span>) </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Rhis is all stylistic fluff</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>levels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sd_block__a_Intercept"</span>, <span class="st">"sd_actor__a_Intercept"</span>, </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"b_a_Intercept"</span>, </span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_c</span>(<span class="st">"r_block__a["</span>, <span class="dv">6</span><span class="sc">:</span><span class="dv">1</span>, <span class="st">",Intercept]"</span>), </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_c</span>(<span class="st">"r_actor__a["</span>, <span class="dv">7</span><span class="sc">:</span><span class="dv">1</span>, <span class="st">",Intercept]"</span>), </span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_c</span>(<span class="st">"b_b_treatment"</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">1</span>))</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">x     =</span> <span class="fu">posterior_summary</span>(b13<span class="fl">.4</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.955</span>))[<span class="st">"r_actor__a[2,Intercept]"</span>, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>)],</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">y     =</span> <span class="fu">c</span>(<span class="fl">13.5</span>, <span class="fl">16.5</span>),</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> <span class="fu">c</span>(<span class="st">"89% CI"</span>, <span class="st">"mean"</span>),</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">hjust =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">0</span>))</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>arrow <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">x    =</span> <span class="fu">posterior_summary</span>(b13<span class="fl">.4</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.955</span>))[<span class="st">"r_actor__a[2,Intercept]"</span>, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>)] <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.2</span>),</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">xend =</span> <span class="fu">posterior_summary</span>(b13<span class="fl">.4</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.955</span>))[<span class="st">"r_actor__a[2,Intercept]"</span>, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>)],</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">y    =</span> <span class="fu">c</span>(<span class="dv">14</span>, <span class="dv">16</span>),</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">yend =</span> <span class="fu">c</span>(<span class="fl">14.8</span>, <span class="fl">15.35</span>))</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Here's the main event</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span> </span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(b_a_Intercept<span class="sc">:</span><span class="st">`</span><span class="at">r_block__a[6,Intercept]</span><span class="st">`</span>)<span class="sc">|&gt;</span> </span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">factor</span>(name, <span class="at">levels =</span> levels)) <span class="sc">|&gt;</span> </span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> name)) <span class="sc">+</span></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_pointinterval</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fl">0.89</span>, </span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>                     <span class="at">point_fill =</span> <span class="st">"blue"</span>, <span class="at">point_size =</span> <span class="dv">2</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> text,</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">label =</span> label, <span class="at">hjust =</span> hjust)) <span class="sc">+</span></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> arrow,</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">xend =</span> xend,</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> y, <span class="at">yend =</span> yend),</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>               <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.15</span>, <span class="st">"cm"</span>))) <span class="sc">+</span></span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">linetype =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="360"></p>
</figure>
</div>
</div>
</div>
<p>Regardless of whether we use a <strong>bayesplot</strong>- or <strong>tidybayes</strong>-oriented workflow, a careful look at our coefficient plots will show the parameters are a little different from those McElreath reported. Again, this is because of the subtle differences between our non-centered parameterization and McElreath’s centered parameterization. This will all make more sense in Section 13.4.</p>
<p>Now use <code>post</code> to compare the group-level <span class="math inline">\(\sigma\)</span> parameters as in Figure 13.4.b.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"sd"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">adjust =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">alpha =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">linewidth =</span> <span class="dv">0</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.67</span>, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"orange4"</span>, <span class="at">label =</span> <span class="st">"block"</span>) <span class="sc">+</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">2.725</span>, <span class="at">y =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"orange1"</span>, <span class="at">label =</span> <span class="st">"actor"</span>) <span class="sc">+</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">str_c</span>(<span class="st">"orange"</span>, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>))) <span class="sc">+</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">expression</span>(sigma[<span class="st">"&lt;group&gt;"</span>])) <span class="sc">+</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>Since both the coefficient plots and the density plots indicate there is much more variability among the <code>actor</code> parameters than in the <code>block</code> parameters, we might fit a model that ignores the variation among the levels of <code>block</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(pulled_left <span class="sc">|</span> <span class="fu">trials</span>(<span class="dv">1</span>) <span class="sc">~</span> a <span class="sc">+</span> b,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>     a <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> actor), </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>     b <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> treatment,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">nl =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">nlpar =</span> b),</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> b, <span class="at">coef =</span> Intercept, <span class="at">nlpar =</span> a),</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sd, <span class="at">group =</span> actor, <span class="at">nlpar =</span> a)),</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b13.05"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We might compare our models by their WAIC estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(b13<span class="fl">.4</span>, <span class="at">criterion =</span> <span class="st">"waic"</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(b13<span class="fl">.5</span>, <span class="at">criterion =</span> <span class="st">"waic"</span>)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(b13<span class="fl">.4</span>, b13<span class="fl">.5</span>, <span class="at">criterion =</span> <span class="st">"waic"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">simplify =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
b13.5    0.0       0.0  -265.7       9.6          8.6    0.4     531.4   19.2 
b13.4   -0.3       0.8  -266.0       9.7         10.5    0.5     532.0   19.3 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">model_weights</span>(b13<span class="fl">.4</span>, b13<span class="fl">.5</span>, <span class="at">weights =</span> <span class="st">"waic"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>b13.4 b13.5 
 0.43  0.57 </code></pre>
</div>
</div>
<p>The two models yield nearly-equivalent WAIC estimates. Just as in the text, our <code>p_waic</code> column shows the models differ by about 2 effective parameters due to the shrinkage from the multilevel partial pooling. Yet recall what McElreath wrote:</p>
<blockquote class="blockquote">
<p>There is nothing to gain here by selecting either model. The comparison of the two models tells a richer story… Since this is an experiment, there is nothing to really select. The experimental design tells us the relevant causal model to inspect. (pp.&nbsp;418–419)</p>
</blockquote>
</section>
<section id="even-more-clusters" class="level3" data-number="13.3.2">
<h3 data-number="13.3.2" class="anchored" data-anchor-id="even-more-clusters"><span class="header-section-number">13.3.2</span> Even more clusters</h3>
<p>We can extend partial pooling to the <code>treatment</code> conditions, too. With <strong>brms</strong>, it will be more natural to revert to the conventional <code>formula</code> syntax.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  pulled_left <span class="sc">|</span> <span class="fu">trials</span>(<span class="dv">1</span>) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> actor) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> block) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> treatment),</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sd)),</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b13.06"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall that with <strong>brms</strong>, we don’t have a <code>coeftab()</code> like with McElreath’s <strong>rethinking</strong>. For us, one approach would be to compare the relevent rows from <code>fixef(b13.4)</code> to the relevant elements from <code>ranef(b13.6)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">parameter =</span> <span class="fu">str_c</span>(<span class="st">"b["</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">"]"</span>),</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>       <span class="st">`</span><span class="at">b13.4</span><span class="st">`</span>   <span class="ot">=</span> <span class="fu">fixef</span>(b13<span class="fl">.4</span>)[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span>],</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>       <span class="st">`</span><span class="at">b13.6</span><span class="st">`</span>   <span class="ot">=</span> <span class="fu">ranef</span>(b13<span class="fl">.6</span>)<span class="sc">$</span>treatment[, <span class="dv">1</span>, <span class="st">"Intercept"</span>]) <span class="sc">|&gt;</span> </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  parameter b13.4 b13.6
  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;
1 b[1]      -0.13 -0.12
2 b[2]       0.4   0.38
3 b[3]      -0.48 -0.45
4 b[4]       0.28  0.27</code></pre>
</div>
</div>
<p>Like in the text, “these are not identical, but they are very close” (p.&nbsp;419). We might compare the group-level <span class="math inline">\(\sigma\)</span> parameters with a plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(b13<span class="fl">.6</span>) <span class="sc">|&gt;</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"sd"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">str_remove</span>(name, <span class="st">"sd_"</span>) <span class="sc">|&gt;</span> <span class="fu">str_remove</span>(<span class="st">"__Intercept"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">parameter =</span> <span class="fu">str_c</span>(<span class="st">"sigma["</span>, group,<span class="st">"]"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> parameter)) <span class="sc">+</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(<span class="at">.width =</span> <span class="fl">0.95</span>,</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">0.1</span>, <span class="at">fill =</span> <span class="st">"orange"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> ggplot2<span class="sc">:::</span>parse_safe, <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">add =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"The variation among treatment levels is small, but the</span><span class="sc">\n</span><span class="st">variation among the levels of block is still the smallest."</span>) <span class="sc">+</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="504"></p>
</figure>
</div>
</div>
</div>
<p>Among the three <span class="math inline">\(\sigma_\text{&lt;group&gt;}\)</span> parameters, <span class="math inline">\(\sigma_\text{block}\)</span> is the smallest. Now we’ll compare <code>b13.6</code> to the last two models with the WAIC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(b13<span class="fl">.6</span>, <span class="at">criterion =</span> <span class="st">"waic"</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(b13<span class="fl">.4</span>, b13<span class="fl">.5</span>, b13<span class="fl">.6</span>, <span class="at">criterion =</span> <span class="st">"waic"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">simplify =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
b13.5    0.0       0.0  -265.7       9.6          8.6    0.4     531.4   19.2 
b13.4   -0.3       0.8  -266.0       9.7         10.5    0.5     532.0   19.3 
b13.6   -0.8       0.8  -266.4       9.6         10.8    0.5     532.9   19.3 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">model_weights</span>(b13<span class="fl">.4</span>, b13<span class="fl">.5</span>, b13<span class="fl">.6</span>, <span class="at">weights =</span> <span class="st">"loo"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>b13.4 b13.5 b13.6 
 0.33  0.45  0.21 </code></pre>
</div>
</div>
<p>The models show little difference “on purely predictive criteria. This is the typical result, when each cluster (each treatment here) has a lot of data to inform its parameters” (p.&nbsp;419). Unlike in the text, we didn’t have a problem with divergent transitions. We’ll see why in the next section.</p>
<p>Before we move on, this section just hints at a historical software difficulty. In short, it’s not uncommon to have a theory-based model that includes multiple sources of clustering (i.e., requiring many <code>( &lt;varying parameter(s)&gt; | &lt;grouping variable(s)&gt; )</code> parts in the model <code>formula</code>). This can make for all kinds of computational difficulties and result in software error messages, inadmissible solutions, and so on. One of the practical solutions to difficulties like these has been to simplify the statistical models by removing some of the clustering terms. Even though such simpler models were not the theory-based ones, at least they yielded solutions. Nowadays, Stan (via <strong>brms</strong> or otherwise) is making it easier to fit the full theoretically-based model. To learn more about this topic, check out this nice blog post by <a href="https://web.stanford.edu/~mcfrank/">Michael Frank</a>, <a href="http://babieslearninglanguage.blogspot.com/2018/02/mixed-effects-models-is-it-time-to-go.html"><em>Mixed effects models: Is it time to go Bayesian by default?</em></a>. Make sure to check out the discussion in the comments section, which includes all-stars like Bürkner and <a href="http://pages.stat.wisc.edu/~bates/">Douglas Bates</a>. You can get more context for the issue from <span class="citation" data-cites="barrRandomEffectsStructure2013">Barr et al. (<a href="references.html#ref-barrRandomEffectsStructure2013" role="doc-biblioref">2013</a>)</span>, <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3881361/"><em>Random effects structure for confirmatory hypothesis testing: Keep it maximal</em></a>.</p>
</section>
</section>
<section id="sec-Divergent-transitions-and-non-centered-priors" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="sec-Divergent-transitions-and-non-centered-priors"><span class="header-section-number">13.4</span> Divergent transitions and non-centered priors</h2>
<p>Although we did not get divergent transitions warnings in from our last few models the way McElreath did with his, the issues is still relevant for <strong>brms</strong>.</p>
<blockquote class="blockquote">
<p>One of the best things about Hamiltonian Monte Carlo is that it provides internal checks of efficiency and accuracy. One of these checks comes free, arising from the constraints on the physics simulation. Recall that HMC simulates the frictionless flow of a particle on a surface. In any given transition, which is just a single flick of the particle, the total energy at the start should be equal to the total energy at the end. That’s how energy in a closed system works. And in a purely mathematical system, the energy is always conserved correctly. It’s just a fact about the physics.</p>
<p>But in a numerical system, it might not be. Sometimes the total energy is not the same at the end as it was at the start. In these cases, the energy is <em>divergent.</em> How can this happen? It tends to happen when the posterior distribution is very steep in some region of parameter space. Steep changes in probability are hard for a discrete physics simulation to follow. When that happens, the algorithm notices by comparing the energy at the start to the energy at the end. When they don’t match, it indicates numerical problems exploring that part of the posterior distribution.</p>
<p>Divergent transitions are rejected. They don’t directly damage your approximation of the posterior distribution. But they do hurt it indirectly, because the region where divergent transitions happen is hard to explore correctly. (p.&nbsp;420, <em>emphasis</em> in the original)</p>
</blockquote>
<p>Two primary ways to handle divergent transitions are by increasing the <code>adapt_delta</code> parameter, which we’ve already done a few times in previous chapters, or reparameterizing the model. As McElreath will cover in a bit, switching from the centered to the non-centered parameterization will often work when using multilevel models.</p>
<section id="the-devils-funnel" class="level3" data-number="13.4.1">
<h3 data-number="13.4.1" class="anchored" data-anchor-id="the-devils-funnel"><span class="header-section-number">13.4.1</span> The Devil’s Funnel</h3>
<p>McElreath posed a joint distribution</p>
<p><span class="math display">\[\begin{align*}
v &amp; \sim \operatorname{Normal}(0, 3) \\
x &amp; \sim \operatorname{Normal}(0, \exp(v)),
\end{align*}\]</span></p>
<p>where the scale of <span class="math inline">\(x\)</span> depends on another variable, <span class="math inline">\(v\)</span>. In <strong>R</strong> code 13.26, McElreath then proposed fitting the following model with <code>rethinking::ulam()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="dv">1</span>),</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">alist</span>(</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    v <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>),</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">exp</span>(v))</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  ), </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span> </span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’m not aware that you can do something like this with <strong>brms</strong>. If you think I’m in error, <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/issues">please share your solution</a>. We can at least get a sense of the model by simulating from the joint distribution and plotting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">v =</span> <span class="fu">rnorm</span>(<span class="fl">1e3</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">3</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="fl">1e3</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">exp</span>(v))) <span class="sc">|&gt;</span> </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"orange2"</span>) <span class="sc">+</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>,</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="sc">-</span><span class="dv">100</span>, <span class="at">y =</span> <span class="dv">490</span>, <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">expression</span>(<span class="fu">italic</span>(v)<span class="sc">%~%</span><span class="fu">Normal</span>(<span class="dv">0</span>, <span class="dv">3</span>))) <span class="sc">+</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>,</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="sc">-</span><span class="dv">100</span>, <span class="at">y =</span> <span class="dv">440</span>, <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">expression</span>(<span class="fu">italic</span>(x)<span class="sc">%~%</span><span class="fu">Normal</span>(<span class="dv">0</span>, <span class="fu">exp</span>(<span class="fu">italic</span>(v))))) <span class="sc">+</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">100</span>)) <span class="sc">+</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>The distribution looks something like a Student-<span class="math inline">\(t\)</span> with a very low <span class="math inline">\(\nu\)</span> parameter. We can express the joint likelihood of <span class="math inline">\(p(v, x)\)</span> as</p>
<p><span class="math display">\[p(v, x) = p(x \mid v)\ p(v).\]</span></p>
<p>Here that is in a plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the parameter space</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>parameter_space <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="dv">4</span>, <span class="at">to =</span> <span class="dv">4</span>, <span class="at">length.out =</span> <span class="dv">200</span>)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="fu">crossing</span>(<span class="at">v =</span> parameter_space,</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> parameter_space) <span class="sc">|&gt;</span> </span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">likelihood_v =</span> <span class="fu">dnorm</span>(v, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">3</span>),</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">likelihood_x =</span> <span class="fu">dnorm</span>(x, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">exp</span>(v))) <span class="sc">|&gt;</span> </span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">joint_likelihood =</span> likelihood_v <span class="sc">*</span> likelihood_x) <span class="sc">|&gt;</span> </span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> v, <span class="at">fill =</span> joint_likelihood)) <span class="sc">+</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="at">interpolate =</span> T) <span class="sc">+</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"B"</span>) <span class="sc">+</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Centered parameterization"</span>) <span class="sc">+</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>This ends up as a version of McElreath’s Figure 13.5.a.</p>
<blockquote class="blockquote">
<p>At low values of <span class="math inline">\(v\)</span>, the distribution of <span class="math inline">\(x\)</span> contracts around zero. This forms a very steep valley that the Hamiltonian particle needs to explore. Steep surfaces are hard to simulate, because the simulation is not actually continuous. It happens in discrete steps. If the steps are too big, the simulation will overshoot. (p.&nbsp;421)</p>
</blockquote>
<p>To avoid the divergent transitions than can arise from steep valleys like this, we can switch from our original formula to a non-centered parameterization, such as:</p>
<p><span class="math display">\[\begin{align*}
v &amp; \sim \operatorname{Normal}(0, 3) \\
z &amp; \sim \operatorname{Normal}(0, 1) \\
x &amp; = z \exp(v),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(x\)</span> is now the product of two independent distributions, <span class="math inline">\(v\)</span> and <span class="math inline">\(z\)</span>. With this parameterization, we can express the joint likelihood <span class="math inline">\(p(v, z)\)</span> as</p>
<p><span class="math display">\[p(v, z) = p(z)\ p(v),\]</span></p>
<p>where <span class="math inline">\(p(z)\)</span> is not conditional on <span class="math inline">\(v\)</span> and <span class="math inline">\(p(v)\)</span> is not conditional on <span class="math inline">\(z\)</span>. Here’s what that looks like in a plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">crossing</span>(<span class="at">v =</span> parameter_space,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">z =</span> parameter_space <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">likelihood_v =</span> <span class="fu">dnorm</span>(v, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">3</span>),</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">likelihood_z =</span> <span class="fu">dnorm</span>(z, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">joint_likelihood =</span> likelihood_v <span class="sc">*</span> likelihood_z) <span class="sc">|&gt;</span> </span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> z, <span class="at">y =</span> v, <span class="at">fill =</span> joint_likelihood)) <span class="sc">+</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="at">interpolate =</span> T) <span class="sc">+</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"B"</span>) <span class="sc">+</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Non-centered parameterization"</span>) <span class="sc">+</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>This is our version of the right-hand panel of McElreath’s Figure 13.5. No nasty funnel–just a friendly glowing likelihood orb.</p>
</section>
<section id="sec-Non-centered-chimpanzees" class="level3" data-number="13.4.2">
<h3 data-number="13.4.2" class="anchored" data-anchor-id="sec-Non-centered-chimpanzees"><span class="header-section-number">13.4.2</span> Non-centered chimpanzees</h3>
<p>At the top of the section, McElreath reported the <code>rethinking::ulam()</code> default is to set <code>adapt_delta = 0.95</code>. Readers should be aware that the <code>brms::brm()</code> default is <code>adapt_delta = 0.80</code>. A consequence of this difference is <code>rethinking::ulam()</code> will tend to take smaller step sizes than <code>brms::brm()</code>, at the cost of slower exploration of the posterior. I don’t know that one is inherently better than the other. They’re just defaults.</p>
<p>Recall that due to how <strong>brms</strong> only supports the non-centered parameterization, we have already fit our version of McElreath’s <code>m13.4nc</code>. We called it <code>b13.4</code>. Here is the model summary, again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b13<span class="fl">.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: pulled_left | trials(1) ~ a + b 
         a ~ 1 + (1 | actor) + (1 | block)
         b ~ 0 + treatment
   Data: d (Number of observations: 504) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~actor (Number of levels: 7) 
                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(a_Intercept)     2.02      0.65     1.08     3.61 1.00     1396     2247

~block (Number of levels: 6) 
                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(a_Intercept)     0.21      0.18     0.01     0.66 1.00     1700     1525

Regression Coefficients:
             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
a_Intercept      0.66      0.73    -0.80     2.15 1.01     1044     1758
b_treatment1    -0.13      0.30    -0.69     0.45 1.00     2548     3040
b_treatment2     0.40      0.30    -0.16     0.97 1.00     2740     2522
b_treatment3    -0.48      0.30    -1.05     0.11 1.00     2723     2820
b_treatment4     0.28      0.30    -0.29     0.86 1.00     2711     2626

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Because we only fit this model using the non-centered parameterization, we won’t be able to fully reproduce McElreath’s Figure 13.6. But we can still plot our effective sample sizes. Recall that unlike the way <strong>rethinking</strong> only reports <code>n_eff</code>, <strong>brms</strong> now reports both <code>Bulk_ESS</code> and <code>Tail_ESS</code> <span class="citation" data-cites="vehtariRanknormalizationFoldingLocalization2019">(see <a href="references.html#ref-vehtariRanknormalizationFoldingLocalization2019" role="doc-biblioref">Vehtari et al., 2019</a>)</span>. At the moment, <strong>brms</strong> does not offer a convenience function that allows users to collect those values in a data frame. However you can do so with help from the <a href="https://github.com/stan-dev/posterior"><strong>posterior</strong> package</a>. For our purposes, the function of interest is <code>summarise_draws()</code>, which will take the output from <code>as_draws_df()</code> as input.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(b13<span class="fl">.4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22 × 10
   variable                  mean median    sd   mad      q5     q95  rhat ess_bulk ess_tail
   &lt;chr&gt;                    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 b_a_Intercept            0.656  0.640 0.733 0.682 -0.530   1.87    1.01    1044.    1758.
 2 b_b_treatment1          -0.133 -0.136 0.295 0.303 -0.596   0.365   1.00    2548.    3040.
 3 b_b_treatment2           0.397  0.394 0.297 0.305 -0.0728  0.883   1.00    2740.    2522.
 4 b_b_treatment3          -0.475 -0.477 0.297 0.293 -0.963   0.0243  1.00    2723.    2820.
 5 b_b_treatment4           0.281  0.274 0.300 0.304 -0.204   0.784   1.00    2711.    2626.
 6 sd_actor__a_Intercept    2.02   1.92  0.648 0.555  1.19    3.28    1.00    1396.    2247.
 7 sd_block__a_Intercept    0.213  0.175 0.177 0.146  0.0176  0.540   1.00    1700.    1525.
 8 r_actor__a[1,Intercept] -1.02  -1.00  0.735 0.684 -2.25    0.166   1.01    1037.    1539.
 9 r_actor__a[2,Intercept]  4.05   3.86  1.37  1.19   2.21    6.49    1.00    2053.    2673.
10 r_actor__a[3,Intercept] -1.31  -1.29  0.745 0.692 -2.53   -0.133   1.00    1024.    1654.
# ℹ 12 more rows</code></pre>
</div>
</div>
<p>Note how the last three columns are the <code>rhat</code>, the <code>ess_bulk</code>, and the <code>ess_tail</code>. Here we summarize those two effective sample size columns in a scatter plot similar to Figure 13.6, but based only on our <code>b13.4</code>, which used the non-centered parameterization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(b13<span class="fl">.4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>() <span class="sc">|&gt;</span> </span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ess_bulk, <span class="at">y =</span> ess_tail)) <span class="sc">+</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">4700</span>) <span class="sc">+</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">4700</span>) <span class="sc">+</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Effective sample size summaries for b13.4"</span>,</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="st">"ess_bulk is on the x and ess_tail is on the y"</span>) <span class="sc">+</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fl">11.5</span>),</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title.position =</span> <span class="st">"plot"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>Both measures of effective sample size are fine.</p>
<blockquote class="blockquote">
<p>So should we always use the non-centered parameterization? No.&nbsp;Sometimes the centered form is better. It could even be true that the centered form is better for one cluster in a model while the non-centered form is better for another cluster in the same model. It all depends upon the details. Typically, a cluster with low variation, like the blocks in <code>m13.4</code>, will sample better with a non-centered prior. And if you have a large number of units inside a cluster, but not much data for each unit, then the non-centered is also usually better. But being able to switch back and forth as needed is very useful. (p.&nbsp;425)</p>
</blockquote>
<p>I won’t argue with McElreath, here. But if you run into a situation where you’d like to use the centered parameterization, you will have to use <strong>rethinking</strong> or fit your model directly in Stan. <strong>brms</strong> won’t support you, there.</p>
</section>
</section>
<section id="multilevel-posterior-predictions" class="level2 page-columns page-full" data-number="13.5">
<h2 data-number="13.5" class="anchored" data-anchor-id="multilevel-posterior-predictions"><span class="header-section-number">13.5</span> Multilevel posterior predictions</h2>
<blockquote class="blockquote">
<p>Every model is a merger of sense and nonsense. When we understand a model, we can find its sense and control its nonsense. But as models get more complex, it is very difficult to impossible to understand them just by inspecting tables of posterior means and intervals. Exploring implied posterior predictions helps much more….</p>
<p>The introduction of varying effects does introduce nuance, however.</p>
<p>First, we should no longer expect the model to exactly retrodict the sample, because adaptive regularization has as its goal to trade off poorer fit in sample for better inference and hopefully better fit out of sample. That is what shrinkage does for us. Of course, we should never be trying to really retrodict the sample. But now you have to expect that even a perfectly good model fit will differ from the raw data in a systematic way.</p>
<p>Second, “prediction” in the context of a multilevel model requires additional choices. If we wish to validate a model against the specific clusters used to fit the model, that is one thing. But if we instead wish to compute predictions for new clusters, other than the ones observed in the sample, that is quite another. We’ll consider each of these in turn, continuing to use the chimpanzees model from the previous section. (p.&nbsp;426)</p>
</blockquote>
<section id="posterior-prediction-for-same-clusters" class="level3" data-number="13.5.1">
<h3 data-number="13.5.1" class="anchored" data-anchor-id="posterior-prediction-for-same-clusters"><span class="header-section-number">13.5.1</span> Posterior prediction for same clusters</h3>
<p>Like McElreath did in the text, we’ll do this two ways. Recall we use <code>brms::fitted()</code> in place of <code>rethinking::link()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>chimp <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(treatment) <span class="sc">|&gt;</span> </span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">actor =</span> chimp,</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">block =</span> <span class="dv">1</span>)</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"R/N"</span>, <span class="st">"L/N"</span>, <span class="st">"R/P"</span>, <span class="st">"L/P"</span>)</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b13<span class="fl">.4</span>, <span class="at">newdata =</span> nd) <span class="sc">|&gt;</span> </span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(nd) <span class="sc">|&gt;</span> </span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">factor</span>(treatment, <span class="at">labels =</span> labels))</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Estimate  Est.Error      Q2.5     Q97.5 treatment actor block
1 0.9787165 0.02072611 0.9236727 0.9994928       R/N     2     1
2 0.9872600 0.01265721 0.9534633 0.9997033       L/N     2     1
3 0.9707194 0.02773709 0.8949614 0.9992587       R/P     2     1
4 0.9856789 0.01408381 0.9474881 0.9996992       L/P     2     1</code></pre>
</div>
</div>
<p>Here are the empirical probabilities computed directly from the data (i.e., the no-pooling model).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>chimp_2_d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(actor <span class="sc">==</span> chimp) <span class="sc">|&gt;</span> </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(treatment) <span class="sc">|&gt;</span> </span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">prob =</span> <span class="fu">mean</span>(pulled_left)) <span class="sc">|&gt;</span> </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">factor</span>(treatment, <span class="at">labels =</span> labels))</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>chimp_2_d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  treatment  prob
  &lt;fct&gt;     &lt;dbl&gt;
1 R/N           1
2 L/N           1
3 R/P           1
4 L/P           1</code></pre>
</div>
</div>
<p>McElreath didn’t show the corresponding plot in the text. It might look like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">|&gt;</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If you want to use `geom_line()` or `geom_ribbon()` with a factor on the x-axis,</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># you need to code something like `group = 1` in `aes()`</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> Estimate, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>), <span class="at">fill =</span> <span class="st">"orange1"</span>) <span class="sc">+</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> chimp_2_d,</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> prob),</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"grey25"</span>) <span class="sc">+</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Chimp #2"</span>,</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="st">"The posterior mean and 95%</span><span class="sc">\n</span><span class="st">intervals are the blue line</span><span class="sc">\n</span><span class="st">and orange band, respectively.</span><span class="sc">\n</span><span class="st">The empirical means are</span><span class="sc">\n</span><span class="st">the charcoal dots."</span>) <span class="sc">+</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.75</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Do note how severely we’ve restricted the <span class="math inline">\(y\)</span>-axis range. But okay, now let’s do things by hand. We’ll need to extract the posterior draws and look at the structure of the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(b13<span class="fl">.4</span>)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(post)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,000
Columns: 25
$ b_a_Intercept             &lt;dbl&gt; 0.48479855, 1.10261828, 1.32414097, 0.61872027, 0.68580252, 1.82688159, 1.80901729, 0.45746781…
$ b_b_treatment1            &lt;dbl&gt; -0.6187074919, -0.3437486176, 0.0804279731, -0.1390937124, -0.6857561819, -0.0848117344, -0.36…
$ b_b_treatment2            &lt;dbl&gt; 0.1383289310, 0.3904019777, 0.8951058613, 0.7557796742, -0.0395914687, 0.4286274552, 0.2005432…
$ b_b_treatment3            &lt;dbl&gt; -0.30576782, -0.91277692, -0.36259023, -0.42106581, -0.59420320, -0.84186871, -0.34092465, -0.…
$ b_b_treatment4            &lt;dbl&gt; 0.146705426, 0.079166983, 0.624069604, 0.666658493, -0.115511484, 0.477890020, -0.137705935, 0…
$ sd_actor__a_Intercept     &lt;dbl&gt; 1.6082309, 1.8679855, 2.0615517, 1.9206350, 2.1149926, 1.4807693, 1.2881741, 0.8924760, 1.7975…
$ sd_block__a_Intercept     &lt;dbl&gt; 0.074252910, 0.042437439, 0.194326596, 0.285374450, 0.038305713, 0.113925096, 0.171021798, 0.0…
$ `r_actor__a[1,Intercept]` &lt;dbl&gt; -0.66821389, -1.57806473, -1.58218761, -1.18241690, -0.62033699, -1.99190528, -1.45665994, -0.…
$ `r_actor__a[2,Intercept]` &lt;dbl&gt; 4.105414, 3.308461, 4.612588, 3.230853, 3.729072, 2.707005, 2.705277, 2.154973, 4.305520, 2.22…
$ `r_actor__a[3,Intercept]` &lt;dbl&gt; -0.9143057, -1.2672703, -2.2543003, -1.4780342, -0.9916124, -2.1684133, -2.0672630, -1.4486659…
$ `r_actor__a[4,Intercept]` &lt;dbl&gt; -1.1743512, -1.7493985, -2.2260619, -1.3978979, -0.8812848, -2.6113931, -2.1385626, -1.6201558…
$ `r_actor__a[5,Intercept]` &lt;dbl&gt; -0.45998857, -1.24893388, -1.85653184, -1.55547356, -0.34322624, -1.73311239, -1.98902409, -1.…
$ `r_actor__a[6,Intercept]` &lt;dbl&gt; -0.01434108, -0.05977793, -1.17631349, -0.07773770, 0.09858990, -1.21145376, -1.04737339, -0.5…
$ `r_actor__a[7,Intercept]` &lt;dbl&gt; 1.6095004, 1.1279427, 0.6975524, 1.3489876, 1.7953747, 0.4297830, 0.2385079, 1.1316119, 0.6575…
$ `r_block__a[1,Intercept]` &lt;dbl&gt; 0.059474740, 0.027987751, -0.412821873, -0.463421465, 0.041109921, -0.280710383, -0.174172714,…
$ `r_block__a[2,Intercept]` &lt;dbl&gt; -0.1268652689, -0.0881593460, 0.4228474840, 0.6300555403, -0.0732821086, 0.0897455161, -0.0486…
$ `r_block__a[3,Intercept]` &lt;dbl&gt; 0.0640009759, -0.0256565570, 0.1511196316, -0.0563593557, 0.0045955296, -0.1136581086, -0.0103…
$ `r_block__a[4,Intercept]` &lt;dbl&gt; -0.097988227, 0.005712426, -0.026642650, 0.081390947, -0.014328158, 0.045720819, -0.021047199,…
$ `r_block__a[5,Intercept]` &lt;dbl&gt; 0.068321777, 0.042586015, -0.126076880, 0.078935454, -0.030331945, 0.129920020, -0.226338339, …
$ `r_block__a[6,Intercept]` &lt;dbl&gt; -0.0353906554, -0.0095662871, 0.1492559810, 0.3984556679, -0.0432118567, -0.0878467838, 0.4374…
$ lprior                    &lt;dbl&gt; -4.996182, -6.628174, -7.530316, -6.943208, -6.161883, -6.820002, -5.026128, -7.037665, -5.663…
$ lp__                      &lt;dbl&gt; -289.2636, -287.2589, -286.9593, -285.7644, -286.7215, -291.4669, -291.5642, -299.4945, -289.0…
$ .chain                    &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ .iteration                &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26,…
$ .draw                     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26,…</code></pre>
</div>
</div>
<p>McElreath didn’t show what his <strong>R</strong> code 13.33 <code>dens( post$a[,5] )</code> would look like. But here’s our analogue.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>post <span class="sc">|&gt;</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">actor_5 =</span> <span class="st">`</span><span class="at">r_actor__a[5,Intercept]</span><span class="st">`</span>) <span class="sc">|&gt;</span> </span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actor_5)) <span class="sc">+</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">linewidth =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Chimp #5's density"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>And because we made the density only using the <code>r_actor__a[5,Intercept]</code> values (i.e., we didn’t add <code>b_Intercept</code> to them), the density is in a deviance-score metric.</p>
<p>McElreath built his own <code>link()</code> function in <strong>R</strong> code 13.34. With this particular model, it will be easiest for us to just work directly with <code>post</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> post <span class="sc">|&gt;</span> </span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(b_b_treatment1<span class="sc">:</span>b_b_treatment4) <span class="sc">|&gt;</span> </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> <span class="fu">plogis</span>(b_a_Intercept <span class="sc">+</span> value <span class="sc">+</span> <span class="st">`</span><span class="at">r_actor__a[1,Intercept]</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">r_block__a[1,Intercept]</span><span class="st">`</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">factor</span>(<span class="fu">str_remove</span>(name, <span class="st">"b_b_treatment"</span>),</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">labels =</span> labels)) <span class="sc">|&gt;</span> </span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name<span class="sc">:</span>treatment)</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16,000 × 4
   name             value fitted treatment
   &lt;chr&gt;            &lt;dbl&gt;  &lt;dbl&gt; &lt;fct&gt;    
 1 b_b_treatment1 -0.619   0.322 R/N      
 2 b_b_treatment2  0.138   0.504 L/N      
 3 b_b_treatment3 -0.306   0.394 R/P      
 4 b_b_treatment4  0.147   0.506 L/P      
 5 b_b_treatment1 -0.344   0.312 R/N      
 6 b_b_treatment2  0.390   0.486 L/N      
 7 b_b_treatment3 -0.913   0.204 R/P      
 8 b_b_treatment4  0.0792  0.409 L/P      
 9 b_b_treatment1  0.0804  0.357 R/N      
10 b_b_treatment2  0.895   0.556 L/N      
# ℹ 15,990 more rows</code></pre>
</div>
</div>
<p>Now we’ll summarize those values and compute their empirical analogues directly from the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> f <span class="sc">|&gt;</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(treatment) <span class="sc">|&gt;</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    tidybayes<span class="sc">::</span><span class="fu">mean_qi</span>(fitted)</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 7
  treatment fitted .lower .upper .width .point .interval
  &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 R/N        0.343  0.198  0.497   0.95 mean   qi       
2 L/N        0.467  0.289  0.631   0.95 mean   qi       
3 R/P        0.272  0.149  0.421   0.95 mean   qi       
4 L/P        0.439  0.269  0.607   0.95 mean   qi       </code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The empirical summaries</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>chimp <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  chimp_5_d <span class="ot">&lt;-</span>d <span class="sc">|&gt;</span> </span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(actor <span class="sc">==</span> chimp) <span class="sc">|&gt;</span> </span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(treatment) <span class="sc">|&gt;</span> </span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">prob =</span> <span class="fu">mean</span>(pulled_left)) <span class="sc">|&gt;</span> </span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">factor</span>(treatment, <span class="at">labels =</span> labels))</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  treatment  prob
  &lt;fct&gt;     &lt;dbl&gt;
1 R/N       0.333
2 L/N       0.556
3 R/P       0.278
4 L/P       0.5  </code></pre>
</div>
</div>
<p>Okay, let’s see how good we are at retrodicting the <code>pulled_left</code> probabilities for <code>actor == 5</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">|&gt;</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> fitted, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> .lower, <span class="at">ymax =</span> .upper), </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"orange1"</span>) <span class="sc">+</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> chimp_5_d,</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> prob),</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"grey25"</span>) <span class="sc">+</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Chimp #5"</span>,</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="st">"This plot is like the last except</span><span class="sc">\n</span><span class="st">we did more by hand."</span>) <span class="sc">+</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Not bad.</p>
</section>
<section id="posterior-prediction-for-new-clusters" class="level3 page-columns page-full" data-number="13.5.2">
<h3 data-number="13.5.2" class="anchored" data-anchor-id="posterior-prediction-for-new-clusters"><span class="header-section-number">13.5.2</span> Posterior prediction for new clusters</h3>
<p>By average actor, McElreath referred to a chimp with an intercept exactly at the population mean <span class="math inline">\(\bar \alpha\)</span>. Given our non-centered parameterization for <code>b13.4</code>, this means we’ll leave out the random effects for <code>actor</code>. Since we’re predicting what might happen in new experimental blocks, we’ll leave out the random effects for <code>block</code>, too. When doing this by hand, the workflow is much like is was before, just with fewer columns added together within the first <code>mutate()</code> line.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> post <span class="sc">|&gt;</span> </span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(b_b_treatment1<span class="sc">:</span>b_b_treatment4) <span class="sc">|&gt;</span> </span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> <span class="fu">plogis</span>(b_a_Intercept <span class="sc">+</span> value)) <span class="sc">|&gt;</span> </span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">factor</span>(<span class="fu">str_remove</span>(name, <span class="st">"b_b_treatment"</span>),</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">labels =</span> labels)) <span class="sc">|&gt;</span> </span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name<span class="sc">:</span>treatment) <span class="sc">|&gt;</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(treatment) <span class="sc">|&gt;</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note we're using 80% intervals</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_qi</span>(fitted, <span class="at">.width =</span> <span class="fl">0.8</span>)</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 7
  treatment fitted .lower .upper .width .point .interval
  &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 R/N        0.615  0.406  0.808    0.8 mean   qi       
2 L/N        0.721  0.542  0.877    0.8 mean   qi       
3 R/P        0.540  0.326  0.743    0.8 mean   qi       
4 L/P        0.699  0.509  0.864    0.8 mean   qi       </code></pre>
</div>
</div>
<p>Make Figure 13.7.a.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> f <span class="sc">|&gt;</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> fitted, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> .lower, <span class="at">ymax =</span> .upper), </span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"orange1"</span>) <span class="sc">+</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Average actor"</span>) <span class="sc">+</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>If we want to depict the variability across the chimps, we need to include <code>sd_actor__a_Intercept</code> into the calculations. In the first block of code, below, we simulate a bundle of new intercepts defined by</p>
<p><span class="math display">\[\text{simulated chimpanzees} \sim \operatorname{Normal}(\bar \alpha, \sigma_\alpha).\]</span></p>
<p>As before, we are also averaging over <code>block</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> post <span class="sc">|&gt;</span> </span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulated chimpanzees</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">a_sim =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="at">mean =</span> b_a_Intercept, <span class="at">sd =</span> sd_actor__a_Intercept)) <span class="sc">|&gt;</span> </span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(b_b_treatment1<span class="sc">:</span>b_b_treatment4) <span class="sc">|&gt;</span> </span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> <span class="fu">plogis</span>(a_sim <span class="sc">+</span> value)) <span class="sc">|&gt;</span> </span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">factor</span>(<span class="fu">str_remove</span>(name, <span class="st">"b_b_treatment"</span>),</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">labels =</span> labels)) <span class="sc">|&gt;</span> </span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(treatment) <span class="sc">|&gt;</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note we're using 80% intervals</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_qi</span>(fitted, <span class="at">.width =</span> <span class="fl">0.8</span>)</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 7
  treatment fitted .lower .upper .width .point .interval
  &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 R/N        0.573 0.103   0.961    0.8 mean   qi       
2 L/N        0.649 0.160   0.977    0.8 mean   qi       
3 R/P        0.523 0.0745  0.946    0.8 mean   qi       
4 L/P        0.633 0.144   0.974    0.8 mean   qi       </code></pre>
</div>
</div>
<p>Behold Figure 13.7.b.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> f <span class="sc">|&gt;</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> fitted, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> .lower, <span class="at">ymax =</span> .upper), </span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"orange1"</span>) <span class="sc">+</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Marginal of actor"</span>) <span class="sc">+</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>The big difference between this workflow and the last is now we start of by marking off the rows in <code>post</code> with an <code>iter</code> index and then use <code>slice_sample()</code> to randomly sample 100 posterior rows. We also omit the <code>group_by()</code> and <code>mean_qi()</code> lines at the end.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many simulated chimps would you like?</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>n_chimps <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> post <span class="sc">|&gt;</span> </span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> n_chimps) <span class="sc">|&gt;</span> </span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulated chimpanzees</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">a_sim =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="at">mean =</span> b_a_Intercept, <span class="at">sd =</span> sd_actor__a_Intercept)) <span class="sc">|&gt;</span> </span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(b_b_treatment1<span class="sc">:</span>b_b_treatment4) <span class="sc">|&gt;</span> </span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> <span class="fu">plogis</span>(a_sim <span class="sc">+</span> value)) <span class="sc">|&gt;</span> </span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">str_remove</span>(name, <span class="st">"b_b_treatment"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>           <span class="fu">factor</span>(<span class="at">labels =</span> labels)) <span class="sc">|&gt;</span> </span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.draw<span class="sc">:</span>treatment)</span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 400 × 6
   .draw  a_sim name             value fitted treatment
   &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;            &lt;dbl&gt;  &lt;dbl&gt; &lt;fct&gt;    
 1  1496 -4.54  b_b_treatment1  0.242  0.0134 R/N      
 2  1496 -4.54  b_b_treatment2  0.851  0.0243 L/N      
 3  1496 -4.54  b_b_treatment3  0.0924 0.0115 R/P      
 4  1496 -4.54  b_b_treatment4  0.664  0.0202 L/P      
 5  3843  0.475 b_b_treatment1 -0.834  0.411  R/N      
 6  3843  0.475 b_b_treatment2 -0.261  0.553  L/N      
 7  3843  0.475 b_b_treatment3 -0.999  0.372  R/P      
 8  3843  0.475 b_b_treatment4 -0.0949 0.594  L/P      
 9   960  2.21  b_b_treatment1 -0.594  0.834  R/N      
10   960  2.21  b_b_treatment2  0.303  0.925  L/N      
# ℹ 390 more rows</code></pre>
</div>
</div>
<p>Make Figure 13.7.c.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> f <span class="sc">|&gt;</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> fitted, <span class="at">group =</span> .draw)) <span class="sc">+</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"orange3"</span>) <span class="sc">+</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"100 simulated actors"</span>) <span class="sc">+</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>For the finale, we’ll combine the three plots with <strong>patchwork</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">|</span> p2 <span class="sc">|</span> p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid figure-img" width="720"></p>
</figure>
</div>
</div>
</div>
<section id="sec-Lets-use-fitted-this-time" class="level4 page-columns page-full" data-number="13.5.2.1">
<h4 data-number="13.5.2.1" class="anchored" data-anchor-id="sec-Lets-use-fitted-this-time"><span class="header-section-number">13.5.2.1</span> Bonus: Let’s use <code>fitted()</code> this time</h4>
<p>We just made those plots using various wrangled versions of <code>post</code>, the data frame returned by <code>as_draws_df(b.13.4)</code>. If you followed along closely, part of what made that a great exercise is that it forced you to consider what the various vectors in <code>post</code> meant with respect to the model formula. But it’s also handy to see how to do that from a different perspective. So in this section, we’ll repeat that process by relying on the <code>fitted()</code> function, instead. We’ll go in the same order, starting with the average actor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">distinct</span>(d, treatment)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b13<span class="fl">.4</span>,</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">newdata =</span> nd,</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">re_formula =</span> <span class="cn">NA</span>,</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(nd) <span class="sc">|&gt;</span> </span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">factor</span>(treatment, <span class="at">labels =</span> labels))</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Estimate Est.Error       Q10       Q90 treatment
1 0.6148421 0.1542169 0.4061214 0.8076083       R/N
2 0.7206447 0.1343735 0.5415473 0.8766787       L/N
3 0.5401932 0.1600461 0.3258537 0.7426736       R/P
4 0.6986064 0.1398025 0.5087745 0.8641619       L/P</code></pre>
</div>
</div>
<p>You should notice a few things. Since <code>b13.4</code> is a cross-classified multilevel model, it had three predictors: <code>treatment</code>, <code>block</code>, and <code>actor</code>. However, our <code>nd</code> data only included the first of those three. The reason <code>fitted()</code> permitted that was because we set <code>re_formula = NA</code>. When you do that, you tell <code>fitted()</code> to ignore group-level effects (i.e., focus only on the fixed effects). This was our <code>fitted()</code> version of ignoring the <code>r_</code> vectors returned by <code>as_draws_df()</code>. Here’s the plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> f <span class="sc">|&gt;</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> Estimate, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q10, <span class="at">ymax =</span> Q90), </span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"orange1"</span>) <span class="sc">+</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Average actor"</span>) <span class="sc">+</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>p4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>For marginal of actor, we can continue using the same <code>nd</code> data. This time we’ll be sticking with the default <code>re_formula</code> setting, which will accommodate the multilevel nature of the model. However, we’ll also be adding <code>allow_new_levels = T</code> and <code>sample_new_levels = "gaussian"</code>. The former will allow us to marginalize across the specific actors and blocks in our data and the latter will instruct <code>fitted()</code> to use the multivariate normal distribution implied by the random effects. It’ll make more sense why I say <em>multivariate</em> normal by the end of <a href="14.html" class="quarto-xref"><span>Chapter 14</span></a>. For now, just go with it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b13<span class="fl">.4</span>,</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">newdata =</span> nd,</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>),</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">allow_new_levels =</span> T,</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">sample_new_levels =</span> <span class="st">"gaussian"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(nd) <span class="sc">|&gt;</span> </span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">factor</span>(treatment, <span class="at">labels =</span> labels))</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Estimate Est.Error        Q10       Q90 treatment
1 0.5816443 0.3179784 0.09565353 0.9656763       R/N
2 0.6549381 0.3046262 0.15049058 0.9799405       L/N
3 0.5325079 0.3226019 0.06762004 0.9541468       R/P
4 0.6392903 0.3080312 0.13923280 0.9779486       L/P</code></pre>
</div>
</div>
<p>Here’s our <code>fitted()</code>-based marginal of <code>actor</code> plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> f <span class="sc">|&gt;</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> Estimate, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q10, <span class="at">ymax =</span> Q90), </span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"orange1"</span>) <span class="sc">+</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Marginal of actor"</span>) <span class="sc">+</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>p5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>We’ll have to amend our workflow a bit to make a <code>fitted()</code> version of the third panel. First we redefine our <code>nd</code> data and execute the <code>fitted()</code> code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many simulated chimps would you like?</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>n_chimps <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">distinct</span>(d, treatment) <span class="sc">|&gt;</span> </span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define 100 new actors</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">actor =</span> <span class="fu">str_c</span>(<span class="st">"new"</span>, <span class="dv">1</span><span class="sc">:</span>n_chimps)) <span class="sc">|&gt;</span> </span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(actor, treatment) <span class="sc">|&gt;</span> </span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This adds a row number, which will come in handy, later</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitted</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b13<span class="fl">.4</span>,</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">newdata =</span> nd,</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">allow_new_levels =</span> T,</span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">sample_new_levels =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">summary =</span> F,</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">ndraws =</span> n_chimps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our <code>f</code> object will need a lot of wrangling. Before I walk out the wrangling steps, we should reiterate what McElreath originally did in the text (pp.&nbsp;429–430). He based the new actors on the deviation scores from <code>post$sigma_a</code>. That was the first working line in his <strong>R</strong> code 13.38. In the remaining lines in that code block, he used the model formula to compute the actor-level trajectories. Then in his plot code in <strong>R</strong> code 13.39, he just used the first 100 rows from that output.</p>
<p>In our <code>fitted()</code> code, above, we saved a little time and computer memory by setting <code>ndraws = n_chimps</code>, which equaled 100. That’s functionally the same as when McElreath used the first 100 posterior draws in the plot. A difficulty for us is the way <code>brms::fitted()</code> returns the output, the 100 new levels of <code>actor</code> and the four levels of <code>treatment</code> are confounded in the 400 columns. In the code block, below, the <code>data.frame()</code> through <code>left_join()</code> lines are meant to disentangle those two. After that, we’ll make an <code>actor_number</code> variable, which which we’ll filter the data such that the first row returned by <code>fitted()</code> is only assigned to the new actor #1, the second row is only assigned to the new actor #2, and so on. The result is that we have 100 new simulated actors, each of which corresponds to a different iteration of the posterior draws from the fixed effects.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;The <code>fitted()</code> version of the code for the third panel is cumbersome. Indeed, this in one of those cases where it seems more straightforward to work directly with the <code>as_draws_df()</code> output, rather than with <code>fitted()</code>. The workflow in this section from previous editions of this ebook was more streamlined and superficially seemed to work. However, fellow researcher <a href="https://twitter.com/lnalborczyk">Ladislas Nalborczyk</a> kindly pointed out I was taking 100 draws from one new simulated <code>actor</code>, rather than one simulated draw from 100 new levels of <code>actor</code>. To my knowledge, if you want 100 new levels of <code>actor</code> AND want each one to be from a different posterior iteration, you’ll need a lot of post-processing code when working with <code>fitted()</code>.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> f <span class="sc">|&gt;</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Name the columns by the `row` values in `nd`</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">pull</span>(nd, row)) <span class="sc">|&gt;</span> </span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a draw index</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">draw =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make it long</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>draw, <span class="at">names_to =</span> <span class="st">"row"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">as.double</span>(row)) <span class="sc">|&gt;</span> </span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the new data</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(nd, <span class="at">by =</span> <span class="st">"row"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the numbers from the names of the new actors</span></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">actor_number =</span> <span class="fu">str_extract</span>(actor, <span class="st">"</span><span class="sc">\\</span><span class="st">d+"</span>) <span class="sc">|&gt;</span> <span class="fu">as.double</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Only keep the posterior iterations that match the `actor_number` values</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(actor_number <span class="sc">==</span> draw) <span class="sc">|&gt;</span> </span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the `treatment` labels</span></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">factor</span>(treatment, <span class="at">labels =</span> labels)) <span class="sc">|&gt;</span> </span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot!</span></span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> value, <span class="at">group =</span> actor)) <span class="sc">+</span></span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"100 simulated actors"</span>) <span class="sc">+</span></span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb122-24"><a href="#cb122-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-25"><a href="#cb122-25" aria-hidden="true" tabindex="-1"></a>p6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Here they are altogether.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>p4 <span class="sc">|</span> p5 <span class="sc">|</span> p6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-72-1.png" class="img-fluid figure-img" width="720"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-Post-stratification" class="level3" data-number="13.5.3">
<h3 data-number="13.5.3" class="anchored" data-anchor-id="sec-Post-stratification"><span class="header-section-number">13.5.3</span> Post-stratification</h3>
<p>If you have estimates <span class="math inline">\(p_i\)</span> for each relevant demographic category <span class="math inline">\(i\)</span>, the post-stratified prediction for the whole population just re-weights these estimates using the number of individuals <span class="math inline">\(N_i\)</span> in each category with the formula</p>
<p><span class="math display">\[\frac{\sum_i N_i p_i}{\sum_i N_i}.\]</span></p>
<p>You can find a more comprehensive introduction to post-stratification in Chapter 17 of <span class="citation" data-cites="gelmanRegressionOtherStories2020">Gelman et al. (<a href="references.html#ref-gelmanRegressionOtherStories2020" role="doc-biblioref">2020</a>)</span>. Within the multilevel context, this is approach is called <strong>multilevel regression and post-stratification</strong> (MRP, pronounced “Mister P”). Gelman is a long-time advocate for MRP <span class="citation" data-cites="gelmanPostratificationManyCategories1997 parkBayesianMultilevelEstimation2004">(e.g., <a href="references.html#ref-gelmanPostratificationManyCategories1997" role="doc-biblioref">Gelman &amp; Little, 1997</a>; <a href="references.html#ref-parkBayesianMultilevelEstimation2004" role="doc-biblioref">Park et al., 2004</a>)</span>. He mentions MRP a lot in his blog (e.g., <a href="https://statmodeling.stat.columbia.edu/2019/01/10/mrp-multilevel-regression-poststratification-mister-p-clearing-misunderstandings/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2019/11/09/australian-polls-failed-they-didnt-do-mister-p/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2019/07/27/the-economist-does-mister-p/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2019/05/14/scandal-mrp-appears-in-british-tabloid/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2019/03/25/mister-p-surveys-epidemiology-using-stan/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2016/10/12/31398/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2016/09/09/q-is-a-50-state-poll-as-good-as-50-state-polls-a-use-mister-p/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2016/06/12/29344/">here</a>).</p>
</section>
</section>
<section id="summary-bonus-post-stratification-in-an-example" class="level2" data-number="13.6">
<h2 data-number="13.6" class="anchored" data-anchor-id="summary-bonus-post-stratification-in-an-example"><span class="header-section-number">13.6</span> <del>Summary</del> Bonus: Post-stratification in an example</h2>
<p>Though I was excited to see McElreath introduce MRP, I was disappointed he did not work through an example. Happily, MRP tutorials have been popping up all over the place online. In this bonus section, we’ll draw heavily from the great blog post from demographer <a href="https://www.monicaalexander.com/">Monica Alexander</a>, <a href="https://www.monicaalexander.com/posts/2019-08-07-mrp/"><em>Analyzing name changes after marriage using a non-representative survey</em></a>. From the introduction of her post, we read:</p>
<blockquote class="blockquote">
<p>Recently on Twitter, sociologist <a href="https://socy.umd.edu/facultyprofile/cohen/philip-n">Phil Cohen</a> put out a survey asking people about their decisions to change their name (or not) after marriage. The response was impressive - there are currently over 5,000 responses. Thanks to Phil, the data from the survey are publicly available and downloadable <a href="https://osf.io/uzqdn/">here</a> for anyone to do their own analysis.</p>
<p>However, there’s an issue with using the raw data without lots of caveats: the respondents are not very representative of the broader population, and in particular tend to have a higher education level and are younger than average….</p>
<p>This is a very common problem for social scientists: trying to come up with representative estimates using non-representative data. In this post I’ll introduce one particular technique of trying to do this: multilevel regression and post-stratification (MRP). In particular, I’ll use data from the marital name change survey to estimate the proportion of women in the US who kept their maiden name after marriage.</p>
</blockquote>
<section id="meet-the-data" class="level3" data-number="13.6.1">
<h3 data-number="13.6.1" class="anchored" data-anchor-id="meet-the-data"><span class="header-section-number">13.6.1</span> Meet the data</h3>
<p>Alexander used two data sources in her example. As alluded to in the block quote, above, she used a subset of the data from Cohen’s Twitter poll. She derived her post-stratification weights from the 2017 5-year ACS data from <a href="https://usa.ipums.org/usa/index.shtml">IPUMS-USA</a>, which provides U.S. census data for research use. Alexander provided some of her data wrangling code in her post and her full <strong>R</strong> code is available on her GitHub repo, <a href="https://github.com/MJAlexander/marriage-name-change">marriage-name-change</a>. For the sake of space, I downloaded the data, wrangled them similarly to how they were used in her blog, and saved the tidied data as external files in my <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/tree/master/data">data folder</a> on GitHub. You can download them from there.</p>
<p>Load the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/mrp_data_ch13.rds"</span>)</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,413
Columns: 5
$ kept_name      &lt;dbl&gt; 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, …
$ state_name     &lt;chr&gt; "ohio", "virginia", "new york", "rhode island", "illinois", "north carolina", "iowa", "texas", "south dak…
$ age_group      &lt;chr&gt; "50", "35", "35", "55", "35", "25", "35", "35", "35", "35", "40", "35", "30", "30", "45", "45", "30", "40…
$ decade_married &lt;chr&gt; "1979", "1999", "2009", "1999", "2009", "2009", "1999", "2009", "1999", "2009", "2009", "2009", "2009", "…
$ educ_group     &lt;chr&gt; "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", "&gt;BA", …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(cell_counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 6,058
Columns: 5
$ state_name     &lt;chr&gt; "alabama", "alabama", "alabama", "alabama", "alabama", "alabama", "alaska", "alaska", "alaska", "alaska",…
$ age_group      &lt;chr&gt; "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25…
$ decade_married &lt;chr&gt; "1999", "2009", "1999", "2009", "1999", "2009", "1999", "2009", "1999", "2009", "1999", "2009", "1999", "…
$ educ_group     &lt;chr&gt; "&lt;BA", "&lt;BA", "&gt;BA", "&gt;BA", "BA", "BA", "&lt;BA", "&lt;BA", "&gt;BA", "&gt;BA", "BA", "BA", "&lt;BA", "&lt;BA", "&gt;BA", "&gt;BA…
$ n              &lt;dbl&gt; 19012, 37488, 959, 5319, 2986, 14261, 3320, 7001, 159, 435, 341, 2660, 23279, 45477, 1105, 6229, 3994, 16…</code></pre>
</div>
</div>
<p>Our primary data file, which contains the survey responses to whether women changed their names after marriage, is <code>d</code>. Our criterion variable will be <code>kept_name</code>, which is dummy coded 0 = “no” 1 = “yes.” We have four grouping variables:</p>
<ul>
<li><code>age_group</code>, which ranges from 25 to 75 and is discretized such that 25 = [25, 30), 30 = [30, 35), and so on;</li>
<li><code>decade_married</code>, which ranges from 1979 to 2019 and is discretized such that 1979 = [1979, 1989), 1989 = [1989, 1999), and so on;</li>
<li><code>educ_group</code>, which is coded as &lt;BA = no bachelor’s degree, BA = bachelor’s degree, and &gt;BA = above a bachelor’s degree; and</li>
<li><code>state_name</code>, which includes the names of the 50 US states, the District of Columbia, and Puerto Rico.</li>
</ul>
<p>The <code>cell_counts</code> data contains the relevant information from the US census. The first four columns, <code>state_name</code>, <code>age_group</code>, <code>decade_married</code>, and <code>educ_group</code> are the same demographic categories from the survey data. The fifth column, <code>n</code>, has the counts of women falling within those categories from the US census. There were 6,058 unique combinations of the demographic categories represented in the census data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>cell_counts <span class="sc">|&gt;</span> <span class="fu">count</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
      n
  &lt;int&gt;
1  6058</code></pre>
</div>
</div>
<p>We can use a histogram to get a sense of how those counts vary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>cell_counts <span class="sc">|&gt;</span> </span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n)) <span class="sc">+</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">2000</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span> <span class="sc">*</span> <span class="dv">100000</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="st">"100K"</span>, <span class="st">"200K"</span>, <span class="st">"300K"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Though some of the categories are large with an excess of 100,000 persons in them, many are fairly small. It seems unlikely that the women who participated in Cohen’s Twitter poll fell into these categories in the same proportions. This is where post-stratification will help.</p>
</section>
<section id="settle-the-mr-part-of-mrp" class="level3" data-number="13.6.2">
<h3 data-number="13.6.2" class="anchored" data-anchor-id="settle-the-mr-part-of-mrp"><span class="header-section-number">13.6.2</span> Settle the MR part of MRP</h3>
<p>Like in the earlier examples in this chapter, we will model the data with multilevel logistic regression. Alexander fit her model with <strong>brms</strong> and kept things simple by using default priors. Here we’ll continue on with McElreath’s recommendations and use weakly regularizing priors. Though I am no expert on the topic of women’s name-changing practices following marriage, my layperson’s sense is that most do not keep their maiden name after they marry. I’m not quite sure what the proportion might be, but I’d like my <span class="math inline">\(\bar \alpha\)</span> prior to tend closer to 0 than to 1. Recall that the <span class="math inline">\(\bar \alpha\)</span> for a multilevel logistic model is typically a Gaussian set on the log-odds scale. If we were to use <span class="math inline">\(\operatorname{Normal}(-1, 1)\)</span>, here’s what that would look like when converted back to the probability metric.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">n =</span> <span class="fu">rnorm</span>(<span class="fl">1e6</span>, <span class="at">mean =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">sd =</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">plogis</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> p)) <span class="sc">+</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="fl">0.02</span>, <span class="at">boundary =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-76-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>To my eye, this looks like a good place to start. Feel free to experiment with different priors on your end. As to the hierarchical <span class="math inline">\(\sigma_\text{&lt;group&gt;}\)</span> priors, we will continue our practice of setting them to <span class="math inline">\(\operatorname{Exponential}(1)\)</span>. Here’s how to fit the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>b13<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>  kept_name <span class="sc">|</span> <span class="fu">trials</span>(<span class="dv">1</span>) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> age_group) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> decade_married) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> educ_group) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> state_name),</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sd)),</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.95</span>),</span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/b13.07"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note how, like Alexander did in the blog, we had to adjust the <code>adept_delta</code> setting to stave off a few divergent transitions. In my experience, this is common when your hierarchical grouping variables have few levels. Our <code>decade_married</code> has five levels and <code>educ_group</code> has only four. Happily, <code>brms::brm()</code> came through in the end. You can see by checking the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b13<span class="fl">.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: kept_name | trials(1) ~ 1 + (1 | age_group) + (1 | decade_married) + (1 | educ_group) + (1 | state_name) 
   Data: d (Number of observations: 4373) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~age_group (Number of levels: 11) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.15      0.30     0.71     1.85 1.00     1289     2195

~decade_married (Number of levels: 5) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.00      0.39     0.50     1.94 1.00     1757     2559

~educ_group (Number of levels: 4) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     0.91      0.47     0.36     2.19 1.00     1813     2602

~state_name (Number of levels: 52) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     0.25      0.06     0.15     0.38 1.00     1180     2246

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept    -0.73      0.62    -1.96     0.47 1.00     1489     2364

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Even with 4,373 cases in the data, the uncertainty around <span class="math inline">\(\bar \alpha\)</span> is massive, -0.73 [-1.96, 0.47], suggesting a lot of the action is lurking in the <span class="math inline">\(\sigma_\text{&lt;group&gt;}\)</span> parameters. It might be easier to compare the <span class="math inline">\(\sigma_\text{&lt;group&gt;}\)</span> parameters with an interval plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(b13<span class="fl">.7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"sd_"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">str_c</span>(<span class="st">"sigma["</span>, <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"decade~married"</span>, <span class="st">"education"</span>, <span class="st">"state"</span>), <span class="st">"]"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median_qi</span>(<span class="at">.width =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.5</span>, <span class="at">to =</span> <span class="fl">0.9</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">xmin =</span> .lower, <span class="at">xmax =</span> .upper, <span class="at">y =</span> <span class="fu">reorder</span>(name, value))) <span class="sc">+</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_interval</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> .width), </span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"orange3"</span>) <span class="sc">+</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> ggplot2<span class="sc">:::</span>parse_safe) <span class="sc">+</span></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_continuous</span>(<span class="st">"CI width"</span>, <span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.15</span>)) <span class="sc">+</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-78-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>It seems the largest share of the variation is to be found among the age groups. Since there was relatively less variation across states, we can expect more aggressive regularization along those lines.</p>
</section>
<section id="post-stratify-to-put-the-p-in-mrp" class="level3" data-number="13.6.3">
<h3 data-number="13.6.3" class="anchored" data-anchor-id="post-stratify-to-put-the-p-in-mrp"><span class="header-section-number">13.6.3</span> Post-stratify to put the P in MRP</h3>
<p>In her post, Alexander contrasted the MRP results with the empirical proportions from the Twitter survey in a series of four plots, one for each of the four grouping variables. We will take a slightly different approach. For simplicity, we will only focus on the results for <code>age_group</code> and <code>state</code>. However, we will examine the results for each using three estimation methods: the empirical proportions, the naïve results from the multilevel model, and the MRP estimates.</p>
<section id="estimates-by-age-group" class="level4" data-number="13.6.3.1">
<h4 data-number="13.6.3.1" class="anchored" data-anchor-id="estimates-by-age-group"><span class="header-section-number">13.6.3.1</span> Estimates by age group</h4>
<p>To warm up, here is the plot of the empirical proportions for <code>kept_name</code>, by <code>age_group</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"raw data"</span>, <span class="st">"multilevel"</span>, <span class="st">"MRP"</span>)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the proportions from the data</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group, kept_name) <span class="sc">|&gt;</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group) <span class="sc">|&gt;</span> </span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n),</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">type =</span> <span class="fu">factor</span>(<span class="st">"raw data"</span>, <span class="at">levels =</span> levels)) <span class="sc">|&gt;</span> </span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kept_name <span class="sc">==</span> <span class="dv">1</span>, age_group <span class="sc">&lt;</span> <span class="dv">80</span>, age_group <span class="sc">&gt;</span> <span class="dv">20</span>) <span class="sc">|&gt;</span></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> prop, <span class="at">y =</span> age_group)) <span class="sc">+</span> </span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">limits =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> type)</span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-79-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>We’ll combine that plot with the next two, in a bit. I just wanted to give a preview of what we’re doing. The second plot will showcase the typical multilevel estimates for the same. The most straightforward way to do this with <strong>brms</strong> is with the <code>fitted()</code> function. We’ll use the <code>re_formula</code> argument to average over the levels of all grouping variables other than <code>age_group</code>. Relatedly, we’ll feed in the unique levels of <code>age_group</code> into the <code>newdata</code> argument. Then we just wrangle and plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">distinct</span>(d, age_group) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(age_group)</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">fitted</span>(</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>  b13<span class="fl">.7</span>,</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">re_formula =</span> <span class="sc">~</span> (<span class="dv">1</span> <span class="sc">|</span> age_group),</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> nd) <span class="sc">|&gt;</span> </span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(nd) <span class="sc">|&gt;</span> </span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> Estimate,</span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">type =</span> <span class="fu">factor</span>(<span class="st">"multilevel"</span>, <span class="at">levels =</span> levels)) <span class="sc">|&gt;</span> </span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> prop, <span class="at">xmin =</span> Q2<span class="fl">.5</span>, <span class="at">xmax =</span> Q97<span class="fl">.5</span>, <span class="at">y =</span> age_group)) <span class="sc">+</span> </span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="at">color =</span> <span class="st">"blue2"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will take a look at the multilevel coefficient plot in just a bit. Now we turn our focus to computing the MRP estimates. As a first step, we’ll follow Alexander’s lead and add a <code>prop</code> column to the <code>cell_counts</code> data, which will give us the proportions of the combinations of the other three demographic categories, within each level of <code>age_group</code>. We’ll save the results as <code>age_prop</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>age_prop <span class="ot">&lt;-</span> cell_counts <span class="sc">|&gt;</span> </span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group) <span class="sc">|&gt;</span> </span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>age_prop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,058 × 6
   state_name age_group decade_married educ_group     n      prop
   &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt;          &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;
 1 alabama    25        1999           &lt;BA        19012 0.00414  
 2 alabama    25        2009           &lt;BA        37488 0.00816  
 3 alabama    25        1999           &gt;BA          959 0.000209 
 4 alabama    25        2009           &gt;BA         5319 0.00116  
 5 alabama    25        1999           BA          2986 0.000650 
 6 alabama    25        2009           BA         14261 0.00310  
 7 alaska     25        1999           &lt;BA         3320 0.000723 
 8 alaska     25        2009           &lt;BA         7001 0.00152  
 9 alaska     25        1999           &gt;BA          159 0.0000346
10 alaska     25        2009           &gt;BA          435 0.0000947
# ℹ 6,048 more rows</code></pre>
</div>
</div>
<p>These results are then fed into the <code>newdata</code> argument within the <code>add_predicted_draws()</code> function, which we’ll save as <code>p</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">add_predicted_draws</span>(</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  b13<span class="fl">.7</span>, </span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> age_prop <span class="sc">|&gt;</span> </span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age_group <span class="sc">&gt;</span> <span class="dv">20</span>, </span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>           age_group <span class="sc">&lt;</span> <span class="dv">80</span>, </span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>           decade_married <span class="sc">&gt;</span> <span class="dv">1969</span>),</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">allow_new_levels =</span> T)</span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 24,232,000
Columns: 11
Groups: state_name, age_group, decade_married, educ_group, n, prop, .row [6,058]
$ state_name     &lt;chr&gt; "alabama", "alabama", "alabama", "alabama", "alabama", "alabama", "alabama", "alabama", "alabama", "alaba…
$ age_group      &lt;chr&gt; "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25", "25…
$ decade_married &lt;chr&gt; "1999", "1999", "1999", "1999", "1999", "1999", "1999", "1999", "1999", "1999", "1999", "1999", "1999", "…
$ educ_group     &lt;chr&gt; "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", "&lt;BA", …
$ n              &lt;dbl&gt; 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, …
$ prop           &lt;dbl&gt; 0.004137905, 0.004137905, 0.004137905, 0.004137905, 0.004137905, 0.004137905, 0.004137905, 0.004137905, 0…
$ .row           &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ .chain         &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ .iteration     &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ .draw          &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29…
$ .prediction    &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …</code></pre>
</div>
</div>
<p>The <code>tidybayes::add_predicted_draws()</code> function is somewhat analogous to <code>brms::predict()</code>. It allowed us to compute the posterior predictions from our model, given the levels of the predictors we fed into <code>newdata</code>. The results were returned in a tidy data format, including the levels of the predictors from the <code>newdata</code> argument. Because there were 6,058 unique predictor values and 4,000 posterior draws, this produced a 24,232,000-row data frame. The posterior predictions are in the <code>.prediction</code> column on the end. Since we used a binomial regression model, we got a series of 0’s and 1’s.</p>
<p>Next comes the MRP magic. If we group the results by <code>age_group</code> and <code>.draw</code>, we can sum the product of the posterior predictions and the weights, which will leave us with 4,000 stratified posterior draws for each of the 11 levels of <code>age_group</code>. This is the essence of the post-stratification equation McElreath presented in <a href="#sec-Post-stratification" class="quarto-xref"><span>Section 13.5.3</span></a>,</p>
<p><span class="math display">\[\frac{\sum_i N_i p_i}{\sum_i N_i}.\]</span></p>
<p>We will follow Alexander and call these summary values <code>kept_name_predict</code>. We then complete the project by grouping by <code>age_group</code> and summarizing each stratified posterior predictive distribution by its mean and 95% interval.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">|&gt;</span> </span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group, .draw) <span class="sc">|&gt;</span> </span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">kept_name_predict =</span> <span class="fu">sum</span>(.prediction <span class="sc">*</span> prop)) <span class="sc">|&gt;</span> </span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group) <span class="sc">|&gt;</span> </span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_qi</span>(kept_name_predict)</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 7
   age_group kept_name_predict .lower .upper .width .point .interval
   &lt;chr&gt;                 &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
 1 25                    0.175 0.0921  0.273   0.95 mean   qi       
 2 30                    0.182 0.116   0.263   0.95 mean   qi       
 3 35                    0.218 0.148   0.297   0.95 mean   qi       
 4 40                    0.244 0.171   0.326   0.95 mean   qi       
 5 45                    0.279 0.203   0.368   0.95 mean   qi       
 6 50                    0.301 0.218   0.399   0.95 mean   qi       
 7 55                    0.324 0.231   0.427   0.95 mean   qi       
 8 60                    0.438 0.327   0.555   0.95 mean   qi       
 9 65                    0.560 0.416   0.704   0.95 mean   qi       
10 70                    0.515 0.291   0.762   0.95 mean   qi       
11 75                    0.226 0.0485  0.505   0.95 mean   qi       </code></pre>
</div>
</div>
<p>Now we are finally ready to plot our MRP estimates and combine the three subplots into a coherent whole with <strong>patchwork</strong> syntax.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MRP plot</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> p <span class="sc">|&gt;</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="fu">factor</span>(<span class="st">"MRP"</span>, <span class="at">levels =</span> levels)) <span class="sc">|&gt;</span> </span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> kept_name_predict, <span class="at">xmin =</span> .lower, <span class="at">xmax =</span> .upper, <span class="at">y =</span> age_group)) <span class="sc">+</span> </span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="at">color =</span> <span class="st">"orange2"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">limits =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> type)</span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine, entitle, and display</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">|</span> p2 <span class="sc">|</span> p3) <span class="sc">+</span></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Proportion of women keeping name after marriage, by age"</span>,</span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">subtitle =</span> <span class="st">"Proportions are on the x-axis and age groups are on the y-axis."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-84-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Both multilevel and MRP estimates tended to be a little lower than the raw proportions, particularly for women in the younger age groups. Alexander mused this was “likely due to the fact that the survey has an over-sample of highly educated women, who are more likely to keep their name.” The MRP estimates were more precise than the multilevel predictions, which averaged across the grouping variables other than age. All three estimates show something of an inverted U-shape curve across age, which Alexander noted “is consistent with past observations that there was a <a href="https://www.nytimes.com/2015/06/28/upshot/maiden-names-on-the-rise-again.html">peak in name retention in the 80s and 90s</a>.”</p>
</section>
<section id="estimates-by-us-state" class="level4" data-number="13.6.3.2">
<h4 data-number="13.6.3.2" class="anchored" data-anchor-id="estimates-by-us-state"><span class="header-section-number">13.6.3.2</span> Estimates by US state</h4>
<p>Now we turn out attention to variation across states. The workflow, here, will only deviate slightly from what we just did. This time, of course, we will be grouping the estimates by <code>state_name</code> instead of by <code>age_group</code>. The other notable difference is since we’re plotting data clustered by US states, it might be fun to show the results in a map format. Alexander used the <code>geom_statebins()</code> function from the <a href="https://CRAN.R-project.org/package=statebins"><strong>statebins</strong> package</a> <span class="citation" data-cites="R-statebins">(<a href="references.html#ref-R-statebins" role="doc-biblioref">Rudis, 2020</a>)</span>. I thought the results were pretty cool, we will do the same. To give you a sense of what we’re building, here’s the plot of the empirical proportions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(statebins)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state_name, kept_name) <span class="sc">|&gt;</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state_name) <span class="sc">|&gt;</span></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kept_name <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>         state_name <span class="sc">!=</span> <span class="st">"puerto rico"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="fu">factor</span>(<span class="st">"raw data"</span>, <span class="at">levels =</span> levels),</span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">statename =</span> <span class="fu">str_to_title</span>(state_name)) <span class="sc">|&gt;</span></span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> prop, <span class="at">state =</span> statename)) <span class="sc">+</span> </span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_statebins</span>(<span class="at">lbl_size =</span> <span class="fl">2.5</span>, <span class="at">border_size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">radius =</span> grid<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"pt"</span>)) <span class="sc">+</span></span>
<span id="cb145-15"><a href="#cb145-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb145-16"><a href="#cb145-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb145-17"><a href="#cb145-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="st">"proportion</span><span class="sc">\n</span><span class="st">keeping</span><span class="sc">\n</span><span class="st">name"</span>, <span class="at">option =</span> <span class="st">"B"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.8</span>)) <span class="sc">+</span></span>
<span id="cb145-18"><a href="#cb145-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> type) <span class="sc">+</span></span>
<span id="cb145-19"><a href="#cb145-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb145-20"><a href="#cb145-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-21"><a href="#cb145-21" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-85-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>For the naïve multilevel estimates, we’ll continue using <code>fitted()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">distinct</span>(d, state_name)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">fitted</span>(b13<span class="fl">.7</span>,</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">newdata =</span> nd,</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">re_formula =</span> <span class="sc">~</span> (<span class="dv">1</span> <span class="sc">|</span> state_name),</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">allow_new_levels =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(nd) <span class="sc">|&gt;</span> </span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state_name <span class="sc">!=</span> <span class="st">"puerto rico"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> Estimate,</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">type =</span> <span class="fu">factor</span>(<span class="st">"multilevel"</span>, <span class="at">levels =</span> levels),</span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">statename =</span> <span class="fu">str_to_title</span>(state_name)) <span class="sc">|&gt;</span> </span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> prop, <span class="at">state =</span> statename)) <span class="sc">+</span> </span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_statebins</span>(<span class="at">lbl_size =</span> <span class="fl">2.5</span>, <span class="at">border_size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">radius =</span> grid<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"pt"</span>)) <span class="sc">+</span></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="st">"proportion</span><span class="sc">\n</span><span class="st">keeping</span><span class="sc">\n</span><span class="st">name"</span>, <span class="at">option =</span> <span class="st">"B"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.8</span>)) <span class="sc">+</span></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In preparation for the MRP estimates, we’ll first wrangle <code>cell_counts</code>, this time grouping by <code>state_name</code> before computing the weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>state_prop <span class="ot">&lt;-</span> cell_counts <span class="sc">|&gt;</span> </span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state_name) <span class="sc">|&gt;</span> </span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n<span class="sc">/</span><span class="fu">sum</span>(n))  <span class="sc">|&gt;</span> </span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>state_prop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,058 × 6
   state_name age_group decade_married educ_group     n     prop
   &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt;          &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;
 1 alabama    25        1999           &lt;BA        19012 0.0187  
 2 alabama    25        2009           &lt;BA        37488 0.0369  
 3 alabama    25        1999           &gt;BA          959 0.000945
 4 alabama    25        2009           &gt;BA         5319 0.00524 
 5 alabama    25        1999           BA          2986 0.00294 
 6 alabama    25        2009           BA         14261 0.0141  
 7 alaska     25        1999           &lt;BA         3320 0.0225  
 8 alaska     25        2009           &lt;BA         7001 0.0474  
 9 alaska     25        1999           &gt;BA          159 0.00108 
10 alaska     25        2009           &gt;BA          435 0.00295 
# ℹ 6,048 more rows</code></pre>
</div>
</div>
<p>Now we’ll feed those <code>state_prop</code> values into <code>add_predicted_draws()</code>, wrangle, and plot the MRP plot in one step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">add_predicted_draws</span>(</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  b13<span class="fl">.7</span>,</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> state_prop <span class="sc">|&gt;</span> </span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age_group <span class="sc">&gt;</span> <span class="dv">20</span>, </span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>           age_group <span class="sc">&lt;</span> <span class="dv">80</span>, </span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>           decade_married <span class="sc">&gt;</span> <span class="dv">1969</span>),</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">allow_new_levels =</span> T) <span class="sc">|&gt;</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state_name, .draw) <span class="sc">|&gt;</span> </span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">kept_name_predict =</span> <span class="fu">sum</span>(.prediction <span class="sc">*</span> prop)) <span class="sc">|&gt;</span> </span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state_name) <span class="sc">|&gt;</span> </span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_qi</span>(kept_name_predict) <span class="sc">|&gt;</span> </span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop      =</span> kept_name_predict,</span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">type      =</span> <span class="fu">factor</span>(<span class="st">"MRP"</span>, <span class="at">levels =</span> levels),</span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">statename =</span> <span class="fu">str_to_title</span>(state_name)) <span class="sc">|&gt;</span> </span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> kept_name_predict, <span class="at">state =</span> statename)) <span class="sc">+</span> </span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_statebins</span>(<span class="at">lbl_size =</span> <span class="fl">2.5</span>, <span class="at">border_size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">radius =</span> grid<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"pt"</span>)) <span class="sc">+</span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="st">"proportion</span><span class="sc">\n</span><span class="st">keeping</span><span class="sc">\n</span><span class="st">name"</span>, <span class="at">option =</span> <span class="st">"B"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.8</span>)) <span class="sc">+</span></span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> type) <span class="sc">+</span></span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’re finally ready to combine our three panels into one grand plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">|</span> p2 <span class="sc">|</span> p3) <span class="sc">+</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Proportion off women keeping name after marriage, by state"</span>,</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="fl">0.2</span>, <span class="dv">0</span>, <span class="fl">0.01</span>, <span class="dv">0</span>, <span class="st">"cm"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-89-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
<p>Remember how small the posterior for <span class="math inline">\(\sigma_\text{state}\)</span> was relative to the other <span class="math inline">\(\sigma_\text{&lt;group&gt;}\)</span> posteriors? We said that would imply more aggressive regularization across states. You can really see that regularization in the panels showing the multilevel and MRP estimates. They are much more uniform than the proportions from the raw data, which are all over the place. This is why you use multilevel models and/or stratify. When you divide the responses up at the state level, the proportions get jerked all around due to small and unrepresentative samples. Even with the regularization from the multilevel partial pooling, you can still see some interesting differences in the multilevel and MRP panels. Both suggest women keep their maiden names in relatively low proportions in Utah and relatively high proportions in New York. For those acquainted with American culture, this shouldn’t be a great surprise.</p>
</section>
</section>
<section id="wrap-this-mrp-up" class="level3" data-number="13.6.4">
<h3 data-number="13.6.4" class="anchored" data-anchor-id="wrap-this-mrp-up"><span class="header-section-number">13.6.4</span> Wrap this MRP up</h3>
<p>Interested readers should practice exploring the MRP estimates by the other two grouping variables, <code>educ_group</code> and <code>decate_married</code>. Both contain interesting results. Also, there are many other great free resources for learning about MRP.</p>
<ul>
<li><a href="https://timmastny.com/">Tim Mastny</a> showed how to use MRP via <strong>brms</strong> with data of US state level opinions for gay marriage in his blog post, <a href="https://timmastny.rbind.io/blog/multilevel-mrp-tidybayes-brms-stan/"><em>MRP Using brms and tidybayes</em></a>.</li>
<li><a href="https://rohanalexander.com/">Rohan Alexander</a> showed how to fit political poling data with both <strong>lme4</strong> and <strong>brms</strong> in his post, <a href="https://rohanalexander.com/posts/2019-12-04-getting_started_with_mrp/"><em>Getting started with MRP</em></a>.</li>
<li><a href="https://jazzystats.com/about/">Lauren Kennedy</a> and Andrew Gelman have a <span class="citation" data-cites="kennedy2021know">(<a href="references.html#ref-kennedy2021know" role="doc-biblioref">2021</a>)</span> paper called <a href="https://doi.org/10.1037/met0000362"><em>Know your population and know your model: Using model-based regression and post-stratification to generalize findings beyond the observed sample</em></a>, which shows how to use <strong>brms</strong> to apply MRP to Big Five personality data. <a href="https://arxiv.org/pdf/1906.11323.pdf">Here</a>’s a link to the preprint.</li>
</ul>
<p>For a more advanced application, check out the paper by <a href="https://martakolczynska.com/">Kolczynska</a>, Bürkner, <a href="https://jazzystats.com/about/">Kennedy</a>, and Vehtari <span class="citation" data-cites="kolczynskaTrustStateInstitutions2020">(<a href="references.html#ref-kolczynskaTrustStateInstitutions2020" role="doc-biblioref">2020</a>)</span>, which combines MRP with a model with ordinal outcomes (recall <a href="12.html#sec-Ordered-categorical-outcomes" class="quarto-xref"><span>Section 12.3</span></a>). Their supplemental material, which includes their <strong>R</strong> code, lives at <a href="https://osf.io/dz4y7/">https://osf.io/dz4y7/</a>. With all this good stuff, it seems we have an embarrassment of riches when it comes to <strong>brms</strong> and MRP! To wrap this section up, we’ll give Monica Alexander the last words:</p>
<blockquote class="blockquote">
<p>MRP is probably most commonly used in political analysis to reweight polling <a href="https://www.monicaalexander.com/posts/2019-08-07-mrp/#fn5">data</a>, but it is a useful technique for many different survey responses. Many modeling extensions are possible. For example, the multilevel regression need not be limited to just using random effects, as was used here, and other model set ups could be <a href="https://www.monicaalexander.com/posts/2019-08-07-mrp/#fn6">investigated</a>. MRP is a relatively easy and quick way of trying to get more representative estimates out of non-representative data, while giving you a sense of the uncertainty around the estimates (unlike traditional post-stratification).</p>
</blockquote>
</section>
</section>
<section id="session-info" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="session-info">Session info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.1 (2025-06-13)
Platform: aarch64-apple-darwin20
Running under: macOS Ventura 13.4

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] statebins_1.4.0       posterior_1.6.1.9000  bayesplot_1.15.0.9000 patchwork_1.3.2       tidybayes_3.0.7      
 [6] ggthemes_5.1.0        lubridate_1.9.4       forcats_1.0.1         stringr_1.6.0         dplyr_1.1.4          
[11] purrr_1.2.1           readr_2.1.5           tidyr_1.3.2           tibble_3.3.1          ggplot2_4.0.1        
[16] tidyverse_2.0.0       brms_2.23.0           Rcpp_1.1.0           

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.1        svUnit_1.0.8            viridisLite_0.4.2       farver_2.1.2            loo_2.9.0.9000         
 [6] S7_0.2.1                fastmap_1.2.0           TH.data_1.1-4           tensorA_0.36.2.1        digest_0.6.39          
[11] timechange_0.3.0        estimability_1.5.1      lifecycle_1.0.5         StanHeaders_2.36.0.9000 survival_3.8-3         
[16] magrittr_2.0.4          compiler_4.5.1          rlang_1.1.7             tools_4.5.1             utf8_1.2.6             
[21] yaml_2.3.12             knitr_1.51              emo_0.0.0.9000          labeling_0.4.3          bridgesampling_1.2-1   
[26] htmlwidgets_1.6.4       pkgbuild_1.4.8          curl_7.0.0              plyr_1.8.9              RColorBrewer_1.1-3     
[31] multcomp_1.4-29         abind_1.4-8             withr_3.0.2             grid_4.5.1              stats4_4.5.1           
[36] xtable_1.8-4            inline_0.3.21           emmeans_1.11.2-8        scales_1.4.0            MASS_7.3-65            
[41] cli_3.6.5               mvtnorm_1.3-3           crayon_1.5.3            rmarkdown_2.30          generics_0.1.4         
[46] RcppParallel_5.1.11-1   rstudioapi_0.17.1       reshape2_1.4.5          tzdb_0.5.0              rstan_2.36.0.9000      
[51] splines_4.5.1           assertthat_0.2.1        parallel_4.5.1          matrixStats_1.5.0       vctrs_0.6.5            
[56] V8_8.0.1                Matrix_1.7-3            sandwich_3.1-1          jsonlite_2.0.0          hms_1.1.4              
[61] arrayhelpers_1.1-0      ggdist_3.3.3            glue_1.8.0              codetools_0.2-20        distributional_0.5.0   
[66] stringi_1.8.7           gtable_0.3.6            QuickJSR_1.8.1          quadprog_1.5-8          pillar_1.11.1          
[71] htmltools_0.5.9         Brobdingnag_1.2-9       R6_2.6.1                evaluate_1.0.5          lattice_0.22-7         
[76] backports_1.5.0         rstantools_2.5.0.9000   coda_0.19-4.1           gridExtra_2.3           nlme_3.1-168           
[81] checkmate_2.3.3         xfun_0.55               zoo_1.8-14              pkgconfig_2.0.3        </code></pre>
</div>
</div>
</section>
<section id="comments" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="comments">Comments</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list" style="display: none">
<div id="ref-barrRandomEffectsStructure2013" class="csl-entry" role="listitem">
Barr, D. J., Levy, R., Scheepers, C., &amp; Tily, H. J. (2013). Random effects structure for confirmatory hypothesis testing: <span>Keep</span> it maximal. <em>Journal of Memory and Language</em>, <em>68</em>(3), 255–278. <a href="https://doi.org/10.1016/j.jml.2012.11.001">https://doi.org/10.1016/j.jml.2012.11.001</a>
</div>
<div id="ref-efronSteinParadoxStatistics1977" class="csl-entry" role="listitem">
Efron, B., &amp; Morris, C. (1977). Stein’s paradox in statistics. <em>Scientific American</em>, <em>236</em>(5), 119–127. <a href="https://doi.org/10.1038/scientificamerican0577-119">https://doi.org/10.1038/scientificamerican0577-119</a>
</div>
<div id="ref-gelmanRegressionOtherStories2020" class="csl-entry" role="listitem">
Gelman, A., Hill, J., &amp; Vehtari, A. (2020). <em>Regression and other stories</em>. Cambridge University Press. <a href="https://doi.org/10.1017/9781139161879">https://doi.org/10.1017/9781139161879</a>
</div>
<div id="ref-gelmanPostratificationManyCategories1997" class="csl-entry" role="listitem">
Gelman, A., &amp; Little, T. C. (1997). Postratification into many categories using hierarchical logistic regression. <em>Survey Methodology</em>, <em>23</em>, 127–135. <a href="https://stat.columbia.edu/~gelman/research/published/poststrat3.pdf">https://stat.columbia.edu/~gelman/research/published/poststrat3.pdf</a>
</div>
<div id="ref-kennedy2021know" class="csl-entry" role="listitem">
Kennedy, L., &amp; Gelman, A. (2021). Know your population and know your model: <span>Using</span> model-based regression and poststratification to generalize findings beyond the observed sample. <em>Psychological Methods</em>, <em>26</em>(5), 547–558. <a href="https://doi.org/10.1037/met0000362">https://doi.org/10.1037/met0000362</a>
</div>
<div id="ref-kolczynskaTrustStateInstitutions2020" class="csl-entry" role="listitem">
Kolczynska, M., Bürkner, P.-C., Kennedy, L., &amp; Vehtari, A. (2020). <em>Trust in state institutions in <span>Europe</span>, 1989-2019</em>. SocArXiv. <a href="https://doi.org/10.31235/osf.io/3v5g7">https://doi.org/10.31235/osf.io/3v5g7</a>
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2020" class="csl-entry" role="listitem">
McElreath, R. (2020). <em>Statistical rethinking: <span>A Bayesian</span> course with examples in <span>R</span> and <span>Stan</span></em> (Second Edition). CRC Press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a>
</div>
<div id="ref-paananenMomentMatching2020" class="csl-entry" role="listitem">
Paananen, T., Bürkner, P.-C., Vehtari, A., &amp; Gabry, J. (2020). <em>Avoiding model refits in leave-one-out cross-validation with moment matching</em>. <a href="https://CRAN.R-project.org/package=loo/vignettes/loo2-moment-matching.html">https://CRAN.R-project.org/package=loo/vignettes/loo2-moment-matching.html</a>
</div>
<div id="ref-paananenImplicitlyAdaptiveImportance2020" class="csl-entry" role="listitem">
Paananen, T., Piironen, J., Bürkner, P.-C., &amp; Vehtari, A. (2020). <em>Implicitly adaptive importance sampling</em>. <a href="http://arxiv.org/abs/1906.08850">http://arxiv.org/abs/1906.08850</a>
</div>
<div id="ref-parkBayesianMultilevelEstimation2004" class="csl-entry" role="listitem">
Park, D. K., Gelman, A., &amp; Bafumi, J. (2004). Bayesian multilevel estimation with poststratification: <span class="nocase">State-level</span> estimates from national polls. <em>Political Analysis</em>, <em>12</em>(4), 375–385. <a href="https://www.jstor.org/stable/25791784">https://www.jstor.org/stable/25791784</a>
</div>
<div id="ref-R-statebins" class="csl-entry" role="listitem">
Rudis, B. (2020). <em><span class="nocase">statebins</span>: <span>Create</span> united states uniform cartogram heatmaps</em> [Manual]. <a href="https://CRAN.R-project.org/package=statebins">https://CRAN.R-project.org/package=statebins</a>
</div>
<div id="ref-vehtariRanknormalizationFoldingLocalization2019" class="csl-entry" role="listitem">
Vehtari, A., Gelman, A., Simpson, D., Carpenter, B., &amp; Bürkner, P.-C. (2019). <em>Rank-normalization, folding, and localization: <span>An</span> improved for assessing convergence of <span>MCMC</span></em>. <a href="https://arxiv.org/abs/1903.08008?">https://arxiv.org/abs/1903.08008?</a>
</div>
<div id="ref-voneshCompensatoryLarvalResponses2005" class="csl-entry" role="listitem">
Vonesh, J. R., &amp; Bolker, B. M. (2005). Compensatory larval responses shift trade-offs associated with predator-induced hatching plasticity. <em>Ecology</em>, <em>86</em>(6), 1580–1591. <a href="https://doi.org/10.1890/04-0535">https://doi.org/10.1890/04-0535</a>
</div>
</div>
</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed";
    script.dataset.repoId = "";
    script.dataset.category = "General";
    script.dataset.categoryId = "";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./12.html" class="pagination-link" aria-label="Monsters and Mixtures">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Monsters and Mixtures</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./14.html" class="pagination-link" aria-label="Adventures in Covariance">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Adventures in Covariance</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>