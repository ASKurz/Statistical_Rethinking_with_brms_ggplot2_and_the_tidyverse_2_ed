<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>13 Models With Memory | Statistical rethinking with brms, ggplot2, and the tidyverse: Second edition</title>
  <meta name="description" content="This book is an attempt to re-express the code in the second edition of McElreath’s textbook, ‘Statistical rethinking.’ His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="13 Models With Memory | Statistical rethinking with brms, ggplot2, and the tidyverse: Second edition" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book is an attempt to re-express the code in the second edition of McElreath’s textbook, ‘Statistical rethinking.’ His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  <meta name="github-repo" content="ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="13 Models With Memory | Statistical rethinking with brms, ggplot2, and the tidyverse: Second edition" />
  <meta name="twitter:site" content="@SolomonKurz" />
  <meta name="twitter:description" content="This book is an attempt to re-express the code in the second edition of McElreath’s textbook, ‘Statistical rethinking.’ His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  

<meta name="author" content="A Solomon Kurz" />


<meta name="date" content="2020-08-20" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="monsters-and-mixtures.html"/>
<link rel="next" href="adventures-in-covariance.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>What and why</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#caution-work-in-progress"><i class="fa fa-check"></i>Caution: Work in progress</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#thank-yous-are-in-order"><i class="fa fa-check"></i>Thank-you’s are in order</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="the-golem-of-prague.html"><a href="the-golem-of-prague.html"><i class="fa fa-check"></i><b>1</b> The Golem of Prague</a><ul>
<li class="chapter" data-level="" data-path="the-golem-of-prague.html"><a href="the-golem-of-prague.html#session-info"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html"><i class="fa fa-check"></i><b>2</b> Small Worlds and Large Worlds</a><ul>
<li class="chapter" data-level="2.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#the-garden-of-forking-data"><i class="fa fa-check"></i><b>2.1</b> The garden of forking data</a><ul>
<li class="chapter" data-level="2.1.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#counting-possibilities."><i class="fa fa-check"></i><b>2.1.1</b> Counting possibilities.</a></li>
<li class="chapter" data-level="2.1.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#combining-other-information."><i class="fa fa-check"></i><b>2.1.2</b> Combining other information.</a></li>
<li class="chapter" data-level="2.1.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#from-counts-to-probability."><i class="fa fa-check"></i><b>2.1.3</b> From counts to probability.</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#building-a-model"><i class="fa fa-check"></i><b>2.2</b> Building a model</a><ul>
<li class="chapter" data-level="2.2.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#a-data-story."><i class="fa fa-check"></i><b>2.2.1</b> A data story.</a></li>
<li class="chapter" data-level="2.2.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#bayesian-updating."><i class="fa fa-check"></i><b>2.2.2</b> Bayesian updating.</a></li>
<li class="chapter" data-level="2.2.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#evaluate."><i class="fa fa-check"></i><b>2.2.3</b> Evaluate.</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#components-of-the-model"><i class="fa fa-check"></i><b>2.3</b> Components of the model</a><ul>
<li class="chapter" data-level="2.3.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#variables."><i class="fa fa-check"></i><b>2.3.1</b> Variables.</a></li>
<li class="chapter" data-level="2.3.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#definitions."><i class="fa fa-check"></i><b>2.3.2</b> Definitions.</a></li>
<li class="chapter" data-level="2.3.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#a-model-is-born."><i class="fa fa-check"></i><b>2.3.3</b> A model is born.</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#making-the-model-go"><i class="fa fa-check"></i><b>2.4</b> Making the model go</a><ul>
<li class="chapter" data-level="2.4.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#bayes-theorem."><i class="fa fa-check"></i><b>2.4.1</b> Bayes’ theorem.</a></li>
<li class="chapter" data-level="2.4.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#motors."><i class="fa fa-check"></i><b>2.4.2</b> Motors.</a></li>
<li class="chapter" data-level="2.4.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#grid-approximation."><i class="fa fa-check"></i><b>2.4.3</b> Grid approximation.</a></li>
<li class="chapter" data-level="2.4.4" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#quadratic-approximation."><i class="fa fa-check"></i><b>2.4.4</b> Quadratic approximation.</a></li>
<li class="chapter" data-level="2.4.5" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#markov-chain-monte-carlo."><i class="fa fa-check"></i><b>2.4.5</b> Markov chain Monte Carlo.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#session-info-1"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html"><i class="fa fa-check"></i><b>3</b> Sampling the Imaginary</a><ul>
<li class="chapter" data-level="3.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-from-a-grid-approximate-posterior"><i class="fa fa-check"></i><b>3.1</b> Sampling from a grid-approximate posterior</a></li>
<li class="chapter" data-level="3.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-to-summarize"><i class="fa fa-check"></i><b>3.2</b> Sampling to summarize</a><ul>
<li class="chapter" data-level="3.2.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#intervals-of-defined-boundaries."><i class="fa fa-check"></i><b>3.2.1</b> Intervals of defined boundaries.</a></li>
<li class="chapter" data-level="3.2.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#intervals-of-defined-mass."><i class="fa fa-check"></i><b>3.2.2</b> Intervals of defined mass.</a></li>
<li class="chapter" data-level="3.2.3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#point-estimates."><i class="fa fa-check"></i><b>3.2.3</b> Point estimates.</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-to-simulate-prediction"><i class="fa fa-check"></i><b>3.3</b> Sampling to simulate prediction</a><ul>
<li class="chapter" data-level="3.3.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#dummy-data."><i class="fa fa-check"></i><b>3.3.1</b> Dummy data.</a></li>
<li class="chapter" data-level="3.3.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#model-checking."><i class="fa fa-check"></i><b>3.3.2</b> Model checking.</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#summary-lets-practice-with-brms"><i class="fa fa-check"></i><b>3.4</b> <del>Summary</del> Let’s practice with brms</a></li>
<li class="chapter" data-level="" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#session-info-2"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="geocentric-models.html"><a href="geocentric-models.html"><i class="fa fa-check"></i><b>4</b> Geocentric Models</a><ul>
<li class="chapter" data-level="4.1" data-path="geocentric-models.html"><a href="geocentric-models.html#why-normal-distributions-are-normal"><i class="fa fa-check"></i><b>4.1</b> Why normal distributions are normal</a><ul>
<li class="chapter" data-level="4.1.1" data-path="geocentric-models.html"><a href="geocentric-models.html#normal-by-addition."><i class="fa fa-check"></i><b>4.1.1</b> Normal by addition.</a></li>
<li class="chapter" data-level="4.1.2" data-path="geocentric-models.html"><a href="geocentric-models.html#normal-by-multiplication."><i class="fa fa-check"></i><b>4.1.2</b> Normal by multiplication.</a></li>
<li class="chapter" data-level="4.1.3" data-path="geocentric-models.html"><a href="geocentric-models.html#normal-by-log-multiplication."><i class="fa fa-check"></i><b>4.1.3</b> Normal by log-multiplication.</a></li>
<li class="chapter" data-level="4.1.4" data-path="geocentric-models.html"><a href="geocentric-models.html#using-gaussian-distributions."><i class="fa fa-check"></i><b>4.1.4</b> Using Gaussian distributions.</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="geocentric-models.html"><a href="geocentric-models.html#a-language-for-describing-models"><i class="fa fa-check"></i><b>4.2</b> A language for describing models</a><ul>
<li class="chapter" data-level="4.2.1" data-path="geocentric-models.html"><a href="geocentric-models.html#re-describing-the-globe-tossing-model."><i class="fa fa-check"></i><b>4.2.1</b> Re-describing the globe tossing model.</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="geocentric-models.html"><a href="geocentric-models.html#a-gaussian-model-of-height"><i class="fa fa-check"></i><b>4.3</b> A Gaussian model of height</a><ul>
<li class="chapter" data-level="4.3.1" data-path="geocentric-models.html"><a href="geocentric-models.html#the-data."><i class="fa fa-check"></i><b>4.3.1</b> The data.</a></li>
<li class="chapter" data-level="4.3.2" data-path="geocentric-models.html"><a href="geocentric-models.html#the-model."><i class="fa fa-check"></i><b>4.3.2</b> The model.</a></li>
<li class="chapter" data-level="4.3.3" data-path="geocentric-models.html"><a href="geocentric-models.html#grid-approximation-of-the-posterior-distribution."><i class="fa fa-check"></i><b>4.3.3</b> Grid approximation of the posterior distribution.</a></li>
<li class="chapter" data-level="4.3.4" data-path="geocentric-models.html"><a href="geocentric-models.html#sampling-from-the-posterior."><i class="fa fa-check"></i><b>4.3.4</b> Sampling from the posterior.</a></li>
<li class="chapter" data-level="4.3.5" data-path="geocentric-models.html"><a href="geocentric-models.html#finding-the-posterior-distribution-with-quap-brm."><i class="fa fa-check"></i><b>4.3.5</b> Finding the posterior distribution with <del><code>quap</code></del> <code>brm()</code>.</a></li>
<li class="chapter" data-level="4.3.6" data-path="geocentric-models.html"><a href="geocentric-models.html#sampling-from-a-quap-brm-fit."><i class="fa fa-check"></i><b>4.3.6</b> Sampling from a <del><code>quap()</code></del> <code>brm()</code> fit.</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="geocentric-models.html"><a href="geocentric-models.html#linear-prediction"><i class="fa fa-check"></i><b>4.4</b> Linear prediction</a><ul>
<li class="chapter" data-level="4.4.1" data-path="geocentric-models.html"><a href="geocentric-models.html#the-linear-model-strategy."><i class="fa fa-check"></i><b>4.4.1</b> The linear model strategy.</a></li>
<li class="chapter" data-level="4.4.2" data-path="geocentric-models.html"><a href="geocentric-models.html#finding-the-posterior-distribution."><i class="fa fa-check"></i><b>4.4.2</b> Finding the posterior distribution.</a></li>
<li class="chapter" data-level="4.4.3" data-path="geocentric-models.html"><a href="geocentric-models.html#interpreting-the-posterior-distribution."><i class="fa fa-check"></i><b>4.4.3</b> Interpreting the posterior distribution.</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="geocentric-models.html"><a href="geocentric-models.html#curves-from-lines"><i class="fa fa-check"></i><b>4.5</b> Curves from lines</a><ul>
<li class="chapter" data-level="4.5.1" data-path="geocentric-models.html"><a href="geocentric-models.html#polynomial-regression"><i class="fa fa-check"></i><b>4.5.1</b> Polynomial regression</a></li>
<li class="chapter" data-level="4.5.2" data-path="geocentric-models.html"><a href="geocentric-models.html#splines."><i class="fa fa-check"></i><b>4.5.2</b> Splines.</a></li>
<li class="chapter" data-level="4.5.3" data-path="geocentric-models.html"><a href="geocentric-models.html#smooth-functions-for-a-rough-world."><i class="fa fa-check"></i><b>4.5.3</b> Smooth functions for a rough world.</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="geocentric-models.html"><a href="geocentric-models.html#summary-b-splines-with-brms"><i class="fa fa-check"></i><b>4.6</b> <del>Summary</del> B-splines with <strong>brms</strong></a></li>
<li class="chapter" data-level="" data-path="geocentric-models.html"><a href="geocentric-models.html#session-info-3"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html"><i class="fa fa-check"></i><b>5</b> The Many Variables &amp; The Spurious Waffles</a><ul>
<li class="chapter" data-level="5.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#spurious-associations"><i class="fa fa-check"></i><b>5.1</b> Spurious associations</a><ul>
<li class="chapter" data-level="5.1.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#think-before-you-regress."><i class="fa fa-check"></i><b>5.1.1</b> Think before you regress.</a></li>
<li class="chapter" data-level="5.1.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#testable-implications."><i class="fa fa-check"></i><b>5.1.2</b> Testable implications.</a></li>
<li class="chapter" data-level="5.1.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#multiple-regression-notation."><i class="fa fa-check"></i><b>5.1.3</b> Multiple regression notation.</a></li>
<li class="chapter" data-level="5.1.4" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#approximating-the-posterior."><i class="fa fa-check"></i><b>5.1.4</b> Approximating the posterior.</a></li>
<li class="chapter" data-level="5.1.5" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#plotting-multivariate-posteriors."><i class="fa fa-check"></i><b>5.1.5</b> Plotting multivariate posteriors.</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#masked-relationship"><i class="fa fa-check"></i><b>5.2</b> Masked relationship</a></li>
<li class="chapter" data-level="5.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#categorical-varaibles"><i class="fa fa-check"></i><b>5.3</b> Categorical varaibles</a><ul>
<li class="chapter" data-level="5.3.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#binary-categories."><i class="fa fa-check"></i><b>5.3.1</b> Binary categories.</a></li>
<li class="chapter" data-level="5.3.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#many-categories."><i class="fa fa-check"></i><b>5.3.2</b> Many categories.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#session-info-4"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html"><i class="fa fa-check"></i><b>6</b> The Haunted DAG &amp; The Causal Terror</a><ul>
<li class="chapter" data-level="6.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#multicollinearity"><i class="fa fa-check"></i><b>6.1</b> Multicollinearity</a><ul>
<li class="chapter" data-level="6.1.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#multicollinear-legs."><i class="fa fa-check"></i><b>6.1.1</b> Multicollinear legs.</a></li>
<li class="chapter" data-level="6.1.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#multicollinear-milk."><i class="fa fa-check"></i><b>6.1.2</b> Multicollinear <code>milk</code>.</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#post-treatment-bias"><i class="fa fa-check"></i><b>6.2</b> Post-treatment bias</a><ul>
<li class="chapter" data-level="6.2.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#a-prior-is-born."><i class="fa fa-check"></i><b>6.2.1</b> A prior is born.</a></li>
<li class="chapter" data-level="6.2.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#blocked-by-consequence."><i class="fa fa-check"></i><b>6.2.2</b> Blocked by consequence.</a></li>
<li class="chapter" data-level="6.2.3" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#fungus-and-d-separation."><i class="fa fa-check"></i><b>6.2.3</b> Fungus and <span class="math inline">\(d\)</span>-separation.</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#collider-bias"><i class="fa fa-check"></i><b>6.3</b> Collider bias</a><ul>
<li class="chapter" data-level="6.3.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#collider-of-false-sorrow."><i class="fa fa-check"></i><b>6.3.1</b> Collider of false sorrow.</a></li>
<li class="chapter" data-level="6.3.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#the-haunted-dag."><i class="fa fa-check"></i><b>6.3.2</b> The haunted DAG.</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#confronting-confounding"><i class="fa fa-check"></i><b>6.4</b> Confronting confounding</a><ul>
<li class="chapter" data-level="6.4.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#shutting-the-backdoor."><i class="fa fa-check"></i><b>6.4.1</b> Shutting the backdoor.</a></li>
<li class="chapter" data-level="6.4.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#two-roads."><i class="fa fa-check"></i><b>6.4.2</b> Two roads.</a></li>
<li class="chapter" data-level="6.4.3" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#backdoor-waffles."><i class="fa fa-check"></i><b>6.4.3</b> Backdoor waffles.</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#summary-and-a-little-more-practice"><i class="fa fa-check"></i><b>6.5</b> Summary [and a little more practice]</a></li>
<li class="chapter" data-level="" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#session-info-5"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ulysses-compass.html"><a href="ulysses-compass.html"><i class="fa fa-check"></i><b>7</b> Ulysses’ Compass</a><ul>
<li class="chapter" data-level="7.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#the-problem-with-parameters"><i class="fa fa-check"></i><b>7.1</b> The problem with parameters</a><ul>
<li class="chapter" data-level="7.1.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#more-parameters-almost-always-improve-fit."><i class="fa fa-check"></i><b>7.1.1</b> More parameters (almost) always improve fit.</a></li>
<li class="chapter" data-level="7.1.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#too-few-parameters-hurts-too."><i class="fa fa-check"></i><b>7.1.2</b> Too few parameters hurts, too.</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#entropy-and-accuracy"><i class="fa fa-check"></i><b>7.2</b> Entropy and accuracy</a><ul>
<li class="chapter" data-level="7.2.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#firing-the-weatherperson."><i class="fa fa-check"></i><b>7.2.1</b> Firing the weatherperson.</a></li>
<li class="chapter" data-level="7.2.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#information-and-uncertainty."><i class="fa fa-check"></i><b>7.2.2</b> Information and uncertainty.</a></li>
<li class="chapter" data-level="7.2.3" data-path="ulysses-compass.html"><a href="ulysses-compass.html#from-entropy-to-accuracy."><i class="fa fa-check"></i><b>7.2.3</b> From entropy to accuracy.</a></li>
<li class="chapter" data-level="7.2.4" data-path="ulysses-compass.html"><a href="ulysses-compass.html#estimating-divergence."><i class="fa fa-check"></i><b>7.2.4</b> Estimating divergence.</a></li>
<li class="chapter" data-level="7.2.5" data-path="ulysses-compass.html"><a href="ulysses-compass.html#scoring-the-right-data."><i class="fa fa-check"></i><b>7.2.5</b> Scoring the right data.</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ulysses-compass.html"><a href="ulysses-compass.html#golem-taming-regularization"><i class="fa fa-check"></i><b>7.3</b> Golem taming: regularization</a></li>
<li class="chapter" data-level="7.4" data-path="ulysses-compass.html"><a href="ulysses-compass.html#predicting-predictive-accuracy"><i class="fa fa-check"></i><b>7.4</b> Predicting predictive accuracy</a><ul>
<li class="chapter" data-level="7.4.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#cross-validation."><i class="fa fa-check"></i><b>7.4.1</b> Cross-validation.</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="ulysses-compass.html"><a href="ulysses-compass.html#information-criteria"><i class="fa fa-check"></i><b>7.5</b> Information criteria</a><ul>
<li class="chapter" data-level="7.5.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#comparing-cv-psis-and-waic."><i class="fa fa-check"></i><b>7.5.1</b> Comparing CV, PSIS, and WAIC.</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="ulysses-compass.html"><a href="ulysses-compass.html#model-comparison"><i class="fa fa-check"></i><b>7.6</b> Model comparison</a><ul>
<li class="chapter" data-level="7.6.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#model-mis-selection."><i class="fa fa-check"></i><b>7.6.1</b> Model mis-selection.</a></li>
<li class="chapter" data-level="7.6.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#outliers-and-other-illusions."><i class="fa fa-check"></i><b>7.6.2</b> Outliers and other illusions.</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="ulysses-compass.html"><a href="ulysses-compass.html#summarybonus-r2-talk"><i class="fa fa-check"></i><b>7.7</b> <del>Summary</del>Bonus: <span class="math inline">\(R^2\)</span> talk</a></li>
<li class="chapter" data-level="" data-path="ulysses-compass.html"><a href="ulysses-compass.html#session-info-6"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="conditional-manatees.html"><a href="conditional-manatees.html"><i class="fa fa-check"></i><b>8</b> Conditional Manatees</a><ul>
<li class="chapter" data-level="8.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#building-an-interaction."><i class="fa fa-check"></i><b>8.1</b> Building an interaction.</a><ul>
<li class="chapter" data-level="8.1.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#making-a-rugged-model."><i class="fa fa-check"></i><b>8.1.1</b> Making a rugged model.</a></li>
<li class="chapter" data-level="8.1.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#adding-an-indicator-variable-isnt-enough."><i class="fa fa-check"></i><b>8.1.2</b> Adding an indicator variable isn’t enough.</a></li>
<li class="chapter" data-level="8.1.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#adding-an-interaction-does-work."><i class="fa fa-check"></i><b>8.1.3</b> Adding an interaction does work.</a></li>
<li class="chapter" data-level="8.1.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-the-interaction."><i class="fa fa-check"></i><b>8.1.4</b> Plotting the interaction.</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#symmetry-of-interactions"><i class="fa fa-check"></i><b>8.2</b> Symmetry of interactions</a></li>
<li class="chapter" data-level="8.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#continuous-interactions"><i class="fa fa-check"></i><b>8.3</b> Continuous interactions</a><ul>
<li class="chapter" data-level="8.3.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#a-winter-flower."><i class="fa fa-check"></i><b>8.3.1</b> A winter flower.</a></li>
<li class="chapter" data-level="8.3.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#the-models."><i class="fa fa-check"></i><b>8.3.2</b> The models.</a></li>
<li class="chapter" data-level="8.3.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-posterior-predictions."><i class="fa fa-check"></i><b>8.3.3</b> Plotting posterior predictions.</a></li>
<li class="chapter" data-level="8.3.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-prior-predictions."><i class="fa fa-check"></i><b>8.3.4</b> Plotting prior predictions.</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#summary-bonus-conditional_effects"><i class="fa fa-check"></i><b>8.4</b> <del>Summary</del> Bonus: <code>conditional_effects()</code></a></li>
<li class="chapter" data-level="" data-path="conditional-manatees.html"><a href="conditional-manatees.html#session-info-7"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html"><i class="fa fa-check"></i><b>9</b> Markov Chain Monte Carlo</a><ul>
<li class="chapter" data-level="9.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#good-king-markov-and-his-island-kingdom"><i class="fa fa-check"></i><b>9.1</b> Good King Markov and his island kingdom</a></li>
<li class="chapter" data-level="9.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#metropolis-algorithms"><i class="fa fa-check"></i><b>9.2</b> Metropolis algorithms</a><ul>
<li class="chapter" data-level="9.2.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#gibbs-sampling."><i class="fa fa-check"></i><b>9.2.1</b> Gibbs sampling.</a></li>
<li class="chapter" data-level="9.2.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#high-dimensional-problems."><i class="fa fa-check"></i><b>9.2.2</b> High-dimensional problems.</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#hamiltonian-monte-carlo"><i class="fa fa-check"></i><b>9.3</b> Hamiltonian Monte Carlo</a><ul>
<li class="chapter" data-level="9.3.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#limitations."><i class="fa fa-check"></i><b>9.3.1</b> Limitations.</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#easy-hmc-ulam-brm"><i class="fa fa-check"></i><b>9.4</b> Easy HMC: <del>ulam</del> <code>brm()</code></a><ul>
<li class="chapter" data-level="9.4.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#preparation."><i class="fa fa-check"></i><b>9.4.1</b> Preparation.</a></li>
<li class="chapter" data-level="9.4.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#estimation."><i class="fa fa-check"></i><b>9.4.2</b> Estimation.</a></li>
<li class="chapter" data-level="9.4.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#sampling-again-in-parallel."><i class="fa fa-check"></i><b>9.4.3</b> Sampling again, in parallel.</a></li>
<li class="chapter" data-level="9.4.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#visualization."><i class="fa fa-check"></i><b>9.4.4</b> Visualization.</a></li>
<li class="chapter" data-level="9.4.5" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#checking-the-chain."><i class="fa fa-check"></i><b>9.4.5</b> Checking the chain.</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#care-and-feeding-of-your-markov-chain."><i class="fa fa-check"></i><b>9.5</b> Care and feeding of your Markov chain.</a><ul>
<li class="chapter" data-level="9.5.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#how-many-samples-do-you-need"><i class="fa fa-check"></i><b>9.5.1</b> How many samples do you need?</a></li>
<li class="chapter" data-level="9.5.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#how-many-chains-do-you-need"><i class="fa fa-check"></i><b>9.5.2</b> How many chains do you need?</a></li>
<li class="chapter" data-level="9.5.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#taming-a-wild-chain."><i class="fa fa-check"></i><b>9.5.3</b> Taming a wild chain.</a></li>
<li class="chapter" data-level="9.5.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#non-identifiable-parameters."><i class="fa fa-check"></i><b>9.5.4</b> Non-identifiable parameters.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#session-info-8"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html"><i class="fa fa-check"></i><b>10</b> Big Entropy and the Generalized Linear Model</a><ul>
<li class="chapter" data-level="10.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#maximum-entropy"><i class="fa fa-check"></i><b>10.1</b> Maximum entropy</a><ul>
<li class="chapter" data-level="10.1.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#gaussian."><i class="fa fa-check"></i><b>10.1.1</b> Gaussian.</a></li>
<li class="chapter" data-level="10.1.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#binomial."><i class="fa fa-check"></i><b>10.1.2</b> Binomial.</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#generalized-linear-models"><i class="fa fa-check"></i><b>10.2</b> Generalized linear models</a><ul>
<li class="chapter" data-level="10.2.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#meet-the-family."><i class="fa fa-check"></i><b>10.2.1</b> Meet the family.</a></li>
<li class="chapter" data-level="10.2.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#linking-linear-models-to-distributions."><i class="fa fa-check"></i><b>10.2.2</b> Linking linear models to distributions.</a></li>
<li class="chapter" data-level="10.2.3" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#omitted-variable-bias-again."><i class="fa fa-check"></i><b>10.2.3</b> Omitted variable bias again.</a></li>
<li class="chapter" data-level="10.2.4" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#absolute-and-relative-differences."><i class="fa fa-check"></i><b>10.2.4</b> Absolute and relative differences.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#session-info-9"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html"><i class="fa fa-check"></i><b>11</b> God Spiked the Integers</a><ul>
<li class="chapter" data-level="11.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#binomial-regression"><i class="fa fa-check"></i><b>11.1</b> Binomial regression</a><ul>
<li class="chapter" data-level="11.1.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#logistic-regression-prosocial-chimpanzees."><i class="fa fa-check"></i><b>11.1.1</b> Logistic regression: Prosocial chimpanzees.</a></li>
<li class="chapter" data-level="11.1.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#relative-shark-and-absolute-deer."><i class="fa fa-check"></i><b>11.1.2</b> Relative shark and absolute deer.</a></li>
<li class="chapter" data-level="11.1.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#aggregated-binomial-chimpanzees-again-condensed."><i class="fa fa-check"></i><b>11.1.3</b> Aggregated binomial: Chimpanzees again, condensed.</a></li>
<li class="chapter" data-level="11.1.4" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#aggregated-binomial-graduate-school-admissions."><i class="fa fa-check"></i><b>11.1.4</b> Aggregated binomial: Graduate school admissions.</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#poisson-regression"><i class="fa fa-check"></i><b>11.2</b> Poisson regression</a><ul>
<li class="chapter" data-level="11.2.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#example-oceanic-tool-complexity."><i class="fa fa-check"></i><b>11.2.1</b> Example: Oceanic tool complexity.</a></li>
<li class="chapter" data-level="11.2.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#negative-binomial-gamma-poisson-models."><i class="fa fa-check"></i><b>11.2.2</b> Negative binomial (gamma-Poisson) models.</a></li>
<li class="chapter" data-level="11.2.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#example-exposure-and-the-offset."><i class="fa fa-check"></i><b>11.2.3</b> Example: Exposure and the offset.</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#multinomial-and-categorical-models"><i class="fa fa-check"></i><b>11.3</b> Multinomial and categorical models</a><ul>
<li class="chapter" data-level="11.3.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#predictors-matched-to-observations."><i class="fa fa-check"></i><b>11.3.1</b> Predictors matched to observations.</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#summary"><i class="fa fa-check"></i><b>11.4</b> Summary</a></li>
<li class="chapter" data-level="" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#session-info-10"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html"><i class="fa fa-check"></i><b>12</b> Monsters and Mixtures</a><ul>
<li class="chapter" data-level="12.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#over-dispersed-counts"><i class="fa fa-check"></i><b>12.1</b> Over-dispersed counts</a><ul>
<li class="chapter" data-level="12.1.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#beta-binomial."><i class="fa fa-check"></i><b>12.1.1</b> Beta-binomial.</a></li>
<li class="chapter" data-level="12.1.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#negative-binomial-or-gamma-poisson."><i class="fa fa-check"></i><b>12.1.2</b> Negative-binomial or gamma-Poisson.</a></li>
<li class="chapter" data-level="12.1.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#over-dispersion-entropy-and-information-criteria."><i class="fa fa-check"></i><b>12.1.3</b> Over-dispersion, entropy, and information criteria.</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#zero-inflated-outcomes"><i class="fa fa-check"></i><b>12.2</b> Zero-inflated outcomes</a><ul>
<li class="chapter" data-level="12.2.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#example-zero-inflated-poisson."><i class="fa fa-check"></i><b>12.2.1</b> Example: Zero-inflated Poisson.</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#ordered-categorical-outcomes"><i class="fa fa-check"></i><b>12.3</b> Ordered categorical outcomes</a><ul>
<li class="chapter" data-level="12.3.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#example-moral-intuition."><i class="fa fa-check"></i><b>12.3.1</b> Example: Moral intuition.</a></li>
<li class="chapter" data-level="12.3.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#describing-an-ordered-distribution-with-intercepts."><i class="fa fa-check"></i><b>12.3.2</b> Describing an ordered distribution with intercepts.</a></li>
<li class="chapter" data-level="12.3.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#adding-predictor-variables."><i class="fa fa-check"></i><b>12.3.3</b> Adding predictor variables.</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#ordered-categorical-predictors"><i class="fa fa-check"></i><b>12.4</b> Ordered categorical predictors</a></li>
<li class="chapter" data-level="12.5" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#summary-1"><i class="fa fa-check"></i><b>12.5</b> Summary</a></li>
<li class="chapter" data-level="" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#session-info-11"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="models-with-memory.html"><a href="models-with-memory.html"><i class="fa fa-check"></i><b>13</b> Models With Memory</a><ul>
<li class="chapter" data-level="13.1" data-path="models-with-memory.html"><a href="models-with-memory.html#example-multilevel-tadpoles"><i class="fa fa-check"></i><b>13.1</b> Example: Multilevel tadpoles</a></li>
<li class="chapter" data-level="13.2" data-path="models-with-memory.html"><a href="models-with-memory.html#varying-effects-and-the-underfittingoverfitting-trade-off"><i class="fa fa-check"></i><b>13.2</b> Varying effects and the underfitting/overfitting trade-off</a><ul>
<li class="chapter" data-level="13.2.1" data-path="models-with-memory.html"><a href="models-with-memory.html#the-model.-1"><i class="fa fa-check"></i><b>13.2.1</b> The model.</a></li>
<li class="chapter" data-level="13.2.2" data-path="models-with-memory.html"><a href="models-with-memory.html#assign-values-to-the-parameters."><i class="fa fa-check"></i><b>13.2.2</b> Assign values to the parameters.</a></li>
<li class="chapter" data-level="13.2.3" data-path="models-with-memory.html"><a href="models-with-memory.html#sumulate-survivors."><i class="fa fa-check"></i><b>13.2.3</b> Sumulate survivors.</a></li>
<li class="chapter" data-level="13.2.4" data-path="models-with-memory.html"><a href="models-with-memory.html#compute-the-no-pooling-estimates."><i class="fa fa-check"></i><b>13.2.4</b> Compute the no-pooling estimates.</a></li>
<li class="chapter" data-level="13.2.5" data-path="models-with-memory.html"><a href="models-with-memory.html#compute-the-partial-pooling-estimates."><i class="fa fa-check"></i><b>13.2.5</b> Compute the partial-pooling estimates.</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="models-with-memory.html"><a href="models-with-memory.html#more-than-one-type-of-cluster"><i class="fa fa-check"></i><b>13.3</b> More than one type of cluster</a><ul>
<li class="chapter" data-level="13.3.1" data-path="models-with-memory.html"><a href="models-with-memory.html#multilevel-chimpanzees."><i class="fa fa-check"></i><b>13.3.1</b> Multilevel chimpanzees.</a></li>
<li class="chapter" data-level="13.3.2" data-path="models-with-memory.html"><a href="models-with-memory.html#even-more-clusters."><i class="fa fa-check"></i><b>13.3.2</b> Even more clusters.</a></li>
</ul></li>
<li class="chapter" data-level="13.4" data-path="models-with-memory.html"><a href="models-with-memory.html#divergent-transitions-and-non-centered-priors"><i class="fa fa-check"></i><b>13.4</b> Divergent transitions and non-centered priors</a><ul>
<li class="chapter" data-level="13.4.1" data-path="models-with-memory.html"><a href="models-with-memory.html#the-devils-funnel."><i class="fa fa-check"></i><b>13.4.1</b> The Devil’s Funnel.</a></li>
<li class="chapter" data-level="13.4.2" data-path="models-with-memory.html"><a href="models-with-memory.html#non-centered-chimpanzees."><i class="fa fa-check"></i><b>13.4.2</b> Non-centered chimpanzees.</a></li>
</ul></li>
<li class="chapter" data-level="13.5" data-path="models-with-memory.html"><a href="models-with-memory.html#multilevel-posterior-predictions"><i class="fa fa-check"></i><b>13.5</b> Multilevel posterior predictions</a><ul>
<li class="chapter" data-level="13.5.1" data-path="models-with-memory.html"><a href="models-with-memory.html#posterior-prediction-for-same-clusters."><i class="fa fa-check"></i><b>13.5.1</b> Posterior prediction for same clusters.</a></li>
<li class="chapter" data-level="13.5.2" data-path="models-with-memory.html"><a href="models-with-memory.html#posterior-prediction-for-new-clusters."><i class="fa fa-check"></i><b>13.5.2</b> Posterior prediction for new clusters.</a></li>
<li class="chapter" data-level="13.5.3" data-path="models-with-memory.html"><a href="models-with-memory.html#post-stratification."><i class="fa fa-check"></i><b>13.5.3</b> Post-stratification.</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="models-with-memory.html"><a href="models-with-memory.html#summary-bonus-post-stratification-in-an-example"><i class="fa fa-check"></i><b>13.6</b> <del>Summary</del> Bonus: Post-stratification in an example</a><ul>
<li class="chapter" data-level="13.6.1" data-path="models-with-memory.html"><a href="models-with-memory.html#meet-the-data."><i class="fa fa-check"></i><b>13.6.1</b> Meet the data.</a></li>
<li class="chapter" data-level="13.6.2" data-path="models-with-memory.html"><a href="models-with-memory.html#settle-the-mr-part-of-mrp."><i class="fa fa-check"></i><b>13.6.2</b> Settle the MR part of MRP.</a></li>
<li class="chapter" data-level="13.6.3" data-path="models-with-memory.html"><a href="models-with-memory.html#post-stratify-to-put-the-p-in-mrp."><i class="fa fa-check"></i><b>13.6.3</b> Post-stratify to put the P in MRP.</a></li>
<li class="chapter" data-level="13.6.4" data-path="models-with-memory.html"><a href="models-with-memory.html#wrap-this-mrp-up."><i class="fa fa-check"></i><b>13.6.4</b> Wrap this MRP up.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="models-with-memory.html"><a href="models-with-memory.html#session-info-12"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html"><i class="fa fa-check"></i><b>14</b> Adventures in Covariance</a><ul>
<li class="chapter" data-level="14.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#varying-slopes-by-construction"><i class="fa fa-check"></i><b>14.1</b> Varying slopes by construction</a><ul>
<li class="chapter" data-level="14.1.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#simulate-the-population."><i class="fa fa-check"></i><b>14.1.1</b> Simulate the population.</a></li>
<li class="chapter" data-level="14.1.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#simulate-observations."><i class="fa fa-check"></i><b>14.1.2</b> Simulate observations.</a></li>
<li class="chapter" data-level="14.1.3" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#the-varying-slopes-model."><i class="fa fa-check"></i><b>14.1.3</b> The varying slopes model.</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#advanced-varying-slopes"><i class="fa fa-check"></i><b>14.2</b> Advanced varying slopes</a></li>
<li class="chapter" data-level="14.3" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#instruments-and-causal-designs"><i class="fa fa-check"></i><b>14.3</b> Instruments and causal designs</a><ul>
<li class="chapter" data-level="14.3.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#instrumental-variables."><i class="fa fa-check"></i><b>14.3.1</b> Instrumental variables.</a></li>
<li class="chapter" data-level="14.3.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#other-designs."><i class="fa fa-check"></i><b>14.3.2</b> Other designs.</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#social-relations-as-correlated-varying-effects"><i class="fa fa-check"></i><b>14.4</b> Social relations as correlated varying effects</a></li>
<li class="chapter" data-level="14.5" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#continuous-categories-and-the-gaussian-process"><i class="fa fa-check"></i><b>14.5</b> Continuous categories and the Gaussian process</a><ul>
<li class="chapter" data-level="14.5.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#example-spatial-autocorrelation-in-oceanic-tools."><i class="fa fa-check"></i><b>14.5.1</b> Example: Spatial autocorrelation in Oceanic tools.</a></li>
<li class="chapter" data-level="14.5.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#example-phylogenetic-distance."><i class="fa fa-check"></i><b>14.5.2</b> Example: Phylogenetic distance.</a></li>
</ul></li>
<li class="chapter" data-level="14.6" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#summary-bonus-multilevel-growth-models-and-the-melsm"><i class="fa fa-check"></i><b>14.6</b> <del>Summary</del> Bonus: Multilevel growth models and the MELSM</a><ul>
<li class="chapter" data-level="14.6.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#borrow-some-data."><i class="fa fa-check"></i><b>14.6.1</b> Borrow some data.</a></li>
<li class="chapter" data-level="14.6.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#conventional-multilevel-growth-model."><i class="fa fa-check"></i><b>14.6.2</b> Conventional multilevel growth model.</a></li>
<li class="chapter" data-level="14.6.3" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#learn-more-about-your-data-with-the-melsm."><i class="fa fa-check"></i><b>14.6.3</b> Learn more about your data with the MELSM.</a></li>
<li class="chapter" data-level="14.6.4" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#time-to-go-multivariate."><i class="fa fa-check"></i><b>14.6.4</b> Time to go multivariate.</a></li>
<li class="chapter" data-level="14.6.5" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#growth-modelmelsm-wrap-up."><i class="fa fa-check"></i><b>14.6.5</b> Growth model/MELSM wrap-up.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#session-info-13"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><em>Statistical rethinking</em> with brms, ggplot2, and the tidyverse: Second edition</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="models-with-memory" class="section level1">
<h1><span class="header-section-number">13</span> Models With Memory</h1>
<blockquote>
<p><strong>Multilevel models</strong>… remember features of each cluster in the data as they learn about all of the clusters. Depending upon the variation among clusters, which is learned from the data as well, the model pools information across clusters. This pooling tends to improve estimates about each cluster. This improved estimation leads to several, more pragmatic sounding, benefits of the multilevel approach. <span class="citation">(McElreath, <a href="#ref-mcelreathStatisticalRethinkingBayesian2020">2020</a><a href="#ref-mcelreathStatisticalRethinkingBayesian2020">a</a>, p. 400, <strong>emphasis</strong> in the original)</span></p>
</blockquote>
<p>These benefits include:</p>
<ul>
<li>better estimates for repeated sampling (i.e., in longitudinal data),</li>
<li>better estimates when there are imbalances among subsamples,</li>
<li>estimates of the variation across subsamples, and</li>
<li>avoiding simplistic averaging by retaining variation across subsamples.</li>
</ul>
<blockquote>
<p>All of these benefits flow out of the same strategy and model structure. You learn one basic design and you get all of this for free.</p>
<p>When it comes to regression, multilevel regression deserves to be the default approach. There are certainly contexts in which it would be better to use an old-fashioned single-level model. But the contexts in which multilevel models are superior are much more numerous. It is better to begin to build a multilevel analysis, and then realize it’s unnecessary, than to overlook it. And once you grasp the basic multilevel strategy, it becomes much easier to incorporate related tricks such as allowing for measurement error in the data and even modeling missing data itself (Chapter 15). (p. 400)</p>
</blockquote>
<p>I’m totally on board with this. After learning about the multilevel model, I see it everywhere. For more on the sentiment it should be the default, check out McElreath’s blog post, <a href="https://elevanth.org/blog/2017/08/24/multilevel-regression-as-default/"><em>Multilevel regression as default</em></a>.</p>
<div id="example-multilevel-tadpoles" class="section level2">
<h2><span class="header-section-number">13.1</span> Example: Multilevel tadpoles</h2>
<p>Let’s load the <code>reedfrogs</code> data <span class="citation">(see Vonesh &amp; Bolker, <a href="#ref-voneshCompensatoryLarvalResponses2005">2005</a>)</span>.</p>
<div class="sourceCode" id="cb1524"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1524-1" data-line-number="1"><span class="kw">library</span>(rethinking)</a>
<a class="sourceLine" id="cb1524-2" data-line-number="2"><span class="kw">data</span>(reedfrogs)</a>
<a class="sourceLine" id="cb1524-3" data-line-number="3">d &lt;-<span class="st"> </span>reedfrogs</a></code></pre></div>
<p>Detach <strong>rethinking</strong> and load <strong>brms</strong>.</p>
<div class="sourceCode" id="cb1525"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1525-1" data-line-number="1"><span class="kw">rm</span>(reedfrogs)</a>
<a class="sourceLine" id="cb1525-2" data-line-number="2"><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</a>
<a class="sourceLine" id="cb1525-3" data-line-number="3"><span class="kw">library</span>(brms)</a></code></pre></div>
<p>Go ahead and acquaint yourself with the <code>reedfrogs</code>.</p>
<div class="sourceCode" id="cb1526"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1526-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1526-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1526-3" data-line-number="3">d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1526-4" data-line-number="4"><span class="st">  </span><span class="kw">glimpse</span>()</a></code></pre></div>
<pre><code>## Rows: 48
## Columns: 5
## $ density  &lt;int&gt; 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 25, 25, 25, 25, 25, 25, 25…
## $ pred     &lt;fct&gt; no, no, no, no, no, no, no, no, pred, pred, pred, pred, pred, pred, pred, pred, no, no, no…
## $ size     &lt;fct&gt; big, big, big, big, small, small, small, small, big, big, big, big, small, small, small, s…
## $ surv     &lt;int&gt; 9, 10, 7, 10, 9, 9, 10, 9, 4, 9, 7, 6, 7, 5, 9, 9, 24, 23, 22, 25, 23, 23, 23, 21, 6, 13, …
## $ propsurv &lt;dbl&gt; 0.9000000, 1.0000000, 0.7000000, 1.0000000, 0.9000000, 0.9000000, 1.0000000, 0.9000000, 0.…</code></pre>
<p>Making the <code>tank</code> cluster variable is easy.</p>
<div class="sourceCode" id="cb1528"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1528-1" data-line-number="1">d &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1528-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1528-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">tank =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(d))</a></code></pre></div>
<p>Here’s the formula for the un-pooled model in which each <code>tank</code> gets its own intercept:</p>
<p><span class="math display">\[\begin{align*}
\text{surv}_i             &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_{\text{tank}[i]} \\
\alpha_j                  &amp; \sim \operatorname{Normal} (0, 1.5) &amp; \text{for } j = 1..48,
\end{align*}\]</span></p>
<p>where <span class="math inline">\(n_i\)</span> is indexed by the <code>density</code> column. Its values are distributed like so:</p>
<div class="sourceCode" id="cb1529"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1529-1" data-line-number="1">d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1529-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>(density)</a></code></pre></div>
<pre><code>##   density  n
## 1      10 16
## 2      25 16
## 3      35 16</code></pre>
<p>Now fit this simple aggregated binomial model much like we practiced in <a href="god-spiked-the-integers.html#aggregated-binomial-chimpanzees-again-condensed.">Chapter 11</a>.</p>
<div class="sourceCode" id="cb1531"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1531-1" data-line-number="1">b13<span class="fl">.1</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1531-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1531-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1531-4" data-line-number="4">      surv <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(density) <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(tank),</a>
<a class="sourceLine" id="cb1531-5" data-line-number="5">      <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> b),</a>
<a class="sourceLine" id="cb1531-6" data-line-number="6">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1531-7" data-line-number="7">      <span class="dt">seed =</span> <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb1531-8" data-line-number="8">      <span class="dt">file =</span> <span class="st">&quot;fits/b13.01&quot;</span>)</a></code></pre></div>
<p>We don’t need a <code>depth=2</code> argument to discover we have 48 different intercepts. The default <code>print()</code> behavior will do.</p>
<div class="sourceCode" id="cb1532"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1532-1" data-line-number="1"><span class="kw">print</span>(b13<span class="fl">.1</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: surv | trials(density) ~ 0 + factor(tank) 
##    Data: d (Number of observations: 48) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## factortank1      1.71      0.76     0.35     3.32 1.00     5968     2690
## factortank2      2.41      0.90     0.77     4.38 1.00     4900     2558
## factortank3      0.76      0.63    -0.40     2.04 1.00     6092     2689
## factortank4      2.41      0.89     0.81     4.36 1.00     6258     3082
## factortank5      1.71      0.77     0.34     3.36 1.00     4940     2499
## factortank6      1.72      0.77     0.39     3.38 1.00     6044     3061
## factortank7      2.41      0.91     0.88     4.40 1.00     5596     2867
## factortank8      1.72      0.76     0.35     3.37 1.00     5477     2615
## factortank9     -0.36      0.60    -1.56     0.82 1.00     6323     2826
## factortank10     1.72      0.78     0.34     3.40 1.00     5799     2853
## factortank11     0.76      0.62    -0.42     2.01 1.00     5467     2858
## factortank12     0.35      0.63    -0.87     1.61 1.00     5133     3110
## factortank13     0.76      0.65    -0.44     2.10 1.00     6180     2641
## factortank14     0.01      0.59    -1.16     1.20 1.00     5359     3277
## factortank15     1.72      0.79     0.31     3.41 1.00     6558     2823
## factortank16     1.74      0.78     0.34     3.37 1.00     5035     2706
## factortank17     2.55      0.69     1.36     4.06 1.00     4771     2989
## factortank18     2.14      0.62     1.05     3.48 1.00     5673     2708
## factortank19     1.82      0.55     0.84     3.00 1.00     6580     2789
## factortank20     3.09      0.81     1.67     4.89 1.00     5512     2629
## factortank21     2.16      0.63     1.06     3.56 1.00     4868     2438
## factortank22     2.13      0.61     1.03     3.45 1.00     5752     2526
## factortank23     2.14      0.58     1.11     3.36 1.00     5812     2941
## factortank24     1.55      0.52     0.62     2.69 1.00     5606     2728
## factortank25    -1.11      0.46    -2.05    -0.25 1.01     5548     2758
## factortank26     0.07      0.41    -0.73     0.90 1.00     5360     2584
## factortank27    -1.55      0.50    -2.60    -0.63 1.00     5138     2886
## factortank28    -0.54      0.41    -1.35     0.24 1.00     5783     2878
## factortank29     0.08      0.39    -0.67     0.84 1.00     5349     3120
## factortank30     1.30      0.46     0.46     2.24 1.00     5681     2730
## factortank31    -0.72      0.41    -1.58     0.04 1.00     5584     2848
## factortank32    -0.39      0.41    -1.21     0.39 1.00     5755     3148
## factortank33     2.84      0.65     1.70     4.18 1.00     4913     2760
## factortank34     2.45      0.57     1.41     3.67 1.00     5085     2773
## factortank35     2.48      0.59     1.41     3.73 1.00     6235     3034
## factortank36     1.91      0.48     1.03     2.92 1.00     6056     3296
## factortank37     1.91      0.48     1.03     2.91 1.00     5467     2841
## factortank38     3.36      0.78     1.99     5.05 1.00     5907     2908
## factortank39     2.44      0.59     1.40     3.73 1.00     6059     2850
## factortank40     2.15      0.52     1.21     3.27 1.00     5156     2828
## factortank41    -1.90      0.48    -2.93    -1.02 1.00     6242     2527
## factortank42    -0.63      0.35    -1.34     0.03 1.00     6081     2929
## factortank43    -0.52      0.34    -1.20     0.15 1.00     5480     2523
## factortank44    -0.39      0.34    -1.08     0.25 1.00     6721     2985
## factortank45     0.51      0.35    -0.16     1.20 1.00     6432     3238
## factortank46    -0.63      0.35    -1.33     0.06 1.00     6303     2560
## factortank47     1.91      0.49     1.04     2.93 1.00     5039     2543
## factortank48    -0.06      0.34    -0.73     0.63 1.00     4892     3202
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>This is much like the models we’ve fit in earlier chapters using McElreath’s index approach, but on steroids. It’ll be instructive to take a look at their distributions in density plots. We’ll plot them in both their log-odds and probability metrics.</p>
<p>For kicks and giggles, let’s use a <a href="https://github.com/alex23lemm/theme_fivethirtyeight">FiveThirtyEight-like theme</a> for this chapter’s plots. An easy way to do so is with help from the <a href="https://cran.r-project.org/package=ggthemes"><strong>ggthemes</strong> package</a>.</p>
<div class="sourceCode" id="cb1534"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1534-1" data-line-number="1"><span class="kw">library</span>(ggthemes) </a>
<a class="sourceLine" id="cb1534-2" data-line-number="2"><span class="kw">library</span>(tidybayes)</a>
<a class="sourceLine" id="cb1534-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1534-4" data-line-number="4"><span class="co"># change the default</span></a>
<a class="sourceLine" id="cb1534-5" data-line-number="5"><span class="kw">theme_set</span>(<span class="kw">theme_gray</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme_fivethirtyeight</span>())</a>
<a class="sourceLine" id="cb1534-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1534-7" data-line-number="7"><span class="kw">tibble</span>(<span class="dt">estimate =</span> <span class="kw">fixef</span>(b13<span class="fl">.1</span>)[, <span class="dv">1</span>]) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1534-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p =</span> <span class="kw">inv_logit_scaled</span>(estimate)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1534-9" data-line-number="9"><span class="st">  </span><span class="kw">pivot_longer</span>(estimate<span class="op">:</span>p) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1534-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">if_else</span>(name <span class="op">==</span><span class="st"> &quot;p&quot;</span>, <span class="st">&quot;expected survival probability&quot;</span>, <span class="st">&quot;expected survival log-odds&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1534-11" data-line-number="11"><span class="st">  </span></a>
<a class="sourceLine" id="cb1534-12" data-line-number="12"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1534-13" data-line-number="13"><span class="st">  </span><span class="kw">stat_dots</span>(<span class="dt">size =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1534-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;orange1&quot;</span>, <span class="st">&quot;orange4&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1534-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1534-16" data-line-number="16"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Tank-level intercepts from the no-pooling model&quot;</span>,</a>
<a class="sourceLine" id="cb1534-17" data-line-number="17">       <span class="dt">subtitle =</span> <span class="st">&quot;Notice now inspecting the distributions of the posterior means can offer insights you</span><span class="ch">\n</span><span class="st">might not get if you looked at them one at a time.&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1534-18" data-line-number="18"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>,</a>
<a class="sourceLine" id="cb1534-19" data-line-number="19">        <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb1534-20" data-line-number="20"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>name, <span class="dt">scales =</span> <span class="st">&quot;free_x&quot;</span>)</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Even though it seems like we can derive important insights from how the <code>tank</code>-level intercepts are distributed, that information is not explicitly encoded in the statistical model. Keep that in mind as we now consider the multilevel alternative. Its formula is</p>
<p><span class="math display">\[\begin{align*}
\text{surv}_i             &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_{\text{tank}[i]} \\
\alpha_j                  &amp; \sim \operatorname{Normal}(\bar \alpha, \sigma) \\
\bar \alpha               &amp; \sim \operatorname{Normal}(0, 1.5) \\
\sigma                    &amp; \sim \operatorname{Exponential}(1),
\end{align*}\]</span></p>
<p>where</p>
<blockquote>
<p>the prior for the tank intercepts is now a function of two parameters, <span class="math inline">\(\bar \alpha\)</span> and <span class="math inline">\(\sigma\)</span>. You can say <span class="math inline">\(\bar \alpha\)</span> like “bar alpha.” The bar means average. These two parameters inside the prior is where the “multi” in multilevel arises. The Gaussian distribution with mean <span class="math inline">\(\bar \alpha\)</span> standard deviation <span class="math inline">\(\sigma\)</span> is the prior for each tank’s intercept. But that prior itself has priors for <span class="math inline">\(\bar \alpha\)</span> and <span class="math inline">\(\sigma\)</span>. So there are two <em>levels</em> in the model, each resembling a simpler model. (p. 403, <em>emphasis</em> in the original)</p>
</blockquote>
<p>With <strong>brms</strong>, you might specify the corresponding multilevel model like this.</p>
<div class="sourceCode" id="cb1535"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1535-1" data-line-number="1">b13<span class="fl">.2</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1535-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1535-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1535-4" data-line-number="4">      surv <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(density) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>tank),</a>
<a class="sourceLine" id="cb1535-5" data-line-number="5">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> Intercept),  <span class="co"># bar alpha</span></a>
<a class="sourceLine" id="cb1535-6" data-line-number="6">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd)),        <span class="co"># sigma</span></a>
<a class="sourceLine" id="cb1535-7" data-line-number="7">      <span class="dt">iter =</span> <span class="dv">5000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1535-8" data-line-number="8">      <span class="dt">sample_prior =</span> <span class="st">&quot;yes&quot;</span>,</a>
<a class="sourceLine" id="cb1535-9" data-line-number="9">      <span class="dt">seed =</span> <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb1535-10" data-line-number="10">      <span class="dt">file =</span> <span class="st">&quot;fits/b13.02&quot;</span>)</a></code></pre></div>
<p>The syntax for the varying effects follows the <a href="https://cran.r-project.org/package=brms/vignettes/brms_overview.pdf"><strong>lme4</strong> style</a>, <code>( &lt;varying parameter(s)&gt; | &lt;grouping variable(s)&gt; )</code>. In this case <code>(1 | tank)</code> indicates only the intercept, <code>1</code>, varies by <code>tank</code>. The extent to which parameters vary is controlled by the prior, <code>prior(exponential(1), class = sd)</code>, which is <u>parameterized in the standard deviation metric</u>. Do note that last part. It’s common in multilevel software to model in the variance metric, instead. For technical reasons we won’t really get into until Chapter 14, Stan parameterizes this as a standard deviation.</p>
<p>Let’s do the WAIC comparisons.</p>
<div class="sourceCode" id="cb1536"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1536-1" data-line-number="1">b13<span class="fl">.1</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.1</span>, <span class="st">&quot;waic&quot;</span>)</a>
<a class="sourceLine" id="cb1536-2" data-line-number="2">b13<span class="fl">.2</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.2</span>, <span class="st">&quot;waic&quot;</span>)</a>
<a class="sourceLine" id="cb1536-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1536-4" data-line-number="4">w &lt;-<span class="st"> </span><span class="kw">loo_compare</span>(b13<span class="fl">.1</span>, b13<span class="fl">.2</span>, <span class="dt">criterion =</span> <span class="st">&quot;waic&quot;</span>)</a>
<a class="sourceLine" id="cb1536-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1536-6" data-line-number="6"><span class="kw">print</span>(w, <span class="dt">simplify =</span> F)</a></code></pre></div>
<pre><code>##       elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
## b13.2    0.0       0.0  -100.1       3.7         21.0    0.8     200.3    7.4 
## b13.1   -7.6       1.9  -107.7       2.4         26.0    1.3     215.5    4.7</code></pre>
<p>The <code>se_diff</code> is large relative to the <code>elpd_diff</code>. If we convert the <span class="math inline">\(\text{elpd}\)</span> difference to the WAIC metric, the message stays the same.</p>
<div class="sourceCode" id="cb1538"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1538-1" data-line-number="1"><span class="kw">cbind</span>(<span class="dt">waic_diff =</span> w[, <span class="dv">1</span>] <span class="op">*</span><span class="st"> </span><span class="dv">-2</span>,</a>
<a class="sourceLine" id="cb1538-2" data-line-number="2">      <span class="dt">se        =</span> w[, <span class="dv">2</span>] <span class="op">*</span><span class="st">  </span><span class="dv">2</span>)</a></code></pre></div>
<pre><code>##       waic_diff       se
## b13.2   0.00000 0.000000
## b13.1  15.17549 3.773735</code></pre>
<p>Here are the WAIC weights.</p>
<div class="sourceCode" id="cb1540"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1540-1" data-line-number="1"><span class="kw">model_weights</span>(b13<span class="fl">.1</span>, b13<span class="fl">.2</span>, <span class="dt">weights =</span> <span class="st">&quot;waic&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1540-2" data-line-number="2"><span class="st">  </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## b13.1 b13.2 
##     0     1</code></pre>
<p>I’m not going to show it here, but if you’d like a challenge, try comparing the models with the PSIS-LOO. You’ll get some great practice with high <code>pareto_k</code> values, <code>kfold()</code> recommendations, and challenges implementing those <code>kfold()</code> recommendations. If you’re interested, pour yourself a calming adult beverage, execute the code below, and check out the <a href="https://discourse.mc-stan.org/t/kfold-error-new-factor-levels-are-not-allowed/8299">Kfold(): “Error: New factor levels are not allowed”</a> thread in the Stan forums.</p>
<p>But back on track, McElreath commented on the number of effective parameters for the two models. This, recall, is listed in the column for <span class="math inline">\(p_\text{WAIC}\)</span>.</p>
<div class="sourceCode" id="cb1542"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1542-1" data-line-number="1">w[, <span class="st">&quot;p_waic&quot;</span>]</a></code></pre></div>
<pre><code>##    b13.2    b13.1 
## 20.99286 25.97493</code></pre>
<p>And indeed, even though out multilevel model (<code>b13.2</code>) technically had two more parameters than the conventional single-level model (<code>b13.1</code>), its <span class="math inline">\(p_\text{WAIC}\)</span> is substantially smaller, due to the regularizing level-2 <span class="math inline">\(\sigma\)</span> parameter. Speaking of which, let’s examine the model summary.</p>
<div class="sourceCode" id="cb1544"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1544-1" data-line-number="1"><span class="kw">print</span>(b13<span class="fl">.2</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: surv | trials(density) ~ 1 + (1 | tank) 
##    Data: d (Number of observations: 48) 
## Samples: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
##          total post-warmup samples = 16000
## 
## Group-Level Effects: 
## ~tank (Number of levels: 48) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     1.62      0.21     1.25     2.09 1.00     3925     7523
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     1.34      0.26     0.85     1.87 1.00     2751     5431
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>This time we don’t get a list of 48 separate <code>tank</code>-level parameters. However, we do get a description of their distribution in terms of <span class="math inline">\(\bar \alpha\)</span> (i.e., <code>Intercept</code>) and <span class="math inline">\(\sigma\)</span> (i.e., <code>sd(Intercept)</code>). If you’d like the actual <code>tank</code>-level parameters, don’t worry; they’re coming in Figure 13.1. We’ll need to do a little prep work, though.</p>
<div class="sourceCode" id="cb1546"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1546-1" data-line-number="1">post &lt;-<span class="st"> </span><span class="kw">posterior_samples</span>(b13<span class="fl">.2</span>)</a>
<a class="sourceLine" id="cb1546-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1546-3" data-line-number="3">post_mdn &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1546-4" data-line-number="4"><span class="st">  </span><span class="kw">coef</span>(b13<span class="fl">.2</span>, <span class="dt">robust =</span> T)<span class="op">$</span>tank[, , ] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1546-5" data-line-number="5"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1546-6" data-line-number="6"><span class="st">  </span><span class="kw">bind_cols</span>(d) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1546-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">post_mdn =</span> <span class="kw">inv_logit_scaled</span>(Estimate))</a>
<a class="sourceLine" id="cb1546-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1546-9" data-line-number="9"><span class="kw">head</span>(post_mdn)</a></code></pre></div>
<pre><code>##    Estimate Est.Error       Q2.5    Q97.5 density pred  size surv propsurv tank  post_mdn
## 1 2.0807851 0.8456408  0.6169004 3.995959      10   no   big    9      0.9    1 0.8890215
## 2 2.9710479 1.0865864  1.1927605 5.535820      10   no   big   10      1.0    2 0.9512489
## 3 0.9892671 0.6741416 -0.2584084 2.448554      10   no   big    7      0.7    3 0.7289431
## 4 2.9590868 1.0867701  1.1895391 5.592523      10   no   big   10      1.0    4 0.9506912
## 5 2.0680600 0.8773067  0.5837285 4.066780      10   no small    9      0.9    5 0.8877598
## 6 2.0711689 0.8389577  0.6088897 4.024909      10   no small    9      0.9    6 0.8880692</code></pre>
<p>Here’s the <strong>ggplot2</strong> code to reproduce Figure 13.1.</p>
<div class="sourceCode" id="cb1548"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1548-1" data-line-number="1">post_mdn <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1548-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> tank)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1548-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="kw">inv_logit_scaled</span>(<span class="kw">median</span>(post<span class="op">$</span>b_Intercept)), <span class="dt">linetype =</span> <span class="dv">2</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1548-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="kw">c</span>(<span class="fl">16.5</span>, <span class="fl">32.5</span>), <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">color =</span> <span class="st">&quot;grey25&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1548-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> propsurv), <span class="dt">color =</span> <span class="st">&quot;orange2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1548-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> post_mdn), <span class="dt">shape =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1548-7" data-line-number="7"><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">8</span>, <span class="dv">16</span> <span class="op">+</span><span class="st"> </span><span class="dv">8</span>, <span class="dv">32</span> <span class="op">+</span><span class="st"> </span><span class="dv">8</span>), <span class="dt">y =</span> <span class="dv">0</span>, </a>
<a class="sourceLine" id="cb1548-8" data-line-number="8">           <span class="dt">label =</span> <span class="kw">c</span>(<span class="st">&quot;small tanks&quot;</span>, <span class="st">&quot;medium tanks&quot;</span>, <span class="st">&quot;large tanks&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1548-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">16</span>, <span class="dv">32</span>, <span class="dv">48</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1548-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">5</span> <span class="op">/</span><span class="st"> </span><span class="dv">5</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1548-11" data-line-number="11"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Multilevel shrinkage!&quot;</span>,</a>
<a class="sourceLine" id="cb1548-12" data-line-number="12">       <span class="dt">subtitle =</span> <span class="st">&quot;The empirical proportions are in orange while the model-</span><span class="ch">\n</span><span class="st">implied proportions are the black circles. The dashed line is</span><span class="ch">\n</span><span class="st">the model-implied average survival proportion.&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1548-13" data-line-number="13"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid.major =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-16-1.png" width="480" style="display: block; margin: auto;" /></p>
<p>Here is the code for our version of Figure 13.2.a, where we visualize the model-implied population distribution of log-odds survival (i.e., the population distribution yielding all the <code>tank</code>-level intercepts).</p>
<div class="sourceCode" id="cb1549"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1549-1" data-line-number="1"><span class="co"># this makes the output of `sample_n()` reproducible</span></a>
<a class="sourceLine" id="cb1549-2" data-line-number="2"><span class="kw">set.seed</span>(<span class="dv">13</span>)</a>
<a class="sourceLine" id="cb1549-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1549-4" data-line-number="4">p1 &lt;-</a>
<a class="sourceLine" id="cb1549-5" data-line-number="5"><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1549-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">iter =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1549-7" data-line-number="7"><span class="st">  </span><span class="kw">sample_n</span>(<span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1549-8" data-line-number="8"><span class="st">  </span><span class="kw">expand</span>(<span class="kw">nesting</span>(iter, b_Intercept, sd_tank__Intercept),</a>
<a class="sourceLine" id="cb1549-9" data-line-number="9">         <span class="dt">x =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">-4</span>, <span class="dt">to =</span> <span class="dv">5</span>, <span class="dt">length.out =</span> <span class="dv">100</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1549-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">density =</span> <span class="kw">dnorm</span>(x, <span class="dt">mean =</span> b_Intercept, <span class="dt">sd =</span> sd_tank__Intercept)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1549-11" data-line-number="11"><span class="st">    </span></a>
<a class="sourceLine" id="cb1549-12" data-line-number="12"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> density, <span class="dt">group =</span> iter)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1549-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">.2</span>, <span class="dt">color =</span> <span class="st">&quot;orange2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1549-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1549-15" data-line-number="15"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Population survival distribution&quot;</span>,</a>
<a class="sourceLine" id="cb1549-16" data-line-number="16">       <span class="dt">subtitle =</span> <span class="st">&quot;log-odds scale&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1549-17" data-line-number="17"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">4</span>))</a></code></pre></div>
<p>Now we make our Figure 13.2.b and then bind the two subplots with <strong>patchwork</strong>.</p>
<div class="sourceCode" id="cb1550"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1550-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">13</span>)</a>
<a class="sourceLine" id="cb1550-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1550-3" data-line-number="3">p2 &lt;-</a>
<a class="sourceLine" id="cb1550-4" data-line-number="4"><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1550-5" data-line-number="5"><span class="st">  </span><span class="kw">sample_n</span>(<span class="dv">8000</span>, <span class="dt">replace =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1550-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sim_tanks =</span> <span class="kw">rnorm</span>(<span class="kw">n</span>(), <span class="dt">mean =</span> b_Intercept, <span class="dt">sd =</span> sd_tank__Intercept)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1550-7" data-line-number="7"><span class="st">  </span></a>
<a class="sourceLine" id="cb1550-8" data-line-number="8"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">inv_logit_scaled</span>(sim_tanks))) <span class="op">+</span></a>
<a class="sourceLine" id="cb1550-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">fill =</span> <span class="st">&quot;orange2&quot;</span>, <span class="dt">adjust =</span> <span class="fl">0.1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1550-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1550-11" data-line-number="11"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Probability of survival&quot;</span>,</a>
<a class="sourceLine" id="cb1550-12" data-line-number="12">       <span class="dt">subtitle =</span> <span class="st">&quot;transformed by the inverse-logit function&quot;</span>)</a>
<a class="sourceLine" id="cb1550-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1550-14" data-line-number="14"><span class="kw">library</span>(patchwork)</a>
<a class="sourceLine" id="cb1550-15" data-line-number="15"></a>
<a class="sourceLine" id="cb1550-16" data-line-number="16">(p1 <span class="op">+</span><span class="st"> </span>p2) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb1550-17" data-line-number="17"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">12</span>),</a>
<a class="sourceLine" id="cb1550-18" data-line-number="18">        <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">10</span>))</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-18-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>Both plots show different ways in expressing the model uncertainty in terms of both location <span class="math inline">\(\alpha\)</span> and scale <span class="math inline">\(\sigma\)</span>.</p>
<div id="rethinking-varying-intercepts-as-over-dispersion." class="section level4">
<h4><span class="header-section-number">13.1.0.1</span> Rethinking: Varying intercepts as over-dispersion.</h4>
<blockquote>
<p>In the previous chapter (<a href="monsters-and-mixtures.html#over-dispersed-counts">page 369</a>), the beta-binomial and gamma-Poisson models were presented as ways for coping with <strong>over-dispersion</strong> of count data. Varying intercepts accomplish the same thing, allowing count outcomes to be over-dispersed. They accomplish this, because when each observed count gets its own unique intercept, but these intercepts are pooled through a common distribution, the predictions expect over-dispersion just like a beta-binomial or gamma-Poisson model would. Multilevel models are also mixtures. Compared to a beta-binomial or gamma-Poisson model, a binomial or Poisson model with a varying intercept on every observed outcome will often be easier to estimate and easier to extend. (p. 407, <strong>emphasis</strong> in the original)</p>
</blockquote>
</div>
<div id="overthinking-prior-for-variance-components." class="section level4">
<h4><span class="header-section-number">13.1.0.2</span> Overthinking: Prior for variance components.</h4>
<p>Yep, you can use the half-Normal distribution for your priors in <strong>brms</strong>, too. Here it is for model <code>b13.2</code>.</p>
<div class="sourceCode" id="cb1551"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1551-1" data-line-number="1">b13<span class="fl">.2</span>b &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1551-2" data-line-number="2"><span class="st">  </span><span class="kw">update</span>(b13<span class="fl">.2</span>,</a>
<a class="sourceLine" id="cb1551-3" data-line-number="3">         <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1551-4" data-line-number="4">                   <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> sd)),</a>
<a class="sourceLine" id="cb1551-5" data-line-number="5">         <span class="dt">iter =</span> <span class="dv">5000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1551-6" data-line-number="6">         <span class="dt">sample_prior =</span> <span class="st">&quot;yes&quot;</span>,</a>
<a class="sourceLine" id="cb1551-7" data-line-number="7">         <span class="dt">seed =</span> <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb1551-8" data-line-number="8">         <span class="dt">file =</span> <span class="st">&quot;fits/b13.02b&quot;</span>)</a></code></pre></div>
<p>Check the model summary.</p>
<div class="sourceCode" id="cb1552"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1552-1" data-line-number="1"><span class="kw">print</span>(b13<span class="fl">.2</span>b)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: surv | trials(density) ~ 1 + (1 | tank) 
##    Data: d (Number of observations: 48) 
## Samples: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
##          total post-warmup samples = 16000
## 
## Group-Level Effects: 
## ~tank (Number of levels: 48) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     1.59      0.20     1.24     2.03 1.00     4125     7606
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     1.34      0.25     0.85     1.84 1.00     3027     5850
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>If you’re curious how the exponential and half-Normal priors compare to one another and to their posteriors, you might just plot.</p>
<div class="sourceCode" id="cb1554"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1554-1" data-line-number="1"><span class="co"># for annotation</span></a>
<a class="sourceLine" id="cb1554-2" data-line-number="2">text &lt;-</a>
<a class="sourceLine" id="cb1554-3" data-line-number="3"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">value        =</span> <span class="kw">c</span>(<span class="fl">0.5</span>, <span class="fl">2.4</span>),</a>
<a class="sourceLine" id="cb1554-4" data-line-number="4">         <span class="dt">density      =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">1.85</span>),</a>
<a class="sourceLine" id="cb1554-5" data-line-number="5">         <span class="dt">distribution =</span> <span class="kw">factor</span>(<span class="kw">c</span>(<span class="st">&quot;prior&quot;</span>, <span class="st">&quot;posterior&quot;</span>), <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;prior&quot;</span>, <span class="st">&quot;posterior&quot;</span>)),</a>
<a class="sourceLine" id="cb1554-6" data-line-number="6">         <span class="dt">prior        =</span> <span class="st">&quot;Exponential(1)&quot;</span>)</a>
<a class="sourceLine" id="cb1554-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1554-8" data-line-number="8"><span class="co"># gather and wrangle the prior and posterior draws</span></a>
<a class="sourceLine" id="cb1554-9" data-line-number="9"><span class="kw">tibble</span>(<span class="st">`</span><span class="dt">prior_Exponential(1)</span><span class="st">`</span>        =<span class="st"> </span><span class="kw">prior_samples</span>(b13<span class="fl">.2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(sd_tank),</a>
<a class="sourceLine" id="cb1554-10" data-line-number="10">       <span class="st">`</span><span class="dt">posterior_Exponential(1)</span><span class="st">`</span>    =<span class="st"> </span><span class="kw">posterior_samples</span>(b13<span class="fl">.2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(sd_tank__Intercept),</a>
<a class="sourceLine" id="cb1554-11" data-line-number="11">       <span class="st">`</span><span class="dt">prior_Half-Normal(0, 1)</span><span class="st">`</span>     =<span class="st"> </span><span class="kw">prior_samples</span>(b13<span class="fl">.2</span>b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(sd_tank),</a>
<a class="sourceLine" id="cb1554-12" data-line-number="12">       <span class="st">`</span><span class="dt">posterior_Half-Normal(0, 1)</span><span class="st">`</span> =<span class="st"> </span><span class="kw">posterior_samples</span>(b13<span class="fl">.2</span>b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(sd_tank__Intercept)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1554-13" data-line-number="13"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>(),</a>
<a class="sourceLine" id="cb1554-14" data-line-number="14">               <span class="dt">names_sep =</span> <span class="st">&quot;_&quot;</span>,</a>
<a class="sourceLine" id="cb1554-15" data-line-number="15">               <span class="dt">names_to =</span> <span class="kw">c</span>(<span class="st">&quot;distribution&quot;</span>, <span class="st">&quot;prior&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1554-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">distribution =</span> <span class="kw">factor</span>(distribution, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;prior&quot;</span>, <span class="st">&quot;posterior&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1554-17" data-line-number="17"><span class="st">  </span></a>
<a class="sourceLine" id="cb1554-18" data-line-number="18"><span class="st">  </span><span class="co"># plot!</span></a>
<a class="sourceLine" id="cb1554-19" data-line-number="19"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> distribution)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1554-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">adjust =</span> <span class="fl">0.25</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1554-21" data-line-number="21"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> text,</a>
<a class="sourceLine" id="cb1554-22" data-line-number="22">            <span class="kw">aes</span>(<span class="dt">y =</span> density, <span class="dt">label =</span> distribution, <span class="dt">color =</span> distribution)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1554-23" data-line-number="23"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="ot">NULL</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;orange4&quot;</span>, <span class="st">&quot;orange2&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1554-24" data-line-number="24"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="ot">NULL</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;orange4&quot;</span>, <span class="st">&quot;orange2&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1554-25" data-line-number="25"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1554-26" data-line-number="26"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="kw">expression</span>(Hierarchical<span class="op">~</span>sigma<span class="op">~</span>parameter)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1554-27" data-line-number="27"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">4</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1554-28" data-line-number="28"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1554-29" data-line-number="29"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>prior)</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-20-1.png" width="528" style="display: block; margin: auto;" /></p>
<p>By the way, this is why we set <code>iter = 5000</code> and <code>sample_prior = &quot;yes&quot;</code> for the last two models. Neither were necessary to fit the models, but both helped us out with this plot.</p>
</div>
</div>
<div id="varying-effects-and-the-underfittingoverfitting-trade-off" class="section level2">
<h2><span class="header-section-number">13.2</span> Varying effects and the underfitting/overfitting trade-off</h2>
<blockquote>
<p>Varying intercepts are just regularized estimates, but adaptively regularized by estimat- ing how diverse the clusters are while estimating the features of each cluster. This fact is not easy to grasp…
A major benefit of using varying effects estimates, instead of the empirical raw estimates, is that they provide more accurate estimates of the individual cluster (tank) intercepts. On average, the varying effects actually provide a better estimate of the individual tank (cluster) means. The reason that the varying intercepts provide better estimates is that they do a better job of trading off underfitting and overfitting. (p. 408)</p>
</blockquote>
<p>In this section, we explicate this by contrasting three perspectives:</p>
<ul>
<li>complete pooling (i.e., a single-<span class="math inline">\(\alpha\)</span> model),</li>
<li>no pooling (i.e., the single-level <span class="math inline">\(\alpha_{\text{tank}[i]}\)</span> model), and</li>
<li>partial pooling [i.e., the multilevel model for which <span class="math inline">\(\alpha_j \sim \operatorname{Normal} (\bar \alpha, \sigma)\)</span>].</li>
</ul>
<blockquote>
<p>To demonstrate [the magic of the multilevel model], we’ll simulate some tadpole data. That way, we’ll know the true per-pond survival probabilities. Then we can compare the no-pooling estimates to the partial pooling estimates, by computing how close each gets to the true values they are trying to estimate. The rest of this section shows how to do such a simulation. (p. 409)</p>
</blockquote>
<div id="the-model.-1" class="section level3">
<h3><span class="header-section-number">13.2.1</span> The model.</h3>
<p>The simulation formula should look familiar.</p>
<p><span class="math display">\[\begin{align*}
\text{surv}_i &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_{\text{pond}[i]} \\
\alpha_j                  &amp; \sim \operatorname{Normal}(\bar \alpha, \sigma) \\
\bar \alpha               &amp; \sim \operatorname{Normal}(0, 1.5) \\
\sigma                    &amp; \sim \operatorname{Exponential}(1)
\end{align*}\]</span></p>
</div>
<div id="assign-values-to-the-parameters." class="section level3">
<h3><span class="header-section-number">13.2.2</span> Assign values to the parameters.</h3>
<p>Here we follow along with McElreath and “assign specific values representative of the actual tadpole data” (p. 409). Because he included a <code>set.seed()</code> line, our results should match his exactly.</p>
<div class="sourceCode" id="cb1555"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1555-1" data-line-number="1">a_bar   &lt;-<span class="st">  </span><span class="fl">1.5</span></a>
<a class="sourceLine" id="cb1555-2" data-line-number="2">sigma   &lt;-<span class="st">  </span><span class="fl">1.5</span></a>
<a class="sourceLine" id="cb1555-3" data-line-number="3">n_ponds &lt;-<span class="st"> </span><span class="dv">60</span></a>
<a class="sourceLine" id="cb1555-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1555-5" data-line-number="5"><span class="kw">set.seed</span>(<span class="dv">5005</span>)</a>
<a class="sourceLine" id="cb1555-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1555-7" data-line-number="7">dsim &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1555-8" data-line-number="8"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">pond   =</span> <span class="dv">1</span><span class="op">:</span>n_ponds,</a>
<a class="sourceLine" id="cb1555-9" data-line-number="9">         <span class="dt">ni     =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">35</span>), <span class="dt">each =</span> n_ponds <span class="op">/</span><span class="st"> </span><span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.integer</span>(),</a>
<a class="sourceLine" id="cb1555-10" data-line-number="10">         <span class="dt">true_a =</span> <span class="kw">rnorm</span>(<span class="dt">n =</span> n_ponds, <span class="dt">mean =</span> a_bar, <span class="dt">sd =</span> sigma))</a>
<a class="sourceLine" id="cb1555-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1555-12" data-line-number="12"><span class="kw">head</span>(dsim)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##    pond    ni true_a
##   &lt;int&gt; &lt;int&gt;  &lt;dbl&gt;
## 1     1     5  0.567
## 2     2     5  1.99 
## 3     3     5 -0.138
## 4     4     5  1.86 
## 5     5     5  3.91 
## 6     6     5  1.95</code></pre>
<p>McElreath twice urged us to inspect the contents of ths simulation. In addition to looking at the data with <code>head()</code>, we might well plot.</p>
<div class="sourceCode" id="cb1557"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1557-1" data-line-number="1">dsim <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1557-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ni =</span> <span class="kw">factor</span>(ni)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1557-3" data-line-number="3"><span class="st">  </span></a>
<a class="sourceLine" id="cb1557-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> true_a, <span class="dt">y =</span> ni)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1557-5" data-line-number="5"><span class="st">  </span><span class="kw">stat_dotsinterval</span>(<span class="dt">fill =</span> <span class="st">&quot;orange2&quot;</span>, <span class="dt">slab_size =</span> <span class="dv">0</span>, <span class="dt">.width =</span> <span class="fl">.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1557-6" data-line-number="6"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Log-odds varying by # tadpoles per pond&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1557-7" data-line-number="7"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">14</span>))</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-22-1.png" width="480" style="display: block; margin: auto;" /></p>
</div>
<div id="sumulate-survivors." class="section level3">
<h3><span class="header-section-number">13.2.3</span> Sumulate survivors.</h3>
<blockquote>
<p>Each pond <span class="math inline">\(i\)</span> has <span class="math inline">\(n_i\)</span> potential survivors, and nature flips each tadpole’s coin, so to speak, with probability of survival <span class="math inline">\(p_i\)</span>. This probability <span class="math inline">\(p_i\)</span> is implied by the model definition, and is equal to:</p>
<p><span class="math display">\[p_i = \frac{\exp (\alpha_i)}{1 + \exp (\alpha_i)}\]</span></p>
<p>The model uses a logit link, and so the probability is defined by the [<code>inv_logit_scaled()</code>] function. (p. 411)</p>
</blockquote>
<p>Although McElreath shared his <code>set.seed()</code> number in the last section, he didn’t share it for this bit. We’ll go ahead and carry over the one from last time. However, in a moment we’ll see this clearly wasn’t the one he used here. As a consequence, our results will deviate a bit from his.</p>
<div class="sourceCode" id="cb1558"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1558-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">5005</span>)</a>
<a class="sourceLine" id="cb1558-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1558-3" data-line-number="3">(</a>
<a class="sourceLine" id="cb1558-4" data-line-number="4">  dsim &lt;-</a>
<a class="sourceLine" id="cb1558-5" data-line-number="5"><span class="st">  </span>dsim <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1558-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">si =</span> <span class="kw">rbinom</span>(<span class="dt">n =</span> <span class="kw">n</span>(), <span class="dt">prob =</span> <span class="kw">inv_logit_scaled</span>(true_a), <span class="dt">size =</span> ni))</a>
<a class="sourceLine" id="cb1558-7" data-line-number="7">)</a></code></pre></div>
<pre><code>## # A tibble: 60 x 4
##     pond    ni true_a    si
##    &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;int&gt;
##  1     1     5  0.567     4
##  2     2     5  1.99      4
##  3     3     5 -0.138     3
##  4     4     5  1.86      5
##  5     5     5  3.91      5
##  6     6     5  1.95      4
##  7     7     5  1.49      4
##  8     8     5  2.52      4
##  9     9     5  2.18      3
## 10    10     5  2.05      4
## # … with 50 more rows</code></pre>
</div>
<div id="compute-the-no-pooling-estimates." class="section level3">
<h3><span class="header-section-number">13.2.4</span> Compute the no-pooling estimates.</h3>
<p>The no-pooling estimates (i.e., <span class="math inline">\(\alpha_{\text{tank}_i}\)</span>) are the results of simple algebra.</p>
<div class="sourceCode" id="cb1560"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1560-1" data-line-number="1">(</a>
<a class="sourceLine" id="cb1560-2" data-line-number="2">  dsim &lt;-</a>
<a class="sourceLine" id="cb1560-3" data-line-number="3"><span class="st">  </span>dsim <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1560-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p_nopool =</span> si <span class="op">/</span><span class="st"> </span>ni)</a>
<a class="sourceLine" id="cb1560-5" data-line-number="5">)</a></code></pre></div>
<pre><code>## # A tibble: 60 x 5
##     pond    ni true_a    si p_nopool
##    &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt;
##  1     1     5  0.567     4      0.8
##  2     2     5  1.99      4      0.8
##  3     3     5 -0.138     3      0.6
##  4     4     5  1.86      5      1  
##  5     5     5  3.91      5      1  
##  6     6     5  1.95      4      0.8
##  7     7     5  1.49      4      0.8
##  8     8     5  2.52      4      0.8
##  9     9     5  2.18      3      0.6
## 10    10     5  2.05      4      0.8
## # … with 50 more rows</code></pre>
<p>“These are the same no-pooling estimates you’d get by fitting a model with a dummy variable for each pond and flat priors that induce no regularization” (p. 411). That is, these are the same kinds of estimates we got back when we fit <code>b13.1</code>.</p>
</div>
<div id="compute-the-partial-pooling-estimates." class="section level3">
<h3><span class="header-section-number">13.2.5</span> Compute the partial-pooling estimates.</h3>
<p>Fit the multilevel (partial-pooling) model.</p>
<div class="sourceCode" id="cb1562"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1562-1" data-line-number="1">b13<span class="fl">.3</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1562-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> dsim, </a>
<a class="sourceLine" id="cb1562-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1562-4" data-line-number="4">      si <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(ni) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>pond),</a>
<a class="sourceLine" id="cb1562-5" data-line-number="5">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1562-6" data-line-number="6">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd)),</a>
<a class="sourceLine" id="cb1562-7" data-line-number="7">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1562-8" data-line-number="8">      <span class="dt">seed =</span> <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb1562-9" data-line-number="9">      <span class="dt">file =</span> <span class="st">&quot;fits/b13.03&quot;</span>)</a></code></pre></div>
<p>Here’s our standard <strong>brms</strong> summary.</p>
<div class="sourceCode" id="cb1563"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1563-1" data-line-number="1"><span class="kw">print</span>(b13<span class="fl">.3</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: si | trials(ni) ~ 1 + (1 | pond) 
##    Data: dsim (Number of observations: 60) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Group-Level Effects: 
## ~pond (Number of levels: 60) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     1.50      0.20     1.15     1.94 1.00     1511     2352
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     1.46      0.23     1.03     1.92 1.00     1071     1801
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>I’m not aware that you can use McElreath’s <code>depth=2</code> trick in <strong>brms</strong> for <code>summary()</code> or <code>print()</code>. However, you can get most of that information and more with the Stan-like summary using the <code>$fit</code> syntax.</p>
<div class="sourceCode" id="cb1565"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1565-1" data-line-number="1">b13<span class="fl">.3</span><span class="op">$</span>fit</a></code></pre></div>
<pre><code>## Inference for Stan model: a077003526b0a3eaf501765accf709a9.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##                         mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
## b_Intercept             1.46    0.01 0.23    1.03    1.31    1.45    1.61    1.92  1060 1.00
## sd_pond__Intercept      1.50    0.01 0.20    1.15    1.36    1.49    1.63    1.94  1521 1.00
## r_pond[1,Intercept]     0.08    0.01 0.93   -1.62   -0.56    0.04    0.67    2.04  6122 1.00
## r_pond[2,Intercept]     0.09    0.01 0.95   -1.63   -0.56    0.03    0.68    2.11  6021 1.00
## r_pond[3,Intercept]    -0.70    0.01 0.86   -2.34   -1.28   -0.72   -0.13    1.05  7466 1.00
## r_pond[4,Intercept]     1.15    0.01 1.14   -0.89    0.34    1.10    1.86    3.61  6114 1.00
## r_pond[5,Intercept]     1.13    0.01 1.14   -0.83    0.33    1.05    1.85    3.67  6901 1.00
## r_pond[6,Intercept]     0.08    0.01 0.95   -1.65   -0.57    0.03    0.68    2.11  6043 1.00
## r_pond[7,Intercept]     0.10    0.01 0.93   -1.63   -0.53    0.05    0.69    2.11  6789 1.00
## r_pond[8,Intercept]     0.08    0.01 0.95   -1.62   -0.58    0.05    0.70    2.05  5401 1.00
## r_pond[9,Intercept]    -0.68    0.01 0.89   -2.44   -1.27   -0.70   -0.10    1.16  7189 1.00
## r_pond[10,Intercept]    0.08    0.01 0.94   -1.62   -0.57    0.04    0.69    2.02  7059 1.00
## r_pond[11,Intercept]    1.16    0.01 1.15   -0.89    0.35    1.10    1.86    3.69  6578 1.00
## r_pond[12,Intercept]   -1.36    0.01 0.83   -2.98   -1.93   -1.37   -0.81    0.31  6286 1.00
## r_pond[13,Intercept]    1.18    0.02 1.17   -0.90    0.36    1.10    1.91    3.73  4892 1.00
## r_pond[14,Intercept]    0.10    0.01 0.97   -1.66   -0.58    0.05    0.75    2.17  7258 1.00
## r_pond[15,Intercept]    1.13    0.01 1.13   -0.94    0.38    1.04    1.81    3.72  6127 1.00
## r_pond[16,Intercept]   -0.84    0.01 0.65   -2.08   -1.28   -0.85   -0.42    0.46  4900 1.00
## r_pond[17,Intercept]   -1.94    0.01 0.65   -3.24   -2.38   -1.93   -1.49   -0.74  5512 1.00
## r_pond[18,Intercept]   -1.22    0.01 0.64   -2.50   -1.63   -1.22   -0.81    0.01  5038 1.00
## r_pond[19,Intercept]   -1.22    0.01 0.66   -2.52   -1.64   -1.23   -0.79    0.11  5463 1.00
## r_pond[20,Intercept]   -0.43    0.01 0.66   -1.71   -0.88   -0.45   -0.02    0.92  5338 1.00
## r_pond[21,Intercept]   -1.57    0.01 0.65   -2.88   -2.00   -1.57   -1.14   -0.34  5106 1.00
## r_pond[22,Intercept]    0.68    0.01 0.88   -0.89    0.05    0.62    1.25    2.52  6972 1.00
## r_pond[23,Intercept]    1.55    0.02 1.08   -0.32    0.79    1.46    2.20    3.92  4832 1.00
## r_pond[24,Intercept]   -0.84    0.01 0.66   -2.10   -1.29   -0.86   -0.41    0.51  5938 1.00
## r_pond[25,Intercept]    0.05    0.01 0.74   -1.32   -0.45    0.00    0.55    1.56  5025 1.00
## r_pond[26,Intercept]    0.66    0.01 0.83   -0.82    0.08    0.62    1.20    2.42  6639 1.00
## r_pond[27,Intercept]    0.05    0.01 0.76   -1.36   -0.47    0.03    0.53    1.67  6554 1.00
## r_pond[28,Intercept]   -0.42    0.01 0.67   -1.65   -0.87   -0.44   -0.01    0.98  5017 1.00
## r_pond[29,Intercept]   -0.86    0.01 0.64   -2.10   -1.28   -0.86   -0.43    0.40  4777 1.00
## r_pond[30,Intercept]   -0.43    0.01 0.69   -1.74   -0.90   -0.46    0.02    1.00  5072 1.00
## r_pond[31,Intercept]    1.42    0.01 0.78    0.06    0.88    1.37    1.90    3.14  5138 1.00
## r_pond[32,Intercept]    0.54    0.01 0.59   -0.57    0.15    0.52    0.91    1.76  4400 1.00
## r_pond[33,Intercept]    1.41    0.01 0.79    0.00    0.86    1.37    1.91    3.07  5011 1.00
## r_pond[34,Intercept]   -0.44    0.01 0.48   -1.36   -0.78   -0.44   -0.11    0.50  3546 1.00
## r_pond[35,Intercept]   -0.96    0.01 0.46   -1.83   -1.27   -0.97   -0.65   -0.07  2991 1.00
## r_pond[36,Intercept]    2.11    0.01 0.98    0.46    1.42    2.01    2.71    4.33  5117 1.00
## r_pond[37,Intercept]   -3.37    0.01 0.61   -4.66   -3.75   -3.32   -2.93   -2.26  4106 1.00
## r_pond[38,Intercept]   -2.07    0.01 0.47   -3.00   -2.38   -2.06   -1.76   -1.18  3120 1.00
## r_pond[39,Intercept]   -0.96    0.01 0.46   -1.86   -1.26   -0.97   -0.66   -0.05  3271 1.00
## r_pond[40,Intercept]    2.12    0.01 0.95    0.50    1.47    2.03    2.70    4.20  4706 1.00
## r_pond[41,Intercept]    2.12    0.02 1.01    0.44    1.41    2.02    2.71    4.40  4535 1.00
## r_pond[42,Intercept]    0.55    0.01 0.60   -0.56    0.14    0.52    0.94    1.79  4187 1.00
## r_pond[43,Intercept]   -1.75    0.01 0.45   -2.65   -2.04   -1.74   -1.45   -0.88  3237 1.00
## r_pond[44,Intercept]   -0.62    0.01 0.48   -1.56   -0.95   -0.63   -0.30    0.32  3150 1.00
## r_pond[45,Intercept]   -2.63    0.01 0.51   -3.65   -2.96   -2.62   -2.28   -1.63  3511 1.00
## r_pond[46,Intercept]   -1.44    0.01 0.39   -2.21   -1.71   -1.44   -1.18   -0.69  2376 1.00
## r_pond[47,Intercept]    2.32    0.01 0.92    0.78    1.68    2.21    2.87    4.39  4111 1.00
## r_pond[48,Intercept]    2.34    0.01 0.95    0.74    1.67    2.25    2.93    4.43  4640 1.00
## r_pond[49,Intercept]    0.15    0.01 0.47   -0.73   -0.17    0.14    0.47    1.09  3387 1.00
## r_pond[50,Intercept]    0.16    0.01 0.48   -0.77   -0.17    0.16    0.48    1.14  3247 1.00
## r_pond[51,Intercept]    0.16    0.01 0.49   -0.77   -0.18    0.15    0.47    1.17  3062 1.00
## r_pond[52,Intercept]   -1.44    0.01 0.40   -2.22   -1.70   -1.44   -1.17   -0.68  2787 1.00
## r_pond[53,Intercept]    0.16    0.01 0.49   -0.77   -0.19    0.15    0.48    1.16  3314 1.00
## r_pond[54,Intercept]    2.34    0.01 0.94    0.77    1.66    2.26    2.91    4.44  4441 1.00
## r_pond[55,Intercept]   -0.87    0.01 0.40   -1.67   -1.13   -0.87   -0.61   -0.08  2165 1.00
## r_pond[56,Intercept]    1.69    0.01 0.74    0.41    1.17    1.63    2.14    3.36  5256 1.00
## r_pond[57,Intercept]   -0.75    0.01 0.42   -1.58   -1.03   -0.76   -0.48    0.10  3037 1.00
## r_pond[58,Intercept]    1.23    0.01 0.65    0.06    0.79    1.19    1.65    2.62  4283 1.00
## r_pond[59,Intercept]    0.36    0.01 0.51   -0.62    0.01    0.34    0.69    1.41  3123 1.00
## r_pond[60,Intercept]    1.24    0.01 0.64    0.09    0.80    1.19    1.63    2.59  4586 1.00
## lp__                 -185.60    0.26 7.41 -201.25 -190.29 -185.19 -180.53 -172.41   792 1.01
## 
## Samples were drawn using NUTS(diag_e) at Tue Jul 28 15:07:36 2020.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<p>As an aside, notice how this summary still reports the old-style <code>n_eff</code> values, rather than the updated <code>Bulk_ESS</code> and <code>Tail_ESS</code> values. I suspect this will change sometime soon. In the meantime, here’s a <a href="https://discourse.mc-stan.org/t/new-r-hat-and-ess/8165">thread on the Stan Forums</a> featuring members of the Stan team discussing how.</p>
<p>Let’s get ready for the diagnostic plot of Figure 13.3. First we add the partially-pooled estimates, as summarized by their posterior means, to the <code>dsim</code> data. Then we compute error values.</p>
<div class="sourceCode" id="cb1567"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1567-1" data-line-number="1"><span class="co"># we could have included this step in the block of code below, if we wanted to</span></a>
<a class="sourceLine" id="cb1567-2" data-line-number="2">p_partpool &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1567-3" data-line-number="3"><span class="st">  </span><span class="kw">coef</span>(b13<span class="fl">.3</span>)<span class="op">$</span>pond[, , ] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1567-4" data-line-number="4"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1567-5" data-line-number="5"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">p_partpool =</span> <span class="kw">inv_logit_scaled</span>(Estimate))</a>
<a class="sourceLine" id="cb1567-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1567-7" data-line-number="7">dsim &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1567-8" data-line-number="8"><span class="st">  </span>dsim <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1567-9" data-line-number="9"><span class="st">  </span><span class="kw">bind_cols</span>(p_partpool) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1567-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p_true =</span> <span class="kw">inv_logit_scaled</span>(true_a)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1567-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">nopool_error   =</span> <span class="kw">abs</span>(p_nopool   <span class="op">-</span><span class="st"> </span>p_true),</a>
<a class="sourceLine" id="cb1567-12" data-line-number="12">         <span class="dt">partpool_error =</span> <span class="kw">abs</span>(p_partpool <span class="op">-</span><span class="st"> </span>p_true))</a>
<a class="sourceLine" id="cb1567-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1567-14" data-line-number="14">dsim <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1567-15" data-line-number="15"><span class="st">  </span><span class="kw">glimpse</span>()</a></code></pre></div>
<pre><code>## Rows: 60
## Columns: 9
## $ pond           &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 2…
## $ ni             &lt;int&gt; 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,…
## $ true_a         &lt;dbl&gt; 0.56673123, 1.99002317, -0.13775688, 1.85676651, 3.91208800, 1.95414869, 1.48963805,…
## $ si             &lt;int&gt; 4, 4, 3, 5, 5, 4, 4, 4, 3, 4, 5, 2, 5, 4, 5, 6, 3, 5, 5, 7, 4, 9, 10, 6, 8, 9, 8, 7,…
## $ p_nopool       &lt;dbl&gt; 0.80, 0.80, 0.60, 1.00, 1.00, 0.80, 0.80, 0.80, 0.60, 0.80, 1.00, 0.40, 1.00, 0.80, …
## $ p_partpool     &lt;dbl&gt; 0.8239363, 0.8258695, 0.6827349, 0.9314847, 0.9305743, 0.8243324, 0.8264047, 0.82425…
## $ p_true         &lt;dbl&gt; 0.6380086, 0.8797456, 0.4656151, 0.8649196, 0.9803934, 0.8758983, 0.8160239, 0.92581…
## $ nopool_error   &lt;dbl&gt; 0.161991419, 0.079745589, 0.134384860, 0.135080387, 0.019606594, 0.075898310, 0.0160…
## $ partpool_error &lt;dbl&gt; 0.1859277233, 0.0538761233, 0.2171197348, 0.0665651018, 0.0498191326, 0.0515658995, …</code></pre>
<p>Here is our code for Figure 13.3. The extra data processing for <code>dfline</code> is how we get the values necessary for the horizontal summary lines.</p>
<div class="sourceCode" id="cb1569"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1569-1" data-line-number="1">dfline &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1569-2" data-line-number="2"><span class="st">  </span>dsim <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1569-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(ni, nopool_error<span class="op">:</span>partpool_error) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1569-4" data-line-number="4"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>ni) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1569-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(name, ni) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1569-6" data-line-number="6"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_error =</span> <span class="kw">mean</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1569-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x    =</span> <span class="kw">c</span>( <span class="dv">1</span>, <span class="dv">16</span>, <span class="dv">31</span>, <span class="dv">46</span>),</a>
<a class="sourceLine" id="cb1569-8" data-line-number="8">         <span class="dt">xend =</span> <span class="kw">c</span>(<span class="dv">15</span>, <span class="dv">30</span>, <span class="dv">45</span>, <span class="dv">60</span>))</a>
<a class="sourceLine" id="cb1569-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb1569-10" data-line-number="10">dsim <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1569-11" data-line-number="11"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> pond)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1569-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="kw">c</span>(<span class="fl">15.5</span>, <span class="fl">30.5</span>, <span class="fl">45.4</span>), </a>
<a class="sourceLine" id="cb1569-13" data-line-number="13">             <span class="dt">color =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1569-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> nopool_error), <span class="dt">color =</span> <span class="st">&quot;orange2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1569-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> partpool_error), <span class="dt">shape =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1569-16" data-line-number="16"><span class="st">  </span><span class="kw">geom_segment</span>(<span class="dt">data =</span> dfline, </a>
<a class="sourceLine" id="cb1569-17" data-line-number="17">               <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">xend =</span> xend, </a>
<a class="sourceLine" id="cb1569-18" data-line-number="18">                   <span class="dt">y =</span> mean_error, <span class="dt">yend =</span> mean_error),</a>
<a class="sourceLine" id="cb1569-19" data-line-number="19">               <span class="dt">color =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;orange2&quot;</span>, <span class="st">&quot;black&quot;</span>), <span class="dt">each =</span> <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb1569-20" data-line-number="20">               <span class="dt">linetype =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">each =</span> <span class="dv">4</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1569-21" data-line-number="21"><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, </a>
<a class="sourceLine" id="cb1569-22" data-line-number="22">           <span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">15</span> <span class="op">-</span><span class="st"> </span><span class="fl">7.5</span>, <span class="dv">30</span> <span class="op">-</span><span class="st"> </span><span class="fl">7.5</span>, <span class="dv">45</span> <span class="op">-</span><span class="st"> </span><span class="fl">7.5</span>, <span class="dv">60</span> <span class="op">-</span><span class="st"> </span><span class="fl">7.5</span>), <span class="dt">y =</span> <span class="fl">.45</span>, </a>
<a class="sourceLine" id="cb1569-23" data-line-number="23">           <span class="dt">label =</span> <span class="kw">c</span>(<span class="st">&quot;tiny (5)&quot;</span>, <span class="st">&quot;small (10)&quot;</span>, <span class="st">&quot;medium (25)&quot;</span>, <span class="st">&quot;large (35)&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1569-24" data-line-number="24"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1569-25" data-line-number="25"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Estimate error by model type&quot;</span>,</a>
<a class="sourceLine" id="cb1569-26" data-line-number="26">       <span class="dt">subtitle =</span> <span class="st">&quot;The horizontal axis displays pond number. The vertical axis measures</span><span class="ch">\n</span><span class="st">the absolute error in the predicted proportion of survivors, compared to</span><span class="ch">\n</span><span class="st">the true value used in the simulation. The higher the point, the worse</span><span class="ch">\n</span><span class="st">the estimate. No-pooling shown in orange. Partial pooling shown in black.</span><span class="ch">\n</span><span class="st">The orange and dashed black lines show the average error for each kind</span><span class="ch">\n</span><span class="st">of estimate, across each initial density of tadpoles (pond size).&quot;</span>,</a>
<a class="sourceLine" id="cb1569-27" data-line-number="27">       <span class="dt">y =</span> <span class="st">&quot;absolute error&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1569-28" data-line-number="28"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid.major =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb1569-29" data-line-number="29">        <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">10</span>))</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-28-1.png" width="480" style="display: block; margin: auto;" /></p>
<p>If you wanted to quantify the difference in simple summaries, you might execute something like this.</p>
<div class="sourceCode" id="cb1570"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1570-1" data-line-number="1">dsim <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1570-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(ni, nopool_error<span class="op">:</span>partpool_error) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1570-3" data-line-number="3"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>ni) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1570-4" data-line-number="4"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1570-5" data-line-number="5"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_error   =</span> <span class="kw">mean</span>(value) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1570-6" data-line-number="6">            <span class="dt">median_error =</span> <span class="kw">median</span>(value) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">3</span>))</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##   name           mean_error median_error
##   &lt;chr&gt;               &lt;dbl&gt;        &lt;dbl&gt;
## 1 nopool_error        0.059        0.042
## 2 partpool_error      0.054        0.033</code></pre>
<p>Although many years of work in statistics have shown that partially pooled estimates are better, on average, this is not always the case. Our results are an example of this. McElreath addressed this directly:</p>
<blockquote>
<p>But there are some cases in which the no-pooling estimates are better. These exceptions often result from ponds with extreme probabilities of survival. The partial pooling estimates shrink such extreme ponds towards the mean, because few ponds exhibit such extreme behavior. But sometimes outliers really are outliers. (p. 414)</p>
</blockquote>
<p>I originally learned about the multilevel in order to work with <a href="https://gseacademic.harvard.edu/alda/">longitudinal data</a>. In that context, I found the basic principles of a multilevel structure quite intuitive. The concept of partial pooling, however, took me some time to wrap my head around. If you’re struggling with this, be patient and keep chipping away.</p>
<p>When McElreath <a href="https://www.youtube.com/watch?v=82TaniPgzQc&amp;t=2048s&amp;frags=pl%2Cwn">lectured on this topic in 2015</a>, he traced partial pooling to statistician <a href="https://imstat.org/2017/05/15/obituary-charles-m-stein-1920-2016/">Charles M. Stein</a>. Efron and Morris <span class="citation">(<a href="#ref-efronSteinParadoxStatistics1977">1977</a>)</span> wrote the now classic paper, <a href="https://statweb.stanford.edu/~ckirby/brad/other/Article1977.pdf"><em>Stein’s paradox in statistics</em></a>, which does a nice job breaking down why partial pooling can be so powerful. One of the primary examples they used in the paper was of 1970 batting average data. If you’d like more practice seeing how partial pooling works–or if you just like baseball–, check out my blog post, <a href="https://solomonkurz.netlify.com/post/stein-s-paradox-and-what-partial-pooling-can-do-for-you/"><em>Stein’s paradox and what partial pooling can do for you</em></a>.</p>
<div id="overthinking-repeating-the-pond-simulation." class="section level4">
<h4><span class="header-section-number">13.2.5.1</span> Overthinking: Repeating the pond simulation.</h4>
<p>Within the <strong>brms</strong> workflow, we can reuse a compiled model with <code>update()</code>. But first, we’ll simulate new data.</p>
<div class="sourceCode" id="cb1572"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1572-1" data-line-number="1">a_bar   &lt;-<span class="st">  </span><span class="fl">1.5</span></a>
<a class="sourceLine" id="cb1572-2" data-line-number="2">sigma   &lt;-<span class="st">  </span><span class="fl">1.5</span></a>
<a class="sourceLine" id="cb1572-3" data-line-number="3">n_ponds &lt;-<span class="st"> </span><span class="dv">60</span></a>
<a class="sourceLine" id="cb1572-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1572-5" data-line-number="5"><span class="kw">set.seed</span>(<span class="dv">1999</span>)  <span class="co"># for new data, set a new seed</span></a>
<a class="sourceLine" id="cb1572-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1572-7" data-line-number="7">new_dsim &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1572-8" data-line-number="8"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">pond   =</span> <span class="dv">1</span><span class="op">:</span>n_ponds,</a>
<a class="sourceLine" id="cb1572-9" data-line-number="9">         <span class="dt">ni     =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">35</span>), <span class="dt">each =</span> n_ponds <span class="op">/</span><span class="st"> </span><span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.integer</span>(),</a>
<a class="sourceLine" id="cb1572-10" data-line-number="10">         <span class="dt">true_a =</span> <span class="kw">rnorm</span>(<span class="dt">n =</span> n_ponds, <span class="dt">mean =</span> a_bar, <span class="dt">sd =</span> sigma)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1572-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">si =</span> <span class="kw">rbinom</span>(<span class="dt">n =</span> <span class="kw">n</span>(), <span class="dt">prob =</span> <span class="kw">inv_logit_scaled</span>(true_a), <span class="dt">size =</span> ni)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1572-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p_nopool =</span> si <span class="op">/</span><span class="st"> </span>ni)</a>
<a class="sourceLine" id="cb1572-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1572-14" data-line-number="14"><span class="kw">glimpse</span>(new_dsim)</a></code></pre></div>
<pre><code>## Rows: 60
## Columns: 5
## $ pond     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25,…
## $ ni       &lt;int&gt; 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 1…
## $ true_a   &lt;dbl&gt; 2.5990087, 1.4432554, 3.3045137, 3.7047030, 1.7005354, 2.2797409, 0.6759270, -0.2784119, -…
## $ si       &lt;int&gt; 4, 4, 5, 4, 4, 4, 2, 4, 3, 5, 4, 5, 2, 2, 5, 10, 8, 10, 10, 9, 10, 9, 5, 10, 10, 6, 7, 7, …
## $ p_nopool &lt;dbl&gt; 0.80, 0.80, 1.00, 0.80, 0.80, 0.80, 0.40, 0.80, 0.60, 1.00, 0.80, 1.00, 0.40, 0.40, 1.00, …</code></pre>
<p>Fit the new model.</p>
<div class="sourceCode" id="cb1574"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1574-1" data-line-number="1">b13<span class="fl">.3</span>_new &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1574-2" data-line-number="2"><span class="st">  </span><span class="kw">update</span>(b13<span class="fl">.3</span>,</a>
<a class="sourceLine" id="cb1574-3" data-line-number="3">         <span class="dt">newdata =</span> new_dsim,</a>
<a class="sourceLine" id="cb1574-4" data-line-number="4">         <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1574-5" data-line-number="5">         <span class="dt">seed =</span> <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb1574-6" data-line-number="6">      <span class="dt">file =</span> <span class="st">&quot;fits/b13.03_new&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb1575"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1575-1" data-line-number="1"><span class="kw">print</span>(b13<span class="fl">.3</span>_new)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: si | trials(ni) ~ 1 + (1 | pond) 
##    Data: new_dsim (Number of observations: 60) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Group-Level Effects: 
## ~pond (Number of levels: 60) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     1.32      0.19     1.00     1.73 1.00     1321     2029
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     1.64      0.20     1.24     2.04 1.00     1520     2180
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Why not plot the first simulation versus the second one?</p>
<div class="sourceCode" id="cb1577"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1577-1" data-line-number="1"><span class="kw">bind_rows</span>(<span class="kw">posterior_samples</span>(b13<span class="fl">.3</span>),</a>
<a class="sourceLine" id="cb1577-2" data-line-number="2">          <span class="kw">posterior_samples</span>(b13<span class="fl">.3</span>_new)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1577-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;b13.3&quot;</span>, <span class="st">&quot;b13.3_new&quot;</span>), <span class="dt">each =</span> <span class="kw">n</span>() <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1577-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> b_Intercept, <span class="dt">y =</span> sd_pond__Intercept)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1577-5" data-line-number="5"><span class="st">  </span><span class="kw">stat_density_2d</span>(<span class="dt">geom =</span> <span class="st">&quot;raster&quot;</span>, </a>
<a class="sourceLine" id="cb1577-6" data-line-number="6">                  <span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw">stat</span>(density)), </a>
<a class="sourceLine" id="cb1577-7" data-line-number="7">                  <span class="dt">contour =</span> F, <span class="dt">n =</span> <span class="dv">200</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1577-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> a_bar, <span class="dt">color =</span> <span class="st">&quot;orange3&quot;</span>, <span class="dt">linetype =</span> <span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1577-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> sigma, <span class="dt">color =</span> <span class="st">&quot;orange3&quot;</span>, <span class="dt">linetype =</span> <span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1577-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="dt">low =</span> <span class="st">&quot;grey25&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;orange3&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1577-11" data-line-number="11"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Our simulation posteriors contrast a bit&quot;</span>,</a>
<a class="sourceLine" id="cb1577-12" data-line-number="12">          <span class="dt">subtitle =</span> <span class="kw">expression</span>(alpha<span class="op">*</span><span class="st">&quot; is on the x and &quot;</span><span class="op">*</span>sigma<span class="op">*</span><span class="st">&quot; is on the y, both in log-odds. The dotted lines intersect at the true values.&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1577-13" data-line-number="13"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(.<span class="dv">7</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1577-14" data-line-number="14">                  <span class="dt">ylim =</span> <span class="kw">c</span>(.<span class="dv">8</span>, <span class="fl">1.9</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1577-15" data-line-number="15"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>,</a>
<a class="sourceLine" id="cb1577-16" data-line-number="16">        <span class="dt">panel.grid.major =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb1577-17" data-line-number="17"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>model, <span class="dt">ncol =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-32-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>If you’d like the <code>stanfit</code> portion of your <code>brm()</code> object, subset with <code>$fit</code>. Take <code>b13.3</code>, for example. You might check out its structure via <code>b13.3$fit %&gt;% str()</code>. Here’s the actual Stan code.</p>
<div class="sourceCode" id="cb1578"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1578-1" data-line-number="1">b13<span class="fl">.3</span><span class="op">$</span>fit<span class="op">@</span>stanmodel</a></code></pre></div>
<pre><code>## S4 class stanmodel &#39;a077003526b0a3eaf501765accf709a9&#39; coded as follows:
## // generated with brms 2.13.0
## functions {
## }
## data {
##   int&lt;lower=1&gt; N;  // number of observations
##   int Y[N];  // response variable
##   int trials[N];  // number of trials
##   // data for group-level effects of ID 1
##   int&lt;lower=1&gt; N_1;  // number of grouping levels
##   int&lt;lower=1&gt; M_1;  // number of coefficients per level
##   int&lt;lower=1&gt; J_1[N];  // grouping indicator per observation
##   // group-level predictor values
##   vector[N] Z_1_1;
##   int prior_only;  // should the likelihood be ignored?
## }
## transformed data {
## }
## parameters {
##   real Intercept;  // temporary intercept for centered predictors
##   vector&lt;lower=0&gt;[M_1] sd_1;  // group-level standard deviations
##   vector[N_1] z_1[M_1];  // standardized group-level effects
## }
## transformed parameters {
##   vector[N_1] r_1_1;  // actual group-level effects
##   r_1_1 = (sd_1[1] * (z_1[1]));
## }
## model {
##   // initialize linear predictor term
##   vector[N] mu = Intercept + rep_vector(0, N);
##   for (n in 1:N) {
##     // add more terms to the linear predictor
##     mu[n] += r_1_1[J_1[n]] * Z_1_1[n];
##   }
##   // priors including all constants
##   target += normal_lpdf(Intercept | 0, 1.5);
##   target += exponential_lpdf(sd_1 | 1);
##   target += std_normal_lpdf(z_1[1]);
##   // likelihood including all constants
##   if (!prior_only) {
##     target += binomial_logit_lpmf(Y | trials, mu);
##   }
## }
## generated quantities {
##   // actual population-level intercept
##   real b_Intercept = Intercept;
## }
## </code></pre>
</div>
</div>
</div>
<div id="more-than-one-type-of-cluster" class="section level2">
<h2><span class="header-section-number">13.3</span> More than one type of cluster</h2>
<p>“We can use and often should use more than one type of cluster in the same model” (p. 415).</p>
<div id="rethinking-cross-classification-and-hierarchy." class="section level4">
<h4><span class="header-section-number">13.3.0.1</span> Rethinking: Cross-classification and hierarchy.</h4>
<blockquote>
<p>The kind of data structure in <code>data(chimpanzees)</code> is usually called a <strong>cross-classified multilevel</strong> model. It is cross-classified, because actors are not nested within unique blocks. If each chimpanzee had instead done all of his or her pulls on a single day, within a single block, then the data structure would instead be <em>hierarchical</em>. However, the model specification would typically be the same. So the model structure and code you’ll see below will apply both to cross-classified designs and hierarchical designs. (p. 415, <strong>emphasis</strong> in the original)</p>
</blockquote>
</div>
<div id="multilevel-chimpanzees." class="section level3">
<h3><span class="header-section-number">13.3.1</span> Multilevel chimpanzees.</h3>
<p>The initial multilevel update from model <code>b10.4</code> from <a href="god-spiked-the-integers.html#logistic-regression-prosocial-chimpanzees.">Chapter 10</a> follows the statistical formula</p>
<p><span class="math display">\[\begin{align*}
\text{left_pull}_i         &amp; \sim \operatorname{Binomial}(n_i = 1, p_i) \\
\operatorname{logit} (p_i) &amp; = \alpha_{\text{actor}[i]}  + \gamma_{\text{block}[i]} + \beta_{\text{treatment}[i]} \\
\beta_j       &amp; \sim \operatorname{Normal}(0, 0.5) \;\;\; , \text{for } j = 1..4 \\
\alpha_j      &amp; \sim \operatorname{Normal}(\bar \alpha, \sigma_\alpha) \;\;\; , \text{for } j = 1..7 \\
\gamma_j      &amp; \sim \operatorname{Normal}(0, \sigma_\gamma) \;\;\; , \text{for } j = 1..6 \\
\bar \alpha   &amp; \sim \operatorname{Normal}(0, 1.5) \\
\sigma_\alpha &amp; \sim \operatorname{Exponential}(1) \\
\sigma_\gamma &amp; \sim \operatorname{Exponential}(1).
\end{align*}\]</span></p>
<p>⚠️ WARNING ⚠️</p>
<p>I am so sorry, but we are about to head straight into a load of confusion. If you follow along linearly in the book, we won’t have the language to parse this all out until <a href="models-with-memory.html#divergent-transitions-and-non-centered-priors">Section 13.4</a>. In short, our difficulties will have to do with what are called the centered and the non-centered parameterizations for multilevel models. In the next several models, McElreath used the <strong>centered parameterization</strong>. As we’ll learn in Section 13.4, this often causes problems when you use Stan to fit your multilevel models. Happily, the solution to those problems is often the <strong>non-centered parameterization</strong>. This issue is well known among the Stan team. It’s so well known, in fact, that Bürkner only supports the non-centered parameterization with <strong>brms</strong> (see <a href="https://discourse.mc-stan.org/t/disable-non-centered-parameterization-in-brms/7184/7?u=solomon">here</a>). To my knowledge, there is no easy way around this. In the long run, this is a good thing. Your <strong>brms</strong> models will likely avoid some of the problems McElreath highlighted in this part of the text. In the short term, this also means that our results will not completely match up with those in the text. If you really want to reproduce McElreath’s models <code>m13.4</code> through <code>m13.6</code>, you’ll have to fit them with the <strong>rethinking</strong> package or directly in Stan. Our models <code>b13.4</code> through <code>b13.6</code> will be the non-centered <strong>brms</strong> alternatives. Either way, the models make the same predictions, but the nuts and bolts and gears we’ll use to construct our multilevel golems will look a little different. With all that in mind, here’s how we might express out statistical model using the non-centered parameterization more faithful to the way it will be expressed with <code>brms::brm()</code>:</p>
<p><span class="math display">\[\begin{align*}
\text{left_pull}_i         &amp; \sim \operatorname{Binomial}(n_i = 1, p_i) \\
\operatorname{logit} (p_i) &amp; = \bar \alpha  + \beta_{\text{treatment}[i]} + z_{\text{actor}[i]} \sigma_\alpha + x_{\text{block}[i]} \sigma_\gamma \\
\bar \alpha   &amp; \sim \operatorname{Normal}(0, 1.5) \\
\beta_j       &amp; \sim \operatorname{Normal}(0, 0.5) \;\;\; , \text{for } j = 1..4 \\
z_j           &amp; \sim \operatorname{Normal}(0, 1) \\
x_j           &amp; \sim \operatorname{Normal}(0, 1) \\
\sigma_\alpha &amp; \sim \operatorname{Exponential}(1) \\
\sigma_\gamma &amp; \sim \operatorname{Exponential}(1).
\end{align*}\]</span></p>
<p>If you jump ahead to <a href="models-with-memory.html#non-centered-chimpanzees.">Section 13.4.2</a>, you’ll see this is just re-write of the formula on the top of page 424. For now, let’s load the data.</p>
<div class="sourceCode" id="cb1580"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1580-1" data-line-number="1"><span class="kw">library</span>(rethinking)</a>
<a class="sourceLine" id="cb1580-2" data-line-number="2"><span class="kw">data</span>(chimpanzees)</a>
<a class="sourceLine" id="cb1580-3" data-line-number="3">d &lt;-<span class="st"> </span>chimpanzees</a>
<a class="sourceLine" id="cb1580-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1580-5" data-line-number="5"><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</a>
<a class="sourceLine" id="cb1580-6" data-line-number="6"><span class="kw">library</span>(brms)</a>
<a class="sourceLine" id="cb1580-7" data-line-number="7"><span class="kw">rm</span>(chimpanzees)</a></code></pre></div>
<p>Wrangle.</p>
<div class="sourceCode" id="cb1581"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1581-1" data-line-number="1">d &lt;-</a>
<a class="sourceLine" id="cb1581-2" data-line-number="2"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1581-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">actor     =</span> <span class="kw">factor</span>(actor),</a>
<a class="sourceLine" id="cb1581-4" data-line-number="4">         <span class="dt">block     =</span> <span class="kw">factor</span>(block),</a>
<a class="sourceLine" id="cb1581-5" data-line-number="5">         <span class="dt">treatment =</span> <span class="kw">factor</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>prosoc_left <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>condition))</a>
<a class="sourceLine" id="cb1581-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1581-7" data-line-number="7"><span class="kw">glimpse</span>(d)</a></code></pre></div>
<pre><code>## Rows: 504
## Columns: 9
## $ actor        &lt;fct&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ recipient    &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ condition    &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ block        &lt;fct&gt; 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5,…
## $ trial        &lt;int&gt; 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44, 46…
## $ prosoc_left  &lt;int&gt; 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0,…
## $ chose_prosoc &lt;int&gt; 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1,…
## $ pulled_left  &lt;int&gt; 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0,…
## $ treatment    &lt;fct&gt; 1, 1, 2, 1, 2, 2, 2, 2, 1, 1, 1, 2, 1, 2, 1, 2, 2, 1, 2, 1, 1, 1, 2, 2, 1, 1, 2, 2, 1,…</code></pre>
<p>Even when using the non-centered parameterization, McElreath’s <code>m13.4</code> is a bit of an odd model to translate into <strong>brms</strong> syntax. To my knowledge, it can’t be done with conventional syntax. But we can fit the model with careful use of the non-linear syntax, which might look like this.</p>
<div class="sourceCode" id="cb1583"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1583-1" data-line-number="1">b13<span class="fl">.4</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1583-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1583-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1583-4" data-line-number="4">      <span class="kw">bf</span>(pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span>a <span class="op">+</span><span class="st"> </span>b,</a>
<a class="sourceLine" id="cb1583-5" data-line-number="5">         a <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>actor) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>block), </a>
<a class="sourceLine" id="cb1583-6" data-line-number="6">         b <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>treatment,</a>
<a class="sourceLine" id="cb1583-7" data-line-number="7">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1583-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">nlpar =</span> b),</a>
<a class="sourceLine" id="cb1583-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> b, <span class="dt">coef =</span> Intercept, <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1583-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd, <span class="dt">group =</span> actor, <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1583-11" data-line-number="11">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd, <span class="dt">group =</span> block, <span class="dt">nlpar =</span> a)),</a>
<a class="sourceLine" id="cb1583-12" data-line-number="12">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1583-13" data-line-number="13">      <span class="dt">seed =</span> <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb1583-14" data-line-number="14">      <span class="dt">file =</span> <span class="st">&quot;fits/b13.04&quot;</span>)</a></code></pre></div>
<p>The <code>b ~ 0 + treatment</code> part of the <code>formula</code> is our expression of what we wrote above as <span class="math inline">\(\beta_{\text{treatment}[i]}\)</span>. There’s a lot going on with the <code>a ~ 1 + (1 | actor) + (1 | block)</code> part of the formula. The initial <code>1</code> outside of the parenthesis is <span class="math inline">\(\bar \alpha\)</span>. The <code>(1 | actor)</code> and <code>(1 | block)</code> parts correspond to <span class="math inline">\(z_{\text{actor}[i]} \sigma_\alpha\)</span> and <span class="math inline">\(x_{\text{block}[i]} \sigma_\gamma\)</span>, respectively.</p>
<p>Check the trace plots.</p>
<div class="sourceCode" id="cb1584"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1584-1" data-line-number="1"><span class="kw">library</span>(bayesplot)</a>
<a class="sourceLine" id="cb1584-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1584-3" data-line-number="3"><span class="kw">color_scheme_set</span>(<span class="st">&quot;orange&quot;</span>)</a>
<a class="sourceLine" id="cb1584-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1584-5" data-line-number="5">post &lt;-<span class="st"> </span><span class="kw">posterior_samples</span>(b13<span class="fl">.4</span>, <span class="dt">add_chain =</span> T)</a>
<a class="sourceLine" id="cb1584-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1584-7" data-line-number="7">post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1584-8" data-line-number="8"><span class="st">  </span><span class="kw">mcmc_trace</span>(<span class="dt">pars =</span> <span class="kw">vars</span>(<span class="op">-</span>iter, <span class="op">-</span>lp__),</a>
<a class="sourceLine" id="cb1584-9" data-line-number="9">             <span class="dt">facet_args =</span> <span class="kw">list</span>(<span class="dt">ncol =</span> <span class="dv">4</span>), </a>
<a class="sourceLine" id="cb1584-10" data-line-number="10">             <span class="dt">size =</span> <span class="fl">.15</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1584-11" data-line-number="11"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-36-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>They all look fine. In the text (e.g., page 416), McElreath briefly mentioned warnings about divergent transitions. We didn’t get any warnings like that. Keep following along and you’ll soon learn why.</p>
<p>Here’s a look at the summary when using <code>print()</code>.</p>
<div class="sourceCode" id="cb1585"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1585-1" data-line-number="1"><span class="kw">print</span>(b13<span class="fl">.4</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: pulled_left | trials(1) ~ a + b 
##          a ~ 1 + (1 | actor) + (1 | block)
##          b ~ 0 + treatment
##    Data: d (Number of observations: 504) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Group-Level Effects: 
## ~actor (Number of levels: 7) 
##                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(a_Intercept)     2.01      0.63     1.08     3.49 1.00     1049     2560
## 
## ~block (Number of levels: 6) 
##                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(a_Intercept)     0.21      0.18     0.01     0.66 1.00     1565     1640
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a_Intercept      0.63      0.73    -0.85     2.04 1.00      964     1355
## b_treatment1    -0.14      0.30    -0.74     0.45 1.00     1711     2598
## b_treatment2     0.39      0.30    -0.19     0.99 1.00     2052     2455
## b_treatment3    -0.49      0.30    -1.07     0.10 1.00     1949     2975
## b_treatment4     0.28      0.30    -0.33     0.86 1.00     1921     2689
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>When you use the <code>(1 | &lt;group&gt;)</code> syntax within <code>brm()</code>, the group-specific parameters are not shown with <code>print()</code>. You only get the hierarchical <span class="math inline">\(\sigma_\text{&lt;group&gt;}\)</span> summaries, shown here as the two rows for <code>sd(a_Intercept)</code>. However, you can get a summary of all the parameters with the <code>posterior_summary()</code> function.</p>
<div class="sourceCode" id="cb1587"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1587-1" data-line-number="1"><span class="kw">posterior_summary</span>(b13<span class="fl">.4</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##                         Estimate Est.Error    Q2.5   Q97.5
## b_a_Intercept               0.63      0.73   -0.85    2.04
## b_b_treatment1             -0.14      0.30   -0.74    0.45
## b_b_treatment2              0.39      0.30   -0.19    0.99
## b_b_treatment3             -0.49      0.30   -1.07    0.10
## b_b_treatment4              0.28      0.30   -0.33    0.86
## sd_actor__a_Intercept       2.01      0.63    1.08    3.49
## sd_block__a_Intercept       0.21      0.18    0.01    0.66
## r_actor__a[1,Intercept]    -0.98      0.74   -2.41    0.51
## r_actor__a[2,Intercept]     4.06      1.38    1.95    7.40
## r_actor__a[3,Intercept]    -1.29      0.74   -2.72    0.23
## r_actor__a[4,Intercept]    -1.29      0.75   -2.75    0.20
## r_actor__a[5,Intercept]    -0.98      0.75   -2.45    0.53
## r_actor__a[6,Intercept]    -0.04      0.74   -1.47    1.44
## r_actor__a[7,Intercept]     1.49      0.79    0.01    3.15
## r_block__a[1,Intercept]    -0.16      0.22   -0.70    0.13
## r_block__a[2,Intercept]     0.04      0.18   -0.31    0.44
## r_block__a[3,Intercept]     0.05      0.18   -0.29    0.48
## r_block__a[4,Intercept]     0.01      0.17   -0.37    0.36
## r_block__a[5,Intercept]    -0.03      0.18   -0.44    0.33
## r_block__a[6,Intercept]     0.11      0.20   -0.20    0.60
## lp__                     -286.91      3.70 -295.10 -280.64</code></pre>
<p>We might make the coefficient plot of Figure 13.4.a with <code>bayesplot::mcmc_plot()</code>.</p>
<div class="sourceCode" id="cb1589"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1589-1" data-line-number="1"><span class="kw">mcmc_plot</span>(b13<span class="fl">.4</span>, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;^r_&quot;</span>, <span class="st">&quot;^b_&quot;</span>, <span class="st">&quot;^sd_&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1589-2" data-line-number="2"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>))</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-39-1.png" width="360" style="display: block; margin: auto;" /></p>
<p>For a little more control, we might switch to a <strong>tidybayes</strong>-oriented approach.</p>
<div class="sourceCode" id="cb1590"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1590-1" data-line-number="1"><span class="co"># this is all stylistic fluff</span></a>
<a class="sourceLine" id="cb1590-2" data-line-number="2">levels &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1590-3" data-line-number="3"><span class="st">  </span><span class="kw">c</span>(<span class="st">&quot;sd_block__a_Intercept&quot;</span>, <span class="st">&quot;sd_actor__a_Intercept&quot;</span>, </a>
<a class="sourceLine" id="cb1590-4" data-line-number="4">    <span class="st">&quot;b_a_Intercept&quot;</span>, </a>
<a class="sourceLine" id="cb1590-5" data-line-number="5">    <span class="kw">str_c</span>(<span class="st">&quot;r_block__a[&quot;</span>, <span class="dv">6</span><span class="op">:</span><span class="dv">1</span>, <span class="st">&quot;,Intercept]&quot;</span>), </a>
<a class="sourceLine" id="cb1590-6" data-line-number="6">    <span class="kw">str_c</span>(<span class="st">&quot;r_actor__a[&quot;</span>, <span class="dv">7</span><span class="op">:</span><span class="dv">1</span>, <span class="st">&quot;,Intercept]&quot;</span>), </a>
<a class="sourceLine" id="cb1590-7" data-line-number="7">    <span class="kw">str_c</span>(<span class="st">&quot;b_b_treatment&quot;</span>, <span class="dv">4</span><span class="op">:</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb1590-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1590-9" data-line-number="9">text &lt;-</a>
<a class="sourceLine" id="cb1590-10" data-line-number="10"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">x     =</span> <span class="kw">posterior_summary</span>(b13<span class="fl">.4</span>, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="fl">0.055</span>, <span class="fl">0.955</span>),)[<span class="st">&quot;r_actor__a[2,Intercept]&quot;</span>, <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">1</span>)],</a>
<a class="sourceLine" id="cb1590-11" data-line-number="11">         <span class="dt">y     =</span> <span class="kw">c</span>(<span class="fl">13.5</span>, <span class="fl">16.5</span>),</a>
<a class="sourceLine" id="cb1590-12" data-line-number="12">         <span class="dt">label =</span> <span class="kw">c</span>(<span class="st">&quot;89% CI&quot;</span>, <span class="st">&quot;mean&quot;</span>),</a>
<a class="sourceLine" id="cb1590-13" data-line-number="13">         <span class="dt">hjust =</span> <span class="kw">c</span>(.<span class="dv">5</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb1590-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1590-15" data-line-number="15">arrow &lt;-</a>
<a class="sourceLine" id="cb1590-16" data-line-number="16"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">x    =</span> <span class="kw">posterior_summary</span>(b13<span class="fl">.4</span>, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="fl">0.055</span>, <span class="fl">0.955</span>),)[<span class="st">&quot;r_actor__a[2,Intercept]&quot;</span>, <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">1</span>)] <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="st"> </span><span class="fl">0.3</span>, <span class="fl">0.2</span>),</a>
<a class="sourceLine" id="cb1590-17" data-line-number="17">         <span class="dt">xend =</span> <span class="kw">posterior_summary</span>(b13<span class="fl">.4</span>, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="fl">0.055</span>, <span class="fl">0.955</span>),)[<span class="st">&quot;r_actor__a[2,Intercept]&quot;</span>, <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">1</span>)],</a>
<a class="sourceLine" id="cb1590-18" data-line-number="18">         <span class="dt">y    =</span> <span class="kw">c</span>(<span class="dv">14</span>, <span class="dv">16</span>),</a>
<a class="sourceLine" id="cb1590-19" data-line-number="19">         <span class="dt">yend =</span> <span class="kw">c</span>(<span class="fl">14.8</span>, <span class="fl">15.35</span>))</a>
<a class="sourceLine" id="cb1590-20" data-line-number="20"></a>
<a class="sourceLine" id="cb1590-21" data-line-number="21"><span class="co"># here&#39;s the main event</span></a>
<a class="sourceLine" id="cb1590-22" data-line-number="22">post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1590-23" data-line-number="23"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>(iter<span class="op">:</span>lp__)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1590-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">factor</span>(name, <span class="dt">levels =</span> levels)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1590-25" data-line-number="25"><span class="st">  </span></a>
<a class="sourceLine" id="cb1590-26" data-line-number="26"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1590-27" data-line-number="27"><span class="st">  </span><span class="kw">stat_pointinterval</span>(<span class="dt">point_interval =</span> mean_qi,</a>
<a class="sourceLine" id="cb1590-28" data-line-number="28">                     <span class="dt">.width =</span> <span class="fl">.89</span>, <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">point_size =</span> <span class="dv">2</span>, <span class="dt">point_fill =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1590-29" data-line-number="29"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> text,</a>
<a class="sourceLine" id="cb1590-30" data-line-number="30">            <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">label =</span> label, <span class="dt">hjust =</span> hjust)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1590-31" data-line-number="31"><span class="st">  </span><span class="kw">geom_segment</span>(<span class="dt">data =</span> arrow,</a>
<a class="sourceLine" id="cb1590-32" data-line-number="32">               <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">xend =</span> xend,</a>
<a class="sourceLine" id="cb1590-33" data-line-number="33">                   <span class="dt">y =</span> y, <span class="dt">yend =</span> yend),</a>
<a class="sourceLine" id="cb1590-34" data-line-number="34">               <span class="dt">arrow =</span> <span class="kw">arrow</span>(<span class="dt">length =</span> <span class="kw">unit</span>(<span class="fl">0.15</span>, <span class="st">&quot;cm&quot;</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb1590-35" data-line-number="35"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1590-36" data-line-number="36">        <span class="dt">panel.grid.major.y =</span> <span class="kw">element_line</span>(<span class="dt">linetype =</span> <span class="dv">3</span>))</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-40-1.png" width="360" style="display: block; margin: auto;" /></p>
<p>Regardless of whether we use a <strong>bayesplot</strong>- or <strong>tidybayes</strong>-oriented workflow, a careful look at our coefficient plots will show the parameters are a little different from those McElreath reported. Again, this is because of the subtle differences between our non-centered parameterization and McElreath’s centered parameterization. This will all make more sense in Section 13.4.</p>
<p>Now use <code>post</code> to compare the group-level <span class="math inline">\(\sigma\)</span> parameters as in Figure 13.4.b.</p>
<div class="sourceCode" id="cb1591"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1591-1" data-line-number="1">post <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1591-2" data-line-number="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;sd&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1591-3" data-line-number="3"><span class="st">  </span></a>
<a class="sourceLine" id="cb1591-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1591-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">adjust =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">show.legend =</span> F) <span class="op">+</span></a>
<a class="sourceLine" id="cb1591-6" data-line-number="6"><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="fl">0.67</span>, <span class="dt">y =</span> <span class="dv">2</span>, <span class="dt">label =</span> <span class="st">&quot;block&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;orange4&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1591-7" data-line-number="7"><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="fl">2.725</span>, <span class="dt">y =</span> <span class="fl">0.5</span>, <span class="dt">label =</span> <span class="st">&quot;actor&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;orange1&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1591-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">str_c</span>(<span class="st">&quot;orange&quot;</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb1591-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1591-10" data-line-number="10"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="kw">expression</span>(sigma[<span class="st">&quot;&lt;group&gt;&quot;</span>])) <span class="op">+</span></a>
<a class="sourceLine" id="cb1591-11" data-line-number="11"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">4</span>))</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-41-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>Since both the coefficient plots and the density plots indicate there is much more variability among the <code>actor</code> parameters than in the <code>block</code> parameters, we might fit a model that ignores the variation among the levels of <code>block.</code></p>
<div class="sourceCode" id="cb1592"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1592-1" data-line-number="1">b13<span class="fl">.5</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1592-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1592-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1592-4" data-line-number="4">      <span class="kw">bf</span>(pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span>a <span class="op">+</span><span class="st"> </span>b,</a>
<a class="sourceLine" id="cb1592-5" data-line-number="5">         a <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>actor), </a>
<a class="sourceLine" id="cb1592-6" data-line-number="6">         b <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>treatment,</a>
<a class="sourceLine" id="cb1592-7" data-line-number="7">         <span class="dt">nl =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1592-8" data-line-number="8">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">nlpar =</span> b),</a>
<a class="sourceLine" id="cb1592-9" data-line-number="9">                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> b, <span class="dt">coef =</span> Intercept, <span class="dt">nlpar =</span> a),</a>
<a class="sourceLine" id="cb1592-10" data-line-number="10">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd, <span class="dt">group =</span> actor, <span class="dt">nlpar =</span> a)),</a>
<a class="sourceLine" id="cb1592-11" data-line-number="11">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1592-12" data-line-number="12">      <span class="dt">seed =</span> <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb1592-13" data-line-number="13">      <span class="dt">file =</span> <span class="st">&quot;fits/b13.05&quot;</span>)</a></code></pre></div>
<p>We might compare our models by their WAIC estimates.</p>
<div class="sourceCode" id="cb1593"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1593-1" data-line-number="1">b13<span class="fl">.4</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.4</span>, <span class="st">&quot;waic&quot;</span>)</a>
<a class="sourceLine" id="cb1593-2" data-line-number="2">b13<span class="fl">.5</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.5</span>, <span class="st">&quot;waic&quot;</span>)</a>
<a class="sourceLine" id="cb1593-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1593-4" data-line-number="4"><span class="kw">loo_compare</span>(b13<span class="fl">.4</span>, b13<span class="fl">.5</span>, <span class="dt">criterion =</span> <span class="st">&quot;waic&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1593-5" data-line-number="5"><span class="st">  </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</a></code></pre></div>
<pre><code>##       elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
## b13.5    0.0       0.0  -265.6       9.6          8.6    0.4     531.2   19.2 
## b13.4   -0.6       0.8  -266.1       9.7         10.6    0.5     532.3   19.4</code></pre>
<div class="sourceCode" id="cb1595"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1595-1" data-line-number="1"><span class="kw">model_weights</span>(b13<span class="fl">.4</span>, b13<span class="fl">.5</span>, <span class="dt">weights =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1595-2" data-line-number="2"><span class="st">  </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## b13.4 b13.5 
##  0.36  0.64</code></pre>
<p>The two models yield nearly-equivalent WAIC estimates. Just as in the text, our <code>p_waic</code> column shows the models differ by about 2 effective parameters due to the shrinkage from the multilevel partial pooling. Yet recall what McElreath wrote:</p>
<blockquote>
<p>There is nothing to gain here by selecting either model. The comparison of the two models tells a richer story… Since this is an experiment, there is nothing to really select. The experimental design tells us the relevant causal model to inspect. (pp. 418–419).</p>
</blockquote>
</div>
<div id="even-more-clusters." class="section level3">
<h3><span class="header-section-number">13.3.2</span> Even more clusters.</h3>
<p>We can extend partial pooling to the <code>treatment</code> conditions, too. With <strong>brms</strong>, it will be more natural to revert to the conventional <code>formula</code> syntax.</p>
<div class="sourceCode" id="cb1597"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1597-1" data-line-number="1">b13<span class="fl">.6</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1597-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </a>
<a class="sourceLine" id="cb1597-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1597-4" data-line-number="4">      pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>actor) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>block) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>treatment),</a>
<a class="sourceLine" id="cb1597-5" data-line-number="5">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1597-6" data-line-number="6">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd)),</a>
<a class="sourceLine" id="cb1597-7" data-line-number="7">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,  </a>
<a class="sourceLine" id="cb1597-8" data-line-number="8">      <span class="dt">seed =</span> <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb1597-9" data-line-number="9">      <span class="dt">file =</span> <span class="st">&quot;fits/b13.06&quot;</span>)</a></code></pre></div>
<p>Recall that with <strong>brms</strong>, we don’t have a <code>coeftab()</code> like with McElreath’s <strong>rethinking</strong>. For us, one approach would be to compare the relevent rows from <code>fixef(b13.4)</code> to the relevant elements from <code>ranef(b13.6)</code>.</p>
<div class="sourceCode" id="cb1598"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1598-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">parameter =</span> <span class="kw">str_c</span>(<span class="st">&quot;b[&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="st">&quot;]&quot;</span>),</a>
<a class="sourceLine" id="cb1598-2" data-line-number="2">       <span class="st">`</span><span class="dt">b13.4</span><span class="st">`</span>   =<span class="st"> </span><span class="kw">fixef</span>(b13<span class="fl">.4</span>)[<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">1</span>],</a>
<a class="sourceLine" id="cb1598-3" data-line-number="3">       <span class="st">`</span><span class="dt">b13.6</span><span class="st">`</span>   =<span class="st"> </span><span class="kw">ranef</span>(b13<span class="fl">.6</span>)<span class="op">$</span>treatment[, <span class="dv">1</span>, <span class="st">&quot;Intercept&quot;</span>]) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1598-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##   parameter b13.4 b13.6
##   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;
## 1 b[1]      -0.14 -0.11
## 2 b[2]       0.39  0.38
## 3 b[3]      -0.49 -0.42
## 4 b[4]       0.28  0.27</code></pre>
<p>Like in the text, “these are not identical, but they are very close” (p. 419). We might compare the group-level <span class="math inline">\(\sigma\)</span> parameters with a plot.</p>
<div class="sourceCode" id="cb1600"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1600-1" data-line-number="1"><span class="kw">posterior_samples</span>(b13<span class="fl">.6</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1600-2" data-line-number="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;sd&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1600-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">str_remove</span>(name, <span class="st">&quot;sd_&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_remove</span>(., <span class="st">&quot;__Intercept&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1600-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parameter =</span> <span class="kw">str_c</span>(<span class="st">&quot;sigma[&quot;</span>, group,<span class="st">&quot;]&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1600-5" data-line-number="5"><span class="st">  </span></a>
<a class="sourceLine" id="cb1600-6" data-line-number="6"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> parameter)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1600-7" data-line-number="7"><span class="st">  </span><span class="kw">stat_halfeye</span>(<span class="dt">.width =</span> <span class="fl">.95</span>, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">fill =</span> <span class="st">&quot;orange&quot;</span>, <span class="dt">adjust =</span> <span class="fl">0.1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1600-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="dt">labels =</span> ggplot2<span class="op">:::</span>parse_safe) <span class="op">+</span></a>
<a class="sourceLine" id="cb1600-9" data-line-number="9"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;The variation among treatment levels is small, but the</span><span class="ch">\n</span><span class="st">variation among the levels of block is still the smallest.&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1600-10" data-line-number="10"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(<span class="fl">1.5</span>, <span class="dv">3</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1600-11" data-line-number="11"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>))</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-44-1.png" width="504" style="display: block; margin: auto;" /></p>
<p>Now we’ll compare <code>b13.6</code> to the last two models with the WAIC.</p>
<div class="sourceCode" id="cb1601"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1601-1" data-line-number="1">b13<span class="fl">.6</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.6</span>, <span class="st">&quot;waic&quot;</span>)</a>
<a class="sourceLine" id="cb1601-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1601-3" data-line-number="3"><span class="kw">loo_compare</span>(b13<span class="fl">.4</span>, b13<span class="fl">.5</span>, b13<span class="fl">.6</span>, <span class="dt">criterion =</span> <span class="st">&quot;waic&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1601-4" data-line-number="4"><span class="st">  </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</a></code></pre></div>
<pre><code>##       elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
## b13.5    0.0       0.0  -265.6       9.6          8.6    0.4     531.2   19.2 
## b13.4   -0.6       0.8  -266.1       9.7         10.6    0.5     532.3   19.4 
## b13.6   -1.0       0.8  -266.6       9.6         10.9    0.5     533.2   19.2</code></pre>
<div class="sourceCode" id="cb1603"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1603-1" data-line-number="1"><span class="kw">model_weights</span>(b13<span class="fl">.4</span>, b13<span class="fl">.5</span>, b13<span class="fl">.6</span>, <span class="dt">weights =</span> <span class="st">&quot;loo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1603-2" data-line-number="2"><span class="st">  </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>## b13.4 b13.5 b13.6 
##  0.30  0.52  0.18</code></pre>
<p>The models show little difference “on purely predictive criteria. This is the typical result, when each cluster (each treatment here) has a lot of data to inform its parameters” (p. 419). Unlike in the text, we didn’t have a problem with divergent transitions. We’ll see why in the next section.</p>
<p>Before we move on, this section just hints at a historical software difficulty. In short, it’s not uncommon to have a theory-based model that includes multiple sources of clustering (i.e., requiring many <code>( &lt;varying parameter(s)&gt; | &lt;grouping variable(s)&gt; )</code> parts in the model <code>formula</code>). This can make for all kinds of computational difficulties and result in software error messages, inadmissible solutions, and so on. One of the practical solutions to difficulties like these has been to simplify the statistical models by removing some of the clustering terms. Even though such simpler models were not the theory-based ones, at least they yielded solutions. Nowadays, Stan (via <strong>brms</strong> or otherwise) is making it easier to fit the full theoretically-based model. To learn more about this topic, check out this nice blog post by <a href="https://twitter.com/mcxfrank">Michael Frank</a>, <a href="http://babieslearninglanguage.blogspot.com/2018/02/mixed-effects-models-is-it-time-to-go.html"><em>Mixed effects models: Is it time to go Bayesian by default?</em></a>. Make sure to check out the discussion in the comments section, which includes all-stars like Bürkner and <a href="http://pages.stat.wisc.edu/~bates/">Douglas Bates</a>. You can get more context for the issue from <span class="citation">Barr et al. (<a href="#ref-barrRandomEffectsStructure2013">2013</a>)</span>, <a href="https://www.sciencedirect.com/science/article/pii/S0749596X12001180"><em>Random effects structure for confirmatory hypothesis testing: Keep it maximal</em></a>.</p>
</div>
</div>
<div id="divergent-transitions-and-non-centered-priors" class="section level2">
<h2><span class="header-section-number">13.4</span> Divergent transitions and non-centered priors</h2>
<p>Although we did not get divergent transitions warnings in from our last few models the way McElreath did with his, the issues is still relevant for <strong>brms</strong>.</p>
<blockquote>
<p>One of the best things about Hamiltonian Monte Carlo is that it provides internal checks of efficiency and accuracy. One of these checks comes free, arising from the constraints on the physics simulation. Recall that HMC simulates the frictionless flow of a particle on a surface. In any given transition, which is just a single flick of the particle, the total energy at the start should be equal to the total energy at the end. That’s how energy in a closed system works. And in a purely mathematical system, the energy is always conserved correctly. It’s just a fact about the physics.</p>
<p>But in a numerical system, it might not be. Sometimes the total energy is not the same at the end as it was at the start. In these cases, the energy is <em>divergent.</em> How can this happen? It tends to happen when the posterior distribution is very steep in some region of parameter space. Steep changes in probability are hard for a discrete physics simulation to follow. When that happens, the algorithm notices by comparing the energy at the start to the energy at the end. When they don’t match, it indicates numerical problems exploring that part of the posterior distribution.</p>
<p>Divergent transitions are rejected. They don’t directly damage your approximation of the posterior distribution. But they do hurt it indirectly, because the region where divergent transitions happen is hard to explore correctly. (p. 420, <em>emphasis</em> in the original)</p>
</blockquote>
<p>Two primary ways to handle divergent transitions are by increasing the <code>adapt_delta</code> parameter, which we’ve already done a few times in previous chapters, or reparameterizing the model. As McElreath will cover in a bit, switching from the centered to the non-centered parameterization will often work when using multilevel models.</p>
<div id="the-devils-funnel." class="section level3">
<h3><span class="header-section-number">13.4.1</span> The Devil’s Funnel.</h3>
<p>McElreath posed a joint distribution</p>
<p><span class="math display">\[\begin{align*}
v &amp; \sim \operatorname{Normal}(0, 3) \\
x &amp; \sim \operatorname{Normal}(0, \exp(v)),
\end{align*}\]</span></p>
<p>where the scale of <span class="math inline">\(x\)</span> depends on another variable, <span class="math inline">\(v\)</span>. In <strong>R</strong> code 13.26, McElreath then proposed fitting the following model with <code>rethinking::ulam()</code>.</p>
<div class="sourceCode" id="cb1605"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1605-1" data-line-number="1">m13<span class="fl">.7</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1605-2" data-line-number="2"><span class="st">  </span><span class="kw">ulam</span>(</a>
<a class="sourceLine" id="cb1605-3" data-line-number="3">    <span class="dt">data =</span> <span class="kw">list</span>(<span class="dt">N =</span> <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1605-4" data-line-number="4">    <span class="kw">alist</span>(</a>
<a class="sourceLine" id="cb1605-5" data-line-number="5">      v <span class="op">~</span><span class="st"> </span><span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1605-6" data-line-number="6">      x <span class="op">~</span><span class="st"> </span><span class="kw">normal</span>(<span class="dv">0</span>, <span class="kw">exp</span>(v))</a>
<a class="sourceLine" id="cb1605-7" data-line-number="7">    ), </a>
<a class="sourceLine" id="cb1605-8" data-line-number="8">    <span class="dt">chains =</span> <span class="dv">4</span> </a>
<a class="sourceLine" id="cb1605-9" data-line-number="9">  )</a></code></pre></div>
<p>I’m not aware that you can do something like this with <strong>brms</strong>. If you think I’m in error, <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/issues">please share your solution</a>. We can at least get a sense of the model by simulating from the joint distribution and plotting.</p>
<div class="sourceCode" id="cb1606"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1606-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">13</span>)</a>
<a class="sourceLine" id="cb1606-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1606-3" data-line-number="3"><span class="kw">tibble</span>(<span class="dt">v =</span> <span class="kw">rnorm</span>(<span class="fl">1e3</span>, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">3</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1606-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x =</span> <span class="kw">rnorm</span>(<span class="fl">1e3</span>, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="kw">exp</span>(v))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1606-5" data-line-number="5"><span class="st">  </span></a>
<a class="sourceLine" id="cb1606-6" data-line-number="6"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1606-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">fill =</span> <span class="st">&quot;orange2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1606-8" data-line-number="8"><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>,</a>
<a class="sourceLine" id="cb1606-9" data-line-number="9">           <span class="dt">x =</span> <span class="dv">-100</span>, <span class="dt">y =</span> <span class="dv">490</span>, <span class="dt">hjust =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb1606-10" data-line-number="10">           <span class="dt">label =</span> <span class="kw">expression</span>(<span class="kw">italic</span>(v)<span class="op">%~%</span><span class="kw">Normal</span>(<span class="dv">0</span>, <span class="dv">3</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb1606-11" data-line-number="11"><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>,</a>
<a class="sourceLine" id="cb1606-12" data-line-number="12">           <span class="dt">x =</span> <span class="dv">-100</span>, <span class="dt">y =</span> <span class="dv">440</span>, <span class="dt">hjust =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb1606-13" data-line-number="13">           <span class="dt">label =</span> <span class="kw">expression</span>(<span class="kw">italic</span>(x)<span class="op">%~%</span><span class="kw">Normal</span>(<span class="dv">0</span>, <span class="kw">exp</span>(<span class="kw">italic</span>(v))))) <span class="op">+</span></a>
<a class="sourceLine" id="cb1606-14" data-line-number="14"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">100</span>, <span class="dv">100</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1606-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="ot">NULL</span>)</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-47-1.png" width="480" style="display: block; margin: auto;" /></p>
<p>The distribution looks something like a Student-<span class="math inline">\(t\)</span> with a very low <span class="math inline">\(\nu\)</span> parameter. We can express the joint likelihood of <span class="math inline">\(p(v, x)\)</span> as</p>
<p><span class="math display">\[p(v, x) = p(x | v) \; p(v).\]</span></p>
<p>Here that is in a plot.</p>
<div class="sourceCode" id="cb1607"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1607-1" data-line-number="1"><span class="co"># define the parameter space</span></a>
<a class="sourceLine" id="cb1607-2" data-line-number="2">parameter_space &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">-4</span>, <span class="dt">to =</span> <span class="dv">4</span>, <span class="dt">length.out =</span> <span class="dv">200</span>)</a>
<a class="sourceLine" id="cb1607-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1607-4" data-line-number="4"><span class="co"># simulate</span></a>
<a class="sourceLine" id="cb1607-5" data-line-number="5"><span class="kw">crossing</span>(<span class="dt">v =</span> parameter_space,</a>
<a class="sourceLine" id="cb1607-6" data-line-number="6">         <span class="dt">x =</span> parameter_space) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1607-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">likelihood_v =</span> <span class="kw">dnorm</span>(v, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1607-8" data-line-number="8">         <span class="dt">likelihood_x =</span> <span class="kw">dnorm</span>(x, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="kw">exp</span>(v))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1607-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">joint_likelihood =</span> likelihood_v <span class="op">*</span><span class="st"> </span>likelihood_x) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1607-10" data-line-number="10"><span class="st">  </span></a>
<a class="sourceLine" id="cb1607-11" data-line-number="11"><span class="st">  </span><span class="co"># plot!</span></a>
<a class="sourceLine" id="cb1607-12" data-line-number="12"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> v, <span class="dt">fill =</span> joint_likelihood)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1607-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_raster</span>(<span class="dt">interpolate =</span> T) <span class="op">+</span></a>
<a class="sourceLine" id="cb1607-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;B&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1607-15" data-line-number="15"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Centered parameterization&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1607-16" data-line-number="16"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-48-1.png" width="336" style="display: block; margin: auto;" /></p>
<p>This ends up as a version of McElreath’s Figure 13.5.a.</p>
<blockquote>
<p>At low values of <span class="math inline">\(v\)</span>, the distribution of <span class="math inline">\(x\)</span> contracts around zero. This forms a very steep valley that the Hamiltonian particle needs to explore. Steep surfaces are hard to simulate, because the simulation is not actually continuous. It happens in discrete steps. If the steps are too big, the simulation will overshoot. (p. 421)</p>
</blockquote>
<p>To avoid the divergent transitions than can arise from steep valleys like this, we can switch fron our origonal formula to a non-centered parameterization, such as:</p>
<p><span class="math display">\[\begin{align*}
v &amp; \sim \operatorname{Normal}(0, 3) \\
z &amp; \sim \operatorname{Normal}(0, 1) \\
x &amp; = z \exp(v),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(x\)</span> is now the product of two independent distributions, <span class="math inline">\(v\)</span> and <span class="math inline">\(z\)</span>. With this parameterization, we can express the joint likelihood <span class="math inline">\(p(v, z)\)</span> as</p>
<p><span class="math display">\[p(v, z) = p(z) \; p(v),\]</span></p>
<p>where <span class="math inline">\(p(z)\)</span> is not conditional on <span class="math inline">\(v\)</span> and <span class="math inline">\(p(v)\)</span> is not conditional on <span class="math inline">\(z\)</span>. Here’s what that looks like in a plot.</p>
<div class="sourceCode" id="cb1608"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1608-1" data-line-number="1"><span class="co"># simulate</span></a>
<a class="sourceLine" id="cb1608-2" data-line-number="2"><span class="kw">crossing</span>(<span class="dt">v =</span> parameter_space,</a>
<a class="sourceLine" id="cb1608-3" data-line-number="3">         <span class="dt">z =</span> parameter_space <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1608-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">likelihood_v =</span> <span class="kw">dnorm</span>(v, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1608-5" data-line-number="5">         <span class="dt">likelihood_z =</span> <span class="kw">dnorm</span>(z, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1608-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">joint_likelihood =</span> likelihood_v <span class="op">*</span><span class="st"> </span>likelihood_z) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1608-7" data-line-number="7"><span class="st">  </span></a>
<a class="sourceLine" id="cb1608-8" data-line-number="8"><span class="st">  </span><span class="co"># plot!</span></a>
<a class="sourceLine" id="cb1608-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> z, <span class="dt">y =</span> v, <span class="dt">fill =</span> joint_likelihood)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1608-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_raster</span>(<span class="dt">interpolate =</span> T) <span class="op">+</span></a>
<a class="sourceLine" id="cb1608-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;B&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1608-12" data-line-number="12"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Non-centered parameterization&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1608-13" data-line-number="13"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-49-1.png" width="336" style="display: block; margin: auto;" /></p>
<p>This is our version of the right-hand panel of McElreath’s Figure 13.5. No nasty funnel–just a friendly glowing likelihood orb.</p>
</div>
<div id="non-centered-chimpanzees." class="section level3">
<h3><span class="header-section-number">13.4.2</span> Non-centered chimpanzees.</h3>
<p>At the top of the section, McElreath reported the <code>rethinking::ulam()</code> default is to set <code>adapt_delta = 0.95</code>. Readers should be aware that the <code>brms::brm()</code> default is <code>adapt_delta = 0.80</code>. A consequence of this difference is <code>rethinking::ulam()</code> will tend to take smaller step sizes than <code>brms::brm()</code>, at the cost of slower exploration of the posterior. I don’t know that one is inherently better than the other. They’re just defaults.</p>
<p>Recall that due to how <strong>brms</strong> only supports the non-centered parameterization, we have already fit our version of McElreath’s <code>m13.4nc</code>. We called it <code>b13.4</code>. Here is the model summary, again.</p>
<div class="sourceCode" id="cb1609"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1609-1" data-line-number="1"><span class="kw">print</span>(b13<span class="fl">.4</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: pulled_left | trials(1) ~ a + b 
##          a ~ 1 + (1 | actor) + (1 | block)
##          b ~ 0 + treatment
##    Data: d (Number of observations: 504) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Group-Level Effects: 
## ~actor (Number of levels: 7) 
##                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(a_Intercept)     2.01      0.63     1.08     3.49 1.00     1049     2560
## 
## ~block (Number of levels: 6) 
##                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(a_Intercept)     0.21      0.18     0.01     0.66 1.00     1565     1640
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## a_Intercept      0.63      0.73    -0.85     2.04 1.00      964     1355
## b_treatment1    -0.14      0.30    -0.74     0.45 1.00     1711     2598
## b_treatment2     0.39      0.30    -0.19     0.99 1.00     2052     2455
## b_treatment3    -0.49      0.30    -1.07     0.10 1.00     1949     2975
## b_treatment4     0.28      0.30    -0.33     0.86 1.00     1921     2689
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Because we only fit this model using the non-centered parameterization, we won’t be able to fully reproduce McElreath’s Figure 13.6. But we can still plot our effective sample sizes. Recall that unlike the way <strong>rethinking</strong> only reports <code>n_eff</code>, <strong>brms</strong> now reports both <code>Bulk_ESS</code> and <code>Tail_ESS</code> <span class="citation">(see Vehtari, Gelman, et al., <a href="#ref-vehtariRanknormalizationFoldingLocalization2019">2019</a>)</span>. At the moment, <strong>brms</strong> does not offer a convenience function that allows users to collect those values in a data frame. However you can do so with help from the <a href="https://github.com/stan-dev/posterior"><strong>posterior</strong> package</a> <span class="citation">(Bürkner et al., <a href="#ref-R-posterior">2020</a>)</span>, which has not made its way to CRAN, yet, but can be downloaded directly from GitHub.</p>
<div class="sourceCode" id="cb1611"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1611-1" data-line-number="1"><span class="co"># install the beta release with this</span></a>
<a class="sourceLine" id="cb1611-2" data-line-number="2"><span class="kw">install.packages</span>(<span class="st">&quot;posterior&quot;</span>, <span class="dt">repos =</span> <span class="kw">c</span>(<span class="st">&quot;https://mc-stan.org/r-packages/&quot;</span>, <span class="kw">getOption</span>(<span class="st">&quot;repos&quot;</span>)))</a>
<a class="sourceLine" id="cb1611-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1611-4" data-line-number="4"><span class="co"># install the latest development version with this instead</span></a>
<a class="sourceLine" id="cb1611-5" data-line-number="5"><span class="kw">install.packages</span>(<span class="st">&quot;remotes&quot;</span>)</a>
<a class="sourceLine" id="cb1611-6" data-line-number="6">remotes<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;stan-dev/posterior&quot;</span>)</a></code></pre></div>
<p>For our purposes, the function of interest is <code>summarise_draws()</code>, which will take the output from <code>posterior_samples()</code> as input.</p>
<div class="sourceCode" id="cb1612"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1612-1" data-line-number="1"><span class="kw">library</span>(posterior)</a>
<a class="sourceLine" id="cb1612-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1612-3" data-line-number="3"><span class="kw">posterior_samples</span>(b13<span class="fl">.4</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1612-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise_draws</span>()</a></code></pre></div>
<pre><code>## # A tibble: 21 x 10
##    variable                  mean median    sd   mad      q5     q95  rhat ess_bulk ess_tail
##    &lt;chr&gt;                    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 b_a_Intercept            0.632  0.635 0.734 0.696 -0.605   1.83    1.00     957.    1343.
##  2 b_b_treatment1          -0.135 -0.131 0.299 0.301 -0.631   0.359   1.00    1718.    2575.
##  3 b_b_treatment2           0.387  0.391 0.304 0.304 -0.103   0.892   1.00    2053.    2449.
##  4 b_b_treatment3          -0.486 -0.486 0.301 0.308 -0.969   0.0157  1.00    1977.    2947.
##  5 b_b_treatment4           0.277  0.273 0.302 0.301 -0.218   0.780   1.00    1916.    2677.
##  6 sd_actor__a_Intercept    2.01   1.90  0.627 0.578  1.20    3.23    1.00     994.    2554.
##  7 sd_block__a_Intercept    0.207  0.167 0.178 0.144  0.0158  0.511   1.00    1559.    1615.
##  8 r_actor__a[1,Intercept] -0.984 -0.983 0.740 0.696 -2.17    0.220   1.00     978.    1454.
##  9 r_actor__a[2,Intercept]  4.06   3.86  1.38  1.18   2.22    6.58    1.00    1891.    2215.
## 10 r_actor__a[3,Intercept] -1.29  -1.29  0.743 0.711 -2.49   -0.0602  1.00     979.    1320.
## # … with 11 more rows</code></pre>
<p>Note how the last three columns are the <code>rhat</code>, the <code>ess_bulk</code>, and the <code>ess_tail</code>. Here we summarize those two effective sample size columns with histograms.</p>
<div class="sourceCode" id="cb1614"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1614-1" data-line-number="1"><span class="kw">posterior_samples</span>(b13<span class="fl">.4</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1614-2" data-line-number="2"><span class="st">  </span><span class="kw">summarise_draws</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1614-3" data-line-number="3"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;ess&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1614-4" data-line-number="4"><span class="st">  </span></a>
<a class="sourceLine" id="cb1614-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1614-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">100</span>, <span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1614-7" data-line-number="7"><span class="st">  </span><span class="kw">xlim</span>(<span class="dv">0</span>, <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1614-8" data-line-number="8"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>name)</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-53-1.png" width="480" style="display: block; margin: auto;" /></p>
<p>Both measures of effective sample size are fine.</p>
<blockquote>
<p>So should we always use the non-centered parameterization? No. Sometimes the centered form is better. It could even be true that the centered form is better for one cluster in a model while the non-centered form is better for another cluster in the same model. It all depends upon the details. Typically, a cluster with low variation, like the blocks in <code>m13.4</code>, will sample better with a non-centered prior. And if you have a large number of units inside a cluster, but not much data for each unit, then the non-centered is also usually better. But being able to switch back and forth as needed is very useful. (p. 425)</p>
</blockquote>
<p>I won’t argue with McElreath, here. But if you run into a situation where you’d like to use the centered parameterization, you will have to use <strong>rethinking</strong> or fit your model directly in Stan. <strong>brms</strong> won’t support you, there.</p>
</div>
</div>
<div id="multilevel-posterior-predictions" class="section level2">
<h2><span class="header-section-number">13.5</span> Multilevel posterior predictions</h2>
<blockquote>
<p>Every model is a merger of sense and nonsense. When we understand a model, we can find its sense and control its nonsense. But as models get more complex, it is very difficult to impossible to understand them just by inspecting tables of posterior means and intervals. Exploring implied posterior predictions helps much more….</p>
<p>The introduction of varying effects does introduce nuance, however.</p>
<p>First, we should no longer expect the model to exactly retrodict the sample, because adaptive regularization has as its goal to trade off poorer fit in sample for better inference and hopefully better fit out of sample. That is what shrinkage does for us. Of course, we should never be trying to really retrodict the sample. But now you have to expect that even a perfectly good model fit will differ from the raw data in a systematic way.</p>
<p>Second, “prediction” in the context of a multilevel model requires additional choices. If we wish to validate a model against the specific clusters used to fit the model, that is one thing. But if we instead wish to compute predictions for new clusters, other than the ones observed in the sample, that is quite another. We’ll consider each of these in turn, continuing to use the chimpanzees model from the previous section. (p. 426)</p>
</blockquote>
<div id="posterior-prediction-for-same-clusters." class="section level3">
<h3><span class="header-section-number">13.5.1</span> Posterior prediction for same clusters.</h3>
<p>Like McElreath did in the text, we’ll do this two ways. Recall we use <code>brms::fitted()</code> in place of <code>rethinking::link()</code>.</p>
<div class="sourceCode" id="cb1615"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1615-1" data-line-number="1">chimp &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb1615-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1615-3" data-line-number="3">nd &lt;-</a>
<a class="sourceLine" id="cb1615-4" data-line-number="4"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1615-5" data-line-number="5"><span class="st">  </span><span class="kw">distinct</span>(treatment) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1615-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">actor =</span> chimp,</a>
<a class="sourceLine" id="cb1615-7" data-line-number="7">         <span class="dt">block =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1615-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1615-9" data-line-number="9">labels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;R/N&quot;</span>, <span class="st">&quot;L/N&quot;</span>, <span class="st">&quot;R/P&quot;</span>, <span class="st">&quot;L/P&quot;</span>)</a>
<a class="sourceLine" id="cb1615-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1615-11" data-line-number="11">f &lt;-</a>
<a class="sourceLine" id="cb1615-12" data-line-number="12"><span class="st">  </span><span class="kw">fitted</span>(b13<span class="fl">.4</span>,</a>
<a class="sourceLine" id="cb1615-13" data-line-number="13">         <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1615-14" data-line-number="14"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1615-15" data-line-number="15"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1615-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">factor</span>(treatment, <span class="dt">labels =</span> labels))</a>
<a class="sourceLine" id="cb1615-17" data-line-number="17"></a>
<a class="sourceLine" id="cb1615-18" data-line-number="18">f</a></code></pre></div>
<pre><code>##    Estimate  Est.Error      Q2.5     Q97.5 treatment actor block
## 1 0.9787295 0.02126683 0.9224670 0.9995272       R/N     2     1
## 2 0.9870054 0.01366843 0.9511776 0.9997251       L/N     2     1
## 3 0.9703801 0.02892296 0.8946880 0.9992900       R/P     2     1
## 4 0.9855329 0.01495810 0.9462899 0.9996733       L/P     2     1</code></pre>
<p>Here are the empirical probabilities computed directly from the data (i.e., the no-pooling model).</p>
<div class="sourceCode" id="cb1617"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1617-1" data-line-number="1">(</a>
<a class="sourceLine" id="cb1617-2" data-line-number="2">  chimp_<span class="dv">2</span>_d &lt;-</a>
<a class="sourceLine" id="cb1617-3" data-line-number="3"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1617-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(actor <span class="op">==</span><span class="st"> </span>chimp) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1617-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(treatment) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1617-6" data-line-number="6"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">prob =</span> <span class="kw">mean</span>(pulled_left)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1617-7" data-line-number="7"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1617-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">factor</span>(treatment, <span class="dt">labels =</span> labels))</a>
<a class="sourceLine" id="cb1617-9" data-line-number="9">)</a></code></pre></div>
<pre><code>## # A tibble: 4 x 2
##   treatment  prob
##   &lt;fct&gt;     &lt;dbl&gt;
## 1 R/N           1
## 2 L/N           1
## 3 R/P           1
## 4 L/P           1</code></pre>
<p>McElreath didn’t show the corresponding plot in the text. It might look like this.</p>
<div class="sourceCode" id="cb1619"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1619-1" data-line-number="1">f <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1619-2" data-line-number="2"><span class="st">  </span><span class="co"># if you want to use `geom_line()` or `geom_ribbon()` with a factor on the x axis,</span></a>
<a class="sourceLine" id="cb1619-3" data-line-number="3"><span class="st">  </span><span class="co"># you need to code something like `group = 1` in `aes()`</span></a>
<a class="sourceLine" id="cb1619-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> treatment, <span class="dt">y =</span> Estimate, <span class="dt">group =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1619-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> Q2<span class="fl">.5</span>, <span class="dt">ymax =</span> Q97<span class="fl">.5</span>), <span class="dt">fill =</span> <span class="st">&quot;orange1&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1619-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1619-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> chimp_<span class="dv">2</span>_d,</a>
<a class="sourceLine" id="cb1619-8" data-line-number="8">             <span class="kw">aes</span>(<span class="dt">y =</span> prob),</a>
<a class="sourceLine" id="cb1619-9" data-line-number="9">             <span class="dt">color =</span> <span class="st">&quot;grey25&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1619-10" data-line-number="10"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Chimp #2&quot;</span>,</a>
<a class="sourceLine" id="cb1619-11" data-line-number="11">          <span class="dt">subtitle =</span> <span class="st">&quot;The posterior mean and 95%</span><span class="ch">\n</span><span class="st">intervals are the blue line</span><span class="ch">\n</span><span class="st">and orange band, respectively.</span><span class="ch">\n</span><span class="st">The empirical means are</span><span class="ch">\n</span><span class="st">the charcoal dots.&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1619-12" data-line-number="12"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(.<span class="dv">75</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1619-13" data-line-number="13"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">10</span>))</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-56-1.png" width="240" style="display: block; margin: auto;" /></p>
<p>Do note how severely we’ve restricted the <span class="math inline">\(y\)</span>-axis range. But okay, now let’s do things by hand. We’ll need to extract the posterior samples and look at the structure of the data.</p>
<div class="sourceCode" id="cb1620"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1620-1" data-line-number="1">post &lt;-<span class="st"> </span><span class="kw">posterior_samples</span>(b13<span class="fl">.4</span>)</a>
<a class="sourceLine" id="cb1620-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1620-3" data-line-number="3"><span class="kw">glimpse</span>(post)</a></code></pre></div>
<pre><code>## Rows: 4,000
## Columns: 21
## $ b_a_Intercept             &lt;dbl&gt; 1.61353780, 2.29909672, 0.21804618, -0.71822690, -0.29446959, -0.49454948…
## $ b_b_treatment1            &lt;dbl&gt; -0.5881338192, -0.0521139913, -0.0944142974, -0.2991082049, -0.2709837751…
## $ b_b_treatment2            &lt;dbl&gt; 0.15357729, 0.11647257, 0.22554745, 0.48485808, 0.08526243, 0.39399161, 0…
## $ b_b_treatment3            &lt;dbl&gt; -0.403645564, -0.653273387, -0.735431962, -0.215537742, -0.277967092, -0.…
## $ b_b_treatment4            &lt;dbl&gt; -0.04534249, 0.12634161, 0.28056996, 0.11954150, 0.21095851, 0.17789486, …
## $ sd_actor__a_Intercept     &lt;dbl&gt; 1.290175, 1.898355, 1.956417, 2.895852, 3.064750, 2.518026, 2.039748, 2.4…
## $ sd_block__a_Intercept     &lt;dbl&gt; 0.029763422, 0.098032595, 0.137982597, 0.271987808, 0.222494959, 0.078771…
## $ `r_actor__a[1,Intercept]` &lt;dbl&gt; -1.672948712, -2.776625832, -0.744449782, 0.219976887, 0.477092542, 0.120…
## $ `r_actor__a[2,Intercept]` &lt;dbl&gt; 2.513310, 3.238901, 3.318018, 6.037397, 4.867757, 5.038438, 5.034154, 5.5…
## $ `r_actor__a[3,Intercept]` &lt;dbl&gt; -1.986462e+00, -2.868363e+00, -7.113747e-01, 3.231409e-01, -4.935144e-01,…
## $ `r_actor__a[4,Intercept]` &lt;dbl&gt; -1.71484148, -3.20351097, -0.51921879, 0.60503596, -0.10105241, 0.0358684…
## $ `r_actor__a[5,Intercept]` &lt;dbl&gt; -1.695710048, -2.731675437, -0.490459108, 0.480324319, -0.013488604, 0.28…
## $ `r_actor__a[6,Intercept]` &lt;dbl&gt; -0.99172822, -1.68587770, 0.16173108, 0.87110668, 1.26328478, 1.15483514,…
## $ `r_actor__a[7,Intercept]` &lt;dbl&gt; 0.78237533, 0.59372302, 1.66607028, 2.60068603, 2.20321760, 3.15798989, 2…
## $ `r_block__a[1,Intercept]` &lt;dbl&gt; -0.019923765, -0.046674154, -0.090481864, -0.427836347, -0.149315008, 0.0…
## $ `r_block__a[2,Intercept]` &lt;dbl&gt; -0.021106086, -0.035369969, 0.177476123, 0.094307488, 0.318098613, 0.0415…
## $ `r_block__a[3,Intercept]` &lt;dbl&gt; -0.004309381, 0.066861370, -0.002291435, 0.232281836, 0.298768025, 0.0012…
## $ `r_block__a[4,Intercept]` &lt;dbl&gt; 0.006238016, 0.116369914, -0.195335891, -0.240182260, -0.327461566, 0.085…
## $ `r_block__a[5,Intercept]` &lt;dbl&gt; 0.013151235, -0.013473133, -0.048064661, 0.052216626, 0.008668973, 0.1018…
## $ `r_block__a[6,Intercept]` &lt;dbl&gt; 0.034684330, 0.098429335, -0.004342521, 0.248927252, 0.147661130, 0.04701…
## $ lp__                      &lt;dbl&gt; -288.3516, -287.4684, -284.0937, -284.5207, -285.9123, -286.0937, -280.10…</code></pre>
<p>McElreath didn’t show what his <strong>R</strong> code 13.33 <code>dens( post$a[,5] )</code> would look like. But here’s our analogue.</p>
<div class="sourceCode" id="cb1622"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1622-1" data-line-number="1">post <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1622-2" data-line-number="2"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">actor_5 =</span> <span class="st">`</span><span class="dt">r_actor__a[5,Intercept]</span><span class="st">`</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1622-3" data-line-number="3"><span class="st">  </span></a>
<a class="sourceLine" id="cb1622-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> actor_<span class="dv">5</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1622-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1622-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1622-7" data-line-number="7"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Chimp #5&#39;s density&quot;</span>)</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-58-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>And because we made the density only using the <code>r_actor__a[5,Intercept]</code> values (i.e., we didn’t add <code>b_Intercept</code> to them), the density is in a deviance-score metric.</p>
<p>McElreath built his own <code>link()</code> function in <strong>R</strong> code 13.34. With this particular model, it will be easiest for us to just work directly with <code>post</code>.</p>
<div class="sourceCode" id="cb1623"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1623-1" data-line-number="1">f &lt;-</a>
<a class="sourceLine" id="cb1623-2" data-line-number="2"><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1623-3" data-line-number="3"><span class="st">  </span><span class="kw">pivot_longer</span>(b_b_treatment1<span class="op">:</span>b_b_treatment4) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1623-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fitted =</span> <span class="kw">inv_logit_scaled</span>(b_a_Intercept <span class="op">+</span><span class="st"> </span>value <span class="op">+</span><span class="st"> `</span><span class="dt">r_actor__a[1,Intercept]</span><span class="st">`</span> <span class="op">+</span><span class="st"> `</span><span class="dt">r_block__a[1,Intercept]</span><span class="st">`</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1623-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">factor</span>(<span class="kw">str_remove</span>(name, <span class="st">&quot;b_b_treatment&quot;</span>),</a>
<a class="sourceLine" id="cb1623-6" data-line-number="6">                            <span class="dt">labels =</span> labels)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1623-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(name<span class="op">:</span>treatment)</a>
<a class="sourceLine" id="cb1623-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1623-9" data-line-number="9">f</a></code></pre></div>
<pre><code>## # A tibble: 16,000 x 4
##    name             value fitted treatment
##    &lt;chr&gt;            &lt;dbl&gt;  &lt;dbl&gt; &lt;fct&gt;    
##  1 b_b_treatment1 -0.588   0.339 R/N      
##  2 b_b_treatment2  0.154   0.519 L/N      
##  3 b_b_treatment3 -0.404   0.382 R/P      
##  4 b_b_treatment4 -0.0453  0.469 L/P      
##  5 b_b_treatment1 -0.0521  0.360 R/N      
##  6 b_b_treatment2  0.116   0.399 L/N      
##  7 b_b_treatment3 -0.653   0.236 R/P      
##  8 b_b_treatment4  0.126   0.402 L/P      
##  9 b_b_treatment1 -0.0944  0.329 R/N      
## 10 b_b_treatment2  0.226   0.403 L/N      
## # … with 15,990 more rows</code></pre>
<p>Now we’ll summarize those values and compute their empirical analogues directly from the data.</p>
<div class="sourceCode" id="cb1625"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1625-1" data-line-number="1"><span class="co"># the posterior summaries</span></a>
<a class="sourceLine" id="cb1625-2" data-line-number="2">(</a>
<a class="sourceLine" id="cb1625-3" data-line-number="3">  f &lt;-</a>
<a class="sourceLine" id="cb1625-4" data-line-number="4"><span class="st">  </span>f <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1625-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(treatment) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1625-6" data-line-number="6"><span class="st">  </span>tidybayes<span class="op">::</span><span class="kw">mean_qi</span>(fitted)</a>
<a class="sourceLine" id="cb1625-7" data-line-number="7">)</a></code></pre></div>
<pre><code>## # A tibble: 4 x 7
##   treatment fitted .lower .upper .width .point .interval
##   &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
## 1 R/N        0.347  0.203  0.501   0.95 mean   qi       
## 2 L/N        0.469  0.302  0.629   0.95 mean   qi       
## 3 R/P        0.274  0.148  0.415   0.95 mean   qi       
## 4 L/P        0.443  0.278  0.601   0.95 mean   qi</code></pre>
<div class="sourceCode" id="cb1627"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1627-1" data-line-number="1"><span class="co"># the empirical summaries</span></a>
<a class="sourceLine" id="cb1627-2" data-line-number="2">chimp &lt;-<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb1627-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1627-4" data-line-number="4">(</a>
<a class="sourceLine" id="cb1627-5" data-line-number="5">  chimp_<span class="dv">5</span>_d &lt;-</a>
<a class="sourceLine" id="cb1627-6" data-line-number="6"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1627-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(actor <span class="op">==</span><span class="st"> </span>chimp) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1627-8" data-line-number="8"><span class="st">  </span><span class="kw">group_by</span>(treatment) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1627-9" data-line-number="9"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">prob =</span> <span class="kw">mean</span>(pulled_left)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1627-10" data-line-number="10"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1627-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">factor</span>(treatment, <span class="dt">labels =</span> labels))</a>
<a class="sourceLine" id="cb1627-12" data-line-number="12">)</a></code></pre></div>
<pre><code>## # A tibble: 4 x 2
##   treatment  prob
##   &lt;fct&gt;     &lt;dbl&gt;
## 1 R/N       0.333
## 2 L/N       0.556
## 3 R/P       0.278
## 4 L/P       0.5</code></pre>
<p>Okay, let’s see how good we are at retrodicting the <code>pulled_left</code> probabilities for <code>actor == 5</code>.</p>
<div class="sourceCode" id="cb1629"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1629-1" data-line-number="1">f <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1629-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> treatment, <span class="dt">y =</span> fitted, <span class="dt">group =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1629-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> .lower, <span class="dt">ymax =</span> .upper), <span class="dt">fill =</span> <span class="st">&quot;orange1&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1629-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1629-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> chimp_<span class="dv">5</span>_d,</a>
<a class="sourceLine" id="cb1629-6" data-line-number="6">             <span class="kw">aes</span>(<span class="dt">y =</span> prob),</a>
<a class="sourceLine" id="cb1629-7" data-line-number="7">             <span class="dt">color =</span> <span class="st">&quot;grey25&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1629-8" data-line-number="8"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Chimp #5&quot;</span>,</a>
<a class="sourceLine" id="cb1629-9" data-line-number="9">          <span class="dt">subtitle =</span> <span class="st">&quot;This plot is like the last except</span><span class="ch">\n</span><span class="st">we did more by hand.&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1629-10" data-line-number="10"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1629-11" data-line-number="11"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">10</span>))</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-61-1.png" width="240" style="display: block; margin: auto;" /></p>
<p>Not bad.</p>
</div>
<div id="posterior-prediction-for-new-clusters." class="section level3">
<h3><span class="header-section-number">13.5.2</span> Posterior prediction for new clusters.</h3>
<p>By average actor, McElreath referred to a chimp with an intercept exactly at the population mean <span class="math inline">\(\bar \alpha\)</span>. Given our non-centered parameterization for <code>b13.4</code>, this means we’ll leave out the random effects for <code>actor</code>. Since we’re predicting what might happen in new experimental blocks, we’ll leave out the random effects for <code>block</code>, too. When doing this by hand, the workflow is much like is was before, just with fewer columns added together within the first <code>mutate()</code> line.</p>
<div class="sourceCode" id="cb1630"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1630-1" data-line-number="1">f &lt;-</a>
<a class="sourceLine" id="cb1630-2" data-line-number="2"><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1630-3" data-line-number="3"><span class="st">  </span><span class="kw">pivot_longer</span>(b_b_treatment1<span class="op">:</span>b_b_treatment4) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1630-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fitted =</span> <span class="kw">inv_logit_scaled</span>(b_a_Intercept <span class="op">+</span><span class="st"> </span>value)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1630-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">factor</span>(<span class="kw">str_remove</span>(name, <span class="st">&quot;b_b_treatment&quot;</span>),</a>
<a class="sourceLine" id="cb1630-6" data-line-number="6">                            <span class="dt">labels =</span> labels)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1630-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(name<span class="op">:</span>treatment) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1630-8" data-line-number="8"><span class="st">  </span><span class="kw">group_by</span>(treatment) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1630-9" data-line-number="9"><span class="st">  </span><span class="co"># note we&#39;re using 80% intervals</span></a>
<a class="sourceLine" id="cb1630-10" data-line-number="10"><span class="st">  </span>tidybayes<span class="op">::</span><span class="kw">mean_qi</span>(fitted, <span class="dt">.width =</span> <span class="fl">.8</span>)</a>
<a class="sourceLine" id="cb1630-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1630-12" data-line-number="12">f</a></code></pre></div>
<pre><code>## # A tibble: 4 x 7
##   treatment fitted .lower .upper .width .point .interval
##   &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
## 1 R/N        0.610  0.395  0.804    0.8 mean   qi       
## 2 L/N        0.714  0.524  0.873    0.8 mean   qi       
## 3 R/P        0.533  0.316  0.740    0.8 mean   qi       
## 4 L/P        0.694  0.496  0.860    0.8 mean   qi</code></pre>
<p>Make Figure 13.7.a.</p>
<div class="sourceCode" id="cb1632"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1632-1" data-line-number="1">p1 &lt;-</a>
<a class="sourceLine" id="cb1632-2" data-line-number="2"><span class="st">  </span>f <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1632-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> treatment, <span class="dt">y =</span> fitted, <span class="dt">group =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1632-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> .lower, <span class="dt">ymax =</span> .upper), <span class="dt">fill =</span> <span class="st">&quot;orange1&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1632-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1632-6" data-line-number="6"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average actor&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1632-7" data-line-number="7"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1632-8" data-line-number="8"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">14</span>, <span class="dt">hjust =</span> <span class="fl">.5</span>))</a>
<a class="sourceLine" id="cb1632-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1632-10" data-line-number="10">p1</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-63-1.png" width="240" style="display: block; margin: auto;" /></p>
<p>If we want to depict the variability across the chimps, we need to include <code>sd_actor__a_Intercept</code> into the calculations. In the first block of code, below, we simulate a bundle of new intercepts defined by</p>
<p><span class="math display">\[\text{simulated chimpanzees} \sim \operatorname{Normal} (\bar \alpha, \sigma_\alpha).\]</span></p>
<p>As before, we are also averaging over <code>block</code>.</p>
<div class="sourceCode" id="cb1633"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1633-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">13</span>)</a>
<a class="sourceLine" id="cb1633-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1633-3" data-line-number="3">f &lt;-</a>
<a class="sourceLine" id="cb1633-4" data-line-number="4"><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1633-5" data-line-number="5"><span class="st">  </span><span class="co"># simulated chimpanzees</span></a>
<a class="sourceLine" id="cb1633-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">a_sim =</span> <span class="kw">rnorm</span>(<span class="kw">n</span>(), <span class="dt">mean =</span> b_a_Intercept, <span class="dt">sd =</span> sd_actor__a_Intercept)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1633-7" data-line-number="7"><span class="st">  </span><span class="kw">pivot_longer</span>(b_b_treatment1<span class="op">:</span>b_b_treatment4) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1633-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fitted =</span> <span class="kw">inv_logit_scaled</span>(a_sim <span class="op">+</span><span class="st"> </span>value)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1633-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">factor</span>(<span class="kw">str_remove</span>(name, <span class="st">&quot;b_b_treatment&quot;</span>),</a>
<a class="sourceLine" id="cb1633-10" data-line-number="10">                            <span class="dt">labels =</span> labels)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1633-11" data-line-number="11"><span class="st">  </span><span class="kw">group_by</span>(treatment) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1633-12" data-line-number="12"><span class="st">  </span><span class="co"># note we&#39;re using 80% intervals</span></a>
<a class="sourceLine" id="cb1633-13" data-line-number="13"><span class="st">  </span><span class="kw">mean_qi</span>(fitted, <span class="dt">.width =</span> <span class="fl">.8</span>)</a>
<a class="sourceLine" id="cb1633-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1633-15" data-line-number="15">f</a></code></pre></div>
<pre><code>## # A tibble: 4 x 7
##   treatment fitted .lower .upper .width .point .interval
##   &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
## 1 R/N        0.572 0.0985  0.959    0.8 mean   qi       
## 2 L/N        0.647 0.161   0.977    0.8 mean   qi       
## 3 R/P        0.520 0.0716  0.944    0.8 mean   qi       
## 4 L/P        0.631 0.147   0.973    0.8 mean   qi</code></pre>
<p>Behold Figure 13.7.b.</p>
<div class="sourceCode" id="cb1635"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1635-1" data-line-number="1">p2 &lt;-</a>
<a class="sourceLine" id="cb1635-2" data-line-number="2"><span class="st">  </span>f <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1635-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> treatment, <span class="dt">y =</span> fitted, <span class="dt">group =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1635-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> .lower, <span class="dt">ymax =</span> .upper), <span class="dt">fill =</span> <span class="st">&quot;orange1&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1635-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1635-6" data-line-number="6"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Marginal of actor&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1635-7" data-line-number="7"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1635-8" data-line-number="8"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">14</span>, <span class="dt">hjust =</span> <span class="fl">.5</span>))</a>
<a class="sourceLine" id="cb1635-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1635-10" data-line-number="10">p2</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-65-1.png" width="240" style="display: block; margin: auto;" /></p>
<p>The big difference between this workflow and the last is now we start of by marking off the rows in <code>post</code> with an <code>iter</code> index and then use <code>sample_n()</code> to randomly sample 100 posterior rows. We also omit the <code>group_by()</code> and <code>mean_qi()</code> lines at the end.</p>
<div class="sourceCode" id="cb1636"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1636-1" data-line-number="1"><span class="co"># how many simulated chimps would you like?</span></a>
<a class="sourceLine" id="cb1636-2" data-line-number="2">n_chimps &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb1636-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1636-4" data-line-number="4"><span class="kw">set.seed</span>(<span class="dv">13</span>)</a>
<a class="sourceLine" id="cb1636-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1636-6" data-line-number="6">f &lt;-</a>
<a class="sourceLine" id="cb1636-7" data-line-number="7"><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1636-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">iter =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1636-9" data-line-number="9"><span class="st">  </span><span class="kw">sample_n</span>(<span class="dt">size =</span> n_chimps) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1636-10" data-line-number="10"><span class="st">  </span><span class="co"># simulated chimpanzees</span></a>
<a class="sourceLine" id="cb1636-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">a_sim =</span> <span class="kw">rnorm</span>(<span class="kw">n</span>(), <span class="dt">mean =</span> b_a_Intercept, <span class="dt">sd =</span> sd_actor__a_Intercept)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1636-12" data-line-number="12"><span class="st">  </span><span class="kw">pivot_longer</span>(b_b_treatment1<span class="op">:</span>b_b_treatment4) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1636-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fitted =</span> <span class="kw">inv_logit_scaled</span>(a_sim <span class="op">+</span><span class="st"> </span>value)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1636-14" data-line-number="14"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">factor</span>(<span class="kw">str_remove</span>(name, <span class="st">&quot;b_b_treatment&quot;</span>),</a>
<a class="sourceLine" id="cb1636-15" data-line-number="15">                            <span class="dt">labels =</span> labels)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1636-16" data-line-number="16"><span class="st">  </span><span class="kw">select</span>(iter<span class="op">:</span>treatment)</a>
<a class="sourceLine" id="cb1636-17" data-line-number="17"></a>
<a class="sourceLine" id="cb1636-18" data-line-number="18">f</a></code></pre></div>
<pre><code>## # A tibble: 400 x 6
##     iter a_sim name             value  fitted treatment
##    &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;            &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;    
##  1  1496 -5.05 b_b_treatment1 -0.0454 0.00609 R/N      
##  2  1496 -5.05 b_b_treatment2  0.536  0.0108  L/N      
##  3  1496 -5.05 b_b_treatment3 -0.609  0.00348 R/P      
##  4  1496 -5.05 b_b_treatment4  0.525  0.0107  L/P      
##  5  3843 -1.03 b_b_treatment1 -0.328  0.205   R/N      
##  6  3843 -1.03 b_b_treatment2  0.356  0.338   L/N      
##  7  3843 -1.03 b_b_treatment3 -0.279  0.213   R/P      
##  8  3843 -1.03 b_b_treatment4  0.281  0.321   L/P      
##  9   960  1.87 b_b_treatment1 -0.313  0.826   R/N      
## 10   960  1.87 b_b_treatment2  0.369  0.904   L/N      
## # … with 390 more rows</code></pre>
<p>Make Figure 13.7.c.</p>
<div class="sourceCode" id="cb1638"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1638-1" data-line-number="1">p3 &lt;-</a>
<a class="sourceLine" id="cb1638-2" data-line-number="2"><span class="st">  </span>f <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1638-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> treatment, <span class="dt">y =</span> fitted, <span class="dt">group =</span> iter)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1638-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">color =</span> <span class="st">&quot;orange3&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1638-5" data-line-number="5"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;100 simulated actors&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1638-6" data-line-number="6"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1638-7" data-line-number="7"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">14</span>, <span class="dt">hjust =</span> <span class="fl">.5</span>))</a>
<a class="sourceLine" id="cb1638-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1638-9" data-line-number="9">p3</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-67-1.png" width="240" style="display: block; margin: auto;" /></p>
<p>For the finale, we’ll combine the three plots with <strong>patchwork</strong>.</p>
<div class="sourceCode" id="cb1639"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1639-1" data-line-number="1"><span class="kw">library</span>(patchwork)</a>
<a class="sourceLine" id="cb1639-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1639-3" data-line-number="3">p1 <span class="op">|</span><span class="st"> </span>p2 <span class="op">|</span><span class="st"> </span>p3</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-68-1.png" width="720" style="display: block; margin: auto;" /></p>
<div id="bonus-lets-use-fitted-this-time." class="section level4">
<h4><span class="header-section-number">13.5.2.1</span> Bonus: Let’s use <code>fitted()</code> this time.</h4>
<p>We just made those plots using various wrangled versions of <code>post</code>, the data frame returned by <code>posterior_samples(b.13.4)</code>. If you followed along closely, part of what made that a great exercise is that it forced you to consider what the various vectors in <code>post</code> meant with respect to the model formula. But it’s also handy to see how to do that from a different perspective. So in this section, we’ll repeat that process by relying on the <code>fitted()</code> function, instead. We’ll go in the same order, starting with the average actor.</p>
<div class="sourceCode" id="cb1640"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1640-1" data-line-number="1">nd &lt;-<span class="st"> </span><span class="kw">distinct</span>(d, treatment)</a>
<a class="sourceLine" id="cb1640-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1640-3" data-line-number="3">(</a>
<a class="sourceLine" id="cb1640-4" data-line-number="4">  f &lt;-</a>
<a class="sourceLine" id="cb1640-5" data-line-number="5"><span class="st">  </span><span class="kw">fitted</span>(b13<span class="fl">.4</span>,</a>
<a class="sourceLine" id="cb1640-6" data-line-number="6">         <span class="dt">newdata =</span> nd,</a>
<a class="sourceLine" id="cb1640-7" data-line-number="7">         <span class="dt">re_formula =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb1640-8" data-line-number="8">         <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">1</span>, <span class="fl">.9</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1640-9" data-line-number="9"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1640-10" data-line-number="10"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1640-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">factor</span>(treatment, <span class="dt">labels =</span> labels))</a>
<a class="sourceLine" id="cb1640-12" data-line-number="12">)</a></code></pre></div>
<pre><code>##    Estimate Est.Error       Q10       Q90 treatment
## 1 0.6098332 0.1563866 0.3947594 0.8040578       R/N
## 2 0.7142176 0.1391407 0.5242422 0.8734818       L/N
## 3 0.5331834 0.1612549 0.3158449 0.7396197       R/P
## 4 0.6938553 0.1424508 0.4956653 0.8602308       L/P</code></pre>
<p>You should notice a few things. Since <code>b13.4</code> is a cross-classified multilevel model, it had three predictors: <code>treatment</code>, <code>block</code>, and <code>actor</code>. However, our <code>nd</code> data only included the first of those three. The reason <code>fitted()</code> permitted that was because we set <code>re_formula = NA</code>. When you do that, you tell <code>fitted()</code> to ignore group-level effects (i.e., focus only on the fixed effects). This was our <code>fitted()</code> version of ignoring the <code>r_</code> vectors returned by <code>posterior_samples()</code>. Here’s the plot.</p>
<div class="sourceCode" id="cb1642"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1642-1" data-line-number="1">p4 &lt;-</a>
<a class="sourceLine" id="cb1642-2" data-line-number="2"><span class="st">  </span>f <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1642-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> treatment, <span class="dt">y =</span> Estimate, <span class="dt">group =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1642-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> Q10, <span class="dt">ymax =</span> Q90), <span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1642-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;orange1&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1642-6" data-line-number="6"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average actor&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1642-7" data-line-number="7"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1642-8" data-line-number="8"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">14</span>, <span class="dt">hjust =</span> <span class="fl">.5</span>))</a>
<a class="sourceLine" id="cb1642-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1642-10" data-line-number="10">p4</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-70-1.png" width="240" style="display: block; margin: auto;" /></p>
<p>For marginal of actor, we can continue using the same <code>nd</code> data. This time we’ll be sticking with the default <code>re_formula</code> setting, which will accommodate the multilevel nature of the model. However, we’ll also be adding <code>allow_new_levels = T</code> and <code>sample_new_levels = &quot;gaussian&quot;</code>. The former will allow us to marginalize across the specific actors and blocks in our data and the latter will instruct <code>fitted()</code> to use the multivariate normal distribution implied by the random effects. It’ll make more sense why I say <em>multivariate</em> normal by the end of the <a href="adventures-in-covariance.html#adventures-in-covariance">next chapter</a>. For now, just go with it.</p>
<div class="sourceCode" id="cb1643"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1643-1" data-line-number="1">(</a>
<a class="sourceLine" id="cb1643-2" data-line-number="2">  f &lt;-</a>
<a class="sourceLine" id="cb1643-3" data-line-number="3"><span class="st">  </span><span class="kw">fitted</span>(b13<span class="fl">.4</span>,</a>
<a class="sourceLine" id="cb1643-4" data-line-number="4">         <span class="dt">newdata =</span> nd,</a>
<a class="sourceLine" id="cb1643-5" data-line-number="5">         <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">1</span>, <span class="fl">.9</span>),</a>
<a class="sourceLine" id="cb1643-6" data-line-number="6">         <span class="dt">allow_new_levels =</span> T,</a>
<a class="sourceLine" id="cb1643-7" data-line-number="7">         <span class="dt">sample_new_levels =</span> <span class="st">&quot;gaussian&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1643-8" data-line-number="8"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1643-9" data-line-number="9"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1643-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">factor</span>(treatment, <span class="dt">labels =</span> labels))</a>
<a class="sourceLine" id="cb1643-11" data-line-number="11">  )</a></code></pre></div>
<pre><code>##    Estimate Est.Error        Q10       Q90 treatment
## 1 0.5785581 0.3180170 0.09608327 0.9664923       R/N
## 2 0.6510787 0.3053672 0.15230113 0.9796633       L/N
## 3 0.5285130 0.3229412 0.06917748 0.9510153       R/P
## 4 0.6361257 0.3084835 0.13956392 0.9772636       L/P</code></pre>
<p>Here’s our <code>fitted()</code>-based marginal of <code>actor</code> plot.</p>
<div class="sourceCode" id="cb1645"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1645-1" data-line-number="1">p5 &lt;-</a>
<a class="sourceLine" id="cb1645-2" data-line-number="2"><span class="st">  </span>f <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1645-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> treatment, <span class="dt">y =</span> Estimate, <span class="dt">group =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1645-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> Q10, <span class="dt">ymax =</span> Q90), <span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1645-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;orange1&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1645-6" data-line-number="6"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Marginal of actor&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1645-7" data-line-number="7"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1645-8" data-line-number="8"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">14</span>, <span class="dt">hjust =</span> <span class="fl">.5</span>))</a>
<a class="sourceLine" id="cb1645-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1645-10" data-line-number="10">p5</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-72-1.png" width="240" style="display: block; margin: auto;" /></p>
<p>For the simulated actors plot, we’ll just amend our process from the last one. This time we set <code>summary = F</code> to keep the iteration-specific results and set <code>nsamples = n_sim</code> to indicate the number of actors we’d like to simulate (i.e., 100, as in the text).</p>
<div class="sourceCode" id="cb1646"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1646-1" data-line-number="1"><span class="co"># how many simulated chimps would you like?</span></a>
<a class="sourceLine" id="cb1646-2" data-line-number="2">n_chimps &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb1646-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1646-4" data-line-number="4"><span class="kw">set.seed</span>(<span class="dv">13</span>)</a>
<a class="sourceLine" id="cb1646-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1646-6" data-line-number="6">(</a>
<a class="sourceLine" id="cb1646-7" data-line-number="7">  f &lt;-</a>
<a class="sourceLine" id="cb1646-8" data-line-number="8"><span class="st">  </span><span class="kw">fitted</span>(b13<span class="fl">.4</span>,</a>
<a class="sourceLine" id="cb1646-9" data-line-number="9">         <span class="dt">newdata =</span> nd,</a>
<a class="sourceLine" id="cb1646-10" data-line-number="10">         <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">1</span>, <span class="fl">.9</span>),</a>
<a class="sourceLine" id="cb1646-11" data-line-number="11">         <span class="dt">allow_new_levels =</span> T,</a>
<a class="sourceLine" id="cb1646-12" data-line-number="12">         <span class="dt">sample_new_levels =</span> <span class="st">&quot;gaussian&quot;</span>,</a>
<a class="sourceLine" id="cb1646-13" data-line-number="13">         <span class="dt">summary =</span> F,</a>
<a class="sourceLine" id="cb1646-14" data-line-number="14">         <span class="dt">nsamples =</span> n_chimps) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1646-15" data-line-number="15"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1646-16" data-line-number="16"><span class="st">  </span><span class="kw">set_names</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1646-17" data-line-number="17"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">iter =</span> <span class="dv">1</span><span class="op">:</span>n_chimps) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1646-18" data-line-number="18"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>iter) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1646-19" data-line-number="19"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">treatment =</span> <span class="kw">factor</span>(name, <span class="dt">labels =</span> labels))</a>
<a class="sourceLine" id="cb1646-20" data-line-number="20">)</a></code></pre></div>
<pre><code>## # A tibble: 400 x 4
##     iter name    value treatment
##    &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;fct&gt;    
##  1     1 1     0.00628 R/N      
##  2     1 2     0.0112  L/N      
##  3     1 3     0.00358 R/P      
##  4     1 4     0.0111  L/P      
##  5     2 1     0.200   R/N      
##  6     2 2     0.332   L/N      
##  7     2 3     0.208   R/P      
##  8     2 4     0.315   L/P      
##  9     3 1     0.801   R/N      
## 10     3 2     0.888   L/N      
## # … with 390 more rows</code></pre>
<p>Plot.</p>
<div class="sourceCode" id="cb1648"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1648-1" data-line-number="1">p6 &lt;-</a>
<a class="sourceLine" id="cb1648-2" data-line-number="2"><span class="st">  </span>f <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1648-3" data-line-number="3"><span class="st">  </span></a>
<a class="sourceLine" id="cb1648-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> treatment, <span class="dt">y =</span> value, <span class="dt">group =</span> iter)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1648-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1648-6" data-line-number="6"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;100 simulated actors&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1648-7" data-line-number="7"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1648-8" data-line-number="8"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">14</span>, <span class="dt">hjust =</span> <span class="fl">.5</span>))</a>
<a class="sourceLine" id="cb1648-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1648-10" data-line-number="10">p6</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-74-1.png" width="240" style="display: block; margin: auto;" /></p>
<p>Here they are altogether.</p>
<div class="sourceCode" id="cb1649"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1649-1" data-line-number="1">p4 <span class="op">|</span><span class="st"> </span>p5 <span class="op">|</span><span class="st"> </span>p6</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-75-1.png" width="720" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="post-stratification." class="section level3">
<h3><span class="header-section-number">13.5.3</span> Post-stratification.</h3>
<p>If you have estimates <span class="math inline">\(p_i\)</span> for each relevant demographic category <span class="math inline">\(i\)</span>, the post-stratified prediction for the whole population just re-weights these estimates using the number of individuals <span class="math inline">\(N_i\)</span> in each category with the formula</p>
<p><span class="math display">\[\frac{\sum_i N_i p_i}{\sum_i N_i}.\]</span></p>
<p>Within the multilevel context, this is called <strong>multilevel regression and post-stratification</strong> (MRP, pronounced “Mister P”). Gelman is a long-time advocate for MRP <span class="citation">(e.g., Gelman &amp; Little, <a href="#ref-gelmanPostratificationManyCategories1997">1997</a>; Park et al., <a href="#ref-parkBayesianMultilevelEstimation2004">2004</a>)</span>. He mentions MRP a lot in his blog (e.g., <a href="https://statmodeling.stat.columbia.edu/2019/01/10/mrp-multilevel-regression-poststratification-mister-p-clearing-misunderstandings/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2019/11/09/australian-polls-failed-they-didnt-do-mister-p/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2019/07/27/the-economist-does-mister-p/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2019/05/14/scandal-mrp-appears-in-british-tabloid/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2019/03/25/mister-p-surveys-epidemiology-using-stan/">here</a>,
<a href="https://statmodeling.stat.columbia.edu/2016/10/12/31398/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2016/09/09/q-is-a-50-state-poll-as-good-as-50-state-polls-a-use-mister-p/">here</a>, <a href="https://statmodeling.stat.columbia.edu/2016/06/12/29344/">here</a>).</p>
</div>
</div>
<div id="summary-bonus-post-stratification-in-an-example" class="section level2">
<h2><span class="header-section-number">13.6</span> <del>Summary</del> Bonus: Post-stratification in an example</h2>
<p>Though I was excited to see McElreath introduce MRP, I was disappointed he did not work through an example. Happily, MRP tutorials have been popping up all over the place online. In this bonus section, we’ll draw heavily from the great blog post from demographer <a href="https://twitter.com/monjalexander">Monica Alexander</a>, <a href="https://www.monicaalexander.com/posts/2019-08-07-mrp/"><em>Analyzing name changes after marriage using a non-representative survey</em></a>. From the introduction of her post, we read:</p>
<blockquote>
<p>Recently on Twitter, sociologist <a href="https://socy.umd.edu/facultyprofile/cohen/philip-n">Phil Cohen</a> put out a survey asking people about their decisions to change their name (or not) after marriage. The response was impressive - there are currently over 5,000 responses. Thanks to Phil, the data from the survey are publicly available and downloadable <a href="https://osf.io/uzqdn/">here</a> for anyone to do their own analysis.</p>
<p>However, there’s an issue with using the raw data without lots of caveats: the respondents are not very representative of the broader population, and in particular tend to have a higher education level and are younger than average….</p>
<p>This is a very common problem for social scientists: trying to come up with representative estimates using non-representative data. In this post I’ll introduce one particular technique of trying to do this: multilevel regression and post-stratification (MRP). In particular, I’ll use data from the marital name change survey to estimate the proportion of women in the US who kept their maiden name after marriage.</p>
</blockquote>
<div id="meet-the-data." class="section level3">
<h3><span class="header-section-number">13.6.1</span> Meet the data.</h3>
<p>Alexander used two data sources in her example. As alluded to in the block quote, above, she used a subset of the data from Cohen’s Twitter poll. She derived her post-stratification weights from the 2017 5-year ACS data from <a href="https://usa.ipums.org/usa/index.shtml">IPUMS-USA</a>, which provides U.S. census data for research use. Alexander provided some of her data wrangling code in her post and her full <strong>R</strong> code is available on her GitHub repo, <a href="https://github.com/MJAlexander/marriage-name-change">marriage-name-change</a>. For the sake of space, I downloaded the data, wrangled them similarly to how they were used in her blog, and saved the tidied data as external files in my <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse_2_ed/tree/master/data">data folder</a> on GitHub. You can download them from there.</p>
<p>Load the data.</p>
<div class="sourceCode" id="cb1650"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1650-1" data-line-number="1"><span class="kw">load</span>(<span class="st">&quot;data/mrp_data_ch13.rds&quot;</span>)</a>
<a class="sourceLine" id="cb1650-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1650-3" data-line-number="3"><span class="kw">glimpse</span>(d)</a></code></pre></div>
<pre><code>## Rows: 4,413
## Columns: 5
## $ kept_name      &lt;dbl&gt; 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, …
## $ state_name     &lt;chr&gt; &quot;ohio&quot;, &quot;virginia&quot;, &quot;new york&quot;, &quot;rhode island&quot;, &quot;illinois&quot;, &quot;north carolina&quot;, &quot;iowa&quot;…
## $ age_group      &lt;chr&gt; &quot;50&quot;, &quot;35&quot;, &quot;35&quot;, &quot;55&quot;, &quot;35&quot;, &quot;25&quot;, &quot;35&quot;, &quot;35&quot;, &quot;35&quot;, &quot;35&quot;, &quot;40&quot;, &quot;35&quot;, &quot;30&quot;, &quot;30&quot;, …
## $ decade_married &lt;chr&gt; &quot;1979&quot;, &quot;1999&quot;, &quot;2009&quot;, &quot;1999&quot;, &quot;2009&quot;, &quot;2009&quot;, &quot;1999&quot;, &quot;2009&quot;, &quot;1999&quot;, &quot;2009&quot;, &quot;200…
## $ educ_group     &lt;chr&gt; &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, …</code></pre>
<div class="sourceCode" id="cb1652"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1652-1" data-line-number="1"><span class="kw">glimpse</span>(cell_counts)</a></code></pre></div>
<pre><code>## Rows: 6,058
## Columns: 5
## $ state_name     &lt;chr&gt; &quot;alabama&quot;, &quot;alabama&quot;, &quot;alabama&quot;, &quot;alabama&quot;, &quot;alabama&quot;, &quot;alabama&quot;, &quot;alaska&quot;, &quot;alaska&quot;…
## $ age_group      &lt;chr&gt; &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, …
## $ decade_married &lt;chr&gt; &quot;1999&quot;, &quot;2009&quot;, &quot;1999&quot;, &quot;2009&quot;, &quot;1999&quot;, &quot;2009&quot;, &quot;1999&quot;, &quot;2009&quot;, &quot;1999&quot;, &quot;2009&quot;, &quot;199…
## $ educ_group     &lt;chr&gt; &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;BA&quot;, &quot;BA&quot;, &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&gt;BA&quot;, &quot;&gt;BA&quot;, &quot;BA&quot;, &quot;BA&quot;, &quot;&lt;BA…
## $ n              &lt;dbl&gt; 19012, 37488, 959, 5319, 2986, 14261, 3320, 7001, 159, 435, 341, 2660, 23279, 45477,…</code></pre>
<p>Our main primary data file, which contains the survey responses to whether women changed their names after marriage, is <code>d</code>. Our criterion variable will be <code>kept_name</code>, which is dummy coded 0 = “no” 1 = “yes.” We have four grouping variables:</p>
<ul>
<li><code>age_group</code>, which ranges from 25 to 75 and is discretized such that 25 = [25, 30), 30 = [30, 35), and so on;</li>
<li><code>decade_married</code>, which ranges from 1979 to 2019 and is discretized such that 1979 = [1979, 1989), 1989 = [1989, 1999), and so on;</li>
<li><code>educ_group</code>, which is coded as &lt;BA = no bachelor’s degree, BA = bachelor’s degree, and &gt;BA = above a bachelor’s degree; and</li>
<li><code>state_name</code>, which includes the names of the 50 US states, the District of Columbia, and Puerto Rico.</li>
</ul>
<p>The <code>cell_counts</code> data contains the relevant information from the US census. The first four columns, <code>state_name</code>, <code>age_group</code>, <code>decade_married</code>, and <code>educ_group</code> are the same demographic categories from the survey data. The fifth column, <code>n</code>, has the counts of women falling within those categories from the US census. There were 6,058 unique combinations of the demographic categories represented in the census data.</p>
<div class="sourceCode" id="cb1654"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1654-1" data-line-number="1">cell_counts <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>()</a></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##       n
##   &lt;int&gt;
## 1  6058</code></pre>
<p>We can use a histogram to get a sense of how those counts vary.</p>
<div class="sourceCode" id="cb1656"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1656-1" data-line-number="1">cell_counts <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1656-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> n)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1656-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">2000</span>, <span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1656-4" data-line-number="4"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">3</span> <span class="op">*</span><span class="st"> </span><span class="dv">100000</span>, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="st">&quot;100K&quot;</span>, <span class="st">&quot;200K&quot;</span>, <span class="st">&quot;300K&quot;</span>))</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-78-1.png" width="432" style="display: block; margin: auto;" /></p>
<p>Though some of the categories are large with an excess of 100,000 persons in them, many are fairly small. It seems unlikely that the women who participated in Cohen’s Twitter poll fell into these categories in the same proportions. This is where post-stratification will help.</p>
</div>
<div id="settle-the-mr-part-of-mrp." class="section level3">
<h3><span class="header-section-number">13.6.2</span> Settle the MR part of MRP.</h3>
<p>Like in the earlier examples in this chapter, we will model the data with multilevel logistic regression. Alexander fit her model with <strong>brms</strong> and kept things simple by using default priors. Here we’ll continue on with McElreath’s recommendations and use weakly regularizing priors. Though I am no expert on the topic of women’s name-changing practices following marriage, my layperson’s sense is that most do not keep their maiden name after they marry. I’m not quite sure what the proportion might be, but I’d like my <span class="math inline">\(\bar \alpha\)</span> prior to tend closer to 0 than to 1. Recall that the <span class="math inline">\(\bar \alpha\)</span> for a multilevel logistic model is typically a Gaussion set on the log-odds scale. If we were to use <span class="math inline">\(\operatorname{Normal}(-1, 1)\)</span>, here’s what that would look like when converted back to the probability metric.</p>
<div class="sourceCode" id="cb1657"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1657-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">13</span>)</a>
<a class="sourceLine" id="cb1657-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1657-3" data-line-number="3"><span class="kw">tibble</span>(<span class="dt">n =</span> <span class="kw">rnorm</span>(<span class="fl">1e6</span>, <span class="dv">-1</span>, <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1657-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p =</span> <span class="kw">inv_logit_scaled</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1657-5" data-line-number="5"><span class="st">  </span></a>
<a class="sourceLine" id="cb1657-6" data-line-number="6"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> p)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1657-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">binwidth =</span> <span class="fl">.02</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1657-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="ot">NULL</span>)</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-79-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>To my eye, this looks like a good place to start. Feel free to experiment with different priors on your end. As to the hierarchical <span class="math inline">\(\sigma_\text{&lt;group&gt;}\)</span> priors, we will continue our practice of setting them to <span class="math inline">\(\operatorname{Exponential}(1)\)</span>. Here’s how to fit the model.</p>
<div class="sourceCode" id="cb1658"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1658-1" data-line-number="1">b13<span class="fl">.7</span> &lt;-</a>
<a class="sourceLine" id="cb1658-2" data-line-number="2"><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d,</a>
<a class="sourceLine" id="cb1658-3" data-line-number="3">      <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb1658-4" data-line-number="4">      kept_name <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>age_group) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>decade_married) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>educ_group) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>state_name),</a>
<a class="sourceLine" id="cb1658-5" data-line-number="5">      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept),</a>
<a class="sourceLine" id="cb1658-6" data-line-number="6">                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sd)),</a>
<a class="sourceLine" id="cb1658-7" data-line-number="7">      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1658-8" data-line-number="8">      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">.98</span>),</a>
<a class="sourceLine" id="cb1658-9" data-line-number="9">      <span class="dt">seed =</span> <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb1658-10" data-line-number="10">      <span class="dt">file =</span> <span class="st">&quot;fits/b13.07&quot;</span>)</a></code></pre></div>
<p>Note how, like Alexander did in the blog, we had to set <code>adept_delta = .98</code> to stave off a few divergent transitions. In my experience, this is common when your hierarchical grouping variables have few levels. Our <code>decade_married</code> has five levels and <code>educ_group</code> has only four. Happily, <code>brms::brm()</code> came through in the end. You can see by checking the summary.</p>
<div class="sourceCode" id="cb1659"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1659-1" data-line-number="1"><span class="kw">print</span>(b13<span class="fl">.7</span>)</a></code></pre></div>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: kept_name | trials(1) ~ 1 + (1 | age_group) + (1 | decade_married) + (1 | educ_group) + (1 | state_name) 
##    Data: d (Number of observations: 4373) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Group-Level Effects: 
## ~age_group (Number of levels: 11) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     1.14      0.29     0.71     1.82 1.00     1346     2153
## 
## ~decade_married (Number of levels: 5) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     1.00      0.42     0.49     2.08 1.00     2041     2529
## 
## ~educ_group (Number of levels: 4) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.93      0.49     0.35     2.18 1.00     2114     2141
## 
## ~state_name (Number of levels: 52) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.25      0.06     0.15     0.37 1.00     1565     2388
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept    -0.70      0.61    -1.99     0.49 1.00     1937     2633
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Even with 4,373 cases in the data, the uncertainty around <span class="math inline">\(\bar \alpha\)</span> is massive, -0.7 [-1.99, 0.49], suggesting a lot of the action is lurking in the <span class="math inline">\(\sigma_\text{&lt;group&gt;}\)</span> parameters. It might be easier to compare the <span class="math inline">\(\sigma_\text{&lt;group&gt;}\)</span> parameters with an interval plot.</p>
<div class="sourceCode" id="cb1661"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1661-1" data-line-number="1"><span class="kw">posterior_samples</span>(b13<span class="fl">.7</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1661-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;sd_&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1661-3" data-line-number="3"><span class="st">  </span><span class="kw">set_names</span>(<span class="kw">str_c</span>(<span class="st">&quot;sigma[&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;decade~married&quot;</span>, <span class="st">&quot;education&quot;</span>, <span class="st">&quot;state&quot;</span>), <span class="st">&quot;]&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1661-4" data-line-number="4"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1661-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1661-6" data-line-number="6"><span class="st">  </span><span class="kw">median_qi</span>(<span class="dt">.width =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="fl">.5</span>, <span class="dt">to =</span> <span class="fl">.9</span>, <span class="dt">by =</span> <span class="fl">.1</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1661-7" data-line-number="7"><span class="st">  </span></a>
<a class="sourceLine" id="cb1661-8" data-line-number="8"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">xmin =</span> .lower, <span class="dt">xmax =</span> .upper, <span class="dt">y =</span> <span class="kw">reorder</span>(name, value))) <span class="op">+</span></a>
<a class="sourceLine" id="cb1661-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_interval</span>(<span class="kw">aes</span>(<span class="dt">alpha =</span> .width), <span class="dt">color =</span> <span class="st">&quot;orange3&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1661-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="dt">labels =</span> ggplot2<span class="op">:::</span>parse_safe) <span class="op">+</span></a>
<a class="sourceLine" id="cb1661-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_alpha_continuous</span>(<span class="st">&quot;CI width&quot;</span>, <span class="dt">range =</span> <span class="kw">c</span>(.<span class="dv">7</span>, <span class="fl">.15</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1661-12" data-line-number="12"><span class="st">  </span><span class="kw">xlim</span>(<span class="dv">0</span>, <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1661-13" data-line-number="13"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb1661-14" data-line-number="14">        <span class="dt">panel.grid.major.y =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-81-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>It seems the largest share of the variation is to be found among the age groups. Since there was relatively less variation across states, we can expect more aggressive regularization along those lines.</p>
</div>
<div id="post-stratify-to-put-the-p-in-mrp." class="section level3">
<h3><span class="header-section-number">13.6.3</span> Post-stratify to put the P in MRP.</h3>
<p>In her post, Alexander contrasted the MRP results with the empirical proportions from the Twitter survey in a series of four plots, one for each of the four grouping variables. We will take a slightly different approach. For simplicity, we will only focus on the results for <code>age_group</code> and <code>state</code>. However, we will examine the results for each using three estimation methods: the empirical proportions, the naïve results from the multilevel model, and the MRP estimates.</p>
<div id="estimates-by-age-group." class="section level4">
<h4><span class="header-section-number">13.6.3.1</span> Estimates by age group.</h4>
<p>To warm up, here is the plot of the empirical proportions for <code>kept_name</code>, by <code>age_group</code>.</p>
<div class="sourceCode" id="cb1662"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1662-1" data-line-number="1">levels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;raw data&quot;</span>, <span class="st">&quot;multilevel&quot;</span>, <span class="st">&quot;MRP&quot;</span>)</a>
<a class="sourceLine" id="cb1662-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1662-3" data-line-number="3">p1 &lt;-</a>
<a class="sourceLine" id="cb1662-4" data-line-number="4"><span class="st">  </span><span class="co"># compute the proportions from the data</span></a>
<a class="sourceLine" id="cb1662-5" data-line-number="5"><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1662-6" data-line-number="6"><span class="st">  </span><span class="kw">group_by</span>(age_group, kept_name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1662-7" data-line-number="7"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1662-8" data-line-number="8"><span class="st">  </span><span class="kw">group_by</span>(age_group) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1662-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n<span class="op">/</span><span class="kw">sum</span>(n),</a>
<a class="sourceLine" id="cb1662-10" data-line-number="10">         <span class="dt">type =</span> <span class="kw">factor</span>(<span class="st">&quot;raw data&quot;</span>, <span class="dt">levels =</span> levels)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1662-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(kept_name <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, age_group <span class="op">&lt;</span><span class="st"> </span><span class="dv">80</span>, age_group <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1662-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1662-13" data-line-number="13"><span class="st">  </span><span class="co"># plot!</span></a>
<a class="sourceLine" id="cb1662-14" data-line-number="14"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> prop, <span class="dt">y =</span> age_group)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1662-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb1662-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1662-17" data-line-number="17"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>type)</a>
<a class="sourceLine" id="cb1662-18" data-line-number="18"></a>
<a class="sourceLine" id="cb1662-19" data-line-number="19">p1</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-82-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>We’ll combine that plot with the next two, in a bit. I just wanted to give a preview of what we’re doing. The second plot will showcase the typical multilevel estimates for the same. The most straightforward way to do this with <strong>brms</strong> is with the <code>fitted()</code> function. We’ll use the <code>re_formula</code> argument to average over the levels of all grouping variables other than <code>age_group</code>. Relatedly, we’ll feed in the unique levels of <code>age_group</code> into the <code>newdata</code> argument. Then we just wrangle and plot.</p>
<div class="sourceCode" id="cb1663"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1663-1" data-line-number="1">nd &lt;-<span class="st"> </span><span class="kw">distinct</span>(d, age_group) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(age_group)</a>
<a class="sourceLine" id="cb1663-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1663-3" data-line-number="3">p2 &lt;-</a>
<a class="sourceLine" id="cb1663-4" data-line-number="4"><span class="st">  </span><span class="kw">fitted</span>(b13<span class="fl">.7</span>,</a>
<a class="sourceLine" id="cb1663-5" data-line-number="5">         <span class="dt">re_formula =</span> <span class="op">~</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>age_group),</a>
<a class="sourceLine" id="cb1663-6" data-line-number="6">         <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1663-7" data-line-number="7"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1663-8" data-line-number="8"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1663-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> Estimate,</a>
<a class="sourceLine" id="cb1663-10" data-line-number="10">         <span class="dt">type =</span> <span class="kw">factor</span>(<span class="st">&quot;multilevel&quot;</span>, <span class="dt">levels =</span> levels)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1663-11" data-line-number="11"><span class="st">  </span></a>
<a class="sourceLine" id="cb1663-12" data-line-number="12"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> prop, <span class="dt">xmin =</span> Q2<span class="fl">.5</span>, <span class="dt">xmax =</span> Q97<span class="fl">.5</span>, <span class="dt">y =</span> age_group)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1663-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="dt">color =</span> <span class="st">&quot;blue2&quot;</span>, <span class="dt">size =</span> <span class="fl">0.8</span>, <span class="dt">fatten =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1663-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1663-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="dt">labels =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1663-16" data-line-number="16"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>type)</a></code></pre></div>
<p>We will take a look at the multilevel coefficient plot in just a bit. Now we turn our focus to computing the MRP estimates. As a first step, we’ll follow Alexander’s lead and add a <code>prop</code> column to the <code>cell_counts</code> data, which will give us the proportions of the combinations of the other three demographic categories, within each level of <code>age_group</code>. We’ll save the results as <code>age_prop</code>.</p>
<div class="sourceCode" id="cb1664"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1664-1" data-line-number="1">age_prop &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1664-2" data-line-number="2"><span class="st">  </span>cell_counts <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1664-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(age_group) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1664-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1664-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb1664-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1664-7" data-line-number="7">age_prop</a></code></pre></div>
<pre><code>## # A tibble: 6,058 x 6
##    state_name age_group decade_married educ_group     n      prop
##    &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt;          &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;
##  1 alabama    25        1999           &lt;BA        19012 0.00414  
##  2 alabama    25        2009           &lt;BA        37488 0.00816  
##  3 alabama    25        1999           &gt;BA          959 0.000209 
##  4 alabama    25        2009           &gt;BA         5319 0.00116  
##  5 alabama    25        1999           BA          2986 0.000650 
##  6 alabama    25        2009           BA         14261 0.00310  
##  7 alaska     25        1999           &lt;BA         3320 0.000723 
##  8 alaska     25        2009           &lt;BA         7001 0.00152  
##  9 alaska     25        1999           &gt;BA          159 0.0000346
## 10 alaska     25        2009           &gt;BA          435 0.0000947
## # … with 6,048 more rows</code></pre>
<p>These results are then fed into the <code>newdata</code> argument within the <code>add_predicted_draws()</code> function, which we’ll save as <code>p</code>.</p>
<div class="sourceCode" id="cb1666"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1666-1" data-line-number="1">p &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1666-2" data-line-number="2"><span class="st">  </span><span class="kw">add_predicted_draws</span>(b13<span class="fl">.7</span>, </a>
<a class="sourceLine" id="cb1666-3" data-line-number="3">                      <span class="dt">newdata =</span> age_prop <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1666-4" data-line-number="4"><span class="st">                        </span><span class="kw">filter</span>(age_group <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span>, </a>
<a class="sourceLine" id="cb1666-5" data-line-number="5">                               age_group <span class="op">&lt;</span><span class="st"> </span><span class="dv">80</span>, </a>
<a class="sourceLine" id="cb1666-6" data-line-number="6">                               decade_married <span class="op">&gt;</span><span class="st"> </span><span class="dv">1969</span>),</a>
<a class="sourceLine" id="cb1666-7" data-line-number="7">                      <span class="dt">allow_new_levels =</span> T)</a>
<a class="sourceLine" id="cb1666-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1666-9" data-line-number="9"><span class="kw">glimpse</span>(p)</a></code></pre></div>
<pre><code>## Rows: 24,232,000
## Columns: 11
## Groups: state_name, age_group, decade_married, educ_group, n, prop, .row [6,058]
## $ state_name     &lt;chr&gt; &quot;alabama&quot;, &quot;alabama&quot;, &quot;alabama&quot;, &quot;alabama&quot;, &quot;alabama&quot;, &quot;alabama&quot;, &quot;alabama&quot;, &quot;alabam…
## $ age_group      &lt;chr&gt; &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, …
## $ decade_married &lt;chr&gt; &quot;1999&quot;, &quot;1999&quot;, &quot;1999&quot;, &quot;1999&quot;, &quot;1999&quot;, &quot;1999&quot;, &quot;1999&quot;, &quot;1999&quot;, &quot;1999&quot;, &quot;1999&quot;, &quot;199…
## $ educ_group     &lt;chr&gt; &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, &quot;&lt;BA&quot;, …
## $ n              &lt;dbl&gt; 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, 19012, …
## $ prop           &lt;dbl&gt; 0.004137905, 0.004137905, 0.004137905, 0.004137905, 0.004137905, 0.004137905, 0.0041…
## $ .row           &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
## $ .chain         &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ .iteration     &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ .draw          &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 2…
## $ .prediction    &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, …</code></pre>
<p>The <code>tidybayes::add_predicted_draws()</code> function is somewhat analogous to <code>brms::predict()</code>. It allowed us to compute the posterior predictions from our model, given the levels of the predictors we fed into <code>newdata</code>. The results were returned in a tidy data format, including the levels of the predictors from the <code>newdata</code> argument. Because there were 6,058 unique predictor values and 4,000 posterior draws, this produced a 24,232,000-row data frame. The posterior predictions are in the <code>.prediction</code> column on the end. Since we used a binomial regression model, we got a series of 0’s and 1’s.</p>
<p>Next comes the MRP magic. If we group the results by <code>age_group</code> and <code>.draw</code>, we can sum the product of the posterior predictions and the weights, which will leave us with 4,000 stratified posterior draws for each of the 11 levels of <code>age_group</code>. This is the essence of the post-stratification equation McElreath presented in <a href="models-with-memory.html#post-stratification.">Section 13.5.3</a>,</p>
<p><span class="math display">\[\frac{\sum_i N_i p_i}{\sum_i N_i}.\]</span></p>
<p>We will follow Alexander and call these summary values <code>kept_name_predict</code>. We then complete the project by grouping by <code>age_group</code> and summarizing each stratified posterior predictive distribution by its mean and 95% interval.</p>
<div class="sourceCode" id="cb1668"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1668-1" data-line-number="1">p &lt;-</a>
<a class="sourceLine" id="cb1668-2" data-line-number="2"><span class="st">  </span>p <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1668-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(age_group, .draw) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1668-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">kept_name_predict =</span> <span class="kw">sum</span>(.prediction <span class="op">*</span><span class="st"> </span>prop)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1668-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(age_group) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1668-6" data-line-number="6"><span class="st">  </span><span class="kw">mean_qi</span>(kept_name_predict)</a>
<a class="sourceLine" id="cb1668-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1668-8" data-line-number="8">p</a></code></pre></div>
<pre><code>## # A tibble: 11 x 7
##    age_group kept_name_predict .lower .upper .width .point .interval
##    &lt;chr&gt;                 &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
##  1 25                    0.175 0.0902  0.279   0.95 mean   qi       
##  2 30                    0.181 0.115   0.262   0.95 mean   qi       
##  3 35                    0.218 0.150   0.301   0.95 mean   qi       
##  4 40                    0.246 0.175   0.327   0.95 mean   qi       
##  5 45                    0.279 0.203   0.367   0.95 mean   qi       
##  6 50                    0.302 0.216   0.397   0.95 mean   qi       
##  7 55                    0.325 0.233   0.432   0.95 mean   qi       
##  8 60                    0.437 0.329   0.551   0.95 mean   qi       
##  9 65                    0.561 0.419   0.706   0.95 mean   qi       
## 10 70                    0.513 0.291   0.752   0.95 mean   qi       
## 11 75                    0.229 0.0497  0.536   0.95 mean   qi</code></pre>
<p>Now we are finally ready to plot our MRP estimates and combine the three subplots into a coherent whole with <strong>patchwork</strong> syntax.</p>
<div class="sourceCode" id="cb1670"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1670-1" data-line-number="1"><span class="co"># MRP plot</span></a>
<a class="sourceLine" id="cb1670-2" data-line-number="2">p3 &lt;-</a>
<a class="sourceLine" id="cb1670-3" data-line-number="3"><span class="st">  </span>p <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1670-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="kw">factor</span>(<span class="st">&quot;MRP&quot;</span>, <span class="dt">levels =</span> levels)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1670-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1670-6" data-line-number="6"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> kept_name_predict, <span class="dt">xmin =</span> .lower, <span class="dt">xmax =</span> .upper, <span class="dt">y =</span> age_group)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1670-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="dt">color =</span> <span class="st">&quot;orange2&quot;</span>, <span class="dt">size =</span> <span class="fl">0.8</span>, <span class="dt">fatten =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1670-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1670-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="dt">labels =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1670-10" data-line-number="10"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>type)</a>
<a class="sourceLine" id="cb1670-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1670-12" data-line-number="12"><span class="co"># combine!</span></a>
<a class="sourceLine" id="cb1670-13" data-line-number="13">(p1 <span class="op">|</span><span class="st"> </span>p2 <span class="op">|</span><span class="st"> </span>p3) <span class="op">+</span></a>
<a class="sourceLine" id="cb1670-14" data-line-number="14"><span class="st">  </span><span class="kw">plot_annotation</span>(<span class="dt">title =</span> <span class="st">&quot;Proportion of women keeping name after marriage, by age&quot;</span>,</a>
<a class="sourceLine" id="cb1670-15" data-line-number="15">                  <span class="dt">subtitle =</span> <span class="st">&quot;Proportions are on the x-axis and age groups are on the y-axis.&quot;</span>)</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-87-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>Both multilevel and MRP estimates tended to be a little lower than the raw proportions, particularly for women in the younger age groups. Alexander mused this was “likely due to the fact that the survey has an over-sample of highly educated women, who are more likely to keep their name.” The MRP estimates were more precise than the multilevel predictions, which averaged across the grouping variables other than age. All three estimates show something of an inverted U-shape curve across age, which Alexander noted “is consistent with past observations that there was a <a href="https://www.nytimes.com/2015/06/28/upshot/maiden-names-on-the-rise-again.html">peak in name retention in the 80s and 90s</a>.”</p>
</div>
<div id="estimates-by-us-state." class="section level4">
<h4><span class="header-section-number">13.6.3.2</span> Estimates by US state.</h4>
<p>Now we turn out attention to variation across states. The workflow, here, will only deviate slightly from what we just did. This time, of course, we will be grouping the estimates by <code>state_name</code> instead of by <code>age_group</code>. The other notable difference is since we’re plotting US state, it might be fun to show the results in a map format. Alexander used the <code>gemo_statebins()</code> function from the <a href="https://CRAN.R-project.org/package=statebins"><strong>statebins</strong> package</a> <span class="citation">(Rudis, <a href="#ref-R-statebins">2020</a>)</span>. I thought the results were pretty cool, we we’ll do the same. To give you a sense of what we’re building, here’s the plot of the empirical proportions.</p>
<div class="sourceCode" id="cb1671"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1671-1" data-line-number="1"><span class="kw">library</span>(statebins)</a>
<a class="sourceLine" id="cb1671-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1671-3" data-line-number="3">p1 &lt;-</a>
<a class="sourceLine" id="cb1671-4" data-line-number="4"><span class="st">  </span>d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1671-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(state_name, kept_name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1671-6" data-line-number="6"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1671-7" data-line-number="7"><span class="st">  </span><span class="kw">group_by</span>(state_name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1671-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n<span class="op">/</span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1671-9" data-line-number="9"><span class="st">  </span><span class="kw">filter</span>(kept_name <span class="op">==</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb1671-10" data-line-number="10">         state_name <span class="op">!=</span><span class="st"> &quot;puerto rico&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1671-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="kw">factor</span>(<span class="st">&quot;raw data&quot;</span>, <span class="dt">levels =</span> levels),</a>
<a class="sourceLine" id="cb1671-12" data-line-number="12">         <span class="dt">statename =</span> <span class="kw">str_to_title</span>(state_name)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1671-13" data-line-number="13"><span class="st">  </span></a>
<a class="sourceLine" id="cb1671-14" data-line-number="14"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> prop, <span class="dt">state =</span> statename)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1671-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_statebins</span>(<span class="dt">lbl_size =</span> <span class="fl">2.5</span>, <span class="dt">border_size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">radius =</span> grid<span class="op">::</span><span class="kw">unit</span>(<span class="dv">2</span>, <span class="st">&quot;pt&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1671-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_fill_viridis_c</span>(<span class="st">&quot;proportion</span><span class="ch">\n</span><span class="st">keeping</span><span class="ch">\n</span><span class="st">name&quot;</span>, <span class="dt">option =</span> <span class="st">&quot;B&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.8</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1671-17" data-line-number="17"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1671-18" data-line-number="18"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1671-19" data-line-number="19"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1671-20" data-line-number="20"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>type)</a>
<a class="sourceLine" id="cb1671-21" data-line-number="21"></a>
<a class="sourceLine" id="cb1671-22" data-line-number="22">p1</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-88-1.png" width="288" style="display: block; margin: auto;" /></p>
<p>For the naïve multilevel estimates, we’ll continue using <code>fitted()</code>.</p>
<div class="sourceCode" id="cb1672"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1672-1" data-line-number="1">nd &lt;-<span class="st"> </span><span class="kw">distinct</span>(d, state_name)</a>
<a class="sourceLine" id="cb1672-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1672-3" data-line-number="3">p2 &lt;-</a>
<a class="sourceLine" id="cb1672-4" data-line-number="4"><span class="st">  </span><span class="kw">fitted</span>(b13<span class="fl">.7</span>,</a>
<a class="sourceLine" id="cb1672-5" data-line-number="5">         <span class="dt">re_formula =</span> <span class="op">~</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>state_name),</a>
<a class="sourceLine" id="cb1672-6" data-line-number="6">         <span class="dt">newdata =</span> nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1672-7" data-line-number="7"><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1672-8" data-line-number="8"><span class="st">  </span><span class="kw">bind_cols</span>(nd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1672-9" data-line-number="9"><span class="st">  </span><span class="kw">filter</span>(state_name <span class="op">!=</span><span class="st"> &quot;puerto rico&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1672-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> Estimate,</a>
<a class="sourceLine" id="cb1672-11" data-line-number="11">         <span class="dt">type =</span> <span class="kw">factor</span>(<span class="st">&quot;multilevel&quot;</span>, <span class="dt">levels =</span> levels),</a>
<a class="sourceLine" id="cb1672-12" data-line-number="12">         <span class="dt">statename =</span> <span class="kw">str_to_title</span>(state_name)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1672-13" data-line-number="13"><span class="st">  </span></a>
<a class="sourceLine" id="cb1672-14" data-line-number="14"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> prop, <span class="dt">state =</span> statename)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1672-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_statebins</span>(<span class="dt">lbl_size =</span> <span class="fl">2.5</span>, <span class="dt">border_size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">radius =</span> grid<span class="op">::</span><span class="kw">unit</span>(<span class="dv">2</span>, <span class="st">&quot;pt&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1672-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_fill_viridis_c</span>(<span class="st">&quot;proportion</span><span class="ch">\n</span><span class="st">keeping</span><span class="ch">\n</span><span class="st">name&quot;</span>, <span class="dt">option =</span> <span class="st">&quot;B&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.8</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1672-17" data-line-number="17"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1672-18" data-line-number="18"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1672-19" data-line-number="19"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>type)</a></code></pre></div>
<p>In preparation for the MRP estimates, we’ll first wrangle <code>cell_counts</code>, this time grouping by <code>state_name</code> before computing the weights.</p>
<div class="sourceCode" id="cb1673"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1673-1" data-line-number="1">state_prop &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1673-2" data-line-number="2"><span class="st">  </span>cell_counts <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1673-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(state_name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1673-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n<span class="op">/</span><span class="kw">sum</span>(n))  <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1673-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb1673-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1673-7" data-line-number="7">state_prop</a></code></pre></div>
<pre><code>## # A tibble: 6,058 x 6
##    state_name age_group decade_married educ_group     n     prop
##    &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt;          &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;
##  1 alabama    25        1999           &lt;BA        19012 0.0187  
##  2 alabama    25        2009           &lt;BA        37488 0.0369  
##  3 alabama    25        1999           &gt;BA          959 0.000945
##  4 alabama    25        2009           &gt;BA         5319 0.00524 
##  5 alabama    25        1999           BA          2986 0.00294 
##  6 alabama    25        2009           BA         14261 0.0141  
##  7 alaska     25        1999           &lt;BA         3320 0.0225  
##  8 alaska     25        2009           &lt;BA         7001 0.0474  
##  9 alaska     25        1999           &gt;BA          159 0.00108 
## 10 alaska     25        2009           &gt;BA          435 0.00295 
## # … with 6,048 more rows</code></pre>
<p>Now we’ll feed those <code>state_prop</code> values into <code>add_predicted_draws()</code>, wrangle, and plot the MRP plot in one step.</p>
<div class="sourceCode" id="cb1675"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1675-1" data-line-number="1">p3 &lt;-</a>
<a class="sourceLine" id="cb1675-2" data-line-number="2"><span class="st">  </span><span class="kw">add_predicted_draws</span>(b13<span class="fl">.7</span>,</a>
<a class="sourceLine" id="cb1675-3" data-line-number="3">                      <span class="dt">newdata =</span> state_prop <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1675-4" data-line-number="4"><span class="st">                        </span><span class="kw">filter</span>(age_group <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span>, </a>
<a class="sourceLine" id="cb1675-5" data-line-number="5">                               age_group <span class="op">&lt;</span><span class="st"> </span><span class="dv">80</span>, </a>
<a class="sourceLine" id="cb1675-6" data-line-number="6">                               decade_married <span class="op">&gt;</span><span class="st"> </span><span class="dv">1969</span>),</a>
<a class="sourceLine" id="cb1675-7" data-line-number="7">                      <span class="dt">allow_new_levels =</span> T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1675-8" data-line-number="8"><span class="st">  </span><span class="kw">group_by</span>(state_name, .draw) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1675-9" data-line-number="9"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">kept_name_predict =</span> <span class="kw">sum</span>(.prediction <span class="op">*</span><span class="st"> </span>prop)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1675-10" data-line-number="10"><span class="st">  </span><span class="kw">group_by</span>(state_name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1675-11" data-line-number="11"><span class="st">  </span><span class="kw">mean_qi</span>(kept_name_predict) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1675-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop      =</span> kept_name_predict,</a>
<a class="sourceLine" id="cb1675-13" data-line-number="13">         <span class="dt">type      =</span> <span class="kw">factor</span>(<span class="st">&quot;MRP&quot;</span>, <span class="dt">levels =</span> levels),</a>
<a class="sourceLine" id="cb1675-14" data-line-number="14">         <span class="dt">statename =</span> <span class="kw">str_to_title</span>(state_name)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1675-15" data-line-number="15"><span class="st">  </span></a>
<a class="sourceLine" id="cb1675-16" data-line-number="16"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> kept_name_predict, <span class="dt">state =</span> statename)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1675-17" data-line-number="17"><span class="st">  </span><span class="kw">geom_statebins</span>(<span class="dt">lbl_size =</span> <span class="fl">2.5</span>, <span class="dt">border_size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">radius =</span> grid<span class="op">::</span><span class="kw">unit</span>(<span class="dv">2</span>, <span class="st">&quot;pt&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1675-18" data-line-number="18"><span class="st">  </span><span class="kw">scale_fill_viridis_c</span>(<span class="st">&quot;proportion</span><span class="ch">\n</span><span class="st">keeping</span><span class="ch">\n</span><span class="st">name&quot;</span>, <span class="dt">option =</span> <span class="st">&quot;B&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.8</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb1675-19" data-line-number="19"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1675-20" data-line-number="20"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1675-21" data-line-number="21"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb1675-22" data-line-number="22"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>type)</a></code></pre></div>
<p>We’re finally ready to combine our three panels into one grand plot.</p>
<div class="sourceCode" id="cb1676"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1676-1" data-line-number="1">(p1 <span class="op">|</span><span class="st"> </span>p2 <span class="op">|</span><span class="st"> </span>p3) <span class="op">+</span></a>
<a class="sourceLine" id="cb1676-2" data-line-number="2"><span class="st">  </span><span class="kw">plot_annotation</span>(<span class="dt">title =</span> <span class="st">&quot;Proportion of women keeping name after marriage, by state&quot;</span>,</a>
<a class="sourceLine" id="cb1676-3" data-line-number="3">                  <span class="dt">theme =</span> <span class="kw">theme</span>(<span class="dt">plot.margin =</span> <span class="kw">margin</span>(<span class="fl">0.2</span>, <span class="dv">0</span>, <span class="fl">0.01</span>, <span class="dv">0</span>, <span class="st">&quot;cm&quot;</span>)))</a></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-92-1.png" width="864" style="display: block; margin: auto;" /></p>
<p>Remember how small the posterior for <span class="math inline">\(\sigma_\text{state}\)</span> was relative to the other <span class="math inline">\(\sigma_\text{&lt;group&gt;}\)</span> posteriors? We said that would imply more aggressive regularization across states. You can really see that regularization in the panels showing the multilevel and MRP estimates. They are much more uniform than the proportions from the raw data, which are all over the place. This is why you use multilevel models and/or stratify. When you divide the responses up at the state level, the proportions get jerked all around due to small and unrepresentative samples. Even with the regularization from the multilevel partial pooling, you can still see some interesting differences in the multilevel and MRP panels. Both suggest women keep their maiden names in relatively low proportions in Utah and relatively high proportions in New York. For those acquainted with American culture, this shouldn’t be a great surprise.</p>
</div>
</div>
<div id="wrap-this-mrp-up." class="section level3">
<h3><span class="header-section-number">13.6.4</span> Wrap this MRP up.</h3>
<p>Interested readers should practice exploring the MRP estimates by the other two grouping variables, <code>educ_group</code> and <code>decate_married</code>. Both contain interesting results. Also, there are many other great free resources for learning about MRP.</p>
<ul>
<li><a href="https://twitter.com/timmastny">Tim Mastny</a> showed how to use MRP via <strong>brms</strong> with data of US state level opinions for gay marriage in his blog post, <a href="https://timmastny.rbind.io/blog/multilevel-mrp-tidybayes-brms-stan/"><em>MRP Using brms and tidybayes</em></a>.</li>
<li><a href="https://twitter.com/RohanAlexander">Rohan Alexander</a> showed how to fit political poling data with both <strong>lme4</strong> and <strong>brms</strong> in his post, <a href="https://rohanalexander.com/posts/2019-12-04-getting_started_with_mrp/"><em>Getting started with MRP</em></a>.</li>
<li><a href="https://twitter.com/jazzystats">Lauren Kennedy</a> and Andrew Gelman have a <span class="citation">(<a href="#ref-kennedyKnowYourPopulation2020">2020</a>)</span> preprint called <a href="https://arxiv.org/pdf/1906.11323.pdf"><em>Know your population and know your model: Using model-based regression and post-stratification to generalize findings beyond the observed sample</em></a>, which shows how to use <strong>brms</strong> to apply MRP to Big Five personality data.</li>
</ul>
<p>If anything, it seems we have an embarrassment of riches when it comes to <strong>brms</strong> and MRP! To wrap this section up, we’ll give Monica Alexander the last words:</p>
<blockquote>
<p>MRP is probably most commonly used in political analysis to reweight polling <a href="https://www.monicaalexander.com/posts/2019-08-07-mrp/#fn5">data</a>, but it is a useful technique for many different survey responses. Many modeling extensions are possible. For example, the multilevel regression need not be limited to just using random effects, as was used here, and other model set ups could be <a href="https://www.monicaalexander.com/posts/2019-08-07-mrp/#fn6">investigated</a>. MRP is a relatively easy and quick way of trying to get more representative estimates out of non-representative data, while giving you a sense of the uncertainty around the estimates (unlike traditional post-stratification).</p>
</blockquote>
</div>
</div>
<div id="session-info-12" class="section level2 unnumbered">
<h2>Session info</h2>
<div class="sourceCode" id="cb1677"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1677-1" data-line-number="1"><span class="kw">sessionInfo</span>()</a></code></pre></div>
<pre><code>## R version 3.6.3 (2020-02-29)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS Catalina 10.15.3
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] parallel  stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] statebins_1.4.0      posterior_0.1.0      bayesplot_1.7.1      patchwork_1.0.1.9000 tidybayes_2.1.1     
##  [6] ggthemes_4.2.0       forcats_0.5.0        stringr_1.4.0        dplyr_1.0.1          purrr_0.3.4         
## [11] readr_1.3.1          tidyr_1.1.1          tibble_3.0.3         tidyverse_1.3.0      brms_2.13.0         
## [16] Rcpp_1.0.5           dagitty_0.2-2        rstan_2.19.3         ggplot2_3.3.2        StanHeaders_2.21.0-1
## 
## loaded via a namespace (and not attached):
##   [1] readxl_1.3.1         backports_1.1.8      plyr_1.8.6           igraph_1.2.5         splines_3.6.3       
##   [6] svUnit_1.0.3         crosstalk_1.1.0.1    TH.data_1.0-10       rstantools_2.0.0     inline_0.3.15       
##  [11] digest_0.6.25        htmltools_0.5.0      rsconnect_0.8.16     fansi_0.4.1          checkmate_2.0.0     
##  [16] magrittr_1.5         modelr_0.1.6         matrixStats_0.56.0   xts_0.12-0           sandwich_2.5-1      
##  [21] prettyunits_1.1.1    colorspace_1.4-1     rvest_0.3.5          ggdist_2.1.1         haven_2.2.0         
##  [26] xfun_0.13            callr_3.4.3          crayon_1.3.4         jsonlite_1.7.0       survival_3.1-12     
##  [31] zoo_1.8-7            glue_1.4.1           gtable_0.3.0         emmeans_1.4.5        V8_3.0.2            
##  [36] pkgbuild_1.1.0       shape_1.4.4          abind_1.4-5          scales_1.1.1         mvtnorm_1.1-0       
##  [41] emo_0.0.0.9000       DBI_1.1.0            miniUI_0.1.1.1       viridisLite_0.3.0    xtable_1.8-4        
##  [46] stats4_3.6.3         DT_0.13              htmlwidgets_1.5.1    httr_1.4.1           threejs_0.3.3       
##  [51] arrayhelpers_1.1-0   ellipsis_0.3.1       pkgconfig_2.0.3      loo_2.2.0            farver_2.0.3        
##  [56] dbplyr_1.4.2         utf8_1.1.4           tidyselect_1.1.0     labeling_0.3         rlang_0.4.7         
##  [61] reshape2_1.4.4       later_1.1.0.1        munsell_0.5.0        cellranger_1.1.0     tools_3.6.3         
##  [66] cli_2.0.2            generics_0.0.2       broom_0.5.5          ggridges_0.5.2       evaluate_0.14       
##  [71] fastmap_1.0.1        yaml_2.2.1           processx_3.4.3       knitr_1.28           fs_1.4.1            
##  [76] nlme_3.1-144         mime_0.9             xml2_1.3.1           compiler_3.6.3       shinythemes_1.1.2   
##  [81] rstudioapi_0.11      curl_4.3             reprex_0.3.0         stringi_1.4.6        ps_1.3.4            
##  [86] Brobdingnag_1.2-6    lattice_0.20-38      Matrix_1.2-18        markdown_1.1         shinyjs_1.1         
##  [91] vctrs_0.3.2          pillar_1.4.6         lifecycle_0.2.0      bridgesampling_1.0-0 estimability_1.3    
##  [96] httpuv_1.5.4         R6_2.4.1             bookdown_0.18        promises_1.1.1       gridExtra_2.3       
## [101] codetools_0.2-16     boot_1.3-24          colourpicker_1.0     MASS_7.3-51.5        gtools_3.8.2        
## [106] assertthat_0.2.1     withr_2.2.0          shinystan_2.5.0      multcomp_1.4-13      hms_0.5.3           
## [111] grid_3.6.3           coda_0.19-3          rmarkdown_2.1        shiny_1.5.0          lubridate_1.7.8     
## [116] base64enc_0.1-3      dygraphs_1.1.1.6</code></pre>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-barrRandomEffectsStructure2013">
<p>Barr, D. J., Levy, R., Scheepers, C., &amp; Tily, H. J. (2013). Random effects structure for confirmatory hypothesis testing: Keep it maximal. <em>Journal of Memory and Language</em>, <em>68</em>(3), 255–278. <a href="https://doi.org/10.1016/j.jml.2012.11.001">https://doi.org/10.1016/j.jml.2012.11.001</a></p>
</div>
<div id="ref-R-posterior">
<p>Bürkner, P.-C., Gabry, J., Kay, M., &amp; Vehtari, A. (2020). <em>posterior: Tools for working with posterior distributions</em>. <a href="https://mc-stan.org/posterior">https://mc-stan.org/posterior</a></p>
</div>
<div id="ref-efronSteinParadoxStatistics1977">
<p>Efron, B., &amp; Morris, C. (1977). Stein’s paradox in statistics. <em>Scientific American</em>, <em>236</em>(5), 119–127. <a href="https://doi.org/10.1038/scientificamerican0577-119">https://doi.org/10.1038/scientificamerican0577-119</a></p>
</div>
<div id="ref-gelmanPostratificationManyCategories1997">
<p>Gelman, A., &amp; Little, T. C. (1997). Postratification into many categories using hierarchical logistic regression. <em>Survey Methodology</em>, <em>23</em>, 127–135. <a href="https://stat.columbia.edu/~gelman/research/published/poststrat3.pdf">https://stat.columbia.edu/~gelman/research/published/poststrat3.pdf</a></p>
</div>
<div id="ref-kennedyKnowYourPopulation2020">
<p>Kennedy, L., &amp; Gelman, A. (2020). Know your population and know your model: Using model-based regression and poststratification to generalize findings beyond the observed sample. <em>arXiv:1906.11323 [Stat]</em>. <a href="http://arxiv.org/abs/1906.11323">http://arxiv.org/abs/1906.11323</a></p>
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2020">
<p>McElreath, R. (2020a). <em>Statistical rethinking: A Bayesian course with examples in R and Stan</em> (Second edition). CRC Press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a></p>
</div>
<div id="ref-parkBayesianMultilevelEstimation2004">
<p>Park, D. K., Gelman, A., &amp; Bafumi, J. (2004). Bayesian multilevel estimation with poststratification: State-level estimates from national polls. <em>Political Analysis</em>, <em>12</em>(4), 375–385. <a href="https://www.jstor.org/stable/25791784">https://www.jstor.org/stable/25791784</a></p>
</div>
<div id="ref-R-statebins">
<p>Rudis, B. (2020). <em>statebins: Create united states uniform cartogram heatmaps</em> [Manual]. <a href="https://CRAN.R-project.org/package=statebins">https://CRAN.R-project.org/package=statebins</a></p>
</div>
<div id="ref-vehtariRanknormalizationFoldingLocalization2019">
<p>Vehtari, A., Gelman, A., Simpson, D., Carpenter, B., &amp; Bürkner, P.-C. (2019). Rank-normalization, folding, and localization: An improved <span class="math inline">\(\widehat{R}\)</span> for assessing convergence of MCMC. <em>arXiv Preprint arXiv:1903.08008</em>. <a href="https://arxiv.org/abs/1903.08008?">https://arxiv.org/abs/1903.08008?</a></p>
</div>
<div id="ref-voneshCompensatoryLarvalResponses2005">
<p>Vonesh, J. R., &amp; Bolker, B. M. (2005). Compensatory larval responses shift trade-offs associated with predator-induced hatching plasticity. <em>Ecology</em>, <em>86</em>(6), 1580–1591. <a href="https://doi.org/10.1890/04-0535">https://doi.org/10.1890/04-0535</a></p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="monsters-and-mixtures.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="adventures-in-covariance.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
